name: Build & Upload HACS ZIP

# Wird ausgelöst, sobald du einen Release publishst
on:
  release:
    types:
      - published

jobs:
  build_zip:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # erlaubt, Assets an den Release zu hängen

    steps:
      # 1) Den Code auschecken (inkl. aller Dateien und Tags)
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2) ZIP-Package zusammenstellen
      - name: Build ha-pp-reader.zip
        run: |
          # 1) Temp-Ordner anlegen
          mkdir package

          # 2) Nur den Integrations-Ordner kopieren (ohne custom_components/)
          cp -r custom_components/pp_reader/.  package/

          # 3) Frontend und Metadaten dazu
          cp -r frontend           package/
          cp hacs.json             package/
          cp README.md             package/
          cp LICENSE               package/

          # 4) ZIP ohne zusätzlichen Wrapper
          cd package
          zip -r ../ha-pp-reader.zip ./*
          cd ..

      # 3) ZIP als Asset an den gerade veröffentlichten Release hängen
      - name: Upload ZIP to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ha-pp-reader.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
