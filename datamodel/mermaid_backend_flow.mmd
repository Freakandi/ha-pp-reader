---
id: 3352fa75-eea8-43f1-acf3-9faffdbd6a55
---
flowchart TB
  UI[[Portfolio Performance UI]]

  subgraph DashboardSummary["Dashboard Summary"]
    AccountsProto[["PAccount stream"]] --> SyncAccounts[["_sync_accounts"]]
    SyncAccounts --> AccountsDB[("SQLite accounts")]
    SyncAccounts --> AccountPerfDB[("SQLite account_balances_performance")]
    FXProto[["Frankfurter FX ingest"]] --> FxRates[("SQLite fx_rates")]
    HoldingsProto[["PPortfolio + PTransaction stream"]] --> SyncHoldings[["_sync_portfolio_securities"]]
    SyncHoldings --> PortfolioSecDB[("SQLite portfolio_securities")]
    SyncHoldings --> PortfolioPerfDB[("SQLite portfolio_securities_performance")]
    AccountsDB --> LoadAccounts[["_load_accounts_payload"]]
    FxRates --> LoadAccounts
    PortfolioSecDB --> FetchLivePortfolios[["fetch_live_portfolios"]]
    LoadAccounts --> DashboardAgg[["ws_get_dashboard_data aggregation"]]
    FetchLivePortfolios --> DashboardAgg
    DashboardAgg --> DashboardSummaryPayload[["dashboard_summary payload"]]
    Clock[["UTC timestamp helper"]] --> DashboardSummaryPayload
    PortfolioPerfDB --> PortfolioHistoryCache[["portfolio time-series cache"]]
    AccountPerfDB --> AccountHistoryCache[["account balance time-series cache"]]
  end
  DashboardSummaryPayload --> UI
  PortfolioHistoryCache --> UI
  AccountHistoryCache --> UI

  subgraph AccountSummaries["Account Summaries"]
    AccountsProto --> SyncAccounts
    AccountsDB --> LoadAccountsPayload[["_load_accounts_payload"]]
    FxRates --> LoadAccountsPayload
    LoadAccountsPayload --> AccountsPayload[["accounts payload"]]
    AccountPerfDB --> AccountTrendQuery[["load_account_balance_series"]]
  end
  AccountsPayload --> UI
  AccountTrendQuery --> UI

  subgraph PortfolioSummaries["Portfolio Summaries"]
    PortfolioProto[["PPortfolio + transactions"]] --> SyncPortfolios[["_sync_portfolios"]]
    PortfolioProto --> SyncHoldings
    SyncPortfolios --> PortfoliosDB[("SQLite portfolios")]
    PortfoliosDB --> LivePortfolios[["fetch_live_portfolios"]]
    PortfolioSecDB --> LivePortfolios
    LivePortfolios --> PerformanceMetrics[["select_performance_metrics"]]
    PerformanceMetrics --> PortfolioNormalize[["_live_portfolios_payload"]]
    LivePortfolios --> PortfolioNormalize
    PortfolioNormalize --> PortfolioValuesPayload[["portfolio_values payload"]]
  end
  PortfolioValuesPayload --> UI

  subgraph PortfolioPositions["Portfolio Positions"]
    PositionProto[["PPortfolio + PTransaction + PSecurity"]] --> SyncTransactions[["_sync_transactions"]]
    PositionProto --> SyncPortSec[["_sync_portfolio_securities"]]
    PositionProto --> SyncPerf[["rebuild_portfolio_security_performance"]]
    PositionProto --> SyncSecurities[["_sync_securities"]]
    SyncTransactions --> TransactionsDB[("SQLite transactions")]
    SyncPortSec --> PortfolioSecDB
    SyncPortSec --> PositionTxAggDB[("SQLite portfolio_securities_transactions")]
    SyncPerf --> PortfolioPerfDB
    SyncSecurities --> SecuritiesDB[("SQLite securities")]
    TransactionsDB --> TxRollup[["rebuild_portfolio_security_transactions"]]
    TxRollup --> PositionTxAggDB
    FxRates --> GetPositions[["get_portfolio_positions"]]
    PortfolioSecDB --> GetPositions
    PositionTxAggDB --> GetPositions
    TransactionsDB --> GetPositions
    SecuritiesDB --> GetPositions
    GetPositions --> HoldingsAgg[["compute_holdings_aggregation"]]
    HoldingsAgg --> NormalizePositions[["_normalize_portfolio_positions"]]
    NormalizePositions --> PortfolioPositionsPayload[["portfolio_positions payload"]]
    PortfolioPerfDB --> PositionTrendSeries[["load_position_performance_series"]]
  end
  PortfolioPositionsPayload --> UI
  PositionTrendSeries --> UI

  subgraph LastFileUpdate["Last File Update"]
    ImportRun[["Portfolio import"]] --> StoreLastUpdate[["_SyncRunner._store_last_file_update"]]
    SourceMeta[["Import metadata"]] --> StoreLastUpdate
    StoreLastUpdate --> MetadataDB[("SQLite metadata")]
    MetadataDB --> LastFileLoader[["get_last_file_update"]]
    LastFileLoader --> LastFilePayload[["last_file_update payload"]]
  end
  LastFilePayload --> UI

  subgraph SecuritySnapshot["Security Snapshot"]
    SecurityProto[["PSecurity + PPortfolio + PTransaction"]] --> SyncSecurities
    SecurityProto --> SyncPortSec
    SecurityProto --> SyncTransactions
    YahooFetch[["Yahoo price fetch"]] --> PriceCycle[["_run_price_cycle"]]
    PriceCycle --> SecuritiesDB
    Frankfurter[["Frankfurter FX"]] --> FxRates
    SecuritiesDB --> SecuritySnapshotLoader[["get_security_snapshot"]]
    PortfolioSecDB --> SecuritySnapshotLoader
    PositionTxAggDB --> SecuritySnapshotLoader
    TransactionsDB --> SecuritySnapshotLoader
    FxRates --> SecuritySnapshotLoader
    SecuritySnapshotLoader --> SnapshotPerf[["select_performance_metrics"]]
    SecuritySnapshotLoader --> SnapshotAvg[["_resolve_average_cost_totals"]]
    SnapshotPerf --> SnapshotSerial[["_serialise_security_snapshot"]]
    SnapshotAvg --> SnapshotSerial
    SecuritySnapshotLoader --> SnapshotSerial
    SnapshotSerial --> SecuritySnapshotPayload[["security_snapshot payload"]]
  end
  SecuritySnapshotPayload --> UI

  subgraph SecurityHistory["Security History"]
    PortfolioPrices[["Portfolio Performance prices"]] --> SyncHistory[["sync_from_pclient"]]
    SyncHistory --> HistoricalPricesDB[("SQLite historical_prices")]
    YahooHistory[["Yahoo history ingest"]] --> HistoricalPricesDB
    FxHelpers[["FX normalization helpers"]] --> SecurityHistoryHandler[["ws_get_security_history"]]
    HistoricalPricesDB --> SecurityHistoryHandler
    SecurityHistoryHandler --> RangeMapper[["range token mapping"]]
    SecurityHistoryHandler --> SeriesBuilder[["prices[] entries"]]
    RangeMapper --> SecurityHistoryPayload[["security_history payload"]]
    SeriesBuilder --> SecurityHistoryPayload
  end
  SecurityHistoryPayload --> UI

  subgraph LiveUpdate["Live Update Envelope"]
    Importers[["Importers"]] --> EventBus[["_push_update"]]
    EventBus --> PanelsUpdated[["panels_updated event"]]
  end
  PanelsUpdated --> UI