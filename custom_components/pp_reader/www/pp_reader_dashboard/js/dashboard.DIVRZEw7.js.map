{"version":3,"file":"dashboard.DIVRZEw7.js","sources":["../../../../../src/interaction/tab_control.ts","../../../../../src/content/elements.ts","../../../../../src/data/api.ts","../../../../../src/dashboard/registry.ts","../../../../../src/utils/currency.ts","../../../../../src/utils/performance.ts","../../../../../src/data/positionsCache.ts","../../../../../src/data/updateConfigsWS.ts","../../../../../src/tabs/overview.ts","../../../../../src/content/charting.ts","../../../../../src/tabs/types.ts","../../../../../src/tabs/security_detail.ts","../../../../../src/dashboard.ts"],"sourcesContent":["/**\n * Swipe and tab interaction helpers mirrored from the legacy UI.\n */\n\nexport type SwipeCallback = () => void;\n\nconst DEFAULT_SWIPE_THRESHOLD = 50;\n\ntype SwipeDirection = 'left' | 'right';\n\nfunction triggerSwipe(direction: SwipeDirection, callback: SwipeCallback): void {\n  try {\n    callback();\n  } catch (error) {\n    console.warn(`addSwipeEvents: ${direction} handler threw`, error);\n  }\n}\n\nexport function addSwipeEvents(\n  element: HTMLElement,\n  onSwipeLeft: SwipeCallback,\n  onSwipeRight: SwipeCallback,\n): void {\n  let startX: number | null = null;\n\n  const handleSwipe = (deltaX: number): void => {\n    if (deltaX < -DEFAULT_SWIPE_THRESHOLD) {\n      triggerSwipe('left', onSwipeLeft);\n    } else if (deltaX > DEFAULT_SWIPE_THRESHOLD) {\n      triggerSwipe('right', onSwipeRight);\n    }\n  };\n\n  const handleTouchStart = (event: TouchEvent): void => {\n    if (event.touches.length === 1) {\n      startX = event.touches[0].clientX;\n    }\n  };\n\n  const handleTouchEnd = (event: TouchEvent): void => {\n    if (startX === null) {\n      return;\n    }\n    if (event.changedTouches.length === 0) {\n      startX = null;\n      return;\n    }\n    const touch = event.changedTouches[0];\n    handleSwipe(touch.clientX - startX);\n    startX = null;\n  };\n\n  const handleMouseDown = (event: MouseEvent): void => {\n    startX = event.clientX;\n  };\n\n  const handleMouseUp = (event: MouseEvent): void => {\n    if (startX === null) {\n      return;\n    }\n    handleSwipe(event.clientX - startX);\n    startX = null;\n  };\n\n  element.addEventListener('touchstart', handleTouchStart, { passive: true });\n  element.addEventListener('touchend', handleTouchEnd, { passive: true });\n  element.addEventListener('mousedown', handleMouseDown);\n  element.addEventListener('mouseup', handleMouseUp);\n}\n\nexport function goToTab(targetIndex: number, onTabChange: (index: number) => void): void {\n  onTabChange(targetIndex);\n}\n","/**\n * HTML rendering helpers mirrored from the legacy dashboard implementation.\n */\n\nexport type SortDirection = 'asc' | 'desc';\n\nexport type TableAlignment = 'left' | 'right' | 'center';\n\nexport interface TableColumn {\n  key: string;\n  label: string;\n  align?: TableAlignment;\n}\n\nexport interface TableFooterContext {\n  hasValue?: boolean;\n}\n\nexport interface TableOptions {\n  sortable?: boolean;\n  defaultSort?: {\n    key: string;\n    dir?: SortDirection;\n  };\n}\n\nexport type TableRow = Record<string, unknown>;\n\nconst resolveRoundedTrend = (\n  numericValue: number,\n  decimals: number,\n): 'positive' | 'negative' | 'neutral' => {\n  if (!Number.isFinite(numericValue) || numericValue === 0) {\n    return 'neutral';\n  }\n\n  const threshold = 0.5 / Math.pow(10, decimals);\n  if (Math.abs(numericValue) < threshold) {\n    return 'neutral';\n  }\n\n  return numericValue > 0 ? 'positive' : 'negative';\n};\n\nexport function formatValue(\n  key: string,\n  value: unknown,\n  row: TableRow | undefined = undefined,\n  context: TableFooterContext | undefined = undefined,\n): string {\n  let formatted: string | null = null;\n\n  const toNumber = (v: unknown): number => {\n    if (typeof v === 'number') {\n      return v;\n    }\n    if (typeof v === 'string' && v.trim() !== '') {\n      const cleaned = v\n        .replace(/\\s+/g, '')\n        .replace(/[^0-9,.-]/g, '')\n        .replace(/\\.(?=\\d{3}(\\D|$))/g, '')\n        .replace(',', '.');\n      const parsed = Number.parseFloat(cleaned);\n      return Number.isNaN(parsed) ? Number.NaN : parsed;\n    }\n    return Number.NaN;\n  };\n\n  const safeNumber = (v: unknown, minFrac = 2, maxFrac = 2): string => {\n    const num = typeof v === 'number' ? v : toNumber(v);\n    if (!Number.isFinite(num)) {\n      return '';\n    }\n    return num.toLocaleString('de-DE', {\n      minimumFractionDigits: minFrac,\n      maximumFractionDigits: maxFrac\n    });\n  };\n\n  const renderMissingValue = (reason = ''): string => {\n    const title = reason || 'Kein Wert verfügbar';\n    return `<span class=\"missing-value\" role=\"note\" aria-label=\"${title}\" title=\"${title}\">—</span>`;\n  };\n\n  if (['gain_abs', 'gain_pct'].includes(key)) {\n    if (value == null && row) {\n      const performance = row.performance;\n      if (typeof performance === 'object' && performance !== null) {\n        const metric = (performance as Record<string, unknown>)[key];\n        if (typeof metric === 'number') {\n          value = metric;\n        }\n      }\n    }\n    const missingReason = row?.fx_unavailable === true\n      ? 'Wechselkurs nicht verfügbar – EUR-Wert unbekannt'\n      : '';\n    if (value == null || context?.hasValue === false) {\n      return renderMissingValue(missingReason);\n    }\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue(missingReason);\n    }\n    const symbol = key === 'gain_pct' ? '%' : '€';\n    formatted = safeNumber(numeric) + `&nbsp;${symbol}`;\n    const cls = resolveRoundedTrend(numeric, 2);\n    return `<span class=\"${cls}\">${formatted}</span>`;\n  } else if (key === 'position_count') {\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue();\n    }\n    formatted = numeric.toLocaleString('de-DE');\n  } else if (['balance', 'current_value', 'purchase_value'].includes(key)) {\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      if (row?.fx_unavailable) {\n        return renderMissingValue('Wechselkurs nicht verfügbar – EUR-Wert unbekannt');\n      }\n      if (context && context.hasValue === false) {\n        return renderMissingValue();\n      }\n      return renderMissingValue();\n    }\n    formatted = safeNumber(numeric) + '&nbsp;€';\n  } else if (key === 'current_holdings') {\n    // Bestände (Anzahl Anteile) – etwas mehr Präzision (bis 4 Nachkommastellen), aber ohne unnötige Nullen\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue();\n    }\n    const hasFraction = Math.abs(numeric % 1) > 0;\n    formatted = numeric.toLocaleString('de-DE', {\n      minimumFractionDigits: hasFraction ? 2 : 0,\n      maximumFractionDigits: 4\n    });\n  } else {\n    let base = '';\n    if (typeof value === 'string') {\n      base = value;\n    } else if (typeof value === 'number' && Number.isFinite(value)) {\n      base = value.toString();\n    } else if (typeof value === 'boolean') {\n      base = value ? 'true' : 'false';\n    } else if (value instanceof Date && Number.isFinite(value.getTime())) {\n      base = value.toISOString();\n    }\n    formatted = base;\n    if (formatted) {\n      const MAX_LEN = 60;\n      if (formatted.length > MAX_LEN) {\n        formatted = formatted.slice(0, MAX_LEN - 1) + '…';\n      }\n      // Entferne frühere Präfixe (Abwärtskompatibilität)\n      if (formatted.startsWith('Kontostand ')) {\n        formatted = formatted.substring('Kontostand '.length);\n      } else if (formatted.startsWith('Depotwert ')) {\n        formatted = formatted.substring('Depotwert '.length);\n      }\n    }\n  }\n  if (typeof formatted !== 'string' || formatted === '') {\n    return renderMissingValue();\n  }\n\n  return formatted;\n}\n\nexport function makeTable(\n  rows: TableRow[],\n  cols: TableColumn[],\n  sumColumns: readonly string[] = [],\n  options: TableOptions = {},\n): string {\n  /**\n   * Erweiterung (optional):\n   * options.sortable    -> true | false (default false)\n   * options.defaultSort -> { key: 'name', dir: 'asc' } (nur wirksam falls sortable)\n   *\n   * Bestehende Aufrufer (3 Parameter) bleiben kompatibel.\n   */\n  const { sortable = false, defaultSort } = options;\n  const defaultSortKey = defaultSort?.key ?? '';\n  const defaultSortDir: SortDirection = defaultSort?.dir === 'desc' ? 'desc' : 'asc';\n\n  const escapeAttribute = (value: unknown): string => {\n    if (value == null) {\n      return '';\n    }\n    let base = '';\n    if (typeof value === 'string') {\n      base = value;\n    } else if (typeof value === 'number' && Number.isFinite(value)) {\n      base = value.toString();\n    } else if (typeof value === 'boolean') {\n      base = value ? 'true' : 'false';\n    } else if (value instanceof Date && Number.isFinite(value.getTime())) {\n      base = value.toISOString();\n    } else {\n      return '';\n    }\n    return base.replace(/&/g, '&amp;').replace(/\"/g, '&quot;');\n  };\n\n  let html = '<table><thead><tr>';\n  cols.forEach(c => {\n    const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n    // Falls sortable: th data-sort-key setzen (nur wenn key vorhanden)\n    if (sortable && c.key) {\n      html += `<th${alignClass} data-sort-key=\"${c.key}\">${c.label}</th>`;\n    } else {\n      html += `<th${alignClass}>${c.label}</th>`;\n    }\n  });\n  html += '</tr></thead><tbody>';\n\n  rows.forEach(r => {\n    html += '<tr>';\n    cols.forEach(c => {\n      const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n      html += `<td${alignClass}>${formatValue(c.key, r[c.key], r)}</td>`;\n    });\n    html += '</tr>';\n  });\n\n  // Summen berechnen (unverändert)\n  const sums: Record<string, number | null> = {};\n  const sumMeta: Record<string, TableFooterContext> = {};\n  cols.forEach(c => {\n    if (sumColumns.includes(c.key)) {\n      const aggregation = rows.reduce<{ total: number; hasValue: boolean }>(\n        (acc, row) => {\n          let candidate = row[c.key];\n          if ((c.key === 'gain_abs' || c.key === 'gain_pct') && (typeof candidate !== 'number' || !Number.isFinite(candidate))) {\n            const performance = row.performance;\n            if (typeof performance === 'object' && performance !== null) {\n              const metric = (performance as Record<string, unknown>)[c.key];\n              if (typeof metric === 'number') {\n                candidate = metric;\n              }\n            }\n          }\n          if (typeof candidate === 'number' && Number.isFinite(candidate)) {\n            const numericCandidate = candidate;\n            acc.total += numericCandidate;\n            acc.hasValue = true;\n          }\n          return acc;\n        },\n        { total: 0, hasValue: false },\n      );\n      if (aggregation.hasValue) {\n        sums[c.key] = aggregation.total;\n        sumMeta[c.key] = { hasValue: true };\n      } else {\n        sums[c.key] = null;\n        sumMeta[c.key] = { hasValue: false };\n      }\n    }\n  });\n\n  const gainAbsSum = sums['gain_abs'] ?? null;\n  if (gainAbsSum != null) {\n    const purchaseSum = sums['purchase_value'] ?? null;\n    if (purchaseSum != null && purchaseSum > 0) {\n      sums['gain_pct'] = (gainAbsSum / purchaseSum) * 100;\n    } else {\n      const currentValueSum = sums['current_value'] ?? null;\n      if (currentValueSum != null && currentValueSum !== 0) {\n        sums['gain_pct'] = (gainAbsSum / (currentValueSum - gainAbsSum)) * 100;\n      }\n    }\n  }\n\n  const aggregatedGainPct = Number.isFinite(sums['gain_pct'] ?? NaN) ? sums['gain_pct'] : null;\n  let aggregatedGainPctLabel = '';\n  let aggregatedGainPctSign = 'neutral';\n\n  if (aggregatedGainPct != null) {\n    aggregatedGainPctLabel = `${formatNumber(aggregatedGainPct)}\\u00a0%`;\n    if (aggregatedGainPct > 0) {\n      aggregatedGainPctSign = 'positive';\n    } else if (aggregatedGainPct < 0) {\n      aggregatedGainPctSign = 'negative';\n    }\n  }\n\n  html += '<tr class=\"footer-row\">';\n  cols.forEach((c, idx) => {\n    const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n    if (idx === 0) {\n      html += `<td${alignClass}>Summe</td>`;\n      return;\n    }\n\n    if (sums[c.key] != null) {\n      let extraAttributes = '';\n      if (c.key === 'gain_abs' && aggregatedGainPctLabel) {\n        extraAttributes = ` data-gain-pct=\"${escapeAttribute(aggregatedGainPctLabel)}\" data-gain-sign=\"${escapeAttribute(aggregatedGainPctSign)}\"`;\n      }\n      html += `<td${alignClass}${extraAttributes}>${formatValue(c.key, sums[c.key], undefined, sumMeta[c.key])}</td>`;\n      return;\n    }\n\n    if (c.key === 'gain_pct' && sums['gain_pct'] != null) {\n      html += `<td${alignClass}>${formatValue('gain_pct', sums['gain_pct'], undefined, sumMeta[c.key])}</td>`;\n      return;\n    }\n\n    const fallbackContext = sumMeta[c.key] ?? { hasValue: false };\n    html += `<td${alignClass}>${formatValue(c.key, null, undefined, fallbackContext)}</td>`;\n  });\n  html += '</tr>';\n\n  html += '</tbody></table>';\n\n  // Falls sortable: Default-Sort-Metadaten injizieren (nicht doppelt parsen falls nicht nötig)\n  if (sortable) {\n    try {\n      const tpl = document.createElement('template');\n      tpl.innerHTML = html.trim();\n      const table = tpl.content.querySelector<HTMLTableElement>('table');\n      if (table) {\n        table.classList.add('sortable-table');\n        if (defaultSortKey) {\n          table.dataset.defaultSort = defaultSortKey;\n          table.dataset.defaultDir = defaultSortDir;\n        }\n        return table.outerHTML;\n      }\n    } catch (e) {\n      console.warn(\"makeTable(sortable): Injection fehlgeschlagen:\", e);\n    }\n  }\n\n  return html;\n}\n\nexport function createHeaderCard(headerTitle: string, meta: string): HTMLDivElement {\n  const headerCard = document.createElement('div');\n  headerCard.className = 'header-card';\n\n  headerCard.innerHTML = `\n    <div class=\"header-content\">\n      <button id=\"nav-left\" class=\"nav-arrow\" aria-label=\"Vorherige Seite\">\n        <svg viewBox=\"0 0 24 24\">\n          <path d=\"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z\"></path>\n        </svg>\n      </button>\n      <h1 id=\"headerTitle\">${headerTitle}</h1>\n      <button id=\"nav-right\" class=\"nav-arrow\" aria-label=\"Nächste Seite\">\n        <svg viewBox=\"0 0 24 24\">\n          <path d=\"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z\"></path>\n        </svg>\n      </button>\n    </div>\n    <div id=\"headerMeta\" class=\"meta\">${meta}</div>\n  `;\n\n  return headerCard;\n}\n\n// === NEU: Vereinheitlichte Format-Helfer für andere Module (z.B. overview.js) ===\nexport function formatNumber(value: number, minFrac = 2, maxFrac = 2): string {\n  const numeric = Number.isNaN(value) ? 0 : value;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: minFrac,\n    maximumFractionDigits: maxFrac\n  });\n}\n\nexport function formatGain(value: number): string {\n  const num = Number.isNaN(value) ? 0 : value;\n  const cls = resolveRoundedTrend(num, 2);\n  return `<span class=\"${cls}\">${formatNumber(num)}&nbsp;€</span>`;\n}\n\nexport function formatGainPct(value: number): string {\n  const num = Number.isNaN(value) ? 0 : value;\n  const cls = resolveRoundedTrend(num, 2);\n  return `<span class=\"${cls}\">${formatNumber(num)}&nbsp;%</span>`;\n}\n\n/**\n * Neue Utility: sortTableRows\n * Sortiert die Datenzeilen (<tr>) einer Tabelle anhand eines Keys.\n *\n * @param {HTMLTableElement} tableEl  Ziel-Tabelle\n * @param {string} key                Daten-Key (muss mit data-sort-key im TH oder Positions-Mapping übereinstimmen)\n * @param {'asc'|'desc'} dir          Sortierrichtung\n * @param {boolean} isPositions       true => Positions-Spalten-Mapping verwenden\n * @returns {HTMLTableRowElement[]}   Array der neu angeordneten Daten-Zeilen (ohne Footer)\n *\n * Erkennung Zahl vs. String:\n *  - Entfernt NBSP, €, %, Tausenderpunkte\n *  - Wandelt Komma in Punkt\n *  - Wenn parseFloat ein valides Zahlenergebnis liefert und der ursprüngliche Text\n *    nicht komplett alphabetisch ist -> numerischer Vergleich; sonst localeCompare.\n *\n * Footer-Zeile ('.footer-row') bleibt am Ende erhalten.\n */\nexport function sortTableRows(\n  tableEl: HTMLTableElement | null | undefined,\n  key: string,\n  dir: SortDirection = 'asc',\n  isPositions = false,\n): HTMLTableRowElement[] {\n  if (!tableEl) {\n    return [];\n  }\n  const tbody = tableEl.querySelector('tbody');\n  if (!tbody) {\n    return [];\n  }\n\n  const footer = tbody.querySelector<HTMLTableRowElement>('tr.footer-row');\n  const rows = Array\n    .from(tbody.querySelectorAll<HTMLTableRowElement>('tr'))\n    .filter(r => r !== footer);\n\n  // Spaltenindex bestimmen\n  let colIdx = -1;\n  if (isPositions) {\n    const posMap: Record<string, number> = {\n      name: 0,\n      current_holdings: 1,\n      purchase_value: 2,\n      current_value: 3,\n      gain_abs: 4,\n      gain_pct: 5\n    };\n    const mappedIdx = posMap[key];\n    if (typeof mappedIdx === 'number') {\n      colIdx = mappedIdx;\n    }\n  } else {\n    // Generisch über thead th[data-sort-key]\n    const ths = Array.from(tableEl.querySelectorAll<HTMLTableCellElement>('thead th'));\n    for (let i = 0; i < ths.length; i++) {\n      if (ths[i].getAttribute('data-sort-key') === key) {\n        colIdx = i;\n        break;\n      }\n    }\n  }\n  if (colIdx < 0) {\n    return rows;\n  }\n\n  const toNumber = (txt: string): number => {\n    const cleaned = txt\n      .replace(/\\u00A0/g, ' ')\n      .replace(/[%€]/g, '')\n      .replace(/\\./g, '')\n      .replace(/,/g, '.')\n      .replace(/[^\\d.-]/g, '')\n      .trim();\n    if (!cleaned) return NaN;\n    const num = parseFloat(cleaned);\n    return Number.isFinite(num) ? num : NaN;\n  };\n\n  rows.sort((a, b) => {\n    const aCell = a.cells.item(colIdx);\n    const bCell = b.cells.item(colIdx);\n    const aTxt = (aCell?.textContent ?? '').trim();\n    const bTxt = (bCell?.textContent ?? '').trim();\n\n    const aNum = toNumber(aTxt);\n    const bNum = toNumber(bTxt);\n\n    let cmp: number;\n    const hasNumericContext = /[0-9]/.test(aTxt) || /[0-9]/.test(bTxt);\n    if (!Number.isNaN(aNum) && !Number.isNaN(bNum) && hasNumericContext) {\n      cmp = aNum - bNum;\n    } else {\n      cmp = aTxt.localeCompare(bTxt, 'de', { sensitivity: 'base' });\n    }\n    return dir === 'asc' ? cmp : -cmp;\n  });\n\n  // Re-Anordnung im DOM\n  rows.forEach(r => tbody.appendChild(r));\n  if (footer) tbody.appendChild(footer);\n\n  // Visuelle Indikatoren aktualisieren (optional generisch)\n  tableEl.querySelectorAll('thead th.sort-active').forEach(th => {\n    th.classList.remove('sort-active', 'dir-asc', 'dir-desc');\n  });\n  const activeTh = tableEl.querySelector<HTMLElement>(`thead th[data-sort-key=\"${key}\"]`);\n  if (activeTh) {\n    activeTh.classList.add('sort-active', dir === 'asc' ? 'dir-asc' : 'dir-desc');\n  }\n\n  return rows;\n}\n","/**\n * Home Assistant websocket API helpers carried over for TypeScript migration.\n */\n\nimport type {\n  AverageCostPayload,\n  HoldingsAggregationPayload,\n  PanelConfigLike,\n  PerformanceMetricsPayload,\n  PortfolioPosition as TabsPortfolioPosition,\n} from \"../tabs/types\";\nimport type { HomeAssistant } from \"../types/home-assistant\";\n\nexport interface AccountSummary {\n  name?: string | null;\n  currency_code?: string | null;\n  orig_balance?: number | null;\n  balance?: number | null;\n  fx_unavailable?: boolean;\n  [key: string]: unknown;\n}\n\nexport interface PortfolioSummary {\n  uuid?: string | null;\n  name?: string | null;\n  current_value?: number | null;\n  purchase_sum?: number | null;\n  position_count?: number | null;\n  performance?: PerformanceMetricsPayload | null;\n  [key: string]: unknown;\n}\n\nexport interface DashboardDataResponse {\n  accounts: AccountSummary[];\n  portfolios: PortfolioSummary[];\n  last_file_update?: string | null;\n  transactions: unknown[];\n  [key: string]: unknown;\n}\n\nexport interface AccountsResponse {\n  accounts: AccountSummary[];\n  [key: string]: unknown;\n}\n\nexport interface PortfoliosResponse {\n  portfolios: PortfolioSummary[];\n  [key: string]: unknown;\n}\n\nexport type PortfolioPosition = TabsPortfolioPosition;\n\nexport interface PortfolioPositionsResponse {\n  portfolio_uuid: string;\n  positions: PortfolioPosition[];\n  error?: string;\n  [key: string]: unknown;\n}\n\nexport interface SecuritySnapshotResponse {\n  security_uuid: string;\n  snapshot: {\n    name?: string;\n    currency_code?: string;\n    total_holdings?: number;\n    purchase_value_eur?: number;\n    current_value_eur?: number;\n    last_price_native?: number | null;\n    last_price_eur?: number;\n    market_value_eur?: number | null;\n    last_close_native?: number | null;\n    last_close_eur?: number | null;\n    /** Structured selection of average purchase prices with provenance metadata. */\n    average_cost?: AverageCostPayload | null;\n    aggregation?: HoldingsAggregationPayload | null;\n    /** Structured gain and day-change metrics shared across payloads. */\n    performance?: PerformanceMetricsPayload | null;\n    /** Raw snapshot provenance flag (e.g. cache vs. live). */\n    source?: string | null;\n    [key: string]: unknown;\n  };\n  [key: string]: unknown;\n}\n\nexport interface SecurityHistoryPoint {\n  date: number;\n  close: number;\n  close_raw?: number;\n  [key: string]: unknown;\n}\n\nexport interface SecurityHistoryResponse {\n  security_uuid: string;\n  prices: SecurityHistoryPoint[];\n  start_date?: number | null;\n  end_date?: number | null;\n  [key: string]: unknown;\n}\n\nexport interface LastFileUpdateResponse {\n  last_file_update?: string | null;\n  [key: string]: unknown;\n}\n\nexport interface SecurityHistoryOptions {\n  startDate?: number | null;\n  endDate?: number | null;\n  start_date?: number | null;\n  end_date?: number | null;\n  [key: string]: unknown;\n}\n\ninterface SecurityHistoryRequestPayload {\n  type: \"pp_reader/get_security_history\";\n  entry_id: string;\n  security_uuid: string;\n  start_date?: number | null;\n  end_date?: number | null;\n  [key: string]: string | number | null | undefined;\n}\n\nfunction deriveEntryId(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): string | undefined {\n  let entryId =\n    panelConfig?.config?.entry_id ??\n    panelConfig?.entry_id ??\n    panelConfig?.config?._panel_custom?.config?.entry_id ??\n    undefined;\n\n  if (!entryId && hass?.panels) {\n    const panels = hass.panels;\n    const candidate =\n      (panels.ppreader as PanelConfigLike | undefined) ??\n      (panels.pp_reader as PanelConfigLike | undefined) ??\n      (Object.values(panels).find(\n        panel => (panel as PanelConfigLike | undefined)?.webcomponent_name === \"pp-reader-panel\",\n      ) as PanelConfigLike | undefined);\n\n    entryId =\n      candidate?.config?.entry_id ??\n      candidate?.entry_id ??\n      candidate?.config?._panel_custom?.config?.entry_id ??\n      undefined;\n  }\n\n  return entryId ?? undefined;\n}\n\n// Export für andere Module (Dashboard/Event-Filter)\nexport function getEntryId(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): string | undefined {\n  return deriveEntryId(hass, panelConfig);\n}\n\n// Dashboard Data\nexport async function fetchDashboardDataWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<DashboardDataResponse> {\n  if (!hass) {\n    throw new Error(\"fetchDashboardDataWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchDashboardDataWS: fehlendes entry_id\");\n  }\n\n  return hass.connection.sendMessagePromise<DashboardDataResponse>({\n    type: \"pp_reader/get_dashboard_data\",\n    entry_id: entryId,\n  });\n}\n\n// Accounts\nexport async function fetchAccountsWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<AccountsResponse> {\n  if (!hass) {\n    throw new Error(\"fetchAccountsWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchAccountsWS: fehlendes entry_id\");\n  }\n\n  return hass.connection.sendMessagePromise<AccountsResponse>({\n    type: \"pp_reader/get_accounts\",\n    entry_id: entryId,\n  });\n}\n\n// Last file update\nexport async function fetchLastFileUpdateWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<string> {\n  if (!hass) {\n    throw new Error(\"fetchLastFileUpdateWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchLastFileUpdateWS: fehlendes entry_id\");\n  }\n\n  const response = await hass.connection.sendMessagePromise<\n    LastFileUpdateResponse | string\n  >({\n    type: \"pp_reader/get_last_file_update\",\n    entry_id: entryId,\n  });\n\n  if (typeof response === \"string\") {\n    return response;\n  }\n\n  const lastFileUpdate = response.last_file_update;\n  return typeof lastFileUpdate === \"string\" ? lastFileUpdate : \"\";\n}\n\n// Portfolios\nexport async function fetchPortfoliosWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<PortfoliosResponse> {\n  if (!hass) {\n    throw new Error(\"fetchPortfoliosWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchPortfoliosWS: fehlendes entry_id\");\n  }\n\n  return hass.connection.sendMessagePromise<PortfoliosResponse>({\n    type: \"pp_reader/get_portfolio_data\",\n    entry_id: entryId,\n  });\n}\n\n// Positions (lazy)\nexport async function fetchPortfolioPositionsWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  portfolioUuid: string | null | undefined,\n): Promise<PortfolioPositionsResponse> {\n  if (!hass) {\n    throw new Error(\"fetchPortfolioPositionsWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchPortfolioPositionsWS: fehlendes entry_id\");\n  }\n\n  if (!portfolioUuid) {\n    throw new Error(\"fetchPortfolioPositionsWS: fehlendes portfolio_uuid\");\n  }\n\n  return hass.connection.sendMessagePromise<PortfolioPositionsResponse>({\n    type: \"pp_reader/get_portfolio_positions\",\n    entry_id: entryId,\n    portfolio_uuid: portfolioUuid,\n  });\n}\n\n// Security snapshot for detail tab\nexport async function fetchSecuritySnapshotWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  securityUuid: string | null | undefined,\n): Promise<SecuritySnapshotResponse> {\n  if (!hass) {\n    throw new Error(\"fetchSecuritySnapshotWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchSecuritySnapshotWS: fehlendes entry_id\");\n  }\n\n  if (!securityUuid) {\n    throw new Error(\"fetchSecuritySnapshotWS: fehlendes securityUuid\");\n  }\n\n  return hass.connection.sendMessagePromise<SecuritySnapshotResponse>({\n    type: \"pp_reader/get_security_snapshot\",\n    entry_id: entryId,\n    security_uuid: securityUuid,\n  });\n}\n\n// Historical prices for detail tab charting\nexport async function fetchSecurityHistoryWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  securityUuid: string | null | undefined,\n  options: SecurityHistoryOptions | null | undefined = {},\n): Promise<SecurityHistoryResponse> {\n  if (!hass) {\n    throw new Error(\"fetchSecurityHistoryWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchSecurityHistoryWS: fehlendes entry_id\");\n  }\n\n  if (!securityUuid) {\n    throw new Error(\"fetchSecurityHistoryWS: fehlendes securityUuid\");\n  }\n\n  const payload: SecurityHistoryRequestPayload = {\n    type: \"pp_reader/get_security_history\",\n    entry_id: entryId,\n    security_uuid: securityUuid,\n  };\n\n  const { startDate, endDate, start_date: startDateRaw, end_date: endDateRaw } =\n    options || {};\n\n  const resolvedStart = startDate ?? startDateRaw;\n  if (resolvedStart !== undefined && resolvedStart !== null) {\n    payload.start_date = resolvedStart;\n  }\n\n  const resolvedEnd = endDate ?? endDateRaw;\n  if (resolvedEnd !== undefined && resolvedEnd !== null) {\n    payload.end_date = resolvedEnd;\n  }\n\n  return hass.connection.sendMessagePromise<SecurityHistoryResponse>(payload);\n}\n","/**\n * Dashboard registry utilities replacing legacy window.__ppReader* shims.\n *\n * Keeps cross-module helpers and element references in module scope so\n * consumers interact via imports instead of global assignments.\n */\n\nexport type DashboardElement = HTMLElement;\n\nexport type PortfolioPositionsRenderer = (positions: readonly unknown[]) => string;\nexport type GainPctMetadataApplier = (table: HTMLTableElement) => void;\nexport type PortfolioPositionsSortingAttacher = (\n  root: Document | HTMLElement,\n  portfolioUuid: string,\n) => void;\nexport type SecurityDetailListenerAttacher = (\n  root: Document | HTMLElement,\n  portfolioUuid: string,\n) => void;\nexport type PortfolioFooterUpdater = (table: HTMLTableElement | null) => void;\n\ninterface OverviewHelperRegistry {\n  renderPositionsTable?: PortfolioPositionsRenderer;\n  applyGainPctMetadata?: GainPctMetadataApplier;\n  attachSecurityDetailListener?: SecurityDetailListenerAttacher;\n  attachPortfolioPositionsSorting?: PortfolioPositionsSortingAttacher;\n  updatePortfolioFooter?: PortfolioFooterUpdater;\n}\n\nconst dashboardElements = new Set<DashboardElement>();\nconst panelHosts = new Set<HTMLElement>();\nconst overviewHelpers: Partial<OverviewHelperRegistry> = {};\n\ntype OverviewHelperKey = keyof OverviewHelperRegistry;\n\nconst OVERVIEW_HELPER_KEYS: readonly OverviewHelperKey[] = [\n  'renderPositionsTable',\n  'applyGainPctMetadata',\n  'attachSecurityDetailListener',\n  'attachPortfolioPositionsSorting',\n  'updatePortfolioFooter',\n];\n\nfunction setOverviewHelper<K extends OverviewHelperKey>(\n  key: K,\n  helper: OverviewHelperRegistry[K] | undefined,\n): void {\n  if (typeof helper === 'function') {\n    overviewHelpers[key] = helper;\n  }\n}\n\nexport function registerDashboardElement(element: DashboardElement | null | undefined): void {\n  if (!element) {\n    return;\n  }\n  dashboardElements.add(element);\n}\n\nexport function unregisterDashboardElement(element: DashboardElement | null | undefined): void {\n  if (!element) {\n    return;\n  }\n  dashboardElements.delete(element);\n}\n\nexport function getRegisteredDashboardElements(): ReadonlySet<DashboardElement> {\n  return dashboardElements;\n}\n\nexport function registerPanelHost(host: HTMLElement | null | undefined): void {\n  if (!host) {\n    return;\n  }\n  panelHosts.add(host);\n}\n\nexport function unregisterPanelHost(host: HTMLElement | null | undefined): void {\n  if (!host) {\n    return;\n  }\n  panelHosts.delete(host);\n}\n\nexport function getRegisteredPanelHosts(): ReadonlySet<HTMLElement> {\n  return panelHosts;\n}\n\nexport function registerOverviewHelpers(helpers: OverviewHelperRegistry): void {\n  for (const key of OVERVIEW_HELPER_KEYS) {\n    setOverviewHelper(key, helpers[key]);\n  }\n}\n\nexport function getOverviewHelpers(): Readonly<OverviewHelperRegistry> {\n  return overviewHelpers as OverviewHelperRegistry;\n}\n\nexport const __TEST_ONLY__ = {\n  clearRegistries(): void {\n    dashboardElements.clear();\n    panelHosts.clear();\n    for (const key of OVERVIEW_HELPER_KEYS) {\n      overviewHelpers[key] = undefined;\n    }\n  },\n};\n","/**\n * Shared currency helpers for Portfolio Performance Reader dashboard logic.\n */\n\nconst DEFAULT_DECIMALS = 2;\n\nexport interface RoundCurrencyOptions {\n  decimals?: number;\n  fallback?: number | null;\n}\n\nexport function toFiniteCurrency(value: unknown): number | null {\n  if (typeof value === 'number') {\n    return Number.isFinite(value) ? value : null;\n  }\n\n  if (typeof value === 'string') {\n    const trimmed = value.trim().replace(/\\u00a0/g, '');\n    if (!trimmed) {\n      return null;\n    }\n\n    const direct = Number(trimmed);\n    if (Number.isFinite(direct)) {\n      return direct;\n    }\n\n    const stripped = trimmed.replace(/[^0-9.,+-]/g, '');\n    if (!stripped) {\n      return null;\n    }\n\n    const lastComma = stripped.lastIndexOf(',');\n    const lastDot = stripped.lastIndexOf('.');\n    let normalized = stripped;\n\n    const hasComma = lastComma !== -1;\n    const hasDot = lastDot !== -1;\n\n    if (hasComma && (!hasDot || lastComma > lastDot)) {\n      if (!hasDot) {\n        const commaGroups = normalized.split(',');\n        const decimalDigits = commaGroups[commaGroups.length - 1]?.length ?? 0;\n        const integerPart = commaGroups.slice(0, -1).join('');\n        const integerDigits = integerPart.replace(/[+-]/g, '').length;\n        const multipleCommas = commaGroups.length > 2;\n        const integerIsZero = /^[-+]?0$/.test(integerPart);\n\n        const treatAsThousands =\n          multipleCommas ||\n          decimalDigits === 0 ||\n          (decimalDigits === 3 && integerDigits > 0 && integerDigits <= 3 && !integerIsZero);\n\n        normalized = treatAsThousands\n          ? normalized.replace(/,/g, '')\n          : normalized.replace(',', '.');\n      } else {\n        normalized = normalized.replace(/\\./g, '').replace(',', '.');\n      }\n    } else if (hasDot && hasComma && lastDot > lastComma) {\n      normalized = normalized.replace(/,/g, '');\n    } else if (hasDot) {\n      const decimals = normalized.length - lastDot - 1;\n      if (decimals === 3 && /\\d{4,}/.test(normalized.replace(/\\./g, ''))) {\n        normalized = normalized.replace(/\\./g, '');\n      }\n    }\n\n    if (normalized === '-' || normalized === '+') {\n      return null;\n    }\n\n    const localized = Number.parseFloat(normalized);\n    if (Number.isFinite(localized)) {\n      return localized;\n    }\n\n    const relaxed = Number.parseFloat(stripped.replace(',', '.'));\n    if (Number.isFinite(relaxed)) {\n      return relaxed;\n    }\n  }\n\n  return null;\n}\n\nexport function roundCurrency(\n  value: unknown,\n  { decimals = DEFAULT_DECIMALS, fallback = null }: RoundCurrencyOptions = {},\n): number | null {\n  const numeric = toFiniteCurrency(value);\n  if (numeric == null) {\n    return fallback ?? null;\n  }\n\n  const factor = 10 ** decimals;\n  const rounded = Math.round(numeric * factor) / factor;\n  if (Object.is(rounded, -0)) {\n    return 0;\n  }\n\n  return rounded;\n}\n\nexport function normalizeCurrencyValue(\n  value: unknown,\n  options: RoundCurrencyOptions = {},\n): number | null {\n  return roundCurrency(value, options);\n}\n\nexport function normalizePercentValue(\n  value: unknown,\n  options: RoundCurrencyOptions = {},\n): number | null {\n  return roundCurrency(value, options);\n}\n","/**\n * Utilities to normalise backend-provided performance payloads for the PP Reader dashboard.\n */\n\nimport type {\n  PerformanceDayChangePayload,\n  PerformanceMetricsPayload,\n} from \"../tabs/types\";\n\nconst NUMERIC_STRING_PATTERN = /^[+-]?(?:\\d+\\.?\\d*|\\d*\\.?\\d+)(?:[eE][+-]?\\d+)?$/;\n\nconst toFiniteNumber = (value: unknown): number | null => {\n  if (typeof value === \"number\") {\n    return Number.isFinite(value) ? value : null;\n  }\n\n  if (typeof value === \"string\") {\n    const trimmed = value.trim();\n    if (!trimmed) {\n      return null;\n    }\n\n    if (!NUMERIC_STRING_PATTERN.test(trimmed)) {\n      return null;\n    }\n\n    const parsed = Number(trimmed);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return null;\n};\n\nconst toOptionalString = (value: unknown): string | null => {\n  if (typeof value !== \"string\") {\n    return null;\n  }\n  const trimmed = value.trim();\n  return trimmed ? trimmed : null;\n};\n\nfunction normalizeDayChangePayload(raw: unknown): PerformanceDayChangePayload | null {\n  const candidate = raw && typeof raw === \"object\" ? (raw as Record<string, unknown>) : null;\n  if (!candidate) {\n    return null;\n  }\n\n  const priceChangeNative = toFiniteNumber(candidate.price_change_native);\n  const priceChangeEur = toFiniteNumber(candidate.price_change_eur);\n  const changePct = toFiniteNumber(candidate.change_pct);\n\n  if (priceChangeNative == null && priceChangeEur == null && changePct == null) {\n    return null;\n  }\n\n  const source = toOptionalString(candidate.source) ?? \"derived\";\n  const coverage = toFiniteNumber(candidate.coverage_ratio) ?? null;\n\n  return {\n    price_change_native: priceChangeNative,\n    price_change_eur: priceChangeEur,\n    change_pct: changePct,\n    source,\n    coverage_ratio: coverage,\n  };\n}\n\nexport function normalizePerformancePayload(\n  raw: unknown,\n): PerformanceMetricsPayload | null {\n  const candidate = raw && typeof raw === \"object\" ? (raw as Record<string, unknown>) : null;\n  if (!candidate) {\n    return null;\n  }\n\n  const gainAbs = toFiniteNumber(candidate.gain_abs);\n  const gainPct = toFiniteNumber(candidate.gain_pct);\n  const totalChangeEur = toFiniteNumber(candidate.total_change_eur);\n  const totalChangePct = toFiniteNumber(candidate.total_change_pct);\n\n  if (gainAbs == null || gainPct == null || totalChangeEur == null || totalChangePct == null) {\n    return null;\n  }\n\n  const source = toOptionalString(candidate.source) ?? \"derived\";\n  const coverage = toFiniteNumber(candidate.coverage_ratio) ?? null;\n  const dayChange = normalizeDayChangePayload(candidate.day_change);\n\n  return {\n    gain_abs: gainAbs,\n    gain_pct: gainPct,\n    total_change_eur: totalChangeEur,\n    total_change_pct: totalChangePct,\n    source,\n    coverage_ratio: coverage,\n    day_change: dayChange,\n  };\n}\n","/**\n * Shared in-memory portfolio positions cache used by dashboard tabs.\n *\n * Centralises storage for normalised portfolio position payloads so that\n * websocket update handlers and tab renderers can exchange data without\n * relying on window globals. All accessors clone cached entries to prevent\n * consumers from mutating the shared state.\n */\n\nimport type { PortfolioPosition } from '../tabs/types';\n\nexport type PortfolioPositionRecord = PortfolioPosition & { [key: string]: unknown };\n\nconst portfolioPositionsCache = new Map<string, PortfolioPositionRecord[]>();\n\nfunction clonePosition(position: PortfolioPositionRecord): PortfolioPositionRecord {\n  return { ...position };\n}\n\nexport function setPortfolioPositions(\n  portfolioUuid: string | null | undefined,\n  positions: readonly PortfolioPositionRecord[] | null | undefined,\n): void {\n  if (!portfolioUuid) {\n    return;\n  }\n\n  if (!Array.isArray(positions)) {\n    portfolioPositionsCache.delete(portfolioUuid);\n    return;\n  }\n\n  const normalised = positions\n    .filter((candidate): candidate is PortfolioPositionRecord => Boolean(candidate))\n    .map(clonePosition);\n  portfolioPositionsCache.set(portfolioUuid, normalised);\n}\n\nexport function hasPortfolioPositions(portfolioUuid: string | null | undefined): boolean {\n  if (!portfolioUuid) {\n    return false;\n  }\n  return portfolioPositionsCache.has(portfolioUuid);\n}\n\nexport function getPortfolioPositions(\n  portfolioUuid: string | null | undefined,\n): PortfolioPositionRecord[] {\n  if (!portfolioUuid) {\n    return [];\n  }\n  const entries = portfolioPositionsCache.get(portfolioUuid);\n  if (!entries) {\n    return [];\n  }\n  return entries.map(clonePosition);\n}\n\nexport function clearPortfolioPositions(portfolioUuid: string | null | undefined): void {\n  if (!portfolioUuid) {\n    return;\n  }\n  portfolioPositionsCache.delete(portfolioUuid);\n}\n\nexport function clearAllPortfolioPositions(): void {\n  portfolioPositionsCache.clear();\n}\n\nexport function getPortfolioPositionsSnapshot(): ReadonlyMap<string, PortfolioPositionRecord[]> {\n  return new Map(\n    Array.from(portfolioPositionsCache.entries(), ([portfolioUuid, positions]) => [\n      portfolioUuid,\n      positions.map(clonePosition),\n    ]),\n  );\n}\n","/**\n * Live update handlers mirrored from the legacy websocket client.\n */\n\nimport { makeTable } from '../content/elements';\nimport { sortTableRows } from '../content/elements'; // NEU: generische Sortier-Utility\nimport { formatValue } from '../content/elements';\nimport type { SortDirection } from '../content/elements';\nimport { getOverviewHelpers } from '../dashboard/registry';\nimport type {\n  AverageCostPayload,\n  HoldingsAggregationPayload,\n  PerformanceMetricsPayload,\n  PortfolioPositionsUpdatedEventDetail,\n} from '../tabs/types';\nimport { normalizeCurrencyValue, roundCurrency, toFiniteCurrency } from '../utils/currency';\nimport { normalizePerformancePayload } from '../utils/performance';\nimport type { AccountSummary, PortfolioSummary } from './api';\nimport {\n  clearAllPortfolioPositions,\n  getPortfolioPositionsSnapshot,\n  setPortfolioPositions,\n} from './positionsCache';\nimport type { PortfolioPositionRecord } from './positionsCache';\n\nexport type { PortfolioPositionsUpdatedEventDetail } from '../tabs/types';\n\ntype QueryRoot = HTMLElement | Document;\n\ninterface PortfolioPositionData {\n  security_uuid?: string | null;\n  name?: string | null;\n  current_holdings?: number | null;\n  purchase_value?: number | null;\n  current_value?: number | null;\n  average_cost?: AverageCostPayload | null;\n  performance?: PerformanceMetricsPayload | null;\n  aggregation?: HoldingsAggregationPayload | null;\n  [key: string]: unknown;\n}\n\ninterface PortfolioPositionsUpdatePayload {\n  portfolio_uuid?: string | null;\n  portfolioUuid?: string | null;\n  positions?: PortfolioPositionData[] | null;\n  error?: unknown;\n  [key: string]: unknown;\n}\n\ninterface PendingPortfolioUpdate {\n  positions: PortfolioPositionData[];\n  error?: unknown;\n}\n\ninterface PendingRetryMeta {\n  attempts: number;\n  timer: ReturnType<typeof setTimeout> | null;\n}\n\ninterface ApplyPositionsResult {\n  applied: boolean;\n  reason?: 'invalid' | 'missing' | 'hidden';\n}\n\nconst pendingPortfolioUpdates = new Map<string, PendingPortfolioUpdate>();\nconst pendingRetryMetaMap = new Map<string, PendingRetryMeta>();\n\nfunction formatErrorMessage(error: unknown): string {\n  if (typeof error === 'string') {\n    const trimmed = error.trim();\n    return trimmed.length > 0 ? trimmed : 'Unbekannter Fehler';\n  }\n  if (error instanceof Error) {\n    const trimmed = error.message.trim();\n    return trimmed.length > 0 ? trimmed : 'Unbekannter Fehler';\n  }\n  if (error != null) {\n    try {\n      const serialized = JSON.stringify(error);\n      if (serialized && serialized !== '{}') {\n        return serialized;\n      }\n    } catch {\n      // Ignore serialization issues and fall through to default label.\n    }\n  }\n  return 'Unbekannter Fehler';\n}\n\nfunction toNonEmptyString(value: unknown): string | null {\n  if (typeof value !== 'string') {\n    return null;\n  }\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : null;\n}\n\nfunction normalizePerformanceMetrics(\n  position: PortfolioPositionData,\n): PerformanceMetricsPayload | null {\n  return normalizePerformancePayload(position.performance);\n}\n\nfunction cloneAggregationPayload(\n  value: PortfolioPositionData['aggregation'],\n): HoldingsAggregationPayload | null {\n  if (!value || typeof value !== 'object') {\n    return null;\n  }\n\n  const clone: HoldingsAggregationPayload = { ...value };\n  return clone;\n}\n\nfunction cloneAverageCostPayload(\n  value: PortfolioPositionData['average_cost'],\n): AverageCostPayload | null {\n  if (!value || typeof value !== 'object') {\n    return null;\n  }\n\n  const clone: AverageCostPayload = { ...value };\n  return clone;\n}\n\nfunction sanitizePosition(position: PortfolioPositionData): PortfolioPositionRecord | null {\n  const securityUuid = toNonEmptyString(position.security_uuid);\n  const name = toNonEmptyString(position.name);\n  const currentHoldings = toFiniteCurrency(position.current_holdings);\n  const purchaseValue = normalizeCurrencyValue(position.purchase_value);\n  const currentValue = normalizeCurrencyValue(position.current_value);\n  if (\n    !securityUuid ||\n    !name ||\n    currentHoldings == null ||\n    purchaseValue == null ||\n    currentValue == null\n  ) {\n    return null;\n  }\n\n  const aggregation = cloneAggregationPayload(position.aggregation);\n  const averageCost = cloneAverageCostPayload(position.average_cost);\n  const performance = normalizePerformanceMetrics(position);\n\n  const gainAbs = typeof performance?.gain_abs === 'number' ? performance.gain_abs : null;\n  const gainPct = typeof performance?.gain_pct === 'number' ? performance.gain_pct : null;\n\n  return {\n    ...position,\n    security_uuid: securityUuid,\n    name,\n    current_holdings: currentHoldings,\n    purchase_value: purchaseValue,\n    current_value: currentValue,\n    average_cost: averageCost,\n    aggregation,\n    performance,\n    gain_abs: gainAbs,\n    gain_pct: gainPct,\n  } as PortfolioPositionRecord;\n}\n\nfunction sanitizePositions(positions: PortfolioPositionData[]): PortfolioPositionRecord[] {\n  const sanitized: PortfolioPositionRecord[] = [];\n  for (const position of positions) {\n    const normalized = sanitizePosition(position);\n    if (normalized) {\n      sanitized.push(normalized);\n    }\n  }\n  return sanitized;\n}\n\ninterface PortfolioUpdatePayload extends Partial<PortfolioSummary> {\n  uuid?: string | null;\n  value?: number | null;\n  purchaseSum?: number | null;\n  count?: number | null;\n  position_count?: number | null;\n  [key: string]: unknown;\n}\n\nconst PENDING_RETRY_INTERVAL = 500;\nconst PENDING_MAX_ATTEMPTS = 10;\nexport const PORTFOLIO_POSITIONS_UPDATED_EVENT = 'pp-reader:portfolio-positions-updated';\n\nfunction renderPositionsError(error: unknown, portfolioUuid: string): string {\n  const safeError = formatErrorMessage(error);\n  return `<div class=\"error\">${safeError} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n}\n\nfunction restoreSortAndInit(containerEl: HTMLElement, rootEl: QueryRoot, pid: string): void {\n  const table = containerEl.querySelector<HTMLTableElement>('table.sortable-positions');\n  if (!table) return;\n\n  const key = containerEl.dataset.sortKey || table.dataset.defaultSort || 'name';\n  const dirValue = containerEl.dataset.sortDir || table.dataset.defaultDir || 'asc';\n  const direction: SortDirection = dirValue === 'desc' ? 'desc' : 'asc';\n  containerEl.dataset.sortKey = key;\n  containerEl.dataset.sortDir = direction;\n\n  try {\n    sortTableRows(table, key, direction, true);\n  } catch (e) {\n    console.warn('restoreSortAndInit: sortTableRows Fehler:', e);\n  }\n\n  const { attachPortfolioPositionsSorting, attachSecurityDetailListener } = getOverviewHelpers();\n\n  if (attachPortfolioPositionsSorting) {\n    try {\n      attachPortfolioPositionsSorting(rootEl, pid);\n    } catch (e) {\n      console.warn('restoreSortAndInit: attachPortfolioPositionsSorting Fehler:', e);\n    }\n  }\n\n  if (attachSecurityDetailListener) {\n    try {\n      attachSecurityDetailListener(rootEl, pid);\n    } catch (e) {\n      console.warn('restoreSortAndInit: attachSecurityDetailListener Fehler:', e);\n    }\n  }\n}\n\nfunction applyPortfolioPositionsToDom(\n  root: QueryRoot | null | undefined,\n  portfolioUuid: string | null | undefined,\n  positions: PortfolioPositionData[],\n  error?: unknown,\n): ApplyPositionsResult {\n  if (!root || !portfolioUuid) {\n    return { applied: false, reason: 'invalid' };\n  }\n\n  const detailsRow = root.querySelector<HTMLTableRowElement>(\n    `.portfolio-table .portfolio-details[data-portfolio=\"${portfolioUuid}\"]`\n  );\n  if (!detailsRow) {\n    return { applied: false, reason: 'missing' };\n  }\n\n  const container = detailsRow.querySelector<HTMLElement>('.positions-container');\n  if (!container) {\n    return { applied: false, reason: 'missing' };\n  }\n\n  if (detailsRow.classList.contains('hidden')) {\n    return { applied: false, reason: 'hidden' };\n  }\n\n  if (error) {\n    container.innerHTML = renderPositionsError(error, portfolioUuid);\n    return { applied: true };\n  }\n\n  const prevKey = container.dataset.sortKey;\n  const prevDir = container.dataset.sortDir;\n\n  container.innerHTML = renderPositionsTableInline(positions);\n\n  if (prevKey) container.dataset.sortKey = prevKey;\n  if (prevDir) container.dataset.sortDir = prevDir;\n\n  restoreSortAndInit(container, root, portfolioUuid);\n  return { applied: true };\n}\n\nexport function flushPendingPositions(root: QueryRoot | null | undefined, portfolioUuid: string): boolean {\n  const pending = pendingPortfolioUpdates.get(portfolioUuid);\n  if (!pending) return false;\n\n  const result = applyPortfolioPositionsToDom(\n    root,\n    portfolioUuid,\n    pending.positions,\n    pending.error\n  );\n  if (result.applied) {\n    pendingPortfolioUpdates.delete(portfolioUuid);\n  }\n  return result.applied;\n}\n\nexport function flushAllPendingPositions(root: QueryRoot | null | undefined): boolean {\n  let appliedAny = false;\n  for (const [portfolioUuid] of pendingPortfolioUpdates) {\n    if (flushPendingPositions(root, portfolioUuid)) {\n      appliedAny = true;\n    }\n  }\n  return appliedAny;\n}\n\nfunction schedulePendingRetry(root: QueryRoot | null | undefined, portfolioUuid: string): void {\n  const meta: PendingRetryMeta = pendingRetryMetaMap.get(portfolioUuid) ?? {\n    attempts: 0,\n    timer: null,\n  };\n\n  if (meta.timer) {\n    return;\n  }\n\n  meta.timer = setTimeout(() => {\n    meta.timer = null;\n    meta.attempts += 1;\n\n    const success = flushPendingPositions(root, portfolioUuid);\n    if (success || meta.attempts >= PENDING_MAX_ATTEMPTS) {\n      pendingRetryMetaMap.delete(portfolioUuid);\n      if (!success) {\n        pendingPortfolioUpdates.delete(portfolioUuid);\n      }\n    } else {\n      schedulePendingRetry(root, portfolioUuid);\n    }\n  }, PENDING_RETRY_INTERVAL);\n\n  pendingRetryMetaMap.set(portfolioUuid, meta);\n}\n\n/**\n * Handler für Kontodaten-Updates (Accounts, inkl. FX).\n * @param update Die empfangenen Kontodaten (mit currency_code, orig_balance, balance(EUR)).\n * @param root Das Root-Element des Dashboards.\n */\nexport function handleAccountUpdate(\n  update: AccountSummary[] | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  console.log('updateConfigsWS: Kontodaten-Update erhalten:', update);\n  const updatedAccounts = Array.isArray(update) ? update : [];\n\n  if (!root) {\n    return;\n  }\n\n  // Tabellen aktualisieren (EUR + FX)\n  updateAccountTable(updatedAccounts, root);\n\n  // Portfolios aus aktueller Tabelle lesen (für Total-Neuberechnung)\n  const portfolioTable = root.querySelector<HTMLTableElement>('.portfolio-table table');\n  const portfolios = portfolioTable\n    ? Array.from(\n        portfolioTable.querySelectorAll<HTMLTableRowElement>('tbody tr:not(.footer-row)'),\n      ).map(row => {\n        // Spalten: Name | position_count | current_value | gain_abs | gain_pct\n        const currentValueCell = row.cells.item(2);\n        const textContent = currentValueCell?.textContent ?? '';\n        const numeric = parseFloat(\n          textContent.replace(/\\./g, '').replace(',', '.').replace(/[^\\d.-]/g, ''),\n        );\n        return {\n          current_value: Number.isFinite(numeric) ? numeric : 0,\n        };\n      })\n    : [];\n\n  updateTotalWealth(updatedAccounts, portfolios, root);\n}\n\n/**\n * Aktualisiert die Tabellen mit den Kontodaten (EUR + FX).\n * @param {Array} accounts - Alle Kontodaten.\n * @param {HTMLElement} root - Root-Element.\n */\nfunction updateAccountTable(accounts: AccountSummary[], root: QueryRoot): void {\n  const eurContainer = root.querySelector<HTMLElement>('.account-table');\n  const fxContainer = root.querySelector<HTMLElement>('.fx-account-table');\n\n  const eurAccounts = accounts.filter(account => (account.currency_code || 'EUR') === 'EUR');\n  const fxAccounts = accounts.filter(account => (account.currency_code || 'EUR') !== 'EUR');\n\n  if (eurContainer) {\n    eurContainer.innerHTML = makeTable(\n      eurAccounts,\n      [\n        { key: 'name', label: 'Name' },\n        { key: 'balance', label: 'Kontostand (EUR)', align: 'right' },\n      ],\n      ['balance'],\n    );\n  } else {\n    console.warn('updateAccountTable: .account-table nicht gefunden.');\n  }\n\n  if (fxContainer) {\n    fxContainer.innerHTML = makeTable(\n      fxAccounts.map(account => {\n        const origBalance = account.orig_balance;\n        const hasOrigBalance = typeof origBalance === 'number' && Number.isFinite(origBalance);\n        const currencyCode = toNonEmptyString(account.currency_code);\n        const amountLabel = hasOrigBalance\n          ? origBalance.toLocaleString('de-DE', {\n              minimumFractionDigits: 2,\n              maximumFractionDigits: 2,\n            })\n          : null;\n        const fxDisplay = amountLabel\n          ? currencyCode\n            ? `${amountLabel}\\u00A0${currencyCode}`\n            : amountLabel\n          : '';\n\n        return {\n          ...account,\n          fx_display: fxDisplay,\n        };\n      }),\n      [\n        { key: 'name', label: 'Name' },\n        { key: 'fx_display', label: 'Betrag (FX)' },\n        { key: 'balance', label: 'EUR', align: 'right' },\n      ],\n      ['balance'],\n    );\n  } else if (fxAccounts.length) {\n    console.warn('updateAccountTable: .fx-account-table nicht gefunden, obwohl FX-Konten vorhanden sind.');\n  }\n}\n\n/**\n * Handler für Depot-Updates (aggregierte Portfolio-Werte).\n * Ersetzt die bisherige komplette Tabellen-Neuerstellung durch ein gezieltes Patchen\n * der vorhandenen expandierbaren Tabelle (gebaut in overview.js).\n */\nexport function handlePortfolioUpdate(\n  update: PortfolioUpdatePayload[] | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  if (!Array.isArray(update)) {\n    console.warn('handlePortfolioUpdate: Update ist kein Array:', update);\n    return;\n  }\n\n  try {\n    console.debug('handlePortfolioUpdate: payload=', update);\n  } catch {\n    // no-op for browsers without console.debug\n  }\n\n  if (!root) {\n    return;\n  }\n\n  // Tabelle finden (neuer Selektor unterstützt beide Varianten)\n  const table =\n    root.querySelector<HTMLTableElement>('.portfolio-table table') ||\n    root.querySelector<HTMLTableElement>('table.expandable-portfolio-table');\n  if (!table) {\n    const overviewHost = root.querySelector('.portfolio-table');\n    const detailViewActive =\n      !overviewHost &&\n      (root.querySelector('.security-range-selector') ||\n        root.querySelector('.security-detail-placeholder'));\n\n    if (detailViewActive) {\n      console.debug(\n        'handlePortfolioUpdate: Übersicht nicht aktiv – Update wird später angewendet.',\n      );\n    } else {\n      console.warn('handlePortfolioUpdate: Keine Portfolio-Tabelle gefunden.');\n    }\n    return;\n  }\n\n  const tbody = table.tBodies.item(0) ?? table.querySelector('tbody');\n  if (!tbody) {\n    console.warn('handlePortfolioUpdate: Kein <tbody> in Tabelle.');\n    return;\n  }\n\n  // Helper Formatierer (lokal oder einfacher Fallback)\n  const formatNumberLocal = (val: number): string => {\n    if (typeof Intl !== 'undefined') {\n      try {\n        const locale = typeof navigator !== 'undefined' && navigator.language\n          ? navigator.language\n          : 'de-DE';\n        return new Intl.NumberFormat(locale, {\n          minimumFractionDigits: 2,\n          maximumFractionDigits: 2,\n        }).format(val);\n      } catch {\n        // fallback below\n      }\n    }\n    const rounded = roundCurrency(val, { fallback: 0 }) ?? 0;\n    return rounded.toFixed(2).replace('.', ',');\n  };\n\n  // Map: uuid -> Row\n  const rowMap = new Map<string, HTMLTableRowElement>();\n  const portfolioRows = tbody.querySelectorAll<HTMLTableRowElement>('tr.portfolio-row');\n  portfolioRows.forEach(row => {\n    const portfolio = row.dataset.portfolio;\n    if (portfolio) {\n      rowMap.set(portfolio, row);\n    }\n  });\n\n  let patched = 0;\n\n  const formatPositionCount = (value: number | null | undefined): string => {\n    const numeric = typeof value === 'number' && Number.isFinite(value) ? value : 0;\n    try {\n      return numeric.toLocaleString('de-DE');\n    } catch {\n      return numeric.toString();\n    }\n  };\n\n  for (const entry of update) {\n    const uuid = entry.uuid;\n    if (typeof uuid !== 'string' || !uuid) {\n      continue;\n    }\n    const row = rowMap.get(uuid);\n    if (!row) {\n      continue;\n    }\n\n    if (row.cells.length < 3) {\n      continue;\n    }\n\n    const posCountCell = row.cells.item(1);\n    const curValCell = row.cells.item(2);\n    const gainAbsCell = row.cells.item(3);\n    const gainPctCell = row.cells.item(4);\n\n    if (!posCountCell || !curValCell) {\n      continue;\n    }\n\n    // Normalisierung (Full Sync nutzt value/purchase_sum; Price Events current_value/purchase_sum)\n    const posCount = toFiniteNumber(entry.position_count ?? entry.count);\n    const curVal = toFiniteNumber(entry.current_value ?? entry.value);\n    const entryRecord = entry as Record<string, unknown>;\n    const performance = normalizePerformancePayload(entryRecord['performance']);\n    const gainAbs = typeof performance?.gain_abs === 'number' ? performance.gain_abs : null;\n    const gainPct = typeof performance?.gain_pct === 'number' ? performance.gain_pct : null;\n    const purchaseRaw = entry.purchase_sum ?? entry.purchaseSum ?? null;\n    const purchase = typeof purchaseRaw === 'number' && Number.isFinite(purchaseRaw)\n      ? purchaseRaw\n      : null;\n\n    const oldCur = parseNumLoose(curValCell.textContent);\n    const oldCnt = parseNumLoose(posCountCell.textContent);\n\n    if (oldCnt !== posCount) {\n      posCountCell.textContent = formatPositionCount(posCount);\n    }\n    const hasValue = Number.isFinite(curVal);\n    const rowData = {\n      fx_unavailable: Boolean(entryRecord['fx_unavailable']),\n      current_value: hasValue ? curVal : null,\n      performance,\n    };\n    const rowContext = { hasValue };\n    const currentMarkup = formatValue('current_value', rowData.current_value, rowData, rowContext);\n    if (Math.abs(oldCur - curVal) >= 0.005 || curValCell.innerHTML !== currentMarkup) {\n      curValCell.innerHTML = currentMarkup;\n      row.classList.add('flash-update');\n      setTimeout(() => {\n        row.classList.remove('flash-update');\n      }, 800);\n    }\n    if (gainAbsCell) {\n      const gainMarkup = formatValue('gain_abs', gainAbs, rowData, rowContext);\n      gainAbsCell.innerHTML = gainMarkup;\n      const hasGainPct = typeof gainPct === 'number' && Number.isFinite(gainPct);\n      const pctValue = hasGainPct ? gainPct : null;\n      gainAbsCell.dataset.gainPct = pctValue != null\n        ? `${formatNumberLocal(pctValue)} %`\n        : '—';\n      gainAbsCell.dataset.gainSign = pctValue != null\n        ? pctValue > 0\n          ? 'positive'\n          : pctValue < 0\n            ? 'negative'\n            : 'neutral'\n        : 'neutral';\n    }\n    if (gainPctCell) {\n      gainPctCell.innerHTML = formatValue('gain_pct', gainPct, rowData, rowContext);\n    }\n\n    row.dataset.positionCount = posCount.toString();\n    row.dataset.currentValue = hasValue ? curVal.toString() : '';\n    row.dataset.purchaseSum = purchase != null ? purchase.toString() : '';\n    row.dataset.gainAbs = gainAbs != null ? gainAbs.toString() : '';\n    row.dataset.gainPct = gainPct != null ? gainPct.toString() : '';\n\n    patched += 1;\n  }\n\n  if (patched === 0) {\n    console.debug('handlePortfolioUpdate: Keine passenden Zeilen gefunden / keine Änderungen.');\n  } else {\n    const patchedLabel = patched.toLocaleString('de-DE');\n    console.debug(`handlePortfolioUpdate: ${patchedLabel} Zeile(n) gepatcht.`);\n  }\n\n  try {\n    updatePortfolioFooter(table);\n  } catch (error) {\n    console.warn('handlePortfolioUpdate: Fehler bei Summen-Neuberechnung:', error);\n  }\n\n  // Total-Wealth neu berechnen (Accounts + Portfolios)\n  try {\n    const findTable = (...selectors: Array<string | null | undefined>): HTMLTableElement | null => {\n      for (const selector of selectors) {\n        if (!selector) continue;\n        const tableEl = root.querySelector<HTMLTableElement>(selector);\n        if (tableEl) return tableEl;\n      }\n      return null;\n    };\n\n    const eurTable = findTable(\n      '.account-table table',\n      '.accounts-eur-table table',\n      '.accounts-table table',\n    );\n    const fxTable = findTable(\n      '.fx-account-table table',\n      '.accounts-fx-table table',\n    );\n\n    const extractAccounts = (tbl: HTMLTableElement | null, isFx: boolean): Array<{ balance: number }> => {\n      if (!tbl) return [];\n      const accountRows = tbl.querySelectorAll<HTMLTableRowElement>('tbody tr.account-row');\n      const rows = accountRows.length\n        ? Array.from(accountRows)\n        : Array.from(tbl.querySelectorAll<HTMLTableRowElement>('tbody tr:not(.footer-row)'));\n\n      return rows.map(row => {\n        const cell = isFx ? row.cells.item(2) : row.cells.item(1);\n        return { balance: parseNumLoose(cell?.textContent) };\n      });\n    };\n    const accounts = [\n      ...extractAccounts(eurTable, false),\n      ...extractAccounts(fxTable, true),\n    ];\n\n    const portfolioDomValues = Array.from(\n      table.querySelectorAll<HTMLTableRowElement>('tbody tr.portfolio-row'),\n    ).map(row => {\n      const currentValueRaw = row.dataset.currentValue;\n      const purchaseSumRaw = row.dataset.purchaseSum;\n      const currentValue = currentValueRaw ? Number.parseFloat(currentValueRaw) : Number.NaN;\n      const purchaseSum = purchaseSumRaw ? Number.parseFloat(purchaseSumRaw) : Number.NaN;\n      return {\n        current_value: Number.isFinite(currentValue) ? currentValue : 0,\n        purchase_sum: Number.isFinite(purchaseSum) ? purchaseSum : 0,\n      };\n    });\n\n    updateTotalWealth(accounts, portfolioDomValues, root);\n  } catch (error) {\n    console.warn('handlePortfolioUpdate: Fehler bei Total-Neuberechnung:', error);\n  }\n}\n\n/**\n * NEU: Handler für Einzel-Positions-Updates (Event: portfolio_positions).\n * @param {{portfolio_uuid: string, positions: Array}} update\n * @param {HTMLElement} root\n */\nfunction normalizePortfolioUuid(payload: PortfolioPositionsUpdatePayload | null | undefined): string | null {\n  if (!payload || typeof payload !== 'object') {\n    return null;\n  }\n  const direct = payload.portfolio_uuid;\n  if (typeof direct === 'string' && direct) {\n    return direct;\n  }\n  const camelCase = payload.portfolioUuid;\n  if (typeof camelCase === 'string' && camelCase) {\n    return camelCase;\n  }\n  return null;\n}\n\nfunction processPortfolioPositionsUpdate(\n  update: PortfolioPositionsUpdatePayload | null | undefined,\n  root: QueryRoot | null | undefined,\n): boolean {\n  const portfolioUuid = normalizePortfolioUuid(update);\n  if (!portfolioUuid) {\n    console.warn('handlePortfolioPositionsUpdate: Ungültiges Update:', update);\n    return false;\n  }\n\n  const error = update?.error;\n  const positions = Array.isArray(update?.positions)\n    ? update.positions.filter((pos): pos is PortfolioPositionData => Boolean(pos))\n    : [];\n  const normalizedPositions = sanitizePositions(positions);\n\n  if (!error) {\n    setPortfolioPositions(portfolioUuid, normalizedPositions);\n  }\n\n  const result = applyPortfolioPositionsToDom(root, portfolioUuid, normalizedPositions, error);\n\n  if (result.applied) {\n    pendingPortfolioUpdates.delete(portfolioUuid);\n  } else {\n    pendingPortfolioUpdates.set(portfolioUuid, { positions: normalizedPositions, error });\n    if (result.reason !== 'hidden') {\n      schedulePendingRetry(root, portfolioUuid);\n    }\n  }\n\n  if (!error && normalizedPositions.length > 0) {\n    const securityUuids = Array.from(\n      new Set(\n        normalizedPositions\n          .map(pos => pos.security_uuid)\n          .filter((uuid): uuid is string => typeof uuid === 'string' && uuid.length > 0),\n      ),\n    );\n\n    if (securityUuids.length && typeof window !== 'undefined') {\n      try {\n        window.dispatchEvent(\n          new CustomEvent<PortfolioPositionsUpdatedEventDetail>(\n            PORTFOLIO_POSITIONS_UPDATED_EVENT,\n            {\n              detail: {\n                portfolioUuid,\n                securityUuids,\n              },\n            },\n          ),\n        );\n      } catch (dispatchError) {\n        console.warn(\n          'handlePortfolioPositionsUpdate: Dispatch des Portfolio-Events fehlgeschlagen',\n          dispatchError,\n        );\n      }\n    }\n  }\n\n  return true;\n}\n\nexport function handlePortfolioPositionsUpdate(\n  update: PortfolioPositionsUpdatePayload | PortfolioPositionsUpdatePayload[] | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  if (Array.isArray(update)) {\n    let handled = false;\n    for (const item of update) {\n      if (processPortfolioPositionsUpdate(item, root)) {\n        handled = true;\n      }\n    }\n    if (!handled && update.length) {\n      console.warn('handlePortfolioPositionsUpdate: Kein gültiges Element im Array:', update);\n    }\n    return;\n  }\n\n  processPortfolioPositionsUpdate(update, root);\n}\n\n/* ------------------ Hilfsfunktionen (lokal) ------------------ */\n\nfunction renderPositionsTableInline(positions: PortfolioPositionData[]): string {\n  // Konsistenz Push vs Lazy:\n  const { renderPositionsTable, applyGainPctMetadata } = getOverviewHelpers();\n  try {\n    if (typeof renderPositionsTable === 'function') {\n      return renderPositionsTable(positions);\n    }\n  } catch (_) {}\n\n  if (positions.length === 0) {\n    return '<div class=\"no-positions\">Keine Positionen vorhanden.</div>';\n  }\n  const rows = positions.map(position => {\n    const performance = normalizePerformanceMetrics(position);\n\n    return {\n      name: position.name,\n      current_holdings: position.current_holdings,\n      purchase_value: position.purchase_value,\n      current_value: position.current_value,\n      performance,\n    };\n  });\n\n  // Basis HTML\n  const raw = makeTable(\n    rows,\n    [\n      { key: 'name', label: 'Wertpapier' },\n      { key: 'current_holdings', label: 'Bestand', align: 'right' },\n      { key: 'purchase_value', label: 'Kaufwert', align: 'right' },\n      { key: 'current_value', label: 'Aktueller Wert', align: 'right' },\n      { key: 'gain_abs', label: '+/-', align: 'right' },\n      { key: 'gain_pct', label: '%', align: 'right' }\n    ],\n    ['purchase_value', 'current_value', 'gain_abs']\n  );\n\n  // Sortier-Metadaten wie in overview.js renderPositionsTable injizieren\n  try {\n    const tpl = document.createElement('template');\n    tpl.innerHTML = raw.trim();\n    const table = tpl.content.querySelector<HTMLTableElement>('table');\n    if (table) {\n      table.classList.add('sortable-positions');\n      const ths = table.querySelectorAll<HTMLTableCellElement>('thead th');\n      const colKeys = ['name', 'current_holdings', 'purchase_value', 'current_value', 'gain_abs', 'gain_pct'];\n      ths.forEach((th, i) => {\n        const key = colKeys[i];\n        if (!key) return;\n        th.setAttribute('data-sort-key', key);\n        th.classList.add('sortable-col');\n      });\n      const bodyRows = table.querySelectorAll<HTMLTableRowElement>('tbody tr');\n      bodyRows.forEach((tr, idx) => {\n        if (tr.classList.contains('footer-row')) {\n          return;\n        }\n        const pos = positions[idx];\n        if (pos.security_uuid) {\n          tr.dataset.security = pos.security_uuid;\n        }\n        tr.classList.add('position-row');\n      });\n      table.dataset.defaultSort = 'name';\n      table.dataset.defaultDir = 'asc';\n      const gainPctMetadata = applyGainPctMetadata;\n      if (gainPctMetadata) {\n        try {\n          gainPctMetadata(table);\n        } catch (err) {\n          console.warn('renderPositionsTableInline: applyGainPctMetadata failed', err);\n        }\n      } else {\n        const rows = table.querySelectorAll<HTMLTableRowElement>('tbody tr');\n        rows.forEach((row, idx) => {\n          if (row.classList.contains('footer-row')) {\n            return;\n          }\n          const gainCell = row.cells.item(4);\n          if (!gainCell) {\n            return;\n          }\n          const position = positions[idx];\n          const performance = normalizePerformanceMetrics(position);\n          const gainPctValue =\n            typeof performance?.gain_pct === 'number' &&\n            Number.isFinite(performance.gain_pct)\n              ? performance.gain_pct\n              : null;\n          const pctLabel =\n            gainPctValue != null\n              ? `${gainPctValue.toLocaleString('de-DE', {\n                  minimumFractionDigits: 2,\n                  maximumFractionDigits: 2,\n                })} %`\n              : '—';\n          const pctSign =\n            gainPctValue == null\n              ? 'neutral'\n              : gainPctValue > 0\n                ? 'positive'\n                : gainPctValue < 0\n                  ? 'negative'\n                  : 'neutral';\n          gainCell.dataset.gainPct = pctLabel;\n          gainCell.dataset.gainSign = pctSign;\n        });\n      }\n      return table.outerHTML;\n    }\n  } catch (e) {\n    console.warn(\"renderPositionsTableInline: Sortier-Metadaten Injection fehlgeschlagen:\", e);\n  }\n  return raw;\n}\n\nfunction updatePortfolioFooter(table: HTMLTableElement | null): void {\n  if (!table) return;\n  const { updatePortfolioFooter: helper } = getOverviewHelpers();\n  if (typeof helper === 'function') {\n    try {\n      helper(table);\n      return;\n    } catch (err) {\n      console.warn('updatePortfolioFooter: helper schlug fehl:', err);\n    }\n  }\n\n  const rows = Array.from(table.querySelectorAll<HTMLTableRowElement>('tbody tr.portfolio-row'));\n\n  const parseDatasetNumber = (value: string | undefined): number | null => {\n    if (value === undefined) {\n      return null;\n    }\n    const parsed = Number.parseFloat(value);\n    return Number.isFinite(parsed) ? parsed : null;\n  };\n\n  const metrics = rows.reduce(\n    (acc, row) => {\n\n      const positionCount = parseDatasetNumber(row.dataset.positionCount);\n      if (positionCount != null) {\n        acc.sumPositions += positionCount;\n      }\n\n      if (row.dataset.fxUnavailable === 'true') {\n        acc.fxUnavailable = true;\n      }\n\n      if (row.dataset.hasValue !== 'true') {\n        acc.incompleteRows += 1;\n        return acc;\n      }\n\n      acc.valueRows += 1;\n\n      const currentValue = parseDatasetNumber(row.dataset.currentValue);\n      const gainAbs = parseDatasetNumber(row.dataset.gainAbs);\n      const purchaseSum = parseDatasetNumber(row.dataset.purchaseSum);\n\n      if (currentValue == null || gainAbs == null || purchaseSum == null) {\n        acc.incompleteRows += 1;\n        return acc;\n      }\n\n      acc.sumCurrent += currentValue;\n      acc.sumGainAbs += gainAbs;\n      acc.sumPurchase += purchaseSum;\n\n      return acc;\n    },\n    {\n      sumCurrent: 0,\n      sumGainAbs: 0,\n      sumPurchase: 0,\n      sumPositions: 0,\n      valueRows: 0,\n      incompleteRows: 0,\n      fxUnavailable: false,\n    },\n  );\n\n  const totalsComplete = metrics.valueRows > 0 && metrics.incompleteRows === 0;\n  const sumGainPct = totalsComplete && metrics.sumPurchase > 0 ? (metrics.sumGainAbs / metrics.sumPurchase) * 100 : null;\n\n  let footer = table.querySelector<HTMLTableRowElement>('tr.footer-row');\n  if (!footer) {\n    footer = document.createElement('tr');\n    footer.className = 'footer-row';\n    table.querySelector('tbody')?.appendChild(footer);\n  }\n  const sumPositionsDisplay = Math.round(metrics.sumPositions).toLocaleString('de-DE');\n  const footerRowData = {\n    fx_unavailable: metrics.fxUnavailable || !totalsComplete,\n    current_value: totalsComplete ? metrics.sumCurrent : null,\n    performance: totalsComplete\n      ? {\n          gain_abs: metrics.sumGainAbs,\n          gain_pct: sumGainPct,\n          total_change_eur: metrics.sumGainAbs,\n          total_change_pct: sumGainPct,\n          source: 'aggregated',\n          coverage_ratio: 1,\n        }\n      : null,\n  } as Record<string, unknown>;\n  const footerContext = { hasValue: totalsComplete };\n\n  const currentValueCell = formatValue('current_value', footerRowData.current_value, footerRowData, footerContext);\n  const gainAbsValue = totalsComplete ? metrics.sumGainAbs : null;\n  const gainPctValue = totalsComplete ? sumGainPct : null;\n  const gainAbsCellMarkup = formatValue('gain_abs', gainAbsValue, footerRowData, footerContext);\n  const gainPctCellMarkup = formatValue('gain_pct', gainPctValue, footerRowData, footerContext);\n\n  footer.innerHTML = `\n    <td>Summe</td>\n    <td class=\"align-right\">${sumPositionsDisplay}</td>\n    <td class=\"align-right\">${currentValueCell}</td>\n    <td class=\"align-right\">${gainAbsCellMarkup}</td>\n    <td class=\"align-right\">${gainPctCellMarkup}</td>\n  `;\n  const footerGainAbsCell = footer.cells.item(3);\n  if (footerGainAbsCell) {\n    footerGainAbsCell.dataset.gainPct = totalsComplete && typeof sumGainPct === 'number'\n      ? `${formatNumber(sumGainPct)} %`\n      : '—';\n    footerGainAbsCell.dataset.gainSign = totalsComplete && typeof sumGainPct === 'number'\n      ? sumGainPct > 0\n        ? 'positive'\n        : sumGainPct < 0\n          ? 'negative'\n          : 'neutral'\n      : 'neutral';\n  }\n  footer.dataset.positionCount = Math.round(metrics.sumPositions).toString();\n  footer.dataset.currentValue = totalsComplete ? metrics.sumCurrent.toString() : '';\n  footer.dataset.purchaseSum = totalsComplete ? metrics.sumPurchase.toString() : '';\n  footer.dataset.gainAbs = totalsComplete ? metrics.sumGainAbs.toString() : '';\n  footer.dataset.gainPct = totalsComplete && typeof sumGainPct === 'number' ? sumGainPct.toString() : '';\n  footer.dataset.hasValue = totalsComplete ? 'true' : 'false';\n  footer.dataset.fxUnavailable = metrics.fxUnavailable || !totalsComplete ? 'true' : 'false';\n}\n\nfunction toFiniteNumber(value: unknown): number {\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n  if (typeof value === 'string') {\n    const parsed = Number.parseFloat(value);\n    return Number.isFinite(parsed) ? parsed : 0;\n  }\n  return 0;\n}\n\nfunction formatNumber(v: number): string {\n  const rounded = roundCurrency(v, { fallback: 0 }) ?? 0;\n  return rounded.toLocaleString('de-DE', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2,\n  });\n}\n\nfunction updateTotalWealth(\n  accounts: Array<{ balance?: number | null; current_value?: number | null; value?: number | null }> | null | undefined,\n  portfolios: Array<{ current_value?: number | null; value?: number | null; purchase_sum?: number | null }> | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  const targetRoot: QueryRoot = root ?? document;\n\n  const accountEntries = Array.isArray(accounts) ? accounts : [];\n  const accountSum = accountEntries.reduce((acc, entry) => {\n    const candidate = entry.balance ?? entry.current_value ?? entry.value ?? 0;\n    return acc + toFiniteNumber(candidate);\n  }, 0);\n\n  const portfolioEntries = Array.isArray(portfolios) ? portfolios : [];\n  const portfolioSum = portfolioEntries.reduce((acc, entry) => {\n    const candidate = entry.current_value ?? entry.value ?? 0;\n    return acc + toFiniteNumber(candidate);\n  }, 0);\n\n  const totalWealth = accountSum + portfolioSum;\n\n  const headerMeta = targetRoot.querySelector<HTMLElement>('#headerMeta');\n  if (!headerMeta) {\n    console.warn('updateTotalWealth: #headerMeta nicht gefunden.');\n    return;\n  }\n\n  const valueElement =\n    headerMeta.querySelector<HTMLElement>('strong') ||\n    headerMeta.querySelector<HTMLElement>('.total-wealth-value');\n  if (valueElement) {\n    valueElement.textContent = `${formatNumber(totalWealth)}\\u00A0€`;\n  } else {\n    headerMeta.textContent = `💰 Gesamtvermögen: ${formatNumber(totalWealth)}\\u00A0€`;\n  }\n\n  headerMeta.dataset.totalWealthEur = totalWealth.toString();\n}\n\n/**\n * HINWEIS (2025-09):\n * Die frühere Funktion updatePortfolioTable (vollständiger Neuaufbau der Depot-Tabelle)\n * wurde durch inkrementelles Patchen via handlePortfolioUpdate + Lazy-Load der Positions-\n * daten ersetzt. Alte Implementierung entfernt, um doppelte Logik und Render-Flashes\n * zu vermeiden.\n *\n * Falls noch Referenzen auf updatePortfolioTable existieren, bitte auf handlePortfolioUpdate\n * umstellen. (Das Dashboard-Modul ruft bereits nur noch _doRender -> handlePortfolioUpdate auf.)\n */\n// Entfernte Legacy-Funktion:\n// function updatePortfolioTable(...) { /* veraltet, entfernt */ }\n\n// ==== Last File Update Handler (canonical) ====\n// (Ändere zu export function, damit unten kein Sammel-Export nötig ist)\nexport function handleLastFileUpdate(\n  update: string | { last_file_update?: string | null } | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  const resolvedUpdate = typeof update === 'string' ? update : update?.last_file_update;\n  const value = toNonEmptyString(resolvedUpdate) ?? '';\n\n  if (!root) {\n    console.warn('handleLastFileUpdate: root fehlt');\n    return;\n  }\n\n  // Bevorzugt Footer-Karte, sonst erste passende Stelle\n  let el =\n    root.querySelector<HTMLElement>('.footer-card .last-file-update') ||\n    root.querySelector<HTMLElement>('.last-file-update');\n\n  if (!el) {\n    // Fallback: existierende Meta-Hosts durchsuchen\n    const metaHost =\n      root.querySelector<HTMLElement>('.footer-card .meta') ||\n      root.querySelector<HTMLElement>('#headerMeta') ||\n      root.querySelector<HTMLElement>('.header-card .meta') ||\n      root.querySelector<HTMLElement>('.header-card');\n    if (!metaHost) {\n      console.warn('handleLastFileUpdate: Kein Einfügepunkt gefunden.');\n      return;\n    }\n    el = document.createElement('div');\n    el.className = 'last-file-update';\n    metaHost.appendChild(el);\n  }\n\n  // Format abhängig vom Ort (Footer behält <strong>)\n  if (el.closest('.footer-card')) {\n    el.innerHTML = value\n      ? `📂 Letzte Aktualisierung der Datei: <strong>${value}</strong>`\n      : '📂 Letzte Aktualisierung der Datei: <strong>Unbekannt</strong>';\n  } else {\n    // Header/Meta-Version (schlichter Text)\n    el.textContent = value\n      ? `📂 Letzte Aktualisierung: ${value}`\n      : '📂 Letzte Aktualisierung: Unbekannt';\n  }\n}\n/// END handleLastFileUpdate (canonical)\n\n/**\n * NEUER HELPER (Änderung 8):\n * Re-applied die gespeicherte Sortierung einer Positions-Tabelle.\n * Liest container.dataset.sortKey / sortDir oder Default-Werte vom <table>.\n * Nutzt sortTableRows(..., true) für Positions-Mapping.\n * @param {HTMLElement} containerEl .positions-container\n */\nexport function reapplyPositionsSort(containerEl: HTMLElement | null | undefined): void {\n  if (containerEl == null) {\n    return;\n  }\n  const table = containerEl.querySelector<HTMLTableElement>('table.sortable-positions');\n  if (table == null) {\n    return;\n  }\n  const key = containerEl.dataset.sortKey || table.dataset.defaultSort || 'name';\n  const dirValue = containerEl.dataset.sortDir || table.dataset.defaultDir || 'asc';\n  const direction: SortDirection = dirValue === 'desc' ? 'desc' : 'asc';\n  // Persistiere (falls erstmalig)\n  containerEl.dataset.sortKey = key;\n  containerEl.dataset.sortDir = direction;\n  sortTableRows(table, key, direction, true);\n}\n\nexport const __TEST_ONLY__ = {\n  getPortfolioPositionsCacheSnapshot: getPortfolioPositionsSnapshot,\n  clearPortfolioPositionsCache: clearAllPortfolioPositions,\n  getPendingUpdateCount(): number {\n    return pendingPortfolioUpdates.size;\n  },\n  queuePendingUpdate(\n    portfolioUuid: string,\n    positions: PortfolioPositionData[],\n    error?: unknown,\n  ): void {\n    pendingPortfolioUpdates.set(portfolioUuid, { positions, error });\n  },\n  clearPendingUpdates(): void {\n    pendingPortfolioUpdates.clear();\n    pendingRetryMetaMap.clear();\n  },\n};\n\n// === Globale / modulweite Utilities ===\nfunction parseNumLoose(txt: string | null | undefined): number {\n  if (txt == null) return 0;\n  const rawText = txt;\n  return parseFloat(\n    rawText\n      .replace(/\\u00A0/g, ' ')\n      .replace(/[€%]/g, '')\n      .replace(/\\./g, '')\n      .replace(',', '.')\n      .replace(/[^\\d.-]/g, '')\n  ) || 0;\n}\n","/**\n * Overview tab renderer copied for the TypeScript source tree.\n */\n\nimport {\n  createHeaderCard,\n  makeTable,\n  formatNumber,\n  formatValue,\n} from '../content/elements';\nimport { openSecurityDetail } from '../dashboard';\nimport {\n  fetchAccountsWS,\n  fetchLastFileUpdateWS,\n  fetchPortfoliosWS,\n  fetchPortfolioPositionsWS,\n} from '../data/api';\nimport type { PortfolioPositionsResponse } from '../data/api';\nimport { flushPendingPositions, flushAllPendingPositions } from '../data/updateConfigsWS';\nimport { registerOverviewHelpers } from '../dashboard/registry';\nimport {\n  getPortfolioPositions,\n  hasPortfolioPositions,\n  setPortfolioPositions,\n} from '../data/positionsCache';\nimport type { PortfolioPositionRecord } from '../data/positionsCache';\nimport type { HomeAssistant } from '../types/home-assistant';\nimport type {\n  AverageCostPayload,\n  HoldingsAggregationPayload,\n  PanelConfigLike,\n  PerformanceMetricsPayload,\n} from './types';\nimport { normalizeCurrencyValue, toFiniteCurrency } from '../utils/currency';\nimport { normalizePerformancePayload } from '../utils/performance';\n\ninterface PortfolioPositionLike {\n  security_uuid?: unknown;\n  name?: unknown;\n  current_holdings?: unknown;\n  purchase_value?: unknown;\n  current_value?: unknown;\n  gain_abs?: unknown;\n  gain_pct?: unknown;\n  average_cost?: unknown;\n  performance?: unknown;\n  aggregation?: unknown;\n  [key: string]: unknown;\n}\n\ninterface PortfolioOverviewDepot {\n  uuid: string;\n  name: string;\n  position_count: number;\n  current_value: number | null;\n  purchase_sum: number;\n  gain_abs: number | null;\n  gain_pct: number | null;\n  hasValue: boolean;\n  fx_unavailable: boolean;\n  missing_value_positions: number;\n  performance: PerformanceMetricsPayload | null;\n}\n\ninterface NormalizedAccountRow {\n  name: string;\n  balance: number | null;\n  currency_code: string | null;\n  orig_balance: number | null;\n  fx_unavailable: boolean;\n}\n\ntype PortfolioQueryRoot = Document | HTMLElement;\n\ntype PortfolioPositionsSortKey =\n  | 'name'\n  | 'current_holdings'\n  | 'purchase_value'\n  | 'current_value'\n  | 'gain_abs'\n  | 'gain_pct';\n\ntype PortfolioSortDirection = 'asc' | 'desc';\n\nconst PORTFOLIO_SORT_KEYS: readonly PortfolioPositionsSortKey[] = [\n  'name',\n  'current_holdings',\n  'purchase_value',\n  'current_value',\n  'gain_abs',\n  'gain_pct',\n];\n\nfunction isPortfolioPositionsSortKey(\n  value: string | null | undefined,\n): value is PortfolioPositionsSortKey {\n  return PORTFOLIO_SORT_KEYS.includes(value as PortfolioPositionsSortKey);\n}\n\nfunction isPortfolioSortDirection(\n  value: string | null | undefined,\n): value is PortfolioSortDirection {\n  return value === 'asc' || value === 'desc';\n}\n\ntype ToggleContainerElement = HTMLElement & {\n  __ppReaderSecurityClickBound?: boolean;\n  __ppReaderPortfolioToggleBound?: boolean;\n};\n\ntype ToggleRootElement = HTMLElement & {\n  __ppReaderAttachToken?: number;\n  __ppReaderAttachInProgress?: boolean;\n};\n\ntype SortableTableElement = HTMLTableElement & {\n  __ppReaderSortingBound?: boolean;\n  __ppReaderPortfolioFallbackBound?: boolean;\n};\n\n// === Modul-weiter State für Expand/Collapse & Lazy Load ===\n// On-Demand Aggregation liefert frische Portfolio-Werte; nur Positionen bleiben Lazy-Loaded.\nlet _hassRef: HomeAssistant | null = null;\nlet _panelConfigRef: PanelConfigLike | null = null;\n\n// --- Security-Aggregation für Detail-Ansicht ---\nconst PRICE_FRACTION_DIGITS = { min: 2, max: 6 } as const;\n\nfunction toNullableNumber(value: unknown): number | null {\n  return toFiniteCurrency(value);\n}\n\nfunction isFiniteNumber(value: unknown): value is number {\n  return typeof value === 'number' && Number.isFinite(value);\n}\n\nfunction normalizeCurrencyCode(value: unknown): string | null {\n  if (typeof value !== 'string') {\n    return null;\n  }\n  const trimmed = value.trim();\n  if (!trimmed) {\n    return null;\n  }\n  const upper = trimmed.toUpperCase();\n  if (/^[A-Z]{3}$/.test(upper)) {\n    return upper;\n  }\n  if (upper === '€') {\n    return 'EUR';\n  }\n  return null;\n}\n\nfunction resolveCurrencyFromPosition(\n  position: PortfolioPositionLike,\n  keys: readonly string[],\n  fallback: string | null = null,\n): string | null {\n  const record = position as Record<string, unknown>;\n  for (const key of keys) {\n    const candidate = normalizeCurrencyCode(record[key]);\n    if (candidate) {\n      return candidate;\n    }\n  }\n  return fallback;\n}\n\nfunction isRecord(value: unknown): value is Record<string, unknown> {\n  return typeof value === 'object' && value !== null;\n}\n\nfunction hasAverageCostShape(value: Record<string, unknown>): boolean {\n  return (\n    ('native' in value && (typeof value.native === 'number' || value.native === null)) &&\n    ('security' in value && (typeof value.security === 'number' || value.security === null)) &&\n    ('account' in value && (typeof value.account === 'number' || value.account === null)) &&\n    ('eur' in value && (typeof value.eur === 'number' || value.eur === null)) &&\n    typeof value.source === 'string'\n  );\n}\n\nfunction toAverageCostPayload(value: unknown): AverageCostPayload | null {\n  if (!isRecord(value)) {\n    return null;\n  }\n  return hasAverageCostShape(value) ? (value as unknown as AverageCostPayload) : null;\n}\n\nfunction hasHoldingsAggregationShape(value: Record<string, unknown>): boolean {\n  return (\n    typeof value.total_holdings === 'number' &&\n    typeof value.positive_holdings === 'number' &&\n    typeof value.purchase_value_cents === 'number' &&\n    typeof value.purchase_value_eur === 'number' &&\n    typeof value.security_currency_total === 'number' &&\n    typeof value.account_currency_total === 'number' &&\n    typeof value.purchase_total_security === 'number' &&\n    typeof value.purchase_total_account === 'number'\n  );\n}\n\nfunction toHoldingsAggregationPayload(value: unknown): HoldingsAggregationPayload | null {\n  if (!isRecord(value)) {\n    return null;\n  }\n  return hasHoldingsAggregationShape(value)\n    ? (value as unknown as HoldingsAggregationPayload)\n    : null;\n}\n\nfunction sanitizePosition(position: PortfolioPositionLike): PortfolioPositionLike {\n  const record = position as Record<string, unknown>;\n\n  const averageCost = toAverageCostPayload(position.average_cost);\n\n  const aggregation = toHoldingsAggregationPayload(position.aggregation);\n\n  const performance = normalizePerformancePayload(record['performance']);\n  const gainAbs = typeof performance?.gain_abs === 'number' ? performance.gain_abs : null;\n  const gainPct = typeof performance?.gain_pct === 'number' ? performance.gain_pct : null;\n\n  return {\n    ...position,\n    current_holdings: toNullableNumber(record['current_holdings']),\n    purchase_value: normalizeCurrencyValue(record['purchase_value']),\n    current_value: normalizeCurrencyValue(record['current_value']),\n    gain_abs: gainAbs,\n    gain_pct: gainPct,\n    average_cost: averageCost,\n    aggregation,\n    performance,\n  };\n}\n\nfunction formatPriceWithCurrency(\n  value: number | null,\n  currency: string | null,\n): string | null {\n  if (!isFiniteNumber(value)) {\n    return null;\n  }\n\n  const formatted = value.toLocaleString('de-DE', {\n    minimumFractionDigits: PRICE_FRACTION_DIGITS.min,\n    maximumFractionDigits: PRICE_FRACTION_DIGITS.max,\n  });\n  return `${formatted}${currency ? `\\u00A0${currency}` : ''}`;\n}\n\nfunction buildPurchasePriceDisplay(\n  position: PortfolioPositionLike,\n): { markup: string; sortValue: number; ariaLabel: string } {\n  const averageCost = toAverageCostPayload(position.average_cost);\n  const aggregation = toHoldingsAggregationPayload(position.aggregation);\n\n  const securityCurrency = resolveCurrencyFromPosition(position, [\n    'security_currency_code',\n    'security_currency',\n    'native_currency_code',\n    'native_currency',\n  ]);\n\n  const accountCurrency =\n    resolveCurrencyFromPosition(position, [\n      'account_currency_code',\n      'account_currency',\n      'purchase_currency_code',\n      'currency_code',\n    ]) ?? (securityCurrency === 'EUR' ? 'EUR' : null) ?? 'EUR';\n\n  const averageNative = toNullableNumber(averageCost?.native);\n  const averageSecurity = toNullableNumber(averageCost?.security);\n  const averageAccount = toNullableNumber(averageCost?.account);\n  const averageEur = toNullableNumber(averageCost?.eur);\n\n  const effectiveSecurity = averageSecurity ?? averageNative;\n  const effectiveAccount = averageAccount ?? averageEur;\n\n  let primaryValue = effectiveSecurity;\n  let primaryCurrency = securityCurrency;\n  let primaryText = formatPriceWithCurrency(effectiveSecurity, securityCurrency);\n\n  if (!primaryText) {\n    primaryValue = effectiveAccount;\n    primaryCurrency = accountCurrency;\n    primaryText = formatPriceWithCurrency(effectiveAccount, accountCurrency);\n  }\n\n  const formattedAccount = formatPriceWithCurrency(\n    effectiveAccount,\n    accountCurrency,\n  );\n\n  const shouldRenderAccount =\n    formattedAccount !== null &&\n    (primaryText == null ||\n      !primaryCurrency ||\n      !accountCurrency ||\n      accountCurrency !== primaryCurrency ||\n      (isFiniteNumber(effectiveAccount) &&\n        isFiniteNumber(primaryValue) &&\n        Math.abs(effectiveAccount - primaryValue) > 1e-6));\n\n  const parts: string[] = [];\n  const ariaParts: string[] = [];\n\n  if (primaryText) {\n    parts.push(\n      `<span class=\"purchase-price purchase-price--primary\">${primaryText}</span>`,\n    );\n    ariaParts.push(primaryText.replace(/\\u00A0/g, ' '));\n  } else {\n    const missing =\n      '<span class=\"missing-value\" role=\"note\" aria-label=\"Kein Kaufpreis verfügbar\" title=\"Kein Kaufpreis verfügbar\">—</span>';\n    parts.push(missing);\n    ariaParts.push('Kein Kaufpreis verfügbar');\n  }\n\n  if (shouldRenderAccount && formattedAccount && formattedAccount !== primaryText) {\n    parts.push(\n      `<span class=\"purchase-price purchase-price--secondary\">${formattedAccount}</span>`,\n    );\n    ariaParts.push(formattedAccount.replace(/\\u00A0/g, ' '));\n  }\n\n  const markup = parts.join('<br>');\n  const sortValue = toNullableNumber(aggregation?.purchase_value_eur) ?? 0;\n  const ariaLabel = ariaParts.join(', ');\n\n  return { markup, sortValue, ariaLabel };\n}\n\nexport const __TEST_ONLY__ = {\n  buildPurchasePriceDisplayForTest: buildPurchasePriceDisplay,\n};\n\n// Global cache exports have been removed; cache interactions now flow through\n// the shared data/positionsCache module.\nconst expandedPortfolios = new Set<string>();           // gemerkte geöffnete Depots (persistiert über Re-Renders)\n\n// ENTFERNT: Globaler document-Listener (Section 6 Hardening)\n// Stattdessen scoped Listener über attachPortfolioToggleHandler(root)\n\n// Rendert die Positions-Tabelle für ein Depot\n  function applyGainPctMetadata(tableEl: HTMLTableElement | null | undefined): void {\n    if (!tableEl) {\n      return;\n    }\n    const bodyRows = Array.from(tableEl.querySelectorAll<HTMLTableRowElement>('tbody tr'));\n    bodyRows.forEach(row => {\n      const gainAbsCell = row.cells.item(4);\n      const gainPctCell = row.cells.item(5);\n      if (!gainAbsCell || !gainPctCell) {\n        return;\n      }\n      if (gainAbsCell.dataset.gainPct && gainAbsCell.dataset.gainSign) {\n        return;\n      }\n      const pctText = (gainPctCell.textContent || '').trim() || '—';\n      let pctSign: 'positive' | 'negative' | 'neutral' = 'neutral';\n      if (gainPctCell.querySelector('.positive')) {\n        pctSign = 'positive';\n      } else if (gainPctCell.querySelector('.negative')) {\n        pctSign = 'negative';\n      }\n      gainAbsCell.dataset.gainPct = pctText;\n      gainAbsCell.dataset.gainSign = pctSign;\n    });\n  }\n\n  function renderPositionsTable(positions: readonly PortfolioPositionLike[]): string {\n    if (positions.length === 0) {\n      return '<div class=\"no-positions\">Keine Positionen vorhanden.</div>';\n    }\n  const sanitizedPositions = positions.map(sanitizePosition);\n  // Mapping für makeTable\n  const cols = [\n    { key: 'name', label: 'Wertpapier' },\n    { key: 'current_holdings', label: 'Bestand', align: 'right' as const },\n    { key: 'purchase_value', label: 'Ø Kaufpreis', align: 'right' as const },\n    { key: 'current_value', label: 'Aktueller Wert', align: 'right' as const },\n    { key: 'gain_abs', label: '+/-', align: 'right' as const },\n    { key: 'gain_pct', label: '%', align: 'right' as const }\n  ];\n    const rows = sanitizedPositions.map(p => {\n      const performance = normalizePerformancePayload((p as Record<string, unknown>)['performance']);\n      const gainAbs = typeof performance?.gain_abs === 'number' ? performance.gain_abs : null;\n      const gainPct = typeof performance?.gain_pct === 'number' ? performance.gain_pct : null;\n\n      return {\n        name:\n          typeof p.name === 'string'\n            ? p.name\n            : typeof p.name === 'number'\n              ? String(p.name)\n              : '',\n      current_holdings:\n        typeof p.current_holdings === 'number' || typeof p.current_holdings === 'string'\n          ? p.current_holdings\n          : null,\n      purchase_value:\n        typeof p.purchase_value === 'number' || typeof p.purchase_value === 'string'\n          ? p.purchase_value\n          : null,\n      current_value:\n        typeof p.current_value === 'number' || typeof p.current_value === 'string'\n          ? p.current_value\n          : null,\n      gain_abs: gainAbs,\n      gain_pct: gainPct,\n    };\n  });\n\n  // Basis-HTML über makeTable erzeugen\n  const raw = makeTable(rows, cols, ['purchase_value', 'current_value', 'gain_abs']);\n\n  // Header um data-sort-key ergänzen + sortable Klasse setzen\n  try {\n    const tpl = document.createElement('template');\n    tpl.innerHTML = raw.trim();\n    const table = tpl.content.querySelector<HTMLTableElement>('table');\n    if (table) {\n      table.classList.add('sortable-positions');\n        const ths = Array.from(table.querySelectorAll<HTMLElement>('thead th'));\n        cols.forEach((col, i) => {\n          const th = ths.at(i);\n          if (!th) {\n            return;\n          }\n          th.setAttribute('data-sort-key', col.key);\n          th.classList.add('sortable-col');\n        });\n        const bodyRows = table.querySelectorAll<HTMLTableRowElement>('tbody tr');\n        bodyRows.forEach((tr, idx) => {\n          if (tr.classList.contains('footer-row')) {\n            return;\n          }\n          if (idx >= sanitizedPositions.length) {\n            return;\n          }\n          const pos = sanitizedPositions[idx];\n        const securityUuid = typeof pos.security_uuid === 'string' ? pos.security_uuid : null;\n        if (securityUuid) {\n          tr.dataset.security = securityUuid;\n        }\n          tr.classList.add('position-row');\n          const purchaseCell = tr.cells.item(2);\n        if (purchaseCell) {\n          const { markup, sortValue, ariaLabel } = buildPurchasePriceDisplay(pos);\n          purchaseCell.innerHTML = markup;\n          purchaseCell.dataset.sortValue = String(sortValue);\n          if (ariaLabel) {\n            purchaseCell.setAttribute('aria-label', ariaLabel);\n          } else {\n            purchaseCell.removeAttribute('aria-label');\n          }\n        }\n          const gainCell = tr.cells.item(4);\n        if (gainCell) {\n          const performance = normalizePerformancePayload((pos as Record<string, unknown>)['performance']);\n          const gainPctValue =\n            typeof performance?.gain_pct === 'number' && Number.isFinite(performance.gain_pct)\n              ? performance.gain_pct\n              : null;\n          const pctLabel =\n            gainPctValue != null\n              ? `${gainPctValue.toLocaleString('de-DE', {\n                  minimumFractionDigits: 2,\n                  maximumFractionDigits: 2,\n                })} %`\n              : '—';\n          const pctSign =\n            gainPctValue == null\n              ? 'neutral'\n              : gainPctValue > 0\n                ? 'positive'\n                : gainPctValue < 0\n                  ? 'negative'\n                  : 'neutral';\n          gainCell.dataset.gainPct = pctLabel;\n          gainCell.dataset.gainSign = pctSign;\n        }\n          const gainPctCell = tr.cells.item(5);\n        if (gainPctCell) {\n          gainPctCell.classList.add('gain-pct-cell');\n        }\n      });\n      // Default-Sortierung (nach Name asc) – bereits durch SQL geliefert, aber markieren\n      table.dataset.defaultSort = 'name';\n      table.dataset.defaultDir = 'asc';\n      applyGainPctMetadata(table);\n      return table.outerHTML;\n    }\n  } catch (e) {\n    // Fallback: unverändertes Markup\n    console.warn(\"renderPositionsTable: Konnte Sortier-Metadaten nicht injizieren:\", e);\n  }\n  return raw;\n}\n\n// NEU: Export / Global bereitstellen für Push-Handler (Konsistenz Push vs Lazy)\nexport function renderPortfolioPositions(positions: readonly PortfolioPositionLike[]): string {\n  return renderPositionsTable(positions);\n}\n\nfunction attachSecurityDetailDelegation(root: PortfolioQueryRoot, portfolioUuid: string): void {\n  if (!portfolioUuid) return;\n  const detailsRow = root.querySelector<HTMLTableRowElement>(\n    `.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`,\n  );\n  if (!detailsRow) return;\n    const container = detailsRow.querySelector<ToggleContainerElement>('.positions-container');\n    if (!container) return;\n    if (container.__ppReaderSecurityClickBound) return;\n\n    container.__ppReaderSecurityClickBound = true;\n\n  container.addEventListener('click', (event: MouseEvent) => {\n    const target = event.target;\n    if (!(target instanceof Element)) {\n      return;\n    }\n\n    const interactive = target.closest('button, a');\n    if (interactive && container.contains(interactive)) {\n      return;\n    }\n\n    const row = target.closest<HTMLTableRowElement>('tr[data-security]');\n    if (!row || !container.contains(row)) {\n      return;\n    }\n\n    const securityUuid = row.getAttribute('data-security');\n    if (!securityUuid) {\n      return;\n    }\n\n    try {\n      const opened = openSecurityDetail(securityUuid);\n      if (!opened) {\n        console.warn('attachSecurityDetailDelegation: Detail-Tab konnte nicht geöffnet werden für', securityUuid);\n      }\n    } catch (err) {\n      console.error('attachSecurityDetailDelegation: Fehler beim Öffnen des Detail-Tabs', err);\n    }\n  });\n}\n\nexport function attachSecurityDetailListener(root: PortfolioQueryRoot, portfolioUuid: string): void {\n  attachSecurityDetailDelegation(root, portfolioUuid);\n}\n\n// (1) Entferne evtl. doppelte frühere Definitionen von buildExpandablePortfolioTable – nur diese Version behalten\nfunction buildExpandablePortfolioTable(depots: readonly PortfolioOverviewDepot[]): string {\n  console.debug('buildExpandablePortfolioTable: render', depots.length, 'portfolios');\n    const escapeAttribute = (value: unknown): string => {\n      if (value == null) {\n        return '';\n      }\n      if (typeof value !== 'string' && typeof value !== 'number' && typeof value !== 'boolean') {\n        return '';\n      }\n      return String(value)\n        .replace(/&/g, '&amp;')\n        .replace(/\"/g, '&quot;');\n    };\n\n  let html = '<table class=\"expandable-portfolio-table\"><thead><tr>';\n  const cols = [\n    { key: 'name', label: 'Name' },\n    { key: 'position_count', label: 'Anzahl Positionen', align: 'right' },\n    { key: 'current_value', label: 'Aktueller Wert', align: 'right' },\n    { key: 'gain_abs', label: 'Gesamt +/-', align: 'right' },\n    { key: 'gain_pct', label: '%', align: 'right' }\n  ];\n  cols.forEach(c => {\n    const align = c.align === 'right' ? ' class=\"align-right\"' : '';\n    html += `<th${align}>${c.label}</th>`;\n  });\n  html += '</tr></thead><tbody>';\n\n    depots.forEach(d => {\n      const positionCount = Number.isFinite(d.position_count) ? d.position_count : 0;\n      const purchaseSum = Number.isFinite(d.purchase_sum) ? d.purchase_sum : 0;\n      const currentValue =\n        d.hasValue && typeof d.current_value === 'number' && Number.isFinite(d.current_value)\n          ? d.current_value\n          : null;\n      const hasValue = currentValue !== null;\n    const performance = d.performance;\n    const gainAbs = typeof performance?.gain_abs === 'number' ? performance.gain_abs : null;\n    const gainPct = typeof performance?.gain_pct === 'number' ? performance.gain_pct : null;\n    const partialValue = d.fx_unavailable && hasValue;\n\n    const expanded = expandedPortfolios.has(d.uuid);\n    const toggleClass = expanded ? 'portfolio-toggle expanded' : 'portfolio-toggle';\n    const detailId = `portfolio-details-${d.uuid}`;\n    const rowData = {\n      fx_unavailable: d.fx_unavailable,\n      current_value: currentValue,\n      gain_abs: gainAbs,\n      gain_pct: gainPct\n    };\n    const valueContext = { hasValue };\n    const currentValueCell = formatValue('current_value', rowData.current_value, rowData, valueContext);\n    const gainAbsCell = formatValue('gain_abs', rowData.gain_abs, rowData, valueContext);\n    const gainPctCell = formatValue('gain_pct', rowData.gain_pct, rowData, valueContext);\n\n    const gainPctLabel = hasValue && typeof gainPct === 'number' && Number.isFinite(gainPct)\n      ? `${formatNumber(gainPct)} %`\n      : '';\n    const gainPctSign = hasValue && typeof gainPct === 'number' && Number.isFinite(gainPct)\n      ? (gainPct > 0 ? 'positive' : gainPct < 0 ? 'negative' : 'neutral')\n      : '';\n\n      const datasetCurrentValue = hasValue && typeof currentValue === 'number' && Number.isFinite(currentValue)\n        ? currentValue\n        : '';\n      const datasetGainAbs = hasValue && typeof gainAbs === 'number' && Number.isFinite(gainAbs) ? gainAbs : '';\n      const datasetGainPct = hasValue && typeof gainPct === 'number' && Number.isFinite(gainPct) ? gainPct : '';\n      const positionCountAttr = String(positionCount);\n\n    let gainAbsAttributes = '';\n    if (gainPctLabel) {\n      gainAbsAttributes = ` data-gain-pct=\"${escapeAttribute(gainPctLabel)}\" data-gain-sign=\"${escapeAttribute(gainPctSign)}\"`;\n    }\n    if (partialValue) {\n      gainAbsAttributes += ' data-partial=\"true\"';\n    }\n\n      html += `<tr class=\"portfolio-row\"\n                  data-portfolio=\"${d.uuid}\"\n                  data-position-count=\"${positionCountAttr}\"\n                  data-current-value=\"${escapeAttribute(datasetCurrentValue)}\"\n                  data-purchase-sum=\"${escapeAttribute(purchaseSum)}\"\n                  data-gain-abs=\"${escapeAttribute(datasetGainAbs)}\"\n                data-gain-pct=\"${escapeAttribute(datasetGainPct)}\"\n                data-has-value=\"${hasValue ? 'true' : 'false'}\"\n                data-fx-unavailable=\"${d.fx_unavailable ? 'true' : 'false'}\">`;\n    html += `<td>\n        <button type=\"button\"\n                class=\"${toggleClass}\"\n                data-portfolio=\"${d.uuid}\"\n                aria-expanded=\"${expanded ? 'true' : 'false'}\"\n                aria-controls=\"${detailId}\">\n          <span class=\"caret\">${expanded ? '▼' : '▶'}</span>\n          <span class=\"portfolio-name\">${d.name}</span>\n        </button>\n      </td>`;\n      const positionCountDisplay = positionCount.toLocaleString('de-DE');\n      html += `<td class=\"align-right\">${positionCountDisplay}</td>`;\n    html += `<td class=\"align-right\">${currentValueCell}</td>`;\n    html += `<td class=\"align-right\"${gainAbsAttributes}>${gainAbsCell}</td>`;\n    html += `<td class=\"align-right gain-pct-cell\">${gainPctCell}</td>`;\n    html += '</tr>';\n\n    html += `<tr class=\"portfolio-details${expanded ? '' : ' hidden'}\"\n                data-portfolio=\"${d.uuid}\"\n                id=\"${detailId}\"\n                role=\"region\"\n                aria-label=\"Positionen für ${d.name}\">\n      <td colspan=\"5\">\n        <div class=\"positions-container\">${expanded\n        ? (hasPortfolioPositions(d.uuid)\n          ? renderPositionsTable(getPortfolioPositions(d.uuid))\n          : '<div class=\\\"loading\\\">Lade Positionen...</div>')\n        : ''\n      }</div>\n      </td>\n    </tr>`;\n  });\n\n    const availableDepots = depots.filter(d => typeof d.current_value === 'number' && Number.isFinite(d.current_value));\n    const sumPositions = depots.reduce((a, d) => a + (Number.isFinite(d.position_count) ? d.position_count : 0), 0);\n  const sumCurrent = availableDepots.reduce((a, d) => {\n    if (typeof d.current_value === 'number' && Number.isFinite(d.current_value)) {\n      return a + d.current_value;\n    }\n    return a;\n  }, 0);\n  const sumPurchase = availableDepots.reduce((a, d) => {\n    if (typeof d.purchase_sum === 'number' && Number.isFinite(d.purchase_sum)) {\n      return a + d.purchase_sum;\n    }\n    return a;\n  }, 0);\n  const sumGainAbs = availableDepots.reduce((a, d) => {\n    if (typeof d.performance?.gain_abs === 'number' && Number.isFinite(d.performance.gain_abs)) {\n      return a + d.performance.gain_abs;\n    }\n    const current = typeof d.current_value === 'number' && Number.isFinite(d.current_value) ? d.current_value : 0;\n    const purchase = typeof d.purchase_sum === 'number' && Number.isFinite(d.purchase_sum) ? d.purchase_sum : 0;\n    return a + (current - purchase);\n  }, 0);\n  const sumHasValue = availableDepots.length > 0;\n  const sumIsPartial = availableDepots.length !== depots.length;\n  const sumGainPct = sumHasValue && sumPurchase > 0 ? (sumGainAbs / sumPurchase) * 100 : null;\n\n  const sumRowData = {\n    fx_unavailable: sumIsPartial,\n    current_value: sumHasValue ? sumCurrent : null,\n    gain_abs: sumHasValue ? sumGainAbs : null,\n    gain_pct: sumHasValue ? sumGainPct : null\n  };\n  const sumContext = { hasValue: sumHasValue };\n  const sumCurrentCell = formatValue('current_value', sumRowData.current_value, sumRowData, sumContext);\n  const sumGainAbsCell = formatValue('gain_abs', sumRowData.gain_abs, sumRowData, sumContext);\n  const sumGainPctCell = formatValue('gain_pct', sumRowData.gain_pct, sumRowData, sumContext);\n\n  let sumGainAbsAttributes = '';\n  if (sumHasValue && typeof sumGainPct === 'number' && Number.isFinite(sumGainPct)) {\n    const sumGainPctLabel = `${formatNumber(sumGainPct)} %`;\n    const sumGainPctSign = sumGainPct > 0 ? 'positive' : sumGainPct < 0 ? 'negative' : 'neutral';\n    sumGainAbsAttributes = ` data-gain-pct=\"${escapeAttribute(sumGainPctLabel)}\" data-gain-sign=\"${escapeAttribute(sumGainPctSign)}\"`;\n  }\n  if (sumIsPartial) {\n    sumGainAbsAttributes += ' data-partial=\"true\"';\n  }\n\n    const sumPositionAttr = String(Math.round(sumPositions));\n    const sumCurrentAttr = sumHasValue ? String(sumCurrent) : '';\n    const sumPurchaseAttr = sumHasValue ? String(sumPurchase) : '';\n    const sumGainAbsAttr = sumHasValue ? String(sumGainAbs) : '';\n    const sumGainPctAttr = sumHasValue && typeof sumGainPct === 'number' && Number.isFinite(sumGainPct)\n      ? String(sumGainPct)\n      : '';\n\n    html += `<tr class=\"footer-row\"\n      data-position-count=\"${sumPositionAttr}\"\n      data-current-value=\"${escapeAttribute(sumCurrentAttr)}\"\n      data-purchase-sum=\"${escapeAttribute(sumPurchaseAttr)}\"\n      data-gain-abs=\"${escapeAttribute(sumGainAbsAttr)}\"\n      data-gain-pct=\"${escapeAttribute(sumGainPctAttr)}\"\n      data-has-value=\"${sumHasValue ? 'true' : 'false'}\"\n      data-fx-unavailable=\"${sumIsPartial ? 'true' : 'false'}\">\n      <td>Summe</td>\n      <td class=\"align-right\">${Math.round(sumPositions).toLocaleString('de-DE')}</td>\n    <td class=\"align-right\">${sumCurrentCell}</td>\n    <td class=\"align-right\"${sumGainAbsAttributes}>${sumGainAbsCell}</td>\n    <td class=\"align-right gain-pct-cell\">${sumGainPctCell}</td>\n  </tr>`;\n\n  html += '</tbody></table>';\n  return html;\n}\n\nfunction resolvePortfolioTable(target: Element | PortfolioQueryRoot | null | undefined): HTMLTableElement | null {\n  if (target instanceof HTMLTableElement) {\n    return target;\n  }\n  if (target && 'querySelector' in target) {\n    const scoped = (target as ParentNode).querySelector<HTMLTableElement>('table.expandable-portfolio-table');\n    if (scoped) {\n      return scoped;\n    }\n    const nested = (target as ParentNode).querySelector<HTMLTableElement>('.portfolio-table table');\n    if (nested) {\n      return nested;\n    }\n    const generic = (target as ParentNode).querySelector<HTMLTableElement>('table');\n    if (generic) {\n      return generic;\n    }\n  }\n  return document.querySelector<HTMLTableElement>('.portfolio-table table.expandable-portfolio-table') ||\n    document.querySelector<HTMLTableElement>('.portfolio-table table');\n}\n\nfunction readDatasetNumber(value: string | undefined): number | null {\n  if (value === undefined) {\n    return null;\n  }\n  const num = Number(value);\n  return Number.isFinite(num) ? num : null;\n}\n\nexport function updatePortfolioFooterFromDom(target: Element | PortfolioQueryRoot | null | undefined): void {\n    const table = resolvePortfolioTable(target);\n    if (!table) {\n      return;\n    }\n    const tbody = table.tBodies.item(0);\n  if (!tbody) {\n    return;\n  }\n  const rows = Array.from(tbody.querySelectorAll<HTMLTableRowElement>('tr.portfolio-row'));\n  if (!rows.length) {\n    return;\n  }\n\n  let sumPositions = 0;\n  let sumCurrent = 0;\n  let sumPurchase = 0;\n  let sumGainAbs = 0;\n  let hasValueRow = false;\n  let allRowsComplete = true;\n  let fxUnavailable = false;\n\n  for (const row of rows) {\n    const posCount = readDatasetNumber(row.dataset.positionCount);\n    if (posCount != null) {\n      sumPositions += posCount;\n    }\n\n    if (row.dataset.fxUnavailable === 'true') {\n      fxUnavailable = true;\n    }\n\n    const hasValueAttr = row.dataset.hasValue;\n    const hasValue = !(hasValueAttr === 'false' || hasValueAttr === '0' || hasValueAttr === '' || hasValueAttr == null);\n    if (!hasValue) {\n      allRowsComplete = false;\n      continue;\n    }\n\n    hasValueRow = true;\n\n    const currentValue = readDatasetNumber(row.dataset.currentValue);\n    const gainAbs = readDatasetNumber(row.dataset.gainAbs);\n    const purchaseSum = readDatasetNumber(row.dataset.purchaseSum);\n\n    if (currentValue == null || gainAbs == null || purchaseSum == null) {\n      allRowsComplete = false;\n      continue;\n    }\n\n    sumCurrent += currentValue;\n    sumGainAbs += gainAbs;\n    sumPurchase += purchaseSum;\n  }\n\n  const totalsComplete = hasValueRow && allRowsComplete;\n  const sumGainPct = totalsComplete && sumPurchase > 0 ? (sumGainAbs / sumPurchase) * 100 : null;\n\n  let footer = Array.from(tbody.children).find((child): child is HTMLTableRowElement =>\n    child instanceof HTMLTableRowElement && child.classList.contains('footer-row')\n  );\n  if (!footer) {\n    footer = document.createElement('tr');\n    footer.classList.add('footer-row');\n    tbody.appendChild(footer);\n  }\n\n  const sumPositionsDisplay = Math.round(sumPositions).toLocaleString('de-DE');\n\n  const footerRowData = {\n    fx_unavailable: fxUnavailable || !totalsComplete,\n    current_value: totalsComplete ? sumCurrent : null,\n    gain_abs: totalsComplete ? sumGainAbs : null,\n    gain_pct: totalsComplete ? sumGainPct : null,\n  };\n  const footerContext = { hasValue: totalsComplete };\n\n  const currentValueHtml = formatValue('current_value', footerRowData.current_value, footerRowData, footerContext);\n  const gainAbsHtml = formatValue('gain_abs', footerRowData.gain_abs, footerRowData, footerContext);\n  const gainPctHtml = formatValue('gain_pct', footerRowData.gain_pct, footerRowData, footerContext);\n\n    footer.innerHTML = `\n      <td>Summe</td>\n      <td class=\"align-right\">${sumPositionsDisplay}</td>\n      <td class=\"align-right\">${currentValueHtml}</td>\n      <td class=\"align-right\">${gainAbsHtml}</td>\n      <td class=\"align-right\">${gainPctHtml}</td>\n    `;\n    const footerGainAbsCell = footer.cells.item(3);\n  if (footerGainAbsCell) {\n    footerGainAbsCell.dataset.gainPct = totalsComplete && typeof sumGainPct === 'number'\n      ? `${formatNumber(sumGainPct)} %`\n      : '—';\n    footerGainAbsCell.dataset.gainSign = totalsComplete && typeof sumGainPct === 'number'\n      ? (sumGainPct > 0 ? 'positive' : sumGainPct < 0 ? 'negative' : 'neutral')\n      : 'neutral';\n  }\n  footer.dataset.positionCount = String(Math.round(sumPositions));\n  footer.dataset.currentValue = totalsComplete ? String(sumCurrent) : '';\n  footer.dataset.purchaseSum = totalsComplete ? String(sumPurchase) : '';\n  footer.dataset.gainAbs = totalsComplete ? String(sumGainAbs) : '';\n  footer.dataset.gainPct = totalsComplete && typeof sumGainPct === 'number' ? String(sumGainPct) : '';\n  footer.dataset.hasValue = totalsComplete ? 'true' : 'false';\n  footer.dataset.fxUnavailable = fxUnavailable ? 'true' : 'false';\n}\n\n/**\n * Utility-Funktionen zum Auslesen und Wiederherstellen des Expand-States.\n * Perspektivisch nutzbar, falls ein vollständiger Neu-Render (Hard Refresh) der\n * Depot-Tabelle nötig wird (z.B. beim späteren Hinzufügen von Filter-/Sortierlogik).\n */\nexport function getExpandedPortfolios(): string[] {\n  // Primär DOM lesen (falls Tabelle gerendert), Fallback: interner Set\n  const domRows = Array.from(\n    document.querySelectorAll<HTMLTableRowElement>('.portfolio-details:not(.hidden)[data-portfolio]'),\n  );\n  if (domRows.length) {\n    return domRows\n      .map((row) => row.getAttribute('data-portfolio'))\n      .filter((value): value is string => Boolean(value));\n  }\n  return Array.from(expandedPortfolios.values());\n}\n\nexport function setExpandedPortfolios(portfolioIds: Array<string | null | undefined> | null | undefined): void {\n  expandedPortfolios.clear();\n  if (Array.isArray(portfolioIds)) {\n    portfolioIds.forEach(id => {\n      if (id) {\n        expandedPortfolios.add(id);\n      }\n    });\n  }\n}\n\n// NEU: Helper zum Anhängen der Sortier-Logik an eine Positions-Tabelle eines bestimmten Portfolios\nexport function attachPortfolioPositionsSorting(root: PortfolioQueryRoot, portfolioUuid: string): void {\n  if (!portfolioUuid) return;\n  const detailsRow = root.querySelector<HTMLTableRowElement>(\n    `.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`,\n  );\n  if (!detailsRow) return;\n    const container = detailsRow.querySelector<ToggleContainerElement>('.positions-container');\n    if (!container) return;\n    const table = container.querySelector<SortableTableElement>('table.sortable-positions');\n  if (!table || table.__ppReaderSortingBound) return;\n\n  table.__ppReaderSortingBound = true;\n\n  const applySort = (\n    key: PortfolioPositionsSortKey,\n    dir: PortfolioSortDirection,\n  ): void => {\n    const tbody = table.querySelector<HTMLTableSectionElement>('tbody');\n    if (!tbody) return;\n    const rows = Array.from(tbody.querySelectorAll<HTMLTableRowElement>('tr'))\n      .filter(r => !r.classList.contains('footer-row'));\n    const footer = tbody.querySelector<HTMLTableRowElement>('tr.footer-row');\n\n    const parseNum = (txt: string | null | undefined): number => {\n      if (txt == null) return 0;\n      // Entferne Währungs-/Prozent-Symbole, geschützte Leerzeichen\n      const cleaned = txt\n        .replace(/\\u00A0/g, ' ')\n        .replace(/[%€]/g, '')\n        .replace(/\\./g, '')\n        .replace(',', '.')\n        .replace(/[^\\d.-]/g, '');\n      const numeric = Number.parseFloat(cleaned);\n      return Number.isFinite(numeric) ? numeric : 0;\n    };\n\n    rows.sort((a, b) => {\n        const idxMap: Record<PortfolioPositionsSortKey, number> = {\n          name: 0,\n          current_holdings: 1,\n          purchase_value: 2,\n          current_value: 3,\n          gain_abs: 4,\n          gain_pct: 5,\n        };\n        const colIdx = idxMap[key];\n          const aCellEl = a.cells.item(colIdx);\n          const bCellEl = b.cells.item(colIdx);\n\n        let aCell = '';\n        if (aCellEl) {\n          const raw = aCellEl.textContent;\n          if (typeof raw === 'string') {\n            aCell = raw.trim();\n          }\n        }\n\n        let bCell = '';\n        if (bCellEl) {\n          const raw = bCellEl.textContent;\n          if (typeof raw === 'string') {\n            bCell = raw.trim();\n          }\n        }\n\n          const resolveSortValue = (\n            cell: HTMLTableCellElement | null | undefined,\n            text: string,\n          ): number => {\n            const sortAttr = cell ? cell.dataset.sortValue : undefined;\n            if (sortAttr != null && sortAttr !== '') {\n              const numericAttr = Number(sortAttr);\n              if (Number.isFinite(numericAttr)) {\n                return numericAttr;\n              }\n            }\n            return parseNum(text);\n          };\n\n      let comp: number;\n      if (key === 'name') {\n        comp = aCell.localeCompare(bCell, 'de', { sensitivity: 'base' });\n      } else {\n        const aValue = resolveSortValue(aCellEl, aCell);\n        const bValue = resolveSortValue(bCellEl, bCell);\n        comp = aValue - bValue;\n      }\n      return dir === 'asc' ? comp : -comp;\n    });\n\n    // Visuelle Indikatoren zurücksetzen\n    table.querySelectorAll('thead th.sort-active').forEach(th => {\n      th.classList.remove('sort-active', 'dir-asc', 'dir-desc');\n    });\n\n    // Aktives TH markieren\n    const th = table.querySelector<HTMLElement>(`thead th[data-sort-key=\"${key}\"]`);\n    if (th) {\n      th.classList.add('sort-active', dir === 'asc' ? 'dir-asc' : 'dir-desc');\n    }\n\n    // Neu einfügen\n    rows.forEach(r => tbody.appendChild(r));\n    if (footer) tbody.appendChild(footer);\n  };\n\n  // Initial ggf. gespeicherten Zustand anwenden\n  const containerKey = container.dataset.sortKey;\n  const containerDir = container.dataset.sortDir;\n  const defaultKey = table.dataset.defaultSort;\n  const defaultDir = table.dataset.defaultDir;\n\n  const currentKey = isPortfolioPositionsSortKey(containerKey)\n    ? containerKey\n    : isPortfolioPositionsSortKey(defaultKey)\n      ? defaultKey\n      : 'name';\n  const currentDir = isPortfolioSortDirection(containerDir)\n    ? containerDir\n    : isPortfolioSortDirection(defaultDir)\n      ? defaultDir\n      : 'asc';\n\n  applySort(currentKey, currentDir);\n\n  table.addEventListener('click', (event: MouseEvent) => {\n    const target = event.target;\n    if (!(target instanceof Element)) {\n      return;\n    }\n    const th = target.closest('th[data-sort-key]');\n    if (!th || !table.contains(th)) return;\n    const keyAttr = th.getAttribute('data-sort-key');\n    if (!isPortfolioPositionsSortKey(keyAttr)) {\n      return;\n    }\n\n    let dir: PortfolioSortDirection = 'asc';\n    if (container.dataset.sortKey === keyAttr) {\n      const existing = isPortfolioSortDirection(container.dataset.sortDir)\n        ? container.dataset.sortDir\n        : 'asc';\n      dir = existing === 'asc' ? 'desc' : 'asc';\n    }\n    container.dataset.sortKey = keyAttr;\n    container.dataset.sortDir = dir;\n    applySort(keyAttr, dir);\n  });\n}\n\n// NEU: Funktion zum erneuten Laden der Positionsdaten\nasync function reloadPortfolioPositions(\n  portfolioUuid: string,\n  containerEl: HTMLElement | null | undefined,\n  root: HTMLElement,\n): Promise<void> {\n  if (!portfolioUuid || !_hassRef || !_panelConfigRef) return;\n\n  const targetContainer = containerEl || root.querySelector<HTMLElement>(\n    `.portfolio-details[data-portfolio=\"${portfolioUuid}\"] .positions-container`\n  );\n  if (!targetContainer) {\n    return;\n  }\n\n  const detailsRow = targetContainer.closest<HTMLTableRowElement>('.portfolio-details');\n  if (detailsRow && detailsRow.classList.contains('hidden')) {\n    return; // Hidden Rows sollen keinen Silent-Preload anstoßen\n  }\n\n  targetContainer.innerHTML = '<div class=\"loading\">Neu laden...</div>';\n  try {\n    const resp: PortfolioPositionsResponse = await fetchPortfolioPositionsWS(\n      _hassRef,\n      _panelConfigRef,\n      portfolioUuid,\n    );\n    if (resp.error) {\n      const errorText = typeof resp.error === 'string' ? resp.error : String(resp.error);\n      targetContainer.innerHTML = `<div class=\"error\">${errorText} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n      return;\n    }\n    const positions = Array.isArray(resp.positions) ? resp.positions : [];\n    setPortfolioPositions(portfolioUuid, positions as PortfolioPositionRecord[]);\n    targetContainer.innerHTML = renderPositionsTable(positions);\n    // Änderung 11: Nach erstmaligem Lazy-Load Sortierung initialisieren\n    try {\n      attachPortfolioPositionsSorting(root, portfolioUuid);\n    } catch (error) {\n      console.warn('attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:', error);\n    }\n    try {\n      attachSecurityDetailListener(root, portfolioUuid);\n    } catch (error) {\n      console.warn('reloadPortfolioPositions: Security-Listener konnte nicht gebunden werden:', error);\n    }\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    targetContainer.innerHTML = `<div class=\"error\">Fehler: ${message} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Retry</button></div>`;\n  }\n}\n\n// Hilfsfunktion: wartet bis ein Selektor im root existiert\nasync function waitForElement<T extends Element>(\n  root: HTMLElement,\n  selector: string,\n  timeoutMs = 3000,\n  intervalMs = 50,\n): Promise<T | null> {\n  const start = performance.now();\n  return new Promise((resolve) => {\n    const tick = () => {\n      const el = root.querySelector<T>(selector);\n      if (el) {\n        resolve(el);\n        return;\n      }\n      if (performance.now() - start > timeoutMs) {\n        resolve(null);\n        return;\n      }\n      setTimeout(tick, intervalMs);\n    };\n    tick();\n  });\n}\n\n  export function attachPortfolioToggleHandler(root: ToggleRootElement): void {\n    const previousToken = typeof root.__ppReaderAttachToken === 'number' ? root.__ppReaderAttachToken : 0;\n    const token = previousToken + 1;\n  root.__ppReaderAttachToken = token;\n  root.__ppReaderAttachInProgress = true;\n\n    void (async () => {\n    try {\n        const container = await waitForElement<ToggleContainerElement>(root, '.portfolio-table');\n      if (token !== root.__ppReaderAttachToken) {\n        return; // Ein neuer Versuch läuft bereits – diesen abbrechen\n      }\n      if (!container) {\n        console.warn(\"attachPortfolioToggleHandler: .portfolio-table nicht gefunden (Timeout)\");\n        return;\n      }\n\n      // Buttons generiert?\n      const btnCount = container.querySelectorAll('.portfolio-toggle').length;\n      if (btnCount === 0) {\n        console.debug(\"attachPortfolioToggleHandler: Noch keine Buttons – evtl. Recovery später\");\n      }\n\n        if (container.__ppReaderPortfolioToggleBound) {\n          return;\n        }\n        container.__ppReaderPortfolioToggleBound = true;\n      console.debug(\"attachPortfolioToggleHandler: Listener registriert\");\n\n      container.addEventListener('click', (event: MouseEvent) => {\n        void (async () => {\n          try {\n            const target = event.target;\n            if (!(target instanceof Element)) {\n              return;\n            }\n\n              const retryBtn = target.closest<HTMLButtonElement>('.retry-pos');\n            if (retryBtn && container.contains(retryBtn)) {\n              const pid = retryBtn.getAttribute('data-portfolio');\n              if (pid) {\n                const detailsRow = root.querySelector<HTMLTableRowElement>(\n                  `.portfolio-details[data-portfolio=\"${pid}\"]`,\n                );\n                const cont = detailsRow?.querySelector<ToggleContainerElement>('.positions-container');\n                await reloadPortfolioPositions(pid, cont ?? null, root);\n              }\n              return;\n            }\n\n            const btn = target.closest<HTMLButtonElement>('.portfolio-toggle');\n            if (!btn || !container.contains(btn)) return;\n\n            const portfolioUuid = btn.getAttribute('data-portfolio');\n            if (!portfolioUuid) return;\n\n              const detailsRow = root.querySelector<HTMLTableRowElement>(\n              `.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`,\n            );\n            if (!detailsRow) return;\n\n            const caretEl = btn.querySelector<HTMLElement>('.caret');\n            const isHidden = detailsRow.classList.contains('hidden');\n\n            if (isHidden) {\n              detailsRow.classList.remove('hidden');\n              btn.classList.add('expanded');\n              btn.setAttribute('aria-expanded', 'true');\n              if (caretEl) caretEl.textContent = '▼';\n              expandedPortfolios.add(portfolioUuid);\n\n              try {\n                flushPendingPositions(root, portfolioUuid);\n              } catch (error) {\n                console.warn('attachPortfolioToggleHandler: Pending-Flush fehlgeschlagen:', error);\n              }\n\n              if (!hasPortfolioPositions(portfolioUuid)) {\n                const containerEl = detailsRow.querySelector<ToggleContainerElement>('.positions-container');\n                if (containerEl) {\n                  containerEl.innerHTML = '<div class=\"loading\">Lade Positionen...</div>';\n                }\n                try {\n                  const resp: PortfolioPositionsResponse = await fetchPortfolioPositionsWS(\n                    _hassRef,\n                    _panelConfigRef,\n                    portfolioUuid,\n                  );\n                  if (resp.error) {\n                    const errorText = typeof resp.error === 'string' ? resp.error : String(resp.error);\n                    if (containerEl) {\n                      containerEl.innerHTML = `<div class=\"error\">${errorText} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n                    }\n                    return;\n                  }\n                  const positions = Array.isArray(resp.positions) ? resp.positions : [];\n                  setPortfolioPositions(portfolioUuid, positions as PortfolioPositionRecord[]);\n                  if (containerEl) {\n                    containerEl.innerHTML = renderPositionsTable(positions);\n                    // Änderung 11: Nach erstmaligem Lazy-Load Sortierung initialisieren\n                    try {\n                      attachPortfolioPositionsSorting(root, portfolioUuid);\n                    } catch (error) {\n                      console.warn('attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:', error);\n                    }\n                    try {\n                      attachSecurityDetailListener(root, portfolioUuid);\n                    } catch (error) {\n                      console.warn('attachPortfolioToggleHandler: Security-Listener konnte nicht gebunden werden:', error);\n                    }\n                  }\n                } catch (error) {\n                  const message = error instanceof Error ? error.message : String(error);\n                  const containerEl = detailsRow.querySelector<ToggleContainerElement>('.positions-container');\n                  if (containerEl) {\n                    containerEl.innerHTML = `<div class=\"error\">Fehler beim Laden: ${message} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Retry</button></div>`;\n                  }\n                  console.error('Fehler beim Lazy Load für', portfolioUuid, error);\n                }\n              } else {\n                const containerEl = detailsRow.querySelector<HTMLElement>('.positions-container');\n                if (containerEl) {\n                  containerEl.innerHTML = renderPositionsTable(\n                    getPortfolioPositions(portfolioUuid),\n                  );\n                  attachPortfolioPositionsSorting(root, portfolioUuid);\n                  try {\n                    attachSecurityDetailListener(root, portfolioUuid);\n                  } catch (error) {\n                    console.warn('attachPortfolioToggleHandler: Security-Listener (Cache) Fehler:', error);\n                  }\n                }\n              }\n            } else {\n              detailsRow.classList.add('hidden');\n              btn.classList.remove('expanded');\n              btn.setAttribute('aria-expanded', 'false');\n              if (caretEl) caretEl.textContent = '▶';\n              expandedPortfolios.delete(portfolioUuid);\n            }\n            } catch (error) {\n              console.error('attachPortfolioToggleHandler: Ungefangener Fehler im Click-Handler', error);\n            }\n        })();\n      });\n    } finally {\n      if (token === root.__ppReaderAttachToken) {\n        root.__ppReaderAttachInProgress = false;\n      }\n    }\n    })();\n}\n\n// Fallback: direkter Listener auf die Tabelle selbst (falls outer container nicht klickt)\n  export function ensurePortfolioRowFallbackListener(root: ToggleRootElement): void {\n    const table = root.querySelector<SortableTableElement>('.expandable-portfolio-table');\n    if (!table) return;\n    if (table.__ppReaderPortfolioFallbackBound) return;\n    table.__ppReaderPortfolioFallbackBound = true;\n  table.addEventListener('click', (event: MouseEvent) => {\n    const target = event.target;\n    if (!(target instanceof Element)) {\n      return;\n    }\n    const btn = target.closest<HTMLButtonElement>('.portfolio-toggle');\n    if (!btn) return;\n    // Falls der Haupt-Listener schon aktiv war, nichts doppelt machen\n      const primaryContainer = root.querySelector<ToggleContainerElement>('.portfolio-table');\n    if (primaryContainer?.__ppReaderPortfolioToggleBound) return;\n    console.debug('Fallback-Listener aktiv – re-attach Hauptlistener');\n    attachPortfolioToggleHandler(root);\n  });\n}\n\nexport async function renderDashboard(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<string> {\n  _hassRef = hass ?? null;\n  _panelConfigRef = panelConfig ?? null;\n  console.debug(\n    'renderDashboard: start – panelConfig:',\n    panelConfig?.config,\n    'derived entry_id?',\n    panelConfig?.config?._panel_custom?.config?.entry_id,\n  );\n\n  const accountsResp = await fetchAccountsWS(hass, panelConfig);\n  const accounts = accountsResp.accounts;\n  const normalizedAccounts: NormalizedAccountRow[] = accounts.map((account) => ({\n    name: account.name ?? '—',\n    balance: typeof account.balance === 'number' && Number.isFinite(account.balance)\n      ? account.balance\n      : null,\n    currency_code: account.currency_code ?? null,\n    orig_balance: typeof account.orig_balance === 'number' && Number.isFinite(account.orig_balance)\n      ? account.orig_balance\n      : null,\n    fx_unavailable: Boolean(account.fx_unavailable),\n  }));\n\n  const portfoliosResp = await fetchPortfoliosWS(hass, panelConfig);\n  const depots: PortfolioOverviewDepot[] = portfoliosResp.portfolios\n    .map((p): PortfolioOverviewDepot | null => {\n      const record = p as Record<string, unknown>;\n      const uuid = typeof p.uuid === 'string' && p.uuid ? p.uuid : null;\n      if (!uuid) {\n        return null;\n      }\n      const missingPositions = typeof (p as Record<string, unknown>).missing_value_positions === 'number'\n        ? (p as Record<string, unknown>).missing_value_positions as number\n        : 0;\n      const rawCurrentValue = normalizeCurrencyValue(record.current_value);\n      const purchaseSum = normalizeCurrencyValue(record.purchase_sum) ?? 0;\n      const performance = normalizePerformancePayload(record['performance']);\n\n      const hasNumericCurrentValue = rawCurrentValue != null;\n      const gainAbs = typeof performance?.gain_abs === 'number' ? performance.gain_abs : null;\n      const gainPct = typeof performance?.gain_pct === 'number' ? performance.gain_pct : null;\n\n      const partialValue = missingPositions > 0;\n      const hasValue = hasNumericCurrentValue;\n      const fxUnavailable = partialValue || !hasValue;\n\n      return {\n        uuid,\n        name: p.name ?? 'Unbenanntes Depot',\n        position_count: typeof p.position_count === 'number' ? p.position_count : 0,\n        current_value: hasNumericCurrentValue ? rawCurrentValue : null,\n        purchase_sum: purchaseSum,\n        gain_abs: gainAbs,\n        gain_pct: gainPct,\n        hasValue,\n        missing_value_positions: missingPositions,\n        fx_unavailable: fxUnavailable,\n        performance: performance,\n      };\n    })\n    .filter((depot): depot is PortfolioOverviewDepot => depot !== null);\n\n  // 3. Last file update (optional – falls bereits WS-Command vorhanden)\n  let lastFileUpdate = '';\n  try {\n    lastFileUpdate = await fetchLastFileUpdateWS(hass, panelConfig);\n  } catch {\n    lastFileUpdate = '';\n  }\n\n  // 4. Gesamtvermögen berechnen (nur Anzeige)\n  const totalAccounts = normalizedAccounts.reduce(\n    (sum, account) => sum + (typeof account.balance === 'number' && Number.isFinite(account.balance) ? account.balance : 0),\n    0,\n  );\n  const anyPortfolioMissing = depots.some(depot => depot.fx_unavailable);\n  const anyAccountMissing = normalizedAccounts.some(account => account.fx_unavailable && (account.balance == null || !Number.isFinite(account.balance)));\n  const totalDepots = depots.reduce((sum, depot) => {\n    if (depot.hasValue && typeof depot.current_value === 'number' && Number.isFinite(depot.current_value)) {\n      return sum + depot.current_value;\n    }\n    return sum;\n  }, 0);\n  const totalWealth = totalAccounts + totalDepots;\n  const missingWealthReason = 'Teilw. fehlende FX-Kurse – Gesamtvermögen abweichend';\n  const wealthValueAvailable = depots.some(depot => depot.hasValue && typeof depot.current_value === 'number' && Number.isFinite(depot.current_value))\n    || normalizedAccounts.some(account => typeof account.balance === 'number' && Number.isFinite(account.balance));\n  const wealthValueMarkup = wealthValueAvailable\n    ? `${formatNumber(totalWealth)}&nbsp;€`\n    : `<span class=\"missing-value\" role=\"note\" aria-label=\"${missingWealthReason}\" title=\"${missingWealthReason}\">—</span>`;\n  const wealthNote = (anyPortfolioMissing || anyAccountMissing)\n    ? `<span class=\"total-wealth-note\">${missingWealthReason}</span>`\n    : '';\n\n  // 5. Header (ohne Last-File-Update – kommt jetzt wieder in Footer-Karte)\n  const headerMeta = `\n    <div class=\"header-meta-row\">\n      💰 Gesamtvermögen: <strong class=\"total-wealth-value\">${wealthValueMarkup}</strong>${wealthNote}\n    </div>\n  `;\n  const headerCard = createHeaderCard('Übersicht', headerMeta);\n\n  // 6. Sicherstellen, dass die Struktur exakt der erwartet wird:\n  //    - .portfolio-table (Wrapper)\n  //    - darin eine <table class=\"expandable-portfolio-table\"> mit <tr class=\"portfolio-row\" data-portfolio=\"UUID\">\n  const portfolioTableHtml = buildExpandablePortfolioTable(depots);\n\n  // 7. Konten-Tabellen\n  const eurAccounts = normalizedAccounts.filter(a => (a.currency_code ?? 'EUR') === 'EUR');\n  const fxAccounts = normalizedAccounts.filter(a => (a.currency_code ?? 'EUR') !== 'EUR');\n\n  const fxWarningNeeded = fxAccounts.some(a => a.fx_unavailable);\n  const fxWarning = fxWarningNeeded\n    ? `\n        <p class=\"table-note\" role=\"note\">\n          <span class=\"table-note__icon\" aria-hidden=\"true\">⚠️</span>\n          <span>Wechselkurse konnten nicht geladen werden. EUR-Werte werden derzeit nicht angezeigt.</span>\n        </p>\n      `\n    : '';\n\n  const accountsHtml = `\n    <div class=\"card\">\n      <h2>Liquidität</h2>\n      <div class=\"scroll-container account-table\">\n        ${makeTable(\n    eurAccounts.map(account => ({\n      name: account.name,\n      balance: account.balance ?? null,\n    })),\n    [\n      { key: 'name', label: 'Name' },\n      { key: 'balance', label: 'Kontostand (EUR)', align: 'right' as const },\n    ],\n    ['balance'],\n  )}\n      </div>\n    </div>\n    ${fxAccounts.length ? `\n      <div class=\"card\">\n        <h2>Fremdwährungen</h2>\n        <div class=\"scroll-container fx-account-table\">\n          ${makeTable(\n    fxAccounts.map(account => {\n      const origBalance = account.orig_balance;\n      const hasOrigBalance = typeof origBalance === 'number' && Number.isFinite(origBalance);\n      const fxDisplay = hasOrigBalance\n        ? `${origBalance.toLocaleString('de-DE', {\n            minimumFractionDigits: 2,\n            maximumFractionDigits: 2,\n          })}&nbsp;${account.currency_code ?? ''}`\n        : '';\n\n      return {\n        name: account.name,\n        fx_display: fxDisplay,\n        balance: account.balance ?? null,\n      };\n    }),\n    [\n      { key: 'name', label: 'Name' },\n      { key: 'fx_display', label: 'Betrag (FX)' },\n      { key: 'balance', label: 'EUR', align: 'right' as const },\n    ],\n    ['balance'],\n  )}\n        </div>\n        ${fxWarning}\n      </div>` : ''}\n  `;\n\n  // 8. Footer-Karte mit letztem Datei-Änderungszeitpunkt (reintroduziert)\n  const footerCard = `\n    <div class=\"card footer-card\">\n      <div class=\"meta\">\n        <div class=\"last-file-update\">\n          📂 Letzte Aktualisierung der Datei: <strong>${lastFileUpdate || 'Unbekannt'}</strong>\n        </div>\n      </div>\n    </div>\n  `;\n\n  const markup = `\n    ${headerCard.outerHTML}\n    <div class=\"card\">\n      <h2>Investment</h2>\n      <div class=\"scroll-container portfolio-table\">\n        ${portfolioTableHtml}\n      </div>\n    </div>\n    ${accountsHtml}\n    ${footerCard}\n  `;\n\n    schedulePostRenderSetup(root as ToggleRootElement, depots);\n\n  return markup;\n}\n\n  function schedulePostRenderSetup(root: ToggleRootElement | null, depots: readonly PortfolioOverviewDepot[]): void {\n  if (!root) {\n    return;\n  }\n\n  const run = () => {\n    try {\n      const wrapper = root;\n      const tableHost = wrapper.querySelector<HTMLElement>('.portfolio-table');\n      if (tableHost && tableHost.querySelectorAll('.portfolio-toggle').length === 0) {\n        console.debug('Recovery: Tabelle ohne Buttons – erneuter Aufbau');\n        tableHost.innerHTML = buildExpandablePortfolioTable(depots);\n      }\n\n      attachPortfolioToggleHandler(root);\n      ensurePortfolioRowFallbackListener(root);\n\n      expandedPortfolios.forEach((pid) => {\n        try {\n          if (hasPortfolioPositions(pid)) {\n            attachPortfolioPositionsSorting(root, pid);\n            attachSecurityDetailListener(root, pid);\n          }\n        } catch (error) {\n          console.warn('Init-Sortierung für expandiertes Depot fehlgeschlagen:', pid, error);\n        }\n      });\n\n      try {\n        updatePortfolioFooterFromDom(wrapper);\n      } catch (footerErr) {\n        console.warn('renderDashboard: Footer-Summe konnte nicht aktualisiert werden:', footerErr);\n      }\n\n      try {\n        flushAllPendingPositions(root);\n      } catch (pendingErr) {\n        console.warn('renderDashboard: Pending-Positions konnten nicht angewendet werden:', pendingErr);\n      }\n\n      console.debug('renderDashboard: portfolio-toggle Buttons:', wrapper.querySelectorAll('.portfolio-toggle').length);\n    } catch (error) {\n      console.error('renderDashboard: Fehler bei Recovery/Listener', error);\n    }\n  };\n\n  const schedule = typeof requestAnimationFrame === 'function'\n    ? (cb: () => void) => requestAnimationFrame(cb)\n    : (cb: () => void) => setTimeout(cb, 0);\n\n  schedule(() => schedule(run));\n}\n\nregisterOverviewHelpers({\n  renderPositionsTable: (positions) =>\n    renderPortfolioPositions(positions as readonly PortfolioPositionLike[]),\n  applyGainPctMetadata,\n  attachSecurityDetailListener,\n  attachPortfolioPositionsSorting,\n  updatePortfolioFooter: (table) => {\n    if (table) {\n      updatePortfolioFooterFromDom(table);\n    }\n  },\n});\n","/**\n * Chart preparation utilities preserved from the legacy dashboard.\n */\n\n/**\n * Lightweight SVG chart helpers for the PP Reader dashboard.\n *\n * Provides rendering logic for historical security price charts without\n * introducing external dependencies. The helpers expose a simple API with\n * `renderLineChart` for initial setup and `updateLineChart` to mutate an\n * existing chart instance.\n */\n\nconst SVG_NS = 'http://www.w3.org/2000/svg';\nconst DEFAULT_WIDTH = 640;\nconst DEFAULT_HEIGHT = 260;\nconst DEFAULT_MARGIN = { top: 12, right: 16, bottom: 24, left: 16 } as const;\nconst DEFAULT_COLOR = 'var(--pp-reader-chart-line, #3f51b5)';\nconst DEFAULT_AREA = 'var(--pp-reader-chart-area, rgba(63, 81, 181, 0.12))';\nconst DEFAULT_TICK_FONT = '0.75rem';\nconst DEFAULT_BASELINE_COLOR = 'var(--pp-reader-chart-baseline, rgba(96, 125, 139, 0.75))';\nconst DEFAULT_BASELINE_DASH = '6 4';\nconst ONE_DAY_MS = 24 * 60 * 60 * 1000;\n\nfunction toAttributeValue(value: unknown): string | null {\n  if (value == null) {\n    return null;\n  }\n  if (typeof value === 'string') {\n    return value;\n  }\n  if (typeof value === 'number') {\n    return Number.isFinite(value) ? value.toString() : null;\n  }\n  if (typeof value === 'boolean') {\n    return value ? 'true' : 'false';\n  }\n  if (value instanceof Date) {\n    const timestamp = value.getTime();\n    return Number.isFinite(timestamp) ? value.toISOString() : null;\n  }\n  return null;\n}\n\nfunction safeText(value: unknown): string {\n  if (typeof value === 'string') {\n    return value;\n  }\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value.toString();\n  }\n  if (value instanceof Date && Number.isFinite(value.getTime())) {\n    return value.toISOString();\n  }\n  return '';\n}\n\nfunction px(value: number): string {\n  return `${String(value)}px`;\n}\n\nexport type LineChartInputDatum = unknown;\n\nexport type LineChartAccessor = (\n  entry: LineChartInputDatum,\n  index: number,\n) => unknown;\n\nexport type LineChartFormatter = (\n  value: number,\n  entry: LineChartInputDatum,\n  index: number,\n) => string;\n\nexport interface LineChartTooltipPayload {\n  point: LineChartComputedPoint;\n  xFormatted: string;\n  yFormatted: string;\n  data: LineChartInputDatum;\n  index: number;\n}\n\nexport type LineChartTooltipRenderer = (\n  payload: LineChartTooltipPayload,\n) => string;\n\nexport interface ChartMargin {\n  top: number;\n  right: number;\n  bottom: number;\n  left: number;\n}\n\ninterface ChartDimensions {\n  width: number;\n  height: number;\n  margin: ChartMargin;\n}\n\nexport interface LineChartOptions {\n  series?: readonly LineChartInputDatum[];\n  width?: number;\n  height?: number;\n  margin?: Partial<ChartMargin>;\n  xAccessor?: LineChartAccessor;\n  yAccessor?: LineChartAccessor;\n  xFormatter?: LineChartFormatter;\n  yFormatter?: LineChartFormatter;\n  tooltipRenderer?: LineChartTooltipRenderer;\n  color?: string;\n  areaColor?: string;\n  baseline?: LineChartBaselineOptions | null;\n}\n\nexport interface LineChartBaselineOptions {\n  value: number | null | undefined;\n  color?: string;\n  dashArray?: string;\n}\n\ninterface LineChartRange {\n  minX: number;\n  maxX: number;\n  minY: number;\n  maxY: number;\n  boundedWidth: number;\n  boundedHeight: number;\n}\n\nexport interface LineChartComputedPoint {\n  index: number;\n  data: LineChartInputDatum;\n  xValue: number;\n  yValue: number;\n  x: number;\n  y: number;\n}\n\ninterface LineChartInternalState extends ChartDimensions {\n  svg: SVGSVGElement | null;\n  areaPath: SVGPathElement | null;\n  linePath: SVGPathElement | null;\n  baselineLine: SVGLineElement | null;\n  focusLine: SVGLineElement | null;\n  focusCircle: SVGCircleElement | null;\n  overlay: SVGRectElement | null;\n  tooltip: HTMLDivElement | null;\n  xAxis?: HTMLDivElement;\n  yAxis?: HTMLDivElement;\n  series: LineChartInputDatum[];\n  points: LineChartComputedPoint[];\n  range: LineChartRange | null;\n  xAccessor: LineChartAccessor;\n  yAccessor: LineChartAccessor;\n  xFormatter: LineChartFormatter;\n  yFormatter: LineChartFormatter;\n  tooltipRenderer: LineChartTooltipRenderer;\n  color: string;\n  areaColor: string;\n  baseline: LineChartBaselineOptions | null;\n  handlersAttached: boolean;\n  handlePointerMove?: (event: PointerEvent) => void;\n  handlePointerLeave?: (event: PointerEvent) => void;\n}\n\ninterface LineChartContainerElement extends HTMLDivElement {\n  __chartState?: LineChartInternalState;\n}\n\nfunction createSvgElement<K extends keyof SVGElementTagNameMap>(\n  tag: K,\n  attrs: Record<string, unknown> = {},\n): SVGElementTagNameMap[K] {\n  const element = document.createElementNS(SVG_NS, tag);\n  Object.entries(attrs).forEach(([key, value]) => {\n    const attributeValue = toAttributeValue(value);\n    if (attributeValue == null) {\n      return;\n    }\n    element.setAttribute(key, attributeValue);\n  });\n  return element;\n}\n\nfunction toNumber(value: unknown, fallback: number | null = null): number | null {\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n\n  if (typeof value === 'string' && value.trim() !== '') {\n    const parsed = Number.parseFloat(value);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return fallback;\n}\n\nfunction toTimestamp(value: unknown, fallbackIndex: number): number {\n  if (value instanceof Date) {\n    const timestamp = value.getTime();\n    return Number.isFinite(timestamp) ? timestamp : fallbackIndex;\n  }\n\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n\n  if (typeof value === 'string') {\n    const parsed = Date.parse(value);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return fallbackIndex;\n}\n\nconst defaultXAccessor: LineChartAccessor = (entry) => {\n  if (entry && typeof entry === 'object' && 'date' in entry) {\n    return (entry as { date?: unknown }).date;\n  }\n  return undefined;\n};\n\nconst defaultYAccessor: LineChartAccessor = (entry) => {\n  if (entry && typeof entry === 'object' && 'close' in entry) {\n    return (entry as { close?: unknown }).close;\n  }\n  return undefined;\n};\n\nconst defaultXFormatter: LineChartFormatter = (timestamp, dataPoint, _index) => {\n  if (Number.isFinite(timestamp)) {\n    const date = new Date(timestamp);\n    if (!Number.isNaN(date.getTime())) {\n      return date.toLocaleDateString('de-DE');\n    }\n  }\n\n  if (dataPoint && typeof dataPoint === 'object' && 'date' in dataPoint) {\n    const raw = (dataPoint as { date?: unknown }).date;\n    const fallback = safeText(raw);\n    if (fallback) {\n      return fallback;\n    }\n  }\n\n  if (!Number.isFinite(timestamp)) {\n    return '';\n  }\n\n  return timestamp.toString();\n};\n\nconst defaultYFormatter: LineChartFormatter = (value, _dataPoint, _index) => {\n  const numeric = Number.isFinite(value) ? value : toNumber(value, 0) ?? 0;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2,\n  });\n};\n\nconst defaultTooltipRenderer: LineChartTooltipRenderer = ({ xFormatted, yFormatted }) => `\n    <div class=\"chart-tooltip-date\">${xFormatted}</div>\n    <div class=\"chart-tooltip-value\">${yFormatted}&nbsp;€</div>\n  `;\n\nfunction ensureChartState(container: LineChartContainerElement): LineChartInternalState {\n  if (!container.__chartState) {\n    container.__chartState = {\n      svg: null,\n      areaPath: null,\n      linePath: null,\n      baselineLine: null,\n      focusLine: null,\n      focusCircle: null,\n      overlay: null,\n      tooltip: null,\n      width: DEFAULT_WIDTH,\n      height: DEFAULT_HEIGHT,\n      margin: { ...DEFAULT_MARGIN },\n      series: [],\n      points: [],\n      range: null,\n      xAccessor: defaultXAccessor,\n      yAccessor: defaultYAccessor,\n      xFormatter: defaultXFormatter,\n      yFormatter: defaultYFormatter,\n      tooltipRenderer: defaultTooltipRenderer,\n      color: DEFAULT_COLOR,\n      areaColor: DEFAULT_AREA,\n      baseline: null,\n      handlersAttached: false,\n    };\n  }\n  return container.__chartState;\n}\n\nfunction clamp(value: number, min: number, max: number): number {\n  if (!Number.isFinite(value)) {\n    return min;\n  }\n  if (value < min) {\n    return min;\n  }\n  if (value > max) {\n    return max;\n  }\n  return value;\n}\n\nfunction buildAreaPath(points: readonly LineChartComputedPoint[], baselineY: number): string {\n  if (points.length === 0) {\n    return '';\n  }\n\n  const segments: string[] = [];\n  points.forEach((point, index) => {\n    const command = index === 0 ? 'M' : 'L';\n    const x = point.x.toFixed(2);\n    const y = point.y.toFixed(2);\n    segments.push(`${command}${x} ${y}`);\n  });\n\n  const firstPoint = points[0];\n  const lastPoint = points[points.length - 1];\n  const closing = `L${lastPoint.x.toFixed(2)} ${baselineY.toFixed(2)} L${firstPoint.x.toFixed(2)} ${baselineY.toFixed(2)} Z`;\n\n  return `${segments.join(' ')} ${closing}`;\n}\n\nfunction buildLinePath(points: readonly LineChartComputedPoint[]): string {\n  if (points.length === 0) {\n    return '';\n  }\n\n  const segments: string[] = [];\n  points.forEach((point, index) => {\n    const command = index === 0 ? 'M' : 'L';\n    const x = point.x.toFixed(2);\n    const y = point.y.toFixed(2);\n    segments.push(`${command}${x} ${y}`);\n  });\n\n  return segments.join(' ');\n}\n\nfunction applyBaselineAppearance(state: LineChartInternalState): void {\n  const { baselineLine, baseline } = state;\n  if (!baselineLine) {\n    return;\n  }\n\n  const stroke = baseline?.color ?? DEFAULT_BASELINE_COLOR;\n  const dashArray = baseline?.dashArray ?? DEFAULT_BASELINE_DASH;\n\n  baselineLine.setAttribute('stroke', stroke);\n  baselineLine.setAttribute('stroke-dasharray', dashArray);\n}\n\nfunction updateBaselineLine(state: LineChartInternalState): void {\n  const { baselineLine, baseline, range, margin, width } = state;\n  if (!baselineLine) {\n    return;\n  }\n\n  const baselineValue = baseline?.value;\n  if (!range || baselineValue == null || !Number.isFinite(baselineValue)) {\n    baselineLine.style.opacity = '0';\n    return;\n  }\n\n  const { minY, maxY, boundedHeight } = range;\n  const safeMinY = Number.isFinite(minY) ? minY : baselineValue;\n  const safeMaxY = Number.isFinite(maxY) ? maxY : safeMinY + 1;\n  const denominator = safeMaxY - safeMinY;\n  const ratio = denominator === 0 ? 0.5 : (baselineValue - safeMinY) / denominator;\n  const clampedRatio = clamp(ratio, 0, 1);\n\n  const effectiveHeight = Math.max(boundedHeight, 0);\n  const y = margin.top + (1 - clampedRatio) * effectiveHeight;\n  const effectiveWidth = Math.max(width - margin.left - margin.right, 0);\n  const x1 = margin.left;\n  const x2 = margin.left + effectiveWidth;\n\n  baselineLine.setAttribute('x1', x1.toFixed(2));\n  baselineLine.setAttribute('x2', x2.toFixed(2));\n  baselineLine.setAttribute('y1', y.toFixed(2));\n  baselineLine.setAttribute('y2', y.toFixed(2));\n  baselineLine.style.opacity = '1';\n}\n\nfunction computePoints(\n  series: readonly LineChartInputDatum[],\n  dimensions: ChartDimensions & { baseline?: LineChartBaselineOptions | null },\n  accessors: { xAccessor: LineChartAccessor; yAccessor: LineChartAccessor },\n): { points: LineChartComputedPoint[]; range: LineChartRange | null } {\n  const { width, height, margin } = dimensions;\n  const { xAccessor, yAccessor } = accessors;\n\n  if (series.length === 0) {\n    return { points: [], range: null };\n  }\n\n  const rawPoints = series\n    .map((entry, index) => {\n      const rawX = xAccessor(entry, index);\n      const rawY = yAccessor(entry, index);\n      const xValue = toTimestamp(rawX, index);\n      const yValue = toNumber(rawY, Number.NaN);\n      if (!Number.isFinite(yValue)) {\n        return null;\n      }\n      return {\n        index,\n        data: entry,\n        xValue,\n        yValue,\n      };\n    })\n    .filter((point): point is { index: number; data: LineChartInputDatum; xValue: number; yValue: number } => Boolean(point));\n\n  if (rawPoints.length === 0) {\n    return { points: [], range: null };\n  }\n\n  const minX = rawPoints.reduce((min, point) => Math.min(min, point.xValue), rawPoints[0].xValue);\n  const maxX = rawPoints.reduce((max, point) => Math.max(max, point.xValue), rawPoints[0].xValue);\n  const minY = rawPoints.reduce((min, point) => Math.min(min, point.yValue), rawPoints[0].yValue);\n  const maxY = rawPoints.reduce((max, point) => Math.max(max, point.yValue), rawPoints[0].yValue);\n\n  const boundedWidth = Math.max(width - margin.left - margin.right, 1);\n  const boundedHeight = Math.max(height - margin.top - margin.bottom, 1);\n\n  const safeMinX = Number.isFinite(minX) ? minX : 0;\n  const safeMaxX = Number.isFinite(maxX) ? maxX : safeMinX + 1;\n  const safeMinY = Number.isFinite(minY) ? minY : 0;\n  const safeMaxY = Number.isFinite(maxY) ? maxY : safeMinY + 1;\n  const baselineValue = toNumber(dimensions.baseline?.value, null);\n\n  const minDomainCandidate =\n    baselineValue != null && Number.isFinite(baselineValue)\n      ? Math.min(safeMinY, baselineValue)\n      : safeMinY;\n  const maxDomainCandidate =\n    baselineValue != null && Number.isFinite(baselineValue)\n      ? Math.max(safeMaxY, baselineValue)\n      : safeMaxY;\n\n  const desiredYTicks = Math.max(\n    2,\n    Math.min(\n      6,\n      Math.round(\n        Math.max(height - margin.top - margin.bottom, 0) / 60,\n      ) || 4,\n    ),\n  );\n  const { niceMin: domainMinY, niceMax: domainMaxY } = computeNiceDomain(\n    minDomainCandidate,\n    maxDomainCandidate,\n    desiredYTicks,\n  );\n\n  const effectiveMinY = Number.isFinite(domainMinY) ? domainMinY : safeMinY;\n  const effectiveMaxY = Number.isFinite(domainMaxY) ? domainMaxY : safeMaxY;\n\n  const rangeX = safeMaxX - safeMinX || 1;\n  const rangeY = effectiveMaxY - effectiveMinY || 1;\n\n  const points = rawPoints.map((point) => {\n    const ratioX = rangeX === 0 ? 0.5 : (point.xValue - safeMinX) / rangeX;\n    const ratioY = rangeY === 0 ? 0.5 : (point.yValue - effectiveMinY) / rangeY;\n    const x = margin.left + ratioX * boundedWidth;\n    const y = margin.top + (1 - ratioY) * boundedHeight;\n    return {\n      ...point,\n      x,\n      y,\n    } satisfies LineChartComputedPoint;\n  });\n\n  return {\n    points,\n    range: {\n      minX: safeMinX,\n      maxX: safeMaxX,\n      minY: effectiveMinY,\n      maxY: effectiveMaxY,\n      boundedWidth,\n      boundedHeight,\n    },\n  };\n}\n\nfunction assignDimensions(\n  state: LineChartInternalState,\n  width: number | undefined,\n  height: number | undefined,\n  margin: Partial<ChartMargin> | undefined,\n): void {\n  state.width = Number.isFinite(width) ? Number(width) : DEFAULT_WIDTH;\n  state.height = Number.isFinite(height) ? Number(height) : DEFAULT_HEIGHT;\n  state.margin = {\n    top: Number.isFinite(margin?.top) ? Number(margin?.top) : DEFAULT_MARGIN.top,\n    right: Number.isFinite(margin?.right) ? Number(margin?.right) : DEFAULT_MARGIN.right,\n    bottom: Number.isFinite(margin?.bottom) ? Number(margin?.bottom) : DEFAULT_MARGIN.bottom,\n    left: Number.isFinite(margin?.left) ? Number(margin?.left) : DEFAULT_MARGIN.left,\n  };\n}\n\nfunction formatTooltip(state: LineChartInternalState, point: LineChartComputedPoint): string {\n  const xFormatted = state.xFormatter(point.xValue, point.data, point.index);\n  const yFormatted = state.yFormatter(point.yValue, point.data, point.index);\n  return state.tooltipRenderer({\n    point,\n    xFormatted,\n    yFormatted,\n    data: point.data,\n    index: point.index,\n  });\n}\n\nfunction updateTooltipPosition(\n  state: LineChartInternalState,\n  point: LineChartComputedPoint,\n  pointerY: number | null,\n): void {\n  const { tooltip, width, margin, height } = state;\n  if (!tooltip) {\n    return;\n  }\n\n  const baselineY = height - margin.bottom;\n  tooltip.style.visibility = 'visible';\n  tooltip.style.opacity = '1';\n  const tooltipWidth = tooltip.offsetWidth || 0;\n  const tooltipHeight = tooltip.offsetHeight || 0;\n  const horizontal = clamp(point.x - tooltipWidth / 2, margin.left, width - margin.right - tooltipWidth);\n  const maxVertical = Math.max(baselineY - tooltipHeight, 0);\n  const padding = 12;\n  const anchorY = Number.isFinite(pointerY)\n    ? clamp(pointerY ?? 0, margin.top, baselineY)\n    : point.y;\n  let vertical = anchorY - tooltipHeight - padding;\n  if (vertical < margin.top) {\n    vertical = anchorY + padding;\n  }\n  vertical = clamp(vertical, 0, maxVertical);\n  const translateX = px(Math.round(horizontal));\n  const translateY = px(Math.round(vertical));\n  tooltip.style.transform = `translate(${translateX}, ${translateY})`;\n}\n\nfunction hideTooltip(state: LineChartInternalState): void {\n  const { tooltip, focusLine, focusCircle } = state;\n  if (tooltip) {\n    tooltip.style.opacity = '0';\n    tooltip.style.visibility = 'hidden';\n  }\n  if (focusLine) {\n    focusLine.style.opacity = '0';\n  }\n  if (focusCircle) {\n    focusCircle.style.opacity = '0';\n  }\n}\n\nfunction attachPointerHandlers(\n  container: LineChartContainerElement,\n  state: LineChartInternalState,\n): void {\n  if (state.handlersAttached || !state.overlay) {\n    return;\n  }\n\n  const handlePointerMove = (event: PointerEvent) => {\n    if (state.points.length === 0 || !state.svg) {\n      hideTooltip(state);\n      return;\n    }\n\n    const rect = state.svg.getBoundingClientRect();\n    const pointerX = event.clientX - rect.left;\n    const pointerY = event.clientY - rect.top;\n    let closest = state.points[0];\n    let minDistance = Math.abs(pointerX - closest.x);\n\n    for (let idx = 1; idx < state.points.length; idx += 1) {\n      const candidate = state.points[idx];\n      const distance = Math.abs(pointerX - candidate.x);\n      if (distance < minDistance) {\n        minDistance = distance;\n        closest = candidate;\n      }\n    }\n\n    if (state.focusCircle) {\n      state.focusCircle.setAttribute('cx', closest.x.toFixed(2));\n      state.focusCircle.setAttribute('cy', closest.y.toFixed(2));\n      state.focusCircle.style.opacity = '1';\n    }\n\n    if (state.focusLine) {\n      state.focusLine.setAttribute('x1', closest.x.toFixed(2));\n      state.focusLine.setAttribute('x2', closest.x.toFixed(2));\n      state.focusLine.setAttribute('y1', state.margin.top.toFixed(2));\n      state.focusLine.setAttribute(\n        'y2',\n        (state.height - state.margin.bottom).toFixed(2),\n      );\n      state.focusLine.style.opacity = '1';\n    }\n\n    if (state.tooltip) {\n      state.tooltip.innerHTML = formatTooltip(state, closest);\n      updateTooltipPosition(state, closest, pointerY);\n    }\n  };\n\n  const handlePointerLeave = () => {\n    hideTooltip(state);\n  };\n\n  state.overlay.addEventListener('pointermove', handlePointerMove);\n  state.overlay.addEventListener('pointerenter', handlePointerMove);\n  state.overlay.addEventListener('pointerleave', handlePointerLeave);\n\n  state.handlersAttached = true;\n  state.handlePointerMove = handlePointerMove;\n  state.handlePointerLeave = handlePointerLeave;\n\n  container.addEventListener('pointercancel', handlePointerLeave);\n}\n\nexport function renderLineChart(\n  root: HTMLElement,\n  options: LineChartOptions = {},\n): LineChartContainerElement | null {\n  const container = document.createElement('div') as LineChartContainerElement;\n  container.className = 'line-chart-container';\n  container.dataset.chartType = 'line';\n  container.style.position = 'relative';\n\n  const svg = createSvgElement('svg', {\n    width: DEFAULT_WIDTH,\n    height: DEFAULT_HEIGHT,\n    viewBox: `0 0 ${String(DEFAULT_WIDTH)} ${String(DEFAULT_HEIGHT)}`,\n    role: 'img',\n    'aria-hidden': 'true',\n    focusable: 'false',\n  });\n  svg.classList.add('line-chart-svg');\n\n  const areaPath = createSvgElement('path', {\n    class: 'line-chart-area',\n    fill: DEFAULT_AREA,\n    stroke: 'none',\n  });\n\n  const baselineLine = createSvgElement('line', {\n    class: 'line-chart-baseline',\n    stroke: DEFAULT_BASELINE_COLOR,\n    'stroke-width': 1,\n    'stroke-dasharray': DEFAULT_BASELINE_DASH,\n    opacity: 0,\n  });\n\n  const linePath = createSvgElement('path', {\n    class: 'line-chart-path',\n    fill: 'none',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 2,\n    'stroke-linecap': 'round',\n    'stroke-linejoin': 'round',\n  });\n\n  const focusLine = createSvgElement('line', {\n    class: 'line-chart-focus-line',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 1,\n    'stroke-dasharray': '4 4',\n    opacity: 0,\n  });\n\n  const focusCircle = createSvgElement('circle', {\n    class: 'line-chart-focus-circle',\n    r: 4,\n    fill: '#fff',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 2,\n    opacity: 0,\n  });\n\n  const overlay = createSvgElement('rect', {\n    class: 'line-chart-overlay',\n    fill: 'transparent',\n    x: 0,\n    y: 0,\n    width: DEFAULT_WIDTH,\n    height: DEFAULT_HEIGHT,\n  });\n\n  svg.appendChild(areaPath);\n  svg.appendChild(baselineLine);\n  svg.appendChild(linePath);\n  svg.appendChild(focusLine);\n  svg.appendChild(focusCircle);\n  svg.appendChild(overlay);\n\n  container.appendChild(svg);\n\n  const tooltip = document.createElement('div');\n  tooltip.className = 'chart-tooltip';\n  tooltip.style.position = 'absolute';\n  tooltip.style.top = '0';\n  tooltip.style.left = '0';\n  tooltip.style.pointerEvents = 'none';\n  tooltip.style.opacity = '0';\n  tooltip.style.visibility = 'hidden';\n  container.appendChild(tooltip);\n\n  root.appendChild(container);\n\n  const state = ensureChartState(container);\n  state.svg = svg;\n  state.areaPath = areaPath;\n  state.linePath = linePath;\n  state.baselineLine = baselineLine;\n  state.focusLine = focusLine;\n  state.focusCircle = focusCircle;\n  state.overlay = overlay;\n  state.tooltip = tooltip;\n  state.xAccessor = options.xAccessor ?? defaultXAccessor;\n  state.yAccessor = options.yAccessor ?? defaultYAccessor;\n  state.xFormatter = options.xFormatter ?? defaultXFormatter;\n  state.yFormatter = options.yFormatter ?? defaultYFormatter;\n  state.tooltipRenderer = options.tooltipRenderer ?? defaultTooltipRenderer;\n  state.color = options.color ?? DEFAULT_COLOR;\n  state.areaColor = options.areaColor ?? DEFAULT_AREA;\n  state.baseline = options.baseline ?? null;\n  state.handlersAttached = false;\n\n  if (!state.xAxis) {\n    const xAxis = document.createElement('div');\n    xAxis.className = 'line-chart-axis line-chart-axis-x';\n    xAxis.style.position = 'absolute';\n    xAxis.style.left = '0';\n    xAxis.style.right = '0';\n    xAxis.style.bottom = '0';\n    xAxis.style.pointerEvents = 'none';\n    xAxis.style.fontSize = DEFAULT_TICK_FONT;\n    xAxis.style.color = 'var(--secondary-text-color)';\n    xAxis.style.display = 'block';\n    container.appendChild(xAxis);\n    state.xAxis = xAxis;\n  }\n\n  if (!state.yAxis) {\n    const yAxis = document.createElement('div');\n    yAxis.className = 'line-chart-axis line-chart-axis-y';\n    yAxis.style.position = 'absolute';\n    yAxis.style.top = '0';\n    yAxis.style.bottom = '0';\n    yAxis.style.left = '0';\n    yAxis.style.pointerEvents = 'none';\n    yAxis.style.fontSize = DEFAULT_TICK_FONT;\n    yAxis.style.color = 'var(--secondary-text-color)';\n    yAxis.style.display = 'block';\n    container.appendChild(yAxis);\n    state.yAxis = yAxis;\n  }\n\n  assignDimensions(state, options.width, options.height, options.margin);\n\n  linePath.setAttribute('stroke', state.color);\n  focusLine.setAttribute('stroke', state.color);\n  focusCircle.setAttribute('stroke', state.color);\n  areaPath.setAttribute('fill', state.areaColor);\n\n  updateLineChart(container, options);\n  attachPointerHandlers(container, state);\n\n  return container;\n}\n\nexport function updateLineChart(\n  container: LineChartContainerElement | null,\n  options: LineChartOptions = {},\n): void {\n  if (!container) {\n    console.error('updateLineChart: container element is required');\n    return;\n  }\n\n  const state = ensureChartState(container);\n  if (!state.svg || !state.linePath || !state.overlay) {\n    console.error('updateLineChart: chart was not initialised with renderLineChart');\n    return;\n  }\n\n  if (options.xAccessor) {\n    state.xAccessor = options.xAccessor;\n  }\n  if (options.yAccessor) {\n    state.yAccessor = options.yAccessor;\n  }\n  if (options.xFormatter) {\n    state.xFormatter = options.xFormatter;\n  }\n  if (options.yFormatter) {\n    state.yFormatter = options.yFormatter;\n  }\n  if (options.tooltipRenderer) {\n    state.tooltipRenderer = options.tooltipRenderer;\n  }\n  if (options.color) {\n    state.color = options.color;\n    state.linePath.setAttribute('stroke', state.color);\n    if (state.focusLine) {\n      state.focusLine.setAttribute('stroke', state.color);\n    }\n    if (state.focusCircle) {\n      state.focusCircle.setAttribute('stroke', state.color);\n    }\n  }\n  if (options.areaColor) {\n    state.areaColor = options.areaColor;\n    if (state.areaPath) {\n      state.areaPath.setAttribute('fill', state.areaColor);\n    }\n  }\n\n  if (Object.prototype.hasOwnProperty.call(options, 'baseline')) {\n    state.baseline = options.baseline ?? null;\n  }\n\n  applyBaselineAppearance(state);\n\n  assignDimensions(state, options.width, options.height, options.margin);\n\n  const { width, height, margin } = state;\n  state.svg.setAttribute('width', String(width));\n  state.svg.setAttribute('height', String(height));\n  state.svg.setAttribute('viewBox', `0 0 ${String(width)} ${String(height)}`);\n\n  state.overlay.setAttribute('x', margin.left.toFixed(2));\n  state.overlay.setAttribute('y', margin.top.toFixed(2));\n  state.overlay.setAttribute(\n    'width',\n    Math.max(width - margin.left - margin.right, 0).toFixed(2),\n  );\n  state.overlay.setAttribute(\n    'height',\n    Math.max(height - margin.top - margin.bottom, 0).toFixed(2),\n  );\n\n  if (Array.isArray(options.series)) {\n    state.series = Array.from(options.series);\n  }\n\n  const { points, range } = computePoints(state.series, state, {\n    xAccessor: state.xAccessor,\n    yAccessor: state.yAccessor,\n  });\n  state.points = points;\n  state.range = range;\n\n  if (points.length === 0) {\n    state.linePath.setAttribute('d', '');\n    if (state.areaPath) {\n      state.areaPath.setAttribute('d', '');\n    }\n    hideTooltip(state);\n    updateAxes(state);\n    updateBaselineLine(state);\n    return;\n  }\n\n  const lineD = buildLinePath(points);\n  state.linePath.setAttribute('d', lineD);\n\n  if (state.areaPath && range) {\n    const baselineY = state.margin.top + range.boundedHeight;\n    const areaD = buildAreaPath(points, baselineY);\n    state.areaPath.setAttribute('d', areaD);\n  }\n\n  updateAxes(state);\n  updateBaselineLine(state);\n}\n\nfunction updateAxes(state: LineChartInternalState): void {\n  const { xAxis, yAxis, range, margin, height, yFormatter } = state;\n  if (!xAxis || !yAxis) {\n    return;\n  }\n\n  if (!range) {\n    xAxis.innerHTML = '';\n    yAxis.innerHTML = '';\n    return;\n  }\n\n  const { minX, maxX, minY, maxY, boundedWidth, boundedHeight } = range;\n\n  const hasValidX = Number.isFinite(minX) && Number.isFinite(maxX) && maxX >= minX;\n  const hasValidY = Number.isFinite(minY) && Number.isFinite(maxY) && maxY >= minY;\n\n  const effectiveWidth = Math.max(boundedWidth, 0);\n  const effectiveHeight = Math.max(boundedHeight, 0);\n\n  xAxis.style.left = px(margin.left);\n  xAxis.style.width = px(effectiveWidth);\n  xAxis.style.top = px(height - margin.bottom + 6);\n  xAxis.innerHTML = '';\n\n  if (hasValidX && effectiveWidth > 0) {\n    const rangeDays = (maxX - minX) / ONE_DAY_MS;\n    const desiredTicks = Math.max(2, Math.min(6, Math.round(effectiveWidth / 140) || 4));\n    const xTicks = generateTimeAxisTicks(state, minX, maxX, desiredTicks, rangeDays);\n    xTicks.forEach(({ positionRatio, label }) => {\n      const tick = document.createElement('div');\n      tick.className = 'line-chart-axis-tick line-chart-axis-tick-x';\n      tick.style.position = 'absolute';\n      tick.style.bottom = '0';\n      const ratio = clamp(positionRatio, 0, 1);\n      tick.style.left = px(ratio * effectiveWidth);\n      let translateX = '-50%';\n      let textAlign: CSSStyleDeclaration['textAlign'] = 'center';\n      if (ratio <= 0.001) {\n        translateX = '0';\n        textAlign = 'left';\n        tick.style.marginLeft = '2px';\n      } else if (ratio >= 0.999) {\n        translateX = '-100%';\n        textAlign = 'right';\n        tick.style.marginRight = '2px';\n      }\n      tick.style.transform = `translateX(${translateX})`;\n      tick.style.textAlign = textAlign;\n      tick.textContent = label;\n      xAxis.appendChild(tick);\n    });\n  }\n\n  yAxis.style.top = px(margin.top);\n  yAxis.style.height = px(effectiveHeight);\n  const yAxisWidth = Math.max(margin.left - 6, 0);\n  yAxis.style.left = '0';\n  yAxis.style.width = px(Math.max(yAxisWidth, 0));\n  yAxis.innerHTML = '';\n\n  if (hasValidY && effectiveHeight > 0) {\n    const desiredTicks = Math.max(2, Math.min(6, Math.round(effectiveHeight / 60) || 4));\n    const yTicks = generateNumericAxisTicks(minY, maxY, desiredTicks);\n    const applyFormatter = yFormatter;\n    yTicks.forEach(({ value, positionRatio }) => {\n      const tick = document.createElement('div');\n      tick.className = 'line-chart-axis-tick line-chart-axis-tick-y';\n      tick.style.position = 'absolute';\n      tick.style.left = '0';\n      const clampedRatio = clamp(positionRatio, 0, 1);\n      const top = (1 - clampedRatio) * effectiveHeight;\n      tick.style.top = px(top);\n      tick.textContent = applyFormatter(value, null, -1);\n      yAxis.appendChild(tick);\n    });\n  }\n}\n\nfunction computeNiceDomain(\n  minValue: number,\n  maxValue: number,\n  desiredTicks = 4,\n): { niceMin: number; niceMax: number } {\n  if (!Number.isFinite(minValue) || !Number.isFinite(maxValue)) {\n    return {\n      niceMin: minValue,\n      niceMax: maxValue,\n    };\n  }\n\n  const safeTicks = Math.max(2, desiredTicks);\n\n  if (maxValue === minValue) {\n    const padding = niceStep(Math.abs(minValue) || 1);\n    return {\n      niceMin: minValue - padding,\n      niceMax: maxValue + padding,\n    };\n  }\n\n  const range = maxValue - minValue;\n  const rawStep = range / (safeTicks - 1);\n  const step = niceStep(rawStep);\n  const niceMin = Math.floor(minValue / step) * step;\n  const niceMax = Math.ceil(maxValue / step) * step;\n\n  if (niceMin === niceMax) {\n    return {\n      niceMin: minValue,\n      niceMax: maxValue + step,\n    };\n  }\n\n  return {\n    niceMin,\n    niceMax,\n  };\n}\n\nfunction generateTimeAxisTicks(\n  state: LineChartInternalState,\n  minTimestamp: number,\n  maxTimestamp: number,\n  desiredTicks: number,\n  rangeDays: number,\n): Array<{ positionRatio: number; label: string }> {\n  if (!Number.isFinite(minTimestamp) || !Number.isFinite(maxTimestamp) || maxTimestamp < minTimestamp) {\n    return [];\n  }\n\n  if (!Number.isFinite(rangeDays) || rangeDays <= 0) {\n    const label = formatXAxisLabel(state, minTimestamp, rangeDays || 0);\n    return [\n      {\n        positionRatio: 0.5,\n        label,\n      },\n    ];\n  }\n\n  const tickCount = Math.max(2, desiredTicks);\n  const ticks: Array<{ positionRatio: number; label: string }> = [];\n  const range = maxTimestamp - minTimestamp;\n  for (let index = 0; index < tickCount; index += 1) {\n    const ratio = tickCount === 1 ? 0.5 : index / (tickCount - 1);\n    const value = minTimestamp + ratio * range;\n    ticks.push({\n      positionRatio: ratio,\n      label: formatXAxisLabel(state, value, rangeDays),\n    });\n  }\n  return ticks;\n}\n\nfunction formatXAxisLabel(\n  state: LineChartInternalState,\n  timestamp: number,\n  rangeDays: number,\n): string {\n  const date = new Date(timestamp);\n  if (Number.isFinite(date.getTime())) {\n    if (rangeDays > 1095) {\n      return String(date.getFullYear());\n    }\n    if (rangeDays > 365) {\n      return date.toLocaleDateString('de-DE', {\n        year: 'numeric',\n        month: 'short',\n      });\n    }\n    if (rangeDays > 90) {\n      return date.toLocaleDateString('de-DE', {\n        year: '2-digit',\n        month: 'short',\n      });\n    }\n    if (rangeDays > 30) {\n      return date.toLocaleDateString('de-DE', {\n        day: '2-digit',\n        month: 'short',\n      });\n    }\n    return date.toLocaleDateString('de-DE', {\n      day: '2-digit',\n      month: '2-digit',\n    });\n  }\n\n  return state.xFormatter(timestamp, null, -1);\n}\n\nfunction generateNumericAxisTicks(\n  minValue: number,\n  maxValue: number,\n  desiredTicks: number,\n): Array<{ value: number; positionRatio: number }> {\n  if (!Number.isFinite(minValue) || !Number.isFinite(maxValue)) {\n    return [];\n  }\n\n  if (maxValue === minValue) {\n    return [\n      {\n        value: minValue,\n        positionRatio: 0.5,\n      },\n    ];\n  }\n\n  const range = maxValue - minValue;\n  const tickCount = Math.max(2, desiredTicks);\n  const rawStep = range / (tickCount - 1);\n  const step = niceStep(rawStep);\n  const start = Math.floor(minValue / step) * step;\n  const end = Math.ceil(maxValue / step) * step;\n\n  const ticks: Array<{ value: number; positionRatio: number }> = [];\n  for (let value = start; value <= end + step / 2; value += step) {\n    const ratio = (value - minValue) / (maxValue - minValue);\n    ticks.push({\n      value,\n      positionRatio: clamp(ratio, 0, 1),\n    });\n  }\n\n  if (ticks.length > tickCount + 2) {\n    return ticks.filter((_, index) => index % 2 === 0);\n  }\n\n  return ticks;\n}\n\nfunction niceStep(value: number): number {\n  if (!Number.isFinite(value) || value === 0) {\n    return 1;\n  }\n\n  const exponent = Math.floor(Math.log10(Math.abs(value)));\n  const fraction = Math.abs(value) / 10 ** exponent;\n  let niceFraction: number;\n  if (fraction <= 1) {\n    niceFraction = 1;\n  } else if (fraction <= 2) {\n    niceFraction = 2;\n  } else if (fraction <= 5) {\n    niceFraction = 5;\n  } else {\n    niceFraction = 10;\n  }\n  return niceFraction * 10 ** exponent;\n}\n","/**\n * Shared type declarations for PP Reader dashboard tabs.\n *\n * These interfaces centralize cross-tab contracts so the migration from the\n * legacy JavaScript modules can progressively add stronger typing without\n * duplicating structural definitions in each module.\n */\n\nimport type { HomeAssistant } from \"../types/home-assistant\";\n\ntype UnknownRecord = Record<string, unknown>;\n\nfunction isNumber(value: unknown): value is number {\n  return typeof value === \"number\";\n}\n\nfunction isNullableNumber(value: unknown): value is number | null {\n  return value === null || isNumber(value);\n}\n\nfunction isStringArray(value: unknown): value is string[] {\n  return Array.isArray(value) && value.every((entry) => typeof entry === \"string\");\n}\n\nfunction isRecord(value: unknown): value is UnknownRecord {\n  return typeof value === \"object\" && value !== null;\n}\n\n/**\n * Supported provenance markers for helper-provided average cost payloads.\n */\nexport type AverageCostSource = \"aggregation\" | \"totals\" | \"eur_total\";\n\nexport interface AverageCostPayload {\n  native: number | null;\n  security: number | null;\n  account: number | null;\n  eur: number | null;\n  source: AverageCostSource;\n  coverage_ratio: number | null;\n}\n\n/**\n * Optional day-change metrics accompanying a performance payload.\n */\nexport interface PerformanceDayChangePayload {\n  price_change_native: number | null;\n  price_change_eur: number | null;\n  change_pct: number | null;\n  source: string;\n  coverage_ratio: number | null;\n}\n\n/**\n * Normalised gain and change metrics shared between backend payloads.\n *\n * Consumers should rely on this payload for gain and percentage metrics rather\n * than legacy flat mirrors.\n */\nexport interface PerformanceMetricsPayload {\n  gain_abs: number;\n  gain_pct: number;\n  total_change_eur: number;\n  total_change_pct: number;\n  source: string;\n  coverage_ratio: number | null;\n  day_change?: PerformanceDayChangePayload | null;\n}\n\nexport interface PanelConfigLike {\n  entry_id?: string | null;\n  config?: {\n    entry_id?: string | null;\n    _panel_custom?: {\n      config?: {\n        entry_id?: string | null;\n      } | null;\n    } | null;\n  } | null;\n  webcomponent_name?: string | null;\n  [key: string]: unknown;\n}\n\nexport interface DashboardTabRenderContext {\n  root: HTMLElement;\n  hass: HomeAssistant | null | undefined;\n  panelConfig: PanelConfigLike | null | undefined;\n}\n\nexport type DashboardTabRenderResult =\n  | string\n  | undefined\n  | Promise<string | undefined>;\n\nexport type DashboardTabRenderFn = (\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n) => DashboardTabRenderResult;\n\nexport interface DashboardTabDescriptor {\n  key: string;\n  title: string;\n  render: DashboardTabRenderFn;\n  cleanup?: (context: { key: string }) => void | Promise<void>;\n  [key: string]: unknown;\n}\n\nexport type SecurityHistoryRangeKey = \"1M\" | \"6M\" | \"1Y\" | \"5Y\" | \"ALL\";\n\nexport interface SecurityHistoryRangeState {\n  activeRange: SecurityHistoryRangeKey;\n  [key: string]: unknown;\n}\n\nexport interface SecuritySnapshotLike {\n  security_uuid: string;\n  name: string;\n  currency_code?: string | null;\n  total_holdings: number;\n  purchase_value_eur: number;\n  current_value_eur: number;\n  gain_pct: number;\n  last_price_native?: number | null;\n  last_price_eur: number | null;\n  last_close_native?: number | null;\n  last_close_eur?: number | null;\n  /**\n   * Structured selection of average purchase prices with provenance metadata.\n   */\n  average_cost?: AverageCostPayload | null;\n  aggregation?: HoldingsAggregationPayload | null;\n  /** Structured gain and day-change metrics shared across payloads. */\n  performance?: PerformanceMetricsPayload | null;\n  /** Raw snapshot provenance flag (e.g. cache vs. live). */\n  source?: string | null;\n  [key: string]: unknown;\n}\n\nexport interface HoldingsAggregationPayload {\n  total_holdings: number;\n  positive_holdings: number;\n  purchase_value_cents: number;\n  purchase_value_eur: number;\n  security_currency_total: number;\n  account_currency_total: number;\n  purchase_total_security: number;\n  purchase_total_account: number;\n}\n\nexport interface PortfolioPosition {\n  security_uuid: string;\n  name: string;\n  current_holdings: number;\n  purchase_value: number;\n  current_value: number;\n  /**\n   * Structured selection of average purchase prices with provenance metadata.\n   */\n  average_cost: AverageCostPayload | null;\n  /** Structured gain metrics supplied by the backend. */\n  performance: PerformanceMetricsPayload | null;\n  aggregation: HoldingsAggregationPayload | null;\n  /** Client-side convenience mirrors derived from the performance payload. */\n  gain_abs?: number | null;\n  /** Client-side convenience mirrors derived from the performance payload. */\n  gain_pct?: number | null;\n  [key: string]: unknown;\n}\n\nexport interface PortfolioPositionsUpdatedEventDetail {\n  portfolioUuid: string;\n  securityUuids: string[];\n}\n\nexport type PortfolioPositionsUpdatedEvent = CustomEvent<PortfolioPositionsUpdatedEventDetail>;\n\nexport function isAverageCostPayload(value: unknown): value is AverageCostPayload {\n  if (!isRecord(value)) {\n    return false;\n  }\n\n  const record = value;\n\n  if (typeof record.source !== \"string\") {\n    return false;\n  }\n\n  const hasNative = \"native\" in record && isNullableNumber(record.native);\n  const hasSecurity = \"security\" in record && isNullableNumber(record.security);\n  const hasAccount = \"account\" in record && isNullableNumber(record.account);\n  const hasEur = \"eur\" in record && isNullableNumber(record.eur);\n\n  if (!hasNative || !hasSecurity || !hasAccount || !hasEur) {\n    return false;\n  }\n\n  if (\"coverage_ratio\" in record && !isNullableNumber(record.coverage_ratio)) {\n    return false;\n  }\n\n  return true;\n}\n\nexport function isPerformanceDayChangePayload(\n  value: unknown,\n): value is PerformanceDayChangePayload {\n  if (!isRecord(value)) {\n    return false;\n  }\n\n  const record = value;\n\n  if (typeof record.source !== \"string\") {\n    return false;\n  }\n\n  const hasNative = \"price_change_native\" in record && isNullableNumber(record.price_change_native);\n  const hasEur = \"price_change_eur\" in record && isNullableNumber(record.price_change_eur);\n  const hasChange = \"change_pct\" in record && isNullableNumber(record.change_pct);\n\n  if (!hasNative || !hasEur || !hasChange) {\n    return false;\n  }\n\n  if (\"coverage_ratio\" in record && !isNullableNumber(record.coverage_ratio)) {\n    return false;\n  }\n\n  return true;\n}\n\nexport function isPerformanceMetricsPayload(value: unknown): value is PerformanceMetricsPayload {\n  if (!isRecord(value)) {\n    return false;\n  }\n\n  const record = value;\n\n  if (\n    !isNumber(record.gain_abs) ||\n    !isNumber(record.gain_pct) ||\n    !isNumber(record.total_change_eur) ||\n    !isNumber(record.total_change_pct) ||\n    typeof record.source !== \"string\"\n  ) {\n    return false;\n  }\n\n  if (\"coverage_ratio\" in record && !isNullableNumber(record.coverage_ratio)) {\n    return false;\n  }\n\n  if (\"day_change\" in record && record.day_change !== undefined && record.day_change !== null) {\n    if (!isPerformanceDayChangePayload(record.day_change)) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\nexport function isHoldingsAggregationPayload(value: unknown): value is HoldingsAggregationPayload {\n  if (!isRecord(value)) {\n    return false;\n  }\n\n  const record = value;\n\n  return (\n    isNumber(record.total_holdings) &&\n    isNumber(record.positive_holdings) &&\n    isNumber(record.purchase_value_cents) &&\n    isNumber(record.purchase_value_eur) &&\n    isNumber(record.security_currency_total) &&\n    isNumber(record.account_currency_total) &&\n    isNumber(record.purchase_total_security) &&\n    isNumber(record.purchase_total_account)\n  );\n}\n\nexport function isPortfolioPositionsUpdatedEventDetail(\n  value: unknown,\n): value is PortfolioPositionsUpdatedEventDetail {\n  if (!isRecord(value)) {\n    return false;\n  }\n\n  const record = value;\n\n  if (typeof record.portfolioUuid !== \"string\") {\n    return false;\n  }\n\n  return isStringArray(record.securityUuids);\n}\n\nexport function isPortfolioPositionsUpdatedEvent(\n  event: Event,\n): event is PortfolioPositionsUpdatedEvent {\n  if (!(event instanceof CustomEvent)) {\n    return false;\n  }\n\n  return isPortfolioPositionsUpdatedEventDetail(event.detail);\n}\n","/**\n * Security detail tab renderer migrated verbatim for TypeScript.\n */\n\n/**\n * Security detail tab renderer and registration.\n *\n * Provides the render function used by dynamic security tabs and\n * exposes a helper to register the descriptor factory with the\n * dashboard controller.\n */\nimport {\n  createHeaderCard,\n  formatNumber,\n  formatGain,\n  formatGainPct,\n} from '../content/elements';\nimport { renderLineChart, updateLineChart } from '../content/charting';\nimport type { LineChartOptions } from '../content/charting';\nimport {\n  fetchSecuritySnapshotWS,\n  fetchSecurityHistoryWS,\n} from '../data/api';\nimport type {\n  SecuritySnapshotResponse,\n  SecurityHistoryResponse,\n  SecurityHistoryOptions,\n} from '../data/api';\nimport type { HomeAssistant } from '../types/home-assistant';\nimport type {\n  DashboardTabRenderFn,\n  PanelConfigLike,\n  PortfolioPositionsUpdatedEventDetail,\n  SecurityHistoryRangeKey,\n  SecurityHistoryRangeState,\n  SecuritySnapshotLike,\n  HoldingsAggregationPayload,\n  AverageCostPayload,\n  AverageCostSource,\n} from './types';\nimport { isPortfolioPositionsUpdatedEvent } from './types';\nimport { toFiniteCurrency, normalizePercentValue } from '../utils/currency';\nimport { normalizePerformancePayload } from '../utils/performance';\n\nconst HOLDINGS_FRACTION_DIGITS = { min: 0, max: 6 } as const;\nconst PRICE_FRACTION_DIGITS = { min: 2, max: 4 } as const;\nconst DEFAULT_HISTORY_RANGE: SecurityHistoryRangeKey = '1Y';\nconst AVAILABLE_HISTORY_RANGES: readonly SecurityHistoryRangeKey[] = [\n  '1M',\n  '6M',\n  '1Y',\n  '5Y',\n  'ALL',\n];\nconst RANGE_DAY_COUNTS: Record<SecurityHistoryRangeKey, number> = {\n  '1M': 30,\n  '6M': 182,\n  '1Y': 365,\n  '5Y': 1826,\n  'ALL': Number.POSITIVE_INFINITY,\n};\n\ntype SecuritySnapshotDetail = Partial<Omit<SecuritySnapshotLike, 'security_uuid'>> & {\n  security_uuid?: string | null;\n  name?: string | null;\n  total_holdings?: number | string | null;\n  total_holdings_precise?: number | string | null;\n  last_price_native?: number | string | null;\n  last_price_eur?: number | string | null;\n  market_value_eur?: number | string | null;\n  current_value_eur?: number | string | null;\n  currency_code?: string | null;\n  last_close_native?: number | string | null;\n  last_close_eur?: number | string | null;\n  last_price?: {\n    native?: number | string | null;\n    [key: string]: unknown;\n  } | null;\n  source?: string | null;\n  [key: string]: unknown;\n};\n\ninterface RawHistoryEntry {\n  date?: unknown;\n  close?: unknown;\n  close_raw?: unknown;\n  [key: string]: unknown;\n}\n\ninterface NormalizedHistoryEntry {\n  date: Date | string | number;\n  close: number;\n}\n\ntype HistoryPlaceholderState =\n  | { status: 'loaded' }\n  | { status: 'empty' }\n  | { status: 'error'; message?: string };\n\ntype SecurityHistoryCache = Map<SecurityHistoryRangeKey, NormalizedHistoryEntry[]>;\n\ntype HistoryCacheRegistry = Map<string, SecurityHistoryCache>;\n\ntype RangeStateRegistry = Map<string, SecurityHistoryRangeState>;\n\ntype SnapshotDetailRegistry = Map<string, SecuritySnapshotDetail>;\n\nconst AVERAGE_COST_SOURCE_LABELS: Record<AverageCostSource, string> = {\n  aggregation: 'Aggregationsdaten',\n  totals: 'Kaufsummen',\n  eur_total: 'EUR-Kaufsumme',\n};\n\ntype LiveUpdateHandler = (event: Event) => void;\n\nconst SECURITY_HISTORY_CACHE: HistoryCacheRegistry = new Map();\nconst RANGE_STATE_REGISTRY: RangeStateRegistry = new Map();\nconst SNAPSHOT_DETAIL_REGISTRY: SnapshotDetailRegistry = new Map();\nconst LIVE_UPDATE_EVENT = 'pp-reader:portfolio-positions-updated';\nconst LIVE_UPDATE_HANDLERS = new Map<string, LiveUpdateHandler>();\n\nfunction extractAverageCostPayload(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): AverageCostPayload | null {\n  if (!snapshot) {\n    return null;\n  }\n\n  const rawAverageCost = snapshot.average_cost;\n  if (!rawAverageCost || typeof rawAverageCost !== 'object') {\n    return null;\n  }\n\n  const candidate = rawAverageCost as Partial<AverageCostPayload> & {\n    coverage_ratio?: unknown;\n    source?: unknown;\n  };\n\n  const native = toFiniteNumber(candidate.native);\n  const security = toFiniteNumber(candidate.security);\n  const account = toFiniteNumber(candidate.account);\n  const eur = toFiniteNumber(candidate.eur);\n  const coverageRatio = toFiniteNumber(candidate.coverage_ratio);\n\n  if (\n    native == null &&\n    security == null &&\n    account == null &&\n    eur == null &&\n    coverageRatio == null\n  ) {\n    return null;\n  }\n\n  const source = candidate.source;\n  const normalizedSource: AverageCostSource =\n    source === 'totals' || source === 'eur_total' ? source : 'aggregation';\n\n  return {\n    native,\n    security,\n    account,\n    eur,\n    source: normalizedSource,\n    coverage_ratio: coverageRatio,\n  };\n}\n\nfunction extractAggregationPayload(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): HoldingsAggregationPayload | null {\n  if (!snapshot) {\n    return null;\n  }\n\n  const rawAggregation = snapshot.aggregation;\n  if (!rawAggregation || typeof rawAggregation !== 'object') {\n    return null;\n  }\n\n  const candidate = rawAggregation as Partial<HoldingsAggregationPayload> & {\n    purchase_value_cents?: unknown;\n  };\n\n  const totalHoldings = toFiniteNumber(candidate.total_holdings);\n  const positiveHoldings = toFiniteNumber(candidate.positive_holdings);\n  const purchaseValueEur = toFiniteNumber(candidate.purchase_value_eur);\n  const securityTotal =\n    toFiniteNumber(candidate.purchase_total_security) ??\n    toFiniteNumber(candidate.security_currency_total);\n  const accountTotal =\n    toFiniteNumber(candidate.purchase_total_account) ??\n    toFiniteNumber(candidate.account_currency_total);\n\n  const rawPurchaseValueCents = candidate.purchase_value_cents;\n  let purchaseValueCents = 0;\n  if (typeof rawPurchaseValueCents === 'number' && Number.isFinite(rawPurchaseValueCents)) {\n    purchaseValueCents = Math.trunc(rawPurchaseValueCents);\n  } else if (typeof rawPurchaseValueCents === 'string') {\n    const parsed = Number.parseInt(rawPurchaseValueCents, 10);\n    if (Number.isFinite(parsed)) {\n      purchaseValueCents = parsed;\n    }\n  }\n\n  const hasAnyValue =\n    totalHoldings != null ||\n    positiveHoldings != null ||\n    purchaseValueEur != null ||\n    securityTotal != null ||\n    accountTotal != null ||\n    purchaseValueCents !== 0;\n\n  if (!hasAnyValue) {\n    return null;\n  }\n\n  return {\n    total_holdings: totalHoldings ?? 0,\n    positive_holdings: positiveHoldings ?? 0,\n    purchase_value_cents: purchaseValueCents,\n    purchase_value_eur: purchaseValueEur ?? 0,\n    security_currency_total: securityTotal ?? 0,\n    account_currency_total: accountTotal ?? 0,\n    purchase_total_security: securityTotal ?? 0,\n    purchase_total_account: accountTotal ?? 0,\n  };\n}\n\nexport const __TEST_ONLY__ = {\n  getHistoryChartOptionsForTest: getHistoryChartOptions,\n  mergeHistoryWithSnapshotPriceForTest: (\n    historySeries: readonly NormalizedHistoryEntry[] | null | undefined,\n    snapshot: SecuritySnapshotDetail | null | undefined,\n  ): NormalizedHistoryEntry[] => buildHistorySeriesWithSnapshotPrice(historySeries, snapshot),\n  composeAveragePurchaseTooltipForTest: composeAveragePurchaseTooltip,\n  selectAveragePurchaseBaselineForTest: selectAveragePurchaseBaseline,\n  resolveAccountCurrencyCodeForTest: resolveAccountCurrencyCode,\n  resolvePurchaseFxTimestampForTest: resolvePurchaseFxTimestamp,\n  buildHeaderMetaForTest: buildHeaderMeta,\n};\n\nfunction buildCachedSnapshotNotice(params: {\n  fallbackUsed: boolean;\n  flaggedAsCache: boolean;\n}): string {\n  const { fallbackUsed, flaggedAsCache } = params;\n  const reasons: string[] = [];\n  if (fallbackUsed) {\n    reasons.push(\n      'Der aktuelle Snapshot konnte nicht geladen werden. Es werden die zuletzt gespeicherten Werte angezeigt.',\n    );\n  }\n  if (flaggedAsCache && !fallbackUsed) {\n    reasons.push(\n      'Der Snapshot ist vom Datenanbieter als Zwischenspeicherstand markiert.',\n    );\n  }\n\n  const reasonText = reasons.length\n    ? reasons.join(' ')\n    : 'Die Daten stammen aus dem Zwischenspeicher.';\n\n  return `\n    <div class=\"card warning-card stale-notice\" role=\"status\" aria-live=\"polite\">\n      <h2>Zwischengespeicherte Werte</h2>\n      <p>${reasonText}</p>\n      <p class=\"stale-notice__hint\">Die angezeigten Beträge können von den aktuellen Marktwerten abweichen. Laden Sie die Ansicht erneut, sobald eine Verbindung verfügbar ist.</p>\n    </div>\n  `;\n}\n\nfunction cacheSecuritySnapshotDetail(\n  securityUuid: string | null | undefined,\n  snapshot: SecuritySnapshotDetail | null,\n): void {\n  if (!securityUuid) {\n    return;\n  }\n\n  if (snapshot) {\n    SNAPSHOT_DETAIL_REGISTRY.set(securityUuid, snapshot);\n    return;\n  }\n\n  SNAPSHOT_DETAIL_REGISTRY.delete(securityUuid);\n}\n\nfunction getCachedSecuritySnapshot(\n  securityUuid: string | null | undefined,\n): SecuritySnapshotDetail | null {\n  if (!securityUuid || typeof window === 'undefined') {\n    return null;\n  }\n\n  if (SNAPSHOT_DETAIL_REGISTRY.has(securityUuid)) {\n    const cached = SNAPSHOT_DETAIL_REGISTRY.get(securityUuid) || null;\n    if (cached) {\n      return cached;\n    }\n  }\n\n  return null;\n}\n\nfunction ensureHistoryCache(securityUuid: string): SecurityHistoryCache {\n  if (!SECURITY_HISTORY_CACHE.has(securityUuid)) {\n    SECURITY_HISTORY_CACHE.set(securityUuid, new Map());\n  }\n  return SECURITY_HISTORY_CACHE.get(securityUuid) as SecurityHistoryCache;\n}\n\nfunction invalidateHistoryCache(securityUuid: string | null | undefined): void {\n  if (!securityUuid) {\n    return;\n  }\n\n  if (SECURITY_HISTORY_CACHE.has(securityUuid)) {\n    try {\n      const cache = SECURITY_HISTORY_CACHE.get(securityUuid);\n      if (cache) {\n        cache.clear();\n      }\n    } catch (error) {\n      console.warn('invalidateHistoryCache: Konnte Cache nicht leeren', securityUuid, error);\n    }\n    SECURITY_HISTORY_CACHE.delete(securityUuid);\n  }\n}\n\nfunction invalidateSnapshotCaches(securityUuid: string | null | undefined): void {\n  if (!securityUuid) {\n    return;\n  }\n\n  SNAPSHOT_DETAIL_REGISTRY.delete(securityUuid);\n}\n\nfunction handleLiveUpdateForSecurity(\n  securityUuid: string | null | undefined,\n  detail: PortfolioPositionsUpdatedEventDetail | null | undefined,\n): void {\n  if (!securityUuid || !detail) {\n    return;\n  }\n\n  const payload = detail.securityUuids;\n  const candidates = Array.isArray(payload) ? payload : [];\n\n  if (candidates.includes(securityUuid)) {\n    invalidateHistoryCache(securityUuid);\n    invalidateSnapshotCaches(securityUuid);\n  }\n}\n\nfunction ensureLiveUpdateSubscription(securityUuid: string | null | undefined): void {\n  if (!securityUuid || LIVE_UPDATE_HANDLERS.has(securityUuid)) {\n    return;\n  }\n\n  const handler: LiveUpdateHandler = (event) => {\n    if (!isPortfolioPositionsUpdatedEvent(event)) {\n      return;\n    }\n    handleLiveUpdateForSecurity(securityUuid, event.detail);\n  };\n\n  try {\n    window.addEventListener(LIVE_UPDATE_EVENT, handler as EventListener);\n    LIVE_UPDATE_HANDLERS.set(securityUuid, handler);\n  } catch (error) {\n    console.error('ensureLiveUpdateSubscription: Registrierung fehlgeschlagen', error);\n  }\n}\n\nfunction removeLiveUpdateSubscription(securityUuid: string): void {\n  if (!securityUuid || !LIVE_UPDATE_HANDLERS.has(securityUuid)) {\n    return;\n  }\n\n  const handler = LIVE_UPDATE_HANDLERS.get(securityUuid);\n  try {\n    if (handler) {\n      window.removeEventListener(LIVE_UPDATE_EVENT, handler as EventListener);\n    }\n  } catch (error) {\n    console.error('removeLiveUpdateSubscription: Entfernen des Listeners fehlgeschlagen', error);\n  }\n\n  LIVE_UPDATE_HANDLERS.delete(securityUuid);\n}\n\nfunction cleanupSecurityDetailState(securityUuid: string): void {\n  if (!securityUuid) {\n    return;\n  }\n\n  removeLiveUpdateSubscription(securityUuid);\n  invalidateHistoryCache(securityUuid);\n  invalidateSnapshotCaches(securityUuid);\n  // RANGE_STATE_REGISTRY intentionally left intact so the last chosen\n  // range remains active when the user reopens the security detail.\n}\n\nfunction setActiveRange(securityUuid: string, rangeKey: SecurityHistoryRangeKey): void {\n  if (!RANGE_STATE_REGISTRY.has(securityUuid)) {\n    RANGE_STATE_REGISTRY.set(securityUuid, { activeRange: rangeKey });\n    return;\n  }\n  const state = RANGE_STATE_REGISTRY.get(securityUuid);\n  if (state) {\n    state.activeRange = rangeKey;\n  }\n}\n\nfunction getActiveRange(securityUuid: string): SecurityHistoryRangeKey {\n  return (\n    RANGE_STATE_REGISTRY.get(securityUuid)?.activeRange ?? DEFAULT_HISTORY_RANGE\n  );\n}\n\nfunction toEpochDay(date: Date): number {\n  const epochMs = Date.UTC(\n    date.getUTCFullYear(),\n    date.getUTCMonth(),\n    date.getUTCDate(),\n  );\n  return Math.floor(epochMs / 86400000);\n}\n\nfunction normaliseDate(date: Date): Date {\n  const clone = new Date(date.getTime());\n  clone.setUTCHours(0, 0, 0, 0);\n  return clone;\n}\n\nfunction toFiniteNumber(value: unknown): number | null {\n  return toFiniteCurrency(value);\n}\n\nfunction toNonEmptyTrimmedString(value: unknown): string | null {\n  if (typeof value !== 'string') {\n    return null;\n  }\n\n  const trimmed = value.trim();\n  return trimmed ? trimmed : null;\n}\n\nfunction toUppercaseCode(value: unknown): string | null {\n  const normalized = toNonEmptyTrimmedString(value);\n  return normalized ? normalized.toUpperCase() : null;\n}\n\nfunction formatErrorLabel(error: unknown, fallback = 'Unbekannter Fehler'): string {\n  if (typeof error === 'string') {\n    const trimmed = error.trim();\n    return trimmed ? trimmed : fallback;\n  }\n\n  if (error instanceof Error) {\n    const trimmed = error.message.trim();\n    return trimmed ? trimmed : fallback;\n  }\n\n  if (error != null) {\n    try {\n      const serialized = JSON.stringify(error);\n      if (serialized && serialized !== '{}') {\n        return serialized;\n      }\n    } catch {\n      // Ignore serialization issues and fall through to fallback label.\n    }\n  }\n\n  return fallback;\n}\n\nfunction resolveRangeOptions(rangeKey: SecurityHistoryRangeKey): SecurityHistoryOptions {\n  const now = normaliseDate(new Date());\n  const rangeDays = RANGE_DAY_COUNTS[rangeKey];\n  const options: SecurityHistoryOptions = { end_date: toEpochDay(now) };\n\n  if (Number.isFinite(rangeDays) && rangeDays > 0) {\n    const start = new Date(now.getTime());\n    start.setUTCDate(start.getUTCDate() - (rangeDays - 1));\n    options.start_date = toEpochDay(start);\n  }\n\n  return options;\n}\n\nfunction parseHistoryDate(raw: unknown): Date | null {\n  if (!raw) {\n    return null;\n  }\n\n  if (raw instanceof Date && !Number.isNaN(raw.getTime())) {\n    return new Date(raw.getTime());\n  }\n\n  if (typeof raw === 'number' && Number.isFinite(raw)) {\n    const timestamp = raw * 86400000;\n    if (Number.isFinite(timestamp)) {\n      return new Date(timestamp);\n    }\n  }\n\n  if (typeof raw === 'string') {\n    const trimmed = raw.trim();\n    if (/^\\d{8}$/.test(trimmed)) {\n      const year = Number.parseInt(trimmed.slice(0, 4), 10);\n      const month = Number.parseInt(trimmed.slice(4, 6), 10) - 1;\n      const day = Number.parseInt(trimmed.slice(6, 8), 10);\n      if (\n        Number.isFinite(year) &&\n        Number.isFinite(month) &&\n        Number.isFinite(day)\n      ) {\n        const date = new Date(Date.UTC(year, month, day));\n        if (!Number.isNaN(date.getTime())) {\n          return date;\n        }\n      }\n    }\n\n    const parsed = Date.parse(trimmed);\n    if (Number.isFinite(parsed)) {\n      return new Date(parsed);\n    }\n  }\n\n  return null;\n}\n\nfunction parseTimestamp(value: unknown): number | null {\n  if (!value && value !== 0) {\n    return null;\n  }\n\n  if (value instanceof Date && !Number.isNaN(value.getTime())) {\n    return value.getTime();\n  }\n\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    if (value > 1e12) {\n      return value;\n    }\n\n    if (value > 1e9) {\n      return value * 1000;\n    }\n  }\n\n  if (typeof value === 'string') {\n    const trimmed = value.trim();\n    if (!trimmed) {\n      return null;\n    }\n\n    const parsed = Date.parse(trimmed);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return null;\n}\n\nfunction normaliseHistorySeries(prices: unknown): NormalizedHistoryEntry[] {\n  if (!Array.isArray(prices)) {\n    return [];\n  }\n\n  return (prices as RawHistoryEntry[])\n    .map((entry): NormalizedHistoryEntry | null => {\n      const normalizedClose = toFiniteNumber(entry.close);\n      let close = normalizedClose;\n      if (close == null) {\n        const rawClose = toFiniteNumber(entry.close_raw);\n        if (rawClose != null) {\n          close = rawClose / 1e8;\n        }\n      }\n\n      if (close == null) {\n        return null;\n      }\n\n      const dateValue = parseHistoryDate(entry.date);\n\n      return {\n        date: dateValue ?? (entry.date as Date | string | number),\n        close,\n      };\n    })\n    .filter((entry): entry is NormalizedHistoryEntry => Boolean(entry));\n}\n\nfunction extractSnapshotLastPriceNative(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): number | null {\n  const native =\n    toFiniteNumber(snapshot?.last_price_native) ??\n    toFiniteNumber(snapshot?.last_price?.native) ??\n    null;\n\n  if (isFiniteNumber(native)) {\n    return native;\n  }\n\n  const currency = toUppercaseCode(snapshot?.currency_code);\n  if (currency === 'EUR') {\n    const lastPriceEur = toFiniteNumber(snapshot?.last_price_eur);\n    if (isFiniteNumber(lastPriceEur)) {\n      return lastPriceEur;\n    }\n  }\n\n  return null;\n}\n\nfunction extractSnapshotLastPriceTimestamp(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): number | null {\n  if (!snapshot) {\n    return null;\n  }\n\n  const snapshotRecord = snapshot as { last_price_fetched_at?: unknown };\n  const fetchedAt = snapshotRecord.last_price_fetched_at;\n  const normalizedFetchedAt = parseTimestamp(fetchedAt);\n  if (normalizedFetchedAt != null) {\n    return normalizedFetchedAt;\n  }\n\n  const lastPriceRecord = snapshot.last_price as { fetched_at?: unknown } | null | undefined;\n  const lastPriceFetchedAt = lastPriceRecord?.fetched_at;\n  const normalizedLastPriceFetchedAt = parseTimestamp(lastPriceFetchedAt);\n  return normalizedLastPriceFetchedAt ?? null;\n}\n\nfunction buildHistorySeriesWithSnapshotPrice(\n  historySeries: readonly NormalizedHistoryEntry[] | null | undefined,\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): NormalizedHistoryEntry[] {\n  let baseSeries: NormalizedHistoryEntry[] = [];\n  if (Array.isArray(historySeries)) {\n    baseSeries = (historySeries as NormalizedHistoryEntry[]).map((entry) => ({\n      ...entry,\n    }));\n  }\n  const seriesWithSnapshot: NormalizedHistoryEntry[] = baseSeries.slice();\n\n  const lastPriceNative = extractSnapshotLastPriceNative(snapshot);\n  if (!isFiniteNumber(lastPriceNative)) {\n    return seriesWithSnapshot;\n  }\n\n  const lastPriceTimestamp = extractSnapshotLastPriceTimestamp(snapshot) ?? Date.now();\n  const candidateDate = new Date(lastPriceTimestamp);\n  if (Number.isNaN(candidateDate.getTime())) {\n    return seriesWithSnapshot;\n  }\n\n  const targetDay = toEpochDay(normaliseDate(candidateDate));\n  let latestSeriesDay: number | null = null;\n\n  for (let index = seriesWithSnapshot.length - 1; index >= 0; index -= 1) {\n    const entry = seriesWithSnapshot[index];\n    const parsedDate = parseHistoryDate(entry.date);\n    if (!parsedDate) {\n      continue;\n    }\n\n    const entryDay = toEpochDay(normaliseDate(parsedDate));\n    if (latestSeriesDay == null) {\n      latestSeriesDay = entryDay;\n    }\n\n    if (entryDay === targetDay) {\n      if (entry.close !== lastPriceNative) {\n        seriesWithSnapshot[index] = { ...entry, close: lastPriceNative };\n      }\n      return seriesWithSnapshot;\n    }\n\n    if (entryDay < targetDay) {\n      break;\n    }\n  }\n\n  if (latestSeriesDay != null && latestSeriesDay > targetDay) {\n    return seriesWithSnapshot;\n  }\n\n  seriesWithSnapshot.push({\n    date: candidateDate,\n    close: lastPriceNative,\n  });\n\n  return seriesWithSnapshot;\n}\n\nfunction isFiniteNumber(value: number | null | undefined): value is number {\n  return typeof value === 'number' && Number.isFinite(value);\n}\n\nfunction isPositiveFinite(value: number | null | undefined): value is number {\n  return typeof value === 'number' && Number.isFinite(value) && value > 0;\n}\n\nfunction areNumbersClose(\n  first: number | null | undefined,\n  second: number | null | undefined,\n  tolerance?: number,\n): boolean {\n  if (!isFiniteNumber(first) || !isFiniteNumber(second)) {\n    return false;\n  }\n\n  const absoluteDiff = Math.abs(first - second);\n  if (tolerance != null) {\n    return absoluteDiff <= tolerance;\n  }\n\n  const scale = Math.max(Math.abs(first), Math.abs(second), 1);\n  return absoluteDiff <= scale * 1e-4;\n}\n\nfunction computePercentageChange(\n  current: number | null,\n  reference: number | null,\n): number | null {\n  if (!isFiniteNumber(reference) || reference === 0 || !isFiniteNumber(current)) {\n    return null;\n  }\n\n  return normalizePercentValue(((current - reference) / reference) * 100);\n}\n\nfunction computePriceChangeMetrics(\n  historySeries: readonly NormalizedHistoryEntry[],\n  lastPriceNative: number | null,\n): { priceChange: number | null; priceChangePct: number | null } {\n  if (historySeries.length === 0) {\n    return { priceChange: null, priceChangePct: null };\n  }\n\n  const firstEntry = historySeries[0];\n  const baseline = toFiniteNumber(firstEntry.close);\n  if (!isFiniteNumber(baseline) || baseline === 0) {\n    return { priceChange: null, priceChangePct: null };\n  }\n\n  const lastEntry = historySeries[historySeries.length - 1];\n  const fallbackLast = toFiniteNumber(lastEntry.close);\n  const effectiveLast =\n    toFiniteNumber(lastPriceNative) ?? fallbackLast;\n\n  if (!isFiniteNumber(effectiveLast)) {\n    return { priceChange: null, priceChangePct: null };\n  }\n\n  const rawDelta = effectiveLast - baseline;\n  const priceChange = Object.is(rawDelta, -0) ? 0 : rawDelta;\n  const priceChangePct = computePercentageChange(effectiveLast, baseline);\n\n  return { priceChange, priceChangePct };\n}\n\nfunction resolveRoundedTrendClass(\n  value: number | null | undefined,\n  decimals: number,\n): 'positive' | 'negative' | 'neutral' {\n  if (!isFiniteNumber(value) || value === 0) {\n    return 'neutral';\n  }\n\n  const threshold = 0.5 / Math.pow(10, decimals);\n  if (Math.abs(value) < threshold) {\n    return 'neutral';\n  }\n\n  return value > 0 ? 'positive' : 'negative';\n}\n\nfunction formatPriceChangeValue(\n  value: number | null,\n  currency: string | null | undefined,\n): string {\n  if (!isFiniteNumber(value)) {\n    return '<span class=\"value neutral\">—</span>';\n  }\n\n  const formatted = formatPrice(value);\n  if (formatted === '—') {\n    return '<span class=\"value neutral\">—</span>';\n  }\n\n  const trendClass = resolveRoundedTrendClass(value, PRICE_FRACTION_DIGITS.max);\n  const suffix = currency ? `&nbsp;${currency}` : '';\n  return `<span class=\"value ${trendClass}\">${formatted}${suffix}</span>`;\n}\n\nfunction formatPercentageChangeValue(value: number | null): string {\n  if (!isFiniteNumber(value)) {\n    return '<span class=\"value neutral\">—</span>';\n  }\n\n  const trendClass = resolveRoundedTrendClass(value, 2);\n  return `<span class=\"value ${trendClass} value--percentage\">${formatNumber(value)}&nbsp;%</span>`;\n}\n\nfunction buildInfoBar(\n  rangeKey: SecurityHistoryRangeKey,\n  priceChange: number | null,\n  priceChangePct: number | null,\n  currency: string | null | undefined,\n): string {\n  const rangeLabel = rangeKey;\n  const rangeCaption = rangeLabel.length > 0 ? rangeLabel : 'Zeitraum';\n  return `\n    <div class=\"security-info-bar\" data-range=\"${rangeLabel}\">\n      <div class=\"security-info-item\">\n        <span class=\"label\">Preisänderung (${rangeCaption})</span>\n        <div class=\"value-row\">\n          ${formatPriceChangeValue(priceChange, currency)}\n          ${formatPercentageChangeValue(priceChangePct)}\n        </div>\n      </div>\n    </div>\n  `;\n}\n\nfunction buildRangeSelector(activeRange: SecurityHistoryRangeKey): string {\n  const buttons = AVAILABLE_HISTORY_RANGES.map((rangeKey) => {\n    const activeClass = rangeKey === activeRange ? ' active' : '';\n    return `\n      <button\n        type=\"button\"\n        class=\"security-range-button${activeClass}\"\n        data-range=\"${rangeKey}\"\n        aria-pressed=\"${rangeKey === activeRange ? 'true' : 'false'}\"\n      >\n        ${rangeKey}\n      </button>\n    `;\n  });\n\n  return `\n    <div class=\"security-range-selector\" role=\"group\" aria-label=\"Zeitraum\">\n      ${buttons.join('\\n')}\n    </div>\n  `;\n}\n\nfunction buildHistoryPlaceholder(\n  rangeKey: SecurityHistoryRangeKey,\n  state: HistoryPlaceholderState = { status: 'empty' },\n): string {\n  const safeRange = rangeKey;\n\n  switch (state.status) {\n    case 'loaded': {\n      const ariaSuffix = safeRange.length > 0 ? ` für ${safeRange}` : '';\n      return `\n        <div\n          class=\"history-chart\"\n          data-state=\"loaded\"\n          data-range=\"${safeRange}\"\n          role=\"img\"\n          aria-label=\"Preisverlauf${ariaSuffix}\"\n        ></div>\n      `;\n    }\n    case 'error': {\n      const message = formatErrorLabel(\n        state.message,\n        'Die historischen Daten konnten nicht geladen werden.',\n      );\n      return `\n        <div class=\"history-placeholder\" data-state=\"error\" data-range=\"${safeRange}\">\n          <p>${message}</p>\n        </div>\n      `;\n    }\n    case 'empty':\n    default: {\n      const rangeDescriptor = safeRange.length > 0 ? safeRange : 'den gewählten Zeitraum';\n      return `\n        <div class=\"history-placeholder\" data-state=\"empty\" data-range=\"${safeRange}\">\n          <p>Für dieses Wertpapier liegen im Zeitraum ${rangeDescriptor} keine historischen Daten vor.</p>\n        </div>\n      `;\n    }\n  }\n}\n\nfunction formatHoldings(value: unknown): string {\n  const numeric = toFiniteNumber(value);\n  if (numeric == null) {\n    return '—';\n  }\n\n  const hasFraction = Math.abs(numeric % 1) > 0;\n  const minFraction = hasFraction ? 2 : HOLDINGS_FRACTION_DIGITS.min;\n  const maxFraction = hasFraction ? HOLDINGS_FRACTION_DIGITS.max : HOLDINGS_FRACTION_DIGITS.min;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: minFraction,\n    maximumFractionDigits: maxFraction,\n  });\n}\n\nfunction formatPrice(value: unknown): string {\n  const numeric = toFiniteNumber(value);\n  if (numeric == null) {\n    return '—';\n  }\n\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: PRICE_FRACTION_DIGITS.min,\n    maximumFractionDigits: PRICE_FRACTION_DIGITS.max,\n  });\n}\n\nfunction formatPriceChangeWithCurrency(\n  value: number,\n  currency: string,\n): string {\n  const formatted = formatPrice(value);\n  const suffix = currency ? `&nbsp;${currency}` : '';\n  const className = resolveRoundedTrendClass(value, PRICE_FRACTION_DIGITS.max);\n  return `<span class=\"${className}\">${formatted}${suffix}</span>`;\n}\n\nfunction escapeAttribute(\n  value: string | number | boolean | null | undefined,\n): string {\n  if (value === null || value === undefined) {\n    return '';\n  }\n\n  const raw = typeof value === 'string' ? value : String(value);\n\n  return raw\n    .replace(/&/g, '&amp;')\n    .replace(/\"/g, '&quot;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;');\n}\n\nfunction resolveAccountCurrencyCode(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n  accountAverage: number | null | undefined,\n  securityAverage: number | null | undefined,\n): string | null {\n  const normalizedAverageCost = extractAverageCostPayload(snapshot);\n  const accountAverageNumeric =\n    normalizedAverageCost?.account ??\n    (isFiniteNumber(accountAverage) ? accountAverage : toFiniteNumber(accountAverage));\n\n  if (!isFiniteNumber(accountAverageNumeric)) {\n    return null;\n  }\n\n  const rawExplicit =\n    (snapshot as { account_currency_code?: unknown } | null | undefined)?.account_currency_code ??\n    (snapshot as { account_currency?: unknown } | null | undefined)?.account_currency;\n  if (typeof rawExplicit === 'string' && rawExplicit.trim()) {\n    return rawExplicit.trim().toUpperCase();\n  }\n\n  const securityCurrency = toUppercaseCode(snapshot?.currency_code) ?? '';\n  const securityAverageNumeric =\n    normalizedAverageCost?.security ??\n    normalizedAverageCost?.native ??\n    (isFiniteNumber(securityAverage) ? securityAverage : toFiniteNumber(securityAverage));\n\n  const aggregation = extractAggregationPayload(snapshot);\n  if (\n    securityCurrency &&\n    isFiniteNumber(securityAverageNumeric) &&\n    areNumbersClose(accountAverageNumeric, securityAverageNumeric)\n  ) {\n    return securityCurrency;\n  }\n\n  const securityTotal =\n    toFiniteNumber(aggregation?.purchase_total_security) ??\n    toFiniteNumber((snapshot as { purchase_total_security?: unknown } | null | undefined)?.purchase_total_security);\n  const accountTotal =\n    toFiniteNumber(aggregation?.purchase_total_account) ??\n    toFiniteNumber((snapshot as { purchase_total_account?: unknown } | null | undefined)?.purchase_total_account);\n  let ratio: number | null = null;\n  if (isFiniteNumber(securityTotal) && securityTotal !== 0 && isFiniteNumber(accountTotal)) {\n    ratio = accountTotal / securityTotal;\n  }\n\n  const averageSource = normalizedAverageCost?.source;\n  if (averageSource === 'eur_total') {\n    return 'EUR';\n  }\n\n  const averageEur = normalizedAverageCost?.eur;\n  if (isFiniteNumber(averageEur) && areNumbersClose(accountAverageNumeric, averageEur)) {\n    return 'EUR';\n  }\n\n  const purchaseValueEur = toFiniteNumber(snapshot?.purchase_value_eur);\n  if (isFiniteNumber(purchaseValueEur)) {\n    return 'EUR';\n  }\n\n  if (ratio != null && areNumbersClose(ratio, 1)) {\n    return securityCurrency || null;\n  }\n\n  if (securityCurrency === 'EUR') {\n    return 'EUR';\n  }\n\n  return securityCurrency || 'EUR';\n}\n\nfunction formatFxRate(value: number | null | undefined): string | null {\n  if (typeof value !== 'number' || !Number.isFinite(value) || value <= 0) {\n    return null;\n  }\n\n  return value.toLocaleString('de-DE', {\n    minimumFractionDigits: 4,\n    maximumFractionDigits: 4,\n  });\n}\n\nfunction resolvePurchaseFxTimestamp(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): number | null {\n  const snapshotRecord = snapshot as Record<string, unknown> | null | undefined;\n  const candidateKeys = [\n    'purchase_fx_date',\n    'purchase_fx_timestamp',\n    'purchase_fx_rate_date',\n    'purchase_fx_rate_timestamp',\n    'avg_price_updated_at',\n    'avg_price_timestamp',\n    'purchase_updated_at',\n    'purchase_updated',\n    'purchase_value_updated_at',\n    'purchase_value_updated',\n    'last_purchase_date',\n    'last_purchase_timestamp',\n    'last_transaction_date',\n    'last_transaction_at',\n  ] as const;\n\n  for (const key of candidateKeys) {\n    const value = snapshotRecord?.[key];\n    const parsed = parseTimestamp(value);\n    if (parsed != null) {\n      return parsed;\n    }\n  }\n\n  const fallbackCandidates: unknown[] = [];\n  if (snapshotRecord && 'last_price_fetched_at' in snapshotRecord) {\n    fallbackCandidates.push(snapshotRecord.last_price_fetched_at);\n  }\n  const lastPrice = (snapshot as { last_price?: { fetched_at?: unknown } | null } | null)?.last_price;\n  if (lastPrice && typeof lastPrice === 'object') {\n    fallbackCandidates.push(lastPrice.fetched_at);\n  }\n  if (snapshotRecord && 'last_price_date' in snapshotRecord) {\n    fallbackCandidates.push(snapshotRecord.last_price_date);\n  }\n\n  for (const candidate of fallbackCandidates) {\n    const parsed = parseTimestamp(candidate);\n    if (parsed != null) {\n      return parsed;\n    }\n  }\n\n  return null;\n}\n\nfunction formatFxDateLabel(timestamp: number | null): string | null {\n  if (timestamp == null || !Number.isFinite(timestamp)) {\n    return null;\n  }\n\n  const date = new Date(timestamp);\n  if (Number.isNaN(date.getTime())) {\n    return null;\n  }\n\n  return date.toLocaleDateString('de-DE', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric',\n  });\n}\n\nfunction composeAveragePurchaseTooltip(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n  accountCurrency: string | null | undefined,\n): string | null {\n  const securityCurrency = toUppercaseCode(snapshot?.currency_code) ?? '';\n  const accountCurrencySafe = toUppercaseCode(accountCurrency) ?? '';\n\n  if (!securityCurrency || !accountCurrencySafe || securityCurrency === accountCurrencySafe) {\n    return null;\n  }\n\n  const averageCost = extractAverageCostPayload(snapshot);\n  if (!averageCost) {\n    return null;\n  }\n\n  const securityAverage = averageCost.native ?? averageCost.security ?? null;\n  const accountAverage = averageCost.account ?? averageCost.eur ?? null;\n\n  if (!isPositiveFinite(securityAverage) || !isPositiveFinite(accountAverage)) {\n    return null;\n  }\n\n  const fxRate = accountAverage / securityAverage;\n  if (!Number.isFinite(fxRate) || fxRate <= 0) {\n    return null;\n  }\n\n  const formattedRate = formatFxRate(fxRate);\n  if (!formattedRate) {\n    return null;\n  }\n\n  let inverseRateLabel: string | null = null;\n  if (fxRate > 0) {\n    const inverse = 1 / fxRate;\n    if (Number.isFinite(inverse) && inverse > 0) {\n      inverseRateLabel = formatFxRate(inverse);\n    }\n  }\n\n  const timestamp = resolvePurchaseFxTimestamp(snapshot);\n  const dateLabel = formatFxDateLabel(timestamp);\n\n  const parts = [`FX-Kurs (Kauf): 1 ${securityCurrency} = ${formattedRate} ${accountCurrencySafe}`];\n  if (inverseRateLabel) {\n    parts.push(`1 ${accountCurrencySafe} = ${inverseRateLabel} ${securityCurrency}`);\n  }\n\n  const metadataParts: string[] = [];\n  const sourceKey = averageCost.source;\n  const sourceLabel =\n    sourceKey in AVERAGE_COST_SOURCE_LABELS\n      ? AVERAGE_COST_SOURCE_LABELS[sourceKey]\n      : AVERAGE_COST_SOURCE_LABELS.aggregation;\n  metadataParts.push(`Quelle: ${sourceLabel}`);\n\n  if (isFiniteNumber(averageCost.coverage_ratio)) {\n    const percentage = Math.min(Math.max(averageCost.coverage_ratio * 100, 0), 100);\n    metadataParts.push(\n      `Abdeckung: ${percentage.toLocaleString('de-DE', {\n        minimumFractionDigits: 1,\n        maximumFractionDigits: 1,\n      })}%`,\n    );\n  }\n\n  if (metadataParts.length) {\n    parts.push(...metadataParts);\n  }\n\n  const datePart = dateLabel ?? 'Datum unbekannt';\n  return `${parts.join(' · ')} (Stand: ${datePart})`;\n}\n\nfunction selectAveragePurchaseBaseline(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): number | null {\n  const averageCost = extractAverageCostPayload(snapshot);\n  const baseline = averageCost?.native ?? averageCost?.security ?? null;\n  return isFiniteNumber(baseline) ? baseline : null;\n}\n\nfunction buildHeaderMeta(snapshot: SecuritySnapshotDetail | null): string {\n  if (!snapshot) {\n    return '<div class=\"meta-error\">Keine Snapshot-Daten verfügbar.</div>';\n  }\n\n  const currency = snapshot.currency_code || 'EUR';\n  const holdingsSource = snapshot.total_holdings_precise ?? snapshot.total_holdings;\n  const holdings = formatHoldings(holdingsSource);\n  const lastPriceNativeRaw =\n    snapshot.last_price_native ?? snapshot.last_price?.native ?? snapshot.last_price_eur;\n  const formattedLastPrice = formatPrice(lastPriceNativeRaw);\n  const lastPriceDisplay =\n    formattedLastPrice === '—'\n      ? null\n      : `${formattedLastPrice}${currency ? `&nbsp;${currency}` : ''}`;\n  const marketValueRaw =\n    toFiniteNumber(snapshot.market_value_eur) ??\n    toFiniteNumber(snapshot.current_value_eur) ??\n    null;\n  const averageCost = extractAverageCostPayload(snapshot);\n  const averagePurchaseNativeRaw =\n    averageCost?.native ??\n    averageCost?.security ??\n    null;\n  const averagePurchaseEurRaw = averageCost?.eur ?? null;\n  const averagePurchaseAccountRaw = averageCost?.account ?? null;\n  const resolvedAccountAverage = averagePurchaseAccountRaw ?? averagePurchaseEurRaw;\n  const performancePayload = normalizePerformancePayload(snapshot.performance);\n  const dayChangePayload = performancePayload?.day_change ?? null;\n  const dayPriceChangeNative = dayChangePayload?.price_change_native ?? null;\n  const dayPriceChangeEur = dayChangePayload?.price_change_eur ?? null;\n  const dayChangeValue = isFiniteNumber(dayPriceChangeNative)\n    ? dayPriceChangeNative\n    : dayPriceChangeEur;\n  const dayChangeCurrency = isFiniteNumber(dayPriceChangeNative)\n    ? currency\n    : 'EUR';\n\n  const wrapValue = (content: string, extraClass = ''): string => {\n    const classes = ['value'];\n    if (extraClass) {\n      classes.push(...extraClass.split(' ').filter(Boolean));\n    }\n    return `<span class=\"${classes.join(' ')}\">${content}</span>`;\n  };\n\n  const wrapMissingValue = (extraClass = ''): string => {\n    const classes = ['value--missing'];\n    if (extraClass) {\n      classes.push(extraClass);\n    }\n    return wrapValue('—', classes.join(' '));\n  };\n\n  const renderGainValue = (\n    value: number | null | undefined,\n    extraClass = '',\n  ): string => {\n    if (!isFiniteNumber(value)) {\n      return wrapMissingValue(extraClass);\n    }\n\n    const classes = ['value--gain'];\n    if (extraClass) {\n      classes.push(extraClass);\n    }\n    return wrapValue(formatGain(value), classes.join(' '));\n  };\n\n  const renderGainPercentage = (\n    value: number | null | undefined,\n    extraClass = '',\n  ): string => {\n    if (!isFiniteNumber(value)) {\n      return wrapMissingValue(extraClass);\n    }\n\n    const classes = ['value--gain-percentage'];\n    if (extraClass) {\n      classes.push(extraClass);\n    }\n    return wrapValue(formatGainPct(value), classes.join(' '));\n  };\n\n  const lastPriceValue = lastPriceDisplay\n    ? wrapValue(lastPriceDisplay, 'value--price')\n    : wrapMissingValue('value--price');\n  const holdingsValue =\n    holdings === '—'\n      ? wrapMissingValue('value--holdings')\n      : wrapValue(holdings, 'value--holdings');\n  const marketValue = isFiniteNumber(marketValueRaw)\n    ? wrapValue(`${formatNumber(marketValueRaw)}&nbsp;€`, 'value--market-value')\n    : wrapMissingValue('value--market-value');\n  const dayChangeAbsolute = isFiniteNumber(dayChangeValue)\n    ? wrapValue(\n        formatPriceChangeWithCurrency(dayChangeValue, dayChangeCurrency),\n        'value--gain value--absolute',\n      )\n    : wrapMissingValue('value--absolute');\n  const dayChangePercentage = renderGainPercentage(\n    dayChangePayload?.change_pct,\n    'value--percentage',\n  );\n  const totalChangeAbsolute = renderGainValue(\n    performancePayload?.total_change_eur,\n    'value--absolute',\n  );\n  const totalChangePercentage = renderGainPercentage(\n    performancePayload?.total_change_pct,\n    'value--percentage',\n  );\n  const accountCurrency = resolveAccountCurrencyCode(\n    snapshot,\n    resolvedAccountAverage,\n    averagePurchaseNativeRaw,\n  );\n  const averagePurchaseTooltip = composeAveragePurchaseTooltip(\n    snapshot,\n    accountCurrency,\n  );\n  const averageValueGroupAttributes = averagePurchaseTooltip\n    ? ` title=\"${escapeAttribute(averagePurchaseTooltip)}\"`\n    : '';\n  const averagePurchaseValues: string[] = [];\n\n  if (isFiniteNumber(averagePurchaseNativeRaw)) {\n    averagePurchaseValues.push(\n      wrapValue(\n        `${formatPrice(averagePurchaseNativeRaw)}${\n          currency ? `&nbsp;${currency}` : ''\n        }`,\n        'value--average value--average-native',\n      ),\n    );\n  } else {\n    averagePurchaseValues.push(\n      wrapMissingValue('value--average value--average-native'),\n    );\n  }\n\n  const shouldRenderAccountValue =\n    isFiniteNumber(resolvedAccountAverage) &&\n    (!isFiniteNumber(averagePurchaseNativeRaw) ||\n      !accountCurrency ||\n      !currency ||\n      accountCurrency !== currency ||\n      !areNumbersClose(resolvedAccountAverage, averagePurchaseNativeRaw));\n\n  if (shouldRenderAccountValue && isFiniteNumber(resolvedAccountAverage)) {\n    averagePurchaseValues.push(\n      wrapValue(\n        `${formatPrice(resolvedAccountAverage)}${\n          accountCurrency ? `&nbsp;${accountCurrency}` : ''\n        }`,\n        'value--average value--average-eur',\n      ),\n    );\n  }\n\n  return `\n    <div class=\"security-meta-grid security-meta-grid--expanded\">\n      <div class=\"security-meta-item security-meta-item--price\">\n        <span class=\"label\">Letzter Preis</span>\n        <div class=\"value-group\">${lastPriceValue}</div>\n      </div>\n      <div class=\"security-meta-item security-meta-item--average\">\n        <span class=\"label\">Durchschnittlicher Kaufpreis</span>\n        <div class=\"value-group\"${averageValueGroupAttributes}>\n          ${averagePurchaseValues.join('')}\n        </div>\n      </div>\n      <div class=\"security-meta-item security-meta-item--day-change\">\n        <span class=\"label\">Tagesänderung</span>\n        <div class=\"value-group\">\n          ${dayChangeAbsolute}\n          ${dayChangePercentage}\n        </div>\n      </div>\n      <div class=\"security-meta-item security-meta-item--total-change\">\n        <span class=\"label\">Gesamtänderung</span>\n        <div class=\"value-group\">\n          ${totalChangeAbsolute}\n          ${totalChangePercentage}\n        </div>\n      </div>\n      <div class=\"security-meta-item security-meta-item--holdings\">\n        <span class=\"label\">Bestand</span>\n        <div class=\"value-group\">${holdingsValue}</div>\n      </div>\n      <div class=\"security-meta-item security-meta-item--market-value\">\n        <span class=\"label\">Marktwert (EUR)</span>\n        <div class=\"value-group\">${marketValue}</div>\n      </div>\n    </div>\n  `;\n}\n\nfunction normaliseHistoryError(error: unknown): string | null {\n  if (!error) {\n    return null;\n  }\n\n  if (typeof error === 'string') {\n    return error;\n  }\n\n  if (error instanceof Error) {\n    return error.message || null;\n  }\n\n  try {\n    const serialized = JSON.stringify(error);\n    return serialized && serialized !== '{}' ? serialized : null;\n  } catch (_jsonError) {\n    return null;\n  }\n}\n\nfunction getHistoryChartOptions(\n  host: HTMLElement,\n  series: readonly NormalizedHistoryEntry[],\n  {\n    currency,\n    baseline,\n  }: { currency?: string | null | undefined; baseline?: number | null | undefined } = {},\n): LineChartOptions {\n  const measuredWidth = host.clientWidth || host.offsetWidth || 0;\n  const width = measuredWidth > 0 ? measuredWidth : 640;\n  const height = Math.min(Math.max(Math.floor(width * 0.55), 220), 420);\n  const safeCurrency = (currency || '').toUpperCase() || 'EUR';\n  const baselineValue = isFiniteNumber(baseline) ? baseline : null;\n\n  return {\n    width,\n    height,\n    margin: { top: 16, right: 20, bottom: 32, left: 20 },\n    series,\n    yFormatter: (value) => formatPrice(value),\n    tooltipRenderer: ({ xFormatted, yFormatted }) => `\n      <div class=\"chart-tooltip-date\">${xFormatted}</div>\n      <div class=\"chart-tooltip-value\">${yFormatted}&nbsp;${safeCurrency}</div>\n    `,\n    baseline:\n      baselineValue != null\n        ? {\n            value: baselineValue,\n          }\n        : null,\n  };\n}\n\nconst HISTORY_CHART_INSTANCES = new WeakMap<\n  HTMLElement,\n  ReturnType<typeof renderLineChart>\n>();\n\nfunction renderHistoryChart(\n  host: HTMLElement,\n  series: readonly NormalizedHistoryEntry[],\n  options: {\n    currency?: string | null | undefined;\n    baseline?: number | null | undefined;\n  } = {},\n): void {\n  if (series.length === 0) {\n    return;\n  }\n\n  const chartOptions = getHistoryChartOptions(host, series, options);\n  let chartContainer = HISTORY_CHART_INSTANCES.get(host) ?? null;\n\n  if (!chartContainer || !host.contains(chartContainer)) {\n    host.innerHTML = '';\n    chartContainer = renderLineChart(host, chartOptions);\n    if (chartContainer) {\n      HISTORY_CHART_INSTANCES.set(host, chartContainer);\n    }\n    return;\n  }\n\n  updateLineChart(chartContainer, chartOptions);\n}\n\nfunction updateRangeButtons(\n  container: HTMLElement | null,\n  activeRange: SecurityHistoryRangeKey,\n): void {\n  if (!container) {\n    return;\n  }\n\n  container.dataset.activeRange = activeRange;\n  container.querySelectorAll<HTMLButtonElement>('.security-range-button').forEach((button) => {\n    const rangeKey = button.dataset.range as SecurityHistoryRangeKey | undefined;\n    const isActive = rangeKey === activeRange;\n    button.classList.toggle('active', isActive);\n    button.setAttribute('aria-pressed', isActive ? 'true' : 'false');\n    button.disabled = false;\n    button.classList.remove('loading');\n  });\n}\n\nfunction updateInfoBarContent(\n  root: HTMLElement,\n  rangeKey: SecurityHistoryRangeKey,\n  priceChange: number | null,\n  priceChangePct: number | null,\n  currency: string | null | undefined,\n): void {\n  const infoBar = root.querySelector('.security-info-bar');\n  if (!infoBar || !infoBar.parentElement) {\n    return;\n  }\n\n  const wrapper = document.createElement('div');\n  wrapper.innerHTML = buildInfoBar(rangeKey, priceChange, priceChangePct, currency).trim();\n  const fresh = wrapper.firstElementChild;\n  if (!fresh) {\n    return;\n  }\n  infoBar.parentElement.replaceChild(fresh, infoBar);\n}\n\nfunction updateHistoryPlaceholder(\n  root: HTMLElement,\n  rangeKey: SecurityHistoryRangeKey,\n  state: HistoryPlaceholderState,\n  historySeries: readonly NormalizedHistoryEntry[],\n  options: {\n    currency?: string | null | undefined;\n    baseline?: number | null | undefined;\n  } = {},\n): void {\n  const placeholderContainer = root.querySelector('.security-detail-placeholder');\n  if (!placeholderContainer) {\n    return;\n  }\n\n  placeholderContainer.innerHTML = `\n    <h2>Historie</h2>\n    ${buildHistoryPlaceholder(rangeKey, state)}\n  `;\n\n  if (state.status === 'loaded' && Array.isArray(historySeries) && historySeries.length) {\n    const host = placeholderContainer.querySelector<HTMLElement>('.history-chart');\n    if (host) {\n      requestAnimationFrame(() => {\n        renderHistoryChart(host, historySeries, options);\n      });\n    }\n  }\n}\n\ninterface ScheduleRangeSetupOptions {\n  root: HTMLElement;\n  hass: HomeAssistant | null | undefined;\n  panelConfig: PanelConfigLike | null | undefined;\n  securityUuid: string;\n  snapshot: SecuritySnapshotDetail | null;\n  initialRange: SecurityHistoryRangeKey;\n  initialHistory: NormalizedHistoryEntry[];\n  initialHistoryState: HistoryPlaceholderState;\n}\n\nfunction scheduleRangeSetup(options: ScheduleRangeSetupOptions): void {\n  const {\n    root,\n    hass,\n    panelConfig,\n    securityUuid,\n    snapshot,\n    initialRange,\n    initialHistory,\n    initialHistoryState,\n  } = options;\n\n  setTimeout(() => {\n    const rangeSelector = root.querySelector<HTMLElement>('.security-range-selector');\n    if (!rangeSelector) {\n      return;\n    }\n\n    const cache = ensureHistoryCache(securityUuid);\n    const initialBaseline = selectAveragePurchaseBaseline(snapshot);\n    const shouldCacheInitial =\n      Array.isArray(initialHistory) && initialHistoryState.status !== 'error';\n    if (shouldCacheInitial) {\n      cache.set(initialRange, initialHistory);\n    }\n\n    ensureLiveUpdateSubscription(securityUuid);\n\n    setActiveRange(securityUuid, initialRange);\n    updateRangeButtons(rangeSelector, initialRange);\n    const initialDisplayHistory = buildHistorySeriesWithSnapshotPrice(\n      initialHistory,\n      snapshot,\n    );\n    let effectiveInitialState: HistoryPlaceholderState = initialHistoryState;\n    if (effectiveInitialState.status !== 'error') {\n      effectiveInitialState = initialDisplayHistory.length\n        ? { status: 'loaded' }\n        : { status: 'empty' };\n    }\n    updateHistoryPlaceholder(\n      root,\n      initialRange,\n      effectiveInitialState,\n      initialDisplayHistory,\n      {\n        currency: snapshot?.currency_code,\n        baseline: initialBaseline,\n      },\n    );\n\n    const handleRangeClick = async (rangeKey: SecurityHistoryRangeKey): Promise<void> => {\n      if (rangeKey === getActiveRange(securityUuid)) {\n        return;\n      }\n\n      const button = rangeSelector.querySelector<HTMLButtonElement>(\n        `.security-range-button[data-range=\"${rangeKey}\"]`,\n      );\n      if (button) {\n        button.disabled = true;\n        button.classList.add('loading');\n      }\n\n      let historySeries = cache.get(rangeKey) ?? null;\n      let historyState: HistoryPlaceholderState | null = null;\n      let displayHistorySeries: NormalizedHistoryEntry[] = [];\n      if (!historySeries) {\n        try {\n          const rangeOptions = resolveRangeOptions(rangeKey);\n          const historyResponse = await fetchSecurityHistoryWS(\n            hass,\n            panelConfig,\n            securityUuid,\n            rangeOptions,\n          );\n            historySeries = normaliseHistorySeries(historyResponse.prices);\n          cache.set(rangeKey, historySeries);\n          historyState = historySeries.length\n            ? { status: 'loaded' }\n            : { status: 'empty' };\n        } catch (error) {\n          console.error('Range-Wechsel: Historie konnte nicht geladen werden', error);\n          historySeries = [];\n          const message = normaliseHistoryError(error);\n          historyState = {\n            status: 'error',\n            message:\n              message ||\n              'Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden.',\n          };\n        }\n      } else {\n        historyState = historySeries.length\n          ? { status: 'loaded' }\n          : { status: 'empty' };\n        }\n\n        displayHistorySeries = buildHistorySeriesWithSnapshotPrice(historySeries, snapshot);\n        if (historyState.status !== 'error') {\n          historyState = displayHistorySeries.length\n            ? { status: 'loaded' }\n            : { status: 'empty' };\n      }\n\n      const snapshotLastPriceNative =\n        extractSnapshotLastPriceNative(snapshot);\n      const { priceChange, priceChangePct } = computePriceChangeMetrics(\n        displayHistorySeries,\n        snapshotLastPriceNative,\n      );\n\n      setActiveRange(securityUuid, rangeKey);\n      updateRangeButtons(rangeSelector, rangeKey);\n      updateInfoBarContent(\n        root,\n        rangeKey,\n        priceChange,\n        priceChangePct,\n        snapshot?.currency_code,\n      );\n      const rangeBaseline = selectAveragePurchaseBaseline(snapshot);\n\n      updateHistoryPlaceholder(\n        root,\n        rangeKey,\n        historyState,\n        displayHistorySeries,\n        {\n          currency: snapshot?.currency_code,\n          baseline: rangeBaseline,\n        },\n      );\n    };\n\n    rangeSelector.addEventListener('click', (event) => {\n      const button = (event.target as HTMLElement | null)?.closest<HTMLButtonElement>('.security-range-button');\n      if (!button || button.disabled) {\n        return;\n      }\n      const { range } = button.dataset;\n      if (!range || !AVAILABLE_HISTORY_RANGES.includes(range as SecurityHistoryRangeKey)) {\n        return;\n      }\n        void handleRangeClick(range as SecurityHistoryRangeKey);\n    });\n  }, 0);\n}\n\nexport async function renderSecurityDetail(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  securityUuid: string | null | undefined,\n): Promise<string> {\n  if (!securityUuid) {\n    console.error('renderSecurityDetail: securityUuid fehlt');\n    return '<div class=\"card\"><h2>Fehler</h2><p>Kein Wertpapier angegeben.</p></div>';\n  }\n\n  const cachedSnapshot = getCachedSecuritySnapshot(securityUuid);\n  let snapshot: SecuritySnapshotDetail | null = null;\n  let error: string | null = null;\n\n  try {\n    const response: SecuritySnapshotResponse = await fetchSecuritySnapshotWS(\n      hass,\n      panelConfig,\n      securityUuid,\n    );\n    const snapshotPayload: unknown = response.snapshot;\n    snapshot =\n      snapshotPayload && typeof snapshotPayload === 'object'\n        ? (snapshotPayload as SecuritySnapshotDetail)\n        : (response as unknown as SecuritySnapshotDetail);\n  } catch (err) {\n    console.error('renderSecurityDetail: Snapshot konnte nicht geladen werden', err);\n    error = formatErrorLabel(err);\n  }\n\n  const effectiveSnapshot = snapshot || cachedSnapshot;\n  const fallbackUsed = Boolean(cachedSnapshot && !snapshot);\n  const flaggedAsCache = (effectiveSnapshot?.source ?? '') === 'cache';\n  if (securityUuid) {\n    cacheSecuritySnapshotDetail(securityUuid, effectiveSnapshot ?? null);\n  }\n  const staleNotice =\n    effectiveSnapshot && (fallbackUsed || flaggedAsCache)\n      ? buildCachedSnapshotNotice({ fallbackUsed, flaggedAsCache })\n      : '';\n  const headerTitle = effectiveSnapshot?.name || 'Wertpapierdetails';\n\n  if (error) {\n    const headerCard = createHeaderCard(\n      headerTitle,\n      buildHeaderMeta(effectiveSnapshot),\n    );\n    return `\n      ${headerCard.outerHTML}\n      ${staleNotice}\n      <div class=\"card error-card\">\n        <h2>Fehler beim Laden</h2>\n        <p>${error}</p>\n      </div>\n    `;\n  }\n\n  const activeRange = getActiveRange(securityUuid);\n  const cache = ensureHistoryCache(securityUuid);\n  let historySeries = cache.has(activeRange) ? cache.get(activeRange) ?? null : null;\n  let historyState: HistoryPlaceholderState = { status: 'empty' };\n\n  if (Array.isArray(historySeries)) {\n    historyState = historySeries.length\n      ? { status: 'loaded' }\n      : { status: 'empty' };\n  } else {\n    historySeries = [];\n    try {\n      const rangeOptions = resolveRangeOptions(activeRange);\n      const historyResponse: SecurityHistoryResponse = await fetchSecurityHistoryWS(\n        hass,\n        panelConfig,\n        securityUuid,\n        rangeOptions,\n      );\n        historySeries = normaliseHistorySeries(historyResponse.prices);\n      cache.set(activeRange, historySeries);\n      historyState = historySeries.length\n        ? { status: 'loaded' }\n        : { status: 'empty' };\n    } catch (historyError) {\n      console.error(\n        'renderSecurityDetail: Historie konnte nicht geladen werden',\n        historyError,\n      );\n      const message = normaliseHistoryError(historyError);\n      historyState = {\n        status: 'error',\n        message:\n          message ||\n          'Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden.',\n      };\n    }\n  }\n\n  const displayHistorySeries = buildHistorySeriesWithSnapshotPrice(\n    historySeries,\n    effectiveSnapshot,\n  );\n  if (historyState.status !== 'error') {\n    historyState = displayHistorySeries.length\n      ? { status: 'loaded' }\n      : { status: 'empty' };\n  }\n\n  const headerCard = createHeaderCard(\n    headerTitle,\n    buildHeaderMeta(effectiveSnapshot),\n  );\n\n  const snapshotLastPriceNative = extractSnapshotLastPriceNative(effectiveSnapshot);\n  const { priceChange, priceChangePct } = computePriceChangeMetrics(\n    displayHistorySeries,\n    snapshotLastPriceNative,\n  );\n  const infoBar = buildInfoBar(\n    activeRange,\n    priceChange,\n    priceChangePct,\n    effectiveSnapshot?.currency_code,\n  );\n\n  scheduleRangeSetup({\n    root,\n    hass,\n    panelConfig,\n    securityUuid,\n    snapshot: effectiveSnapshot,\n    initialRange: activeRange,\n    initialHistory: historySeries,\n    initialHistoryState: historyState,\n  });\n\n  return `\n    ${headerCard.outerHTML}\n    ${staleNotice}\n    ${infoBar}\n    ${buildRangeSelector(activeRange)}\n    <div class=\"card security-detail-placeholder\">\n      <h2>Historie</h2>\n      ${buildHistoryPlaceholder(activeRange, historyState)}\n    </div>\n  `;\n}\n\ninterface RegisterSecurityDetailTabOptions {\n  setSecurityDetailTabFactory?: ((\n    factory: (securityUuid: string) => {\n      title: string;\n      render: DashboardTabRenderFn;\n      cleanup: (context?: { key: string }) => void;\n    },\n  ) => void) | null;\n}\n\nexport function registerSecurityDetailTab(\n  options: RegisterSecurityDetailTabOptions,\n): void {\n  const { setSecurityDetailTabFactory } = options;\n  if (typeof setSecurityDetailTabFactory !== 'function') {\n    console.error('registerSecurityDetailTab: Ungültige Factory-Funktion übergeben');\n    return;\n  }\n\n    setSecurityDetailTabFactory((securityUuid) => ({\n      title: 'Wertpapier',\n      render: (root, hass, panelConfig) =>\n        renderSecurityDetail(root, hass, panelConfig, securityUuid),\n      cleanup: () => {\n        cleanupSecurityDetailState(securityUuid);\n      },\n    }));\n}\n","/**\n * Mirrors the legacy dashboard controller for initial TypeScript migration.\n */\n\nimport { addSwipeEvents as addSwipeEventsUnsafe } from './interaction/tab_control';\nimport { renderDashboard, attachPortfolioToggleHandler } from './tabs/overview';\nimport { registerSecurityDetailTab } from './tabs/security_detail';\nimport {\n  handleAccountUpdate,\n  handleLastFileUpdate,\n  handlePortfolioUpdate,\n  handlePortfolioPositionsUpdate,\n} from './data/updateConfigsWS';\nimport { getEntryId } from './data/api';\nimport {\n  getRegisteredDashboardElements,\n  getRegisteredPanelHosts,\n} from './dashboard/registry';\nimport type {\n  DashboardTabDescriptor,\n  PanelConfigLike,\n} from './tabs/types';\nimport type {\n  HassEvent,\n  HassPanel,\n  HassPanels,\n  HassRoute,\n  HassUnsubscribe,\n  HomeAssistant,\n} from './types/home-assistant';\n\ntype AddSwipeEvents = (\n  element: HTMLElement,\n  onSwipeLeft: () => void,\n  onSwipeRight: () => void,\n) => void;\n\nconst addSwipeEvents = addSwipeEventsUnsafe as AddSwipeEvents;\n\ntype PanelLike = PanelConfigLike | HassPanel | null | undefined;\n\ntype AccountsUpdatePayload = Parameters<typeof handleAccountUpdate>[0];\ntype LastFileUpdatePayload = Parameters<typeof handleLastFileUpdate>[0];\ntype PortfolioValuesUpdatePayload = Parameters<typeof handlePortfolioUpdate>[0];\ntype PortfolioPositionsUpdatePayload = Parameters<typeof handlePortfolioPositionsUpdate>[0];\n\ntype DashboardUpdateType =\n  | 'accounts'\n  | 'last_file_update'\n  | 'portfolio_values'\n  | 'portfolio_positions';\n\ntype DashboardUpdatePayloadMap = {\n  accounts: AccountsUpdatePayload;\n  last_file_update: LastFileUpdatePayload;\n  portfolio_values: PortfolioValuesUpdatePayload;\n  portfolio_positions: PortfolioPositionsUpdatePayload;\n};\n\ntype DashboardUpdateQueueEntry<T extends DashboardUpdateType = DashboardUpdateType> = {\n  type: T;\n  data: DashboardUpdatePayloadMap[T] | null | undefined;\n  portfolioUuid?: string | null;\n};\n\ninterface PanelsUpdatedEventData {\n  entry_id?: string | null;\n  data_type?: string | null;\n  data?: unknown;\n  [key: string]: unknown;\n}\n\ntype PanelsUpdatedEvent = HassEvent<PanelsUpdatedEventData>;\n\ninterface DashboardElement extends HTMLElement {\n  rememberScrollPosition?: (page?: number) => void;\n  _renderIfInitialized?: () => void;\n  _render?: () => void;\n  handleExternalRender?: (page: number) => void;\n}\n\nconst STICKY_HEADER_ANCHOR_ID = 'pp-reader-sticky-anchor';\nconst OVERVIEW_TAB_KEY = 'overview';\nconst SECURITY_DETAIL_TAB_PREFIX = 'security:';\n\ntype LegacyDashboardRegistry = {\n  __ppReaderDashboardElements?: unknown;\n  __ppReaderPanelHosts?: unknown;\n};\n\nfunction getLegacyRegistry(): LegacyDashboardRegistry | null {\n  if (typeof window === 'undefined') {\n    return null;\n  }\n  return window as Window & LegacyDashboardRegistry;\n}\n\nfunction* iterateLegacySet(value: unknown): Iterable<HTMLElement> {\n  if (value instanceof Set) {\n    for (const entry of value) {\n      if (entry instanceof HTMLElement) {\n        yield entry;\n      }\n    }\n  }\n}\n\nfunction* iterateLegacyDashboardElements(): Iterable<HTMLElement> {\n  const registry = getLegacyRegistry();\n  if (!registry) {\n    return;\n  }\n  yield* iterateLegacySet(registry.__ppReaderDashboardElements);\n}\n\nfunction* iterateLegacyPanelHosts(): Iterable<HTMLElement> {\n  const registry = getLegacyRegistry();\n  if (!registry) {\n    return;\n  }\n  yield* iterateLegacySet(registry.__ppReaderPanelHosts);\n}\n\nconst baseTabs: DashboardTabDescriptor[] = [\n  { key: OVERVIEW_TAB_KEY, title: 'Dashboard', render: renderDashboard },\n];\n\nconst detailTabRegistry = new Map<string, DashboardTabDescriptor>();\nconst detailTabOrder: string[] = [];\nconst securityTabLookup = new Map<string, string>();\n\nlet securityDetailTabFactory: DetailTabFactory | null = null;\nlet navigationInProgress = false;\nlet lastClosedSecurityUuid: string | null = null;\nlet currentPage = 0;\nlet observer: IntersectionObserver | null = null;\n\ntype DetailTabDescriptorInput = {\n  title: string;\n  render: DashboardTabDescriptor['render'];\n  cleanup?: DashboardTabDescriptor['cleanup'];\n  key?: string;\n  [key: string]: unknown;\n};\ntype DetailTabFactory = (securityUuid: string) => DetailTabDescriptorInput | null | undefined;\n\nfunction isRecord(value: unknown): value is Record<string, unknown> {\n  return typeof value === 'object' && value !== null;\n}\n\nfunction isPromiseLike<T>(value: unknown): value is PromiseLike<T> {\n  return (\n    typeof value === 'object' &&\n    value !== null &&\n    typeof (value as PromiseLike<T>).then === 'function'\n  );\n}\n\nfunction toErrorMessage(error: unknown): string {\n  if (typeof error === 'string') {\n    const trimmed = error.trim();\n    return trimmed.length > 0 ? trimmed : 'Unbekannter Fehler';\n  }\n  if (error instanceof Error) {\n    const trimmed = error.message.trim();\n    return trimmed.length > 0 ? trimmed : error.name;\n  }\n  if (error != null) {\n    try {\n      const serialized = JSON.stringify(error);\n      if (serialized && serialized !== '{}') {\n        return serialized;\n      }\n    } catch {\n      // Ignore serialization problems and fall back to String().\n    }\n  }\n  return String(error);\n}\n\nfunction isDashboardUpdateType(value: unknown): value is DashboardUpdateType {\n  return (\n    value === 'accounts' ||\n    value === 'last_file_update' ||\n    value === 'portfolio_values' ||\n    value === 'portfolio_positions'\n  );\n}\n\nfunction extractPortfolioUuidFromSingleUpdate(\n  update: Record<string, unknown>,\n): string | null {\n  const uuidCandidate = update['portfolio_uuid'];\n  if (typeof uuidCandidate === 'string' && uuidCandidate) {\n    return uuidCandidate;\n  }\n  const camelCaseCandidate = update['portfolioUuid'];\n  if (typeof camelCaseCandidate === 'string' && camelCaseCandidate) {\n    return camelCaseCandidate;\n  }\n  return null;\n}\n\nfunction extractPortfolioUuidFromPositionsUpdate(\n  update: PortfolioPositionsUpdatePayload | null | undefined,\n): string | null {\n  if (!update) {\n    return null;\n  }\n  if (Array.isArray(update)) {\n    for (const item of update) {\n      if (isRecord(item)) {\n        const uuid = extractPortfolioUuidFromSingleUpdate(item);\n        if (uuid) {\n          return uuid;\n        }\n      }\n    }\n    return null;\n  }\n  if (!isRecord(update)) {\n    return null;\n  }\n  return extractPortfolioUuidFromSingleUpdate(update);\n}\n\nfunction normalizeDashboardUpdate(\n  dataType: DashboardUpdateType,\n  data: unknown,\n): DashboardUpdateQueueEntry | null {\n  switch (dataType) {\n    case 'accounts':\n      return {\n        type: dataType,\n        data: Array.isArray(data) ? (data as AccountsUpdatePayload) : null,\n      };\n    case 'last_file_update':\n      if (typeof data === 'string') {\n        return { type: dataType, data: data as LastFileUpdatePayload };\n      }\n      if (isRecord(data)) {\n        return { type: dataType, data: data as LastFileUpdatePayload };\n      }\n      return { type: dataType, data: null };\n    case 'portfolio_values':\n      if (Array.isArray(data)) {\n        return { type: dataType, data: data as PortfolioValuesUpdatePayload };\n      }\n      return { type: dataType, data: null };\n    case 'portfolio_positions':\n      if (Array.isArray(data)) {\n        return { type: dataType, data: data as PortfolioPositionsUpdatePayload };\n      }\n      if (isRecord(data)) {\n        return { type: dataType, data: data as PortfolioPositionsUpdatePayload };\n      }\n      return { type: dataType, data: null };\n    default:\n      return null;\n  }\n}\n\nfunction extractSecurityUuidFromKey(key: string | null | undefined): string | null {\n  if (typeof key !== 'string' || !key.startsWith(SECURITY_DETAIL_TAB_PREFIX)) {\n    return null;\n  }\n\n  const uuid = key.slice(SECURITY_DETAIL_TAB_PREFIX.length);\n  return uuid || null;\n}\n\nfunction tryReopenLastDetail(): boolean {\n  if (!lastClosedSecurityUuid) {\n    return false;\n  }\n\n  const reopened = openSecurityDetail(lastClosedSecurityUuid);\n  if (!reopened) {\n    lastClosedSecurityUuid = null;\n  }\n  return reopened;\n}\n\nfunction getVisibleTabs(): DashboardTabDescriptor[] {\n  const detailTabs = detailTabOrder\n    .map((key) => detailTabRegistry.get(key))\n    .filter((descriptor): descriptor is DashboardTabDescriptor => Boolean(descriptor));\n\n  return [...baseTabs, ...detailTabs];\n}\n\nfunction getTabAtIndex(index: number): DashboardTabDescriptor | null {\n  const tabs = getVisibleTabs();\n  if (index < 0 || index >= tabs.length) {\n    return null;\n  }\n  return tabs[index];\n}\n\nfunction resolveDashboardPanel(panels: HassPanels | null | undefined): PanelLike {\n  if (!panels) {\n    return null;\n  }\n  const normalizedPanels = panels as Partial<Record<string, PanelLike>>;\n  const preferred = normalizedPanels.ppreader ?? normalizedPanels.pp_reader;\n  if (preferred) {\n    return preferred;\n  }\n  const fallback = Object.values(normalizedPanels).find((panelConfig) => {\n    if (!panelConfig || typeof panelConfig !== 'object') {\n      return false;\n    }\n    const name = (panelConfig as { webcomponent_name?: unknown }).webcomponent_name;\n    return name === 'pp-reader-panel';\n  });\n  return fallback ?? null;\n}\nfunction rememberCurrentPageScroll(): void {\n  try {\n    const dashboardElement = findDashboardElement();\n    if (dashboardElement && typeof dashboardElement.rememberScrollPosition === 'function') {\n      dashboardElement.rememberScrollPosition();\n    }\n  } catch (error) {\n    console.warn('rememberCurrentPageScroll: konnte Scroll-Position nicht sichern', error);\n  }\n}\n\nfunction clampPageIndex(index: number): number {\n  const tabs = getVisibleTabs();\n  if (!tabs.length) {\n    return 0;\n  }\n  if (index < 0) {\n    return 0;\n  }\n  if (index >= tabs.length) {\n    return tabs.length - 1;\n  }\n  return index;\n}\n\nasync function navigateToPage(\n  targetIndex: number,\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): Promise<void> {\n  const tabs = getVisibleTabs();\n  const clampedIndex = clampPageIndex(targetIndex);\n  if (clampedIndex === currentPage) {\n    if (targetIndex > currentPage) {\n      tryReopenLastDetail();\n    }\n    return;\n  }\n\n  rememberCurrentPageScroll();\n\n  const currentTab = currentPage >= 0 && currentPage < tabs.length ? tabs[currentPage] : null;\n  const currentSecurityUuid = currentTab\n    ? extractSecurityUuidFromKey(currentTab.key)\n    : null;\n  let nextIndex = clampedIndex;\n\n  if (currentSecurityUuid) {\n    const intendedTarget = clampedIndex >= 0 && clampedIndex < tabs.length ? tabs[clampedIndex] : null;\n    if (intendedTarget && intendedTarget.key === OVERVIEW_TAB_KEY) {\n      const closed = closeSecurityDetail(currentSecurityUuid, { suppressRender: true });\n      if (closed) {\n        const updatedTabs = getVisibleTabs();\n        const overviewIndex = updatedTabs.findIndex((tab) => tab.key === OVERVIEW_TAB_KEY);\n        nextIndex = overviewIndex >= 0 ? overviewIndex : 0;\n      }\n    }\n  }\n\n  if (navigationInProgress) {\n    return;\n  }\n\n  navigationInProgress = true;\n  try {\n    currentPage = clampPageIndex(nextIndex);\n    const renderedPage = currentPage;\n    await renderTab(root, hass, panel);\n    notifyExternalRender(renderedPage);\n  } catch (error) {\n    console.error('navigateToPage: Fehler beim Rendern des Tabs', error);\n  } finally {\n    navigationInProgress = false;\n  }\n}\n\nfunction navigateByDelta(\n  delta: number,\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): void {\n  void navigateToPage(currentPage + delta, root, hass, panel);\n}\n\nexport function registerDetailTab(\n  key: string,\n  descriptor: DetailTabDescriptorInput | null | undefined,\n): void {\n  if (!key || !descriptor || typeof descriptor.render !== 'function') {\n    console.error('registerDetailTab: Ungültiger Tab-Descriptor', key, descriptor);\n    return;\n  }\n\n  const securityUuid = extractSecurityUuidFromKey(key);\n  if (securityUuid) {\n    const existingKey = securityTabLookup.get(securityUuid);\n    if (existingKey && existingKey !== key) {\n      unregisterDetailTab(existingKey);\n    }\n  }\n\n  const normalizedDescriptor: DashboardTabDescriptor = {\n    ...descriptor,\n    key,\n  };\n\n  detailTabRegistry.set(key, normalizedDescriptor);\n\n  if (securityUuid) {\n    securityTabLookup.set(securityUuid, key);\n  }\n\n  if (!detailTabOrder.includes(key)) {\n    detailTabOrder.push(key);\n  }\n}\n\nexport function unregisterDetailTab(key: string | null | undefined): void {\n  if (!key) {\n    return;\n  }\n\n  const descriptor = detailTabRegistry.get(key);\n  if (descriptor && typeof descriptor.cleanup === 'function') {\n    try {\n      const cleanupResult = descriptor.cleanup({ key });\n      if (isPromiseLike<unknown>(cleanupResult)) {\n        cleanupResult.catch((cleanupError: unknown) => {\n          console.error(\n            'unregisterDetailTab: Fehler beim asynchronen cleanup',\n            cleanupError,\n          );\n        });\n      }\n    } catch (error: unknown) {\n      console.error('unregisterDetailTab: Fehler beim Ausführen von cleanup', error);\n    }\n  }\n\n  detailTabRegistry.delete(key);\n\n  const index = detailTabOrder.indexOf(key);\n  if (index >= 0) {\n    detailTabOrder.splice(index, 1);\n  }\n\n  const securityUuid = extractSecurityUuidFromKey(key);\n  if (securityUuid && securityTabLookup.get(securityUuid) === key) {\n    securityTabLookup.delete(securityUuid);\n  }\n}\n\nexport function hasDetailTab(key: string): boolean {\n  return detailTabRegistry.has(key);\n}\n\nexport function getDetailTabDescriptor(key: string): DashboardTabDescriptor | null {\n  return detailTabRegistry.get(key) ?? null;\n}\n\nexport function setSecurityDetailTabFactory(\n  factory: DetailTabFactory | null | undefined,\n): void {\n  if (factory != null && typeof factory !== 'function') {\n    console.error('setSecurityDetailTabFactory: Erwartet Funktion oder null', factory);\n    return;\n  }\n\n  securityDetailTabFactory = factory ?? null;\n}\n\nfunction getSecurityDetailTabKey(securityUuid: string): string {\n  return `${SECURITY_DETAIL_TAB_PREFIX}${securityUuid}`;\n}\n\nfunction findDashboardElement(): DashboardElement | null {\n  for (const element of getRegisteredDashboardElements()) {\n    if (element.isConnected) {\n      return element;\n    }\n  }\n\n  for (const legacyElement of iterateLegacyDashboardElements()) {\n    if (legacyElement.isConnected) {\n      return legacyElement as DashboardElement;\n    }\n  }\n\n  const hostCandidates = new Set<HTMLElement>();\n  for (const host of getRegisteredPanelHosts()) {\n    hostCandidates.add(host);\n  }\n  for (const legacyHost of iterateLegacyPanelHosts()) {\n    hostCandidates.add(legacyHost);\n  }\n\n  for (const host of hostCandidates) {\n    const nested = host.shadowRoot?.querySelector<DashboardElement>('pp-reader-dashboard');\n    if (nested) {\n      return nested;\n    }\n  }\n\n  return null;\n}\n\nfunction requestDashboardRender(): void {\n  const dashboardElement = findDashboardElement();\n  if (!dashboardElement) {\n    console.warn('requestDashboardRender: Kein pp-reader-dashboard Element gefunden');\n    return;\n  }\n\n  if (typeof dashboardElement._renderIfInitialized === 'function') {\n    dashboardElement._renderIfInitialized();\n    return;\n  }\n\n  if (typeof dashboardElement._render === 'function') {\n    dashboardElement._render();\n  }\n}\n\nfunction notifyExternalRender(page: number): void {\n  const dashboardElement = findDashboardElement();\n  if (!dashboardElement) {\n    return;\n  }\n\n  if (typeof dashboardElement.handleExternalRender === 'function') {\n    try {\n      dashboardElement.handleExternalRender(page);\n    } catch (error) {\n      console.warn('notifyExternalRender: Fehler beim Synchronisieren des Dashboards', error);\n    }\n  }\n}\n\nexport function openSecurityDetail(securityUuid: string | null | undefined): boolean {\n  if (!securityUuid) {\n    console.error('openSecurityDetail: Ungültige securityUuid', securityUuid);\n    return false;\n  }\n\n  const tabKey = getSecurityDetailTabKey(securityUuid);\n  let descriptor = getDetailTabDescriptor(tabKey);\n\n  if (!descriptor && typeof securityDetailTabFactory === 'function') {\n    try {\n      const maybeDescriptor = securityDetailTabFactory(securityUuid);\n      if (maybeDescriptor && typeof maybeDescriptor.render === 'function') {\n        registerDetailTab(tabKey, maybeDescriptor);\n        descriptor = getDetailTabDescriptor(tabKey);\n      } else {\n        console.error('openSecurityDetail: Factory lieferte ungültigen Descriptor', maybeDescriptor);\n      }\n    } catch (error) {\n      console.error('openSecurityDetail: Fehler beim Erzeugen des Tab-Descriptors', error);\n    }\n  }\n\n  if (!descriptor) {\n    console.warn(`openSecurityDetail: Kein Detail-Tab für ${securityUuid} verfügbar`);\n    return false;\n  }\n\n  rememberCurrentPageScroll();\n\n  const tabs = getVisibleTabs();\n  let targetIndex = tabs.findIndex((tab) => tab.key === tabKey);\n\n  if (targetIndex === -1) {\n    const updatedTabs = getVisibleTabs();\n    targetIndex = updatedTabs.findIndex((tab) => tab.key === tabKey);\n    if (targetIndex === -1) {\n      console.error('openSecurityDetail: Tab nach Registrierung nicht auffindbar');\n      return false;\n    }\n  }\n\n  currentPage = targetIndex;\n  lastClosedSecurityUuid = null;\n  requestDashboardRender();\n  return true;\n}\n\ninterface CloseSecurityDetailOptions {\n  suppressRender?: boolean;\n}\n\nexport function closeSecurityDetail(\n  securityUuid: string | null | undefined,\n  options: CloseSecurityDetailOptions = {},\n): boolean {\n  if (!securityUuid) {\n    console.error('closeSecurityDetail: Ungültige securityUuid', securityUuid);\n    return false;\n  }\n\n  const { suppressRender = false } = options;\n\n  const tabKey = getSecurityDetailTabKey(securityUuid);\n  if (!hasDetailTab(tabKey)) {\n    return false;\n  }\n\n  const tabsBefore = getVisibleTabs();\n  const tabIndexBefore = tabsBefore.findIndex((tab) => tab.key === tabKey);\n  const wasActive = tabIndexBefore === currentPage;\n\n  unregisterDetailTab(tabKey);\n\n  const tabsAfter = getVisibleTabs();\n  if (!tabsAfter.length) {\n    currentPage = 0;\n    if (!suppressRender) {\n      requestDashboardRender();\n    }\n    return true;\n  }\n\n  lastClosedSecurityUuid = securityUuid;\n\n  if (wasActive) {\n    const overviewIndex = tabsAfter.findIndex((tab) => tab.key === OVERVIEW_TAB_KEY);\n    if (overviewIndex >= 0) {\n      currentPage = overviewIndex;\n    } else {\n      currentPage = Math.min(Math.max(tabIndexBefore - 1, 0), tabsAfter.length - 1);\n    }\n  } else if (currentPage >= tabsAfter.length) {\n    currentPage = Math.max(0, tabsAfter.length - 1);\n  }\n\n  if (!suppressRender) {\n    requestDashboardRender();\n  }\n  return true;\n}\nasync function renderTab(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): Promise<void> {\n  let effectivePanel = panel;\n  if (!effectivePanel) {\n    effectivePanel = resolveDashboardPanel(hass ? hass.panels : null);\n  }\n\n  const tabs = getVisibleTabs();\n  if (currentPage >= tabs.length) {\n    currentPage = Math.max(0, tabs.length - 1);\n  }\n\n  const tab = getTabAtIndex(currentPage);\n  if (!tab) {\n    console.error('renderTab: Kein gültiger Tab oder keine render-Methode gefunden!');\n    return;\n  }\n\n  let content: string | undefined;\n  try {\n    content = await tab.render(root, hass, effectivePanel);\n  } catch (error: unknown) {\n    console.error('renderTab: Fehler beim Rendern des Tabs:', error);\n    root.innerHTML = `<div class=\"card\"><h2>Fehler</h2><pre>${toErrorMessage(error)}</pre></div>`;\n    return;\n  }\n\n  root.innerHTML = content ?? '';\n\n  if (tab.render === renderDashboard) {\n    attachPortfolioToggleHandler(root);\n  }\n\n  const waitForHeaderCard = (): Promise<HTMLElement> =>\n    new Promise((resolve) => {\n      const interval = window.setInterval(() => {\n        const headerCard = root.querySelector<HTMLElement>('.header-card');\n        if (headerCard) {\n          clearInterval(interval);\n          resolve(headerCard);\n        }\n      }, 50);\n    });\n\n  const headerCard = await waitForHeaderCard();\n\n  let anchor = root.querySelector<HTMLElement>(`#${STICKY_HEADER_ANCHOR_ID}`);\n  if (!anchor) {\n    anchor = document.createElement('div');\n    anchor.id = STICKY_HEADER_ANCHOR_ID;\n    const parent = headerCard.parentNode as (ParentNode & Node) | null;\n    if (parent && 'insertBefore' in parent) {\n      parent.insertBefore(anchor, headerCard);\n    }\n  }\n\n  setupNavigation(root, hass, panel);\n  setupSwipeOnHeaderCard(root, hass, panel);\n  setupHeaderScrollBehavior(root);\n}\n\nfunction setupHeaderScrollBehavior(root: HTMLElement): void {\n  const headerCard = root.querySelector<HTMLElement>('.header-card');\n  const anchor = root.querySelector<HTMLElement>(`#${STICKY_HEADER_ANCHOR_ID}`);\n\n  if (!headerCard || !anchor) {\n    console.error('Fehlende Elemente für das Scrollverhalten: headerCard oder anchor.');\n    return;\n  }\n\n  observer?.disconnect();\n\n  observer = new IntersectionObserver(\n    ([entry]) => {\n      if (!entry.isIntersecting) {\n        headerCard.classList.add('sticky');\n      } else {\n        headerCard.classList.remove('sticky');\n      }\n    },\n    {\n      root: null,\n      rootMargin: '0px 0px 0px 0px',\n      threshold: 0,\n    },\n  );\n\n  observer.observe(anchor);\n}\n\nfunction setupSwipeOnHeaderCard(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): void {\n  const headerCard = root.querySelector<HTMLElement>('.header-card');\n  if (!headerCard) {\n    console.error('Header-Card nicht gefunden!');\n    return;\n  }\n\n  addSwipeEvents(\n    headerCard,\n    () => {\n      navigateByDelta(1, root, hass, panel);\n    },\n    () => {\n      navigateByDelta(-1, root, hass, panel);\n    },\n  );\n}\n\nfunction setupNavigation(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): void {\n  const headerCard = root.querySelector<HTMLElement>('.header-card');\n  if (!headerCard) {\n    console.error('Header-Card nicht gefunden!');\n    return;\n  }\n\n  const navLeft = headerCard.querySelector<HTMLButtonElement>('#nav-left');\n  const navRight = headerCard.querySelector<HTMLButtonElement>('#nav-right');\n\n  if (!navLeft || !navRight) {\n    console.error('Navigationspfeile nicht gefunden!');\n    return;\n  }\n\n  navLeft.addEventListener('click', () => {\n    navigateByDelta(-1, root, hass, panel);\n  });\n\n  navRight.addEventListener('click', () => {\n    navigateByDelta(1, root, hass, panel);\n  });\n\n  updateNavigationState(headerCard);\n}\n\nfunction updateNavigationState(headerCard: HTMLElement): void {\n  const navLeft = headerCard.querySelector<HTMLButtonElement>('#nav-left');\n  const navRight = headerCard.querySelector<HTMLButtonElement>('#nav-right');\n\n  if (navLeft) {\n    if (currentPage === 0) {\n      navLeft.disabled = true;\n      navLeft.classList.add('disabled');\n    } else {\n      navLeft.disabled = false;\n      navLeft.classList.remove('disabled');\n    }\n  }\n\n  if (navRight) {\n    const tabs = getVisibleTabs();\n    const atEnd = currentPage === tabs.length - 1;\n    const shouldEnable = !atEnd || !!lastClosedSecurityUuid;\n    navRight.disabled = !shouldEnable;\n    navRight.classList.toggle('disabled', !shouldEnable);\n  }\n}\n\nclass PPReaderDashboard extends HTMLElement {\n  private _root: HTMLElement;\n\n  private _hass: HomeAssistant | null = null;\n\n  private _panel: PanelLike = null;\n\n  private _narrow: boolean | null = null;\n\n  private _route: HassRoute | null = null;\n\n  private _lastPanel: PanelLike = null;\n\n  private _lastNarrow: boolean | null = null;\n\n  private _lastRoute: HassRoute | null = null;\n\n  private _lastPage: number | null = null;\n\n  private _scrollPositions: Record<number, number> = {};\n\n  private _unsubscribeEvents: HassUnsubscribe | null = null;\n\n  private _initialized = false;\n\n  private _hasNewData = false;\n\n  private _pendingUpdates: DashboardUpdateQueueEntry[] = [];\n\n  private _entryIdWaitWarned = false;\n\n  constructor() {\n    super();\n    this._root = document.createElement('div');\n    this._root.className = 'pp-reader-dashboard';\n    this.appendChild(this._root);\n  }\n\n  set hass(hass: HomeAssistant | null | undefined) {\n    this._hass = hass ?? null;\n    this._checkInitialization();\n  }\n\n  set panel(panel: PanelLike) {\n    if (this._panel === panel) {\n      return;\n    }\n    this._panel = panel ?? null;\n    this._checkInitialization();\n  }\n\n  set narrow(narrow: boolean | null | undefined) {\n    if (this._narrow === (narrow ?? null)) {\n      return;\n    }\n    this._narrow = narrow ?? null;\n    this._renderIfInitialized();\n  }\n\n  set route(route: HassRoute | null | undefined) {\n    if (this._route === (route ?? null)) {\n      return;\n    }\n    this._route = route ?? null;\n    this._renderIfInitialized();\n  }\n\n  connectedCallback(): void {\n    this._checkInitialization();\n  }\n\n  disconnectedCallback(): void {\n    this._removeEventListeners();\n  }\n\n  public _checkInitialization(): void {\n    if (!this._hass || this._initialized) {\n      return;\n    }\n\n    if (!this._panel) {\n      this._panel = resolveDashboardPanel(this._hass.panels ?? null);\n    }\n\n    const entryId = getEntryId(this._hass, this._panel);\n    if (!entryId) {\n      if (!this._entryIdWaitWarned) {\n        console.warn('PPReaderDashboard: kein entry_id ermittelbar – warte auf Panel-Konfiguration.');\n        this._entryIdWaitWarned = true;\n      }\n      return;\n    }\n\n    this._entryIdWaitWarned = false;\n    console.debug('PPReaderDashboard: entry_id (fallback) =', entryId);\n    this._initialized = true;\n    this._initializeEventListeners();\n    this._render();\n  }\n\n  private _initializeEventListeners(): void {\n    this._removeEventListeners();\n\n    const conn = this._hass?.connection;\n    if (!conn || typeof conn.subscribeEvents !== 'function') {\n      console.error('PPReaderDashboard: keine valide WebSocket-Verbindung oder subscribeEvents fehlt');\n      return;\n    }\n\n    const eventTypes: readonly string[] = ['panels_updated'];\n\n    const subs: HassUnsubscribe[] = [];\n    const subscriptionPromise = Promise.all(\n      eventTypes.map(async (eventType) => {\n        try {\n          const unsubscribe = await conn.subscribeEvents(\n            this._handleBusEvent.bind(this),\n            eventType,\n          );\n          if (typeof unsubscribe === 'function') {\n            subs.push(unsubscribe);\n            console.debug('PPReaderDashboard: subscribed to', eventType);\n          } else {\n            console.error(\n              'PPReaderDashboard: subscribeEvents lieferte kein Unsubscribe-Func für',\n              eventType,\n              unsubscribe,\n            );\n          }\n        } catch (subscribeError: unknown) {\n          console.error('PPReaderDashboard: Fehler bei subscribeEvents für', eventType, subscribeError);\n        }\n      }),\n    );\n    subscriptionPromise\n      .then(() => {\n        this._unsubscribeEvents = () => {\n          subs.forEach((unsubscribe) => {\n            try {\n              unsubscribe();\n            } catch (error: unknown) {\n              // ignore cleanup errors\n            }\n          });\n          console.debug('PPReaderDashboard: alle Event-Subscriptions entfernt');\n        };\n      })\n      .catch((error: unknown) => {\n        console.error('PPReaderDashboard: Fehler beim Registrieren der Events', error);\n      });\n  }\n  private _removeEventListeners(): void {\n    if (typeof this._unsubscribeEvents === 'function') {\n      try {\n        this._unsubscribeEvents();\n      } catch (error: unknown) {\n        console.error('PPReaderDashboard: Fehler beim Entfernen der Event-Listener:', error);\n      }\n    }\n    this._unsubscribeEvents = null;\n  }\n\n  private _handleBusEvent(event: PanelsUpdatedEvent): void {\n    const currentEntryId = getEntryId(this._hass, this._panel);\n    if (!currentEntryId) {\n      return;\n    }\n\n    const eventData = event.data;\n    if (!isDashboardUpdateType(eventData.data_type)) {\n      return;\n    }\n\n    if (eventData.entry_id && eventData.entry_id !== currentEntryId) {\n      return;\n    }\n\n    const normalized = normalizeDashboardUpdate(eventData.data_type, eventData.data);\n    if (!normalized) {\n      return;\n    }\n\n    this._queueUpdate(normalized.type, normalized.data);\n    this._doRender(normalized.type, normalized.data);\n  }\n\n  private _doRender<T extends DashboardUpdateType>(\n    dataType: T,\n    pushedData: DashboardUpdatePayloadMap[T] | null | undefined,\n  ): void {\n    switch (dataType) {\n      case 'accounts':\n        handleAccountUpdate(\n          pushedData as DashboardUpdatePayloadMap['accounts'],\n          this._root,\n        );\n        break;\n      case 'last_file_update':\n        handleLastFileUpdate(\n          pushedData as DashboardUpdatePayloadMap['last_file_update'],\n          this._root,\n        );\n        break;\n      case 'portfolio_values':\n        handlePortfolioUpdate(\n          pushedData as DashboardUpdatePayloadMap['portfolio_values'],\n          this._root,\n        );\n        break;\n      case 'portfolio_positions':\n        handlePortfolioPositionsUpdate(\n          pushedData as DashboardUpdatePayloadMap['portfolio_positions'],\n          this._root,\n        );\n        break;\n      default:\n        console.warn('PPReaderDashboard: Unbekannter Datentyp:', dataType);\n        break;\n    }\n  }\n\n  private _queueUpdate<T extends DashboardUpdateType>(\n    dataType: T,\n    pushedData: DashboardUpdatePayloadMap[T] | null | undefined,\n  ): void {\n    const clonedData = this._cloneData(pushedData);\n    const entry: DashboardUpdateQueueEntry<T> = {\n      type: dataType,\n      data: clonedData,\n    };\n\n    if (dataType === 'portfolio_positions') {\n      entry.portfolioUuid = extractPortfolioUuidFromPositionsUpdate(\n        clonedData as DashboardUpdatePayloadMap['portfolio_positions'],\n      );\n    }\n\n    let index = -1;\n    if (dataType === 'portfolio_positions' && entry.portfolioUuid) {\n      index = this._pendingUpdates.findIndex(\n        (item) => item.type === dataType && item.portfolioUuid === entry.portfolioUuid,\n      );\n    } else {\n      index = this._pendingUpdates.findIndex((item) => item.type === dataType);\n    }\n\n    if (index >= 0) {\n      this._pendingUpdates[index] = entry;\n    } else {\n      this._pendingUpdates.push(entry);\n    }\n\n    this._hasNewData = true;\n  }\n\n  private _cloneData<T>(data: T): T {\n    if (data == null) {\n      return data;\n    }\n\n    try {\n      if (typeof structuredClone === 'function') {\n        return structuredClone(data);\n      }\n    } catch (error: unknown) {\n      console.warn('PPReaderDashboard: structuredClone fehlgeschlagen, falle auf JSON zurück', error);\n    }\n\n    try {\n      return JSON.parse(JSON.stringify(data)) as T;\n    } catch (error: unknown) {\n      console.warn('PPReaderDashboard: JSON-Clone fehlgeschlagen, referenziere Originaldaten', error);\n      return data;\n    }\n  }\n\n  private _reapplyPendingUpdates(): void {\n    if (!Array.isArray(this._pendingUpdates) || this._pendingUpdates.length === 0) {\n      return;\n    }\n\n    for (const item of this._pendingUpdates) {\n      try {\n        this._doRender(item.type, this._cloneData(item.data));\n      } catch (error: unknown) {\n        console.error('PPReaderDashboard: Fehler beim erneuten Anwenden eines Updates', item, error);\n      }\n    }\n  }\n\n  public _renderIfInitialized(): void {\n    if (this._initialized) {\n      this._render();\n    }\n  }\n\n  public handleExternalRender(page: number): void {\n    this._afterRender(page);\n  }\n\n  public rememberScrollPosition(page: number = currentPage): void {\n    const targetPage = Number.isInteger(page) ? page : currentPage;\n    this._scrollPositions[targetPage] = this._root.scrollTop || 0;\n  }\n\n  private _render(): void {\n    if (!this._hass) {\n      console.warn('pp-reader-dashboard: noch kein hass, überspringe _render()');\n      return;\n    }\n    if (!this._initialized) {\n      console.debug('pp-reader-dashboard: _render aufgerufen bevor initialisiert');\n      return;\n    }\n\n    const page = currentPage;\n    if (\n      !this._hasNewData &&\n      this._panel === this._lastPanel &&\n      this._narrow === this._lastNarrow &&\n      this._route === this._lastRoute &&\n      this._lastPage === page\n    ) {\n      return;\n    }\n\n    if (this._lastPage != null) {\n      this._scrollPositions[this._lastPage] = this._root.scrollTop;\n    }\n\n    const renderResult = renderTab(this._root, this._hass, this._panel);\n    if (isPromiseLike<unknown>(renderResult)) {\n      renderResult\n        .then(() => {\n          this._afterRender(page);\n        })\n        .catch((error: unknown) => {\n          console.error('PPReaderDashboard: Fehler beim Rendern des Tabs', error);\n          this._afterRender(page);\n        });\n      return;\n    }\n\n    this._afterRender(page);\n  }\n\n  private _afterRender(page: number): void {\n    const restore = this._scrollPositions[page] || 0;\n    this._root.scrollTop = restore;\n\n    this._lastPanel = this._panel;\n    this._lastNarrow = this._narrow;\n    this._lastRoute = this._route;\n    this._lastPage = page;\n\n    try {\n      this._reapplyPendingUpdates();\n    } catch (error) {\n      console.error('PPReaderDashboard: Fehler beim Wiederanlegen der Updates', error);\n    }\n\n    this._hasNewData = false;\n  }\n}\n\nif (!customElements.get('pp-reader-dashboard')) {\n  customElements.define('pp-reader-dashboard', PPReaderDashboard);\n}\n\nconsole.log('PPReader dashboard module v20250914b geladen');\n\nregisterSecurityDetailTab({\n  setSecurityDetailTabFactory,\n});\n"],"names":["triggerSwipe","direction","callback","error","addSwipeEvents","element","onSwipeLeft","onSwipeRight","startX","handleSwipe","deltaX","handleTouchStart","event","handleTouchEnd","touch","handleMouseDown","handleMouseUp","resolveRoundedTrend","numericValue","decimals","threshold","formatValue","key","value","row","context","formatted","toNumber","v","cleaned","parsed","safeNumber","minFrac","maxFrac","num","renderMissingValue","reason","title","performance","metric","missingReason","numeric","symbol","hasFraction","base","makeTable","rows","cols","sumColumns","options","sortable","defaultSort","defaultSortKey","defaultSortDir","escapeAttribute","html","c","alignClass","r","sums","sumMeta","aggregation","acc","candidate","numericCandidate","gainAbsSum","purchaseSum","currentValueSum","aggregatedGainPct","aggregatedGainPctLabel","aggregatedGainPctSign","formatNumber","idx","extraAttributes","fallbackContext","tpl","table","e","createHeaderCard","headerTitle","meta","headerCard","formatGain","formatGainPct","sortTableRows","tableEl","dir","isPositions","tbody","footer","colIdx","mappedIdx","ths","i","txt","a","b","aCell","bCell","aTxt","bTxt","aNum","bNum","cmp","hasNumericContext","th","activeTh","deriveEntryId","hass","panelConfig","_a","_b","_c","_d","_e","_f","_g","_h","entryId","panels","panel","getEntryId","fetchAccountsWS","fetchLastFileUpdateWS","response","lastFileUpdate","fetchPortfoliosWS","fetchPortfolioPositionsWS","portfolioUuid","fetchSecuritySnapshotWS","securityUuid","fetchSecurityHistoryWS","payload","startDate","endDate","startDateRaw","endDateRaw","resolvedStart","resolvedEnd","dashboardElements","panelHosts","overviewHelpers","OVERVIEW_HELPER_KEYS","setOverviewHelper","helper","getRegisteredDashboardElements","getRegisteredPanelHosts","registerOverviewHelpers","helpers","getOverviewHelpers","DEFAULT_DECIMALS","toFiniteCurrency","trimmed","direct","stripped","lastComma","lastDot","normalized","hasComma","hasDot","commaGroups","decimalDigits","integerPart","integerDigits","multipleCommas","integerIsZero","localized","relaxed","roundCurrency","fallback","factor","rounded","normalizeCurrencyValue","normalizePercentValue","NUMERIC_STRING_PATTERN","toFiniteNumber","toOptionalString","normalizeDayChangePayload","raw","priceChangeNative","priceChangeEur","changePct","source","coverage","normalizePerformancePayload","gainAbs","gainPct","totalChangeEur","totalChangePct","dayChange","portfolioPositionsCache","clonePosition","position","setPortfolioPositions","positions","normalised","hasPortfolioPositions","getPortfolioPositions","entries","pendingPortfolioUpdates","pendingRetryMetaMap","formatErrorMessage","serialized","toNonEmptyString","normalizePerformanceMetrics","cloneAggregationPayload","cloneAverageCostPayload","sanitizePosition","name","currentHoldings","purchaseValue","currentValue","averageCost","sanitizePositions","sanitized","PENDING_RETRY_INTERVAL","PENDING_MAX_ATTEMPTS","PORTFOLIO_POSITIONS_UPDATED_EVENT","renderPositionsError","restoreSortAndInit","containerEl","rootEl","pid","attachPortfolioPositionsSorting","attachSecurityDetailListener","applyPortfolioPositionsToDom","root","detailsRow","container","prevKey","prevDir","renderPositionsTableInline","flushPendingPositions","pending","result","flushAllPendingPositions","appliedAny","schedulePendingRetry","success","handleAccountUpdate","update","updatedAccounts","updateAccountTable","portfolioTable","portfolios","currentValueCell","textContent","updateTotalWealth","accounts","eurContainer","fxContainer","eurAccounts","account","fxAccounts","origBalance","hasOrigBalance","currencyCode","amountLabel","fxDisplay","handlePortfolioUpdate","formatNumberLocal","val","locale","rowMap","portfolio","patched","formatPositionCount","entry","uuid","posCountCell","curValCell","gainAbsCell","gainPctCell","posCount","curVal","entryRecord","purchaseRaw","purchase","oldCur","parseNumLoose","hasValue","rowData","rowContext","currentMarkup","gainMarkup","pctValue","patchedLabel","updatePortfolioFooter","findTable","selectors","selector","eurTable","fxTable","extractAccounts","tbl","isFx","accountRows","cell","portfolioDomValues","currentValueRaw","purchaseSumRaw","normalizePortfolioUuid","camelCase","processPortfolioPositionsUpdate","pos","normalizedPositions","securityUuids","dispatchError","handlePortfolioPositionsUpdate","handled","item","renderPositionsTable","applyGainPctMetadata","colKeys","tr","gainPctMetadata","err","gainCell","gainPctValue","pctLabel","pctSign","parseDatasetNumber","metrics","positionCount","totalsComplete","sumGainPct","sumPositionsDisplay","footerRowData","footerContext","gainAbsValue","gainAbsCellMarkup","gainPctCellMarkup","footerGainAbsCell","targetRoot","accountSum","portfolioSum","totalWealth","headerMeta","valueElement","handleLastFileUpdate","resolvedUpdate","el","metaHost","PORTFOLIO_SORT_KEYS","isPortfolioPositionsSortKey","isPortfolioSortDirection","_hassRef","_panelConfigRef","PRICE_FRACTION_DIGITS","toNullableNumber","isFiniteNumber","normalizeCurrencyCode","upper","resolveCurrencyFromPosition","keys","record","isRecord","hasAverageCostShape","toAverageCostPayload","hasHoldingsAggregationShape","toHoldingsAggregationPayload","formatPriceWithCurrency","currency","buildPurchasePriceDisplay","securityCurrency","accountCurrency","averageNative","averageSecurity","averageAccount","averageEur","effectiveSecurity","effectiveAccount","primaryValue","primaryCurrency","primaryText","formattedAccount","shouldRenderAccount","parts","ariaParts","markup","sortValue","ariaLabel","expandedPortfolios","pctText","sanitizedPositions","p","col","purchaseCell","renderPortfolioPositions","attachSecurityDetailDelegation","target","interactive","openSecurityDetail","buildExpandablePortfolioTable","depots","align","d","partialValue","expanded","toggleClass","detailId","valueContext","gainPctLabel","gainPctSign","datasetCurrentValue","datasetGainAbs","datasetGainPct","positionCountAttr","gainAbsAttributes","positionCountDisplay","availableDepots","sumPositions","sumCurrent","sumPurchase","sumGainAbs","current","sumHasValue","sumIsPartial","sumRowData","sumContext","sumCurrentCell","sumGainAbsCell","sumGainPctCell","sumGainAbsAttributes","sumGainPctLabel","sumGainPctSign","sumPositionAttr","sumCurrentAttr","sumPurchaseAttr","sumGainAbsAttr","sumGainPctAttr","resolvePortfolioTable","scoped","nested","generic","readDatasetNumber","updatePortfolioFooterFromDom","hasValueRow","allRowsComplete","fxUnavailable","hasValueAttr","child","currentValueHtml","gainAbsHtml","gainPctHtml","applySort","parseNum","aCellEl","bCellEl","resolveSortValue","text","sortAttr","numericAttr","comp","aValue","bValue","containerKey","containerDir","defaultKey","defaultDir","currentKey","currentDir","keyAttr","reloadPortfolioPositions","targetContainer","resp","errorText","message","waitForElement","timeoutMs","intervalMs","start","resolve","tick","attachPortfolioToggleHandler","token","retryBtn","cont","btn","caretEl","ensurePortfolioRowFallbackListener","primaryContainer","renderDashboard","normalizedAccounts","missingPositions","rawCurrentValue","hasNumericCurrentValue","depot","totalAccounts","sum","anyPortfolioMissing","anyAccountMissing","totalDepots","missingWealthReason","wealthValueMarkup","wealthNote","portfolioTableHtml","fxWarning","accountsHtml","footerCard","schedulePostRenderSetup","run","wrapper","tableHost","footerErr","pendingErr","schedule","cb","SVG_NS","DEFAULT_WIDTH","DEFAULT_HEIGHT","DEFAULT_MARGIN","DEFAULT_COLOR","DEFAULT_AREA","DEFAULT_TICK_FONT","DEFAULT_BASELINE_COLOR","DEFAULT_BASELINE_DASH","ONE_DAY_MS","toAttributeValue","timestamp","safeText","px","createSvgElement","tag","attrs","attributeValue","toTimestamp","fallbackIndex","defaultXAccessor","defaultYAccessor","defaultXFormatter","dataPoint","_index","date","defaultYFormatter","_dataPoint","defaultTooltipRenderer","xFormatted","yFormatted","ensureChartState","clamp","min","max","buildAreaPath","points","baselineY","segments","point","index","command","x","y","firstPoint","closing","buildLinePath","applyBaselineAppearance","state","baselineLine","baseline","stroke","dashArray","updateBaselineLine","range","margin","width","baselineValue","minY","maxY","boundedHeight","safeMinY","denominator","ratio","clampedRatio","effectiveHeight","effectiveWidth","x1","x2","computePoints","series","dimensions","accessors","height","xAccessor","yAccessor","rawPoints","rawX","rawY","xValue","yValue","minX","maxX","boundedWidth","safeMinX","safeMaxX","safeMaxY","minDomainCandidate","maxDomainCandidate","desiredYTicks","domainMinY","domainMaxY","computeNiceDomain","effectiveMinY","effectiveMaxY","rangeX","rangeY","ratioX","ratioY","assignDimensions","formatTooltip","updateTooltipPosition","pointerY","tooltip","tooltipWidth","tooltipHeight","horizontal","maxVertical","padding","anchorY","vertical","translateX","translateY","hideTooltip","focusLine","focusCircle","attachPointerHandlers","handlePointerMove","rect","pointerX","closest","minDistance","distance","handlePointerLeave","renderLineChart","svg","areaPath","linePath","overlay","xAxis","yAxis","updateLineChart","updateAxes","lineD","areaD","yFormatter","hasValidX","hasValidY","rangeDays","desiredTicks","generateTimeAxisTicks","positionRatio","label","textAlign","yAxisWidth","yTicks","generateNumericAxisTicks","applyFormatter","top","minValue","maxValue","safeTicks","niceStep","rawStep","step","niceMin","niceMax","minTimestamp","maxTimestamp","formatXAxisLabel","tickCount","ticks","end","_","exponent","fraction","niceFraction","isStringArray","isPortfolioPositionsUpdatedEventDetail","isPortfolioPositionsUpdatedEvent","HOLDINGS_FRACTION_DIGITS","DEFAULT_HISTORY_RANGE","AVAILABLE_HISTORY_RANGES","RANGE_DAY_COUNTS","AVERAGE_COST_SOURCE_LABELS","SECURITY_HISTORY_CACHE","RANGE_STATE_REGISTRY","SNAPSHOT_DETAIL_REGISTRY","LIVE_UPDATE_EVENT","LIVE_UPDATE_HANDLERS","extractAverageCostPayload","snapshot","rawAverageCost","native","security","eur","coverageRatio","extractAggregationPayload","rawAggregation","totalHoldings","positiveHoldings","purchaseValueEur","securityTotal","accountTotal","rawPurchaseValueCents","purchaseValueCents","buildCachedSnapshotNotice","params","fallbackUsed","flaggedAsCache","reasons","cacheSecuritySnapshotDetail","getCachedSecuritySnapshot","cached","ensureHistoryCache","invalidateHistoryCache","cache","invalidateSnapshotCaches","handleLiveUpdateForSecurity","detail","ensureLiveUpdateSubscription","handler","removeLiveUpdateSubscription","cleanupSecurityDetailState","setActiveRange","rangeKey","getActiveRange","toEpochDay","epochMs","normaliseDate","clone","toNonEmptyTrimmedString","toUppercaseCode","formatErrorLabel","resolveRangeOptions","now","parseHistoryDate","year","month","day","parseTimestamp","normaliseHistorySeries","prices","close","rawClose","extractSnapshotLastPriceNative","lastPriceEur","extractSnapshotLastPriceTimestamp","fetchedAt","normalizedFetchedAt","lastPriceRecord","lastPriceFetchedAt","buildHistorySeriesWithSnapshotPrice","historySeries","baseSeries","seriesWithSnapshot","lastPriceNative","lastPriceTimestamp","candidateDate","targetDay","latestSeriesDay","parsedDate","entryDay","isPositiveFinite","areNumbersClose","first","second","tolerance","absoluteDiff","scale","computePercentageChange","reference","computePriceChangeMetrics","firstEntry","lastEntry","fallbackLast","effectiveLast","rawDelta","priceChange","priceChangePct","resolveRoundedTrendClass","formatPriceChangeValue","formatPrice","trendClass","suffix","formatPercentageChangeValue","buildInfoBar","rangeLabel","rangeCaption","buildRangeSelector","activeRange","buildHistoryPlaceholder","safeRange","ariaSuffix","rangeDescriptor","formatHoldings","minFraction","maxFraction","formatPriceChangeWithCurrency","resolveAccountCurrencyCode","accountAverage","securityAverage","normalizedAverageCost","accountAverageNumeric","rawExplicit","securityAverageNumeric","formatFxRate","resolvePurchaseFxTimestamp","snapshotRecord","candidateKeys","fallbackCandidates","lastPrice","formatFxDateLabel","composeAveragePurchaseTooltip","accountCurrencySafe","fxRate","formattedRate","inverseRateLabel","inverse","dateLabel","metadataParts","sourceKey","sourceLabel","percentage","datePart","selectAveragePurchaseBaseline","buildHeaderMeta","holdingsSource","holdings","lastPriceNativeRaw","formattedLastPrice","lastPriceDisplay","marketValueRaw","averagePurchaseNativeRaw","averagePurchaseEurRaw","resolvedAccountAverage","performancePayload","dayChangePayload","dayPriceChangeNative","dayPriceChangeEur","dayChangeValue","dayChangeCurrency","wrapValue","content","extraClass","classes","wrapMissingValue","renderGainValue","renderGainPercentage","lastPriceValue","holdingsValue","marketValue","dayChangeAbsolute","dayChangePercentage","totalChangeAbsolute","totalChangePercentage","averagePurchaseTooltip","averageValueGroupAttributes","averagePurchaseValues","normaliseHistoryError","getHistoryChartOptions","host","measuredWidth","safeCurrency","HISTORY_CHART_INSTANCES","renderHistoryChart","chartOptions","chartContainer","updateRangeButtons","button","isActive","updateInfoBarContent","infoBar","fresh","updateHistoryPlaceholder","placeholderContainer","scheduleRangeSetup","initialRange","initialHistory","initialHistoryState","rangeSelector","initialBaseline","initialDisplayHistory","effectiveInitialState","handleRangeClick","historyState","displayHistorySeries","rangeOptions","historyResponse","snapshotLastPriceNative","rangeBaseline","renderSecurityDetail","cachedSnapshot","snapshotPayload","effectiveSnapshot","staleNotice","historyError","registerSecurityDetailTab","setSecurityDetailTabFactory","addSwipeEventsUnsafe","STICKY_HEADER_ANCHOR_ID","OVERVIEW_TAB_KEY","SECURITY_DETAIL_TAB_PREFIX","getLegacyRegistry","iterateLegacySet","iterateLegacyDashboardElements","registry","iterateLegacyPanelHosts","baseTabs","detailTabRegistry","detailTabOrder","securityTabLookup","securityDetailTabFactory","navigationInProgress","lastClosedSecurityUuid","currentPage","observer","isPromiseLike","toErrorMessage","isDashboardUpdateType","extractPortfolioUuidFromSingleUpdate","uuidCandidate","camelCaseCandidate","extractPortfolioUuidFromPositionsUpdate","normalizeDashboardUpdate","dataType","data","extractSecurityUuidFromKey","tryReopenLastDetail","reopened","getVisibleTabs","detailTabs","descriptor","getTabAtIndex","tabs","resolveDashboardPanel","normalizedPanels","preferred","rememberCurrentPageScroll","dashboardElement","findDashboardElement","clampPageIndex","navigateToPage","targetIndex","clampedIndex","currentTab","currentSecurityUuid","nextIndex","intendedTarget","closeSecurityDetail","overviewIndex","tab","renderedPage","renderTab","notifyExternalRender","navigateByDelta","delta","registerDetailTab","existingKey","unregisterDetailTab","normalizedDescriptor","cleanupResult","cleanupError","hasDetailTab","getDetailTabDescriptor","factory","getSecurityDetailTabKey","legacyElement","hostCandidates","legacyHost","requestDashboardRender","page","tabKey","maybeDescriptor","suppressRender","tabIndexBefore","wasActive","tabsAfter","effectivePanel","interval","anchor","parent","setupNavigation","setupSwipeOnHeaderCard","setupHeaderScrollBehavior","navLeft","navRight","updateNavigationState","shouldEnable","PPReaderDashboard","__publicField","narrow","route","conn","eventTypes","subs","eventType","unsubscribe","subscribeError","currentEntryId","eventData","pushedData","clonedData","targetPage","renderResult","restore"],"mappings":"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"}