{"version":3,"file":"dashboard.iikE_hsO.js","sources":["../../../../../src/interaction/tab_control.ts","../../../../../src/content/elements.ts","../../../../../src/lib/api/portfolio/deserializers.ts","../../../../../src/data/api.ts","../../../../../src/dashboard/registry.ts","../../../../../src/utils/currency.ts","../../../../../src/utils/performance.ts","../../../../../src/data/positionsCache.ts","../../../../../src/lib/store/portfolioStore.ts","../../../../../src/lib/store/selectors/portfolio.ts","../../../../../src/lib/ui/badges.ts","../../../../../src/data/updateConfigsWS.ts","../../../../../src/tabs/overview.ts","../../../../../src/content/charting.ts","../../../../../src/tabs/types.ts","../../../../../src/tabs/security_detail.ts","../../../../../src/views/portfolio/accounts.ts","../../../../../src/dashboard.ts"],"sourcesContent":["/**\n * Swipe and tab interaction helpers mirrored from the legacy UI.\n */\n\nexport type SwipeCallback = () => void;\n\nconst DEFAULT_SWIPE_THRESHOLD = 50;\n\ntype SwipeDirection = 'left' | 'right';\n\nfunction triggerSwipe(direction: SwipeDirection, callback: SwipeCallback): void {\n  try {\n    callback();\n  } catch (error) {\n    console.warn(`addSwipeEvents: ${direction} handler threw`, error);\n  }\n}\n\nexport function addSwipeEvents(\n  element: HTMLElement,\n  onSwipeLeft: SwipeCallback,\n  onSwipeRight: SwipeCallback,\n): void {\n  let startX: number | null = null;\n\n  const handleSwipe = (deltaX: number): void => {\n    if (deltaX < -DEFAULT_SWIPE_THRESHOLD) {\n      triggerSwipe('left', onSwipeLeft);\n    } else if (deltaX > DEFAULT_SWIPE_THRESHOLD) {\n      triggerSwipe('right', onSwipeRight);\n    }\n  };\n\n  const handleTouchStart = (event: TouchEvent): void => {\n    if (event.touches.length === 1) {\n      startX = event.touches[0].clientX;\n    }\n  };\n\n  const handleTouchEnd = (event: TouchEvent): void => {\n    if (startX === null) {\n      return;\n    }\n    if (event.changedTouches.length === 0) {\n      startX = null;\n      return;\n    }\n    const touch = event.changedTouches[0];\n    handleSwipe(touch.clientX - startX);\n    startX = null;\n  };\n\n  const handleMouseDown = (event: MouseEvent): void => {\n    startX = event.clientX;\n  };\n\n  const handleMouseUp = (event: MouseEvent): void => {\n    if (startX === null) {\n      return;\n    }\n    handleSwipe(event.clientX - startX);\n    startX = null;\n  };\n\n  element.addEventListener('touchstart', handleTouchStart, { passive: true });\n  element.addEventListener('touchend', handleTouchEnd, { passive: true });\n  element.addEventListener('mousedown', handleMouseDown);\n  element.addEventListener('mouseup', handleMouseUp);\n}\n\nexport function goToTab(targetIndex: number, onTabChange: (index: number) => void): void {\n  onTabChange(targetIndex);\n}\n","/**\n * HTML rendering helpers mirrored from the legacy dashboard implementation.\n */\n\nexport type SortDirection = 'asc' | 'desc';\n\nexport type TableAlignment = 'left' | 'right' | 'center';\n\nexport interface TableColumn {\n  key: string;\n  label: string;\n  align?: TableAlignment;\n}\n\nexport interface TableFooterContext {\n  hasValue?: boolean;\n}\n\nexport interface TableOptions {\n  sortable?: boolean;\n  defaultSort?: {\n    key: string;\n    dir?: SortDirection;\n  };\n}\n\nexport type TableRow = Record<string, unknown>;\n\nconst resolveRoundedTrend = (\n  numericValue: number,\n  decimals: number,\n): 'positive' | 'negative' | 'neutral' => {\n  if (!Number.isFinite(numericValue) || numericValue === 0) {\n    return 'neutral';\n  }\n\n  const threshold = 0.5 / Math.pow(10, decimals);\n  if (Math.abs(numericValue) < threshold) {\n    return 'neutral';\n  }\n\n  return numericValue > 0 ? 'positive' : 'negative';\n};\n\nexport function formatValue(\n  key: string,\n  value: unknown,\n  row: TableRow | undefined = undefined,\n  context: TableFooterContext | undefined = undefined,\n): string {\n  let formatted: string | null = null;\n\n  const toNumber = (v: unknown): number => {\n    if (typeof v === 'number') {\n      return v;\n    }\n    if (typeof v === 'string' && v.trim() !== '') {\n      const cleaned = v\n        .replace(/\\s+/g, '')\n        .replace(/[^0-9,.-]/g, '')\n        .replace(/\\.(?=\\d{3}(\\D|$))/g, '')\n        .replace(',', '.');\n      const parsed = Number.parseFloat(cleaned);\n      return Number.isNaN(parsed) ? Number.NaN : parsed;\n    }\n    return Number.NaN;\n  };\n\n  const safeNumber = (v: unknown, minFrac = 2, maxFrac = 2): string => {\n    const num = typeof v === 'number' ? v : toNumber(v);\n    if (!Number.isFinite(num)) {\n      return '';\n    }\n    return num.toLocaleString('de-DE', {\n      minimumFractionDigits: minFrac,\n      maximumFractionDigits: maxFrac\n    });\n  };\n\n  const renderMissingValue = (reason = ''): string => {\n    const title = reason || 'Kein Wert verfügbar';\n    return `<span class=\"missing-value\" role=\"note\" aria-label=\"${title}\" title=\"${title}\">—</span>`;\n  };\n\n  if (['gain_abs', 'gain_pct'].includes(key)) {\n    if (value == null && row) {\n      const performance = row.performance;\n      if (typeof performance === 'object' && performance !== null) {\n        const metric = (performance as Record<string, unknown>)[key];\n        if (typeof metric === 'number') {\n          value = metric;\n        }\n      }\n    }\n    const missingReason = row?.fx_unavailable === true\n      ? 'Wechselkurs nicht verfügbar – EUR-Wert unbekannt'\n      : '';\n    if (value == null || context?.hasValue === false) {\n      return renderMissingValue(missingReason);\n    }\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue(missingReason);\n    }\n    const symbol = key === 'gain_pct' ? '%' : '€';\n    formatted = safeNumber(numeric) + `&nbsp;${symbol}`;\n    const cls = resolveRoundedTrend(numeric, 2);\n    return `<span class=\"${cls}\">${formatted}</span>`;\n  } else if (key === 'position_count') {\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue();\n    }\n    formatted = numeric.toLocaleString('de-DE');\n  } else if (['balance', 'current_value', 'purchase_value'].includes(key)) {\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      if (row?.fx_unavailable) {\n        return renderMissingValue('Wechselkurs nicht verfügbar – EUR-Wert unbekannt');\n      }\n      if (context && context.hasValue === false) {\n        return renderMissingValue();\n      }\n      return renderMissingValue();\n    }\n    formatted = safeNumber(numeric) + '&nbsp;€';\n  } else if (key === 'current_holdings') {\n    // Bestände (Anzahl Anteile) – etwas mehr Präzision (bis 4 Nachkommastellen), aber ohne unnötige Nullen\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue();\n    }\n    const hasFraction = Math.abs(numeric % 1) > 0;\n    formatted = numeric.toLocaleString('de-DE', {\n      minimumFractionDigits: hasFraction ? 2 : 0,\n      maximumFractionDigits: 4\n    });\n  } else {\n    let base = '';\n    if (typeof value === 'string') {\n      base = value;\n    } else if (typeof value === 'number' && Number.isFinite(value)) {\n      base = value.toString();\n    } else if (typeof value === 'boolean') {\n      base = value ? 'true' : 'false';\n    } else if (value instanceof Date && Number.isFinite(value.getTime())) {\n      base = value.toISOString();\n    }\n    formatted = base;\n    if (formatted) {\n      const hasMarkup = /<|&lt;|&gt;/.test(formatted);\n      if (!hasMarkup) {\n        const MAX_LEN = 60;\n        if (formatted.length > MAX_LEN) {\n          formatted = formatted.slice(0, MAX_LEN - 1) + '…';\n        }\n        // Entferne frühere Präfixe (Abwärtskompatibilität)\n        if (formatted.startsWith('Kontostand ')) {\n          formatted = formatted.substring('Kontostand '.length);\n        } else if (formatted.startsWith('Depotwert ')) {\n          formatted = formatted.substring('Depotwert '.length);\n        }\n      }\n    }\n  }\n  if (typeof formatted !== 'string' || formatted === '') {\n    return renderMissingValue();\n  }\n\n  return formatted;\n}\n\nexport function makeTable(\n  rows: TableRow[],\n  cols: TableColumn[],\n  sumColumns: readonly string[] = [],\n  options: TableOptions = {},\n): string {\n  /**\n   * Erweiterung (optional):\n   * options.sortable    -> true | false (default false)\n   * options.defaultSort -> { key: 'name', dir: 'asc' } (nur wirksam falls sortable)\n   *\n   * Bestehende Aufrufer (3 Parameter) bleiben kompatibel.\n   */\n  const { sortable = false, defaultSort } = options;\n  const defaultSortKey = defaultSort?.key ?? '';\n  const defaultSortDir: SortDirection = defaultSort?.dir === 'desc' ? 'desc' : 'asc';\n\n  const escapeAttribute = (value: unknown): string => {\n    if (value == null) {\n      return '';\n    }\n    let base = '';\n    if (typeof value === 'string') {\n      base = value;\n    } else if (typeof value === 'number' && Number.isFinite(value)) {\n      base = value.toString();\n    } else if (typeof value === 'boolean') {\n      base = value ? 'true' : 'false';\n    } else if (value instanceof Date && Number.isFinite(value.getTime())) {\n      base = value.toISOString();\n    } else {\n      return '';\n    }\n    return base.replace(/&/g, '&amp;').replace(/\"/g, '&quot;');\n  };\n\n  let html = '<table><thead><tr>';\n  cols.forEach(c => {\n    const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n    // Falls sortable: th data-sort-key setzen (nur wenn key vorhanden)\n    if (sortable && c.key) {\n      html += `<th${alignClass} data-sort-key=\"${c.key}\">${c.label}</th>`;\n    } else {\n      html += `<th${alignClass}>${c.label}</th>`;\n    }\n  });\n  html += '</tr></thead><tbody>';\n\n  rows.forEach(r => {\n    html += '<tr>';\n    cols.forEach(c => {\n      const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n      html += `<td${alignClass}>${formatValue(c.key, r[c.key], r)}</td>`;\n    });\n    html += '</tr>';\n  });\n\n  // Summen berechnen (unverändert)\n  const sums: Record<string, number | null> = {};\n  const sumMeta: Record<string, TableFooterContext> = {};\n  cols.forEach(c => {\n    if (sumColumns.includes(c.key)) {\n      const aggregation = rows.reduce<{ total: number; hasValue: boolean }>(\n        (acc, row) => {\n          let candidate = row[c.key];\n          if ((c.key === 'gain_abs' || c.key === 'gain_pct') && (typeof candidate !== 'number' || !Number.isFinite(candidate))) {\n            const performance = row.performance;\n            if (typeof performance === 'object' && performance !== null) {\n              const metric = (performance as Record<string, unknown>)[c.key];\n              if (typeof metric === 'number') {\n                candidate = metric;\n              }\n            }\n          }\n          if (typeof candidate === 'number' && Number.isFinite(candidate)) {\n            const numericCandidate = candidate;\n            acc.total += numericCandidate;\n            acc.hasValue = true;\n          }\n          return acc;\n        },\n        { total: 0, hasValue: false },\n      );\n      if (aggregation.hasValue) {\n        sums[c.key] = aggregation.total;\n        sumMeta[c.key] = { hasValue: true };\n      } else {\n        sums[c.key] = null;\n        sumMeta[c.key] = { hasValue: false };\n      }\n    }\n  });\n\n  const gainAbsSum = sums['gain_abs'] ?? null;\n  if (gainAbsSum != null) {\n    const purchaseSum = sums['purchase_value'] ?? null;\n    if (purchaseSum != null && purchaseSum > 0) {\n      sums['gain_pct'] = (gainAbsSum / purchaseSum) * 100;\n    } else {\n      const currentValueSum = sums['current_value'] ?? null;\n      if (currentValueSum != null && currentValueSum !== 0) {\n        sums['gain_pct'] = (gainAbsSum / (currentValueSum - gainAbsSum)) * 100;\n      }\n    }\n  }\n\n  const aggregatedGainPct = Number.isFinite(sums['gain_pct'] ?? NaN) ? sums['gain_pct'] : null;\n  let aggregatedGainPctLabel = '';\n  let aggregatedGainPctSign = 'neutral';\n\n  if (aggregatedGainPct != null) {\n    aggregatedGainPctLabel = `${formatNumber(aggregatedGainPct)}\\u00a0%`;\n    if (aggregatedGainPct > 0) {\n      aggregatedGainPctSign = 'positive';\n    } else if (aggregatedGainPct < 0) {\n      aggregatedGainPctSign = 'negative';\n    }\n  }\n\n  html += '<tr class=\"footer-row\">';\n  cols.forEach((c, idx) => {\n    const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n    if (idx === 0) {\n      html += `<td${alignClass}>Summe</td>`;\n      return;\n    }\n\n    if (sums[c.key] != null) {\n      let extraAttributes = '';\n      if (c.key === 'gain_abs' && aggregatedGainPctLabel) {\n        extraAttributes = ` data-gain-pct=\"${escapeAttribute(aggregatedGainPctLabel)}\" data-gain-sign=\"${escapeAttribute(aggregatedGainPctSign)}\"`;\n      }\n      html += `<td${alignClass}${extraAttributes}>${formatValue(c.key, sums[c.key], undefined, sumMeta[c.key])}</td>`;\n      return;\n    }\n\n    if (c.key === 'gain_pct' && sums['gain_pct'] != null) {\n      html += `<td${alignClass}>${formatValue('gain_pct', sums['gain_pct'], undefined, sumMeta[c.key])}</td>`;\n      return;\n    }\n\n    const fallbackContext = sumMeta[c.key] ?? { hasValue: false };\n    html += `<td${alignClass}>${formatValue(c.key, null, undefined, fallbackContext)}</td>`;\n  });\n  html += '</tr>';\n\n  html += '</tbody></table>';\n\n  // Falls sortable: Default-Sort-Metadaten injizieren (nicht doppelt parsen falls nicht nötig)\n  if (sortable) {\n    try {\n      const tpl = document.createElement('template');\n      tpl.innerHTML = html.trim();\n      const table = tpl.content.querySelector<HTMLTableElement>('table');\n      if (table) {\n        table.classList.add('sortable-table');\n        if (defaultSortKey) {\n          table.dataset.defaultSort = defaultSortKey;\n          table.dataset.defaultDir = defaultSortDir;\n        }\n        return table.outerHTML;\n      }\n    } catch (e) {\n      console.warn(\"makeTable(sortable): Injection fehlgeschlagen:\", e);\n    }\n  }\n\n  return html;\n}\n\nexport function createHeaderCard(headerTitle: string, meta: string): HTMLDivElement {\n  const headerCard = document.createElement('div');\n  headerCard.className = 'header-card';\n\n  headerCard.innerHTML = `\n    <div class=\"header-content\">\n      <button id=\"nav-left\" class=\"nav-arrow\" aria-label=\"Vorherige Seite\">\n        <svg viewBox=\"0 0 24 24\">\n          <path d=\"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z\"></path>\n        </svg>\n      </button>\n      <h2 id=\"headerTitle\">${headerTitle}</h2>\n      <button id=\"nav-right\" class=\"nav-arrow\" aria-label=\"Nächste Seite\">\n        <svg viewBox=\"0 0 24 24\">\n          <path d=\"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z\"></path>\n        </svg>\n      </button>\n    </div>\n    <div id=\"headerMeta\" class=\"meta\">${meta}</div>\n  `;\n\n  return headerCard;\n}\n\n// === NEU: Vereinheitlichte Format-Helfer für andere Module (z.B. overview.js) ===\nexport function formatNumber(value: number, minFrac = 2, maxFrac = 2): string {\n  const numeric = Number.isNaN(value) ? 0 : value;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: minFrac,\n    maximumFractionDigits: maxFrac\n  });\n}\n\nexport function formatGain(value: number): string {\n  const num = Number.isNaN(value) ? 0 : value;\n  const cls = resolveRoundedTrend(num, 2);\n  return `<span class=\"${cls}\">${formatNumber(num)}&nbsp;€</span>`;\n}\n\nexport function formatGainPct(value: number): string {\n  const num = Number.isNaN(value) ? 0 : value;\n  const cls = resolveRoundedTrend(num, 2);\n  return `<span class=\"${cls}\">${formatNumber(num)}&nbsp;%</span>`;\n}\n\n/**\n * Neue Utility: sortTableRows\n * Sortiert die Datenzeilen (<tr>) einer Tabelle anhand eines Keys.\n *\n * @param {HTMLTableElement} tableEl  Ziel-Tabelle\n * @param {string} key                Daten-Key (muss mit data-sort-key im TH oder Positions-Mapping übereinstimmen)\n * @param {'asc'|'desc'} dir          Sortierrichtung\n * @param {boolean} isPositions       true => Positions-Spalten-Mapping verwenden\n * @returns {HTMLTableRowElement[]}   Array der neu angeordneten Daten-Zeilen (ohne Footer)\n *\n * Erkennung Zahl vs. String:\n *  - Entfernt NBSP, €, %, Tausenderpunkte\n *  - Wandelt Komma in Punkt\n *  - Wenn parseFloat ein valides Zahlenergebnis liefert und der ursprüngliche Text\n *    nicht komplett alphabetisch ist -> numerischer Vergleich; sonst localeCompare.\n *\n * Footer-Zeile ('.footer-row') bleibt am Ende erhalten.\n */\nexport function sortTableRows(\n  tableEl: HTMLTableElement | null | undefined,\n  key: string,\n  dir: SortDirection = 'asc',\n  isPositions = false,\n): HTMLTableRowElement[] {\n  if (!tableEl) {\n    return [];\n  }\n  const tbody = tableEl.querySelector('tbody');\n  if (!tbody) {\n    return [];\n  }\n\n  const footer = tbody.querySelector<HTMLTableRowElement>('tr.footer-row');\n  const rows = Array\n    .from(tbody.querySelectorAll<HTMLTableRowElement>('tr'))\n    .filter(r => r !== footer);\n\n  // Spaltenindex bestimmen\n  let colIdx = -1;\n  if (isPositions) {\n    const posMap: Record<string, number> = {\n      name: 0,\n      current_holdings: 1,\n      purchase_value: 2,\n      current_value: 3,\n      gain_abs: 4,\n      gain_pct: 5\n    };\n    const mappedIdx = posMap[key];\n    if (typeof mappedIdx === 'number') {\n      colIdx = mappedIdx;\n    }\n  } else {\n    // Generisch über thead th[data-sort-key]\n    const ths = Array.from(tableEl.querySelectorAll<HTMLTableCellElement>('thead th'));\n    for (let i = 0; i < ths.length; i++) {\n      if (ths[i].getAttribute('data-sort-key') === key) {\n        colIdx = i;\n        break;\n      }\n    }\n  }\n  if (colIdx < 0) {\n    return rows;\n  }\n\n  const toNumber = (txt: string): number => {\n    const cleaned = txt\n      .replace(/\\u00A0/g, ' ')\n      .replace(/[%€]/g, '')\n      .replace(/\\./g, '')\n      .replace(/,/g, '.')\n      .replace(/[^\\d.-]/g, '')\n      .trim();\n    if (!cleaned) return NaN;\n    const num = parseFloat(cleaned);\n    return Number.isFinite(num) ? num : NaN;\n  };\n\n  rows.sort((a, b) => {\n    const aCell = a.cells.item(colIdx);\n    const bCell = b.cells.item(colIdx);\n    const aTxt = (aCell?.textContent ?? '').trim();\n    const bTxt = (bCell?.textContent ?? '').trim();\n\n    const aNum = toNumber(aTxt);\n    const bNum = toNumber(bTxt);\n\n    let cmp: number;\n    const hasNumericContext = /[0-9]/.test(aTxt) || /[0-9]/.test(bTxt);\n    if (!Number.isNaN(aNum) && !Number.isNaN(bNum) && hasNumericContext) {\n      cmp = aNum - bNum;\n    } else {\n      cmp = aTxt.localeCompare(bTxt, 'de', { sensitivity: 'base' });\n    }\n    return dir === 'asc' ? cmp : -cmp;\n  });\n\n  // Re-Anordnung im DOM\n  rows.forEach(r => tbody.appendChild(r));\n  if (footer) tbody.appendChild(footer);\n\n  // Visuelle Indikatoren aktualisieren (optional generisch)\n  tableEl.querySelectorAll('thead th.sort-active').forEach(th => {\n    th.classList.remove('sort-active', 'dir-asc', 'dir-desc');\n  });\n  const activeTh = tableEl.querySelector<HTMLElement>(`thead th[data-sort-key=\"${key}\"]`);\n  if (activeTh) {\n    activeTh.classList.add('sort-active', dir === 'asc' ? 'dir-asc' : 'dir-desc');\n  }\n\n  return rows;\n}\n","/**\n * Helper utilities to deserialize canonical normalization payloads.\n */\n\nimport type {\n  NormalizedAccountSnapshot,\n  NormalizedDashboardSnapshot,\n  NormalizedPayloadMetadata,\n  NormalizedPortfolioSnapshot,\n  NormalizedPositionSnapshot,\n  NormalizationDiagnostics,\n  SnapshotDataState,\n} from './types';\n\ntype UnknownRecord = Record<string, unknown>;\n\nfunction isRecord(value: unknown): value is UnknownRecord {\n  return typeof value === 'object' && value !== null;\n}\n\nfunction toStringValue(value: unknown): string | null {\n  return typeof value === 'string' ? value : null;\n}\n\nfunction toNullableString(value: unknown): string | null {\n  return value === null ? null : toStringValue(value);\n}\n\nfunction toFiniteNumber(value: unknown): number | null {\n  if (typeof value === 'number') {\n    return Number.isFinite(value) ? value : null;\n  }\n  if (typeof value === 'string') {\n    const trimmed = value.trim();\n    if (trimmed.length === 0) {\n      return null;\n    }\n    const normalized = Number(trimmed.replace(',', '.'));\n    return Number.isFinite(normalized) ? normalized : null;\n  }\n  return null;\n}\n\nfunction toInteger(value: unknown): number | null {\n  const numeric = toFiniteNumber(value);\n  if (numeric == null) {\n    return null;\n  }\n  const truncated = Math.trunc(numeric);\n  return Number.isFinite(truncated) ? truncated : null;\n}\n\nfunction cloneRecord(value: unknown): Record<string, unknown> | null {\n  return isRecord(value) ? { ...value } : null;\n}\n\nfunction deserializeDataState(value: unknown): SnapshotDataState | null {\n  return isRecord(value) ? { ...value } : null;\n}\n\nfunction readBoolean(value: unknown): boolean | undefined {\n  return typeof value === 'boolean' ? value : undefined;\n}\n\nexport function deserializeAccountSnapshot(value: unknown): NormalizedAccountSnapshot | null {\n  if (!isRecord(value)) {\n    return null;\n  }\n\n  const name = toStringValue(value.name);\n  const currencyCode = toStringValue(value.currency_code);\n  const origBalance = toFiniteNumber(value.orig_balance);\n\n  if (!name || !currencyCode || origBalance == null) {\n    return null;\n  }\n\n  const balance = value.balance === null ? null : toFiniteNumber(value.balance);\n\n  const snapshot: NormalizedAccountSnapshot = {\n    uuid: toStringValue(value.uuid) ?? undefined,\n    name,\n    currency_code: currencyCode,\n    orig_balance: origBalance,\n    balance: balance ?? null,\n  };\n\n  const fxRate = toFiniteNumber(value.fx_rate);\n  if (fxRate != null) {\n    snapshot.fx_rate = fxRate;\n  }\n  const fxRateSource = toStringValue(value.fx_rate_source);\n  if (fxRateSource) {\n    snapshot.fx_rate_source = fxRateSource;\n  }\n  const fxRateTimestamp = toStringValue(value.fx_rate_timestamp);\n  if (fxRateTimestamp) {\n    snapshot.fx_rate_timestamp = fxRateTimestamp;\n  }\n\n  const coverageRatio = toFiniteNumber(value.coverage_ratio);\n  if (coverageRatio != null) {\n    snapshot.coverage_ratio = coverageRatio;\n  }\n  const provenance = toStringValue(value.provenance);\n  if (provenance) {\n    snapshot.provenance = provenance;\n  }\n  const metricRunUuid = toNullableString(value.metric_run_uuid);\n  if (metricRunUuid !== null) {\n    snapshot.metric_run_uuid = metricRunUuid;\n  }\n\n  const fxUnavailable = readBoolean(value.fx_unavailable);\n  if (typeof fxUnavailable === 'boolean') {\n    snapshot.fx_unavailable = fxUnavailable;\n  }\n\n  return snapshot;\n}\n\nexport function deserializeAccountSnapshots(value: unknown): NormalizedAccountSnapshot[] {\n  if (!Array.isArray(value)) {\n    return [];\n  }\n  const snapshots: NormalizedAccountSnapshot[] = [];\n  for (const entry of value) {\n    const snapshot = deserializeAccountSnapshot(entry);\n    if (snapshot) {\n      snapshots.push(snapshot);\n    }\n  }\n  return snapshots;\n}\n\nexport function deserializePositionSnapshot(value: unknown): NormalizedPositionSnapshot | null {\n  if (!isRecord(value)) {\n    return null;\n  }\n  const aggregationRaw = value.aggregation;\n  const securityUuid = toStringValue(value.security_uuid);\n  const name = toStringValue(value.name);\n  const currentHoldings = toFiniteNumber(value.current_holdings);\n  const purchaseValue =\n    toFiniteNumber(value.purchase_value_eur) ??\n    (isRecord(aggregationRaw)\n      ? toFiniteNumber(aggregationRaw.purchase_value_eur) ??\n        toFiniteNumber(aggregationRaw.purchase_total_account) ??\n        toFiniteNumber(aggregationRaw.account_currency_total)\n      : null) ??\n    toFiniteNumber(value.purchase_value);\n  const currentValue = toFiniteNumber(value.current_value);\n\n  if (!securityUuid || !name || currentHoldings == null || purchaseValue == null || currentValue == null) {\n    return null;\n  }\n\n  const snapshot: NormalizedPositionSnapshot = {\n    portfolio_uuid: toStringValue(value.portfolio_uuid) ?? undefined,\n    security_uuid: securityUuid,\n    name,\n    currency_code: toStringValue(value.currency_code),\n    current_holdings: currentHoldings,\n    purchase_value: purchaseValue,\n    current_value: currentValue,\n    average_cost: cloneRecord(value.average_cost),\n    performance: cloneRecord(value.performance),\n    aggregation: cloneRecord(value.aggregation),\n    data_state: deserializeDataState(value.data_state),\n  };\n\n  const coverageRatio = toFiniteNumber(value.coverage_ratio);\n  if (coverageRatio != null) {\n    snapshot.coverage_ratio = coverageRatio;\n  }\n  const provenance = toStringValue(value.provenance);\n  if (provenance) {\n    snapshot.provenance = provenance;\n  }\n  const metricRunUuid = toNullableString(value.metric_run_uuid);\n  if (metricRunUuid !== null) {\n    snapshot.metric_run_uuid = metricRunUuid;\n  }\n\n  const lastPriceNative = toFiniteNumber(value.last_price_native);\n  if (lastPriceNative != null) {\n    snapshot.last_price_native = lastPriceNative;\n  }\n  const lastPriceEur = toFiniteNumber(value.last_price_eur);\n  if (lastPriceEur != null) {\n    snapshot.last_price_eur = lastPriceEur;\n  }\n  const lastCloseNative = toFiniteNumber(value.last_close_native);\n  if (lastCloseNative != null) {\n    snapshot.last_close_native = lastCloseNative;\n  }\n  const lastCloseEur = toFiniteNumber(value.last_close_eur);\n  if (lastCloseEur != null) {\n    snapshot.last_close_eur = lastCloseEur;\n  }\n\n  return snapshot;\n}\n\nexport function deserializePositionSnapshots(value: unknown): NormalizedPositionSnapshot[] {\n  if (!Array.isArray(value)) {\n    return [];\n  }\n  const snapshots: NormalizedPositionSnapshot[] = [];\n  for (const entry of value) {\n    const snapshot = deserializePositionSnapshot(entry);\n    if (snapshot) {\n      snapshots.push(snapshot);\n    }\n  }\n  return snapshots;\n}\n\nexport function deserializePortfolioSnapshot(value: unknown): NormalizedPortfolioSnapshot | null {\n  if (!isRecord(value)) {\n    return null;\n  }\n\n  const name = toStringValue(value.name);\n  const currentValue = toFiniteNumber(value.current_value ?? value.value);\n\n  if (!name || currentValue == null) {\n    return null;\n  }\n\n  const purchaseValueRaw = toFiniteNumber(\n    value.purchase_sum ?? value.purchase_value_eur ?? value.purchase_value ?? value.purchaseSum,\n  );\n  const purchaseValue = purchaseValueRaw ?? 0;\n\n  const snapshot: NormalizedPortfolioSnapshot = {\n    uuid: toStringValue(value.uuid) ?? undefined,\n    name,\n    current_value: currentValue,\n    purchase_value: purchaseValue,\n    purchase_sum: purchaseValue,\n    position_count: toInteger(value.position_count ?? value.count) ?? undefined,\n    missing_value_positions: toInteger(value.missing_value_positions) ?? undefined,\n    has_current_value: readBoolean(value.has_current_value),\n    performance: cloneRecord(value.performance),\n    coverage_ratio: toFiniteNumber(value.coverage_ratio) ?? undefined,\n    provenance: toStringValue(value.provenance) ?? undefined,\n    metric_run_uuid: toNullableString(value.metric_run_uuid) ?? undefined,\n    data_state: deserializeDataState(value.data_state),\n  };\n\n  if (Array.isArray(value.positions)) {\n    snapshot.positions = deserializePositionSnapshots(value.positions);\n  }\n\n  return snapshot;\n}\n\nexport function deserializePortfolioSnapshots(value: unknown): NormalizedPortfolioSnapshot[] {\n  if (!Array.isArray(value)) {\n    return [];\n  }\n  const snapshots: NormalizedPortfolioSnapshot[] = [];\n  for (const entry of value) {\n    const snapshot = deserializePortfolioSnapshot(entry);\n    if (snapshot) {\n      snapshots.push(snapshot);\n    }\n  }\n  return snapshots;\n}\n\nexport function deserializeNormalizedPayloadMetadata(value: unknown): NormalizedPayloadMetadata | null {\n  if (!isRecord(value)) {\n    return null;\n  }\n  const metadata: NormalizedPayloadMetadata = { ...value };\n  const metricRunUuid = toNullableString(value.metric_run_uuid);\n  if (metricRunUuid !== null) {\n    metadata.metric_run_uuid = metricRunUuid;\n  } else {\n    delete metadata.metric_run_uuid;\n  }\n  const coverageRatio = toFiniteNumber(value.coverage_ratio);\n  if (coverageRatio != null) {\n    metadata.coverage_ratio = coverageRatio;\n  } else {\n    delete metadata.coverage_ratio;\n  }\n  const provenance = toStringValue(value.provenance);\n  if (provenance) {\n    metadata.provenance = provenance;\n  } else {\n    delete metadata.provenance;\n  }\n  const generatedAt = toStringValue(value.generated_at ?? value.snapshot_generated_at);\n  if (generatedAt) {\n    metadata.generated_at = generatedAt;\n  } else {\n    delete metadata.generated_at;\n  }\n  return metadata;\n}\n\nexport function deserializeNormalizationDiagnostics(\n  value: unknown,\n): NormalizationDiagnostics | null {\n  if (!isRecord(value)) {\n    return null;\n  }\n  const diagnostics: NormalizationDiagnostics = { ...value };\n  const normalizedPayload = deserializeNormalizedPayloadMetadata(value.normalized_payload);\n  if (normalizedPayload) {\n    diagnostics.normalized_payload = normalizedPayload;\n  } else if ('normalized_payload' in diagnostics) {\n    delete diagnostics.normalized_payload;\n  }\n  return diagnostics;\n}\n\nexport function deserializeNormalizedDashboardSnapshot(value: unknown): NormalizedDashboardSnapshot | null {\n  if (!isRecord(value)) {\n    return null;\n  }\n\n  const generatedAt = toStringValue(value.generated_at);\n  if (!generatedAt) {\n    return null;\n  }\n  const metricRunUuid = toNullableString(value.metric_run_uuid);\n\n  const accounts = deserializeAccountSnapshots(value.accounts);\n  const portfolios = deserializePortfolioSnapshots(value.portfolios);\n  const diagnostics = deserializeNormalizationDiagnostics(value.diagnostics);\n\n  const snapshot: NormalizedDashboardSnapshot = {\n    generated_at: generatedAt,\n    metric_run_uuid: metricRunUuid,\n    accounts,\n    portfolios,\n  };\n  if (diagnostics) {\n    snapshot.diagnostics = diagnostics;\n  }\n  return snapshot;\n}\n","/**\n * Home Assistant websocket API helpers carried over for TypeScript migration.\n */\n\nimport {\n  deserializeAccountSnapshots,\n  deserializeNormalizedDashboardSnapshot,\n  deserializeNormalizedPayloadMetadata,\n  deserializePortfolioSnapshots,\n  deserializePositionSnapshots,\n} from \"../lib/api/portfolio\";\nimport type {\n  NormalizedAccountSnapshot,\n  NormalizedDashboardSnapshot,\n  NormalizedPayloadMetadata,\n  NormalizedPortfolioSnapshot,\n  NormalizedPositionSnapshot,\n} from \"../lib/api/portfolio\";\nimport type {\n  AverageCostPayload,\n  HoldingsAggregationPayload,\n  PanelConfigLike,\n  PerformanceMetricsPayload,\n  PortfolioPosition as TabsPortfolioPosition,\n} from \"../tabs/types\";\nimport type { HomeAssistant } from \"../types/home-assistant\";\n\ntype UnknownRecord = Record<string, unknown>;\n\nfunction toStringOrNull(value: unknown): string | null {\n  return typeof value === \"string\" ? value : null;\n}\n\nfunction toArray(value: unknown): unknown[] {\n  return Array.isArray(value) ? value : [];\n}\n\nfunction toMetricRunUuid(value: unknown): string | null | undefined {\n  if (typeof value === \"string\") {\n    return value;\n  }\n  if (value === null) {\n    return null;\n  }\n  return undefined;\n}\n\nfunction toFiniteNumberOrUndefined(value: unknown): number | undefined {\n  if (typeof value === \"number\" && Number.isFinite(value)) {\n    return value;\n  }\n  return undefined;\n}\n\nfunction requireString(value: string | null | undefined, field: string): string {\n  if (typeof value === \"string\") {\n    return value;\n  }\n  throw new Error(`mapPositionSnapshotToRecord: fehlendes ${field}`);\n}\n\nfunction requireNumber(value: number | null | undefined, field: string): number {\n  if (typeof value === \"number\" && Number.isFinite(value)) {\n    return value;\n  }\n  throw new Error(`mapPositionSnapshotToRecord: fehlendes ${field}`);\n}\n\nfunction mapPositionSnapshotToRecord(snapshot: NormalizedPositionSnapshot): PortfolioPosition {\n  const securityUuid = requireString(snapshot.security_uuid, \"security_uuid\");\n  const name = requireString(snapshot.name, \"name\");\n  const currentHoldings = requireNumber(snapshot.current_holdings, \"current_holdings\");\n  const purchaseValue = requireNumber(snapshot.purchase_value, \"purchase_value\");\n  const currentValue = requireNumber(snapshot.current_value, \"current_value\");\n\n  const position: PortfolioPosition = {\n    security_uuid: securityUuid,\n    name,\n    current_holdings: currentHoldings,\n    purchase_value: purchaseValue,\n    current_value: currentValue,\n    average_cost: (snapshot.average_cost as AverageCostPayload | null | undefined) ?? null,\n    performance: (snapshot.performance as PerformanceMetricsPayload | null | undefined) ?? null,\n    aggregation: (snapshot.aggregation as HoldingsAggregationPayload | null | undefined) ?? null,\n  };\n\n  if (snapshot.currency_code !== undefined) {\n    position.currency_code = snapshot.currency_code;\n  }\n  if (snapshot.coverage_ratio != null) {\n    position.coverage_ratio = snapshot.coverage_ratio;\n  }\n  if (snapshot.provenance) {\n    position.provenance = snapshot.provenance;\n  }\n  if (snapshot.metric_run_uuid !== undefined) {\n    position.metric_run_uuid = snapshot.metric_run_uuid;\n  }\n  if (snapshot.last_price_native != null) {\n    position.last_price_native = snapshot.last_price_native;\n  }\n  if (snapshot.last_price_eur != null) {\n    position.last_price_eur = snapshot.last_price_eur;\n  }\n  if (snapshot.last_close_native != null) {\n    position.last_close_native = snapshot.last_close_native;\n  }\n  if (snapshot.last_close_eur != null) {\n    position.last_close_eur = snapshot.last_close_eur;\n  }\n  if (snapshot.data_state) {\n    position.data_state = snapshot.data_state;\n  }\n  if (snapshot.portfolio_uuid) {\n    position.portfolio_uuid = snapshot.portfolio_uuid;\n  }\n\n  return position;\n}\n\nexport type AccountSummary = NormalizedAccountSnapshot;\n\nexport type PortfolioSummary = NormalizedPortfolioSnapshot;\n\nexport interface DashboardDataResponse {\n  accounts: AccountSummary[];\n  portfolios: PortfolioSummary[];\n  last_file_update?: string | null;\n  transactions: unknown[];\n  normalized_payload?: NormalizedDashboardSnapshot | null;\n}\n\nexport interface AccountsResponse {\n  accounts: AccountSummary[];\n  normalized_payload?: NormalizedDashboardSnapshot | null;\n  [key: string]: unknown;\n}\n\nexport interface PortfoliosResponse {\n  portfolios: PortfolioSummary[];\n  normalized_payload?: NormalizedDashboardSnapshot | null;\n  [key: string]: unknown;\n}\n\nexport type PortfolioPosition = TabsPortfolioPosition;\n\nexport interface PortfolioPositionsResponse {\n  portfolio_uuid: string;\n  positions: PortfolioPosition[];\n  error?: string;\n  metric_run_uuid?: string | null;\n  coverage_ratio?: number | null;\n  provenance?: string | null;\n  normalized_payload?: NormalizedPayloadMetadata | null;\n  [key: string]: unknown;\n}\n\nexport interface SecuritySnapshotResponse {\n  security_uuid: string;\n  snapshot: {\n    name?: string;\n    currency_code?: string;\n    total_holdings?: number;\n    purchase_value_eur?: number;\n    current_value_eur?: number;\n    last_price_native?: number | null;\n    last_price_eur?: number;\n    market_value_eur?: number | null;\n    last_close_native?: number | null;\n    last_close_eur?: number | null;\n    /** Structured selection of average purchase prices with provenance metadata. */\n    average_cost?: AverageCostPayload | null;\n    aggregation?: HoldingsAggregationPayload | null;\n    /** Structured gain and day-change metrics shared across payloads. */\n    performance?: PerformanceMetricsPayload | null;\n    /** Raw snapshot provenance flag (e.g. cache vs. live). */\n    source?: string | null;\n    [key: string]: unknown;\n  };\n  [key: string]: unknown;\n}\n\nexport interface SecurityHistoryPoint {\n  date: number;\n  close: number;\n  close_raw?: number;\n  [key: string]: unknown;\n}\n\nexport interface SecurityHistoryResponse {\n  security_uuid: string;\n  prices: SecurityHistoryPoint[];\n  start_date?: number | null;\n  end_date?: number | null;\n  [key: string]: unknown;\n}\n\nexport interface LastFileUpdateResponse {\n  last_file_update?: string | null;\n  [key: string]: unknown;\n}\n\nexport interface SecurityHistoryOptions {\n  startDate?: number | null;\n  endDate?: number | null;\n  start_date?: number | null;\n  end_date?: number | null;\n  [key: string]: unknown;\n}\n\ninterface SecurityHistoryRequestPayload {\n  type: \"pp_reader/get_security_history\";\n  entry_id: string;\n  security_uuid: string;\n  start_date?: number | null;\n  end_date?: number | null;\n  [key: string]: string | number | null | undefined;\n}\n\nexport interface PortfolioValuesUpdateEntry extends Partial<PortfolioSummary> {\n  uuid?: string | null;\n  value?: number | null;\n  purchaseSum?: number | null;\n  count?: number | null;\n  position_count?: number | null;\n  hasValue?: boolean | null;\n  [key: string]: unknown;\n}\n\nexport interface PortfolioPositionsUpdatePayload {\n  portfolio_uuid?: string | null;\n  portfolioUuid?: string | null;\n  positions?: NormalizedPositionSnapshot[] | null;\n  error?: string | null;\n  normalized_payload?: NormalizedPayloadMetadata | null;\n  coverage_ratio?: number | null;\n  provenance?: string | null;\n  metric_run_uuid?: string | null;\n  [key: string]: unknown;\n}\n\nexport const DASHBOARD_DATA_TYPES = [\n  \"accounts\",\n  \"portfolio_values\",\n  \"portfolio_positions\",\n  \"security_snapshot\",\n  \"security_history\",\n] as const;\n\nexport type DashboardDataType = (typeof DASHBOARD_DATA_TYPES)[number];\n\nexport interface DashboardPushPayloadMap {\n  accounts: AccountSummary[] | null | undefined;\n  portfolio_values: PortfolioValuesUpdateEntry[] | null | undefined;\n  portfolio_positions:\n    | PortfolioPositionsUpdatePayload\n    | PortfolioPositionsUpdatePayload[]\n    | null\n    | undefined;\n  security_snapshot: SecuritySnapshotResponse | null | undefined;\n  security_history: SecurityHistoryResponse | null | undefined;\n}\n\nexport interface DashboardPushEnvelope<T extends DashboardDataType = DashboardDataType> {\n  entry_id?: string | null;\n  data_type: T;\n  data: DashboardPushPayloadMap[T];\n  synced_at?: string | null;\n  [key: string]: unknown;\n}\n\nexport function isDashboardDataType(value: unknown): value is DashboardDataType {\n  return typeof value === \"string\" && (DASHBOARD_DATA_TYPES as readonly string[]).includes(value);\n}\n\nfunction deriveEntryId(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): string | undefined {\n  let entryId =\n    panelConfig?.config?.entry_id ??\n    panelConfig?.entry_id ??\n    panelConfig?.config?._panel_custom?.config?.entry_id ??\n    undefined;\n\n  if (!entryId && hass?.panels) {\n    const panels = hass.panels;\n    const candidate =\n      (panels.ppreader as PanelConfigLike | undefined) ??\n      (panels.pp_reader as PanelConfigLike | undefined) ??\n      (Object.values(panels).find(\n        panel => (panel as PanelConfigLike | undefined)?.webcomponent_name === \"pp-reader-panel\",\n      ) as PanelConfigLike | undefined);\n\n    entryId =\n      candidate?.config?.entry_id ??\n      candidate?.entry_id ??\n      candidate?.config?._panel_custom?.config?.entry_id ??\n      undefined;\n  }\n\n  return entryId ?? undefined;\n}\n\n// Export für andere Module (Dashboard/Event-Filter)\nexport function getEntryId(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): string | undefined {\n  return deriveEntryId(hass, panelConfig);\n}\n\n// Dashboard Data\nexport async function fetchDashboardDataWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<DashboardDataResponse> {\n  if (!hass) {\n    throw new Error(\"fetchDashboardDataWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchDashboardDataWS: fehlendes entry_id\");\n  }\n\n  const raw = await hass.connection.sendMessagePromise<UnknownRecord>({\n    type: \"pp_reader/get_dashboard_data\",\n    entry_id: entryId,\n  });\n\n  const accounts = deserializeAccountSnapshots(raw.accounts);\n  const portfolios = deserializePortfolioSnapshots(raw.portfolios);\n  const lastFileUpdate = toStringOrNull(raw.last_file_update);\n  const transactions = toArray(raw.transactions);\n  const normalizedPayload = deserializeNormalizedDashboardSnapshot(raw.normalized_payload);\n\n  return {\n    accounts,\n    portfolios,\n    last_file_update: lastFileUpdate,\n    transactions,\n    normalized_payload: normalizedPayload,\n  };\n}\n\n// Accounts\nexport async function fetchAccountsWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<AccountsResponse> {\n  if (!hass) {\n    throw new Error(\"fetchAccountsWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchAccountsWS: fehlendes entry_id\");\n  }\n\n  const raw = await hass.connection.sendMessagePromise<UnknownRecord>({\n    type: \"pp_reader/get_accounts\",\n    entry_id: entryId,\n  });\n\n  const accounts = deserializeAccountSnapshots(raw.accounts);\n  const normalizedPayload = deserializeNormalizedDashboardSnapshot(raw.normalized_payload);\n\n  return {\n    accounts,\n    normalized_payload: normalizedPayload,\n  };\n}\n\n// Last file update\nexport async function fetchLastFileUpdateWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<string> {\n  if (!hass) {\n    throw new Error(\"fetchLastFileUpdateWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchLastFileUpdateWS: fehlendes entry_id\");\n  }\n\n  const response = await hass.connection.sendMessagePromise<\n    LastFileUpdateResponse | string\n  >({\n    type: \"pp_reader/get_last_file_update\",\n    entry_id: entryId,\n  });\n\n  if (typeof response === \"string\") {\n    return response;\n  }\n\n  const lastFileUpdate = response.last_file_update;\n  return typeof lastFileUpdate === \"string\" ? lastFileUpdate : \"\";\n}\n\n// Portfolios\nexport async function fetchPortfoliosWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<PortfoliosResponse> {\n  if (!hass) {\n    throw new Error(\"fetchPortfoliosWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchPortfoliosWS: fehlendes entry_id\");\n  }\n\n  const raw = await hass.connection.sendMessagePromise<UnknownRecord>({\n    type: \"pp_reader/get_portfolio_data\",\n    entry_id: entryId,\n  });\n\n  const portfolios = deserializePortfolioSnapshots(raw.portfolios);\n  const normalizedPayload = deserializeNormalizedDashboardSnapshot(raw.normalized_payload);\n\n  return {\n    portfolios,\n    normalized_payload: normalizedPayload,\n  };\n}\n\n// Positions (lazy)\nexport async function fetchPortfolioPositionsWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  portfolioUuid: string | null | undefined,\n): Promise<PortfolioPositionsResponse> {\n  if (!hass) {\n    throw new Error(\"fetchPortfolioPositionsWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchPortfolioPositionsWS: fehlendes entry_id\");\n  }\n\n  if (!portfolioUuid) {\n    throw new Error(\"fetchPortfolioPositionsWS: fehlendes portfolio_uuid\");\n  }\n\n  const raw = await hass.connection.sendMessagePromise<UnknownRecord>({\n    type: \"pp_reader/get_portfolio_positions\",\n    entry_id: entryId,\n    portfolio_uuid: portfolioUuid,\n  });\n\n  const normalizedPositions = deserializePositionSnapshots(raw.positions);\n  const positions = normalizedPositions.map(mapPositionSnapshotToRecord);\n\n  const normalizedPayloadMeta = deserializeNormalizedPayloadMetadata(raw.normalized_payload);\n\n  const response: PortfolioPositionsResponse = {\n    portfolio_uuid: toStringOrNull(raw.portfolio_uuid) ?? portfolioUuid,\n    positions,\n  };\n\n  if (typeof raw.error === \"string\") {\n    response.error = raw.error;\n  }\n  const coverageRatio = toFiniteNumberOrUndefined(raw.coverage_ratio);\n  if (coverageRatio !== undefined) {\n    response.coverage_ratio = coverageRatio;\n  }\n  const provenance = toStringOrNull(raw.provenance);\n  if (provenance) {\n    response.provenance = provenance;\n  }\n  const metricRunUuid = toMetricRunUuid(raw.metric_run_uuid);\n  if (metricRunUuid !== undefined) {\n    response.metric_run_uuid = metricRunUuid;\n  }\n  if (normalizedPayloadMeta) {\n    response.normalized_payload = normalizedPayloadMeta;\n  }\n\n  return response;\n}\n\n// Security snapshot for detail tab\nexport async function fetchSecuritySnapshotWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  securityUuid: string | null | undefined,\n): Promise<SecuritySnapshotResponse> {\n  if (!hass) {\n    throw new Error(\"fetchSecuritySnapshotWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchSecuritySnapshotWS: fehlendes entry_id\");\n  }\n\n  if (!securityUuid) {\n    throw new Error(\"fetchSecuritySnapshotWS: fehlendes securityUuid\");\n  }\n\n  return hass.connection.sendMessagePromise<SecuritySnapshotResponse>({\n    type: \"pp_reader/get_security_snapshot\",\n    entry_id: entryId,\n    security_uuid: securityUuid,\n  });\n}\n\n// Historical prices for detail tab charting\nexport async function fetchSecurityHistoryWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  securityUuid: string | null | undefined,\n  options: SecurityHistoryOptions | null | undefined = {},\n): Promise<SecurityHistoryResponse> {\n  if (!hass) {\n    throw new Error(\"fetchSecurityHistoryWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchSecurityHistoryWS: fehlendes entry_id\");\n  }\n\n  if (!securityUuid) {\n    throw new Error(\"fetchSecurityHistoryWS: fehlendes securityUuid\");\n  }\n\n  const payload: SecurityHistoryRequestPayload = {\n    type: \"pp_reader/get_security_history\",\n    entry_id: entryId,\n    security_uuid: securityUuid,\n  };\n\n  const { startDate, endDate, start_date: startDateRaw, end_date: endDateRaw } =\n    options || {};\n\n  const resolvedStart = startDate ?? startDateRaw;\n  if (resolvedStart !== undefined && resolvedStart !== null) {\n    payload.start_date = resolvedStart;\n  }\n\n  const resolvedEnd = endDate ?? endDateRaw;\n  if (resolvedEnd !== undefined && resolvedEnd !== null) {\n    payload.end_date = resolvedEnd;\n  }\n\n  return hass.connection.sendMessagePromise<SecurityHistoryResponse>(payload);\n}\n","/**\n * Dashboard registry utilities replacing legacy window.__ppReader* shims.\n *\n * Keeps cross-module helpers and element references in module scope so\n * consumers interact via imports instead of global assignments.\n */\n\nexport type DashboardElement = HTMLElement;\n\nexport type PortfolioPositionsRenderer = (positions: readonly unknown[]) => string;\nexport type GainPctMetadataApplier = (table: HTMLTableElement) => void;\nexport type PortfolioPositionsSortingAttacher = (\n  root: Document | HTMLElement,\n  portfolioUuid: string,\n) => void;\nexport type SecurityDetailListenerAttacher = (\n  root: Document | HTMLElement,\n  portfolioUuid: string,\n) => void;\nexport type PortfolioFooterUpdater = (table: HTMLTableElement | null) => void;\n\ninterface OverviewHelperRegistry {\n  renderPositionsTable?: PortfolioPositionsRenderer;\n  applyGainPctMetadata?: GainPctMetadataApplier;\n  attachSecurityDetailListener?: SecurityDetailListenerAttacher;\n  attachPortfolioPositionsSorting?: PortfolioPositionsSortingAttacher;\n  updatePortfolioFooter?: PortfolioFooterUpdater;\n}\n\nconst dashboardElements = new Set<DashboardElement>();\nconst panelHosts = new Set<HTMLElement>();\nconst overviewHelpers: Partial<OverviewHelperRegistry> = {};\n\ntype OverviewHelperKey = keyof OverviewHelperRegistry;\n\nconst OVERVIEW_HELPER_KEYS: readonly OverviewHelperKey[] = [\n  'renderPositionsTable',\n  'applyGainPctMetadata',\n  'attachSecurityDetailListener',\n  'attachPortfolioPositionsSorting',\n  'updatePortfolioFooter',\n];\n\nfunction setOverviewHelper<K extends OverviewHelperKey>(\n  key: K,\n  helper: OverviewHelperRegistry[K] | undefined,\n): void {\n  if (typeof helper === 'function') {\n    overviewHelpers[key] = helper;\n  }\n}\n\nexport function registerDashboardElement(element: DashboardElement | null | undefined): void {\n  if (!element) {\n    return;\n  }\n  dashboardElements.add(element);\n}\n\nexport function unregisterDashboardElement(element: DashboardElement | null | undefined): void {\n  if (!element) {\n    return;\n  }\n  dashboardElements.delete(element);\n}\n\nexport function getRegisteredDashboardElements(): ReadonlySet<DashboardElement> {\n  return dashboardElements;\n}\n\nexport function registerPanelHost(host: HTMLElement | null | undefined): void {\n  if (!host) {\n    return;\n  }\n  panelHosts.add(host);\n}\n\nexport function unregisterPanelHost(host: HTMLElement | null | undefined): void {\n  if (!host) {\n    return;\n  }\n  panelHosts.delete(host);\n}\n\nexport function getRegisteredPanelHosts(): ReadonlySet<HTMLElement> {\n  return panelHosts;\n}\n\nexport function registerOverviewHelpers(helpers: OverviewHelperRegistry): void {\n  for (const key of OVERVIEW_HELPER_KEYS) {\n    setOverviewHelper(key, helpers[key]);\n  }\n}\n\nexport function getOverviewHelpers(): Readonly<OverviewHelperRegistry> {\n  return overviewHelpers as OverviewHelperRegistry;\n}\n\nexport const __TEST_ONLY__ = {\n  clearRegistries(): void {\n    dashboardElements.clear();\n    panelHosts.clear();\n    for (const key of OVERVIEW_HELPER_KEYS) {\n      overviewHelpers[key] = undefined;\n    }\n  },\n};\n","/**\n * Shared currency helpers for Portfolio Performance Reader dashboard logic.\n */\n\nconst DEFAULT_DECIMALS = 2;\n\nexport interface RoundCurrencyOptions {\n  decimals?: number;\n  fallback?: number | null;\n}\n\nexport function toFiniteCurrency(value: unknown): number | null {\n  if (typeof value === 'number') {\n    return Number.isFinite(value) ? value : null;\n  }\n\n  if (typeof value === 'string') {\n    const trimmed = value.trim().replace(/\\u00a0/g, '');\n    if (!trimmed) {\n      return null;\n    }\n\n    const direct = Number(trimmed);\n    if (Number.isFinite(direct)) {\n      return direct;\n    }\n\n    const stripped = trimmed.replace(/[^0-9.,+-]/g, '');\n    if (!stripped) {\n      return null;\n    }\n\n    const lastComma = stripped.lastIndexOf(',');\n    const lastDot = stripped.lastIndexOf('.');\n    let normalized = stripped;\n\n    const hasComma = lastComma !== -1;\n    const hasDot = lastDot !== -1;\n\n    if (hasComma && (!hasDot || lastComma > lastDot)) {\n      if (!hasDot) {\n        const commaGroups = normalized.split(',');\n        const decimalDigits = commaGroups[commaGroups.length - 1]?.length ?? 0;\n        const integerPart = commaGroups.slice(0, -1).join('');\n        const integerDigits = integerPart.replace(/[+-]/g, '').length;\n        const multipleCommas = commaGroups.length > 2;\n        const integerIsZero = /^[-+]?0$/.test(integerPart);\n\n        const treatAsThousands =\n          multipleCommas ||\n          decimalDigits === 0 ||\n          (decimalDigits === 3 && integerDigits > 0 && integerDigits <= 3 && !integerIsZero);\n\n        normalized = treatAsThousands\n          ? normalized.replace(/,/g, '')\n          : normalized.replace(',', '.');\n      } else {\n        normalized = normalized.replace(/\\./g, '').replace(',', '.');\n      }\n    } else if (hasDot && hasComma && lastDot > lastComma) {\n      normalized = normalized.replace(/,/g, '');\n    } else if (hasDot) {\n      const decimals = normalized.length - lastDot - 1;\n      if (decimals === 3 && /\\d{4,}/.test(normalized.replace(/\\./g, ''))) {\n        normalized = normalized.replace(/\\./g, '');\n      }\n    }\n\n    if (normalized === '-' || normalized === '+') {\n      return null;\n    }\n\n    const localized = Number.parseFloat(normalized);\n    if (Number.isFinite(localized)) {\n      return localized;\n    }\n\n    const relaxed = Number.parseFloat(stripped.replace(',', '.'));\n    if (Number.isFinite(relaxed)) {\n      return relaxed;\n    }\n  }\n\n  return null;\n}\n\nexport function roundCurrency(\n  value: unknown,\n  { decimals = DEFAULT_DECIMALS, fallback = null }: RoundCurrencyOptions = {},\n): number | null {\n  const numeric = toFiniteCurrency(value);\n  if (numeric == null) {\n    return fallback ?? null;\n  }\n\n  const factor = 10 ** decimals;\n  const rounded = Math.round(numeric * factor) / factor;\n  if (Object.is(rounded, -0)) {\n    return 0;\n  }\n\n  return rounded;\n}\n\nexport function normalizeCurrencyValue(\n  value: unknown,\n  options: RoundCurrencyOptions = {},\n): number | null {\n  return roundCurrency(value, options);\n}\n\nexport function normalizePercentValue(\n  value: unknown,\n  options: RoundCurrencyOptions = {},\n): number | null {\n  return roundCurrency(value, options);\n}\n","/**\n * Utilities to normalise backend-provided performance payloads for the PP Reader dashboard.\n */\n\nimport type {\n  PerformanceDayChangePayload,\n  PerformanceMetricsPayload,\n} from \"../tabs/types\";\n\nconst NUMERIC_STRING_PATTERN = /^[+-]?(?:\\d+\\.?\\d*|\\d*\\.?\\d+)(?:[eE][+-]?\\d+)?$/;\n\nconst toFiniteNumber = (value: unknown): number | null => {\n  if (typeof value === \"number\") {\n    return Number.isFinite(value) ? value : null;\n  }\n\n  if (typeof value === \"string\") {\n    const trimmed = value.trim();\n    if (!trimmed) {\n      return null;\n    }\n\n    if (!NUMERIC_STRING_PATTERN.test(trimmed)) {\n      return null;\n    }\n\n    const parsed = Number(trimmed);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return null;\n};\n\nconst toOptionalString = (value: unknown): string | null => {\n  if (typeof value !== \"string\") {\n    return null;\n  }\n  const trimmed = value.trim();\n  return trimmed ? trimmed : null;\n};\n\nfunction normalizeDayChangePayload(raw: unknown): PerformanceDayChangePayload | null {\n  const candidate = raw && typeof raw === \"object\" ? (raw as Record<string, unknown>) : null;\n  if (!candidate) {\n    return null;\n  }\n\n  const priceChangeNative = toFiniteNumber(candidate.price_change_native);\n  const priceChangeEur = toFiniteNumber(candidate.price_change_eur);\n  const changePct = toFiniteNumber(candidate.change_pct);\n\n  if (priceChangeNative == null && priceChangeEur == null && changePct == null) {\n    return null;\n  }\n\n  const source = toOptionalString(candidate.source) ?? \"derived\";\n  const coverage = toFiniteNumber(candidate.coverage_ratio) ?? null;\n\n  return {\n    price_change_native: priceChangeNative,\n    price_change_eur: priceChangeEur,\n    change_pct: changePct,\n    source,\n    coverage_ratio: coverage,\n  };\n}\n\nexport function normalizePerformancePayload(\n  raw: unknown,\n): PerformanceMetricsPayload | null {\n  const candidate = raw && typeof raw === \"object\" ? (raw as Record<string, unknown>) : null;\n  if (!candidate) {\n    return null;\n  }\n\n  const gainAbs = toFiniteNumber(candidate.gain_abs);\n  const gainPct = toFiniteNumber(candidate.gain_pct);\n  const totalChangeEur = toFiniteNumber(candidate.total_change_eur);\n  const totalChangePct = toFiniteNumber(candidate.total_change_pct);\n\n  if (gainAbs == null || gainPct == null || totalChangeEur == null || totalChangePct == null) {\n    return null;\n  }\n\n  const source = toOptionalString(candidate.source) ?? \"derived\";\n  const coverage = toFiniteNumber(candidate.coverage_ratio) ?? null;\n  const dayChange = normalizeDayChangePayload(candidate.day_change);\n\n  return {\n    gain_abs: gainAbs,\n    gain_pct: gainPct,\n    total_change_eur: totalChangeEur,\n    total_change_pct: totalChangePct,\n    source,\n    coverage_ratio: coverage,\n    day_change: dayChange,\n  };\n}\n","/**\n * Shared in-memory portfolio positions cache used by dashboard tabs.\n *\n * Centralises storage for normalised portfolio position payloads so that\n * websocket update handlers and tab renderers can exchange data without\n * relying on window globals. All accessors clone cached entries to prevent\n * consumers from mutating the shared state.\n */\n\nimport type { NormalizedPositionSnapshot } from '../lib/api/portfolio';\nimport type {\n  AverageCostPayload,\n  HoldingsAggregationPayload,\n  PerformanceMetricsPayload,\n} from '../tabs/types';\nimport { normalizeCurrencyValue, toFiniteCurrency } from '../utils/currency';\nimport { normalizePerformancePayload } from '../utils/performance';\n\ntype BasePositionSnapshot = Omit<\n  NormalizedPositionSnapshot,\n  'average_cost' | 'aggregation' | 'performance'\n>;\n\nexport type PortfolioPositionRecord = BasePositionSnapshot & {\n  average_cost?: AverageCostPayload | null;\n  aggregation?: HoldingsAggregationPayload | null;\n  performance?: PerformanceMetricsPayload | null;\n  gain_abs?: number | null;\n  gain_pct?: number | null;\n  [key: string]: unknown;\n};\n\nconst portfolioPositionsCache = new Map<string, PortfolioPositionRecord[]>();\n\nfunction toNonEmptyString(value: unknown): string | null {\n  if (typeof value !== 'string') {\n    return null;\n  }\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : null;\n}\n\nfunction toNullableNumber(value: unknown): number | null {\n  if (value === null) {\n    return null;\n  }\n  const numeric = toFiniteCurrency(value);\n  return Number.isFinite(numeric ?? NaN) ? (numeric as number) : null;\n}\n\nfunction isPortfolioPositionRecord(value: unknown): value is PortfolioPositionRecord {\n  if (!value || typeof value !== 'object') {\n    return false;\n  }\n  const record = value as Record<string, unknown>;\n  return (\n    typeof record.security_uuid === 'string' &&\n    typeof record.name === 'string' &&\n    typeof record.current_holdings === 'number' &&\n    typeof record.purchase_value === 'number' &&\n    typeof record.current_value === 'number'\n  );\n}\n\nfunction clonePosition(position: PortfolioPositionRecord): PortfolioPositionRecord {\n  const clone: PortfolioPositionRecord = { ...position };\n  if (position.average_cost && typeof position.average_cost === 'object') {\n    clone.average_cost = { ...position.average_cost };\n  }\n  if (position.performance && typeof position.performance === 'object') {\n    clone.performance = { ...position.performance };\n  }\n  if (position.aggregation && typeof position.aggregation === 'object') {\n    clone.aggregation = { ...position.aggregation };\n  }\n  if (position.data_state && typeof position.data_state === 'object') {\n    clone.data_state = { ...position.data_state };\n  }\n  return clone;\n}\n\nexport function setPortfolioPositions(\n  portfolioUuid: string | null | undefined,\n  positions: readonly PortfolioPositionRecord[] | null | undefined,\n): void {\n  if (!portfolioUuid) {\n    return;\n  }\n\n  if (!Array.isArray(positions)) {\n    portfolioPositionsCache.delete(portfolioUuid);\n    return;\n  }\n\n  const normalised = positions\n    .filter((candidate): candidate is PortfolioPositionRecord => Boolean(candidate))\n    .map(clonePosition);\n  portfolioPositionsCache.set(portfolioUuid, normalised);\n}\n\nexport function hasPortfolioPositions(portfolioUuid: string | null | undefined): boolean {\n  if (!portfolioUuid) {\n    return false;\n  }\n  return portfolioPositionsCache.has(portfolioUuid);\n}\n\nexport function getPortfolioPositions(\n  portfolioUuid: string | null | undefined,\n): PortfolioPositionRecord[] {\n  if (!portfolioUuid) {\n    return [];\n  }\n  const entries = portfolioPositionsCache.get(portfolioUuid);\n  if (!entries) {\n    return [];\n  }\n  return entries.map(clonePosition);\n}\n\nexport function clearPortfolioPositions(portfolioUuid: string | null | undefined): void {\n  if (!portfolioUuid) {\n    return;\n  }\n  portfolioPositionsCache.delete(portfolioUuid);\n}\n\nexport function clearAllPortfolioPositions(): void {\n  portfolioPositionsCache.clear();\n}\n\nexport function getPortfolioPositionsSnapshot(): ReadonlyMap<string, PortfolioPositionRecord[]> {\n  return new Map(\n    Array.from(portfolioPositionsCache.entries(), ([portfolioUuid, positions]) => [\n      portfolioUuid,\n      positions.map(clonePosition),\n    ]),\n  );\n}\n\nexport function normalizeAverageCostPayload(value: unknown): AverageCostPayload | null {\n  if (!value || typeof value !== 'object') {\n    return null;\n  }\n  const record = value as Record<string, unknown>;\n  const native = toNullableNumber(record.native);\n  const security = toNullableNumber(record.security);\n  const account = toNullableNumber(record.account);\n  const eur = toNullableNumber(record.eur);\n  const coverageRatio = toNullableNumber(record.coverage_ratio);\n\n  if (\n    native == null &&\n    security == null &&\n    account == null &&\n    eur == null &&\n    coverageRatio == null\n  ) {\n    return null;\n  }\n\n  const source = toNonEmptyString(record.source);\n  const normalizedSource: AverageCostPayload['source'] =\n    source === 'totals' || source === 'eur_total' ? source : 'aggregation';\n\n  return {\n    native,\n    security,\n    account,\n    eur,\n    source: normalizedSource,\n    coverage_ratio: coverageRatio,\n  };\n}\n\nexport function normalizeAggregationPayload(\n  value: unknown,\n): HoldingsAggregationPayload | null {\n  if (!value || typeof value !== 'object') {\n    return null;\n  }\n  const record = value as Record<string, unknown>;\n\n  const totalHoldings = toNullableNumber(record.total_holdings);\n  const positiveHoldings = toNullableNumber(record.positive_holdings);\n  const purchaseValueEur = toNullableNumber(record.purchase_value_eur);\n  const securityTotal =\n    toNullableNumber(record.purchase_total_security) ??\n    toNullableNumber(record.security_currency_total);\n  const accountTotal =\n    toNullableNumber(record.purchase_total_account) ??\n    toNullableNumber(record.account_currency_total);\n\n  let purchaseValueCents = 0;\n  if (typeof record.purchase_value_cents === 'number') {\n    purchaseValueCents = Number.isFinite(record.purchase_value_cents)\n      ? Math.trunc(record.purchase_value_cents)\n      : 0;\n  } else if (typeof record.purchase_value_cents === 'string') {\n    const parsed = Number.parseInt(record.purchase_value_cents, 10);\n    if (Number.isFinite(parsed)) {\n      purchaseValueCents = parsed;\n    }\n  }\n\n  const hasValues =\n    totalHoldings != null ||\n    positiveHoldings != null ||\n    purchaseValueEur != null ||\n    securityTotal != null ||\n    accountTotal != null ||\n    purchaseValueCents !== 0;\n\n  if (!hasValues) {\n    return null;\n  }\n\n  return {\n    total_holdings: totalHoldings ?? 0,\n    positive_holdings: positiveHoldings ?? 0,\n    purchase_value_cents: purchaseValueCents,\n    purchase_value_eur: purchaseValueEur ?? 0,\n    security_currency_total: securityTotal ?? 0,\n    account_currency_total: accountTotal ?? 0,\n    purchase_total_security: securityTotal ?? 0,\n    purchase_total_account: accountTotal ?? 0,\n  };\n}\n\nexport function normalizePositionRecord(value: unknown): PortfolioPositionRecord | null {\n  if (!value || typeof value !== 'object') {\n    return null;\n  }\n  const record = isPortfolioPositionRecord(value)\n    ? (clonePosition(value) as Record<string, unknown>)\n    : (value as Record<string, unknown>);\n  const securityUuid = toNonEmptyString(record.security_uuid);\n  const name = toNonEmptyString(record.name);\n  const currentHoldings = toFiniteCurrency(record.current_holdings);\n  const currentValue = normalizeCurrencyValue(record.current_value);\n  const aggregation = normalizeAggregationPayload(record.aggregation);\n  const aggregationRaw =\n    record.aggregation && typeof record.aggregation === 'object'\n      ? (record.aggregation as Record<string, unknown>)\n      : null;\n  const purchaseValue =\n    toNullableNumber((record as { purchase_value_eur?: unknown }).purchase_value_eur) ??\n    toNullableNumber(aggregationRaw?.purchase_value_eur) ??\n    toNullableNumber(aggregationRaw?.purchase_total_account) ??\n    toNullableNumber(aggregationRaw?.account_currency_total) ??\n    normalizeCurrencyValue(record.purchase_value);\n\n  if (\n    !securityUuid ||\n    !name ||\n    currentHoldings == null ||\n    purchaseValue == null ||\n    currentValue == null\n  ) {\n    return null;\n  }\n\n  const normalized: PortfolioPositionRecord = {\n    security_uuid: securityUuid,\n    name,\n    portfolio_uuid:\n      toNonEmptyString(record.portfolio_uuid) ?? toNonEmptyString(record.portfolioUuid) ?? undefined,\n    currency_code: toNonEmptyString(record.currency_code),\n    current_holdings: currentHoldings,\n    purchase_value: purchaseValue,\n    current_value: currentValue,\n  };\n\n  const averageCost = normalizeAverageCostPayload(record.average_cost);\n  if (averageCost) {\n    normalized.average_cost = averageCost;\n  }\n  if (aggregation) {\n    normalized.aggregation = aggregation;\n  }\n  const performance = normalizePerformancePayload(record.performance);\n  if (performance) {\n    normalized.performance = performance;\n    normalized.gain_abs =\n      typeof performance.gain_abs === 'number' ? performance.gain_abs : null;\n    normalized.gain_pct =\n      typeof performance.gain_pct === 'number' ? performance.gain_pct : null;\n  } else {\n    const gainAbs = toNullableNumber(record.gain_abs);\n    const gainPct = toNullableNumber(record.gain_pct);\n    if (gainAbs !== null) {\n      normalized.gain_abs = gainAbs;\n    }\n    if (gainPct !== null) {\n      normalized.gain_pct = gainPct;\n    }\n  }\n\n  if ('coverage_ratio' in record) {\n    normalized.coverage_ratio = toNullableNumber(record.coverage_ratio);\n  }\n  const provenance = toNonEmptyString(record.provenance);\n  if (provenance) {\n    normalized.provenance = provenance;\n  }\n  const metricRunUuid = toNonEmptyString(record.metric_run_uuid);\n  if (metricRunUuid || record.metric_run_uuid === null) {\n    normalized.metric_run_uuid = metricRunUuid ?? null;\n  }\n\n  const lastPriceNative = toNullableNumber(record.last_price_native);\n  if (lastPriceNative !== null) {\n    normalized.last_price_native = lastPriceNative;\n  }\n  const lastPriceEur = toNullableNumber(record.last_price_eur);\n  if (lastPriceEur !== null) {\n    normalized.last_price_eur = lastPriceEur;\n  }\n  const lastCloseNative = toNullableNumber(record.last_close_native);\n  if (lastCloseNative !== null) {\n    normalized.last_close_native = lastCloseNative;\n  }\n  const lastCloseEur = toNullableNumber(record.last_close_eur);\n  if (lastCloseEur !== null) {\n    normalized.last_close_eur = lastCloseEur;\n  }\n\n  const dataState =\n    record.data_state && typeof record.data_state === 'object'\n      ? { ...(record.data_state as Record<string, unknown>) }\n      : undefined;\n  if (dataState) {\n    normalized.data_state = dataState;\n  }\n\n  return normalized;\n}\n\nexport function normalizePositionRecords(positions: unknown): PortfolioPositionRecord[] {\n  if (!Array.isArray(positions)) {\n    return [];\n  }\n  const normalized: PortfolioPositionRecord[] = [];\n  for (const entry of positions) {\n    const record = normalizePositionRecord(entry);\n    if (record) {\n      normalized.push(record);\n    }\n  }\n  return normalized;\n}\n","/**\n * Lightweight in-memory store for normalized dashboard snapshots.\n *\n * Keeps canonical AccountSnapshot / PortfolioSnapshot structures available to\n * both websocket handlers and view controllers without relying on window\n * globals. State mutations always clone nested objects to avoid accidental\n * consumer side-effects.\n */\n\nimport type {\n  NormalizedAccountSnapshot,\n  NormalizedPortfolioSnapshot,\n  NormalizedPositionSnapshot,\n} from \"../api/portfolio\";\n\ntype PortfolioSnapshotInput =\n  | NormalizedPortfolioSnapshot\n  | (Partial<NormalizedPortfolioSnapshot> & { uuid?: string | null });\n\ntype PortfolioSnapshotWithId = NormalizedPortfolioSnapshot & { uuid: string };\n\ninterface PortfolioStoreState {\n  accounts: NormalizedAccountSnapshot[];\n  portfolios: NormalizedPortfolioSnapshot[];\n}\n\nlet accountsState: NormalizedAccountSnapshot[] = [];\nconst portfolioState = new Map<string, PortfolioSnapshotWithId>();\n\nfunction toStringValue(value: unknown): string | undefined {\n  return typeof value === \"string\" && value.length > 0 ? value : undefined;\n}\n\nfunction toNullableString(value: unknown): string | null | undefined {\n  if (value === null) {\n    return null;\n  }\n  return toStringValue(value);\n}\n\nfunction toFiniteNumber(value: unknown): number | undefined {\n  return typeof value === \"number\" && Number.isFinite(value) ? value : undefined;\n}\n\nfunction toNullableNumber(value: unknown): number | null | undefined {\n  if (value === null) {\n    return null;\n  }\n  return toFiniteNumber(value);\n}\n\nfunction toFiniteInteger(value: unknown): number | undefined {\n  if (typeof value !== \"number\" || !Number.isFinite(value)) {\n    return undefined;\n  }\n  return Math.trunc(value);\n}\n\nfunction cloneRecord<T extends Record<string, unknown>>(value: T | null | undefined): T | undefined {\n  if (!value || typeof value !== \"object\") {\n    return undefined;\n  }\n  return { ...value };\n}\n\nfunction clonePositionSnapshot(snapshot: NormalizedPositionSnapshot): NormalizedPositionSnapshot {\n  const clone: NormalizedPositionSnapshot = { ...snapshot };\n  clone.average_cost = cloneRecord(snapshot.average_cost);\n  clone.performance = cloneRecord(snapshot.performance);\n  clone.aggregation = cloneRecord(snapshot.aggregation);\n  clone.data_state = cloneRecord(snapshot.data_state);\n  return clone;\n}\n\nfunction clonePortfolioSnapshot(snapshot: PortfolioSnapshotWithId): PortfolioSnapshotWithId {\n  const clone: PortfolioSnapshotWithId = { ...snapshot };\n  clone.performance = cloneRecord(snapshot.performance);\n  clone.data_state = cloneRecord(snapshot.data_state);\n  if (Array.isArray(snapshot.positions)) {\n    clone.positions = snapshot.positions.map(clonePositionSnapshot);\n  }\n  return clone;\n}\n\nfunction normalizePortfolioSnapshot(\n  candidate: PortfolioSnapshotInput | null | undefined,\n): PortfolioSnapshotWithId | null {\n  if (!candidate || typeof candidate !== \"object\") {\n    return null;\n  }\n\n  const uuid = toStringValue(candidate.uuid);\n  if (!uuid) {\n    return null;\n  }\n\n  const normalized: PortfolioSnapshotWithId = { uuid };\n\n  const name = toStringValue(candidate.name);\n  if (name) {\n    normalized.name = name;\n  }\n\n  const currentValue = toNullableNumber(candidate.current_value);\n  if (currentValue !== undefined) {\n    normalized.current_value = currentValue;\n  }\n\n  const purchaseValue =\n    toNullableNumber(candidate.purchase_sum) ??\n    toNullableNumber((candidate as { purchase_value_eur?: unknown }).purchase_value_eur) ??\n    toNullableNumber(candidate.purchase_value);\n  if (purchaseValue !== undefined) {\n    normalized.purchase_value = purchaseValue;\n    normalized.purchase_sum = purchaseValue;\n  }\n\n  const positionCount = toFiniteInteger(candidate.position_count);\n  if (positionCount !== undefined) {\n    normalized.position_count = positionCount;\n  }\n  const missingPositions = toFiniteInteger(candidate.missing_value_positions);\n  if (missingPositions !== undefined) {\n    normalized.missing_value_positions = missingPositions;\n  }\n  if (typeof candidate.has_current_value === \"boolean\") {\n    normalized.has_current_value = candidate.has_current_value;\n  }\n\n  const coverageRatio = toNullableNumber(candidate.coverage_ratio);\n  if (coverageRatio !== undefined) {\n    normalized.coverage_ratio = coverageRatio;\n  }\n  const provenance = toStringValue(candidate.provenance);\n  if (provenance) {\n    normalized.provenance = provenance;\n  }\n  if (\"metric_run_uuid\" in candidate) {\n    normalized.metric_run_uuid = toNullableString(candidate.metric_run_uuid);\n  }\n\n  const performance = cloneRecord(candidate.performance);\n  if (performance) {\n    normalized.performance = performance;\n  }\n  const dataState = cloneRecord(candidate.data_state);\n  if (dataState) {\n    normalized.data_state = dataState;\n  }\n  if (Array.isArray(candidate.positions)) {\n    const filtered = candidate.positions.filter(\n      (entry): entry is NormalizedPositionSnapshot => Boolean(entry),\n    );\n    if (filtered.length) {\n      normalized.positions = filtered.map(clonePositionSnapshot);\n    }\n  }\n\n  return normalized;\n}\n\nfunction mergeSnapshots(\n  current: PortfolioSnapshotWithId,\n  patch: PortfolioSnapshotWithId,\n): PortfolioSnapshotWithId {\n  const merged: PortfolioSnapshotWithId = {\n    ...current,\n    ...patch,\n  };\n\n  if (!patch.performance && current.performance) {\n    merged.performance = cloneRecord(current.performance);\n  }\n  if (!patch.data_state && current.data_state) {\n    merged.data_state = cloneRecord(current.data_state);\n  }\n  if (!patch.positions && current.positions) {\n    merged.positions = current.positions.map(clonePositionSnapshot);\n  }\n  return merged;\n}\n\nexport function setAccountSnapshots(\n  accounts: readonly NormalizedAccountSnapshot[] | null | undefined,\n): void {\n  const entries = accounts ?? [];\n  accountsState = entries.map((account) => ({ ...account }));\n}\n\nexport function getAccountSnapshots(): NormalizedAccountSnapshot[] {\n  return accountsState.map((account) => ({ ...account }));\n}\n\nexport function replacePortfolioSnapshots(\n  portfolios: readonly PortfolioSnapshotInput[] | null | undefined,\n): void {\n  portfolioState.clear();\n  const entries = portfolios ?? [];\n\n  for (const snapshot of entries) {\n    const normalized = normalizePortfolioSnapshot(snapshot);\n    if (!normalized) {\n      continue;\n    }\n    portfolioState.set(normalized.uuid, clonePortfolioSnapshot(normalized));\n  }\n}\n\nexport function mergePortfolioSnapshots(\n  patches: readonly PortfolioSnapshotInput[] | null | undefined,\n): void {\n  const entries = patches ?? [];\n\n  for (const patch of entries) {\n    const normalized = normalizePortfolioSnapshot(patch);\n    if (!normalized) {\n      continue;\n    }\n    const existing = portfolioState.get(normalized.uuid);\n    const snapshot = existing\n      ? mergeSnapshots(existing, normalized)\n      : clonePortfolioSnapshot(normalized);\n    portfolioState.set(snapshot.uuid, snapshot);\n  }\n}\n\nexport function setPortfolioPositionsSnapshot(\n  portfolioUuid: string | null | undefined,\n  positions: readonly NormalizedPositionSnapshot[] | null | undefined,\n): void {\n  if (!portfolioUuid) {\n    return;\n  }\n  const entry = portfolioState.get(portfolioUuid);\n  if (!entry) {\n    return;\n  }\n  if (!Array.isArray(positions) || positions.length === 0) {\n    const next: PortfolioSnapshotWithId = { ...entry };\n    delete next.positions;\n    portfolioState.set(portfolioUuid, next);\n    return;\n  }\n  const normalized = positions.map(clonePositionSnapshot);\n  const next: PortfolioSnapshotWithId = {\n    ...entry,\n    positions: normalized,\n  };\n  portfolioState.set(portfolioUuid, next);\n}\n\nexport function getPortfolioSnapshots(): NormalizedPortfolioSnapshot[] {\n  return Array.from(portfolioState.values(), (snapshot) => clonePortfolioSnapshot(snapshot));\n}\n\nexport function getPortfolioSnapshot(\n  portfolioUuid: string | null | undefined,\n): NormalizedPortfolioSnapshot | null {\n  if (!portfolioUuid) {\n    return null;\n  }\n  const snapshot = portfolioState.get(portfolioUuid);\n  return snapshot ? clonePortfolioSnapshot(snapshot) : null;\n}\n\nexport function getPortfolioStoreState(): PortfolioStoreState {\n  return {\n    accounts: getAccountSnapshots(),\n    portfolios: getPortfolioSnapshots(),\n  };\n}\n\nexport const __TEST_ONLY__ = {\n  reset(): void {\n    accountsState = [];\n    portfolioState.clear();\n  },\n};\n","/**\n * Selector helpers that expose normalized dashboard state for view controllers.\n *\n * These functions keep all overview tables in sync with the canonical store by\n * providing pre-digested rows plus coverage/provenance badges mirrored from\n * the backend normalization pipeline.\n */\n\nimport type {\n  NormalizedAccountSnapshot,\n  NormalizedPortfolioSnapshot,\n} from \"../../api/portfolio\";\nimport type { PerformanceMetricsPayload } from \"../../../tabs/types\";\nimport { normalizePerformancePayload } from \"../../../utils/performance\";\nimport { getPortfolioStoreState } from \"../portfolioStore\";\n\nexport type OverviewBadgeTone = \"info\" | \"warning\" | \"danger\" | \"neutral\";\n\nexport interface OverviewBadge {\n  key: string;\n  label: string;\n  tone: OverviewBadgeTone;\n  description?: string;\n}\n\nexport interface AccountOverviewRow {\n  uuid: string;\n  name: string;\n  currency_code: string | null;\n  balance: number | null;\n  orig_balance: number | null;\n  fx_unavailable: boolean;\n  coverage_ratio: number | null;\n  provenance: string | null;\n  metric_run_uuid: string | null;\n  fx_rate: number | null;\n  fx_rate_source: string | null;\n  fx_rate_timestamp: string | null;\n  badges: OverviewBadge[];\n}\n\nexport interface PortfolioOverviewRow {\n  uuid: string;\n  name: string;\n  position_count: number;\n  current_value: number | null;\n  purchase_sum: number;\n  gain_abs: number | null;\n  gain_pct: number | null;\n  hasValue: boolean;\n  fx_unavailable: boolean;\n  missing_value_positions: number;\n  performance: PerformanceMetricsPayload | null;\n  coverage_ratio: number | null;\n  provenance: string | null;\n  metric_run_uuid: string | null;\n  badges: OverviewBadge[];\n}\n\ntype CoverageScope = \"account\" | \"portfolio\";\n\nconst FALLBACK_ACCOUNT_ID = \"unknown-account\";\n\nfunction toFiniteNumber(value: unknown): number | null {\n  if (typeof value !== \"number\" || !Number.isFinite(value)) {\n    return null;\n  }\n  return value;\n}\n\nfunction toInteger(value: unknown): number {\n  const numeric = toFiniteNumber(value);\n  if (numeric == null) {\n    return 0;\n  }\n  return Math.trunc(numeric);\n}\n\nfunction toNonEmptyString(value: unknown): string | null {\n  if (typeof value !== \"string\") {\n    return null;\n  }\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : null;\n}\n\nfunction sanitizeLabel(value: unknown, fallback: string): string {\n  return toNonEmptyString(value) ?? fallback;\n}\n\nfunction clampRatio(value: number | null): number | null {\n  if (value == null || !Number.isFinite(value)) {\n    return null;\n  }\n  if (value < 0) {\n    return 0;\n  }\n  if (value > 1) {\n    return 1;\n  }\n  return value;\n}\n\nfunction formatPercentageLabel(value: number): string {\n  const hasFraction = Math.abs(value % 1) > 0.01;\n  return value.toLocaleString(\"de-DE\", {\n    minimumFractionDigits: hasFraction ? 1 : 0,\n    maximumFractionDigits: 1,\n  });\n}\n\nfunction composeCoverageBadge(\n  ratio: number | null,\n  scope: CoverageScope,\n): OverviewBadge | null {\n  const clamped = clampRatio(ratio);\n  if (clamped == null) {\n    return null;\n  }\n  const percentValue = Math.round(clamped * 1000) / 10;\n  let tone: OverviewBadgeTone = \"info\";\n  if (clamped < 0.5) {\n    tone = \"danger\";\n  } else if (clamped < 0.9) {\n    tone = \"warning\";\n  }\n\n  const labelPrefix = scope === \"account\" ? \"FX-Abdeckung\" : \"Abdeckung\";\n  const description =\n    scope === \"account\"\n      ? \"Anteil der verfügbaren FX-Daten für diese Kontoumrechnung.\"\n      : \"Anteil der verfügbaren Kennzahlen für dieses Depot.\";\n\n  return {\n    key: `${scope}-coverage`,\n    label: `${labelPrefix} ${formatPercentageLabel(percentValue)}%`,\n    tone,\n    description,\n  };\n}\n\nfunction titleCase(value: string): string {\n  return value\n    .split(/[\\s_-]+/)\n    .filter(Boolean)\n    .map(\n      (token) => token.charAt(0).toUpperCase() + token.slice(1).toLowerCase(),\n    )\n    .join(\" \");\n}\n\nfunction composeProvenanceBadge(provenance: string | null): OverviewBadge | null {\n  const normalized = normalizeProvenanceLabel(provenance);\n  if (!normalized) {\n    return null;\n  }\n\n  const friendly = normalized;\n  return {\n    key: `provenance-${normalized}`,\n    label: `Quelle: ${friendly}`,\n    tone: \"neutral\",\n    description: \"Backend-Provenance zur Nachverfolgung der Kennzahlen.\",\n  };\n}\n\nfunction normalizeProvenanceLabel(provenance: string | null): string | null {\n  const normalized = toNonEmptyString(provenance);\n  if (!normalized) {\n    return null;\n  }\n\n  const structured = parseStructuredProvenance(normalized);\n  if (structured) {\n    return structured;\n  }\n\n  return titleCase(normalized);\n}\n\nfunction parseStructuredProvenance(provenance: string): string | null {\n  const trimmed = provenance.trim();\n  if (!trimmed.startsWith(\"{\") && !trimmed.startsWith(\"[\")) {\n    return null;\n  }\n\n  try {\n    const payload = JSON.parse(trimmed) as unknown;\n    const currencies = extractCurrencyCodes(payload);\n    const provider =\n      payload && typeof payload === \"object\"\n        ? toNonEmptyString(\n            (payload as Record<string, unknown>).provider ??\n              (payload as Record<string, unknown>).source,\n          )\n        : null;\n\n    if (currencies.length && provider) {\n      return `${titleCase(provider)} (${currencies.join(\", \")})`;\n    }\n    if (currencies.length) {\n      return `FX (${currencies.join(\", \")})`;\n    }\n  } catch {\n    return null;\n  }\n\n  return null;\n}\n\nfunction extractCurrencyCodes(payload: unknown): string[] {\n  const normalizeCode = (value: unknown): string | null => {\n    if (typeof value !== \"string\") {\n      return null;\n    }\n    const trimmed = value.trim();\n    return trimmed ? trimmed.toUpperCase() : null;\n  };\n\n  const fromArray = (values: unknown[]): string[] =>\n    values\n      .map(normalizeCode)\n      .filter((code): code is string => Boolean(code));\n\n  if (Array.isArray(payload)) {\n    return fromArray(payload);\n  }\n\n  if (payload && typeof payload === \"object\") {\n    const currencies = (payload as Record<string, unknown>).currencies;\n    if (Array.isArray(currencies)) {\n      return fromArray(currencies);\n    }\n  }\n\n  return [];\n}\n\nfunction buildAccountRow(\n  snapshot: NormalizedAccountSnapshot | null | undefined,\n): AccountOverviewRow | null {\n  if (!snapshot) {\n    return null;\n  }\n\n  const uuid =\n    toNonEmptyString(snapshot.uuid) ?? `${FALLBACK_ACCOUNT_ID}-${snapshot.name ?? \"0\"}`;\n  const name = sanitizeLabel(snapshot.name, \"Unbenanntes Konto\");\n  const currencyCode = toNonEmptyString(snapshot.currency_code);\n  const balance = toFiniteNumber(snapshot.balance);\n  const origBalance = toFiniteNumber(snapshot.orig_balance);\n\n  const coverageRatio =\n    \"coverage_ratio\" in snapshot\n      ? clampRatio(toFiniteNumber(snapshot.coverage_ratio))\n      : null;\n  const provenance = toNonEmptyString(snapshot.provenance);\n  const metricRunUuid: string | null = toNonEmptyString(snapshot.metric_run_uuid);\n  const fxUnavailable = snapshot.fx_unavailable === true;\n  const fxRate = toFiniteNumber(snapshot.fx_rate);\n  const fxRateSource = toNonEmptyString(snapshot.fx_rate_source);\n  const fxRateTimestamp = toNonEmptyString(snapshot.fx_rate_timestamp);\n\n  const badges: OverviewBadge[] = [];\n  const coverageBadge = composeCoverageBadge(coverageRatio, \"account\");\n  if (coverageBadge) {\n    badges.push(coverageBadge);\n  }\n  const provenanceBadge = composeProvenanceBadge(provenance);\n  if (provenanceBadge) {\n    badges.push(provenanceBadge);\n  }\n\n  const row: AccountOverviewRow = {\n    uuid,\n    name,\n    currency_code: currencyCode,\n    balance,\n    orig_balance: origBalance,\n    fx_unavailable: fxUnavailable,\n    coverage_ratio: coverageRatio,\n    provenance,\n    metric_run_uuid: null,\n    fx_rate: fxRate,\n    fx_rate_source: fxRateSource,\n    fx_rate_timestamp: fxRateTimestamp,\n    badges,\n  };\n\n  const normalizedMetricRunUuid: string | null =\n    typeof metricRunUuid === \"string\" ? metricRunUuid : null;\n  row.metric_run_uuid = normalizedMetricRunUuid;\n\n  return row;\n}\n\nfunction buildPortfolioRow(\n  snapshot: NormalizedPortfolioSnapshot | null | undefined,\n): PortfolioOverviewRow | null {\n  if (!snapshot) {\n    return null;\n  }\n  const uuid = toNonEmptyString(snapshot.uuid);\n  if (!uuid) {\n    return null;\n  }\n\n  const name = sanitizeLabel(snapshot.name, \"Unbenanntes Depot\");\n  const positionCount = toInteger(snapshot.position_count);\n  const missingValuePositions = toInteger(snapshot.missing_value_positions);\n  const currentValue = toFiniteNumber(snapshot.current_value);\n  const purchaseSum =\n    toFiniteNumber(snapshot.purchase_sum) ??\n    toFiniteNumber((snapshot as { purchase_value_eur?: unknown })?.purchase_value_eur) ??\n    toFiniteNumber(snapshot.purchase_value) ??\n    0;\n\n  const performance = normalizePerformancePayload(snapshot.performance);\n  const gainAbs = performance?.gain_abs ?? null;\n  const gainPct = performance?.gain_pct ?? null;\n\n  const hasValue = currentValue != null;\n  const fxUnavailable = snapshot.has_current_value === false || !hasValue;\n\n  const coverageRatio =\n    \"coverage_ratio\" in snapshot\n      ? clampRatio(toFiniteNumber(snapshot.coverage_ratio))\n      : null;\n  const provenance = toNonEmptyString(snapshot.provenance);\n  const metricRunUuid = toNonEmptyString(snapshot.metric_run_uuid);\n\n  const badges: OverviewBadge[] = [];\n  const coverageBadge = composeCoverageBadge(coverageRatio, \"portfolio\");\n  if (coverageBadge) {\n    badges.push(coverageBadge);\n  }\n  const provenanceBadge = composeProvenanceBadge(provenance);\n  if (provenanceBadge) {\n    badges.push(provenanceBadge);\n  }\n\n  const row: PortfolioOverviewRow = {\n    uuid,\n    name,\n    position_count: positionCount,\n    current_value: currentValue,\n    purchase_sum: purchaseSum,\n    gain_abs: gainAbs,\n    gain_pct: gainPct,\n    hasValue,\n    fx_unavailable: fxUnavailable || missingValuePositions > 0,\n    missing_value_positions: missingValuePositions,\n    performance,\n    coverage_ratio: coverageRatio,\n    provenance,\n    metric_run_uuid: null,\n    badges,\n  };\n\n  const normalizedMetricRunUuid: string | null =\n    typeof metricRunUuid === \"string\" ? metricRunUuid : null;\n  row.metric_run_uuid = normalizedMetricRunUuid;\n\n  return row;\n}\n\nexport function selectAccountOverviewRows(): AccountOverviewRow[] {\n  const { accounts } = getPortfolioStoreState();\n  return accounts\n    .map(buildAccountRow)\n    .filter((row): row is AccountOverviewRow => Boolean(row));\n}\n\nexport function selectPortfolioOverviewRows(): PortfolioOverviewRow[] {\n  const { portfolios } = getPortfolioStoreState();\n  return portfolios\n    .map(buildPortfolioRow)\n    .filter((row): row is PortfolioOverviewRow => Boolean(row));\n}\n","/**\n * Shared HTML helpers for rendering overview badge elements.\n */\n\nimport type { OverviewBadge } from \"../store/selectors/portfolio\";\n\nexport interface BadgeListOptions {\n  containerClass?: string;\n}\n\nexport interface NameWithBadgeOptions extends BadgeListOptions {\n  labelClass?: string;\n}\n\nexport function escapeHtml(value: string | null | undefined): string {\n  if (!value) {\n    return \"\";\n  }\n  return value.replace(/[&<>\"']/g, (match) => {\n    switch (match) {\n      case \"&\":\n        return \"&amp;\";\n      case \"<\":\n        return \"&lt;\";\n      case \">\":\n        return \"&gt;\";\n      case '\"':\n        return \"&quot;\";\n      case \"'\":\n        return \"&#39;\";\n      default:\n        return match;\n    }\n  });\n}\n\nexport function renderBadgeList(\n  badges: readonly OverviewBadge[] | null | undefined,\n  options: BadgeListOptions = {},\n): string {\n  if (!badges || badges.length === 0) {\n    return \"\";\n  }\n  const containerClass = [\"meta-badges\", options.containerClass]\n    .filter(Boolean)\n    .join(\" \");\n  const items = badges\n    .map((badge) => {\n      const toneClass = `meta-badge--${badge.tone}`;\n      const title = badge.description\n        ? ` title=\"${escapeHtml(badge.description)}\"`\n        : \"\";\n      return `<span class=\"meta-badge ${toneClass}\"${title}>${escapeHtml(\n        badge.label,\n      )}</span>`;\n    })\n    .join(\"\");\n  return `<span class=\"${containerClass}\">${items}</span>`;\n}\n\nexport function renderNameWithBadges(\n  label: string,\n  badges: readonly OverviewBadge[] | null | undefined,\n  options: NameWithBadgeOptions = {},\n): string {\n  const badgeMarkup = renderBadgeList(badges, options);\n  if (!badgeMarkup) {\n    return escapeHtml(label);\n  }\n  const labelClass = options.labelClass ?? \"name-with-badges__label\";\n  const containerClass = [\"name-with-badges\", options.containerClass]\n    .filter(Boolean)\n    .join(\" \");\n  return `<span class=\"${containerClass}\"><span class=\"${labelClass}\">${escapeHtml(\n    label,\n  )}</span>${badgeMarkup}</span>`;\n}\n","/**\n * Live update handlers mirrored from the legacy websocket client.\n */\n\nimport { makeTable } from '../content/elements';\nimport { sortTableRows } from '../content/elements'; // NEU: generische Sortier-Utility\nimport { formatValue } from '../content/elements';\nimport type { SortDirection } from '../content/elements';\nimport { getOverviewHelpers } from '../dashboard/registry';\nimport { deserializePortfolioSnapshot } from '../lib/api/portfolio';\nimport type {\n  PerformanceMetricsPayload,\n  PortfolioPositionsUpdatedEventDetail,\n} from '../tabs/types';\nimport { roundCurrency } from '../utils/currency';\nimport { normalizePerformancePayload } from '../utils/performance';\nimport type {\n  AccountSummary,\n  PortfolioPositionsUpdatePayload,\n  PortfolioSummary,\n  PortfolioValuesUpdateEntry,\n} from './api';\nimport {\n  clearAllPortfolioPositions,\n  getPortfolioPositionsSnapshot,\n  normalizePositionRecords,\n  setPortfolioPositions,\n  type PortfolioPositionRecord,\n} from './positionsCache';\nimport {\n  mergePortfolioSnapshots,\n  setAccountSnapshots,\n  setPortfolioPositionsSnapshot,\n} from '../lib/store/portfolioStore';\nimport {\n  selectAccountOverviewRows,\n  type AccountOverviewRow,\n} from '../lib/store/selectors/portfolio';\nimport { renderNameWithBadges } from '../lib/ui/badges';\n\nexport type { PortfolioPositionsUpdatedEventDetail } from '../tabs/types';\n\ntype DiagnosticSnapshotKind = 'account' | 'portfolio' | 'portfolio_positions';\n\ninterface SnapshotDiagnosticsState {\n  coverage_ratio?: number | null;\n  provenance?: string | null;\n  metric_run_uuid?: string | null;\n  generated_at?: string | null;\n}\n\ninterface DiagnosticChange<T> {\n  previous: T | undefined;\n  current: T | undefined;\n}\n\ntype DiagnosticField = keyof SnapshotDiagnosticsState;\ntype DiagnosticValue = string | number | null | undefined;\n\ntype DiagnosticChanges = Partial<\n  Record<DiagnosticField, DiagnosticChange<DiagnosticValue>>\n>;\n\nfunction setDiagnosticChange(\n  changes: DiagnosticChanges,\n  field: DiagnosticField,\n  previousValue: DiagnosticValue,\n  currentValue: DiagnosticValue,\n): void {\n  changes[field] = {\n    previous: previousValue,\n    current: currentValue,\n  };\n}\n\nexport interface DashboardDiagnosticsEventDetail {\n  kind: DiagnosticSnapshotKind;\n  uuid: string;\n  source: string;\n  changed: DiagnosticChanges;\n  snapshot: SnapshotDiagnosticsState;\n  timestamp: string;\n}\n\ntype QueryRoot = HTMLElement | Document;\n\ninterface PendingPortfolioUpdate {\n  positions: PortfolioPositionRecord[];\n  error?: unknown;\n}\n\ninterface PendingRetryMeta {\n  attempts: number;\n  timer: ReturnType<typeof setTimeout> | null;\n}\n\ninterface ApplyPositionsResult {\n  applied: boolean;\n  reason?: 'invalid' | 'missing' | 'hidden';\n}\n\nconst pendingPortfolioUpdates = new Map<string, PendingPortfolioUpdate>();\nconst pendingRetryMetaMap = new Map<string, PendingRetryMeta>();\n\nfunction formatErrorMessage(error: unknown): string {\n  if (typeof error === 'string') {\n    const trimmed = error.trim();\n    return trimmed.length > 0 ? trimmed : 'Unbekannter Fehler';\n  }\n  if (error instanceof Error) {\n    const trimmed = error.message.trim();\n    return trimmed.length > 0 ? trimmed : 'Unbekannter Fehler';\n  }\n  if (error != null) {\n    try {\n      const serialized = JSON.stringify(error);\n      if (serialized && serialized !== '{}') {\n        return serialized;\n      }\n    } catch {\n      // Ignore serialization issues and fall through to default label.\n    }\n  }\n  return 'Unbekannter Fehler';\n}\n\nfunction toNonEmptyString(value: unknown): string | null {\n  if (typeof value !== 'string') {\n    return null;\n  }\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : null;\n}\n\nfunction toFiniteNumber(value: unknown): number | undefined {\n  return typeof value === 'number' && Number.isFinite(value) ? value : undefined;\n}\n\nfunction toNullableNumber(value: unknown): number | null | undefined {\n  if (value === null) {\n    return null;\n  }\n  return toFiniteNumber(value);\n}\n\nfunction toNullableString(value: unknown): string | null | undefined {\n  if (value === null) {\n    return null;\n  }\n  return toNonEmptyString(value);\n}\n\nfunction normalizePerformanceMetrics(\n  position: PortfolioPositionRecord,\n): PerformanceMetricsPayload | null {\n  return normalizePerformancePayload(position.performance);\n}\n\ntype PortfolioUpdatePayload = PortfolioValuesUpdateEntry;\n\nconst PENDING_RETRY_INTERVAL = 500;\nconst PENDING_MAX_ATTEMPTS = 10;\nexport const PORTFOLIO_POSITIONS_UPDATED_EVENT = 'pp-reader:portfolio-positions-updated';\nexport const DASHBOARD_DIAGNOSTICS_EVENT = 'pp-reader:diagnostics';\n\nconst diagnosticSnapshotMap = new Map<string, SnapshotDiagnosticsState>();\nconst DIAGNOSTIC_FIELDS: readonly (keyof SnapshotDiagnosticsState)[] = [\n  'coverage_ratio',\n  'provenance',\n  'metric_run_uuid',\n  'generated_at',\n];\n\nfunction getDiagnosticKey(kind: DiagnosticSnapshotKind, uuid: string): string {\n  return `${kind}:${uuid}`;\n}\n\nfunction normalizeCoverageValue(value: unknown): number | null | undefined {\n  if (value === undefined) {\n    return undefined;\n  }\n  if (value === null) {\n    return null;\n  }\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n  const numeric = toNullableNumber(value);\n  if (numeric === null) {\n    return null;\n  }\n  if (typeof numeric === 'number' && Number.isFinite(numeric)) {\n    return numeric;\n  }\n  return undefined;\n}\n\nfunction normalizeMetadataString(value: unknown): string | null | undefined {\n  if (value === undefined) {\n    return undefined;\n  }\n  return toNullableString(value);\n}\n\nfunction buildSnapshotDiagnostics(\n  coverageRatio: unknown,\n  provenance: unknown,\n  metricRunUuid: unknown,\n  generatedAt: unknown,\n): SnapshotDiagnosticsState | null {\n  const snapshot: SnapshotDiagnosticsState = {};\n  const normalizedCoverage = normalizeCoverageValue(coverageRatio);\n  if (normalizedCoverage !== undefined) {\n    snapshot.coverage_ratio = normalizedCoverage;\n  }\n  const normalizedProvenance = normalizeMetadataString(provenance);\n  if (normalizedProvenance !== undefined) {\n    snapshot.provenance = normalizedProvenance;\n  }\n  const normalizedMetricRunUuid = normalizeMetadataString(metricRunUuid);\n  if (normalizedMetricRunUuid !== undefined) {\n    snapshot.metric_run_uuid = normalizedMetricRunUuid;\n  }\n  const normalizedGeneratedAt = normalizeMetadataString(generatedAt);\n  if (normalizedGeneratedAt !== undefined) {\n    snapshot.generated_at = normalizedGeneratedAt;\n  }\n  return Object.keys(snapshot).length > 0 ? snapshot : null;\n}\n\nfunction diffDiagnostics(\n  previous: SnapshotDiagnosticsState | undefined,\n  next: SnapshotDiagnosticsState,\n): DiagnosticChanges | null {\n  const changes: DiagnosticChanges = {};\n  let hasChanges = false;\n  for (const field of DIAGNOSTIC_FIELDS) {\n    const previousValue = previous?.[field];\n    const currentValue = next[field];\n    if (previousValue === currentValue) {\n      continue;\n    }\n    setDiagnosticChange(changes, field, previousValue, currentValue);\n    hasChanges = true;\n  }\n  return hasChanges ? changes : null;\n}\n\nfunction buildRemovalChanges(previous: SnapshotDiagnosticsState): DiagnosticChanges | null {\n  const changes: DiagnosticChanges = {};\n  let hasChanges = false;\n  for (const field of DIAGNOSTIC_FIELDS) {\n    const previousValue = previous[field];\n    if (previousValue === undefined) {\n      continue;\n    }\n    setDiagnosticChange(changes, field, previousValue, undefined);\n    hasChanges = true;\n  }\n  return hasChanges ? changes : null;\n}\n\nfunction dispatchDiagnosticsEvent(detail: DashboardDiagnosticsEventDetail): void {\n  if (!Object.keys(detail.changed).length) {\n    return;\n  }\n  try {\n    console.debug('pp-reader:diagnostics', detail);\n  } catch {\n    // ignore console access issues\n  }\n  if (typeof window === 'undefined' || typeof window.dispatchEvent !== 'function') {\n    return;\n  }\n  try {\n    window.dispatchEvent(new CustomEvent(DASHBOARD_DIAGNOSTICS_EVENT, { detail }));\n  } catch (error) {\n    console.warn('updateConfigsWS: Diagnostics-Event konnte nicht gesendet werden', error);\n  }\n}\n\nfunction emitDiagnosticsSnapshot(\n  kind: DiagnosticSnapshotKind,\n  source: string,\n  uuid: string,\n  snapshot: SnapshotDiagnosticsState | null,\n): void {\n  const key = getDiagnosticKey(kind, uuid);\n  const previous = diagnosticSnapshotMap.get(key);\n  if (!snapshot) {\n    if (!previous) {\n      return;\n    }\n    diagnosticSnapshotMap.delete(key);\n    const removalChanges = buildRemovalChanges(previous);\n    if (!removalChanges) {\n      return;\n    }\n    dispatchDiagnosticsEvent({\n      kind,\n      uuid,\n      source,\n      changed: removalChanges,\n      snapshot: {},\n      timestamp: new Date().toISOString(),\n    });\n    return;\n  }\n  const changes = diffDiagnostics(previous, snapshot);\n  if (!changes) {\n    return;\n  }\n  diagnosticSnapshotMap.set(key, { ...snapshot });\n  dispatchDiagnosticsEvent({\n    kind,\n    uuid,\n    source,\n    changed: changes,\n    snapshot: { ...snapshot },\n    timestamp: new Date().toISOString(),\n  });\n}\n\nfunction emitAccountDiagnostics(accounts: AccountSummary[] | null | undefined): void {\n  if (!accounts || accounts.length === 0) {\n    return;\n  }\n  for (const account of accounts) {\n    const uuid = toNonEmptyString(account.uuid);\n    if (!uuid) {\n      continue;\n    }\n    const snapshot = buildSnapshotDiagnostics(\n      account.coverage_ratio,\n      account.provenance,\n      account.metric_run_uuid,\n      undefined,\n    );\n    emitDiagnosticsSnapshot('account', 'accounts', uuid, snapshot);\n  }\n}\n\nfunction emitPortfolioDiagnostics(\n  portfolios: readonly PortfolioSummary[] | null | undefined,\n): void {\n  if (!portfolios || portfolios.length === 0) {\n    return;\n  }\n  for (const portfolio of portfolios) {\n    const uuid = toNonEmptyString(portfolio.uuid);\n    if (!uuid) {\n      continue;\n    }\n    const snapshot = buildSnapshotDiagnostics(\n      portfolio.coverage_ratio,\n      portfolio.provenance,\n      portfolio.metric_run_uuid,\n      undefined,\n    );\n    emitDiagnosticsSnapshot('portfolio', 'portfolio_values', uuid, snapshot);\n  }\n}\n\nfunction emitPortfolioPositionsDiagnostics(\n  portfolioUuid: string,\n  update: PortfolioPositionsUpdatePayload | null | undefined,\n): void {\n  if (!update) {\n    return;\n  }\n  const snapshot = buildSnapshotDiagnostics(\n    update.coverage_ratio ?? update.normalized_payload?.coverage_ratio,\n    update.provenance ?? update.normalized_payload?.provenance,\n    update.metric_run_uuid ?? update.normalized_payload?.metric_run_uuid,\n    update.normalized_payload?.generated_at,\n  );\n  emitDiagnosticsSnapshot('portfolio_positions', 'portfolio_positions', portfolioUuid, snapshot);\n}\nfunction renderPositionsError(error: unknown, portfolioUuid: string): string {\n  const safeError = formatErrorMessage(error);\n  return `<div class=\"error\">${safeError} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n}\n\nfunction restoreSortAndInit(containerEl: HTMLElement, rootEl: QueryRoot, pid: string): void {\n  const table = containerEl.querySelector<HTMLTableElement>('table.sortable-positions');\n  if (!table) return;\n\n  const key = containerEl.dataset.sortKey || table.dataset.defaultSort || 'name';\n  const dirValue = containerEl.dataset.sortDir || table.dataset.defaultDir || 'asc';\n  const direction: SortDirection = dirValue === 'desc' ? 'desc' : 'asc';\n  containerEl.dataset.sortKey = key;\n  containerEl.dataset.sortDir = direction;\n\n  try {\n    sortTableRows(table, key, direction, true);\n  } catch (e) {\n    console.warn('restoreSortAndInit: sortTableRows Fehler:', e);\n  }\n\n  const { attachPortfolioPositionsSorting, attachSecurityDetailListener } = getOverviewHelpers();\n\n  if (attachPortfolioPositionsSorting) {\n    try {\n      attachPortfolioPositionsSorting(rootEl, pid);\n    } catch (e) {\n      console.warn('restoreSortAndInit: attachPortfolioPositionsSorting Fehler:', e);\n    }\n  }\n\n  if (attachSecurityDetailListener) {\n    try {\n      attachSecurityDetailListener(rootEl, pid);\n    } catch (e) {\n      console.warn('restoreSortAndInit: attachSecurityDetailListener Fehler:', e);\n    }\n  }\n}\n\nfunction applyPortfolioPositionsToDom(\n  root: QueryRoot | null | undefined,\n  portfolioUuid: string | null | undefined,\n  positions: PortfolioPositionRecord[],\n  error?: unknown,\n): ApplyPositionsResult {\n  if (!root || !portfolioUuid) {\n    return { applied: false, reason: 'invalid' };\n  }\n\n  const detailsRow = root.querySelector<HTMLTableRowElement>(\n    `.portfolio-table .portfolio-details[data-portfolio=\"${portfolioUuid}\"]`\n  );\n  if (!detailsRow) {\n    return { applied: false, reason: 'missing' };\n  }\n\n  const container = detailsRow.querySelector<HTMLElement>('.positions-container');\n  if (!container) {\n    return { applied: false, reason: 'missing' };\n  }\n\n  if (detailsRow.classList.contains('hidden')) {\n    return { applied: false, reason: 'hidden' };\n  }\n\n  if (error) {\n    container.innerHTML = renderPositionsError(error, portfolioUuid);\n    return { applied: true };\n  }\n\n  const prevKey = container.dataset.sortKey;\n  const prevDir = container.dataset.sortDir;\n\n  container.innerHTML = renderPositionsTableInline(positions);\n\n  if (prevKey) container.dataset.sortKey = prevKey;\n  if (prevDir) container.dataset.sortDir = prevDir;\n\n  restoreSortAndInit(container, root, portfolioUuid);\n  return { applied: true };\n}\n\nexport function flushPendingPositions(root: QueryRoot | null | undefined, portfolioUuid: string): boolean {\n  const pending = pendingPortfolioUpdates.get(portfolioUuid);\n  if (!pending) return false;\n\n  const result = applyPortfolioPositionsToDom(\n    root,\n    portfolioUuid,\n    pending.positions,\n    pending.error\n  );\n  if (result.applied) {\n    pendingPortfolioUpdates.delete(portfolioUuid);\n  }\n  return result.applied;\n}\n\nexport function flushAllPendingPositions(root: QueryRoot | null | undefined): boolean {\n  let appliedAny = false;\n  for (const [portfolioUuid] of pendingPortfolioUpdates) {\n    if (flushPendingPositions(root, portfolioUuid)) {\n      appliedAny = true;\n    }\n  }\n  return appliedAny;\n}\n\nfunction schedulePendingRetry(root: QueryRoot | null | undefined, portfolioUuid: string): void {\n  const meta: PendingRetryMeta = pendingRetryMetaMap.get(portfolioUuid) ?? {\n    attempts: 0,\n    timer: null,\n  };\n\n  if (meta.timer) {\n    return;\n  }\n\n  meta.timer = setTimeout(() => {\n    meta.timer = null;\n    meta.attempts += 1;\n\n    const success = flushPendingPositions(root, portfolioUuid);\n    if (success || meta.attempts >= PENDING_MAX_ATTEMPTS) {\n      pendingRetryMetaMap.delete(portfolioUuid);\n      if (!success) {\n        pendingPortfolioUpdates.delete(portfolioUuid);\n      }\n    } else {\n      schedulePendingRetry(root, portfolioUuid);\n    }\n  }, PENDING_RETRY_INTERVAL);\n\n  pendingRetryMetaMap.set(portfolioUuid, meta);\n}\n\n/**\n * Handler für Kontodaten-Updates (Accounts, inkl. FX).\n * @param update Die empfangenen Kontodaten (mit currency_code, orig_balance, balance(EUR)).\n * @param root Das Root-Element des Dashboards.\n */\nexport function handleAccountUpdate(\n  update: AccountSummary[] | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  console.log('updateConfigsWS: Kontodaten-Update erhalten:', update);\n  const updatedAccounts = Array.isArray(update) ? update : [];\n  setAccountSnapshots(updatedAccounts);\n  emitAccountDiagnostics(updatedAccounts);\n\n  if (!root) {\n    return;\n  }\n\n  const accountRows = selectAccountOverviewRows();\n\n  // Tabellen aktualisieren (EUR + FX)\n  updateAccountTable(accountRows, root);\n\n  // Portfolios aus aktueller Tabelle lesen (für Total-Neuberechnung)\n  const portfolioTable = root.querySelector<HTMLTableElement>('.portfolio-table table');\n  const portfolios = portfolioTable\n    ? Array.from(\n        portfolioTable.querySelectorAll<HTMLTableRowElement>('tbody tr:not(.footer-row)'),\n      ).map(row => {\n        // Spalten: Name | position_count | current_value | gain_abs | gain_pct\n        const currentValueCell = row.cells.item(2);\n        const textContent = currentValueCell?.textContent ?? '';\n        const numeric = parseFloat(\n          textContent.replace(/\\./g, '').replace(',', '.').replace(/[^\\d.-]/g, ''),\n        );\n        return {\n          current_value: Number.isFinite(numeric) ? numeric : 0,\n        };\n      })\n    : [];\n\n  updateTotalWealth(accountRows, portfolios, root);\n}\n\n/**\n * Aktualisiert die Tabellen mit den Kontodaten (EUR + FX).\n * @param {Array} accounts - Alle Kontodaten.\n * @param {HTMLElement} root - Root-Element.\n */\nfunction updateAccountTable(accounts: AccountOverviewRow[], root: QueryRoot): void {\n  const eurContainer = root.querySelector<HTMLElement>('.account-table');\n  const fxContainer = root.querySelector<HTMLElement>('.fx-account-table');\n\n  const eurAccounts = accounts.filter(account => (account.currency_code || 'EUR') === 'EUR');\n  const fxAccounts = accounts.filter(account => (account.currency_code || 'EUR') !== 'EUR');\n\n  if (eurContainer) {\n    const eurRows = eurAccounts.map(account => ({\n      name: renderNameWithBadges(account.name, account.badges, {\n        containerClass: 'account-name',\n        labelClass: 'account-name__label',\n      }),\n      balance: account.balance ?? null,\n    }));\n    eurContainer.innerHTML = makeTable(\n      eurRows,\n      [\n        { key: 'name', label: 'Name' },\n        { key: 'balance', label: 'Kontostand (EUR)', align: 'right' },\n      ],\n      ['balance'],\n    );\n  } else {\n    console.warn('updateAccountTable: .account-table nicht gefunden.');\n  }\n\n  if (fxContainer) {\n    const fxRows = fxAccounts.map(account => {\n      const origBalance = account.orig_balance;\n      const hasOrigBalance = typeof origBalance === 'number' && Number.isFinite(origBalance);\n      const currencyCode = toNonEmptyString(account.currency_code);\n      const amountLabel = hasOrigBalance\n        ? origBalance.toLocaleString('de-DE', {\n            minimumFractionDigits: 2,\n            maximumFractionDigits: 2,\n          })\n        : null;\n      const fxDisplay = amountLabel\n        ? currencyCode\n          ? `${amountLabel}\\u00A0${currencyCode}`\n          : amountLabel\n        : '';\n\n      return {\n        name: renderNameWithBadges(account.name, account.badges, {\n          containerClass: 'account-name',\n          labelClass: 'account-name__label',\n        }),\n        fx_display: fxDisplay,\n        balance: account.balance ?? null,\n      };\n    });\n    fxContainer.innerHTML = makeTable(\n      fxRows,\n      [\n        { key: 'name', label: 'Name' },\n        { key: 'fx_display', label: 'Betrag (FX)' },\n        { key: 'balance', label: 'EUR', align: 'right' },\n      ],\n      ['balance'],\n    );\n  } else if (fxAccounts.length) {\n    console.warn('updateAccountTable: .fx-account-table nicht gefunden, obwohl FX-Konten vorhanden sind.');\n  }\n}\n\nfunction normalizePortfolioUpdateEntries(\n  update: PortfolioUpdatePayload[] | null | undefined,\n): PortfolioSummary[] {\n  if (!Array.isArray(update)) {\n    return [];\n  }\n  const normalized: PortfolioSummary[] = [];\n  for (const entry of update) {\n    const snapshot = deserializePortfolioSnapshot(entry);\n    if (!snapshot) {\n      continue;\n    }\n    normalized.push(snapshot);\n  }\n  return normalized;\n}\n\n/**\n * Handler für Depot-Updates (aggregierte Portfolio-Werte).\n * Ersetzt die bisherige komplette Tabellen-Neuerstellung durch ein gezieltes Patchen\n * der vorhandenen expandierbaren Tabelle (gebaut in overview.js).\n */\nexport function handlePortfolioUpdate(\n  update: PortfolioUpdatePayload[] | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  if (!Array.isArray(update)) {\n    console.warn('handlePortfolioUpdate: Update ist kein Array:', update);\n    return;\n  }\n\n  try {\n    console.debug('handlePortfolioUpdate: payload=', update);\n  } catch {\n    // no-op for browsers without console.debug\n  }\n\n  const normalizedPatches = normalizePortfolioUpdateEntries(update);\n  if (normalizedPatches.length) {\n    mergePortfolioSnapshots(normalizedPatches);\n  }\n  emitPortfolioDiagnostics(normalizedPatches);\n\n  if (!root) {\n    return;\n  }\n\n  // Tabelle finden (neuer Selektor unterstützt beide Varianten)\n  const table =\n    root.querySelector<HTMLTableElement>('.portfolio-table table') ||\n    root.querySelector<HTMLTableElement>('table.expandable-portfolio-table');\n  if (!table) {\n    const overviewHost = root.querySelector('.portfolio-table');\n    const detailViewActive =\n      !overviewHost &&\n      (root.querySelector('.security-range-selector') ||\n        root.querySelector('.security-detail-placeholder'));\n\n    if (detailViewActive) {\n      console.debug(\n        'handlePortfolioUpdate: Übersicht nicht aktiv – Update wird später angewendet.',\n      );\n    } else {\n      console.warn('handlePortfolioUpdate: Keine Portfolio-Tabelle gefunden.');\n    }\n    return;\n  }\n\n  const tbody = table.tBodies.item(0) ?? table.querySelector('tbody');\n  if (!tbody) {\n    console.warn('handlePortfolioUpdate: Kein <tbody> in Tabelle.');\n    return;\n  }\n\n  // Helper Formatierer (lokal oder einfacher Fallback)\n  const formatNumberLocal = (val: number): string => {\n    if (typeof Intl !== 'undefined') {\n      try {\n        const locale = typeof navigator !== 'undefined' && navigator.language\n          ? navigator.language\n          : 'de-DE';\n        return new Intl.NumberFormat(locale, {\n          minimumFractionDigits: 2,\n          maximumFractionDigits: 2,\n        }).format(val);\n      } catch {\n        // fallback below\n      }\n    }\n    const rounded = roundCurrency(val, { fallback: 0 }) ?? 0;\n    return rounded.toFixed(2).replace('.', ',');\n  };\n\n  // Map: uuid -> Row\n  const rowMap = new Map<string, HTMLTableRowElement>();\n  const portfolioRows = tbody.querySelectorAll<HTMLTableRowElement>('tr.portfolio-row');\n  portfolioRows.forEach(row => {\n    const portfolio = row.dataset.portfolio;\n    if (portfolio) {\n      rowMap.set(portfolio, row);\n    }\n  });\n\n  let patched = 0;\n\n  const formatPositionCount = (value: number | null | undefined): string => {\n    const numeric = typeof value === 'number' && Number.isFinite(value) ? value : 0;\n    try {\n      return numeric.toLocaleString('de-DE');\n    } catch {\n      return numeric.toString();\n    }\n  };\n\n  const normalizedByUuid = new Map<string, PortfolioSummary>();\n  for (const snapshot of normalizedPatches) {\n    const uuid = toNonEmptyString(snapshot.uuid);\n    if (!uuid) {\n      continue;\n    }\n    normalizedByUuid.set(uuid, snapshot);\n  }\n\n  for (const [uuid, snapshot] of normalizedByUuid.entries()) {\n    const row = rowMap.get(uuid);\n    if (!row) {\n      continue;\n    }\n\n    if (row.cells.length < 3) {\n      continue;\n    }\n\n    const posCountCell = row.cells.item(1);\n    const curValCell = row.cells.item(2);\n    const gainAbsCell = row.cells.item(3);\n    const gainPctCell = row.cells.item(4);\n\n    if (!posCountCell || !curValCell) {\n      continue;\n    }\n\n    // Normalisierung (Full Sync nutzt value/purchase_sum; Price Events current_value/purchase_sum)\n    const posCount =\n      typeof snapshot.position_count === 'number' && Number.isFinite(snapshot.position_count)\n        ? snapshot.position_count\n        : 0;\n    const currentValue =\n      typeof snapshot.current_value === 'number' && Number.isFinite(snapshot.current_value)\n        ? snapshot.current_value\n        : null;\n    const performance = normalizePerformancePayload(snapshot.performance);\n    const gainAbs = typeof performance?.gain_abs === 'number' ? performance.gain_abs : null;\n    const gainPct = typeof performance?.gain_pct === 'number' ? performance.gain_pct : null;\n    const purchase =\n      typeof snapshot.purchase_sum === 'number' && Number.isFinite(snapshot.purchase_sum)\n        ? snapshot.purchase_sum\n        : typeof snapshot.purchase_value === 'number' && Number.isFinite(snapshot.purchase_value)\n          ? snapshot.purchase_value\n          : null;\n\n    const oldCur = parseNumLoose(curValCell.textContent);\n    const oldCnt = parseNumLoose(posCountCell.textContent);\n\n    if (oldCnt !== posCount) {\n      posCountCell.textContent = formatPositionCount(posCount);\n    }\n    const hasValue = currentValue !== null;\n    const rowData = {\n      fx_unavailable: row.dataset.fxUnavailable === 'true',\n      current_value: currentValue,\n      performance,\n    };\n    const rowContext = { hasValue };\n    const currentMarkup = formatValue('current_value', rowData.current_value, rowData, rowContext);\n    const curValNumeric = currentValue ?? 0;\n    if (Math.abs(oldCur - curValNumeric) >= 0.005 || curValCell.innerHTML !== currentMarkup) {\n      curValCell.innerHTML = currentMarkup;\n      row.classList.add('flash-update');\n      setTimeout(() => {\n        row.classList.remove('flash-update');\n      }, 800);\n    }\n    if (gainAbsCell) {\n      const gainMarkup = formatValue('gain_abs', gainAbs, rowData, rowContext);\n      gainAbsCell.innerHTML = gainMarkup;\n      const hasGainPct = typeof gainPct === 'number' && Number.isFinite(gainPct);\n      const pctValue = hasGainPct ? gainPct : null;\n      gainAbsCell.dataset.gainPct = pctValue != null\n        ? `${formatNumberLocal(pctValue)} %`\n        : '—';\n      gainAbsCell.dataset.gainSign = pctValue != null\n        ? pctValue > 0\n          ? 'positive'\n          : pctValue < 0\n            ? 'negative'\n            : 'neutral'\n        : 'neutral';\n    }\n    if (gainPctCell) {\n      gainPctCell.innerHTML = formatValue('gain_pct', gainPct, rowData, rowContext);\n    }\n\n    row.dataset.positionCount = posCount.toString();\n    row.dataset.currentValue = hasValue ? curValNumeric.toString() : '';\n    row.dataset.purchaseSum = purchase != null ? purchase.toString() : '';\n    row.dataset.gainAbs = gainAbs != null ? gainAbs.toString() : '';\n    row.dataset.gainPct = gainPct != null ? gainPct.toString() : '';\n    row.dataset.coverageRatio =\n      typeof snapshot.coverage_ratio === 'number' && Number.isFinite(snapshot.coverage_ratio)\n        ? snapshot.coverage_ratio.toString()\n        : '';\n    row.dataset.provenance = typeof snapshot.provenance === 'string' ? snapshot.provenance : '';\n    row.dataset.metricRunUuid =\n      typeof snapshot.metric_run_uuid === 'string' ? snapshot.metric_run_uuid : '';\n\n    patched += 1;\n  }\n\n  if (patched === 0) {\n    console.debug('handlePortfolioUpdate: Keine passenden Zeilen gefunden / keine Änderungen.');\n  } else {\n    const patchedLabel = patched.toLocaleString('de-DE');\n    console.debug(`handlePortfolioUpdate: ${patchedLabel} Zeile(n) gepatcht.`);\n  }\n\n  try {\n    updatePortfolioFooter(table);\n  } catch (error) {\n    console.warn('handlePortfolioUpdate: Fehler bei Summen-Neuberechnung:', error);\n  }\n\n  // Total-Wealth neu berechnen (Accounts + Portfolios)\n  try {\n    const findTable = (...selectors: Array<string | null | undefined>): HTMLTableElement | null => {\n      for (const selector of selectors) {\n        if (!selector) continue;\n        const tableEl = root.querySelector<HTMLTableElement>(selector);\n        if (tableEl) return tableEl;\n      }\n      return null;\n    };\n\n    const eurTable = findTable(\n      '.account-table table',\n      '.accounts-eur-table table',\n      '.accounts-table table',\n    );\n    const fxTable = findTable(\n      '.fx-account-table table',\n      '.accounts-fx-table table',\n    );\n\n    const extractAccounts = (tbl: HTMLTableElement | null, isFx: boolean): Array<{ balance: number }> => {\n      if (!tbl) return [];\n      const accountRows = tbl.querySelectorAll<HTMLTableRowElement>('tbody tr.account-row');\n      const rows = accountRows.length\n        ? Array.from(accountRows)\n        : Array.from(tbl.querySelectorAll<HTMLTableRowElement>('tbody tr:not(.footer-row)'));\n\n      return rows.map(row => {\n        const cell = isFx ? row.cells.item(2) : row.cells.item(1);\n        return { balance: parseNumLoose(cell?.textContent) };\n      });\n    };\n    const accounts = [\n      ...extractAccounts(eurTable, false),\n      ...extractAccounts(fxTable, true),\n    ];\n\n    const portfolioDomValues = Array.from(\n      table.querySelectorAll<HTMLTableRowElement>('tbody tr.portfolio-row'),\n    ).map(row => {\n      const currentValueRaw = row.dataset.currentValue;\n      const purchaseSumRaw = row.dataset.purchaseSum;\n      const currentValue = currentValueRaw ? Number.parseFloat(currentValueRaw) : Number.NaN;\n      const purchaseSum = purchaseSumRaw ? Number.parseFloat(purchaseSumRaw) : Number.NaN;\n      return {\n        current_value: Number.isFinite(currentValue) ? currentValue : 0,\n        purchase_sum: Number.isFinite(purchaseSum) ? purchaseSum : 0,\n      };\n    });\n\n    updateTotalWealth(accounts, portfolioDomValues, root);\n  } catch (error) {\n    console.warn('handlePortfolioUpdate: Fehler bei Total-Neuberechnung:', error);\n  }\n}\n\n/**\n * NEU: Handler für Einzel-Positions-Updates (Event: portfolio_positions).\n * @param {{portfolio_uuid: string, positions: Array}} update\n * @param {HTMLElement} root\n */\nfunction normalizePortfolioUuid(payload: PortfolioPositionsUpdatePayload | null | undefined): string | null {\n  if (!payload || typeof payload !== 'object') {\n    return null;\n  }\n  const direct = payload.portfolio_uuid;\n  if (typeof direct === 'string' && direct) {\n    return direct;\n  }\n  const camelCase = payload.portfolioUuid;\n  if (typeof camelCase === 'string' && camelCase) {\n    return camelCase;\n  }\n  return null;\n}\n\nfunction processPortfolioPositionsUpdate(\n  update: PortfolioPositionsUpdatePayload | null | undefined,\n  root: QueryRoot | null | undefined,\n): boolean {\n  const portfolioUuid = normalizePortfolioUuid(update);\n  if (!portfolioUuid) {\n    console.warn('handlePortfolioPositionsUpdate: Ungültiges Update:', update);\n    return false;\n  }\n\n  const error = update?.error;\n  const normalizedPositions = normalizePositionRecords(update?.positions ?? []);\n  emitPortfolioPositionsDiagnostics(portfolioUuid, update);\n\n  if (!error) {\n    setPortfolioPositions(portfolioUuid, normalizedPositions);\n    setPortfolioPositionsSnapshot(portfolioUuid, normalizedPositions);\n  }\n\n  const result = applyPortfolioPositionsToDom(root, portfolioUuid, normalizedPositions, error);\n\n  if (result.applied) {\n    pendingPortfolioUpdates.delete(portfolioUuid);\n  } else {\n    pendingPortfolioUpdates.set(portfolioUuid, { positions: normalizedPositions, error });\n    if (result.reason !== 'hidden') {\n      schedulePendingRetry(root, portfolioUuid);\n    }\n  }\n\n  if (!error && normalizedPositions.length > 0) {\n    const securityUuids = Array.from(\n      new Set(\n        normalizedPositions\n          .map(pos => pos.security_uuid)\n          .filter((uuid): uuid is string => typeof uuid === 'string' && uuid.length > 0),\n      ),\n    );\n\n    if (securityUuids.length && typeof window !== 'undefined') {\n      try {\n        window.dispatchEvent(\n          new CustomEvent<PortfolioPositionsUpdatedEventDetail>(\n            PORTFOLIO_POSITIONS_UPDATED_EVENT,\n            {\n              detail: {\n                portfolioUuid,\n                securityUuids,\n              },\n            },\n          ),\n        );\n      } catch (dispatchError) {\n        console.warn(\n          'handlePortfolioPositionsUpdate: Dispatch des Portfolio-Events fehlgeschlagen',\n          dispatchError,\n        );\n      }\n    }\n  }\n\n  return true;\n}\n\nexport function handlePortfolioPositionsUpdate(\n  update: PortfolioPositionsUpdatePayload | PortfolioPositionsUpdatePayload[] | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  if (Array.isArray(update)) {\n    let handled = false;\n    for (const item of update) {\n      if (processPortfolioPositionsUpdate(item, root)) {\n        handled = true;\n      }\n    }\n    if (!handled && update.length) {\n      console.warn('handlePortfolioPositionsUpdate: Kein gültiges Element im Array:', update);\n    }\n    return;\n  }\n\n  processPortfolioPositionsUpdate(update, root);\n}\n\n/* ------------------ Hilfsfunktionen (lokal) ------------------ */\n\nfunction renderPositionsTableInline(positions: PortfolioPositionRecord[]): string {\n  // Konsistenz Push vs Lazy:\n  const { renderPositionsTable, applyGainPctMetadata } = getOverviewHelpers();\n  try {\n    if (typeof renderPositionsTable === 'function') {\n      return renderPositionsTable(positions);\n    }\n  } catch (_) {}\n\n  if (positions.length === 0) {\n    return '<div class=\"no-positions\">Keine Positionen vorhanden.</div>';\n  }\n  const rows = positions.map(position => {\n    const performance = normalizePerformanceMetrics(position);\n\n    return {\n      name: position.name,\n      current_holdings: position.current_holdings,\n      purchase_value: position.purchase_value,\n      current_value: position.current_value,\n      performance,\n    };\n  });\n\n  // Basis HTML\n  const raw = makeTable(\n    rows,\n    [\n      { key: 'name', label: 'Wertpapier' },\n      { key: 'current_holdings', label: 'Bestand', align: 'right' },\n      { key: 'purchase_value', label: 'Kaufwert', align: 'right' },\n      { key: 'current_value', label: 'Aktueller Wert', align: 'right' },\n      { key: 'gain_abs', label: '+/-', align: 'right' },\n      { key: 'gain_pct', label: '%', align: 'right' }\n    ],\n    ['purchase_value', 'current_value', 'gain_abs']\n  );\n\n  // Sortier-Metadaten wie in overview.js renderPositionsTable injizieren\n  try {\n    const tpl = document.createElement('template');\n    tpl.innerHTML = raw.trim();\n    const table = tpl.content.querySelector<HTMLTableElement>('table');\n    if (table) {\n      table.classList.add('sortable-positions');\n      const ths = table.querySelectorAll<HTMLTableCellElement>('thead th');\n      const colKeys = ['name', 'current_holdings', 'purchase_value', 'current_value', 'gain_abs', 'gain_pct'];\n      ths.forEach((th, i) => {\n        const key = colKeys[i];\n        if (!key) return;\n        th.setAttribute('data-sort-key', key);\n        th.classList.add('sortable-col');\n      });\n      const bodyRows = table.querySelectorAll<HTMLTableRowElement>('tbody tr');\n      bodyRows.forEach((tr, idx) => {\n        if (tr.classList.contains('footer-row')) {\n          return;\n        }\n        const pos = positions[idx];\n        if (pos.security_uuid) {\n          tr.dataset.security = pos.security_uuid;\n        }\n        tr.classList.add('position-row');\n      });\n      table.dataset.defaultSort = 'name';\n      table.dataset.defaultDir = 'asc';\n      const gainPctMetadata = applyGainPctMetadata;\n      if (gainPctMetadata) {\n        try {\n          gainPctMetadata(table);\n        } catch (err) {\n          console.warn('renderPositionsTableInline: applyGainPctMetadata failed', err);\n        }\n      } else {\n        const rows = table.querySelectorAll<HTMLTableRowElement>('tbody tr');\n        rows.forEach((row, idx) => {\n          if (row.classList.contains('footer-row')) {\n            return;\n          }\n          const gainCell = row.cells.item(4);\n          if (!gainCell) {\n            return;\n          }\n          const position = positions[idx];\n          const performance = normalizePerformanceMetrics(position);\n          const gainPctValue =\n            typeof performance?.gain_pct === 'number' &&\n            Number.isFinite(performance.gain_pct)\n              ? performance.gain_pct\n              : null;\n          const pctLabel =\n            gainPctValue != null\n              ? `${gainPctValue.toLocaleString('de-DE', {\n                  minimumFractionDigits: 2,\n                  maximumFractionDigits: 2,\n                })} %`\n              : '—';\n          const pctSign =\n            gainPctValue == null\n              ? 'neutral'\n              : gainPctValue > 0\n                ? 'positive'\n                : gainPctValue < 0\n                  ? 'negative'\n                  : 'neutral';\n          gainCell.dataset.gainPct = pctLabel;\n          gainCell.dataset.gainSign = pctSign;\n        });\n      }\n      return table.outerHTML;\n    }\n  } catch (e) {\n    console.warn(\"renderPositionsTableInline: Sortier-Metadaten Injection fehlgeschlagen:\", e);\n  }\n  return raw;\n}\n\nfunction updatePortfolioFooter(table: HTMLTableElement | null): void {\n  if (!table) return;\n  const { updatePortfolioFooter: helper } = getOverviewHelpers();\n  if (typeof helper === 'function') {\n    try {\n      helper(table);\n      return;\n    } catch (err) {\n      console.warn('updatePortfolioFooter: helper schlug fehl:', err);\n    }\n  }\n\n  const rows = Array.from(table.querySelectorAll<HTMLTableRowElement>('tbody tr.portfolio-row'));\n\n  const parseDatasetNumber = (value: string | undefined): number | null => {\n    if (value === undefined) {\n      return null;\n    }\n    const parsed = Number.parseFloat(value);\n    return Number.isFinite(parsed) ? parsed : null;\n  };\n\n  const metrics = rows.reduce(\n    (acc, row) => {\n\n      const positionCount = parseDatasetNumber(row.dataset.positionCount);\n      if (positionCount != null) {\n        acc.sumPositions += positionCount;\n      }\n\n      if (row.dataset.fxUnavailable === 'true') {\n        acc.fxUnavailable = true;\n      }\n\n      if (row.dataset.hasValue !== 'true') {\n        acc.incompleteRows += 1;\n        return acc;\n      }\n\n      acc.valueRows += 1;\n\n      const currentValue = parseDatasetNumber(row.dataset.currentValue);\n      const gainAbs = parseDatasetNumber(row.dataset.gainAbs);\n      const purchaseSum = parseDatasetNumber(row.dataset.purchaseSum);\n\n      if (currentValue == null || gainAbs == null || purchaseSum == null) {\n        acc.incompleteRows += 1;\n        return acc;\n      }\n\n      acc.sumCurrent += currentValue;\n      acc.sumGainAbs += gainAbs;\n      acc.sumPurchase += purchaseSum;\n\n      return acc;\n    },\n    {\n      sumCurrent: 0,\n      sumGainAbs: 0,\n      sumPurchase: 0,\n      sumPositions: 0,\n      valueRows: 0,\n      incompleteRows: 0,\n      fxUnavailable: false,\n    },\n  );\n\n  const totalsComplete = metrics.valueRows > 0 && metrics.incompleteRows === 0;\n  const sumGainPct = totalsComplete && metrics.sumPurchase > 0 ? (metrics.sumGainAbs / metrics.sumPurchase) * 100 : null;\n\n  let footer = table.querySelector<HTMLTableRowElement>('tr.footer-row');\n  if (!footer) {\n    footer = document.createElement('tr');\n    footer.className = 'footer-row';\n    table.querySelector('tbody')?.appendChild(footer);\n  }\n  const sumPositionsDisplay = Math.round(metrics.sumPositions).toLocaleString('de-DE');\n  const footerRowData = {\n    fx_unavailable: metrics.fxUnavailable || !totalsComplete,\n    current_value: totalsComplete ? metrics.sumCurrent : null,\n    performance: totalsComplete\n      ? {\n          gain_abs: metrics.sumGainAbs,\n          gain_pct: sumGainPct,\n          total_change_eur: metrics.sumGainAbs,\n          total_change_pct: sumGainPct,\n          source: 'aggregated',\n          coverage_ratio: 1,\n        }\n      : null,\n  } as Record<string, unknown>;\n  const footerContext = { hasValue: totalsComplete };\n\n  const currentValueCell = formatValue('current_value', footerRowData.current_value, footerRowData, footerContext);\n  const gainAbsValue = totalsComplete ? metrics.sumGainAbs : null;\n  const gainPctValue = totalsComplete ? sumGainPct : null;\n  const gainAbsCellMarkup = formatValue('gain_abs', gainAbsValue, footerRowData, footerContext);\n  const gainPctCellMarkup = formatValue('gain_pct', gainPctValue, footerRowData, footerContext);\n\n  footer.innerHTML = `\n    <td>Summe</td>\n    <td class=\"align-right\">${sumPositionsDisplay}</td>\n    <td class=\"align-right\">${currentValueCell}</td>\n    <td class=\"align-right\">${gainAbsCellMarkup}</td>\n    <td class=\"align-right\">${gainPctCellMarkup}</td>\n  `;\n  const footerGainAbsCell = footer.cells.item(3);\n  if (footerGainAbsCell) {\n    footerGainAbsCell.dataset.gainPct = totalsComplete && typeof sumGainPct === 'number'\n      ? `${formatNumber(sumGainPct)} %`\n      : '—';\n    footerGainAbsCell.dataset.gainSign = totalsComplete && typeof sumGainPct === 'number'\n      ? sumGainPct > 0\n        ? 'positive'\n        : sumGainPct < 0\n          ? 'negative'\n          : 'neutral'\n      : 'neutral';\n  }\n  footer.dataset.positionCount = Math.round(metrics.sumPositions).toString();\n  footer.dataset.currentValue = totalsComplete ? metrics.sumCurrent.toString() : '';\n  footer.dataset.purchaseSum = totalsComplete ? metrics.sumPurchase.toString() : '';\n  footer.dataset.gainAbs = totalsComplete ? metrics.sumGainAbs.toString() : '';\n  footer.dataset.gainPct = totalsComplete && typeof sumGainPct === 'number' ? sumGainPct.toString() : '';\n  footer.dataset.hasValue = totalsComplete ? 'true' : 'false';\n  footer.dataset.fxUnavailable = metrics.fxUnavailable || !totalsComplete ? 'true' : 'false';\n}\n\nfunction toFiniteNumberOrZero(value: unknown): number {\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n  if (typeof value === 'string') {\n    const parsed = Number.parseFloat(value);\n    return Number.isFinite(parsed) ? parsed : 0;\n  }\n  return 0;\n}\n\nfunction formatNumber(v: number): string {\n  const rounded = roundCurrency(v, { fallback: 0 }) ?? 0;\n  return rounded.toLocaleString('de-DE', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2,\n  });\n}\n\nfunction updateTotalWealth(\n  accounts: Array<{ balance?: number | null; current_value?: number | null; value?: number | null }> | null | undefined,\n  portfolios: Array<{ current_value?: number | null; value?: number | null; purchase_sum?: number | null }> | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  const targetRoot: QueryRoot = root ?? document;\n\n  const accountEntries = Array.isArray(accounts) ? accounts : [];\n  const accountSum = accountEntries.reduce((acc, entry) => {\n    const candidate = entry.balance ?? entry.current_value ?? entry.value;\n    const numeric = toFiniteNumberOrZero(candidate);\n    return acc + numeric;\n  }, 0);\n\n  const portfolioEntries = Array.isArray(portfolios) ? portfolios : [];\n  const portfolioSum = portfolioEntries.reduce((acc, entry) => {\n    const candidate = entry.current_value ?? entry.value;\n    const numeric = toFiniteNumberOrZero(candidate);\n    return acc + numeric;\n  }, 0);\n\n  const totalWealth = accountSum + portfolioSum;\n\n  const headerMeta = targetRoot.querySelector<HTMLElement>('#headerMeta');\n  if (!headerMeta) {\n    console.warn('updateTotalWealth: #headerMeta nicht gefunden.');\n    return;\n  }\n\n  const valueElement =\n    headerMeta.querySelector<HTMLElement>('strong') ||\n    headerMeta.querySelector<HTMLElement>('.total-wealth-value');\n  if (valueElement) {\n    valueElement.textContent = `${formatNumber(totalWealth)}\\u00A0€`;\n  } else {\n    headerMeta.textContent = `💰 Gesamtvermögen: ${formatNumber(totalWealth)}\\u00A0€`;\n  }\n\n  headerMeta.dataset.totalWealthEur = totalWealth.toString();\n}\n\n/**\n * HINWEIS (2025-09):\n * Die frühere Funktion updatePortfolioTable (vollständiger Neuaufbau der Depot-Tabelle)\n * wurde durch inkrementelles Patchen via handlePortfolioUpdate + Lazy-Load der Positions-\n * daten ersetzt. Alte Implementierung entfernt, um doppelte Logik und Render-Flashes\n * zu vermeiden.\n *\n * Falls noch Referenzen auf updatePortfolioTable existieren, bitte auf handlePortfolioUpdate\n * umstellen. (Das Dashboard-Modul ruft bereits nur noch _doRender -> handlePortfolioUpdate auf.)\n */\n// Entfernte Legacy-Funktion:\n// function updatePortfolioTable(...) { /* veraltet, entfernt */ }\n\n// ==== Last File Update Handler (canonical) ====\n// (Ändere zu export function, damit unten kein Sammel-Export nötig ist)\nexport function handleLastFileUpdate(\n  update: string | { last_file_update?: string | null } | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  const resolvedUpdate = typeof update === 'string' ? update : update?.last_file_update;\n  const value = toNonEmptyString(resolvedUpdate) ?? '';\n\n  if (!root) {\n    console.warn('handleLastFileUpdate: root fehlt');\n    return;\n  }\n\n  // Bevorzugt Footer-Karte, sonst erste passende Stelle\n  let el =\n    root.querySelector<HTMLElement>('.footer-card .last-file-update') ||\n    root.querySelector<HTMLElement>('.last-file-update');\n\n  if (!el) {\n    // Fallback: existierende Meta-Hosts durchsuchen\n    const metaHost =\n      root.querySelector<HTMLElement>('.footer-card .meta') ||\n      root.querySelector<HTMLElement>('#headerMeta') ||\n      root.querySelector<HTMLElement>('.header-card .meta') ||\n      root.querySelector<HTMLElement>('.header-card');\n    if (!metaHost) {\n      console.warn('handleLastFileUpdate: Kein Einfügepunkt gefunden.');\n      return;\n    }\n    el = document.createElement('div');\n    el.className = 'last-file-update';\n    metaHost.appendChild(el);\n  }\n\n  // Format abhängig vom Ort (Footer behält <strong>)\n  if (el.closest('.footer-card')) {\n    el.innerHTML = value\n      ? `📂 Letzte Aktualisierung der Datei: <strong>${value}</strong>`\n      : '📂 Letzte Aktualisierung der Datei: <strong>Unbekannt</strong>';\n  } else {\n    // Header/Meta-Version (schlichter Text)\n    el.textContent = value\n      ? `📂 Letzte Aktualisierung: ${value}`\n      : '📂 Letzte Aktualisierung: Unbekannt';\n  }\n}\n/// END handleLastFileUpdate (canonical)\n\n/**\n * NEUER HELPER (Änderung 8):\n * Re-applied die gespeicherte Sortierung einer Positions-Tabelle.\n * Liest container.dataset.sortKey / sortDir oder Default-Werte vom <table>.\n * Nutzt sortTableRows(..., true) für Positions-Mapping.\n * @param {HTMLElement} containerEl .positions-container\n */\nexport function reapplyPositionsSort(containerEl: HTMLElement | null | undefined): void {\n  if (containerEl == null) {\n    return;\n  }\n  const table = containerEl.querySelector<HTMLTableElement>('table.sortable-positions');\n  if (table == null) {\n    return;\n  }\n  const key = containerEl.dataset.sortKey || table.dataset.defaultSort || 'name';\n  const dirValue = containerEl.dataset.sortDir || table.dataset.defaultDir || 'asc';\n  const direction: SortDirection = dirValue === 'desc' ? 'desc' : 'asc';\n  // Persistiere (falls erstmalig)\n  containerEl.dataset.sortKey = key;\n  containerEl.dataset.sortDir = direction;\n  sortTableRows(table, key, direction, true);\n}\n\nexport const __TEST_ONLY__ = {\n  getPortfolioPositionsCacheSnapshot: getPortfolioPositionsSnapshot,\n  clearPortfolioPositionsCache: clearAllPortfolioPositions,\n  getPendingUpdateCount(): number {\n    return pendingPortfolioUpdates.size;\n  },\n  queuePendingUpdate(\n    portfolioUuid: string,\n    positions: PortfolioPositionRecord[],\n    error?: unknown,\n  ): void {\n    pendingPortfolioUpdates.set(portfolioUuid, { positions, error });\n  },\n  clearPendingUpdates(): void {\n    pendingPortfolioUpdates.clear();\n    pendingRetryMetaMap.clear();\n  },\n};\n\n// === Globale / modulweite Utilities ===\nfunction parseNumLoose(txt: string | null | undefined): number {\n  if (txt == null) return 0;\n  const rawText = txt;\n  return parseFloat(\n    rawText\n      .replace(/\\u00A0/g, ' ')\n      .replace(/[€%]/g, '')\n      .replace(/\\./g, '')\n      .replace(',', '.')\n      .replace(/[^\\d.-]/g, '')\n  ) || 0;\n}\n","/**\n * Overview tab renderer copied for the TypeScript source tree.\n */\n\nimport {\n  createHeaderCard,\n  makeTable,\n  formatNumber,\n  formatValue,\n} from '../content/elements';\nimport { openSecurityDetail } from '../dashboard';\nimport {\n  fetchAccountsWS,\n  fetchLastFileUpdateWS,\n  fetchPortfoliosWS,\n  fetchPortfolioPositionsWS,\n} from '../data/api';\nimport type { PortfolioPositionsResponse } from '../data/api';\nimport { flushPendingPositions, flushAllPendingPositions } from '../data/updateConfigsWS';\nimport { registerOverviewHelpers } from '../dashboard/registry';\nimport {\n  getPortfolioPositions,\n  hasPortfolioPositions,\n  normalizePositionRecords,\n  setPortfolioPositions,\n} from '../data/positionsCache';\nimport type { PortfolioPositionRecord } from '../data/positionsCache';\nimport type { HomeAssistant } from '../types/home-assistant';\nimport type {\n  PanelConfigLike,\n} from './types';\nimport { toFiniteCurrency } from '../utils/currency';\nimport { normalizePerformancePayload } from '../utils/performance';\nimport {\n  replacePortfolioSnapshots,\n  setAccountSnapshots,\n  setPortfolioPositionsSnapshot,\n} from '../lib/store/portfolioStore';\nimport {\n  selectAccountOverviewRows,\n  selectPortfolioOverviewRows,\n  type AccountOverviewRow,\n  type PortfolioOverviewRow,\n} from '../lib/store/selectors/portfolio';\nimport { escapeHtml, renderBadgeList, renderNameWithBadges } from '../lib/ui/badges';\n\n\ntype PortfolioQueryRoot = Document | HTMLElement;\n\ntype PortfolioPositionsSortKey =\n  | 'name'\n  | 'current_holdings'\n  | 'purchase_value'\n  | 'current_value'\n  | 'gain_abs'\n  | 'gain_pct';\n\ntype PortfolioSortDirection = 'asc' | 'desc';\n\nconst PORTFOLIO_SORT_KEYS: readonly PortfolioPositionsSortKey[] = [\n  'name',\n  'current_holdings',\n  'purchase_value',\n  'current_value',\n  'gain_abs',\n  'gain_pct',\n];\n\nfunction isPortfolioPositionsSortKey(\n  value: string | null | undefined,\n): value is PortfolioPositionsSortKey {\n  return PORTFOLIO_SORT_KEYS.includes(value as PortfolioPositionsSortKey);\n}\n\nfunction isPortfolioSortDirection(\n  value: string | null | undefined,\n): value is PortfolioSortDirection {\n  return value === 'asc' || value === 'desc';\n}\n\ntype ToggleContainerElement = HTMLElement & {\n  __ppReaderSecurityClickBound?: boolean;\n  __ppReaderPortfolioToggleBound?: boolean;\n};\n\ntype ToggleRootElement = HTMLElement & {\n  __ppReaderAttachToken?: number;\n  __ppReaderAttachInProgress?: boolean;\n};\n\ntype SortableTableElement = HTMLTableElement & {\n  __ppReaderSortingBound?: boolean;\n  __ppReaderPortfolioFallbackBound?: boolean;\n};\n\n// === Modul-weiter State für Expand/Collapse & Lazy Load ===\n// On-Demand Aggregation liefert frische Portfolio-Werte; nur Positionen bleiben Lazy-Loaded.\nlet _hassRef: HomeAssistant | null = null;\nlet _panelConfigRef: PanelConfigLike | null = null;\n\n// --- Security-Aggregation für Detail-Ansicht ---\nconst PRICE_FRACTION_DIGITS = { min: 2, max: 6 } as const;\n\nfunction toNullableNumber(value: unknown): number | null {\n  return toFiniteCurrency(value);\n}\n\nfunction isFiniteNumber(value: unknown): value is number {\n  return typeof value === 'number' && Number.isFinite(value);\n}\n\nfunction normalizeCurrencyCode(value: unknown): string | null {\n  if (typeof value !== 'string') {\n    return null;\n  }\n  const trimmed = value.trim();\n  if (!trimmed) {\n    return null;\n  }\n  const upper = trimmed.toUpperCase();\n  if (/^[A-Z]{3}$/.test(upper)) {\n    return upper;\n  }\n  if (upper === '€') {\n    return 'EUR';\n  }\n  return null;\n}\n\nfunction resolveCurrencyFromPosition(\n  position: Record<string, unknown>,\n  keys: readonly string[],\n  fallback: string | null = null,\n): string | null {\n  for (const key of keys) {\n    const candidate = normalizeCurrencyCode(position[key]);\n    if (candidate) {\n      return candidate;\n    }\n  }\n  return fallback;\n}\n\nfunction formatPriceWithCurrency(\n  value: number | null,\n  currency: string | null,\n): string | null {\n  if (!isFiniteNumber(value)) {\n    return null;\n  }\n\n  const formatted = value.toLocaleString('de-DE', {\n    minimumFractionDigits: PRICE_FRACTION_DIGITS.min,\n    maximumFractionDigits: PRICE_FRACTION_DIGITS.max,\n  });\n  return `${formatted}${currency ? `\\u00A0${currency}` : ''}`;\n}\n\nfunction buildPurchasePriceDisplay(\n  position: PortfolioPositionRecord,\n): { markup: string; sortValue: number; ariaLabel: string } {\n  const record = position as Record<string, unknown>;\n  const averageCost = position.average_cost ?? null;\n  const aggregation = position.aggregation ?? null;\n\n  const securityCurrency = resolveCurrencyFromPosition(record, [\n    'security_currency_code',\n    'security_currency',\n    'native_currency_code',\n    'native_currency',\n  ], position.currency_code ?? null);\n\n  const accountCurrency =\n    resolveCurrencyFromPosition(record, [\n      'account_currency_code',\n      'account_currency',\n      'purchase_currency_code',\n      'currency_code',\n    ], securityCurrency === 'EUR' ? 'EUR' : null) ?? (securityCurrency === 'EUR' ? 'EUR' : null) ?? 'EUR';\n\n  const averageNative = toNullableNumber(averageCost?.native);\n  const averageSecurity = toNullableNumber(averageCost?.security);\n  const averageAccount = toNullableNumber(averageCost?.account);\n  const averageEur = toNullableNumber(averageCost?.eur);\n\n  const nativeAverage = averageSecurity ?? averageNative;\n  const eurAverage = averageEur ?? (accountCurrency === 'EUR' ? averageAccount : null);\n  const resolvedSecurityCurrency = securityCurrency ?? accountCurrency ?? 'EUR';\n  const isEurSecurity = resolvedSecurityCurrency === 'EUR';\n\n  let primaryCurrency: string | null;\n  let primaryValue: number | null;\n\n  if (!isEurSecurity) {\n    if (nativeAverage != null) {\n      primaryCurrency = resolvedSecurityCurrency;\n      primaryValue = nativeAverage;\n    } else if (averageAccount != null) {\n      primaryCurrency = accountCurrency;\n      primaryValue = averageAccount;\n    } else {\n      primaryCurrency = 'EUR';\n      primaryValue = eurAverage ?? null;\n    }\n  } else {\n    primaryCurrency = 'EUR';\n    primaryValue = eurAverage ?? nativeAverage ?? averageAccount ?? null;\n  }\n\n  const primaryText = formatPriceWithCurrency(primaryValue, primaryCurrency);\n  const formattedEur = !isEurSecurity\n    ? formatPriceWithCurrency(eurAverage, 'EUR')\n    : null;\n\n  const shouldRenderAccount =\n    !!formattedEur && formattedEur !== primaryText;\n\n  const parts: string[] = [];\n  const ariaParts: string[] = [];\n\n  if (primaryText) {\n    parts.push(\n      `<span class=\"purchase-price purchase-price--primary\">${primaryText}</span>`,\n    );\n    ariaParts.push(primaryText.replace(/\\u00A0/g, ' '));\n  } else {\n    const missing =\n      '<span class=\"missing-value\" role=\"note\" aria-label=\"Kein Kaufpreis verfügbar\" title=\"Kein Kaufpreis verfügbar\">—</span>';\n    parts.push(missing);\n    ariaParts.push('Kein Kaufpreis verfügbar');\n  }\n\n  if (shouldRenderAccount && formattedEur) {\n    parts.push(\n      `<span class=\"purchase-price purchase-price--secondary\">${formattedEur}</span>`,\n    );\n    ariaParts.push(formattedEur.replace(/\\u00A0/g, ' '));\n  }\n\n  const markup = parts.join('<br>');\n  const sortValue = toNullableNumber(aggregation?.purchase_value_eur) ?? 0;\n  const ariaLabel = ariaParts.join(', ');\n\n  return { markup, sortValue, ariaLabel };\n}\n\nexport const __TEST_ONLY__ = {\n  buildPurchasePriceDisplayForTest: buildPurchasePriceDisplay,\n};\n\n// Global cache exports have been removed; cache interactions now flow through\n// the shared data/positionsCache module.\nconst expandedPortfolios = new Set<string>();           // gemerkte geöffnete Depots (persistiert über Re-Renders)\n\n// ENTFERNT: Globaler document-Listener (Section 6 Hardening)\n// Stattdessen scoped Listener über attachPortfolioToggleHandler(root)\n\n// Rendert die Positions-Tabelle für ein Depot\n  function applyGainPctMetadata(tableEl: HTMLTableElement | null | undefined): void {\n    if (!tableEl) {\n      return;\n    }\n    const bodyRows = Array.from(tableEl.querySelectorAll<HTMLTableRowElement>('tbody tr'));\n    bodyRows.forEach(row => {\n      const gainAbsCell = row.cells.item(4);\n      const gainPctCell = row.cells.item(5);\n      if (!gainAbsCell || !gainPctCell) {\n        return;\n      }\n      if (gainAbsCell.dataset.gainPct && gainAbsCell.dataset.gainSign) {\n        return;\n      }\n      const pctText = (gainPctCell.textContent || '').trim() || '—';\n      let pctSign: 'positive' | 'negative' | 'neutral' = 'neutral';\n      if (gainPctCell.querySelector('.positive')) {\n        pctSign = 'positive';\n      } else if (gainPctCell.querySelector('.negative')) {\n        pctSign = 'negative';\n      }\n      gainAbsCell.dataset.gainPct = pctText;\n      gainAbsCell.dataset.gainSign = pctSign;\n    });\n  }\n\nfunction renderPositionsTable(positions: readonly PortfolioPositionRecord[]): string {\n  if (positions.length === 0) {\n    return '<div class=\"no-positions\">Keine Positionen vorhanden.</div>';\n  }\n  // Mapping für makeTable\n  const cols = [\n    { key: 'name', label: 'Wertpapier' },\n    { key: 'current_holdings', label: 'Bestand', align: 'right' as const },\n    { key: 'purchase_value', label: 'Ø Kaufpreis', align: 'right' as const },\n    { key: 'current_value', label: 'Aktueller Wert', align: 'right' as const },\n    { key: 'gain_abs', label: '+/-', align: 'right' as const },\n    { key: 'gain_pct', label: '%', align: 'right' as const }\n  ];\n  const rows = positions.map((p) => {\n    const performance = normalizePerformancePayload(p.performance);\n    const gainAbs = typeof performance?.gain_abs === 'number' ? performance.gain_abs : null;\n    const gainPct = typeof performance?.gain_pct === 'number' ? performance.gain_pct : null;\n\n    return {\n      name:\n          typeof p.name === 'string'\n            ? p.name\n            : typeof p.name === 'number'\n              ? String(p.name)\n              : '',\n      current_holdings:\n        typeof p.current_holdings === 'number' || typeof p.current_holdings === 'string'\n          ? p.current_holdings\n          : null,\n      purchase_value:\n        typeof p.purchase_value === 'number' || typeof p.purchase_value === 'string'\n          ? p.purchase_value\n          : null,\n      current_value:\n        typeof p.current_value === 'number' || typeof p.current_value === 'string'\n          ? p.current_value\n          : null,\n      gain_abs: gainAbs,\n      gain_pct: gainPct,\n    };\n  });\n\n  // Basis-HTML über makeTable erzeugen\n  const raw = makeTable(rows, cols, ['purchase_value', 'current_value', 'gain_abs']);\n\n  // Header um data-sort-key ergänzen + sortable Klasse setzen\n  try {\n    const tpl = document.createElement('template');\n    tpl.innerHTML = raw.trim();\n    const table = tpl.content.querySelector<HTMLTableElement>('table');\n    if (table) {\n      table.classList.add('sortable-positions');\n        const ths = Array.from(table.querySelectorAll<HTMLElement>('thead th'));\n        cols.forEach((col, i) => {\n          const th = ths.at(i);\n          if (!th) {\n            return;\n          }\n          th.setAttribute('data-sort-key', col.key);\n          th.classList.add('sortable-col');\n        });\n    const bodyRows = table.querySelectorAll<HTMLTableRowElement>('tbody tr');\n    bodyRows.forEach((tr, idx) => {\n      if (tr.classList.contains('footer-row')) {\n        return;\n      }\n      if (idx >= positions.length) {\n        return;\n      }\n      const pos = positions[idx];\n      const securityUuid = typeof pos.security_uuid === 'string' ? pos.security_uuid : null;\n      if (securityUuid) {\n        tr.dataset.security = securityUuid;\n      }\n          tr.classList.add('position-row');\n          const purchaseCell = tr.cells.item(2);\n        if (purchaseCell) {\n          const { markup, sortValue, ariaLabel } = buildPurchasePriceDisplay(pos);\n          purchaseCell.innerHTML = markup;\n          purchaseCell.dataset.sortValue = String(sortValue);\n          if (ariaLabel) {\n            purchaseCell.setAttribute('aria-label', ariaLabel);\n          } else {\n            purchaseCell.removeAttribute('aria-label');\n          }\n        }\n          const gainCell = tr.cells.item(4);\n        if (gainCell) {\n          const performance = normalizePerformancePayload(pos.performance);\n          const gainPctValue =\n            typeof performance?.gain_pct === 'number' && Number.isFinite(performance.gain_pct)\n              ? performance.gain_pct\n              : null;\n          const pctLabel =\n            gainPctValue != null\n              ? `${gainPctValue.toLocaleString('de-DE', {\n                  minimumFractionDigits: 2,\n                  maximumFractionDigits: 2,\n                })} %`\n              : '—';\n          const pctSign =\n            gainPctValue == null\n              ? 'neutral'\n              : gainPctValue > 0\n                ? 'positive'\n                : gainPctValue < 0\n                  ? 'negative'\n                  : 'neutral';\n          gainCell.dataset.gainPct = pctLabel;\n          gainCell.dataset.gainSign = pctSign;\n        }\n          const gainPctCell = tr.cells.item(5);\n        if (gainPctCell) {\n          gainPctCell.classList.add('gain-pct-cell');\n        }\n      });\n      // Default-Sortierung (nach Name asc) – bereits durch SQL geliefert, aber markieren\n      table.dataset.defaultSort = 'name';\n      table.dataset.defaultDir = 'asc';\n      applyGainPctMetadata(table);\n      return table.outerHTML;\n    }\n  } catch (e) {\n    // Fallback: unverändertes Markup\n    console.warn(\"renderPositionsTable: Konnte Sortier-Metadaten nicht injizieren:\", e);\n  }\n  return raw;\n}\n\n// NEU: Export / Global bereitstellen für Push-Handler (Konsistenz Push vs Lazy)\nexport function renderPortfolioPositions(\n  positions: readonly (PortfolioPositionRecord | Record<string, unknown>)[] | null | undefined,\n): string {\n  const normalized = normalizePositionRecords(positions ?? []);\n  return renderPositionsTable(normalized);\n}\n\nfunction attachSecurityDetailDelegation(root: PortfolioQueryRoot, portfolioUuid: string): void {\n  if (!portfolioUuid) return;\n  const detailsRow = root.querySelector<HTMLTableRowElement>(\n    `.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`,\n  );\n  if (!detailsRow) return;\n    const container = detailsRow.querySelector<ToggleContainerElement>('.positions-container');\n    if (!container) return;\n    if (container.__ppReaderSecurityClickBound) return;\n\n    container.__ppReaderSecurityClickBound = true;\n\n  container.addEventListener('click', (event: MouseEvent) => {\n    const target = event.target;\n    if (!(target instanceof Element)) {\n      return;\n    }\n\n    const interactive = target.closest('button, a');\n    if (interactive && container.contains(interactive)) {\n      return;\n    }\n\n    const row = target.closest<HTMLTableRowElement>('tr[data-security]');\n    if (!row || !container.contains(row)) {\n      return;\n    }\n\n    const securityUuid = row.getAttribute('data-security');\n    if (!securityUuid) {\n      return;\n    }\n\n    try {\n      const opened = openSecurityDetail(securityUuid);\n      if (!opened) {\n        console.warn('attachSecurityDetailDelegation: Detail-Tab konnte nicht geöffnet werden für', securityUuid);\n      }\n    } catch (err) {\n      console.error('attachSecurityDetailDelegation: Fehler beim Öffnen des Detail-Tabs', err);\n    }\n  });\n}\n\nexport function attachSecurityDetailListener(root: PortfolioQueryRoot, portfolioUuid: string): void {\n  attachSecurityDetailDelegation(root, portfolioUuid);\n}\n\n// (1) Entferne evtl. doppelte frühere Definitionen von buildExpandablePortfolioTable – nur diese Version behalten\nfunction buildExpandablePortfolioTable(depots: readonly PortfolioOverviewRow[]): string {\n  console.debug('buildExpandablePortfolioTable: render', depots.length, 'portfolios');\n    const escapeAttribute = (value: unknown): string => {\n      if (value == null) {\n        return '';\n      }\n      if (typeof value !== 'string' && typeof value !== 'number' && typeof value !== 'boolean') {\n        return '';\n      }\n      return String(value)\n        .replace(/&/g, '&amp;')\n        .replace(/\"/g, '&quot;');\n    };\n\n  let html = '<table class=\"expandable-portfolio-table\"><thead><tr>';\n  const cols = [\n    { key: 'name', label: 'Name' },\n    { key: 'position_count', label: 'Anzahl Positionen', align: 'right' },\n    { key: 'current_value', label: 'Aktueller Wert', align: 'right' },\n    { key: 'gain_abs', label: 'Gesamt +/-', align: 'right' },\n    { key: 'gain_pct', label: '%', align: 'right' }\n  ];\n  cols.forEach(c => {\n    const align = c.align === 'right' ? ' class=\"align-right\"' : '';\n    html += `<th${align}>${c.label}</th>`;\n  });\n  html += '</tr></thead><tbody>';\n\n    depots.forEach(d => {\n      const positionCount = Number.isFinite(d.position_count) ? d.position_count : 0;\n      const purchaseSum = Number.isFinite(d.purchase_sum) ? d.purchase_sum : 0;\n      const currentValue =\n        d.hasValue && typeof d.current_value === 'number' && Number.isFinite(d.current_value)\n          ? d.current_value\n          : null;\n      const hasValue = currentValue !== null;\n    const performance = d.performance;\n    const gainAbs =\n      typeof d.gain_abs === 'number'\n        ? d.gain_abs\n        : typeof performance?.gain_abs === 'number'\n          ? performance.gain_abs\n          : null;\n    const gainPct =\n      typeof d.gain_pct === 'number'\n        ? d.gain_pct\n        : typeof performance?.gain_pct === 'number'\n          ? performance.gain_pct\n          : null;\n    const partialValue = d.fx_unavailable && hasValue;\n    const datasetCoverageRatio =\n      typeof d.coverage_ratio === 'number' && Number.isFinite(d.coverage_ratio)\n        ? d.coverage_ratio\n        : '';\n    const datasetProvenance = typeof d.provenance === 'string' ? d.provenance : '';\n    const datasetMetricRunUuid =\n      typeof d.metric_run_uuid === 'string' ? d.metric_run_uuid : '';\n\n    const expanded = expandedPortfolios.has(d.uuid);\n    const toggleClass = expanded ? 'portfolio-toggle expanded' : 'portfolio-toggle';\n    const detailId = `portfolio-details-${d.uuid}`;\n    const rowData = {\n      fx_unavailable: d.fx_unavailable,\n      current_value: currentValue,\n      gain_abs: gainAbs,\n      gain_pct: gainPct\n    };\n    const valueContext = { hasValue };\n    const currentValueCell = formatValue('current_value', rowData.current_value, rowData, valueContext);\n    const gainAbsCell = formatValue('gain_abs', rowData.gain_abs, rowData, valueContext);\n    const gainPctCell = formatValue('gain_pct', rowData.gain_pct, rowData, valueContext);\n\n    const gainPctLabel = hasValue && typeof gainPct === 'number' && Number.isFinite(gainPct)\n      ? `${formatNumber(gainPct)} %`\n      : '';\n    const gainPctSign = hasValue && typeof gainPct === 'number' && Number.isFinite(gainPct)\n      ? (gainPct > 0 ? 'positive' : gainPct < 0 ? 'negative' : 'neutral')\n      : '';\n\n      const datasetCurrentValue = hasValue && typeof currentValue === 'number' && Number.isFinite(currentValue)\n        ? currentValue\n        : '';\n      const datasetGainAbs = hasValue && typeof gainAbs === 'number' && Number.isFinite(gainAbs) ? gainAbs : '';\n      const datasetGainPct = hasValue && typeof gainPct === 'number' && Number.isFinite(gainPct) ? gainPct : '';\n      const positionCountAttr = String(positionCount);\n\n    let gainAbsAttributes = '';\n    if (gainPctLabel) {\n      gainAbsAttributes = ` data-gain-pct=\"${escapeAttribute(gainPctLabel)}\" data-gain-sign=\"${escapeAttribute(gainPctSign)}\"`;\n    }\n    if (partialValue) {\n      gainAbsAttributes += ' data-partial=\"true\"';\n    }\n\n      html += `<tr class=\"portfolio-row\"\n                  data-portfolio=\"${d.uuid}\"\n                  data-position-count=\"${positionCountAttr}\"\n                  data-current-value=\"${escapeAttribute(datasetCurrentValue)}\"\n                  data-purchase-sum=\"${escapeAttribute(purchaseSum)}\"\n                  data-gain-abs=\"${escapeAttribute(datasetGainAbs)}\"\n                data-gain-pct=\"${escapeAttribute(datasetGainPct)}\"\n                data-has-value=\"${hasValue ? 'true' : 'false'}\"\n                data-fx-unavailable=\"${d.fx_unavailable ? 'true' : 'false'}\"\n                data-coverage-ratio=\"${escapeAttribute(datasetCoverageRatio)}\"\n                data-provenance=\"${escapeAttribute(datasetProvenance)}\"\n                data-metric-run-uuid=\"${escapeAttribute(datasetMetricRunUuid)}\">`;\n    const safeName = escapeHtml(d.name);\n    const badgeMarkup = renderBadgeList(d.badges, { containerClass: 'portfolio-badges' });\n    html += `<td>\n        <button type=\"button\"\n                class=\"${toggleClass}\"\n                data-portfolio=\"${d.uuid}\"\n                aria-expanded=\"${expanded ? 'true' : 'false'}\"\n                aria-controls=\"${detailId}\">\n          <span class=\"caret\">${expanded ? '▼' : '▶'}</span>\n          <span class=\"portfolio-name\">${safeName}</span>${badgeMarkup}\n        </button>\n      </td>`;\n      const positionCountDisplay = positionCount.toLocaleString('de-DE');\n      html += `<td class=\"align-right\">${positionCountDisplay}</td>`;\n    html += `<td class=\"align-right\">${currentValueCell}</td>`;\n    html += `<td class=\"align-right\"${gainAbsAttributes}>${gainAbsCell}</td>`;\n    html += `<td class=\"align-right gain-pct-cell\">${gainPctCell}</td>`;\n    html += '</tr>';\n\n    html += `<tr class=\"portfolio-details${expanded ? '' : ' hidden'}\"\n                data-portfolio=\"${d.uuid}\"\n                id=\"${detailId}\"\n                role=\"region\"\n                aria-label=\"Positionen für ${d.name}\">\n      <td colspan=\"5\">\n        <div class=\"positions-container\">${expanded\n        ? (hasPortfolioPositions(d.uuid)\n          ? renderPositionsTable(getPortfolioPositions(d.uuid))\n          : '<div class=\\\"loading\\\">Lade Positionen...</div>')\n        : ''\n      }</div>\n      </td>\n    </tr>`;\n  });\n\n    const availableDepots = depots.filter(d => typeof d.current_value === 'number' && Number.isFinite(d.current_value));\n    const sumPositions = depots.reduce((a, d) => a + (Number.isFinite(d.position_count) ? d.position_count : 0), 0);\n  const sumCurrent = availableDepots.reduce((a, d) => {\n    if (typeof d.current_value === 'number' && Number.isFinite(d.current_value)) {\n      return a + d.current_value;\n    }\n    return a;\n  }, 0);\n  const sumPurchase = availableDepots.reduce((a, d) => {\n    if (typeof d.purchase_sum === 'number' && Number.isFinite(d.purchase_sum)) {\n      return a + d.purchase_sum;\n    }\n    return a;\n  }, 0);\n  const sumGainAbs = availableDepots.reduce((a, d) => {\n    if (typeof d.performance?.gain_abs === 'number' && Number.isFinite(d.performance.gain_abs)) {\n      return a + d.performance.gain_abs;\n    }\n    const current = typeof d.current_value === 'number' && Number.isFinite(d.current_value) ? d.current_value : 0;\n    const purchase = typeof d.purchase_sum === 'number' && Number.isFinite(d.purchase_sum) ? d.purchase_sum : 0;\n    return a + (current - purchase);\n  }, 0);\n  const sumHasValue = availableDepots.length > 0;\n  const sumIsPartial = availableDepots.length !== depots.length;\n  const sumGainPct = sumHasValue && sumPurchase > 0 ? (sumGainAbs / sumPurchase) * 100 : null;\n\n  const sumRowData = {\n    fx_unavailable: sumIsPartial,\n    current_value: sumHasValue ? sumCurrent : null,\n    gain_abs: sumHasValue ? sumGainAbs : null,\n    gain_pct: sumHasValue ? sumGainPct : null\n  };\n  const sumContext = { hasValue: sumHasValue };\n  const sumCurrentCell = formatValue('current_value', sumRowData.current_value, sumRowData, sumContext);\n  const sumGainAbsCell = formatValue('gain_abs', sumRowData.gain_abs, sumRowData, sumContext);\n  const sumGainPctCell = formatValue('gain_pct', sumRowData.gain_pct, sumRowData, sumContext);\n\n  let sumGainAbsAttributes = '';\n  if (sumHasValue && typeof sumGainPct === 'number' && Number.isFinite(sumGainPct)) {\n    const sumGainPctLabel = `${formatNumber(sumGainPct)} %`;\n    const sumGainPctSign = sumGainPct > 0 ? 'positive' : sumGainPct < 0 ? 'negative' : 'neutral';\n    sumGainAbsAttributes = ` data-gain-pct=\"${escapeAttribute(sumGainPctLabel)}\" data-gain-sign=\"${escapeAttribute(sumGainPctSign)}\"`;\n  }\n  if (sumIsPartial) {\n    sumGainAbsAttributes += ' data-partial=\"true\"';\n  }\n\n    const sumPositionAttr = String(Math.round(sumPositions));\n    const sumCurrentAttr = sumHasValue ? String(sumCurrent) : '';\n    const sumPurchaseAttr = sumHasValue ? String(sumPurchase) : '';\n    const sumGainAbsAttr = sumHasValue ? String(sumGainAbs) : '';\n    const sumGainPctAttr = sumHasValue && typeof sumGainPct === 'number' && Number.isFinite(sumGainPct)\n      ? String(sumGainPct)\n      : '';\n\n    html += `<tr class=\"footer-row\"\n      data-position-count=\"${sumPositionAttr}\"\n      data-current-value=\"${escapeAttribute(sumCurrentAttr)}\"\n      data-purchase-sum=\"${escapeAttribute(sumPurchaseAttr)}\"\n      data-gain-abs=\"${escapeAttribute(sumGainAbsAttr)}\"\n      data-gain-pct=\"${escapeAttribute(sumGainPctAttr)}\"\n      data-has-value=\"${sumHasValue ? 'true' : 'false'}\"\n      data-fx-unavailable=\"${sumIsPartial ? 'true' : 'false'}\">\n      <td>Summe</td>\n      <td class=\"align-right\">${Math.round(sumPositions).toLocaleString('de-DE')}</td>\n    <td class=\"align-right\">${sumCurrentCell}</td>\n    <td class=\"align-right\"${sumGainAbsAttributes}>${sumGainAbsCell}</td>\n    <td class=\"align-right gain-pct-cell\">${sumGainPctCell}</td>\n  </tr>`;\n\n  html += '</tbody></table>';\n  return html;\n}\n\nfunction resolvePortfolioTable(target: Element | PortfolioQueryRoot | null | undefined): HTMLTableElement | null {\n  if (target instanceof HTMLTableElement) {\n    return target;\n  }\n  if (target && 'querySelector' in target) {\n    const scoped = (target as ParentNode).querySelector<HTMLTableElement>('table.expandable-portfolio-table');\n    if (scoped) {\n      return scoped;\n    }\n    const nested = (target as ParentNode).querySelector<HTMLTableElement>('.portfolio-table table');\n    if (nested) {\n      return nested;\n    }\n    const generic = (target as ParentNode).querySelector<HTMLTableElement>('table');\n    if (generic) {\n      return generic;\n    }\n  }\n  return document.querySelector<HTMLTableElement>('.portfolio-table table.expandable-portfolio-table') ||\n    document.querySelector<HTMLTableElement>('.portfolio-table table');\n}\n\nfunction readDatasetNumber(value: string | undefined): number | null {\n  if (value === undefined) {\n    return null;\n  }\n  const num = Number(value);\n  return Number.isFinite(num) ? num : null;\n}\n\nexport function updatePortfolioFooterFromDom(target: Element | PortfolioQueryRoot | null | undefined): void {\n    const table = resolvePortfolioTable(target);\n    if (!table) {\n      return;\n    }\n    const tbody = table.tBodies.item(0);\n  if (!tbody) {\n    return;\n  }\n  const rows = Array.from(tbody.querySelectorAll<HTMLTableRowElement>('tr.portfolio-row'));\n  if (!rows.length) {\n    return;\n  }\n\n  let sumPositions = 0;\n  let sumCurrent = 0;\n  let sumPurchase = 0;\n  let sumGainAbs = 0;\n  let hasValueRow = false;\n  let allRowsComplete = true;\n  let fxUnavailable = false;\n\n  for (const row of rows) {\n    const posCount = readDatasetNumber(row.dataset.positionCount);\n    if (posCount != null) {\n      sumPositions += posCount;\n    }\n\n    if (row.dataset.fxUnavailable === 'true') {\n      fxUnavailable = true;\n    }\n\n    const hasValueAttr = row.dataset.hasValue;\n    const hasValue = !(hasValueAttr === 'false' || hasValueAttr === '0' || hasValueAttr === '' || hasValueAttr == null);\n    if (!hasValue) {\n      allRowsComplete = false;\n      continue;\n    }\n\n    hasValueRow = true;\n\n    const currentValue = readDatasetNumber(row.dataset.currentValue);\n    const gainAbs = readDatasetNumber(row.dataset.gainAbs);\n    const purchaseSum = readDatasetNumber(row.dataset.purchaseSum);\n\n    if (currentValue == null || gainAbs == null || purchaseSum == null) {\n      allRowsComplete = false;\n      continue;\n    }\n\n    sumCurrent += currentValue;\n    sumGainAbs += gainAbs;\n    sumPurchase += purchaseSum;\n  }\n\n  const totalsComplete = hasValueRow && allRowsComplete;\n  const sumGainPct = totalsComplete && sumPurchase > 0 ? (sumGainAbs / sumPurchase) * 100 : null;\n\n  let footer = Array.from(tbody.children).find((child): child is HTMLTableRowElement =>\n    child instanceof HTMLTableRowElement && child.classList.contains('footer-row')\n  );\n  if (!footer) {\n    footer = document.createElement('tr');\n    footer.classList.add('footer-row');\n    tbody.appendChild(footer);\n  }\n\n  const sumPositionsDisplay = Math.round(sumPositions).toLocaleString('de-DE');\n\n  const footerRowData = {\n    fx_unavailable: fxUnavailable || !totalsComplete,\n    current_value: totalsComplete ? sumCurrent : null,\n    gain_abs: totalsComplete ? sumGainAbs : null,\n    gain_pct: totalsComplete ? sumGainPct : null,\n  };\n  const footerContext = { hasValue: totalsComplete };\n\n  const currentValueHtml = formatValue('current_value', footerRowData.current_value, footerRowData, footerContext);\n  const gainAbsHtml = formatValue('gain_abs', footerRowData.gain_abs, footerRowData, footerContext);\n  const gainPctHtml = formatValue('gain_pct', footerRowData.gain_pct, footerRowData, footerContext);\n\n    footer.innerHTML = `\n      <td>Summe</td>\n      <td class=\"align-right\">${sumPositionsDisplay}</td>\n      <td class=\"align-right\">${currentValueHtml}</td>\n      <td class=\"align-right\">${gainAbsHtml}</td>\n      <td class=\"align-right\">${gainPctHtml}</td>\n    `;\n    const footerGainAbsCell = footer.cells.item(3);\n  if (footerGainAbsCell) {\n    footerGainAbsCell.dataset.gainPct = totalsComplete && typeof sumGainPct === 'number'\n      ? `${formatNumber(sumGainPct)} %`\n      : '—';\n    footerGainAbsCell.dataset.gainSign = totalsComplete && typeof sumGainPct === 'number'\n      ? (sumGainPct > 0 ? 'positive' : sumGainPct < 0 ? 'negative' : 'neutral')\n      : 'neutral';\n  }\n  footer.dataset.positionCount = String(Math.round(sumPositions));\n  footer.dataset.currentValue = totalsComplete ? String(sumCurrent) : '';\n  footer.dataset.purchaseSum = totalsComplete ? String(sumPurchase) : '';\n  footer.dataset.gainAbs = totalsComplete ? String(sumGainAbs) : '';\n  footer.dataset.gainPct = totalsComplete && typeof sumGainPct === 'number' ? String(sumGainPct) : '';\n  footer.dataset.hasValue = totalsComplete ? 'true' : 'false';\n  footer.dataset.fxUnavailable = fxUnavailable ? 'true' : 'false';\n}\n\n/**\n * Utility-Funktionen zum Auslesen und Wiederherstellen des Expand-States.\n * Perspektivisch nutzbar, falls ein vollständiger Neu-Render (Hard Refresh) der\n * Depot-Tabelle nötig wird (z.B. beim späteren Hinzufügen von Filter-/Sortierlogik).\n */\nexport function getExpandedPortfolios(): string[] {\n  // Primär DOM lesen (falls Tabelle gerendert), Fallback: interner Set\n  const domRows = Array.from(\n    document.querySelectorAll<HTMLTableRowElement>('.portfolio-details:not(.hidden)[data-portfolio]'),\n  );\n  if (domRows.length) {\n    return domRows\n      .map((row) => row.getAttribute('data-portfolio'))\n      .filter((value): value is string => Boolean(value));\n  }\n  return Array.from(expandedPortfolios.values());\n}\n\nexport function setExpandedPortfolios(portfolioIds: Array<string | null | undefined> | null | undefined): void {\n  expandedPortfolios.clear();\n  if (Array.isArray(portfolioIds)) {\n    portfolioIds.forEach(id => {\n      if (id) {\n        expandedPortfolios.add(id);\n      }\n    });\n  }\n}\n\n// NEU: Helper zum Anhängen der Sortier-Logik an eine Positions-Tabelle eines bestimmten Portfolios\nexport function attachPortfolioPositionsSorting(root: PortfolioQueryRoot, portfolioUuid: string): void {\n  if (!portfolioUuid) return;\n  const detailsRow = root.querySelector<HTMLTableRowElement>(\n    `.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`,\n  );\n  if (!detailsRow) return;\n    const container = detailsRow.querySelector<ToggleContainerElement>('.positions-container');\n    if (!container) return;\n    const table = container.querySelector<SortableTableElement>('table.sortable-positions');\n  if (!table || table.__ppReaderSortingBound) return;\n\n  table.__ppReaderSortingBound = true;\n\n  const applySort = (\n    key: PortfolioPositionsSortKey,\n    dir: PortfolioSortDirection,\n  ): void => {\n    const tbody = table.querySelector<HTMLTableSectionElement>('tbody');\n    if (!tbody) return;\n    const rows = Array.from(tbody.querySelectorAll<HTMLTableRowElement>('tr'))\n      .filter(r => !r.classList.contains('footer-row'));\n    const footer = tbody.querySelector<HTMLTableRowElement>('tr.footer-row');\n\n    const parseNum = (txt: string | null | undefined): number => {\n      if (txt == null) return 0;\n      // Entferne Währungs-/Prozent-Symbole, geschützte Leerzeichen\n      const cleaned = txt\n        .replace(/\\u00A0/g, ' ')\n        .replace(/[%€]/g, '')\n        .replace(/\\./g, '')\n        .replace(',', '.')\n        .replace(/[^\\d.-]/g, '');\n      const numeric = Number.parseFloat(cleaned);\n      return Number.isFinite(numeric) ? numeric : 0;\n    };\n\n    rows.sort((a, b) => {\n        const idxMap: Record<PortfolioPositionsSortKey, number> = {\n          name: 0,\n          current_holdings: 1,\n          purchase_value: 2,\n          current_value: 3,\n          gain_abs: 4,\n          gain_pct: 5,\n        };\n        const colIdx = idxMap[key];\n          const aCellEl = a.cells.item(colIdx);\n          const bCellEl = b.cells.item(colIdx);\n\n        let aCell = '';\n        if (aCellEl) {\n          const raw = aCellEl.textContent;\n          if (typeof raw === 'string') {\n            aCell = raw.trim();\n          }\n        }\n\n        let bCell = '';\n        if (bCellEl) {\n          const raw = bCellEl.textContent;\n          if (typeof raw === 'string') {\n            bCell = raw.trim();\n          }\n        }\n\n          const resolveSortValue = (\n            cell: HTMLTableCellElement | null | undefined,\n            text: string,\n          ): number => {\n            const sortAttr = cell ? cell.dataset.sortValue : undefined;\n            if (sortAttr != null && sortAttr !== '') {\n              const numericAttr = Number(sortAttr);\n              if (Number.isFinite(numericAttr)) {\n                return numericAttr;\n              }\n            }\n            return parseNum(text);\n          };\n\n      let comp: number;\n      if (key === 'name') {\n        comp = aCell.localeCompare(bCell, 'de', { sensitivity: 'base' });\n      } else {\n        const aValue = resolveSortValue(aCellEl, aCell);\n        const bValue = resolveSortValue(bCellEl, bCell);\n        comp = aValue - bValue;\n      }\n      return dir === 'asc' ? comp : -comp;\n    });\n\n    // Visuelle Indikatoren zurücksetzen\n    table.querySelectorAll('thead th.sort-active').forEach(th => {\n      th.classList.remove('sort-active', 'dir-asc', 'dir-desc');\n    });\n\n    // Aktives TH markieren\n    const th = table.querySelector<HTMLElement>(`thead th[data-sort-key=\"${key}\"]`);\n    if (th) {\n      th.classList.add('sort-active', dir === 'asc' ? 'dir-asc' : 'dir-desc');\n    }\n\n    // Neu einfügen\n    rows.forEach(r => tbody.appendChild(r));\n    if (footer) tbody.appendChild(footer);\n  };\n\n  // Initial ggf. gespeicherten Zustand anwenden\n  const containerKey = container.dataset.sortKey;\n  const containerDir = container.dataset.sortDir;\n  const defaultKey = table.dataset.defaultSort;\n  const defaultDir = table.dataset.defaultDir;\n\n  const currentKey = isPortfolioPositionsSortKey(containerKey)\n    ? containerKey\n    : isPortfolioPositionsSortKey(defaultKey)\n      ? defaultKey\n      : 'name';\n  const currentDir = isPortfolioSortDirection(containerDir)\n    ? containerDir\n    : isPortfolioSortDirection(defaultDir)\n      ? defaultDir\n      : 'asc';\n\n  applySort(currentKey, currentDir);\n\n  table.addEventListener('click', (event: MouseEvent) => {\n    const target = event.target;\n    if (!(target instanceof Element)) {\n      return;\n    }\n    const th = target.closest('th[data-sort-key]');\n    if (!th || !table.contains(th)) return;\n    const keyAttr = th.getAttribute('data-sort-key');\n    if (!isPortfolioPositionsSortKey(keyAttr)) {\n      return;\n    }\n\n    let dir: PortfolioSortDirection = 'asc';\n    if (container.dataset.sortKey === keyAttr) {\n      const existing = isPortfolioSortDirection(container.dataset.sortDir)\n        ? container.dataset.sortDir\n        : 'asc';\n      dir = existing === 'asc' ? 'desc' : 'asc';\n    }\n    container.dataset.sortKey = keyAttr;\n    container.dataset.sortDir = dir;\n    applySort(keyAttr, dir);\n  });\n}\n\n// NEU: Funktion zum erneuten Laden der Positionsdaten\nasync function reloadPortfolioPositions(\n  portfolioUuid: string,\n  containerEl: HTMLElement | null | undefined,\n  root: HTMLElement,\n): Promise<void> {\n  if (!portfolioUuid || !_hassRef || !_panelConfigRef) return;\n\n  const targetContainer = containerEl || root.querySelector<HTMLElement>(\n    `.portfolio-details[data-portfolio=\"${portfolioUuid}\"] .positions-container`\n  );\n  if (!targetContainer) {\n    return;\n  }\n\n  const detailsRow = targetContainer.closest<HTMLTableRowElement>('.portfolio-details');\n  if (detailsRow && detailsRow.classList.contains('hidden')) {\n    return; // Hidden Rows sollen keinen Silent-Preload anstoßen\n  }\n\n  targetContainer.innerHTML = '<div class=\"loading\">Neu laden...</div>';\n  try {\n    const resp: PortfolioPositionsResponse = await fetchPortfolioPositionsWS(\n      _hassRef,\n      _panelConfigRef,\n      portfolioUuid,\n    );\n    if (resp.error) {\n      const errorText = typeof resp.error === 'string' ? resp.error : String(resp.error);\n      targetContainer.innerHTML = `<div class=\"error\">${errorText} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n      return;\n    }\n    const normalizedPositions = normalizePositionRecords(\n      Array.isArray(resp.positions) ? resp.positions : [],\n    );\n    setPortfolioPositions(portfolioUuid, normalizedPositions);\n    setPortfolioPositionsSnapshot(portfolioUuid, normalizedPositions);\n    targetContainer.innerHTML = renderPositionsTable(normalizedPositions);\n    // Änderung 11: Nach erstmaligem Lazy-Load Sortierung initialisieren\n    try {\n      attachPortfolioPositionsSorting(root, portfolioUuid);\n    } catch (error) {\n      console.warn('attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:', error);\n    }\n    try {\n      attachSecurityDetailListener(root, portfolioUuid);\n    } catch (error) {\n      console.warn('reloadPortfolioPositions: Security-Listener konnte nicht gebunden werden:', error);\n    }\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    targetContainer.innerHTML = `<div class=\"error\">Fehler: ${message} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Retry</button></div>`;\n  }\n}\n\n// Hilfsfunktion: wartet bis ein Selektor im root existiert\nasync function waitForElement<T extends Element>(\n  root: HTMLElement,\n  selector: string,\n  timeoutMs = 3000,\n  intervalMs = 50,\n): Promise<T | null> {\n  const start = performance.now();\n  return new Promise((resolve) => {\n    const tick = () => {\n      const el = root.querySelector<T>(selector);\n      if (el) {\n        resolve(el);\n        return;\n      }\n      if (performance.now() - start > timeoutMs) {\n        resolve(null);\n        return;\n      }\n      setTimeout(tick, intervalMs);\n    };\n    tick();\n  });\n}\n\n  export function attachPortfolioToggleHandler(root: ToggleRootElement): void {\n    const previousToken = typeof root.__ppReaderAttachToken === 'number' ? root.__ppReaderAttachToken : 0;\n    const token = previousToken + 1;\n  root.__ppReaderAttachToken = token;\n  root.__ppReaderAttachInProgress = true;\n\n    void (async () => {\n    try {\n        const container = await waitForElement<ToggleContainerElement>(root, '.portfolio-table');\n      if (token !== root.__ppReaderAttachToken) {\n        return; // Ein neuer Versuch läuft bereits – diesen abbrechen\n      }\n      if (!container) {\n        console.warn(\"attachPortfolioToggleHandler: .portfolio-table nicht gefunden (Timeout)\");\n        return;\n      }\n\n      // Buttons generiert?\n      const btnCount = container.querySelectorAll('.portfolio-toggle').length;\n      if (btnCount === 0) {\n        console.debug(\"attachPortfolioToggleHandler: Noch keine Buttons – evtl. Recovery später\");\n      }\n\n        if (container.__ppReaderPortfolioToggleBound) {\n          return;\n        }\n        container.__ppReaderPortfolioToggleBound = true;\n      console.debug(\"attachPortfolioToggleHandler: Listener registriert\");\n\n      container.addEventListener('click', (event: MouseEvent) => {\n        void (async () => {\n          try {\n            const target = event.target;\n            if (!(target instanceof Element)) {\n              return;\n            }\n\n              const retryBtn = target.closest<HTMLButtonElement>('.retry-pos');\n            if (retryBtn && container.contains(retryBtn)) {\n              const pid = retryBtn.getAttribute('data-portfolio');\n              if (pid) {\n                const detailsRow = root.querySelector<HTMLTableRowElement>(\n                  `.portfolio-details[data-portfolio=\"${pid}\"]`,\n                );\n                const cont = detailsRow?.querySelector<ToggleContainerElement>('.positions-container');\n                await reloadPortfolioPositions(pid, cont ?? null, root);\n              }\n              return;\n            }\n\n            const btn = target.closest<HTMLButtonElement>('.portfolio-toggle');\n            if (!btn || !container.contains(btn)) return;\n\n            const portfolioUuid = btn.getAttribute('data-portfolio');\n            if (!portfolioUuid) return;\n\n              const detailsRow = root.querySelector<HTMLTableRowElement>(\n              `.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`,\n            );\n            if (!detailsRow) return;\n\n            const caretEl = btn.querySelector<HTMLElement>('.caret');\n            const isHidden = detailsRow.classList.contains('hidden');\n\n            if (isHidden) {\n              detailsRow.classList.remove('hidden');\n              btn.classList.add('expanded');\n              btn.setAttribute('aria-expanded', 'true');\n              if (caretEl) caretEl.textContent = '▼';\n              expandedPortfolios.add(portfolioUuid);\n\n              try {\n                flushPendingPositions(root, portfolioUuid);\n              } catch (error) {\n                console.warn('attachPortfolioToggleHandler: Pending-Flush fehlgeschlagen:', error);\n              }\n\n              if (!hasPortfolioPositions(portfolioUuid)) {\n                const containerEl = detailsRow.querySelector<ToggleContainerElement>('.positions-container');\n                if (containerEl) {\n                  containerEl.innerHTML = '<div class=\"loading\">Lade Positionen...</div>';\n                }\n                try {\n                  const resp: PortfolioPositionsResponse = await fetchPortfolioPositionsWS(\n                    _hassRef,\n                    _panelConfigRef,\n                    portfolioUuid,\n                  );\n                  if (resp.error) {\n                    const errorText = typeof resp.error === 'string' ? resp.error : String(resp.error);\n                    if (containerEl) {\n                      containerEl.innerHTML = `<div class=\"error\">${errorText} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n                    }\n                    return;\n                  }\n                  const normalizedPositions = normalizePositionRecords(\n                    Array.isArray(resp.positions) ? resp.positions : [],\n                  );\n                  setPortfolioPositions(portfolioUuid, normalizedPositions);\n                  setPortfolioPositionsSnapshot(\n                    portfolioUuid,\n                    normalizedPositions,\n                  );\n                  if (containerEl) {\n                    containerEl.innerHTML = renderPositionsTable(normalizedPositions);\n                    // Änderung 11: Nach erstmaligem Lazy-Load Sortierung initialisieren\n                    try {\n                      attachPortfolioPositionsSorting(root, portfolioUuid);\n                    } catch (error) {\n                      console.warn('attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:', error);\n                    }\n                    try {\n                      attachSecurityDetailListener(root, portfolioUuid);\n                    } catch (error) {\n                      console.warn('attachPortfolioToggleHandler: Security-Listener konnte nicht gebunden werden:', error);\n                    }\n                  }\n                } catch (error) {\n                  const message = error instanceof Error ? error.message : String(error);\n                  const containerEl = detailsRow.querySelector<ToggleContainerElement>('.positions-container');\n                  if (containerEl) {\n                    containerEl.innerHTML = `<div class=\"error\">Fehler beim Laden: ${message} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Retry</button></div>`;\n                  }\n                  console.error('Fehler beim Lazy Load für', portfolioUuid, error);\n                }\n              } else {\n                const containerEl = detailsRow.querySelector<HTMLElement>('.positions-container');\n                if (containerEl) {\n                  containerEl.innerHTML = renderPositionsTable(\n                    getPortfolioPositions(portfolioUuid),\n                  );\n                  attachPortfolioPositionsSorting(root, portfolioUuid);\n                  try {\n                    attachSecurityDetailListener(root, portfolioUuid);\n                  } catch (error) {\n                    console.warn('attachPortfolioToggleHandler: Security-Listener (Cache) Fehler:', error);\n                  }\n                }\n              }\n            } else {\n              detailsRow.classList.add('hidden');\n              btn.classList.remove('expanded');\n              btn.setAttribute('aria-expanded', 'false');\n              if (caretEl) caretEl.textContent = '▶';\n              expandedPortfolios.delete(portfolioUuid);\n            }\n            } catch (error) {\n              console.error('attachPortfolioToggleHandler: Ungefangener Fehler im Click-Handler', error);\n            }\n        })();\n      });\n    } finally {\n      if (token === root.__ppReaderAttachToken) {\n        root.__ppReaderAttachInProgress = false;\n      }\n    }\n    })();\n}\n\n// Fallback: direkter Listener auf die Tabelle selbst (falls outer container nicht klickt)\n  export function ensurePortfolioRowFallbackListener(root: ToggleRootElement): void {\n    const table = root.querySelector<SortableTableElement>('.expandable-portfolio-table');\n    if (!table) return;\n    if (table.__ppReaderPortfolioFallbackBound) return;\n    table.__ppReaderPortfolioFallbackBound = true;\n  table.addEventListener('click', (event: MouseEvent) => {\n    const target = event.target;\n    if (!(target instanceof Element)) {\n      return;\n    }\n    const btn = target.closest<HTMLButtonElement>('.portfolio-toggle');\n    if (!btn) return;\n    // Falls der Haupt-Listener schon aktiv war, nichts doppelt machen\n      const primaryContainer = root.querySelector<ToggleContainerElement>('.portfolio-table');\n    if (primaryContainer?.__ppReaderPortfolioToggleBound) return;\n    console.debug('Fallback-Listener aktiv – re-attach Hauptlistener');\n    attachPortfolioToggleHandler(root);\n  });\n}\n\nexport async function renderDashboard(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<string> {\n  _hassRef = hass ?? null;\n  _panelConfigRef = panelConfig ?? null;\n  console.debug(\n    'renderDashboard: start – panelConfig:',\n    panelConfig?.config,\n    'derived entry_id?',\n    panelConfig?.config?._panel_custom?.config?.entry_id,\n  );\n\n  const accountsResp = await fetchAccountsWS(hass, panelConfig);\n  setAccountSnapshots(accountsResp.accounts);\n  const accountRows: AccountOverviewRow[] = selectAccountOverviewRows();\n\n  const portfoliosResp = await fetchPortfoliosWS(hass, panelConfig);\n  replacePortfolioSnapshots(portfoliosResp.portfolios);\n  const depots = selectPortfolioOverviewRows();\n\n  // 3. Last file update (optional – falls bereits WS-Command vorhanden)\n  let lastFileUpdate = '';\n  try {\n    lastFileUpdate = await fetchLastFileUpdateWS(hass, panelConfig);\n  } catch {\n    lastFileUpdate = '';\n  }\n\n  // 4. Gesamtvermögen berechnen (nur Anzeige)\n  const totalAccounts = accountRows.reduce(\n    (sum, account) => sum + (typeof account.balance === 'number' && Number.isFinite(account.balance) ? account.balance : 0),\n    0,\n  );\n  const anyPortfolioMissing = depots.some(depot => depot.fx_unavailable);\n  const anyAccountMissing = accountRows.some(account => account.fx_unavailable && (account.balance == null || !Number.isFinite(account.balance)));\n  const totalDepots = depots.reduce((sum, depot) => {\n    if (depot.hasValue && typeof depot.current_value === 'number' && Number.isFinite(depot.current_value)) {\n      return sum + depot.current_value;\n    }\n    return sum;\n  }, 0);\n  const totalWealth = totalAccounts + totalDepots;\n  const missingWealthReason = 'Teilw. fehlende FX-Kurse – Gesamtvermögen abweichend';\n  const wealthValueAvailable = depots.some(depot => depot.hasValue && typeof depot.current_value === 'number' && Number.isFinite(depot.current_value))\n    || accountRows.some(account => typeof account.balance === 'number' && Number.isFinite(account.balance));\n  const wealthValueMarkup = wealthValueAvailable\n    ? `${formatNumber(totalWealth)}&nbsp;€`\n    : `<span class=\"missing-value\" role=\"note\" aria-label=\"${missingWealthReason}\" title=\"${missingWealthReason}\">—</span>`;\n  const wealthNote = (anyPortfolioMissing || anyAccountMissing)\n    ? `<span class=\"total-wealth-note\">${missingWealthReason}</span>`\n    : '';\n\n  // 5. Header (ohne Last-File-Update – kommt jetzt wieder in Footer-Karte)\n  const headerMeta = `\n    <div class=\"header-meta-row\">\n      💰 Gesamtvermögen: <strong class=\"total-wealth-value\">${wealthValueMarkup}</strong>${wealthNote}\n    </div>\n  `;\n  const headerCard = createHeaderCard('Übersicht', headerMeta);\n\n  // 6. Sicherstellen, dass die Struktur exakt der erwartet wird:\n  //    - .portfolio-table (Wrapper)\n  //    - darin eine <table class=\"expandable-portfolio-table\"> mit <tr class=\"portfolio-row\" data-portfolio=\"UUID\">\n  const portfolioTableHtml = buildExpandablePortfolioTable(depots);\n\n  // 7. Konten-Tabellen\n  const eurAccounts = accountRows.filter(a => (a.currency_code ?? 'EUR') === 'EUR');\n  const fxAccounts = accountRows.filter(a => (a.currency_code ?? 'EUR') !== 'EUR');\n\n  const fxWarningNeeded = fxAccounts.some(a => a.fx_unavailable);\n  const fxWarning = fxWarningNeeded\n    ? `\n        <p class=\"table-note\" role=\"note\">\n          <span class=\"table-note__icon\" aria-hidden=\"true\">⚠️</span>\n          <span>Wechselkurse konnten nicht geladen werden. EUR-Werte werden derzeit nicht angezeigt.</span>\n        </p>\n      `\n    : '';\n\n  const accountsHtml = `\n    <div class=\"card\">\n      <h2>Liquidität</h2>\n      <div class=\"scroll-container account-table\">\n        ${makeTable(\n    eurAccounts.map(account => ({\n      name: renderNameWithBadges(account.name, account.badges, {\n        containerClass: 'account-name',\n        labelClass: 'account-name__label',\n      }),\n      balance: account.balance ?? null,\n    })),\n    [\n      { key: 'name', label: 'Name' },\n      { key: 'balance', label: 'Kontostand (EUR)', align: 'right' as const },\n    ],\n    ['balance'],\n  )}\n      </div>\n    </div>\n    ${fxAccounts.length ? `\n      <div class=\"card\">\n        <h2>Fremdwährungen</h2>\n        <div class=\"scroll-container fx-account-table\">\n          ${makeTable(\n    fxAccounts.map(account => {\n      const origBalance = account.orig_balance;\n      const hasOrigBalance = typeof origBalance === 'number' && Number.isFinite(origBalance);\n      const fxDisplay = hasOrigBalance\n        ? `${origBalance.toLocaleString('de-DE', {\n            minimumFractionDigits: 2,\n            maximumFractionDigits: 2,\n          })}&nbsp;${account.currency_code ?? ''}`\n        : '';\n\n      return {\n        name: renderNameWithBadges(account.name, account.badges, {\n          containerClass: 'account-name',\n          labelClass: 'account-name__label',\n        }),\n        fx_display: fxDisplay,\n        balance: account.balance ?? null,\n      };\n    }),\n    [\n      { key: 'name', label: 'Name' },\n      { key: 'fx_display', label: 'Betrag (FX)' },\n      { key: 'balance', label: 'EUR', align: 'right' as const },\n    ],\n    ['balance'],\n  )}\n        </div>\n        ${fxWarning}\n      </div>` : ''}\n  `;\n\n  // 8. Footer-Karte mit letztem Datei-Änderungszeitpunkt (reintroduziert)\n  const footerCard = `\n    <div class=\"card footer-card\">\n      <div class=\"meta\">\n        <div class=\"last-file-update\">\n          📂 Letzte Aktualisierung der Datei: <strong>${lastFileUpdate || 'Unbekannt'}</strong>\n        </div>\n      </div>\n    </div>\n  `;\n\n  const markup = `\n    ${headerCard.outerHTML}\n    <div class=\"card\">\n      <h2>Investment</h2>\n      <div class=\"scroll-container portfolio-table\">\n        ${portfolioTableHtml}\n      </div>\n    </div>\n    ${accountsHtml}\n    ${footerCard}\n  `;\n\n    schedulePostRenderSetup(root as ToggleRootElement, depots);\n\n  return markup;\n}\n\n  function schedulePostRenderSetup(root: ToggleRootElement | null, depots: readonly PortfolioOverviewRow[]): void {\n  if (!root) {\n    return;\n  }\n\n  const run = () => {\n    try {\n      const wrapper = root;\n      const tableHost = wrapper.querySelector<HTMLElement>('.portfolio-table');\n      if (tableHost && tableHost.querySelectorAll('.portfolio-toggle').length === 0) {\n        console.debug('Recovery: Tabelle ohne Buttons – erneuter Aufbau');\n        tableHost.innerHTML = buildExpandablePortfolioTable(depots);\n      }\n\n      attachPortfolioToggleHandler(root);\n      ensurePortfolioRowFallbackListener(root);\n\n      expandedPortfolios.forEach((pid) => {\n        try {\n          if (hasPortfolioPositions(pid)) {\n            attachPortfolioPositionsSorting(root, pid);\n            attachSecurityDetailListener(root, pid);\n          }\n        } catch (error) {\n          console.warn('Init-Sortierung für expandiertes Depot fehlgeschlagen:', pid, error);\n        }\n      });\n\n      try {\n        updatePortfolioFooterFromDom(wrapper);\n      } catch (footerErr) {\n        console.warn('renderDashboard: Footer-Summe konnte nicht aktualisiert werden:', footerErr);\n      }\n\n      try {\n        flushAllPendingPositions(root);\n      } catch (pendingErr) {\n        console.warn('renderDashboard: Pending-Positions konnten nicht angewendet werden:', pendingErr);\n      }\n\n      console.debug('renderDashboard: portfolio-toggle Buttons:', wrapper.querySelectorAll('.portfolio-toggle').length);\n    } catch (error) {\n      console.error('renderDashboard: Fehler bei Recovery/Listener', error);\n    }\n  };\n\n  const schedule = typeof requestAnimationFrame === 'function'\n    ? (cb: () => void) => requestAnimationFrame(cb)\n    : (cb: () => void) => setTimeout(cb, 0);\n\n  schedule(() => schedule(run));\n}\n\nregisterOverviewHelpers({\n  renderPositionsTable: (positions) =>\n    renderPortfolioPositions(positions as readonly PortfolioPositionRecord[]),\n  applyGainPctMetadata,\n  attachSecurityDetailListener,\n  attachPortfolioPositionsSorting,\n  updatePortfolioFooter: (table) => {\n    if (table) {\n      updatePortfolioFooterFromDom(table);\n    }\n  },\n});\n","/**\n * Chart preparation utilities preserved from the legacy dashboard.\n */\n\n/**\n * Lightweight SVG chart helpers for the PP Reader dashboard.\n *\n * Provides rendering logic for historical security price charts without\n * introducing external dependencies. The helpers expose a simple API with\n * `renderLineChart` for initial setup and `updateLineChart` to mutate an\n * existing chart instance.\n */\n\nconst SVG_NS = 'http://www.w3.org/2000/svg';\nconst DEFAULT_WIDTH = 640;\nconst DEFAULT_HEIGHT = 260;\nconst DEFAULT_MARGIN = { top: 12, right: 16, bottom: 24, left: 16 } as const;\nconst DEFAULT_COLOR = 'var(--pp-reader-chart-line, #3f51b5)';\nconst DEFAULT_AREA = 'var(--pp-reader-chart-area, rgba(63, 81, 181, 0.12))';\nconst DEFAULT_TICK_FONT = '0.75rem';\nconst DEFAULT_BASELINE_COLOR = 'var(--pp-reader-chart-baseline, rgba(96, 125, 139, 0.75))';\nconst DEFAULT_BASELINE_DASH = '6 4';\nconst ONE_DAY_MS = 24 * 60 * 60 * 1000;\n\nfunction toAttributeValue(value: unknown): string | null {\n  if (value == null) {\n    return null;\n  }\n  if (typeof value === 'string') {\n    return value;\n  }\n  if (typeof value === 'number') {\n    return Number.isFinite(value) ? value.toString() : null;\n  }\n  if (typeof value === 'boolean') {\n    return value ? 'true' : 'false';\n  }\n  if (value instanceof Date) {\n    const timestamp = value.getTime();\n    return Number.isFinite(timestamp) ? value.toISOString() : null;\n  }\n  return null;\n}\n\nfunction safeText(value: unknown): string {\n  if (typeof value === 'string') {\n    return value;\n  }\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value.toString();\n  }\n  if (value instanceof Date && Number.isFinite(value.getTime())) {\n    return value.toISOString();\n  }\n  return '';\n}\n\nfunction px(value: number): string {\n  return `${String(value)}px`;\n}\n\nexport type LineChartInputDatum = unknown;\n\nexport type LineChartAccessor = (\n  entry: LineChartInputDatum,\n  index: number,\n) => unknown;\n\nexport type LineChartFormatter = (\n  value: number,\n  entry: LineChartInputDatum,\n  index: number,\n) => string;\n\nexport interface LineChartTooltipPayload {\n  point: LineChartComputedPoint;\n  xFormatted: string;\n  yFormatted: string;\n  data: LineChartInputDatum;\n  index: number;\n}\n\nexport type LineChartTooltipRenderer = (\n  payload: LineChartTooltipPayload,\n) => string;\n\nexport interface ChartMargin {\n  top: number;\n  right: number;\n  bottom: number;\n  left: number;\n}\n\ninterface ChartDimensions {\n  width: number;\n  height: number;\n  margin: ChartMargin;\n}\n\nexport interface LineChartOptions {\n  series?: readonly LineChartInputDatum[];\n  width?: number;\n  height?: number;\n  margin?: Partial<ChartMargin>;\n  xAccessor?: LineChartAccessor;\n  yAccessor?: LineChartAccessor;\n  xFormatter?: LineChartFormatter;\n  yFormatter?: LineChartFormatter;\n  tooltipRenderer?: LineChartTooltipRenderer;\n  color?: string;\n  areaColor?: string;\n  baseline?: LineChartBaselineOptions | null;\n}\n\nexport interface LineChartBaselineOptions {\n  value: number | null | undefined;\n  color?: string;\n  dashArray?: string;\n}\n\ninterface LineChartRange {\n  minX: number;\n  maxX: number;\n  minY: number;\n  maxY: number;\n  boundedWidth: number;\n  boundedHeight: number;\n}\n\nexport interface LineChartComputedPoint {\n  index: number;\n  data: LineChartInputDatum;\n  xValue: number;\n  yValue: number;\n  x: number;\n  y: number;\n}\n\ninterface LineChartInternalState extends ChartDimensions {\n  svg: SVGSVGElement | null;\n  areaPath: SVGPathElement | null;\n  linePath: SVGPathElement | null;\n  baselineLine: SVGLineElement | null;\n  focusLine: SVGLineElement | null;\n  focusCircle: SVGCircleElement | null;\n  overlay: SVGRectElement | null;\n  tooltip: HTMLDivElement | null;\n  xAxis?: HTMLDivElement;\n  yAxis?: HTMLDivElement;\n  series: LineChartInputDatum[];\n  points: LineChartComputedPoint[];\n  range: LineChartRange | null;\n  xAccessor: LineChartAccessor;\n  yAccessor: LineChartAccessor;\n  xFormatter: LineChartFormatter;\n  yFormatter: LineChartFormatter;\n  tooltipRenderer: LineChartTooltipRenderer;\n  color: string;\n  areaColor: string;\n  baseline: LineChartBaselineOptions | null;\n  handlersAttached: boolean;\n  handlePointerMove?: (event: PointerEvent) => void;\n  handlePointerLeave?: (event: PointerEvent) => void;\n}\n\ninterface LineChartContainerElement extends HTMLDivElement {\n  __chartState?: LineChartInternalState;\n}\n\nfunction createSvgElement<K extends keyof SVGElementTagNameMap>(\n  tag: K,\n  attrs: Record<string, unknown> = {},\n): SVGElementTagNameMap[K] {\n  const element = document.createElementNS(SVG_NS, tag);\n  Object.entries(attrs).forEach(([key, value]) => {\n    const attributeValue = toAttributeValue(value);\n    if (attributeValue == null) {\n      return;\n    }\n    element.setAttribute(key, attributeValue);\n  });\n  return element;\n}\n\nfunction toNumber(value: unknown, fallback: number | null = null): number | null {\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n\n  if (typeof value === 'string' && value.trim() !== '') {\n    const parsed = Number.parseFloat(value);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return fallback;\n}\n\nfunction toTimestamp(value: unknown, fallbackIndex: number): number {\n  if (value instanceof Date) {\n    const timestamp = value.getTime();\n    return Number.isFinite(timestamp) ? timestamp : fallbackIndex;\n  }\n\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n\n  if (typeof value === 'string') {\n    const parsed = Date.parse(value);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return fallbackIndex;\n}\n\nconst defaultXAccessor: LineChartAccessor = (entry) => {\n  if (entry && typeof entry === 'object' && 'date' in entry) {\n    return (entry as { date?: unknown }).date;\n  }\n  return undefined;\n};\n\nconst defaultYAccessor: LineChartAccessor = (entry) => {\n  if (entry && typeof entry === 'object' && 'close' in entry) {\n    return (entry as { close?: unknown }).close;\n  }\n  return undefined;\n};\n\nconst defaultXFormatter: LineChartFormatter = (timestamp, dataPoint, _index) => {\n  if (Number.isFinite(timestamp)) {\n    const date = new Date(timestamp);\n    if (!Number.isNaN(date.getTime())) {\n      return date.toLocaleDateString('de-DE');\n    }\n  }\n\n  if (dataPoint && typeof dataPoint === 'object' && 'date' in dataPoint) {\n    const raw = (dataPoint as { date?: unknown }).date;\n    const fallback = safeText(raw);\n    if (fallback) {\n      return fallback;\n    }\n  }\n\n  if (!Number.isFinite(timestamp)) {\n    return '';\n  }\n\n  return timestamp.toString();\n};\n\nconst defaultYFormatter: LineChartFormatter = (value, _dataPoint, _index) => {\n  const numeric = Number.isFinite(value) ? value : toNumber(value, 0) ?? 0;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2,\n  });\n};\n\nconst defaultTooltipRenderer: LineChartTooltipRenderer = ({ xFormatted, yFormatted }) => `\n    <div class=\"chart-tooltip-date\">${xFormatted}</div>\n    <div class=\"chart-tooltip-value\">${yFormatted}&nbsp;€</div>\n  `;\n\nfunction ensureChartState(container: LineChartContainerElement): LineChartInternalState {\n  if (!container.__chartState) {\n    container.__chartState = {\n      svg: null,\n      areaPath: null,\n      linePath: null,\n      baselineLine: null,\n      focusLine: null,\n      focusCircle: null,\n      overlay: null,\n      tooltip: null,\n      width: DEFAULT_WIDTH,\n      height: DEFAULT_HEIGHT,\n      margin: { ...DEFAULT_MARGIN },\n      series: [],\n      points: [],\n      range: null,\n      xAccessor: defaultXAccessor,\n      yAccessor: defaultYAccessor,\n      xFormatter: defaultXFormatter,\n      yFormatter: defaultYFormatter,\n      tooltipRenderer: defaultTooltipRenderer,\n      color: DEFAULT_COLOR,\n      areaColor: DEFAULT_AREA,\n      baseline: null,\n      handlersAttached: false,\n    };\n  }\n  return container.__chartState;\n}\n\nfunction clamp(value: number, min: number, max: number): number {\n  if (!Number.isFinite(value)) {\n    return min;\n  }\n  if (value < min) {\n    return min;\n  }\n  if (value > max) {\n    return max;\n  }\n  return value;\n}\n\nfunction buildAreaPath(points: readonly LineChartComputedPoint[], baselineY: number): string {\n  if (points.length === 0) {\n    return '';\n  }\n\n  const segments: string[] = [];\n  points.forEach((point, index) => {\n    const command = index === 0 ? 'M' : 'L';\n    const x = point.x.toFixed(2);\n    const y = point.y.toFixed(2);\n    segments.push(`${command}${x} ${y}`);\n  });\n\n  const firstPoint = points[0];\n  const lastPoint = points[points.length - 1];\n  const closing = `L${lastPoint.x.toFixed(2)} ${baselineY.toFixed(2)} L${firstPoint.x.toFixed(2)} ${baselineY.toFixed(2)} Z`;\n\n  return `${segments.join(' ')} ${closing}`;\n}\n\nfunction buildLinePath(points: readonly LineChartComputedPoint[]): string {\n  if (points.length === 0) {\n    return '';\n  }\n\n  const segments: string[] = [];\n  points.forEach((point, index) => {\n    const command = index === 0 ? 'M' : 'L';\n    const x = point.x.toFixed(2);\n    const y = point.y.toFixed(2);\n    segments.push(`${command}${x} ${y}`);\n  });\n\n  return segments.join(' ');\n}\n\nfunction applyBaselineAppearance(state: LineChartInternalState): void {\n  const { baselineLine, baseline } = state;\n  if (!baselineLine) {\n    return;\n  }\n\n  const stroke = baseline?.color ?? DEFAULT_BASELINE_COLOR;\n  const dashArray = baseline?.dashArray ?? DEFAULT_BASELINE_DASH;\n\n  baselineLine.setAttribute('stroke', stroke);\n  baselineLine.setAttribute('stroke-dasharray', dashArray);\n}\n\nfunction updateBaselineLine(state: LineChartInternalState): void {\n  const { baselineLine, baseline, range, margin, width } = state;\n  if (!baselineLine) {\n    return;\n  }\n\n  const baselineValue = baseline?.value;\n  if (!range || baselineValue == null || !Number.isFinite(baselineValue)) {\n    baselineLine.style.opacity = '0';\n    return;\n  }\n\n  const { minY, maxY, boundedHeight } = range;\n  const safeMinY = Number.isFinite(minY) ? minY : baselineValue;\n  const safeMaxY = Number.isFinite(maxY) ? maxY : safeMinY + 1;\n  const denominator = safeMaxY - safeMinY;\n  const ratio = denominator === 0 ? 0.5 : (baselineValue - safeMinY) / denominator;\n  const clampedRatio = clamp(ratio, 0, 1);\n\n  const effectiveHeight = Math.max(boundedHeight, 0);\n  const y = margin.top + (1 - clampedRatio) * effectiveHeight;\n  const effectiveWidth = Math.max(width - margin.left - margin.right, 0);\n  const x1 = margin.left;\n  const x2 = margin.left + effectiveWidth;\n\n  baselineLine.setAttribute('x1', x1.toFixed(2));\n  baselineLine.setAttribute('x2', x2.toFixed(2));\n  baselineLine.setAttribute('y1', y.toFixed(2));\n  baselineLine.setAttribute('y2', y.toFixed(2));\n  baselineLine.style.opacity = '1';\n}\n\nfunction computePoints(\n  series: readonly LineChartInputDatum[],\n  dimensions: ChartDimensions & { baseline?: LineChartBaselineOptions | null },\n  accessors: { xAccessor: LineChartAccessor; yAccessor: LineChartAccessor },\n): { points: LineChartComputedPoint[]; range: LineChartRange | null } {\n  const { width, height, margin } = dimensions;\n  const { xAccessor, yAccessor } = accessors;\n\n  if (series.length === 0) {\n    return { points: [], range: null };\n  }\n\n  const rawPoints = series\n    .map((entry, index) => {\n      const rawX = xAccessor(entry, index);\n      const rawY = yAccessor(entry, index);\n      const xValue = toTimestamp(rawX, index);\n      const yValue = toNumber(rawY, Number.NaN);\n      if (!Number.isFinite(yValue)) {\n        return null;\n      }\n      return {\n        index,\n        data: entry,\n        xValue,\n        yValue,\n      };\n    })\n    .filter((point): point is { index: number; data: LineChartInputDatum; xValue: number; yValue: number } => Boolean(point));\n\n  if (rawPoints.length === 0) {\n    return { points: [], range: null };\n  }\n\n  const minX = rawPoints.reduce((min, point) => Math.min(min, point.xValue), rawPoints[0].xValue);\n  const maxX = rawPoints.reduce((max, point) => Math.max(max, point.xValue), rawPoints[0].xValue);\n  const minY = rawPoints.reduce((min, point) => Math.min(min, point.yValue), rawPoints[0].yValue);\n  const maxY = rawPoints.reduce((max, point) => Math.max(max, point.yValue), rawPoints[0].yValue);\n\n  const boundedWidth = Math.max(width - margin.left - margin.right, 1);\n  const boundedHeight = Math.max(height - margin.top - margin.bottom, 1);\n\n  const safeMinX = Number.isFinite(minX) ? minX : 0;\n  const safeMaxX = Number.isFinite(maxX) ? maxX : safeMinX + 1;\n  const safeMinY = Number.isFinite(minY) ? minY : 0;\n  const safeMaxY = Number.isFinite(maxY) ? maxY : safeMinY + 1;\n  const baselineValue = toNumber(dimensions.baseline?.value, null);\n\n  const minDomainCandidate =\n    baselineValue != null && Number.isFinite(baselineValue)\n      ? Math.min(safeMinY, baselineValue)\n      : safeMinY;\n  const maxDomainCandidate =\n    baselineValue != null && Number.isFinite(baselineValue)\n      ? Math.max(safeMaxY, baselineValue)\n      : safeMaxY;\n\n  const desiredYTicks = Math.max(\n    2,\n    Math.min(\n      6,\n      Math.round(\n        Math.max(height - margin.top - margin.bottom, 0) / 60,\n      ) || 4,\n    ),\n  );\n  const { niceMin: domainMinY, niceMax: domainMaxY } = computeNiceDomain(\n    minDomainCandidate,\n    maxDomainCandidate,\n    desiredYTicks,\n  );\n\n  const effectiveMinY = Number.isFinite(domainMinY) ? domainMinY : safeMinY;\n  const effectiveMaxY = Number.isFinite(domainMaxY) ? domainMaxY : safeMaxY;\n\n  const rangeX = safeMaxX - safeMinX || 1;\n  const rangeY = effectiveMaxY - effectiveMinY || 1;\n\n  const points = rawPoints.map((point) => {\n    const ratioX = rangeX === 0 ? 0.5 : (point.xValue - safeMinX) / rangeX;\n    const ratioY = rangeY === 0 ? 0.5 : (point.yValue - effectiveMinY) / rangeY;\n    const x = margin.left + ratioX * boundedWidth;\n    const y = margin.top + (1 - ratioY) * boundedHeight;\n    return {\n      ...point,\n      x,\n      y,\n    } satisfies LineChartComputedPoint;\n  });\n\n  return {\n    points,\n    range: {\n      minX: safeMinX,\n      maxX: safeMaxX,\n      minY: effectiveMinY,\n      maxY: effectiveMaxY,\n      boundedWidth,\n      boundedHeight,\n    },\n  };\n}\n\nfunction assignDimensions(\n  state: LineChartInternalState,\n  width: number | undefined,\n  height: number | undefined,\n  margin: Partial<ChartMargin> | undefined,\n): void {\n  state.width = Number.isFinite(width) ? Number(width) : DEFAULT_WIDTH;\n  state.height = Number.isFinite(height) ? Number(height) : DEFAULT_HEIGHT;\n  state.margin = {\n    top: Number.isFinite(margin?.top) ? Number(margin?.top) : DEFAULT_MARGIN.top,\n    right: Number.isFinite(margin?.right) ? Number(margin?.right) : DEFAULT_MARGIN.right,\n    bottom: Number.isFinite(margin?.bottom) ? Number(margin?.bottom) : DEFAULT_MARGIN.bottom,\n    left: Number.isFinite(margin?.left) ? Number(margin?.left) : DEFAULT_MARGIN.left,\n  };\n}\n\nfunction formatTooltip(state: LineChartInternalState, point: LineChartComputedPoint): string {\n  const xFormatted = state.xFormatter(point.xValue, point.data, point.index);\n  const yFormatted = state.yFormatter(point.yValue, point.data, point.index);\n  return state.tooltipRenderer({\n    point,\n    xFormatted,\n    yFormatted,\n    data: point.data,\n    index: point.index,\n  });\n}\n\nfunction updateTooltipPosition(\n  state: LineChartInternalState,\n  point: LineChartComputedPoint,\n  pointerY: number | null,\n): void {\n  const { tooltip, width, margin, height } = state;\n  if (!tooltip) {\n    return;\n  }\n\n  const baselineY = height - margin.bottom;\n  tooltip.style.visibility = 'visible';\n  tooltip.style.opacity = '1';\n  const tooltipWidth = tooltip.offsetWidth || 0;\n  const tooltipHeight = tooltip.offsetHeight || 0;\n  const horizontal = clamp(point.x - tooltipWidth / 2, margin.left, width - margin.right - tooltipWidth);\n  const maxVertical = Math.max(baselineY - tooltipHeight, 0);\n  const padding = 12;\n  const anchorY = Number.isFinite(pointerY)\n    ? clamp(pointerY ?? 0, margin.top, baselineY)\n    : point.y;\n  let vertical = anchorY - tooltipHeight - padding;\n  if (vertical < margin.top) {\n    vertical = anchorY + padding;\n  }\n  vertical = clamp(vertical, 0, maxVertical);\n  const translateX = px(Math.round(horizontal));\n  const translateY = px(Math.round(vertical));\n  tooltip.style.transform = `translate(${translateX}, ${translateY})`;\n}\n\nfunction hideTooltip(state: LineChartInternalState): void {\n  const { tooltip, focusLine, focusCircle } = state;\n  if (tooltip) {\n    tooltip.style.opacity = '0';\n    tooltip.style.visibility = 'hidden';\n  }\n  if (focusLine) {\n    focusLine.style.opacity = '0';\n  }\n  if (focusCircle) {\n    focusCircle.style.opacity = '0';\n  }\n}\n\nfunction attachPointerHandlers(\n  container: LineChartContainerElement,\n  state: LineChartInternalState,\n): void {\n  if (state.handlersAttached || !state.overlay) {\n    return;\n  }\n\n  const handlePointerMove = (event: PointerEvent) => {\n    if (state.points.length === 0 || !state.svg) {\n      hideTooltip(state);\n      return;\n    }\n\n    const rect = state.svg.getBoundingClientRect();\n    const pointerX = event.clientX - rect.left;\n    const pointerY = event.clientY - rect.top;\n    let closest = state.points[0];\n    let minDistance = Math.abs(pointerX - closest.x);\n\n    for (let idx = 1; idx < state.points.length; idx += 1) {\n      const candidate = state.points[idx];\n      const distance = Math.abs(pointerX - candidate.x);\n      if (distance < minDistance) {\n        minDistance = distance;\n        closest = candidate;\n      }\n    }\n\n    if (state.focusCircle) {\n      state.focusCircle.setAttribute('cx', closest.x.toFixed(2));\n      state.focusCircle.setAttribute('cy', closest.y.toFixed(2));\n      state.focusCircle.style.opacity = '1';\n    }\n\n    if (state.focusLine) {\n      state.focusLine.setAttribute('x1', closest.x.toFixed(2));\n      state.focusLine.setAttribute('x2', closest.x.toFixed(2));\n      state.focusLine.setAttribute('y1', state.margin.top.toFixed(2));\n      state.focusLine.setAttribute(\n        'y2',\n        (state.height - state.margin.bottom).toFixed(2),\n      );\n      state.focusLine.style.opacity = '1';\n    }\n\n    if (state.tooltip) {\n      state.tooltip.innerHTML = formatTooltip(state, closest);\n      updateTooltipPosition(state, closest, pointerY);\n    }\n  };\n\n  const handlePointerLeave = () => {\n    hideTooltip(state);\n  };\n\n  state.overlay.addEventListener('pointermove', handlePointerMove);\n  state.overlay.addEventListener('pointerenter', handlePointerMove);\n  state.overlay.addEventListener('pointerleave', handlePointerLeave);\n\n  state.handlersAttached = true;\n  state.handlePointerMove = handlePointerMove;\n  state.handlePointerLeave = handlePointerLeave;\n\n  container.addEventListener('pointercancel', handlePointerLeave);\n}\n\nexport function renderLineChart(\n  root: HTMLElement,\n  options: LineChartOptions = {},\n): LineChartContainerElement | null {\n  const container = document.createElement('div') as LineChartContainerElement;\n  container.className = 'line-chart-container';\n  container.dataset.chartType = 'line';\n  container.style.position = 'relative';\n\n  const svg = createSvgElement('svg', {\n    width: DEFAULT_WIDTH,\n    height: DEFAULT_HEIGHT,\n    viewBox: `0 0 ${String(DEFAULT_WIDTH)} ${String(DEFAULT_HEIGHT)}`,\n    role: 'img',\n    'aria-hidden': 'true',\n    focusable: 'false',\n  });\n  svg.classList.add('line-chart-svg');\n\n  const areaPath = createSvgElement('path', {\n    class: 'line-chart-area',\n    fill: DEFAULT_AREA,\n    stroke: 'none',\n  });\n\n  const baselineLine = createSvgElement('line', {\n    class: 'line-chart-baseline',\n    stroke: DEFAULT_BASELINE_COLOR,\n    'stroke-width': 1,\n    'stroke-dasharray': DEFAULT_BASELINE_DASH,\n    opacity: 0,\n  });\n\n  const linePath = createSvgElement('path', {\n    class: 'line-chart-path',\n    fill: 'none',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 2,\n    'stroke-linecap': 'round',\n    'stroke-linejoin': 'round',\n  });\n\n  const focusLine = createSvgElement('line', {\n    class: 'line-chart-focus-line',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 1,\n    'stroke-dasharray': '4 4',\n    opacity: 0,\n  });\n\n  const focusCircle = createSvgElement('circle', {\n    class: 'line-chart-focus-circle',\n    r: 4,\n    fill: '#fff',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 2,\n    opacity: 0,\n  });\n\n  const overlay = createSvgElement('rect', {\n    class: 'line-chart-overlay',\n    fill: 'transparent',\n    x: 0,\n    y: 0,\n    width: DEFAULT_WIDTH,\n    height: DEFAULT_HEIGHT,\n  });\n\n  svg.appendChild(areaPath);\n  svg.appendChild(baselineLine);\n  svg.appendChild(linePath);\n  svg.appendChild(focusLine);\n  svg.appendChild(focusCircle);\n  svg.appendChild(overlay);\n\n  container.appendChild(svg);\n\n  const tooltip = document.createElement('div');\n  tooltip.className = 'chart-tooltip';\n  tooltip.style.position = 'absolute';\n  tooltip.style.top = '0';\n  tooltip.style.left = '0';\n  tooltip.style.pointerEvents = 'none';\n  tooltip.style.opacity = '0';\n  tooltip.style.visibility = 'hidden';\n  container.appendChild(tooltip);\n\n  root.appendChild(container);\n\n  const state = ensureChartState(container);\n  state.svg = svg;\n  state.areaPath = areaPath;\n  state.linePath = linePath;\n  state.baselineLine = baselineLine;\n  state.focusLine = focusLine;\n  state.focusCircle = focusCircle;\n  state.overlay = overlay;\n  state.tooltip = tooltip;\n  state.xAccessor = options.xAccessor ?? defaultXAccessor;\n  state.yAccessor = options.yAccessor ?? defaultYAccessor;\n  state.xFormatter = options.xFormatter ?? defaultXFormatter;\n  state.yFormatter = options.yFormatter ?? defaultYFormatter;\n  state.tooltipRenderer = options.tooltipRenderer ?? defaultTooltipRenderer;\n  state.color = options.color ?? DEFAULT_COLOR;\n  state.areaColor = options.areaColor ?? DEFAULT_AREA;\n  state.baseline = options.baseline ?? null;\n  state.handlersAttached = false;\n\n  if (!state.xAxis) {\n    const xAxis = document.createElement('div');\n    xAxis.className = 'line-chart-axis line-chart-axis-x';\n    xAxis.style.position = 'absolute';\n    xAxis.style.left = '0';\n    xAxis.style.right = '0';\n    xAxis.style.bottom = '0';\n    xAxis.style.pointerEvents = 'none';\n    xAxis.style.fontSize = DEFAULT_TICK_FONT;\n    xAxis.style.color = 'var(--secondary-text-color)';\n    xAxis.style.display = 'block';\n    container.appendChild(xAxis);\n    state.xAxis = xAxis;\n  }\n\n  if (!state.yAxis) {\n    const yAxis = document.createElement('div');\n    yAxis.className = 'line-chart-axis line-chart-axis-y';\n    yAxis.style.position = 'absolute';\n    yAxis.style.top = '0';\n    yAxis.style.bottom = '0';\n    yAxis.style.left = '0';\n    yAxis.style.pointerEvents = 'none';\n    yAxis.style.fontSize = DEFAULT_TICK_FONT;\n    yAxis.style.color = 'var(--secondary-text-color)';\n    yAxis.style.display = 'block';\n    container.appendChild(yAxis);\n    state.yAxis = yAxis;\n  }\n\n  assignDimensions(state, options.width, options.height, options.margin);\n\n  linePath.setAttribute('stroke', state.color);\n  focusLine.setAttribute('stroke', state.color);\n  focusCircle.setAttribute('stroke', state.color);\n  areaPath.setAttribute('fill', state.areaColor);\n\n  updateLineChart(container, options);\n  attachPointerHandlers(container, state);\n\n  return container;\n}\n\nexport function updateLineChart(\n  container: LineChartContainerElement | null,\n  options: LineChartOptions = {},\n): void {\n  if (!container) {\n    console.error('updateLineChart: container element is required');\n    return;\n  }\n\n  const state = ensureChartState(container);\n  if (!state.svg || !state.linePath || !state.overlay) {\n    console.error('updateLineChart: chart was not initialised with renderLineChart');\n    return;\n  }\n\n  if (options.xAccessor) {\n    state.xAccessor = options.xAccessor;\n  }\n  if (options.yAccessor) {\n    state.yAccessor = options.yAccessor;\n  }\n  if (options.xFormatter) {\n    state.xFormatter = options.xFormatter;\n  }\n  if (options.yFormatter) {\n    state.yFormatter = options.yFormatter;\n  }\n  if (options.tooltipRenderer) {\n    state.tooltipRenderer = options.tooltipRenderer;\n  }\n  if (options.color) {\n    state.color = options.color;\n    state.linePath.setAttribute('stroke', state.color);\n    if (state.focusLine) {\n      state.focusLine.setAttribute('stroke', state.color);\n    }\n    if (state.focusCircle) {\n      state.focusCircle.setAttribute('stroke', state.color);\n    }\n  }\n  if (options.areaColor) {\n    state.areaColor = options.areaColor;\n    if (state.areaPath) {\n      state.areaPath.setAttribute('fill', state.areaColor);\n    }\n  }\n\n  if (Object.prototype.hasOwnProperty.call(options, 'baseline')) {\n    state.baseline = options.baseline ?? null;\n  }\n\n  applyBaselineAppearance(state);\n\n  assignDimensions(state, options.width, options.height, options.margin);\n\n  const { width, height, margin } = state;\n  state.svg.setAttribute('width', String(width));\n  state.svg.setAttribute('height', String(height));\n  state.svg.setAttribute('viewBox', `0 0 ${String(width)} ${String(height)}`);\n\n  state.overlay.setAttribute('x', margin.left.toFixed(2));\n  state.overlay.setAttribute('y', margin.top.toFixed(2));\n  state.overlay.setAttribute(\n    'width',\n    Math.max(width - margin.left - margin.right, 0).toFixed(2),\n  );\n  state.overlay.setAttribute(\n    'height',\n    Math.max(height - margin.top - margin.bottom, 0).toFixed(2),\n  );\n\n  if (Array.isArray(options.series)) {\n    state.series = Array.from(options.series);\n  }\n\n  const { points, range } = computePoints(state.series, state, {\n    xAccessor: state.xAccessor,\n    yAccessor: state.yAccessor,\n  });\n  state.points = points;\n  state.range = range;\n\n  if (points.length === 0) {\n    state.linePath.setAttribute('d', '');\n    if (state.areaPath) {\n      state.areaPath.setAttribute('d', '');\n    }\n    hideTooltip(state);\n    updateAxes(state);\n    updateBaselineLine(state);\n    return;\n  }\n\n  const lineD = buildLinePath(points);\n  state.linePath.setAttribute('d', lineD);\n\n  if (state.areaPath && range) {\n    const baselineY = state.margin.top + range.boundedHeight;\n    const areaD = buildAreaPath(points, baselineY);\n    state.areaPath.setAttribute('d', areaD);\n  }\n\n  updateAxes(state);\n  updateBaselineLine(state);\n}\n\nfunction updateAxes(state: LineChartInternalState): void {\n  const { xAxis, yAxis, range, margin, height, yFormatter } = state;\n  if (!xAxis || !yAxis) {\n    return;\n  }\n\n  if (!range) {\n    xAxis.innerHTML = '';\n    yAxis.innerHTML = '';\n    return;\n  }\n\n  const { minX, maxX, minY, maxY, boundedWidth, boundedHeight } = range;\n\n  const hasValidX = Number.isFinite(minX) && Number.isFinite(maxX) && maxX >= minX;\n  const hasValidY = Number.isFinite(minY) && Number.isFinite(maxY) && maxY >= minY;\n\n  const effectiveWidth = Math.max(boundedWidth, 0);\n  const effectiveHeight = Math.max(boundedHeight, 0);\n\n  xAxis.style.left = px(margin.left);\n  xAxis.style.width = px(effectiveWidth);\n  xAxis.style.top = px(height - margin.bottom + 6);\n  xAxis.innerHTML = '';\n\n  if (hasValidX && effectiveWidth > 0) {\n    const rangeDays = (maxX - minX) / ONE_DAY_MS;\n    const desiredTicks = Math.max(2, Math.min(6, Math.round(effectiveWidth / 140) || 4));\n    const xTicks = generateTimeAxisTicks(state, minX, maxX, desiredTicks, rangeDays);\n    xTicks.forEach(({ positionRatio, label }) => {\n      const tick = document.createElement('div');\n      tick.className = 'line-chart-axis-tick line-chart-axis-tick-x';\n      tick.style.position = 'absolute';\n      tick.style.bottom = '0';\n      const ratio = clamp(positionRatio, 0, 1);\n      tick.style.left = px(ratio * effectiveWidth);\n      let translateX = '-50%';\n      let textAlign: CSSStyleDeclaration['textAlign'] = 'center';\n      if (ratio <= 0.001) {\n        translateX = '0';\n        textAlign = 'left';\n        tick.style.marginLeft = '2px';\n      } else if (ratio >= 0.999) {\n        translateX = '-100%';\n        textAlign = 'right';\n        tick.style.marginRight = '2px';\n      }\n      tick.style.transform = `translateX(${translateX})`;\n      tick.style.textAlign = textAlign;\n      tick.textContent = label;\n      xAxis.appendChild(tick);\n    });\n  }\n\n  yAxis.style.top = px(margin.top);\n  yAxis.style.height = px(effectiveHeight);\n  const yAxisWidth = Math.max(margin.left - 6, 0);\n  yAxis.style.left = '0';\n  yAxis.style.width = px(Math.max(yAxisWidth, 0));\n  yAxis.innerHTML = '';\n\n  if (hasValidY && effectiveHeight > 0) {\n    const desiredTicks = Math.max(2, Math.min(6, Math.round(effectiveHeight / 60) || 4));\n    const yTicks = generateNumericAxisTicks(minY, maxY, desiredTicks);\n    const applyFormatter = yFormatter;\n    yTicks.forEach(({ value, positionRatio }) => {\n      const tick = document.createElement('div');\n      tick.className = 'line-chart-axis-tick line-chart-axis-tick-y';\n      tick.style.position = 'absolute';\n      tick.style.left = '0';\n      const clampedRatio = clamp(positionRatio, 0, 1);\n      const top = (1 - clampedRatio) * effectiveHeight;\n      tick.style.top = px(top);\n      tick.textContent = applyFormatter(value, null, -1);\n      yAxis.appendChild(tick);\n    });\n  }\n}\n\nfunction computeNiceDomain(\n  minValue: number,\n  maxValue: number,\n  desiredTicks = 4,\n): { niceMin: number; niceMax: number } {\n  if (!Number.isFinite(minValue) || !Number.isFinite(maxValue)) {\n    return {\n      niceMin: minValue,\n      niceMax: maxValue,\n    };\n  }\n\n  const safeTicks = Math.max(2, desiredTicks);\n\n  if (maxValue === minValue) {\n    const padding = niceStep(Math.abs(minValue) || 1);\n    return {\n      niceMin: minValue - padding,\n      niceMax: maxValue + padding,\n    };\n  }\n\n  const range = maxValue - minValue;\n  const rawStep = range / (safeTicks - 1);\n  const step = niceStep(rawStep);\n  const niceMin = Math.floor(minValue / step) * step;\n  const niceMax = Math.ceil(maxValue / step) * step;\n\n  if (niceMin === niceMax) {\n    return {\n      niceMin: minValue,\n      niceMax: maxValue + step,\n    };\n  }\n\n  return {\n    niceMin,\n    niceMax,\n  };\n}\n\nfunction generateTimeAxisTicks(\n  state: LineChartInternalState,\n  minTimestamp: number,\n  maxTimestamp: number,\n  desiredTicks: number,\n  rangeDays: number,\n): Array<{ positionRatio: number; label: string }> {\n  if (!Number.isFinite(minTimestamp) || !Number.isFinite(maxTimestamp) || maxTimestamp < minTimestamp) {\n    return [];\n  }\n\n  if (!Number.isFinite(rangeDays) || rangeDays <= 0) {\n    const label = formatXAxisLabel(state, minTimestamp, rangeDays || 0);\n    return [\n      {\n        positionRatio: 0.5,\n        label,\n      },\n    ];\n  }\n\n  const tickCount = Math.max(2, desiredTicks);\n  const ticks: Array<{ positionRatio: number; label: string }> = [];\n  const range = maxTimestamp - minTimestamp;\n  for (let index = 0; index < tickCount; index += 1) {\n    const ratio = tickCount === 1 ? 0.5 : index / (tickCount - 1);\n    const value = minTimestamp + ratio * range;\n    ticks.push({\n      positionRatio: ratio,\n      label: formatXAxisLabel(state, value, rangeDays),\n    });\n  }\n  return ticks;\n}\n\nfunction formatXAxisLabel(\n  state: LineChartInternalState,\n  timestamp: number,\n  rangeDays: number,\n): string {\n  const date = new Date(timestamp);\n  if (Number.isFinite(date.getTime())) {\n    if (rangeDays > 1095) {\n      return String(date.getFullYear());\n    }\n    if (rangeDays > 365) {\n      return date.toLocaleDateString('de-DE', {\n        year: 'numeric',\n        month: 'short',\n      });\n    }\n    if (rangeDays > 90) {\n      return date.toLocaleDateString('de-DE', {\n        year: '2-digit',\n        month: 'short',\n      });\n    }\n    if (rangeDays > 30) {\n      return date.toLocaleDateString('de-DE', {\n        day: '2-digit',\n        month: 'short',\n      });\n    }\n    return date.toLocaleDateString('de-DE', {\n      day: '2-digit',\n      month: '2-digit',\n    });\n  }\n\n  return state.xFormatter(timestamp, null, -1);\n}\n\nfunction generateNumericAxisTicks(\n  minValue: number,\n  maxValue: number,\n  desiredTicks: number,\n): Array<{ value: number; positionRatio: number }> {\n  if (!Number.isFinite(minValue) || !Number.isFinite(maxValue)) {\n    return [];\n  }\n\n  if (maxValue === minValue) {\n    return [\n      {\n        value: minValue,\n        positionRatio: 0.5,\n      },\n    ];\n  }\n\n  const range = maxValue - minValue;\n  const tickCount = Math.max(2, desiredTicks);\n  const rawStep = range / (tickCount - 1);\n  const step = niceStep(rawStep);\n  const start = Math.floor(minValue / step) * step;\n  const end = Math.ceil(maxValue / step) * step;\n\n  const ticks: Array<{ value: number; positionRatio: number }> = [];\n  for (let value = start; value <= end + step / 2; value += step) {\n    const ratio = (value - minValue) / (maxValue - minValue);\n    ticks.push({\n      value,\n      positionRatio: clamp(ratio, 0, 1),\n    });\n  }\n\n  if (ticks.length > tickCount + 2) {\n    return ticks.filter((_, index) => index % 2 === 0);\n  }\n\n  return ticks;\n}\n\nfunction niceStep(value: number): number {\n  if (!Number.isFinite(value) || value === 0) {\n    return 1;\n  }\n\n  const exponent = Math.floor(Math.log10(Math.abs(value)));\n  const fraction = Math.abs(value) / 10 ** exponent;\n  let niceFraction: number;\n  if (fraction <= 1) {\n    niceFraction = 1;\n  } else if (fraction <= 2) {\n    niceFraction = 2;\n  } else if (fraction <= 5) {\n    niceFraction = 5;\n  } else {\n    niceFraction = 10;\n  }\n  return niceFraction * 10 ** exponent;\n}\n","/**\n * Shared type declarations for PP Reader dashboard tabs.\n *\n * These interfaces centralize cross-tab contracts so the migration from the\n * legacy JavaScript modules can progressively add stronger typing without\n * duplicating structural definitions in each module.\n */\n\nimport type { HomeAssistant } from \"../types/home-assistant\";\n\ntype UnknownRecord = Record<string, unknown>;\n\nfunction isNumber(value: unknown): value is number {\n  return typeof value === \"number\";\n}\n\nfunction isNullableNumber(value: unknown): value is number | null {\n  return value === null || isNumber(value);\n}\n\nfunction isStringArray(value: unknown): value is string[] {\n  return Array.isArray(value) && value.every((entry) => typeof entry === \"string\");\n}\n\nfunction isRecord(value: unknown): value is UnknownRecord {\n  return typeof value === \"object\" && value !== null;\n}\n\n/**\n * Supported provenance markers for helper-provided average cost payloads.\n */\nexport type AverageCostSource = \"aggregation\" | \"totals\" | \"eur_total\";\n\nexport interface AverageCostPayload {\n  native: number | null;\n  security: number | null;\n  account: number | null;\n  eur: number | null;\n  source: AverageCostSource;\n  coverage_ratio: number | null;\n  [key: string]: unknown;\n}\n\n/**\n * Optional day-change metrics accompanying a performance payload.\n */\nexport interface PerformanceDayChangePayload {\n  price_change_native: number | null;\n  price_change_eur: number | null;\n  change_pct: number | null;\n  source: string;\n  coverage_ratio: number | null;\n  [key: string]: unknown;\n}\n\n/**\n * Normalised gain and change metrics shared between backend payloads.\n *\n * Consumers should rely on this payload for gain and percentage metrics rather\n * than legacy flat mirrors.\n */\nexport interface PerformanceMetricsPayload {\n  gain_abs: number;\n  gain_pct: number;\n  total_change_eur: number;\n  total_change_pct: number;\n  source: string;\n  coverage_ratio: number | null;\n  day_change?: PerformanceDayChangePayload | null;\n  [key: string]: unknown;\n}\n\nexport interface PanelConfigLike {\n  entry_id?: string | null;\n  config?: {\n    entry_id?: string | null;\n    _panel_custom?: {\n      config?: {\n        entry_id?: string | null;\n      } | null;\n    } | null;\n  } | null;\n  webcomponent_name?: string | null;\n  [key: string]: unknown;\n}\n\nexport interface DashboardTabRenderContext {\n  root: HTMLElement;\n  hass: HomeAssistant | null | undefined;\n  panelConfig: PanelConfigLike | null | undefined;\n}\n\nexport type DashboardTabRenderResult =\n  | string\n  | undefined\n  | Promise<string | undefined>;\n\nexport type DashboardTabRenderFn = (\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n) => DashboardTabRenderResult;\n\nexport interface DashboardTabDescriptor {\n  key: string;\n  title: string;\n  render: DashboardTabRenderFn;\n  cleanup?: (context: { key: string }) => void | Promise<void>;\n  [key: string]: unknown;\n}\n\nexport type SecurityHistoryRangeKey = \"1M\" | \"6M\" | \"1Y\" | \"5Y\" | \"ALL\";\n\nexport interface SecurityHistoryRangeState {\n  activeRange: SecurityHistoryRangeKey;\n  [key: string]: unknown;\n}\n\nexport interface SecuritySnapshotLike {\n  security_uuid: string;\n  name: string;\n  currency_code?: string | null;\n  total_holdings: number;\n  purchase_value_eur: number;\n  current_value_eur: number;\n  gain_pct: number;\n  last_price_native?: number | null;\n  last_price_eur: number | null;\n  last_close_native?: number | null;\n  last_close_eur?: number | null;\n  /**\n   * Structured selection of average purchase prices with provenance metadata.\n   */\n  average_cost?: AverageCostPayload | null;\n  aggregation?: HoldingsAggregationPayload | null;\n  /** Structured gain and day-change metrics shared across payloads. */\n  performance?: PerformanceMetricsPayload | null;\n  /** Raw snapshot provenance flag (e.g. cache vs. live). */\n  source?: string | null;\n  [key: string]: unknown;\n}\n\nexport interface HoldingsAggregationPayload {\n  total_holdings: number;\n  positive_holdings: number;\n  purchase_value_cents: number;\n  purchase_value_eur: number;\n  security_currency_total: number;\n  account_currency_total: number;\n  purchase_total_security: number;\n  purchase_total_account: number;\n  [key: string]: unknown;\n}\n\nexport interface PortfolioPosition {\n  security_uuid: string;\n  name: string;\n  current_holdings: number;\n  purchase_value: number;\n  current_value: number;\n  /**\n   * Structured selection of average purchase prices with provenance metadata.\n   */\n  average_cost: AverageCostPayload | null;\n  /** Structured gain metrics supplied by the backend. */\n  performance: PerformanceMetricsPayload | null;\n  aggregation: HoldingsAggregationPayload | null;\n  /** Client-side convenience mirrors derived from the performance payload. */\n  gain_abs?: number | null;\n  /** Client-side convenience mirrors derived from the performance payload. */\n  gain_pct?: number | null;\n  [key: string]: unknown;\n}\n\nexport interface PortfolioPositionsUpdatedEventDetail {\n  portfolioUuid: string;\n  securityUuids: string[];\n}\n\nexport type PortfolioPositionsUpdatedEvent = CustomEvent<PortfolioPositionsUpdatedEventDetail>;\n\nexport function isAverageCostPayload(value: unknown): value is AverageCostPayload {\n  if (!isRecord(value)) {\n    return false;\n  }\n\n  const record = value;\n\n  if (typeof record.source !== \"string\") {\n    return false;\n  }\n\n  const hasNative = \"native\" in record && isNullableNumber(record.native);\n  const hasSecurity = \"security\" in record && isNullableNumber(record.security);\n  const hasAccount = \"account\" in record && isNullableNumber(record.account);\n  const hasEur = \"eur\" in record && isNullableNumber(record.eur);\n\n  if (!hasNative || !hasSecurity || !hasAccount || !hasEur) {\n    return false;\n  }\n\n  if (\"coverage_ratio\" in record && !isNullableNumber(record.coverage_ratio)) {\n    return false;\n  }\n\n  return true;\n}\n\nexport function isPerformanceDayChangePayload(\n  value: unknown,\n): value is PerformanceDayChangePayload {\n  if (!isRecord(value)) {\n    return false;\n  }\n\n  const record = value;\n\n  if (typeof record.source !== \"string\") {\n    return false;\n  }\n\n  const hasNative = \"price_change_native\" in record && isNullableNumber(record.price_change_native);\n  const hasEur = \"price_change_eur\" in record && isNullableNumber(record.price_change_eur);\n  const hasChange = \"change_pct\" in record && isNullableNumber(record.change_pct);\n\n  if (!hasNative || !hasEur || !hasChange) {\n    return false;\n  }\n\n  if (\"coverage_ratio\" in record && !isNullableNumber(record.coverage_ratio)) {\n    return false;\n  }\n\n  return true;\n}\n\nexport function isPerformanceMetricsPayload(value: unknown): value is PerformanceMetricsPayload {\n  if (!isRecord(value)) {\n    return false;\n  }\n\n  const record = value;\n\n  if (\n    !isNumber(record.gain_abs) ||\n    !isNumber(record.gain_pct) ||\n    !isNumber(record.total_change_eur) ||\n    !isNumber(record.total_change_pct) ||\n    typeof record.source !== \"string\"\n  ) {\n    return false;\n  }\n\n  if (\"coverage_ratio\" in record && !isNullableNumber(record.coverage_ratio)) {\n    return false;\n  }\n\n  if (\"day_change\" in record && record.day_change !== undefined && record.day_change !== null) {\n    if (!isPerformanceDayChangePayload(record.day_change)) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\nexport function isHoldingsAggregationPayload(value: unknown): value is HoldingsAggregationPayload {\n  if (!isRecord(value)) {\n    return false;\n  }\n\n  const record = value;\n\n  return (\n    isNumber(record.total_holdings) &&\n    isNumber(record.positive_holdings) &&\n    isNumber(record.purchase_value_cents) &&\n    isNumber(record.purchase_value_eur) &&\n    isNumber(record.security_currency_total) &&\n    isNumber(record.account_currency_total) &&\n    isNumber(record.purchase_total_security) &&\n    isNumber(record.purchase_total_account)\n  );\n}\n\nexport function isPortfolioPositionsUpdatedEventDetail(\n  value: unknown,\n): value is PortfolioPositionsUpdatedEventDetail {\n  if (!isRecord(value)) {\n    return false;\n  }\n\n  const record = value;\n\n  if (typeof record.portfolioUuid !== \"string\") {\n    return false;\n  }\n\n  return isStringArray(record.securityUuids);\n}\n\nexport function isPortfolioPositionsUpdatedEvent(\n  event: Event,\n): event is PortfolioPositionsUpdatedEvent {\n  if (!(event instanceof CustomEvent)) {\n    return false;\n  }\n\n  return isPortfolioPositionsUpdatedEventDetail(event.detail);\n}\n","/**\n * Security detail tab renderer migrated verbatim for TypeScript.\n */\n\n/**\n * Security detail tab renderer and registration.\n *\n * Provides the render function used by dynamic security tabs and\n * exposes a helper to register the descriptor factory with the\n * dashboard controller.\n */\nimport {\n  createHeaderCard,\n  formatNumber,\n  formatGain,\n  formatGainPct,\n} from '../content/elements';\nimport { renderLineChart, updateLineChart } from '../content/charting';\nimport type { LineChartOptions } from '../content/charting';\nimport {\n  fetchSecuritySnapshotWS,\n  fetchSecurityHistoryWS,\n} from '../data/api';\nimport {\n  normalizeAverageCostPayload,\n  normalizeAggregationPayload,\n} from '../data/positionsCache';\nimport type {\n  SecuritySnapshotResponse,\n  SecurityHistoryResponse,\n  SecurityHistoryOptions,\n} from '../data/api';\nimport type { HomeAssistant } from '../types/home-assistant';\nimport type {\n  DashboardTabRenderFn,\n  PanelConfigLike,\n  PortfolioPositionsUpdatedEventDetail,\n  SecurityHistoryRangeKey,\n  SecurityHistoryRangeState,\n  SecuritySnapshotLike,\n  AverageCostSource,\n} from './types';\nimport { isPortfolioPositionsUpdatedEvent } from './types';\nimport { toFiniteCurrency, normalizePercentValue } from '../utils/currency';\nimport { normalizePerformancePayload } from '../utils/performance';\n\nconst HOLDINGS_FRACTION_DIGITS = { min: 0, max: 6 } as const;\nconst PRICE_FRACTION_DIGITS = { min: 2, max: 4 } as const;\nconst DEFAULT_HISTORY_RANGE: SecurityHistoryRangeKey = '1Y';\nconst AVAILABLE_HISTORY_RANGES: readonly SecurityHistoryRangeKey[] = [\n  '1M',\n  '6M',\n  '1Y',\n  '5Y',\n  'ALL',\n];\nconst RANGE_DAY_COUNTS: Record<SecurityHistoryRangeKey, number> = {\n  '1M': 30,\n  '6M': 182,\n  '1Y': 365,\n  '5Y': 1826,\n  'ALL': Number.POSITIVE_INFINITY,\n};\n\ntype SecuritySnapshotDetail = Partial<Omit<SecuritySnapshotLike, 'security_uuid'>> & {\n  security_uuid?: string | null;\n  name?: string | null;\n  total_holdings?: number | string | null;\n  total_holdings_precise?: number | string | null;\n  last_price_native?: number | string | null;\n  last_price_eur?: number | string | null;\n  market_value_eur?: number | string | null;\n  current_value_eur?: number | string | null;\n  currency_code?: string | null;\n  last_close_native?: number | string | null;\n  last_close_eur?: number | string | null;\n  last_price?: {\n    native?: number | string | null;\n    [key: string]: unknown;\n  } | null;\n  source?: string | null;\n  [key: string]: unknown;\n};\n\ninterface RawHistoryEntry {\n  date?: unknown;\n  close?: unknown;\n  close_raw?: unknown;\n  [key: string]: unknown;\n}\n\ninterface NormalizedHistoryEntry {\n  date: Date | string | number;\n  close: number;\n}\n\ntype HistoryPlaceholderState =\n  | { status: 'loaded' }\n  | { status: 'empty' }\n  | { status: 'error'; message?: string };\n\ntype SecurityHistoryCache = Map<SecurityHistoryRangeKey, NormalizedHistoryEntry[]>;\n\ntype HistoryCacheRegistry = Map<string, SecurityHistoryCache>;\n\ntype RangeStateRegistry = Map<string, SecurityHistoryRangeState>;\n\ntype SnapshotDetailRegistry = Map<string, SecuritySnapshotDetail>;\n\nconst AVERAGE_COST_SOURCE_LABELS: Record<AverageCostSource, string> = {\n  aggregation: 'Aggregationsdaten',\n  totals: 'Kaufsummen',\n  eur_total: 'EUR-Kaufsumme',\n};\n\ntype LiveUpdateHandler = (event: Event) => void;\n\nconst SECURITY_HISTORY_CACHE: HistoryCacheRegistry = new Map();\nconst RANGE_STATE_REGISTRY: RangeStateRegistry = new Map();\nconst SNAPSHOT_DETAIL_REGISTRY: SnapshotDetailRegistry = new Map();\nconst LIVE_UPDATE_EVENT = 'pp-reader:portfolio-positions-updated';\nconst LIVE_UPDATE_HANDLERS = new Map<string, LiveUpdateHandler>();\n\nexport const __TEST_ONLY__ = {\n  getHistoryChartOptionsForTest: getHistoryChartOptions,\n  mergeHistoryWithSnapshotPriceForTest: (\n    historySeries: readonly NormalizedHistoryEntry[] | null | undefined,\n    snapshot: SecuritySnapshotDetail | null | undefined,\n  ): NormalizedHistoryEntry[] => buildHistorySeriesWithSnapshotPrice(historySeries, snapshot),\n  composeAveragePurchaseTooltipForTest: composeAveragePurchaseTooltip,\n  selectAveragePurchaseBaselineForTest: selectAveragePurchaseBaseline,\n  resolveAccountCurrencyCodeForTest: resolveAccountCurrencyCode,\n  resolvePurchaseFxTimestampForTest: resolvePurchaseFxTimestamp,\n  buildHeaderMetaForTest: buildHeaderMeta,\n};\n\nfunction buildCachedSnapshotNotice(params: {\n  fallbackUsed: boolean;\n  flaggedAsCache: boolean;\n}): string {\n  const { fallbackUsed, flaggedAsCache } = params;\n  const reasons: string[] = [];\n  if (fallbackUsed) {\n    reasons.push(\n      'Der aktuelle Snapshot konnte nicht geladen werden. Es werden die zuletzt gespeicherten Werte angezeigt.',\n    );\n  }\n  if (flaggedAsCache && !fallbackUsed) {\n    reasons.push(\n      'Der Snapshot ist vom Datenanbieter als Zwischenspeicherstand markiert.',\n    );\n  }\n\n  const reasonText = reasons.length\n    ? reasons.join(' ')\n    : 'Die Daten stammen aus dem Zwischenspeicher.';\n\n  return `\n    <div class=\"card warning-card stale-notice\" role=\"status\" aria-live=\"polite\">\n      <h2>Zwischengespeicherte Werte</h2>\n      <p>${reasonText}</p>\n      <p class=\"stale-notice__hint\">Die angezeigten Beträge können von den aktuellen Marktwerten abweichen. Laden Sie die Ansicht erneut, sobald eine Verbindung verfügbar ist.</p>\n    </div>\n  `;\n}\n\nfunction cacheSecuritySnapshotDetail(\n  securityUuid: string | null | undefined,\n  snapshot: SecuritySnapshotDetail | null,\n): void {\n  if (!securityUuid) {\n    return;\n  }\n\n  if (snapshot) {\n    SNAPSHOT_DETAIL_REGISTRY.set(securityUuid, snapshot);\n    return;\n  }\n\n  SNAPSHOT_DETAIL_REGISTRY.delete(securityUuid);\n}\n\nfunction getCachedSecuritySnapshot(\n  securityUuid: string | null | undefined,\n): SecuritySnapshotDetail | null {\n  if (!securityUuid || typeof window === 'undefined') {\n    return null;\n  }\n\n  if (SNAPSHOT_DETAIL_REGISTRY.has(securityUuid)) {\n    const cached = SNAPSHOT_DETAIL_REGISTRY.get(securityUuid) || null;\n    if (cached) {\n      return cached;\n    }\n  }\n\n  return null;\n}\n\nfunction ensureHistoryCache(securityUuid: string): SecurityHistoryCache {\n  if (!SECURITY_HISTORY_CACHE.has(securityUuid)) {\n    SECURITY_HISTORY_CACHE.set(securityUuid, new Map());\n  }\n  return SECURITY_HISTORY_CACHE.get(securityUuid) as SecurityHistoryCache;\n}\n\nfunction invalidateHistoryCache(securityUuid: string | null | undefined): void {\n  if (!securityUuid) {\n    return;\n  }\n\n  if (SECURITY_HISTORY_CACHE.has(securityUuid)) {\n    try {\n      const cache = SECURITY_HISTORY_CACHE.get(securityUuid);\n      if (cache) {\n        cache.clear();\n      }\n    } catch (error) {\n      console.warn('invalidateHistoryCache: Konnte Cache nicht leeren', securityUuid, error);\n    }\n    SECURITY_HISTORY_CACHE.delete(securityUuid);\n  }\n}\n\nfunction invalidateSnapshotCaches(securityUuid: string | null | undefined): void {\n  if (!securityUuid) {\n    return;\n  }\n\n  SNAPSHOT_DETAIL_REGISTRY.delete(securityUuid);\n}\n\nfunction handleLiveUpdateForSecurity(\n  securityUuid: string | null | undefined,\n  detail: PortfolioPositionsUpdatedEventDetail | null | undefined,\n): void {\n  if (!securityUuid || !detail) {\n    return;\n  }\n\n  const payload = detail.securityUuids;\n  const candidates = Array.isArray(payload) ? payload : [];\n\n  if (candidates.includes(securityUuid)) {\n    invalidateHistoryCache(securityUuid);\n    invalidateSnapshotCaches(securityUuid);\n  }\n}\n\nfunction ensureLiveUpdateSubscription(securityUuid: string | null | undefined): void {\n  if (!securityUuid || LIVE_UPDATE_HANDLERS.has(securityUuid)) {\n    return;\n  }\n\n  const handler: LiveUpdateHandler = (event) => {\n    if (!isPortfolioPositionsUpdatedEvent(event)) {\n      return;\n    }\n    handleLiveUpdateForSecurity(securityUuid, event.detail);\n  };\n\n  try {\n    window.addEventListener(LIVE_UPDATE_EVENT, handler as EventListener);\n    LIVE_UPDATE_HANDLERS.set(securityUuid, handler);\n  } catch (error) {\n    console.error('ensureLiveUpdateSubscription: Registrierung fehlgeschlagen', error);\n  }\n}\n\nfunction removeLiveUpdateSubscription(securityUuid: string): void {\n  if (!securityUuid || !LIVE_UPDATE_HANDLERS.has(securityUuid)) {\n    return;\n  }\n\n  const handler = LIVE_UPDATE_HANDLERS.get(securityUuid);\n  try {\n    if (handler) {\n      window.removeEventListener(LIVE_UPDATE_EVENT, handler as EventListener);\n    }\n  } catch (error) {\n    console.error('removeLiveUpdateSubscription: Entfernen des Listeners fehlgeschlagen', error);\n  }\n\n  LIVE_UPDATE_HANDLERS.delete(securityUuid);\n}\n\nfunction cleanupSecurityDetailState(securityUuid: string): void {\n  if (!securityUuid) {\n    return;\n  }\n\n  removeLiveUpdateSubscription(securityUuid);\n  invalidateHistoryCache(securityUuid);\n  invalidateSnapshotCaches(securityUuid);\n  // RANGE_STATE_REGISTRY intentionally left intact so the last chosen\n  // range remains active when the user reopens the security detail.\n}\n\nfunction setActiveRange(securityUuid: string, rangeKey: SecurityHistoryRangeKey): void {\n  if (!RANGE_STATE_REGISTRY.has(securityUuid)) {\n    RANGE_STATE_REGISTRY.set(securityUuid, { activeRange: rangeKey });\n    return;\n  }\n  const state = RANGE_STATE_REGISTRY.get(securityUuid);\n  if (state) {\n    state.activeRange = rangeKey;\n  }\n}\n\nfunction getActiveRange(securityUuid: string): SecurityHistoryRangeKey {\n  return (\n    RANGE_STATE_REGISTRY.get(securityUuid)?.activeRange ?? DEFAULT_HISTORY_RANGE\n  );\n}\n\nfunction toEpochDay(date: Date): number {\n  const epochMs = Date.UTC(\n    date.getUTCFullYear(),\n    date.getUTCMonth(),\n    date.getUTCDate(),\n  );\n  return Math.floor(epochMs / 86400000);\n}\n\nfunction normaliseDate(date: Date): Date {\n  const clone = new Date(date.getTime());\n  clone.setUTCHours(0, 0, 0, 0);\n  return clone;\n}\n\nfunction toFiniteNumber(value: unknown): number | null {\n  return toFiniteCurrency(value);\n}\n\nfunction toNonEmptyTrimmedString(value: unknown): string | null {\n  if (typeof value !== 'string') {\n    return null;\n  }\n\n  const trimmed = value.trim();\n  return trimmed ? trimmed : null;\n}\n\nfunction toUppercaseCode(value: unknown): string | null {\n  const normalized = toNonEmptyTrimmedString(value);\n  return normalized ? normalized.toUpperCase() : null;\n}\n\nfunction formatErrorLabel(error: unknown, fallback = 'Unbekannter Fehler'): string {\n  if (typeof error === 'string') {\n    const trimmed = error.trim();\n    return trimmed ? trimmed : fallback;\n  }\n\n  if (error instanceof Error) {\n    const trimmed = error.message.trim();\n    return trimmed ? trimmed : fallback;\n  }\n\n  if (error != null) {\n    try {\n      const serialized = JSON.stringify(error);\n      if (serialized && serialized !== '{}') {\n        return serialized;\n      }\n    } catch {\n      // Ignore serialization issues and fall through to fallback label.\n    }\n  }\n\n  return fallback;\n}\n\nfunction resolveRangeOptions(rangeKey: SecurityHistoryRangeKey): SecurityHistoryOptions {\n  const now = normaliseDate(new Date());\n  const rangeDays = RANGE_DAY_COUNTS[rangeKey];\n  const options: SecurityHistoryOptions = { end_date: toEpochDay(now) };\n\n  if (Number.isFinite(rangeDays) && rangeDays > 0) {\n    const start = new Date(now.getTime());\n    start.setUTCDate(start.getUTCDate() - (rangeDays - 1));\n    options.start_date = toEpochDay(start);\n  }\n\n  return options;\n}\n\nfunction parseHistoryDate(raw: unknown): Date | null {\n  if (!raw) {\n    return null;\n  }\n\n  if (raw instanceof Date && !Number.isNaN(raw.getTime())) {\n    return new Date(raw.getTime());\n  }\n\n  if (typeof raw === 'number' && Number.isFinite(raw)) {\n    const timestamp = raw * 86400000;\n    if (Number.isFinite(timestamp)) {\n      return new Date(timestamp);\n    }\n  }\n\n  if (typeof raw === 'string') {\n    const trimmed = raw.trim();\n    if (/^\\d{8}$/.test(trimmed)) {\n      const year = Number.parseInt(trimmed.slice(0, 4), 10);\n      const month = Number.parseInt(trimmed.slice(4, 6), 10) - 1;\n      const day = Number.parseInt(trimmed.slice(6, 8), 10);\n      if (\n        Number.isFinite(year) &&\n        Number.isFinite(month) &&\n        Number.isFinite(day)\n      ) {\n        const date = new Date(Date.UTC(year, month, day));\n        if (!Number.isNaN(date.getTime())) {\n          return date;\n        }\n      }\n    }\n\n    const parsed = Date.parse(trimmed);\n    if (Number.isFinite(parsed)) {\n      return new Date(parsed);\n    }\n  }\n\n  return null;\n}\n\nfunction parseTimestamp(value: unknown): number | null {\n  if (!value && value !== 0) {\n    return null;\n  }\n\n  if (value instanceof Date && !Number.isNaN(value.getTime())) {\n    return value.getTime();\n  }\n\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    if (value > 1e12) {\n      return value;\n    }\n\n    if (value > 1e9) {\n      return value * 1000;\n    }\n  }\n\n  if (typeof value === 'string') {\n    const trimmed = value.trim();\n    if (!trimmed) {\n      return null;\n    }\n\n    const parsed = Date.parse(trimmed);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return null;\n}\n\nfunction normaliseHistorySeries(prices: unknown): NormalizedHistoryEntry[] {\n  if (!Array.isArray(prices)) {\n    return [];\n  }\n\n  return (prices as RawHistoryEntry[])\n    .map((entry): NormalizedHistoryEntry | null => {\n      const normalizedClose = toFiniteNumber(entry.close);\n      let close = normalizedClose;\n      if (close == null) {\n        const rawClose = toFiniteNumber(entry.close_raw);\n        if (rawClose != null) {\n          close = rawClose / 1e8;\n        }\n      }\n\n      if (close == null) {\n        return null;\n      }\n\n      const dateValue = parseHistoryDate(entry.date);\n\n      return {\n        date: dateValue ?? (entry.date as Date | string | number),\n        close,\n      };\n    })\n    .filter((entry): entry is NormalizedHistoryEntry => Boolean(entry));\n}\n\nfunction extractSnapshotLastPriceNative(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): number | null {\n  const native =\n    toFiniteNumber(snapshot?.last_price_native) ??\n    toFiniteNumber(snapshot?.last_price?.native) ??\n    null;\n\n  if (isFiniteNumber(native)) {\n    return native;\n  }\n\n  const currency = toUppercaseCode(snapshot?.currency_code);\n  if (currency === 'EUR') {\n    const lastPriceEur = toFiniteNumber(snapshot?.last_price_eur);\n    if (isFiniteNumber(lastPriceEur)) {\n      return lastPriceEur;\n    }\n  }\n\n  return null;\n}\n\nfunction extractSnapshotLastPriceTimestamp(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): number | null {\n  if (!snapshot) {\n    return null;\n  }\n\n  const snapshotRecord = snapshot as { last_price_fetched_at?: unknown };\n  const fetchedAt = snapshotRecord.last_price_fetched_at;\n  const normalizedFetchedAt = parseTimestamp(fetchedAt);\n  if (normalizedFetchedAt != null) {\n    return normalizedFetchedAt;\n  }\n\n  const lastPriceRecord = snapshot.last_price as { fetched_at?: unknown } | null | undefined;\n  const lastPriceFetchedAt = lastPriceRecord?.fetched_at;\n  const normalizedLastPriceFetchedAt = parseTimestamp(lastPriceFetchedAt);\n  return normalizedLastPriceFetchedAt ?? null;\n}\n\nfunction buildHistorySeriesWithSnapshotPrice(\n  historySeries: readonly NormalizedHistoryEntry[] | null | undefined,\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): NormalizedHistoryEntry[] {\n  let baseSeries: NormalizedHistoryEntry[] = [];\n  if (Array.isArray(historySeries)) {\n    baseSeries = (historySeries as NormalizedHistoryEntry[]).map((entry) => ({\n      ...entry,\n    }));\n  }\n  const seriesWithSnapshot: NormalizedHistoryEntry[] = baseSeries.slice();\n\n  const lastPriceNative = extractSnapshotLastPriceNative(snapshot);\n  if (!isFiniteNumber(lastPriceNative)) {\n    return seriesWithSnapshot;\n  }\n\n  const lastPriceTimestamp = extractSnapshotLastPriceTimestamp(snapshot) ?? Date.now();\n  const candidateDate = new Date(lastPriceTimestamp);\n  if (Number.isNaN(candidateDate.getTime())) {\n    return seriesWithSnapshot;\n  }\n\n  const targetDay = toEpochDay(normaliseDate(candidateDate));\n  let latestSeriesDay: number | null = null;\n\n  for (let index = seriesWithSnapshot.length - 1; index >= 0; index -= 1) {\n    const entry = seriesWithSnapshot[index];\n    const parsedDate = parseHistoryDate(entry.date);\n    if (!parsedDate) {\n      continue;\n    }\n\n    const entryDay = toEpochDay(normaliseDate(parsedDate));\n    if (latestSeriesDay == null) {\n      latestSeriesDay = entryDay;\n    }\n\n    if (entryDay === targetDay) {\n      if (entry.close !== lastPriceNative) {\n        seriesWithSnapshot[index] = { ...entry, close: lastPriceNative };\n      }\n      return seriesWithSnapshot;\n    }\n\n    if (entryDay < targetDay) {\n      break;\n    }\n  }\n\n  if (latestSeriesDay != null && latestSeriesDay > targetDay) {\n    return seriesWithSnapshot;\n  }\n\n  seriesWithSnapshot.push({\n    date: candidateDate,\n    close: lastPriceNative,\n  });\n\n  return seriesWithSnapshot;\n}\n\nfunction isFiniteNumber(value: number | null | undefined): value is number {\n  return typeof value === 'number' && Number.isFinite(value);\n}\n\nfunction isPositiveFinite(value: number | null | undefined): value is number {\n  return typeof value === 'number' && Number.isFinite(value) && value > 0;\n}\n\nfunction areNumbersClose(\n  first: number | null | undefined,\n  second: number | null | undefined,\n  tolerance?: number,\n): boolean {\n  if (!isFiniteNumber(first) || !isFiniteNumber(second)) {\n    return false;\n  }\n\n  const absoluteDiff = Math.abs(first - second);\n  if (tolerance != null) {\n    return absoluteDiff <= tolerance;\n  }\n\n  const scale = Math.max(Math.abs(first), Math.abs(second), 1);\n  return absoluteDiff <= scale * 1e-4;\n}\n\nfunction computePercentageChange(\n  current: number | null,\n  reference: number | null,\n): number | null {\n  if (!isFiniteNumber(reference) || reference === 0 || !isFiniteNumber(current)) {\n    return null;\n  }\n\n  return normalizePercentValue(((current - reference) / reference) * 100);\n}\n\nfunction computePriceChangeMetrics(\n  historySeries: readonly NormalizedHistoryEntry[],\n  lastPriceNative: number | null,\n): { priceChange: number | null; priceChangePct: number | null } {\n  if (historySeries.length === 0) {\n    return { priceChange: null, priceChangePct: null };\n  }\n\n  const firstEntry = historySeries[0];\n  const baseline = toFiniteNumber(firstEntry.close);\n  if (!isFiniteNumber(baseline) || baseline === 0) {\n    return { priceChange: null, priceChangePct: null };\n  }\n\n  const lastEntry = historySeries[historySeries.length - 1];\n  const fallbackLast = toFiniteNumber(lastEntry.close);\n  const effectiveLast =\n    toFiniteNumber(lastPriceNative) ?? fallbackLast;\n\n  if (!isFiniteNumber(effectiveLast)) {\n    return { priceChange: null, priceChangePct: null };\n  }\n\n  const rawDelta = effectiveLast - baseline;\n  const priceChange = Object.is(rawDelta, -0) ? 0 : rawDelta;\n  const priceChangePct = computePercentageChange(effectiveLast, baseline);\n\n  return { priceChange, priceChangePct };\n}\n\nfunction resolveRoundedTrendClass(\n  value: number | null | undefined,\n  decimals: number,\n): 'positive' | 'negative' | 'neutral' {\n  if (!isFiniteNumber(value) || value === 0) {\n    return 'neutral';\n  }\n\n  const threshold = 0.5 / Math.pow(10, decimals);\n  if (Math.abs(value) < threshold) {\n    return 'neutral';\n  }\n\n  return value > 0 ? 'positive' : 'negative';\n}\n\nfunction formatPriceChangeValue(\n  value: number | null,\n  currency: string | null | undefined,\n): string {\n  if (!isFiniteNumber(value)) {\n    return '<span class=\"value neutral\">—</span>';\n  }\n\n  const formatted = formatPrice(value);\n  if (formatted === '—') {\n    return '<span class=\"value neutral\">—</span>';\n  }\n\n  const trendClass = resolveRoundedTrendClass(value, PRICE_FRACTION_DIGITS.max);\n  const suffix = currency ? `&nbsp;${currency}` : '';\n  return `<span class=\"value ${trendClass}\">${formatted}${suffix}</span>`;\n}\n\nfunction formatPercentageChangeValue(value: number | null): string {\n  if (!isFiniteNumber(value)) {\n    return '<span class=\"value neutral\">—</span>';\n  }\n\n  const trendClass = resolveRoundedTrendClass(value, 2);\n  return `<span class=\"value ${trendClass} value--percentage\">${formatNumber(value)}&nbsp;%</span>`;\n}\n\nfunction buildInfoBar(\n  rangeKey: SecurityHistoryRangeKey,\n  priceChange: number | null,\n  priceChangePct: number | null,\n  currency: string | null | undefined,\n): string {\n  const rangeLabel = rangeKey;\n  const rangeCaption = rangeLabel.length > 0 ? rangeLabel : 'Zeitraum';\n  return `\n    <div class=\"security-info-bar\" data-range=\"${rangeLabel}\">\n      <div class=\"security-info-item\">\n        <span class=\"label\">Preisänderung (${rangeCaption})</span>\n        <div class=\"value-row\">\n          ${formatPriceChangeValue(priceChange, currency)}\n          ${formatPercentageChangeValue(priceChangePct)}\n        </div>\n      </div>\n    </div>\n  `;\n}\n\nfunction buildRangeSelector(activeRange: SecurityHistoryRangeKey): string {\n  const buttons = AVAILABLE_HISTORY_RANGES.map((rangeKey) => {\n    const activeClass = rangeKey === activeRange ? ' active' : '';\n    return `\n      <button\n        type=\"button\"\n        class=\"security-range-button${activeClass}\"\n        data-range=\"${rangeKey}\"\n        aria-pressed=\"${rangeKey === activeRange ? 'true' : 'false'}\"\n      >\n        ${rangeKey}\n      </button>\n    `;\n  });\n\n  return `\n    <div class=\"security-range-selector\" role=\"group\" aria-label=\"Zeitraum\">\n      ${buttons.join('\\n')}\n    </div>\n  `;\n}\n\nfunction buildHistoryPlaceholder(\n  rangeKey: SecurityHistoryRangeKey,\n  state: HistoryPlaceholderState = { status: 'empty' },\n): string {\n  const safeRange = rangeKey;\n\n  switch (state.status) {\n    case 'loaded': {\n      const ariaSuffix = safeRange.length > 0 ? ` für ${safeRange}` : '';\n      return `\n        <div\n          class=\"history-chart\"\n          data-state=\"loaded\"\n          data-range=\"${safeRange}\"\n          role=\"img\"\n          aria-label=\"Preisverlauf${ariaSuffix}\"\n        ></div>\n      `;\n    }\n    case 'error': {\n      const message = formatErrorLabel(\n        state.message,\n        'Die historischen Daten konnten nicht geladen werden.',\n      );\n      return `\n        <div class=\"history-placeholder\" data-state=\"error\" data-range=\"${safeRange}\">\n          <p>${message}</p>\n        </div>\n      `;\n    }\n    case 'empty':\n    default: {\n      const rangeDescriptor = safeRange.length > 0 ? safeRange : 'den gewählten Zeitraum';\n      return `\n        <div class=\"history-placeholder\" data-state=\"empty\" data-range=\"${safeRange}\">\n          <p>Für dieses Wertpapier liegen im Zeitraum ${rangeDescriptor} keine historischen Daten vor.</p>\n        </div>\n      `;\n    }\n  }\n}\n\nfunction formatHoldings(value: unknown): string {\n  const numeric = toFiniteNumber(value);\n  if (numeric == null) {\n    return '—';\n  }\n\n  const hasFraction = Math.abs(numeric % 1) > 0;\n  const minFraction = hasFraction ? 2 : HOLDINGS_FRACTION_DIGITS.min;\n  const maxFraction = hasFraction ? HOLDINGS_FRACTION_DIGITS.max : HOLDINGS_FRACTION_DIGITS.min;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: minFraction,\n    maximumFractionDigits: maxFraction,\n  });\n}\n\nfunction formatPrice(value: unknown): string {\n  const numeric = toFiniteNumber(value);\n  if (numeric == null) {\n    return '—';\n  }\n\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: PRICE_FRACTION_DIGITS.min,\n    maximumFractionDigits: PRICE_FRACTION_DIGITS.max,\n  });\n}\n\nfunction formatPriceChangeWithCurrency(\n  value: number,\n  currency: string,\n): string {\n  const formatted = formatPrice(value);\n  const suffix = currency ? `&nbsp;${currency}` : '';\n  const className = resolveRoundedTrendClass(value, PRICE_FRACTION_DIGITS.max);\n  return `<span class=\"${className}\">${formatted}${suffix}</span>`;\n}\n\nfunction escapeAttribute(\n  value: string | number | boolean | null | undefined,\n): string {\n  if (value === null || value === undefined) {\n    return '';\n  }\n\n  const raw = typeof value === 'string' ? value : String(value);\n\n  return raw\n    .replace(/&/g, '&amp;')\n    .replace(/\"/g, '&quot;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;');\n}\n\nfunction resolveAccountCurrencyCode(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n  accountAverage: number | null | undefined,\n  securityAverage: number | null | undefined,\n): string | null {\n  const normalizedAverageCost = normalizeAverageCostPayload(snapshot?.average_cost);\n  const accountAverageNumeric =\n    normalizedAverageCost?.account ??\n    (isFiniteNumber(accountAverage) ? accountAverage : toFiniteNumber(accountAverage));\n\n  if (!isFiniteNumber(accountAverageNumeric)) {\n    return null;\n  }\n\n  const rawExplicit =\n    (snapshot as { account_currency_code?: unknown } | null | undefined)?.account_currency_code ??\n    (snapshot as { account_currency?: unknown } | null | undefined)?.account_currency;\n  if (typeof rawExplicit === 'string' && rawExplicit.trim()) {\n    return rawExplicit.trim().toUpperCase();\n  }\n\n  const securityCurrency = toUppercaseCode(snapshot?.currency_code) ?? '';\n  const securityAverageNumeric =\n    normalizedAverageCost?.security ??\n    normalizedAverageCost?.native ??\n    (isFiniteNumber(securityAverage) ? securityAverage : toFiniteNumber(securityAverage));\n\n  const aggregation = normalizeAggregationPayload(snapshot?.aggregation);\n  if (\n    securityCurrency &&\n    isFiniteNumber(securityAverageNumeric) &&\n    areNumbersClose(accountAverageNumeric, securityAverageNumeric)\n  ) {\n    return securityCurrency;\n  }\n\n  const securityTotal =\n    toFiniteNumber(aggregation?.purchase_total_security) ??\n    toFiniteNumber((snapshot as { purchase_total_security?: unknown } | null | undefined)?.purchase_total_security);\n  const accountTotal =\n    toFiniteNumber(aggregation?.purchase_total_account) ??\n    toFiniteNumber((snapshot as { purchase_total_account?: unknown } | null | undefined)?.purchase_total_account);\n  let ratio: number | null = null;\n  if (isFiniteNumber(securityTotal) && securityTotal !== 0 && isFiniteNumber(accountTotal)) {\n    ratio = accountTotal / securityTotal;\n  }\n\n  const averageSource = normalizedAverageCost?.source;\n  if (averageSource === 'eur_total') {\n    return 'EUR';\n  }\n\n  const averageEur = normalizedAverageCost?.eur;\n  if (isFiniteNumber(averageEur) && areNumbersClose(accountAverageNumeric, averageEur)) {\n    return 'EUR';\n  }\n\n  const purchaseValueEur = toFiniteNumber(snapshot?.purchase_value_eur);\n  if (isFiniteNumber(purchaseValueEur)) {\n    return 'EUR';\n  }\n\n  if (ratio != null && areNumbersClose(ratio, 1)) {\n    return securityCurrency || null;\n  }\n\n  if (securityCurrency === 'EUR') {\n    return 'EUR';\n  }\n\n  return securityCurrency || 'EUR';\n}\n\nfunction formatFxRate(value: number | null | undefined): string | null {\n  if (typeof value !== 'number' || !Number.isFinite(value) || value <= 0) {\n    return null;\n  }\n\n  return value.toLocaleString('de-DE', {\n    minimumFractionDigits: 4,\n    maximumFractionDigits: 4,\n  });\n}\n\nfunction resolvePurchaseFxTimestamp(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): number | null {\n  const snapshotRecord = snapshot as Record<string, unknown> | null | undefined;\n  const candidateKeys = [\n    'purchase_fx_date',\n    'purchase_fx_timestamp',\n    'purchase_fx_rate_date',\n    'purchase_fx_rate_timestamp',\n    'avg_price_updated_at',\n    'avg_price_timestamp',\n    'purchase_updated_at',\n    'purchase_updated',\n    'purchase_value_updated_at',\n    'purchase_value_updated',\n    'last_purchase_date',\n    'last_purchase_timestamp',\n    'last_transaction_date',\n    'last_transaction_at',\n  ] as const;\n\n  for (const key of candidateKeys) {\n    const value = snapshotRecord?.[key];\n    const parsed = parseTimestamp(value);\n    if (parsed != null) {\n      return parsed;\n    }\n  }\n\n  const fallbackCandidates: unknown[] = [];\n  if (snapshotRecord && 'last_price_fetched_at' in snapshotRecord) {\n    fallbackCandidates.push(snapshotRecord.last_price_fetched_at);\n  }\n  const lastPrice = (snapshot as { last_price?: { fetched_at?: unknown } | null } | null)?.last_price;\n  if (lastPrice && typeof lastPrice === 'object') {\n    fallbackCandidates.push(lastPrice.fetched_at);\n  }\n  if (snapshotRecord && 'last_price_date' in snapshotRecord) {\n    fallbackCandidates.push(snapshotRecord.last_price_date);\n  }\n\n  for (const candidate of fallbackCandidates) {\n    const parsed = parseTimestamp(candidate);\n    if (parsed != null) {\n      return parsed;\n    }\n  }\n\n  return null;\n}\n\nfunction formatFxDateLabel(timestamp: number | null): string | null {\n  if (timestamp == null || !Number.isFinite(timestamp)) {\n    return null;\n  }\n\n  const date = new Date(timestamp);\n  if (Number.isNaN(date.getTime())) {\n    return null;\n  }\n\n  return date.toLocaleDateString('de-DE', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric',\n  });\n}\n\nfunction composeAveragePurchaseTooltip(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n  accountCurrency: string | null | undefined,\n): string | null {\n  if (!snapshot) {\n    return null;\n  }\n  const securityCurrency = toUppercaseCode(snapshot.currency_code) ?? '';\n  const accountCurrencySafe = toUppercaseCode(accountCurrency) ?? '';\n\n  if (!securityCurrency || !accountCurrencySafe || securityCurrency === accountCurrencySafe) {\n    return null;\n  }\n\n  const averageCost = normalizeAverageCostPayload(snapshot.average_cost);\n  if (!averageCost) {\n    return null;\n  }\n\n  const securityAverage = averageCost.native ?? averageCost.security ?? null;\n  const accountAverage = averageCost.account ?? averageCost.eur ?? null;\n\n  if (!isPositiveFinite(securityAverage) || !isPositiveFinite(accountAverage)) {\n    return null;\n  }\n\n  const fxRate = accountAverage / securityAverage;\n  if (!Number.isFinite(fxRate) || fxRate <= 0) {\n    return null;\n  }\n\n  const formattedRate = formatFxRate(fxRate);\n  if (!formattedRate) {\n    return null;\n  }\n\n  let inverseRateLabel: string | null = null;\n  if (fxRate > 0) {\n    const inverse = 1 / fxRate;\n    if (Number.isFinite(inverse) && inverse > 0) {\n      inverseRateLabel = formatFxRate(inverse);\n    }\n  }\n\n  const timestamp = resolvePurchaseFxTimestamp(snapshot);\n  const dateLabel = formatFxDateLabel(timestamp);\n\n  const parts = [`FX-Kurs (Kauf): 1 ${securityCurrency} = ${formattedRate} ${accountCurrencySafe}`];\n  if (inverseRateLabel) {\n    parts.push(`1 ${accountCurrencySafe} = ${inverseRateLabel} ${securityCurrency}`);\n  }\n\n  const metadataParts: string[] = [];\n  const sourceKey = averageCost.source;\n  const sourceLabel =\n    sourceKey in AVERAGE_COST_SOURCE_LABELS\n      ? AVERAGE_COST_SOURCE_LABELS[sourceKey]\n      : AVERAGE_COST_SOURCE_LABELS.aggregation;\n  metadataParts.push(`Quelle: ${sourceLabel}`);\n\n  if (isFiniteNumber(averageCost.coverage_ratio)) {\n    const percentage = Math.min(Math.max(averageCost.coverage_ratio * 100, 0), 100);\n    metadataParts.push(\n      `Abdeckung: ${percentage.toLocaleString('de-DE', {\n        minimumFractionDigits: 1,\n        maximumFractionDigits: 1,\n      })}%`,\n    );\n  }\n\n  if (metadataParts.length) {\n    parts.push(...metadataParts);\n  }\n\n  const datePart = dateLabel ?? 'Datum unbekannt';\n  return `${parts.join(' · ')} (Stand: ${datePart})`;\n}\n\nfunction selectAveragePurchaseBaseline(\n  snapshot: SecuritySnapshotDetail | null | undefined,\n): number | null {\n  if (!snapshot) {\n    return null;\n  }\n  const averageCost = normalizeAverageCostPayload(snapshot.average_cost);\n  const baseline = averageCost?.native ?? averageCost?.security ?? null;\n  return isFiniteNumber(baseline) ? baseline : null;\n}\n\nfunction buildHeaderMeta(snapshot: SecuritySnapshotDetail | null): string {\n  if (!snapshot) {\n    return '<div class=\"meta-error\">Keine Snapshot-Daten verfügbar.</div>';\n  }\n\n  const currency = snapshot.currency_code || 'EUR';\n  const holdingsSource = snapshot.total_holdings_precise ?? snapshot.total_holdings;\n  const holdings = formatHoldings(holdingsSource);\n  const lastPriceNativeRaw =\n    snapshot.last_price_native ?? snapshot.last_price?.native ?? snapshot.last_price_eur;\n  const formattedLastPrice = formatPrice(lastPriceNativeRaw);\n  const lastPriceDisplay =\n    formattedLastPrice === '—'\n      ? null\n      : `${formattedLastPrice}${currency ? `&nbsp;${currency}` : ''}`;\n  const marketValueRaw =\n    toFiniteNumber(snapshot.market_value_eur) ??\n    toFiniteNumber(snapshot.current_value_eur) ??\n    null;\n  const averageCost = normalizeAverageCostPayload(snapshot.average_cost);\n  const averagePurchaseNativeRaw =\n    averageCost?.native ??\n    averageCost?.security ??\n    null;\n  const averagePurchaseEurRaw = averageCost?.eur ?? null;\n  const averagePurchaseAccountRaw = averageCost?.account ?? null;\n  const resolvedAccountAverage = averagePurchaseAccountRaw ?? averagePurchaseEurRaw;\n  const performancePayload = normalizePerformancePayload(snapshot.performance);\n  const dayChangePayload = performancePayload?.day_change ?? null;\n  const dayPriceChangeNative = dayChangePayload?.price_change_native ?? null;\n  const dayPriceChangeEur = dayChangePayload?.price_change_eur ?? null;\n  const dayChangeValue = isFiniteNumber(dayPriceChangeNative)\n    ? dayPriceChangeNative\n    : dayPriceChangeEur;\n  const dayChangeCurrency = isFiniteNumber(dayPriceChangeNative)\n    ? currency\n    : 'EUR';\n\n  const wrapValue = (content: string, extraClass = ''): string => {\n    const classes = ['value'];\n    if (extraClass) {\n      classes.push(...extraClass.split(' ').filter(Boolean));\n    }\n    return `<span class=\"${classes.join(' ')}\">${content}</span>`;\n  };\n\n  const wrapMissingValue = (extraClass = ''): string => {\n    const classes = ['value--missing'];\n    if (extraClass) {\n      classes.push(extraClass);\n    }\n    return wrapValue('—', classes.join(' '));\n  };\n\n  const renderGainValue = (\n    value: number | null | undefined,\n    extraClass = '',\n  ): string => {\n    if (!isFiniteNumber(value)) {\n      return wrapMissingValue(extraClass);\n    }\n\n    const classes = ['value--gain'];\n    if (extraClass) {\n      classes.push(extraClass);\n    }\n    return wrapValue(formatGain(value), classes.join(' '));\n  };\n\n  const renderGainPercentage = (\n    value: number | null | undefined,\n    extraClass = '',\n  ): string => {\n    if (!isFiniteNumber(value)) {\n      return wrapMissingValue(extraClass);\n    }\n\n    const classes = ['value--gain-percentage'];\n    if (extraClass) {\n      classes.push(extraClass);\n    }\n    return wrapValue(formatGainPct(value), classes.join(' '));\n  };\n\n  const lastPriceValue = lastPriceDisplay\n    ? wrapValue(lastPriceDisplay, 'value--price')\n    : wrapMissingValue('value--price');\n  const holdingsValue =\n    holdings === '—'\n      ? wrapMissingValue('value--holdings')\n      : wrapValue(holdings, 'value--holdings');\n  const marketValue = isFiniteNumber(marketValueRaw)\n    ? wrapValue(`${formatNumber(marketValueRaw)}&nbsp;€`, 'value--market-value')\n    : wrapMissingValue('value--market-value');\n  const dayChangeAbsolute = isFiniteNumber(dayChangeValue)\n    ? wrapValue(\n        formatPriceChangeWithCurrency(dayChangeValue, dayChangeCurrency),\n        'value--gain value--absolute',\n      )\n    : wrapMissingValue('value--absolute');\n  const dayChangePercentage = renderGainPercentage(\n    dayChangePayload?.change_pct,\n    'value--percentage',\n  );\n  const totalChangeAbsolute = renderGainValue(\n    performancePayload?.total_change_eur,\n    'value--absolute',\n  );\n  const totalChangePercentage = renderGainPercentage(\n    performancePayload?.total_change_pct,\n    'value--percentage',\n  );\n  const accountCurrency = resolveAccountCurrencyCode(\n    snapshot,\n    resolvedAccountAverage,\n    averagePurchaseNativeRaw,\n  );\n  const averagePurchaseTooltip = composeAveragePurchaseTooltip(\n    snapshot,\n    accountCurrency,\n  );\n  const averageValueGroupAttributes = averagePurchaseTooltip\n    ? ` title=\"${escapeAttribute(averagePurchaseTooltip)}\"`\n    : '';\n  const averagePurchaseValues: string[] = [];\n\n  if (isFiniteNumber(averagePurchaseNativeRaw)) {\n    averagePurchaseValues.push(\n      wrapValue(\n        `${formatPrice(averagePurchaseNativeRaw)}${\n          currency ? `&nbsp;${currency}` : ''\n        }`,\n        'value--average value--average-native',\n      ),\n    );\n  } else {\n    averagePurchaseValues.push(\n      wrapMissingValue('value--average value--average-native'),\n    );\n  }\n\n  const shouldRenderAccountValue =\n    isFiniteNumber(resolvedAccountAverage) &&\n    (!isFiniteNumber(averagePurchaseNativeRaw) ||\n      !accountCurrency ||\n      !currency ||\n      accountCurrency !== currency ||\n      !areNumbersClose(resolvedAccountAverage, averagePurchaseNativeRaw));\n\n  if (shouldRenderAccountValue && isFiniteNumber(resolvedAccountAverage)) {\n    averagePurchaseValues.push(\n      wrapValue(\n        `${formatPrice(resolvedAccountAverage)}${\n          accountCurrency ? `&nbsp;${accountCurrency}` : ''\n        }`,\n        'value--average value--average-eur',\n      ),\n    );\n  }\n\n  return `\n    <div class=\"security-meta-grid security-meta-grid--expanded\">\n      <div class=\"security-meta-item security-meta-item--price\">\n        <span class=\"label\">Letzter Preis</span>\n        <div class=\"value-group\">${lastPriceValue}</div>\n      </div>\n      <div class=\"security-meta-item security-meta-item--average\">\n        <span class=\"label\">Durchschnittlicher Kaufpreis</span>\n        <div class=\"value-group\"${averageValueGroupAttributes}>\n          ${averagePurchaseValues.join('')}\n        </div>\n      </div>\n      <div class=\"security-meta-item security-meta-item--day-change\">\n        <span class=\"label\">Tagesänderung</span>\n        <div class=\"value-group\">\n          ${dayChangeAbsolute}\n          ${dayChangePercentage}\n        </div>\n      </div>\n      <div class=\"security-meta-item security-meta-item--total-change\">\n        <span class=\"label\">Gesamtänderung</span>\n        <div class=\"value-group\">\n          ${totalChangeAbsolute}\n          ${totalChangePercentage}\n        </div>\n      </div>\n      <div class=\"security-meta-item security-meta-item--holdings\">\n        <span class=\"label\">Bestand</span>\n        <div class=\"value-group\">${holdingsValue}</div>\n      </div>\n      <div class=\"security-meta-item security-meta-item--market-value\">\n        <span class=\"label\">Marktwert (EUR)</span>\n        <div class=\"value-group\">${marketValue}</div>\n      </div>\n    </div>\n  `;\n}\n\nfunction normaliseHistoryError(error: unknown): string | null {\n  if (!error) {\n    return null;\n  }\n\n  if (typeof error === 'string') {\n    return error;\n  }\n\n  if (error instanceof Error) {\n    return error.message || null;\n  }\n\n  try {\n    const serialized = JSON.stringify(error);\n    return serialized && serialized !== '{}' ? serialized : null;\n  } catch (_jsonError) {\n    return null;\n  }\n}\n\nfunction getHistoryChartOptions(\n  host: HTMLElement,\n  series: readonly NormalizedHistoryEntry[],\n  {\n    currency,\n    baseline,\n  }: { currency?: string | null | undefined; baseline?: number | null | undefined } = {},\n): LineChartOptions {\n  const measuredWidth = host.clientWidth || host.offsetWidth || 0;\n  const width = measuredWidth > 0 ? measuredWidth : 640;\n  const height = Math.min(Math.max(Math.floor(width * 0.55), 220), 420);\n  const safeCurrency = (currency || '').toUpperCase() || 'EUR';\n  const baselineValue = isFiniteNumber(baseline) ? baseline : null;\n\n  return {\n    width,\n    height,\n    margin: { top: 16, right: 20, bottom: 32, left: 20 },\n    series,\n    yFormatter: (value) => formatPrice(value),\n    tooltipRenderer: ({ xFormatted, yFormatted }) => `\n      <div class=\"chart-tooltip-date\">${xFormatted}</div>\n      <div class=\"chart-tooltip-value\">${yFormatted}&nbsp;${safeCurrency}</div>\n    `,\n    baseline:\n      baselineValue != null\n        ? {\n            value: baselineValue,\n          }\n        : null,\n  };\n}\n\nconst HISTORY_CHART_INSTANCES = new WeakMap<\n  HTMLElement,\n  ReturnType<typeof renderLineChart>\n>();\n\nfunction renderHistoryChart(\n  host: HTMLElement,\n  series: readonly NormalizedHistoryEntry[],\n  options: {\n    currency?: string | null | undefined;\n    baseline?: number | null | undefined;\n  } = {},\n): void {\n  if (series.length === 0) {\n    return;\n  }\n\n  const chartOptions = getHistoryChartOptions(host, series, options);\n  let chartContainer = HISTORY_CHART_INSTANCES.get(host) ?? null;\n\n  if (!chartContainer || !host.contains(chartContainer)) {\n    host.innerHTML = '';\n    chartContainer = renderLineChart(host, chartOptions);\n    if (chartContainer) {\n      HISTORY_CHART_INSTANCES.set(host, chartContainer);\n    }\n    return;\n  }\n\n  updateLineChart(chartContainer, chartOptions);\n}\n\nfunction updateRangeButtons(\n  container: HTMLElement | null,\n  activeRange: SecurityHistoryRangeKey,\n): void {\n  if (!container) {\n    return;\n  }\n\n  container.dataset.activeRange = activeRange;\n  container.querySelectorAll<HTMLButtonElement>('.security-range-button').forEach((button) => {\n    const rangeKey = button.dataset.range as SecurityHistoryRangeKey | undefined;\n    const isActive = rangeKey === activeRange;\n    button.classList.toggle('active', isActive);\n    button.setAttribute('aria-pressed', isActive ? 'true' : 'false');\n    button.disabled = false;\n    button.classList.remove('loading');\n  });\n}\n\nfunction updateInfoBarContent(\n  root: HTMLElement,\n  rangeKey: SecurityHistoryRangeKey,\n  priceChange: number | null,\n  priceChangePct: number | null,\n  currency: string | null | undefined,\n): void {\n  const infoBar = root.querySelector('.security-info-bar');\n  if (!infoBar || !infoBar.parentElement) {\n    return;\n  }\n\n  const wrapper = document.createElement('div');\n  wrapper.innerHTML = buildInfoBar(rangeKey, priceChange, priceChangePct, currency).trim();\n  const fresh = wrapper.firstElementChild;\n  if (!fresh) {\n    return;\n  }\n  infoBar.parentElement.replaceChild(fresh, infoBar);\n}\n\nfunction updateHistoryPlaceholder(\n  root: HTMLElement,\n  rangeKey: SecurityHistoryRangeKey,\n  state: HistoryPlaceholderState,\n  historySeries: readonly NormalizedHistoryEntry[],\n  options: {\n    currency?: string | null | undefined;\n    baseline?: number | null | undefined;\n  } = {},\n): void {\n  const placeholderContainer = root.querySelector('.security-detail-placeholder');\n  if (!placeholderContainer) {\n    return;\n  }\n\n  placeholderContainer.innerHTML = `\n    <h2>Historie</h2>\n    ${buildHistoryPlaceholder(rangeKey, state)}\n  `;\n\n  if (state.status === 'loaded' && Array.isArray(historySeries) && historySeries.length) {\n    const host = placeholderContainer.querySelector<HTMLElement>('.history-chart');\n    if (host) {\n      requestAnimationFrame(() => {\n        renderHistoryChart(host, historySeries, options);\n      });\n    }\n  }\n}\n\ninterface ScheduleRangeSetupOptions {\n  root: HTMLElement;\n  hass: HomeAssistant | null | undefined;\n  panelConfig: PanelConfigLike | null | undefined;\n  securityUuid: string;\n  snapshot: SecuritySnapshotDetail | null;\n  initialRange: SecurityHistoryRangeKey;\n  initialHistory: NormalizedHistoryEntry[];\n  initialHistoryState: HistoryPlaceholderState;\n}\n\nfunction scheduleRangeSetup(options: ScheduleRangeSetupOptions): void {\n  const {\n    root,\n    hass,\n    panelConfig,\n    securityUuid,\n    snapshot,\n    initialRange,\n    initialHistory,\n    initialHistoryState,\n  } = options;\n\n  setTimeout(() => {\n    const rangeSelector = root.querySelector<HTMLElement>('.security-range-selector');\n    if (!rangeSelector) {\n      return;\n    }\n\n    const cache = ensureHistoryCache(securityUuid);\n    const initialBaseline = selectAveragePurchaseBaseline(snapshot);\n    const shouldCacheInitial =\n      Array.isArray(initialHistory) && initialHistoryState.status !== 'error';\n    if (shouldCacheInitial) {\n      cache.set(initialRange, initialHistory);\n    }\n\n    ensureLiveUpdateSubscription(securityUuid);\n\n    setActiveRange(securityUuid, initialRange);\n    updateRangeButtons(rangeSelector, initialRange);\n    const initialDisplayHistory = buildHistorySeriesWithSnapshotPrice(\n      initialHistory,\n      snapshot,\n    );\n    let effectiveInitialState: HistoryPlaceholderState = initialHistoryState;\n    if (effectiveInitialState.status !== 'error') {\n      effectiveInitialState = initialDisplayHistory.length\n        ? { status: 'loaded' }\n        : { status: 'empty' };\n    }\n    updateHistoryPlaceholder(\n      root,\n      initialRange,\n      effectiveInitialState,\n      initialDisplayHistory,\n      {\n        currency: snapshot?.currency_code,\n        baseline: initialBaseline,\n      },\n    );\n\n    const handleRangeClick = async (rangeKey: SecurityHistoryRangeKey): Promise<void> => {\n      if (rangeKey === getActiveRange(securityUuid)) {\n        return;\n      }\n\n      const button = rangeSelector.querySelector<HTMLButtonElement>(\n        `.security-range-button[data-range=\"${rangeKey}\"]`,\n      );\n      if (button) {\n        button.disabled = true;\n        button.classList.add('loading');\n      }\n\n      let historySeries = cache.get(rangeKey) ?? null;\n      let historyState: HistoryPlaceholderState | null = null;\n      let displayHistorySeries: NormalizedHistoryEntry[] = [];\n      if (!historySeries) {\n        try {\n          const rangeOptions = resolveRangeOptions(rangeKey);\n          const historyResponse = await fetchSecurityHistoryWS(\n            hass,\n            panelConfig,\n            securityUuid,\n            rangeOptions,\n          );\n            historySeries = normaliseHistorySeries(historyResponse.prices);\n          cache.set(rangeKey, historySeries);\n          historyState = historySeries.length\n            ? { status: 'loaded' }\n            : { status: 'empty' };\n        } catch (error) {\n          console.error('Range-Wechsel: Historie konnte nicht geladen werden', error);\n          historySeries = [];\n          const message = normaliseHistoryError(error);\n          historyState = {\n            status: 'error',\n            message:\n              message ||\n              'Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden.',\n          };\n        }\n      } else {\n        historyState = historySeries.length\n          ? { status: 'loaded' }\n          : { status: 'empty' };\n        }\n\n        displayHistorySeries = buildHistorySeriesWithSnapshotPrice(historySeries, snapshot);\n        if (historyState.status !== 'error') {\n          historyState = displayHistorySeries.length\n            ? { status: 'loaded' }\n            : { status: 'empty' };\n      }\n\n      const snapshotLastPriceNative =\n        extractSnapshotLastPriceNative(snapshot);\n      const { priceChange, priceChangePct } = computePriceChangeMetrics(\n        displayHistorySeries,\n        snapshotLastPriceNative,\n      );\n\n      setActiveRange(securityUuid, rangeKey);\n      updateRangeButtons(rangeSelector, rangeKey);\n      updateInfoBarContent(\n        root,\n        rangeKey,\n        priceChange,\n        priceChangePct,\n        snapshot?.currency_code,\n      );\n      const rangeBaseline = selectAveragePurchaseBaseline(snapshot);\n\n      updateHistoryPlaceholder(\n        root,\n        rangeKey,\n        historyState,\n        displayHistorySeries,\n        {\n          currency: snapshot?.currency_code,\n          baseline: rangeBaseline,\n        },\n      );\n    };\n\n    rangeSelector.addEventListener('click', (event) => {\n      const button = (event.target as HTMLElement | null)?.closest<HTMLButtonElement>('.security-range-button');\n      if (!button || button.disabled) {\n        return;\n      }\n      const { range } = button.dataset;\n      if (!range || !AVAILABLE_HISTORY_RANGES.includes(range as SecurityHistoryRangeKey)) {\n        return;\n      }\n        void handleRangeClick(range as SecurityHistoryRangeKey);\n    });\n  }, 0);\n}\n\nexport async function renderSecurityDetail(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  securityUuid: string | null | undefined,\n): Promise<string> {\n  if (!securityUuid) {\n    console.error('renderSecurityDetail: securityUuid fehlt');\n    return '<div class=\"card\"><h2>Fehler</h2><p>Kein Wertpapier angegeben.</p></div>';\n  }\n\n  const cachedSnapshot = getCachedSecuritySnapshot(securityUuid);\n  let snapshot: SecuritySnapshotDetail | null = null;\n  let error: string | null = null;\n\n  try {\n    const response: SecuritySnapshotResponse = await fetchSecuritySnapshotWS(\n      hass,\n      panelConfig,\n      securityUuid,\n    );\n    const snapshotPayload: unknown = response.snapshot;\n    snapshot =\n      snapshotPayload && typeof snapshotPayload === 'object'\n        ? (snapshotPayload as SecuritySnapshotDetail)\n        : (response as unknown as SecuritySnapshotDetail);\n  } catch (err) {\n    console.error('renderSecurityDetail: Snapshot konnte nicht geladen werden', err);\n    error = formatErrorLabel(err);\n  }\n\n  const effectiveSnapshot = snapshot || cachedSnapshot;\n  const fallbackUsed = Boolean(cachedSnapshot && !snapshot);\n  const flaggedAsCache = (effectiveSnapshot?.source ?? '') === 'cache';\n  if (securityUuid) {\n    cacheSecuritySnapshotDetail(securityUuid, effectiveSnapshot ?? null);\n  }\n  const staleNotice =\n    effectiveSnapshot && (fallbackUsed || flaggedAsCache)\n      ? buildCachedSnapshotNotice({ fallbackUsed, flaggedAsCache })\n      : '';\n  const headerTitle = effectiveSnapshot?.name || 'Wertpapierdetails';\n\n  if (error) {\n    const headerCard = createHeaderCard(\n      headerTitle,\n      buildHeaderMeta(effectiveSnapshot),\n    );\n    return `\n      ${headerCard.outerHTML}\n      ${staleNotice}\n      <div class=\"card error-card\">\n        <h2>Fehler beim Laden</h2>\n        <p>${error}</p>\n      </div>\n    `;\n  }\n\n  const activeRange = getActiveRange(securityUuid);\n  const cache = ensureHistoryCache(securityUuid);\n  let historySeries = cache.has(activeRange) ? cache.get(activeRange) ?? null : null;\n  let historyState: HistoryPlaceholderState = { status: 'empty' };\n\n  if (Array.isArray(historySeries)) {\n    historyState = historySeries.length\n      ? { status: 'loaded' }\n      : { status: 'empty' };\n  } else {\n    historySeries = [];\n    try {\n      const rangeOptions = resolveRangeOptions(activeRange);\n      const historyResponse: SecurityHistoryResponse = await fetchSecurityHistoryWS(\n        hass,\n        panelConfig,\n        securityUuid,\n        rangeOptions,\n      );\n        historySeries = normaliseHistorySeries(historyResponse.prices);\n      cache.set(activeRange, historySeries);\n      historyState = historySeries.length\n        ? { status: 'loaded' }\n        : { status: 'empty' };\n    } catch (historyError) {\n      console.error(\n        'renderSecurityDetail: Historie konnte nicht geladen werden',\n        historyError,\n      );\n      const message = normaliseHistoryError(historyError);\n      historyState = {\n        status: 'error',\n        message:\n          message ||\n          'Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden.',\n      };\n    }\n  }\n\n  const displayHistorySeries = buildHistorySeriesWithSnapshotPrice(\n    historySeries,\n    effectiveSnapshot,\n  );\n  if (historyState.status !== 'error') {\n    historyState = displayHistorySeries.length\n      ? { status: 'loaded' }\n      : { status: 'empty' };\n  }\n\n  const headerCard = createHeaderCard(\n    headerTitle,\n    buildHeaderMeta(effectiveSnapshot),\n  );\n\n  const snapshotLastPriceNative = extractSnapshotLastPriceNative(effectiveSnapshot);\n  const { priceChange, priceChangePct } = computePriceChangeMetrics(\n    displayHistorySeries,\n    snapshotLastPriceNative,\n  );\n  const infoBar = buildInfoBar(\n    activeRange,\n    priceChange,\n    priceChangePct,\n    effectiveSnapshot?.currency_code,\n  );\n\n  scheduleRangeSetup({\n    root,\n    hass,\n    panelConfig,\n    securityUuid,\n    snapshot: effectiveSnapshot,\n    initialRange: activeRange,\n    initialHistory: historySeries,\n    initialHistoryState: historyState,\n  });\n\n  return `\n    ${headerCard.outerHTML}\n    ${staleNotice}\n    ${infoBar}\n    ${buildRangeSelector(activeRange)}\n    <div class=\"card security-detail-placeholder\">\n      <h2>Historie</h2>\n      ${buildHistoryPlaceholder(activeRange, historyState)}\n    </div>\n  `;\n}\n\ninterface RegisterSecurityDetailTabOptions {\n  setSecurityDetailTabFactory?: ((\n    factory: (securityUuid: string) => {\n      title: string;\n      render: DashboardTabRenderFn;\n      cleanup: (context?: { key: string }) => void;\n    },\n  ) => void) | null;\n}\n\nexport function registerSecurityDetailTab(\n  options: RegisterSecurityDetailTabOptions,\n): void {\n  const { setSecurityDetailTabFactory } = options;\n  if (typeof setSecurityDetailTabFactory !== 'function') {\n    console.error('registerSecurityDetailTab: Ungültige Factory-Funktion übergeben');\n    return;\n  }\n\n    setSecurityDetailTabFactory((securityUuid) => ({\n      title: 'Wertpapier',\n      render: (root, hass, panelConfig) =>\n        renderSecurityDetail(root, hass, panelConfig, securityUuid),\n      cleanup: () => {\n        cleanupSecurityDetailState(securityUuid);\n      },\n    }));\n}\n","/**\n * Accounts tab rendering backed by normalized account snapshots.\n *\n * Renders dedicated EUR + FX sections that reuse the shared dashboard styles\n * while surfacing FX provenance/coverage metadata via badge helpers.\n */\n\nimport {\n  createHeaderCard,\n  formatNumber,\n  makeTable,\n} from '../../content/elements';\nimport { fetchAccountsWS } from '../../data/api';\nimport { setAccountSnapshots } from '../../lib/store/portfolioStore';\nimport {\n  selectAccountOverviewRows,\n  type AccountOverviewRow,\n} from '../../lib/store/selectors/portfolio';\nimport { renderNameWithBadges, escapeHtml } from '../../lib/ui/badges';\nimport type { PanelConfigLike } from '../../tabs/types';\nimport type { HomeAssistant } from '../../types/home-assistant';\n\nexport const ACCOUNTS_TAB_KEY = 'accounts';\n\nconst ACCOUNT_TAB_TITLE = 'Konten';\n\ninterface AccountPartitions {\n  eur: AccountOverviewRow[];\n  fx: AccountOverviewRow[];\n}\n\nfunction partitionAccounts(\n  rows: AccountOverviewRow[],\n): AccountPartitions {\n  const eur: AccountOverviewRow[] = [];\n  const fx: AccountOverviewRow[] = [];\n\n  for (const account of rows) {\n    const currency = (account.currency_code ?? '').toUpperCase() || 'EUR';\n    if (currency === 'EUR') {\n      eur.push(account);\n    } else {\n      fx.push(account);\n    }\n  }\n\n  return { eur, fx };\n}\n\nfunction sumBalances(rows: AccountOverviewRow[]): number {\n  return rows.reduce((sum, account) => {\n    if (typeof account.balance === 'number' && Number.isFinite(account.balance)) {\n      return sum + account.balance;\n    }\n    return sum;\n  }, 0);\n}\n\nfunction formatEuroLabel(value: number): string {\n  return `${formatNumber(value)}\\u00A0€`;\n}\n\nfunction formatOriginalBalance(account: AccountOverviewRow): string {\n  if (typeof account.orig_balance !== 'number' || !Number.isFinite(account.orig_balance)) {\n    return '—';\n  }\n  const currency = account.currency_code ?? '';\n  const amount = account.orig_balance.toLocaleString('de-DE', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2,\n  });\n  return `${amount}${currency ? `\\u00A0${currency}` : ''}`;\n}\n\nfunction formatFxRate(value: number | null): string | null {\n  if (typeof value !== 'number' || !Number.isFinite(value) || value <= 0) {\n    return null;\n  }\n  return value.toLocaleString('de-DE', {\n    minimumFractionDigits: 4,\n    maximumFractionDigits: 4,\n  });\n}\n\nfunction formatFxTimestamp(value: string | null): string | null {\n  if (!value) {\n    return null;\n  }\n  const date = new Date(value);\n  if (Number.isNaN(date.getTime())) {\n    return null;\n  }\n  return date.toLocaleString('de-DE', {\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n  });\n}\n\nfunction formatFxSource(account: AccountOverviewRow): string {\n  const parts: string[] = [];\n  const source = account.fx_rate_source;\n  const timestamp = formatFxTimestamp(account.fx_rate_timestamp);\n  const rateLabel = formatFxRate(account.fx_rate);\n\n  if (source) {\n    parts.push(source);\n  }\n  if (timestamp) {\n    parts.push(timestamp);\n  }\n  if (rateLabel) {\n    parts.push(`Kurs ${rateLabel}`);\n  }\n  if (parts.length === 0) {\n    return account.fx_unavailable ? 'FX-Daten fehlen' : '—';\n  }\n  return parts.join(' · ');\n}\n\nfunction buildHeaderMeta(\n  eurTotal: number,\n  fxTotal: number,\n  fxMissingCount: number,\n): string {\n  const fxTotalLabel =\n    fxTotal > 0 ? formatEuroLabel(fxTotal) : '—';\n  const missingNote = fxMissingCount\n    ? `<span class=\"total-wealth-note\">${String(\n        fxMissingCount,\n      )}&nbsp;FX-Konten ohne Kurs</span>`\n    : '';\n\n  return `\n    <div class=\"header-meta-row accounts-meta\">\n      <span>💶 EUR-Konten: <strong>${formatEuroLabel(eurTotal)}</strong></span>\n      <span>💱 FX-Konten (EUR): <strong>${fxTotalLabel}</strong></span>\n      ${missingNote}\n    </div>\n  `;\n}\n\nfunction buildFxWarningBanner(count: number): string {\n  if (count === 0) {\n    return '';\n  }\n  const plural = count === 1 ? '' : 'e';\n  return `\n    <div class=\"card warning-card\">\n      <h2>FX-Warnung</h2>\n      <p>${String(\n        count,\n      )} Fremdwährungskont${plural} ohne aktuelle FX-Daten. EUR-Werte fehlen für diese Konten.</p>\n    </div>\n  `;\n}\n\nfunction buildAccountsTables(\n  eurAccounts: AccountOverviewRow[],\n  fxAccounts: AccountOverviewRow[],\n): { eurTable: string; fxTable: string } {\n  const eurRows = eurAccounts.map((account) => ({\n    name: renderNameWithBadges(account.name, account.badges, {\n      containerClass: 'account-name',\n      labelClass: 'account-name__label',\n    }),\n    balance: account.balance ?? null,\n    fx_unavailable: account.fx_unavailable,\n  }));\n\n  const eurTable = makeTable(\n    eurRows,\n    [\n      { key: 'name', label: 'Name' },\n      { key: 'balance', label: 'Kontostand (EUR)', align: 'right' as const },\n    ],\n    ['balance'],\n  );\n\n  const fxRows = fxAccounts.map((account) => ({\n    name: renderNameWithBadges(account.name, account.badges, {\n      containerClass: 'account-name',\n      labelClass: 'account-name__label',\n    }),\n    fx_display: formatOriginalBalance(account),\n    fx_source: escapeHtml(formatFxSource(account)),\n    balance: account.fx_unavailable ? null : account.balance ?? null,\n    fx_unavailable: account.fx_unavailable,\n  }));\n\n  const fxTable = makeTable(\n    fxRows,\n    [\n      { key: 'name', label: 'Name' },\n      { key: 'fx_display', label: 'Betrag (FX)' },\n      { key: 'fx_source', label: 'FX-Provenienz' },\n      { key: 'balance', label: 'EUR', align: 'right' as const },\n    ],\n    ['balance'],\n  );\n\n  return { eurTable, fxTable };\n}\n\nexport async function renderAccountsTab(\n  _root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<string> {\n  const accountsResp = await fetchAccountsWS(hass, panelConfig);\n  setAccountSnapshots(accountsResp.accounts);\n\n  const rows = selectAccountOverviewRows();\n  const { eur, fx } = partitionAccounts(rows);\n\n  const eurTotal = sumBalances(eur);\n  const fxTotal = sumBalances(\n    fx.filter((account) => !account.fx_unavailable),\n  );\n  const fxMissingCount = fx.filter(\n    (account) => account.fx_unavailable || account.balance == null,\n  ).length;\n\n  const headerMeta = buildHeaderMeta(eurTotal, fxTotal, fxMissingCount);\n  const headerCard = createHeaderCard(ACCOUNT_TAB_TITLE, headerMeta);\n\n  const warningBanner = buildFxWarningBanner(fxMissingCount);\n  const { eurTable, fxTable } = buildAccountsTables(eur, fx);\n\n  return `\n    ${headerCard.outerHTML}\n    ${warningBanner}\n    <div class=\"card\">\n      <h2>EUR-Konten</h2>\n      <div class=\"scroll-container account-table\">\n        ${eurTable}\n      </div>\n    </div>\n    <div class=\"card\">\n      <h2>Fremdwährungen</h2>\n      <div class=\"scroll-container fx-account-table\">\n        ${fxTable}\n      </div>\n      ${\n        fx.length\n          ? `\n        <p class=\"table-note\" role=\"note\">\n          <span class=\"table-note__icon\" aria-hidden=\"true\">ℹ️</span>\n          <span>FX-Provenienz zeigt Quelle, Zeitpunkt und Kurs des letzten Abgleichs.</span>\n        </p>`\n          : ''\n      }\n    </div>\n  `;\n}\n\nexport const accountsTabDescriptor = {\n  key: ACCOUNTS_TAB_KEY,\n  title: ACCOUNT_TAB_TITLE,\n  render: renderAccountsTab,\n};\n","/**\n * Mirrors the legacy dashboard controller for initial TypeScript migration.\n */\n\nimport { addSwipeEvents as addSwipeEventsUnsafe } from './interaction/tab_control';\nimport {\n  renderDashboard,\n  attachPortfolioToggleHandler,\n  updatePortfolioFooterFromDom,\n} from './tabs/overview';\nimport { registerSecurityDetailTab } from './tabs/security_detail';\nimport { accountsTabDescriptor } from './views/portfolio/accounts';\nimport {\n  handleAccountUpdate,\n  handleLastFileUpdate,\n  handlePortfolioUpdate,\n  handlePortfolioPositionsUpdate,\n  __TEST_ONLY__,\n  flushPendingPositions,\n  reapplyPositionsSort,\n} from './data/updateConfigsWS';\nimport { getEntryId } from './data/api';\nimport {\n  getRegisteredDashboardElements,\n  getRegisteredPanelHosts,\n} from './dashboard/registry';\nimport type {\n  DashboardTabDescriptor,\n  PanelConfigLike,\n} from './tabs/types';\nimport type {\n  HassEvent,\n  HassPanel,\n  HassPanels,\n  HassRoute,\n  HassUnsubscribe,\n  HomeAssistant,\n} from './types/home-assistant';\n\nexport { updatePortfolioFooterFromDom };\nexport {\n  __TEST_ONLY__,\n  handlePortfolioPositionsUpdate,\n  flushPendingPositions,\n  reapplyPositionsSort,\n};\n\ntype AddSwipeEvents = (\n  element: HTMLElement,\n  onSwipeLeft: () => void,\n  onSwipeRight: () => void,\n) => void;\n\nconst addSwipeEvents = addSwipeEventsUnsafe as AddSwipeEvents;\n\ntype PanelLike = PanelConfigLike | HassPanel | null | undefined;\n\ntype AccountsUpdatePayload = Parameters<typeof handleAccountUpdate>[0];\ntype LastFileUpdatePayload = Parameters<typeof handleLastFileUpdate>[0];\ntype PortfolioValuesUpdatePayload = Parameters<typeof handlePortfolioUpdate>[0];\ntype PortfolioPositionsUpdatePayload = Parameters<typeof handlePortfolioPositionsUpdate>[0];\n\ntype DashboardUpdateType =\n  | 'accounts'\n  | 'last_file_update'\n  | 'portfolio_values'\n  | 'portfolio_positions';\n\ntype DashboardUpdatePayloadMap = {\n  accounts: AccountsUpdatePayload;\n  last_file_update: LastFileUpdatePayload;\n  portfolio_values: PortfolioValuesUpdatePayload;\n  portfolio_positions: PortfolioPositionsUpdatePayload;\n};\n\ntype DashboardUpdateQueueEntry<T extends DashboardUpdateType = DashboardUpdateType> = {\n  type: T;\n  data: DashboardUpdatePayloadMap[T] | null | undefined;\n  portfolioUuid?: string | null;\n};\n\ninterface PanelsUpdatedEventData {\n  entry_id?: string | null;\n  data_type?: string | null;\n  data?: unknown;\n  [key: string]: unknown;\n}\n\ntype PanelsUpdatedEvent = HassEvent<PanelsUpdatedEventData>;\n\ninterface DashboardElement extends HTMLElement {\n  rememberScrollPosition?: (page?: number) => void;\n  _renderIfInitialized?: () => void;\n  _render?: () => void;\n  handleExternalRender?: (page: number) => void;\n}\n\nconst STICKY_HEADER_ANCHOR_ID = 'pp-reader-sticky-anchor';\nconst OVERVIEW_TAB_KEY = 'overview';\nconst SECURITY_DETAIL_TAB_PREFIX = 'security:';\n\nconst baseTabs: DashboardTabDescriptor[] = [\n  { key: OVERVIEW_TAB_KEY, title: 'Dashboard', render: renderDashboard },\n  accountsTabDescriptor,\n];\n\nconst detailTabRegistry = new Map<string, DashboardTabDescriptor>();\nconst detailTabOrder: string[] = [];\nconst securityTabLookup = new Map<string, string>();\n\nlet securityDetailTabFactory: DetailTabFactory | null = null;\nlet navigationInProgress = false;\nlet lastClosedSecurityUuid: string | null = null;\nlet currentPage = 0;\nlet observer: IntersectionObserver | null = null;\n\ntype DetailTabDescriptorInput = {\n  title: string;\n  render: DashboardTabDescriptor['render'];\n  cleanup?: DashboardTabDescriptor['cleanup'];\n  key?: string;\n  [key: string]: unknown;\n};\ntype DetailTabFactory = (securityUuid: string) => DetailTabDescriptorInput | null | undefined;\n\nfunction isRecord(value: unknown): value is Record<string, unknown> {\n  return typeof value === 'object' && value !== null;\n}\n\nfunction isPromiseLike<T>(value: unknown): value is PromiseLike<T> {\n  return (\n    typeof value === 'object' &&\n    value !== null &&\n    typeof (value as PromiseLike<T>).then === 'function'\n  );\n}\n\nfunction toErrorMessage(error: unknown): string {\n  if (typeof error === 'string') {\n    const trimmed = error.trim();\n    return trimmed.length > 0 ? trimmed : 'Unbekannter Fehler';\n  }\n  if (error instanceof Error) {\n    const trimmed = error.message.trim();\n    return trimmed.length > 0 ? trimmed : error.name;\n  }\n  if (error != null) {\n    try {\n      const serialized = JSON.stringify(error);\n      if (serialized && serialized !== '{}') {\n        return serialized;\n      }\n    } catch {\n      // Ignore serialization problems and fall back to String().\n    }\n  }\n  return String(error);\n}\n\nfunction isDashboardUpdateType(value: unknown): value is DashboardUpdateType {\n  return (\n    value === 'accounts' ||\n    value === 'last_file_update' ||\n    value === 'portfolio_values' ||\n    value === 'portfolio_positions'\n  );\n}\n\nfunction extractPortfolioUuidFromSingleUpdate(\n  update: Record<string, unknown>,\n): string | null {\n  const uuidCandidate = update['portfolio_uuid'];\n  if (typeof uuidCandidate === 'string' && uuidCandidate) {\n    return uuidCandidate;\n  }\n  const camelCaseCandidate = update['portfolioUuid'];\n  if (typeof camelCaseCandidate === 'string' && camelCaseCandidate) {\n    return camelCaseCandidate;\n  }\n  return null;\n}\n\nfunction extractPortfolioUuidFromPositionsUpdate(\n  update: PortfolioPositionsUpdatePayload | null | undefined,\n): string | null {\n  if (!update) {\n    return null;\n  }\n  if (Array.isArray(update)) {\n    for (const item of update) {\n      if (isRecord(item)) {\n        const uuid = extractPortfolioUuidFromSingleUpdate(item);\n        if (uuid) {\n          return uuid;\n        }\n      }\n    }\n    return null;\n  }\n  if (!isRecord(update)) {\n    return null;\n  }\n  return extractPortfolioUuidFromSingleUpdate(update);\n}\n\nfunction normalizeDashboardUpdate(\n  dataType: DashboardUpdateType,\n  data: unknown,\n): DashboardUpdateQueueEntry | null {\n  switch (dataType) {\n    case 'accounts':\n      return {\n        type: dataType,\n        data: Array.isArray(data) ? (data as AccountsUpdatePayload) : null,\n      };\n    case 'last_file_update':\n      if (typeof data === 'string') {\n        return { type: dataType, data: data as LastFileUpdatePayload };\n      }\n      if (isRecord(data)) {\n        return { type: dataType, data: data as LastFileUpdatePayload };\n      }\n      return { type: dataType, data: null };\n    case 'portfolio_values':\n      if (Array.isArray(data)) {\n        return { type: dataType, data: data as PortfolioValuesUpdatePayload };\n      }\n      return { type: dataType, data: null };\n    case 'portfolio_positions':\n      if (Array.isArray(data)) {\n        return { type: dataType, data: data as PortfolioPositionsUpdatePayload };\n      }\n      if (isRecord(data)) {\n        return { type: dataType, data: data as PortfolioPositionsUpdatePayload };\n      }\n      return { type: dataType, data: null };\n    default:\n      return null;\n  }\n}\n\nfunction extractSecurityUuidFromKey(key: string | null | undefined): string | null {\n  if (typeof key !== 'string' || !key.startsWith(SECURITY_DETAIL_TAB_PREFIX)) {\n    return null;\n  }\n\n  const uuid = key.slice(SECURITY_DETAIL_TAB_PREFIX.length);\n  return uuid || null;\n}\n\nfunction tryReopenLastDetail(): boolean {\n  if (!lastClosedSecurityUuid) {\n    return false;\n  }\n\n  const reopened = openSecurityDetail(lastClosedSecurityUuid);\n  if (!reopened) {\n    lastClosedSecurityUuid = null;\n  }\n  return reopened;\n}\n\nfunction getVisibleTabs(): DashboardTabDescriptor[] {\n  const detailTabs = detailTabOrder\n    .map((key) => detailTabRegistry.get(key))\n    .filter((descriptor): descriptor is DashboardTabDescriptor => Boolean(descriptor));\n\n  return [...baseTabs, ...detailTabs];\n}\n\nfunction getTabAtIndex(index: number): DashboardTabDescriptor | null {\n  const tabs = getVisibleTabs();\n  if (index < 0 || index >= tabs.length) {\n    return null;\n  }\n  return tabs[index];\n}\n\nfunction resolveDashboardPanel(panels: HassPanels | null | undefined): PanelLike {\n  if (!panels) {\n    return null;\n  }\n  const normalizedPanels = panels as Partial<Record<string, PanelLike>>;\n  const preferred = normalizedPanels.ppreader ?? normalizedPanels.pp_reader;\n  if (preferred) {\n    return preferred;\n  }\n  const fallback = Object.values(normalizedPanels).find((panelConfig) => {\n    if (!panelConfig || typeof panelConfig !== 'object') {\n      return false;\n    }\n    const name = (panelConfig as { webcomponent_name?: unknown }).webcomponent_name;\n    return name === 'pp-reader-panel';\n  });\n  return fallback ?? null;\n}\nfunction rememberCurrentPageScroll(): void {\n  try {\n    const dashboardElement = findDashboardElement();\n    if (dashboardElement && typeof dashboardElement.rememberScrollPosition === 'function') {\n      dashboardElement.rememberScrollPosition();\n    }\n  } catch (error) {\n    console.warn('rememberCurrentPageScroll: konnte Scroll-Position nicht sichern', error);\n  }\n}\n\nfunction clampPageIndex(index: number): number {\n  const tabs = getVisibleTabs();\n  if (!tabs.length) {\n    return 0;\n  }\n  if (index < 0) {\n    return 0;\n  }\n  if (index >= tabs.length) {\n    return tabs.length - 1;\n  }\n  return index;\n}\n\nasync function navigateToPage(\n  targetIndex: number,\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): Promise<void> {\n  const tabs = getVisibleTabs();\n  const clampedIndex = clampPageIndex(targetIndex);\n  if (clampedIndex === currentPage) {\n    if (targetIndex > currentPage) {\n      tryReopenLastDetail();\n    }\n    return;\n  }\n\n  rememberCurrentPageScroll();\n\n  const currentTab = currentPage >= 0 && currentPage < tabs.length ? tabs[currentPage] : null;\n  const currentSecurityUuid = currentTab\n    ? extractSecurityUuidFromKey(currentTab.key)\n    : null;\n  let nextIndex = clampedIndex;\n\n  if (currentSecurityUuid) {\n    const intendedTarget = clampedIndex >= 0 && clampedIndex < tabs.length ? tabs[clampedIndex] : null;\n    if (intendedTarget && intendedTarget.key === OVERVIEW_TAB_KEY) {\n      const closed = closeSecurityDetail(currentSecurityUuid, { suppressRender: true });\n      if (closed) {\n        const updatedTabs = getVisibleTabs();\n        const overviewIndex = updatedTabs.findIndex((tab) => tab.key === OVERVIEW_TAB_KEY);\n        nextIndex = overviewIndex >= 0 ? overviewIndex : 0;\n      }\n    }\n  }\n\n  if (navigationInProgress) {\n    return;\n  }\n\n  navigationInProgress = true;\n  try {\n    currentPage = clampPageIndex(nextIndex);\n    const renderedPage = currentPage;\n    await renderTab(root, hass, panel);\n    notifyExternalRender(renderedPage);\n  } catch (error) {\n    console.error('navigateToPage: Fehler beim Rendern des Tabs', error);\n  } finally {\n    navigationInProgress = false;\n  }\n}\n\nfunction navigateByDelta(\n  delta: number,\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): void {\n  void navigateToPage(currentPage + delta, root, hass, panel);\n}\n\nexport function registerDetailTab(\n  key: string,\n  descriptor: DetailTabDescriptorInput | null | undefined,\n): void {\n  if (!key || !descriptor || typeof descriptor.render !== 'function') {\n    console.error('registerDetailTab: Ungültiger Tab-Descriptor', key, descriptor);\n    return;\n  }\n\n  const securityUuid = extractSecurityUuidFromKey(key);\n  if (securityUuid) {\n    const existingKey = securityTabLookup.get(securityUuid);\n    if (existingKey && existingKey !== key) {\n      unregisterDetailTab(existingKey);\n    }\n  }\n\n  const normalizedDescriptor: DashboardTabDescriptor = {\n    ...descriptor,\n    key,\n  };\n\n  detailTabRegistry.set(key, normalizedDescriptor);\n\n  if (securityUuid) {\n    securityTabLookup.set(securityUuid, key);\n  }\n\n  if (!detailTabOrder.includes(key)) {\n    detailTabOrder.push(key);\n  }\n}\n\nexport function unregisterDetailTab(key: string | null | undefined): void {\n  if (!key) {\n    return;\n  }\n\n  const descriptor = detailTabRegistry.get(key);\n  if (descriptor && typeof descriptor.cleanup === 'function') {\n    try {\n      const cleanupResult = descriptor.cleanup({ key });\n      if (isPromiseLike<unknown>(cleanupResult)) {\n        cleanupResult.catch((cleanupError: unknown) => {\n          console.error(\n            'unregisterDetailTab: Fehler beim asynchronen cleanup',\n            cleanupError,\n          );\n        });\n      }\n    } catch (error: unknown) {\n      console.error('unregisterDetailTab: Fehler beim Ausführen von cleanup', error);\n    }\n  }\n\n  detailTabRegistry.delete(key);\n\n  const index = detailTabOrder.indexOf(key);\n  if (index >= 0) {\n    detailTabOrder.splice(index, 1);\n  }\n\n  const securityUuid = extractSecurityUuidFromKey(key);\n  if (securityUuid && securityTabLookup.get(securityUuid) === key) {\n    securityTabLookup.delete(securityUuid);\n  }\n}\n\nexport function hasDetailTab(key: string): boolean {\n  return detailTabRegistry.has(key);\n}\n\nexport function getDetailTabDescriptor(key: string): DashboardTabDescriptor | null {\n  return detailTabRegistry.get(key) ?? null;\n}\n\nexport function setSecurityDetailTabFactory(\n  factory: DetailTabFactory | null | undefined,\n): void {\n  if (factory != null && typeof factory !== 'function') {\n    console.error('setSecurityDetailTabFactory: Erwartet Funktion oder null', factory);\n    return;\n  }\n\n  securityDetailTabFactory = factory ?? null;\n}\n\nfunction getSecurityDetailTabKey(securityUuid: string): string {\n  return `${SECURITY_DETAIL_TAB_PREFIX}${securityUuid}`;\n}\n\nfunction findDashboardElement(): DashboardElement | null {\n  for (const element of getRegisteredDashboardElements()) {\n    if (element.isConnected) {\n      return element;\n    }\n  }\n\n  const hostCandidates = new Set<HTMLElement>();\n  for (const host of getRegisteredPanelHosts()) {\n    hostCandidates.add(host);\n  }\n\n  for (const host of hostCandidates) {\n    const nested = host.shadowRoot?.querySelector<DashboardElement>('pp-reader-dashboard');\n    if (nested) {\n      return nested;\n    }\n  }\n\n  if (typeof document !== 'undefined') {\n    const standalone = document.querySelector<DashboardElement>('pp-reader-dashboard');\n    if (standalone) {\n      return standalone;\n    }\n  }\n\n  return null;\n}\n\nfunction requestDashboardRender(): void {\n  const dashboardElement = findDashboardElement();\n  if (!dashboardElement) {\n    console.warn('requestDashboardRender: Kein pp-reader-dashboard Element gefunden');\n    return;\n  }\n\n  if (typeof dashboardElement._renderIfInitialized === 'function') {\n    dashboardElement._renderIfInitialized();\n    return;\n  }\n\n  if (typeof dashboardElement._render === 'function') {\n    dashboardElement._render();\n  }\n}\n\nfunction notifyExternalRender(page: number): void {\n  const dashboardElement = findDashboardElement();\n  if (!dashboardElement) {\n    return;\n  }\n\n  if (typeof dashboardElement.handleExternalRender === 'function') {\n    try {\n      dashboardElement.handleExternalRender(page);\n    } catch (error) {\n      console.warn('notifyExternalRender: Fehler beim Synchronisieren des Dashboards', error);\n    }\n  }\n}\n\nexport function openSecurityDetail(securityUuid: string | null | undefined): boolean {\n  if (!securityUuid) {\n    console.error('openSecurityDetail: Ungültige securityUuid', securityUuid);\n    return false;\n  }\n\n  const tabKey = getSecurityDetailTabKey(securityUuid);\n  let descriptor = getDetailTabDescriptor(tabKey);\n\n  if (!descriptor && typeof securityDetailTabFactory === 'function') {\n    try {\n      const maybeDescriptor = securityDetailTabFactory(securityUuid);\n      if (maybeDescriptor && typeof maybeDescriptor.render === 'function') {\n        registerDetailTab(tabKey, maybeDescriptor);\n        descriptor = getDetailTabDescriptor(tabKey);\n      } else {\n        console.error('openSecurityDetail: Factory lieferte ungültigen Descriptor', maybeDescriptor);\n      }\n    } catch (error) {\n      console.error('openSecurityDetail: Fehler beim Erzeugen des Tab-Descriptors', error);\n    }\n  }\n\n  if (!descriptor) {\n    console.warn(`openSecurityDetail: Kein Detail-Tab für ${securityUuid} verfügbar`);\n    return false;\n  }\n\n  rememberCurrentPageScroll();\n\n  const tabs = getVisibleTabs();\n  let targetIndex = tabs.findIndex((tab) => tab.key === tabKey);\n\n  if (targetIndex === -1) {\n    const updatedTabs = getVisibleTabs();\n    targetIndex = updatedTabs.findIndex((tab) => tab.key === tabKey);\n    if (targetIndex === -1) {\n      console.error('openSecurityDetail: Tab nach Registrierung nicht auffindbar');\n      return false;\n    }\n  }\n\n  currentPage = targetIndex;\n  lastClosedSecurityUuid = null;\n  requestDashboardRender();\n  return true;\n}\n\ninterface CloseSecurityDetailOptions {\n  suppressRender?: boolean;\n}\n\nexport function closeSecurityDetail(\n  securityUuid: string | null | undefined,\n  options: CloseSecurityDetailOptions = {},\n): boolean {\n  if (!securityUuid) {\n    console.error('closeSecurityDetail: Ungültige securityUuid', securityUuid);\n    return false;\n  }\n\n  const { suppressRender = false } = options;\n\n  const tabKey = getSecurityDetailTabKey(securityUuid);\n  if (!hasDetailTab(tabKey)) {\n    return false;\n  }\n\n  const tabsBefore = getVisibleTabs();\n  const tabIndexBefore = tabsBefore.findIndex((tab) => tab.key === tabKey);\n  const wasActive = tabIndexBefore === currentPage;\n\n  unregisterDetailTab(tabKey);\n\n  const tabsAfter = getVisibleTabs();\n  if (!tabsAfter.length) {\n    currentPage = 0;\n    if (!suppressRender) {\n      requestDashboardRender();\n    }\n    return true;\n  }\n\n  lastClosedSecurityUuid = securityUuid;\n\n  if (wasActive) {\n    const overviewIndex = tabsAfter.findIndex((tab) => tab.key === OVERVIEW_TAB_KEY);\n    if (overviewIndex >= 0) {\n      currentPage = overviewIndex;\n    } else {\n      currentPage = Math.min(Math.max(tabIndexBefore - 1, 0), tabsAfter.length - 1);\n    }\n  } else if (currentPage >= tabsAfter.length) {\n    currentPage = Math.max(0, tabsAfter.length - 1);\n  }\n\n  if (!suppressRender) {\n    requestDashboardRender();\n  }\n  return true;\n}\nasync function renderTab(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): Promise<void> {\n  let effectivePanel = panel;\n  if (!effectivePanel) {\n    effectivePanel = resolveDashboardPanel(hass ? hass.panels : null);\n  }\n\n  const tabs = getVisibleTabs();\n  if (currentPage >= tabs.length) {\n    currentPage = Math.max(0, tabs.length - 1);\n  }\n\n  const tab = getTabAtIndex(currentPage);\n  if (!tab) {\n    console.error('renderTab: Kein gültiger Tab oder keine render-Methode gefunden!');\n    return;\n  }\n\n  let content: string | undefined;\n  try {\n    content = await tab.render(root, hass, effectivePanel);\n  } catch (error: unknown) {\n    console.error('renderTab: Fehler beim Rendern des Tabs:', error);\n    root.innerHTML = `<div class=\"card\"><h2>Fehler</h2><pre>${toErrorMessage(error)}</pre></div>`;\n    return;\n  }\n\n  root.innerHTML = content ?? '';\n\n  if (tab.render === renderDashboard) {\n    attachPortfolioToggleHandler(root);\n  }\n\n  const waitForHeaderCard = (): Promise<HTMLElement> =>\n    new Promise((resolve) => {\n      const interval = window.setInterval(() => {\n        const headerCard = root.querySelector<HTMLElement>('.header-card');\n        if (headerCard) {\n          clearInterval(interval);\n          resolve(headerCard);\n        }\n      }, 50);\n    });\n\n  const headerCard = await waitForHeaderCard();\n\n  let anchor = root.querySelector<HTMLElement>(`#${STICKY_HEADER_ANCHOR_ID}`);\n  if (!anchor) {\n    anchor = document.createElement('div');\n    anchor.id = STICKY_HEADER_ANCHOR_ID;\n    const parent = headerCard.parentNode as (ParentNode & Node) | null;\n    if (parent && 'insertBefore' in parent) {\n      parent.insertBefore(anchor, headerCard);\n    }\n  }\n\n  setupNavigation(root, hass, panel);\n  setupSwipeOnHeaderCard(root, hass, panel);\n  setupHeaderScrollBehavior(root);\n}\n\nfunction setupHeaderScrollBehavior(root: HTMLElement): void {\n  const headerCard = root.querySelector<HTMLElement>('.header-card');\n  const anchor = root.querySelector<HTMLElement>(`#${STICKY_HEADER_ANCHOR_ID}`);\n\n  if (!headerCard || !anchor) {\n    console.error('Fehlende Elemente für das Scrollverhalten: headerCard oder anchor.');\n    return;\n  }\n\n  observer?.disconnect();\n\n  observer = new IntersectionObserver(\n    ([entry]) => {\n      if (!entry.isIntersecting) {\n        headerCard.classList.add('sticky');\n      } else {\n        headerCard.classList.remove('sticky');\n      }\n    },\n    {\n      root: null,\n      rootMargin: '0px 0px 0px 0px',\n      threshold: 0,\n    },\n  );\n\n  observer.observe(anchor);\n}\n\nfunction setupSwipeOnHeaderCard(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): void {\n  const headerCard = root.querySelector<HTMLElement>('.header-card');\n  if (!headerCard) {\n    console.error('Header-Card nicht gefunden!');\n    return;\n  }\n\n  addSwipeEvents(\n    headerCard,\n    () => {\n      navigateByDelta(1, root, hass, panel);\n    },\n    () => {\n      navigateByDelta(-1, root, hass, panel);\n    },\n  );\n}\n\nfunction setupNavigation(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): void {\n  const headerCard = root.querySelector<HTMLElement>('.header-card');\n  if (!headerCard) {\n    console.error('Header-Card nicht gefunden!');\n    return;\n  }\n\n  const navLeft = headerCard.querySelector<HTMLButtonElement>('#nav-left');\n  const navRight = headerCard.querySelector<HTMLButtonElement>('#nav-right');\n\n  if (!navLeft || !navRight) {\n    console.error('Navigationspfeile nicht gefunden!');\n    return;\n  }\n\n  navLeft.addEventListener('click', () => {\n    navigateByDelta(-1, root, hass, panel);\n  });\n\n  navRight.addEventListener('click', () => {\n    navigateByDelta(1, root, hass, panel);\n  });\n\n  updateNavigationState(headerCard);\n}\n\nfunction updateNavigationState(headerCard: HTMLElement): void {\n  const navLeft = headerCard.querySelector<HTMLButtonElement>('#nav-left');\n  const navRight = headerCard.querySelector<HTMLButtonElement>('#nav-right');\n\n  if (navLeft) {\n    if (currentPage === 0) {\n      navLeft.disabled = true;\n      navLeft.classList.add('disabled');\n    } else {\n      navLeft.disabled = false;\n      navLeft.classList.remove('disabled');\n    }\n  }\n\n  if (navRight) {\n    const tabs = getVisibleTabs();\n    const atEnd = currentPage === tabs.length - 1;\n    const shouldEnable = !atEnd || !!lastClosedSecurityUuid;\n    navRight.disabled = !shouldEnable;\n    navRight.classList.toggle('disabled', !shouldEnable);\n  }\n}\n\nclass PPReaderDashboard extends HTMLElement {\n  private _root: HTMLElement;\n\n  private _hass: HomeAssistant | null = null;\n\n  private _panel: PanelLike = null;\n\n  private _narrow: boolean | null = null;\n\n  private _route: HassRoute | null = null;\n\n  private _lastPanel: PanelLike = null;\n\n  private _lastNarrow: boolean | null = null;\n\n  private _lastRoute: HassRoute | null = null;\n\n  private _lastPage: number | null = null;\n\n  private _scrollPositions: Record<number, number> = {};\n\n  private _unsubscribeEvents: HassUnsubscribe | null = null;\n\n  private _initialized = false;\n\n  private _hasNewData = false;\n\n  private _pendingUpdates: DashboardUpdateQueueEntry[] = [];\n\n  private _entryIdWaitWarned = false;\n\n  constructor() {\n    super();\n    this._root = document.createElement('div');\n    this._root.className = 'pp-reader-dashboard';\n    this.appendChild(this._root);\n  }\n\n  set hass(hass: HomeAssistant | null | undefined) {\n    this._hass = hass ?? null;\n    this._checkInitialization();\n  }\n\n  set panel(panel: PanelLike) {\n    if (this._panel === panel) {\n      return;\n    }\n    this._panel = panel ?? null;\n    this._checkInitialization();\n  }\n\n  set narrow(narrow: boolean | null | undefined) {\n    if (this._narrow === (narrow ?? null)) {\n      return;\n    }\n    this._narrow = narrow ?? null;\n    this._renderIfInitialized();\n  }\n\n  set route(route: HassRoute | null | undefined) {\n    if (this._route === (route ?? null)) {\n      return;\n    }\n    this._route = route ?? null;\n    this._renderIfInitialized();\n  }\n\n  connectedCallback(): void {\n    this._checkInitialization();\n  }\n\n  disconnectedCallback(): void {\n    this._removeEventListeners();\n  }\n\n  public _checkInitialization(): void {\n    if (!this._hass || this._initialized) {\n      return;\n    }\n\n    if (!this._panel) {\n      this._panel = resolveDashboardPanel(this._hass.panels ?? null);\n    }\n\n    const entryId = getEntryId(this._hass, this._panel);\n    if (!entryId) {\n      if (!this._entryIdWaitWarned) {\n        console.warn('PPReaderDashboard: kein entry_id ermittelbar – warte auf Panel-Konfiguration.');\n        this._entryIdWaitWarned = true;\n      }\n      return;\n    }\n\n    this._entryIdWaitWarned = false;\n    console.debug('PPReaderDashboard: entry_id (fallback) =', entryId);\n    this._initialized = true;\n    this._initializeEventListeners();\n    this._render();\n  }\n\n  private _initializeEventListeners(): void {\n    this._removeEventListeners();\n\n    const conn = this._hass?.connection;\n    if (!conn || typeof conn.subscribeEvents !== 'function') {\n      console.error('PPReaderDashboard: keine valide WebSocket-Verbindung oder subscribeEvents fehlt');\n      return;\n    }\n\n    const eventTypes: readonly string[] = ['panels_updated'];\n\n    const subs: HassUnsubscribe[] = [];\n    const subscriptionPromise = Promise.all(\n      eventTypes.map(async (eventType) => {\n        try {\n          const unsubscribe = await conn.subscribeEvents(\n            this._handleBusEvent.bind(this),\n            eventType,\n          );\n          if (typeof unsubscribe === 'function') {\n            subs.push(unsubscribe);\n            console.debug('PPReaderDashboard: subscribed to', eventType);\n          } else {\n            console.error(\n              'PPReaderDashboard: subscribeEvents lieferte kein Unsubscribe-Func für',\n              eventType,\n              unsubscribe,\n            );\n          }\n        } catch (subscribeError: unknown) {\n          console.error('PPReaderDashboard: Fehler bei subscribeEvents für', eventType, subscribeError);\n        }\n      }),\n    );\n    subscriptionPromise\n      .then(() => {\n        this._unsubscribeEvents = () => {\n          subs.forEach((unsubscribe) => {\n            try {\n              unsubscribe();\n            } catch (error: unknown) {\n              // ignore cleanup errors\n            }\n          });\n          console.debug('PPReaderDashboard: alle Event-Subscriptions entfernt');\n        };\n      })\n      .catch((error: unknown) => {\n        console.error('PPReaderDashboard: Fehler beim Registrieren der Events', error);\n      });\n  }\n  private _removeEventListeners(): void {\n    if (typeof this._unsubscribeEvents === 'function') {\n      try {\n        this._unsubscribeEvents();\n      } catch (error: unknown) {\n        console.error('PPReaderDashboard: Fehler beim Entfernen der Event-Listener:', error);\n      }\n    }\n    this._unsubscribeEvents = null;\n  }\n\n  private _handleBusEvent(event: PanelsUpdatedEvent): void {\n    const currentEntryId = getEntryId(this._hass, this._panel);\n    if (!currentEntryId) {\n      return;\n    }\n\n    const eventData = event.data;\n    if (!isDashboardUpdateType(eventData.data_type)) {\n      return;\n    }\n\n    if (eventData.entry_id && eventData.entry_id !== currentEntryId) {\n      return;\n    }\n\n    const normalized = normalizeDashboardUpdate(eventData.data_type, eventData.data);\n    if (!normalized) {\n      return;\n    }\n\n    this._queueUpdate(normalized.type, normalized.data);\n    this._doRender(normalized.type, normalized.data);\n  }\n\n  private _doRender<T extends DashboardUpdateType>(\n    dataType: T,\n    pushedData: DashboardUpdatePayloadMap[T] | null | undefined,\n  ): void {\n    switch (dataType) {\n      case 'accounts':\n        handleAccountUpdate(\n          pushedData as DashboardUpdatePayloadMap['accounts'],\n          this._root,\n        );\n        break;\n      case 'last_file_update':\n        handleLastFileUpdate(\n          pushedData as DashboardUpdatePayloadMap['last_file_update'],\n          this._root,\n        );\n        break;\n      case 'portfolio_values':\n        handlePortfolioUpdate(\n          pushedData as DashboardUpdatePayloadMap['portfolio_values'],\n          this._root,\n        );\n        break;\n      case 'portfolio_positions':\n        handlePortfolioPositionsUpdate(\n          pushedData as DashboardUpdatePayloadMap['portfolio_positions'],\n          this._root,\n        );\n        break;\n      default:\n        console.warn('PPReaderDashboard: Unbekannter Datentyp:', dataType);\n        break;\n    }\n  }\n\n  private _queueUpdate<T extends DashboardUpdateType>(\n    dataType: T,\n    pushedData: DashboardUpdatePayloadMap[T] | null | undefined,\n  ): void {\n    const clonedData = this._cloneData(pushedData);\n    const entry: DashboardUpdateQueueEntry<T> = {\n      type: dataType,\n      data: clonedData,\n    };\n\n    if (dataType === 'portfolio_positions') {\n      entry.portfolioUuid = extractPortfolioUuidFromPositionsUpdate(\n        clonedData as DashboardUpdatePayloadMap['portfolio_positions'],\n      );\n    }\n\n    let index = -1;\n    if (dataType === 'portfolio_positions' && entry.portfolioUuid) {\n      index = this._pendingUpdates.findIndex(\n        (item) => item.type === dataType && item.portfolioUuid === entry.portfolioUuid,\n      );\n    } else {\n      index = this._pendingUpdates.findIndex((item) => item.type === dataType);\n    }\n\n    if (index >= 0) {\n      this._pendingUpdates[index] = entry;\n    } else {\n      this._pendingUpdates.push(entry);\n    }\n\n    this._hasNewData = true;\n  }\n\n  private _cloneData<T>(data: T): T {\n    if (data == null) {\n      return data;\n    }\n\n    try {\n      if (typeof structuredClone === 'function') {\n        return structuredClone(data);\n      }\n    } catch (error: unknown) {\n      console.warn('PPReaderDashboard: structuredClone fehlgeschlagen, falle auf JSON zurück', error);\n    }\n\n    try {\n      return JSON.parse(JSON.stringify(data)) as T;\n    } catch (error: unknown) {\n      console.warn('PPReaderDashboard: JSON-Clone fehlgeschlagen, referenziere Originaldaten', error);\n      return data;\n    }\n  }\n\n  private _reapplyPendingUpdates(): void {\n    if (!Array.isArray(this._pendingUpdates) || this._pendingUpdates.length === 0) {\n      return;\n    }\n\n    for (const item of this._pendingUpdates) {\n      try {\n        this._doRender(item.type, this._cloneData(item.data));\n      } catch (error: unknown) {\n        console.error('PPReaderDashboard: Fehler beim erneuten Anwenden eines Updates', item, error);\n      }\n    }\n  }\n\n  public _renderIfInitialized(): void {\n    if (this._initialized) {\n      this._render();\n    }\n  }\n\n  public handleExternalRender(page: number): void {\n    this._afterRender(page);\n  }\n\n  public rememberScrollPosition(page: number = currentPage): void {\n    const targetPage = Number.isInteger(page) ? page : currentPage;\n    this._scrollPositions[targetPage] = this._root.scrollTop || 0;\n  }\n\n  private _render(): void {\n    if (!this._hass) {\n      console.warn('pp-reader-dashboard: noch kein hass, überspringe _render()');\n      return;\n    }\n    if (!this._initialized) {\n      console.debug('pp-reader-dashboard: _render aufgerufen bevor initialisiert');\n      return;\n    }\n\n    const page = currentPage;\n    if (\n      !this._hasNewData &&\n      this._panel === this._lastPanel &&\n      this._narrow === this._lastNarrow &&\n      this._route === this._lastRoute &&\n      this._lastPage === page\n    ) {\n      return;\n    }\n\n    if (this._lastPage != null) {\n      this._scrollPositions[this._lastPage] = this._root.scrollTop;\n    }\n\n    const renderResult = renderTab(this._root, this._hass, this._panel);\n    if (isPromiseLike<unknown>(renderResult)) {\n      renderResult\n        .then(() => {\n          this._afterRender(page);\n        })\n        .catch((error: unknown) => {\n          console.error('PPReaderDashboard: Fehler beim Rendern des Tabs', error);\n          this._afterRender(page);\n        });\n      return;\n    }\n\n    this._afterRender(page);\n  }\n\n  private _afterRender(page: number): void {\n    const restore = this._scrollPositions[page] || 0;\n    this._root.scrollTop = restore;\n\n    this._lastPanel = this._panel;\n    this._lastNarrow = this._narrow;\n    this._lastRoute = this._route;\n    this._lastPage = page;\n\n    try {\n      this._reapplyPendingUpdates();\n    } catch (error) {\n      console.error('PPReaderDashboard: Fehler beim Wiederanlegen der Updates', error);\n    }\n\n    this._hasNewData = false;\n  }\n}\n\nif (!customElements.get('pp-reader-dashboard')) {\n  customElements.define('pp-reader-dashboard', PPReaderDashboard);\n}\n\nconsole.log('PPReader dashboard module v20250914b geladen');\n\nregisterSecurityDetailTab({\n  setSecurityDetailTabFactory,\n});\n"],"names":["triggerSwipe","direction","callback","error","addSwipeEvents","element","onSwipeLeft","onSwipeRight","startX","handleSwipe","deltaX","handleTouchStart","event","handleTouchEnd","touch","handleMouseDown","handleMouseUp","resolveRoundedTrend","numericValue","decimals","threshold","formatValue","key","value","row","context","formatted","toNumber","v","cleaned","parsed","safeNumber","minFrac","maxFrac","num","renderMissingValue","reason","title","performance","metric","missingReason","numeric","symbol","hasFraction","base","makeTable","rows","cols","sumColumns","options","sortable","defaultSort","defaultSortKey","defaultSortDir","escapeAttribute","html","c","alignClass","r","sums","sumMeta","aggregation","acc","candidate","numericCandidate","gainAbsSum","purchaseSum","currentValueSum","aggregatedGainPct","aggregatedGainPctLabel","aggregatedGainPctSign","formatNumber","idx","extraAttributes","fallbackContext","tpl","table","e","createHeaderCard","headerTitle","meta","headerCard","formatGain","formatGainPct","sortTableRows","tableEl","dir","isPositions","tbody","footer","colIdx","mappedIdx","ths","i","txt","a","b","aCell","bCell","aTxt","bTxt","aNum","bNum","cmp","hasNumericContext","th","activeTh","isRecord","toStringValue","toNullableString","toFiniteNumber","trimmed","normalized","toInteger","truncated","cloneRecord","deserializeDataState","readBoolean","deserializeAccountSnapshot","name","currencyCode","origBalance","balance","snapshot","fxRate","fxRateSource","fxRateTimestamp","coverageRatio","provenance","metricRunUuid","fxUnavailable","deserializeAccountSnapshots","snapshots","entry","deserializePositionSnapshot","aggregationRaw","securityUuid","currentHoldings","purchaseValue","currentValue","lastPriceNative","lastPriceEur","lastCloseNative","lastCloseEur","deserializePositionSnapshots","deserializePortfolioSnapshot","deserializePortfolioSnapshots","deserializeNormalizedPayloadMetadata","metadata","generatedAt","deserializeNormalizationDiagnostics","diagnostics","normalizedPayload","deserializeNormalizedDashboardSnapshot","accounts","portfolios","toStringOrNull","toMetricRunUuid","toFiniteNumberOrUndefined","requireString","field","requireNumber","mapPositionSnapshotToRecord","position","deriveEntryId","hass","panelConfig","_a","_b","_c","_d","_e","_f","_g","_h","entryId","panels","panel","getEntryId","fetchAccountsWS","raw","fetchLastFileUpdateWS","response","lastFileUpdate","fetchPortfoliosWS","fetchPortfolioPositionsWS","portfolioUuid","positions","normalizedPayloadMeta","fetchSecuritySnapshotWS","fetchSecurityHistoryWS","payload","startDate","endDate","startDateRaw","endDateRaw","resolvedStart","resolvedEnd","dashboardElements","panelHosts","overviewHelpers","OVERVIEW_HELPER_KEYS","setOverviewHelper","helper","getRegisteredDashboardElements","getRegisteredPanelHosts","registerOverviewHelpers","helpers","getOverviewHelpers","DEFAULT_DECIMALS","toFiniteCurrency","direct","stripped","lastComma","lastDot","hasComma","hasDot","commaGroups","decimalDigits","integerPart","integerDigits","multipleCommas","integerIsZero","localized","relaxed","roundCurrency","fallback","factor","rounded","normalizeCurrencyValue","normalizePercentValue","NUMERIC_STRING_PATTERN","toOptionalString","normalizeDayChangePayload","priceChangeNative","priceChangeEur","changePct","source","coverage","normalizePerformancePayload","gainAbs","gainPct","totalChangeEur","totalChangePct","dayChange","portfolioPositionsCache","toNonEmptyString","toNullableNumber","isPortfolioPositionRecord","record","clonePosition","clone","setPortfolioPositions","normalised","hasPortfolioPositions","getPortfolioPositions","entries","clearAllPortfolioPositions","getPortfolioPositionsSnapshot","normalizeAverageCostPayload","native","security","account","eur","normalizeAggregationPayload","totalHoldings","positiveHoldings","purchaseValueEur","securityTotal","accountTotal","purchaseValueCents","normalizePositionRecord","averageCost","dataState","normalizePositionRecords","accountsState","portfolioState","toFiniteInteger","clonePositionSnapshot","clonePortfolioSnapshot","normalizePortfolioSnapshot","uuid","positionCount","missingPositions","filtered","mergeSnapshots","current","patch","merged","setAccountSnapshots","getAccountSnapshots","replacePortfolioSnapshots","mergePortfolioSnapshots","patches","existing","setPortfolioPositionsSnapshot","next","getPortfolioSnapshots","getPortfolioStoreState","FALLBACK_ACCOUNT_ID","sanitizeLabel","clampRatio","formatPercentageLabel","composeCoverageBadge","ratio","scope","clamped","percentValue","tone","labelPrefix","description","titleCase","token","composeProvenanceBadge","normalizeProvenanceLabel","friendly","structured","parseStructuredProvenance","currencies","extractCurrencyCodes","provider","normalizeCode","fromArray","values","code","buildAccountRow","badges","coverageBadge","provenanceBadge","normalizedMetricRunUuid","buildPortfolioRow","missingValuePositions","hasValue","selectAccountOverviewRows","selectPortfolioOverviewRows","escapeHtml","match","renderBadgeList","containerClass","items","badge","toneClass","renderNameWithBadges","label","badgeMarkup","labelClass","setDiagnosticChange","changes","previousValue","pendingPortfolioUpdates","pendingRetryMetaMap","formatErrorMessage","serialized","normalizePerformanceMetrics","PENDING_RETRY_INTERVAL","PENDING_MAX_ATTEMPTS","PORTFOLIO_POSITIONS_UPDATED_EVENT","DASHBOARD_DIAGNOSTICS_EVENT","diagnosticSnapshotMap","DIAGNOSTIC_FIELDS","getDiagnosticKey","kind","normalizeCoverageValue","normalizeMetadataString","buildSnapshotDiagnostics","normalizedCoverage","normalizedProvenance","normalizedGeneratedAt","diffDiagnostics","previous","hasChanges","buildRemovalChanges","dispatchDiagnosticsEvent","detail","emitDiagnosticsSnapshot","removalChanges","emitAccountDiagnostics","emitPortfolioDiagnostics","portfolio","emitPortfolioPositionsDiagnostics","update","renderPositionsError","restoreSortAndInit","containerEl","rootEl","pid","attachPortfolioPositionsSorting","attachSecurityDetailListener","applyPortfolioPositionsToDom","root","detailsRow","container","prevKey","prevDir","renderPositionsTableInline","flushPendingPositions","pending","result","flushAllPendingPositions","appliedAny","schedulePendingRetry","success","handleAccountUpdate","updatedAccounts","accountRows","updateAccountTable","portfolioTable","currentValueCell","textContent","updateTotalWealth","eurContainer","fxContainer","eurAccounts","fxAccounts","eurRows","fxRows","hasOrigBalance","amountLabel","fxDisplay","normalizePortfolioUpdateEntries","handlePortfolioUpdate","normalizedPatches","formatNumberLocal","val","locale","rowMap","patched","formatPositionCount","normalizedByUuid","posCountCell","curValCell","gainAbsCell","gainPctCell","posCount","purchase","oldCur","parseNumLoose","rowData","rowContext","currentMarkup","curValNumeric","gainMarkup","pctValue","patchedLabel","updatePortfolioFooter","findTable","selectors","selector","eurTable","fxTable","extractAccounts","tbl","isFx","cell","portfolioDomValues","currentValueRaw","purchaseSumRaw","normalizePortfolioUuid","camelCase","processPortfolioPositionsUpdate","normalizedPositions","securityUuids","pos","dispatchError","handlePortfolioPositionsUpdate","handled","item","renderPositionsTable","applyGainPctMetadata","colKeys","tr","gainPctMetadata","err","gainCell","gainPctValue","pctLabel","pctSign","parseDatasetNumber","metrics","totalsComplete","sumGainPct","sumPositionsDisplay","footerRowData","footerContext","gainAbsValue","gainAbsCellMarkup","gainPctCellMarkup","footerGainAbsCell","toFiniteNumberOrZero","targetRoot","accountSum","portfolioSum","totalWealth","headerMeta","valueElement","handleLastFileUpdate","resolvedUpdate","el","metaHost","reapplyPositionsSort","__TEST_ONLY__","PORTFOLIO_SORT_KEYS","isPortfolioPositionsSortKey","isPortfolioSortDirection","_hassRef","_panelConfigRef","PRICE_FRACTION_DIGITS","isFiniteNumber","normalizeCurrencyCode","upper","resolveCurrencyFromPosition","keys","formatPriceWithCurrency","currency","buildPurchasePriceDisplay","securityCurrency","accountCurrency","averageNative","averageSecurity","averageAccount","averageEur","nativeAverage","eurAverage","resolvedSecurityCurrency","isEurSecurity","primaryCurrency","primaryValue","primaryText","formattedEur","shouldRenderAccount","parts","ariaParts","markup","sortValue","ariaLabel","expandedPortfolios","pctText","p","col","purchaseCell","renderPortfolioPositions","attachSecurityDetailDelegation","target","interactive","openSecurityDetail","buildExpandablePortfolioTable","depots","align","d","partialValue","datasetCoverageRatio","datasetProvenance","datasetMetricRunUuid","expanded","toggleClass","detailId","valueContext","gainPctLabel","gainPctSign","datasetCurrentValue","datasetGainAbs","datasetGainPct","positionCountAttr","gainAbsAttributes","safeName","positionCountDisplay","availableDepots","sumPositions","sumCurrent","sumPurchase","sumGainAbs","sumHasValue","sumIsPartial","sumRowData","sumContext","sumCurrentCell","sumGainAbsCell","sumGainPctCell","sumGainAbsAttributes","sumGainPctLabel","sumGainPctSign","sumPositionAttr","sumCurrentAttr","sumPurchaseAttr","sumGainAbsAttr","sumGainPctAttr","resolvePortfolioTable","scoped","nested","generic","readDatasetNumber","updatePortfolioFooterFromDom","hasValueRow","allRowsComplete","hasValueAttr","child","currentValueHtml","gainAbsHtml","gainPctHtml","applySort","parseNum","aCellEl","bCellEl","resolveSortValue","text","sortAttr","numericAttr","comp","aValue","bValue","containerKey","containerDir","defaultKey","defaultDir","currentKey","currentDir","keyAttr","reloadPortfolioPositions","targetContainer","resp","errorText","message","waitForElement","timeoutMs","intervalMs","start","resolve","tick","attachPortfolioToggleHandler","retryBtn","cont","btn","caretEl","ensurePortfolioRowFallbackListener","primaryContainer","renderDashboard","accountsResp","portfoliosResp","totalAccounts","sum","anyPortfolioMissing","depot","anyAccountMissing","totalDepots","missingWealthReason","wealthValueMarkup","wealthNote","portfolioTableHtml","fxWarning","accountsHtml","footerCard","schedulePostRenderSetup","run","wrapper","tableHost","footerErr","pendingErr","schedule","cb","SVG_NS","DEFAULT_WIDTH","DEFAULT_HEIGHT","DEFAULT_MARGIN","DEFAULT_COLOR","DEFAULT_AREA","DEFAULT_TICK_FONT","DEFAULT_BASELINE_COLOR","DEFAULT_BASELINE_DASH","ONE_DAY_MS","toAttributeValue","timestamp","safeText","px","createSvgElement","tag","attrs","attributeValue","toTimestamp","fallbackIndex","defaultXAccessor","defaultYAccessor","defaultXFormatter","dataPoint","_index","date","defaultYFormatter","_dataPoint","defaultTooltipRenderer","xFormatted","yFormatted","ensureChartState","clamp","min","max","buildAreaPath","points","baselineY","segments","point","index","command","x","y","firstPoint","closing","buildLinePath","applyBaselineAppearance","state","baselineLine","baseline","stroke","dashArray","updateBaselineLine","range","margin","width","baselineValue","minY","maxY","boundedHeight","safeMinY","denominator","clampedRatio","effectiveHeight","effectiveWidth","x1","x2","computePoints","series","dimensions","accessors","height","xAccessor","yAccessor","rawPoints","rawX","rawY","xValue","yValue","minX","maxX","boundedWidth","safeMinX","safeMaxX","safeMaxY","minDomainCandidate","maxDomainCandidate","desiredYTicks","domainMinY","domainMaxY","computeNiceDomain","effectiveMinY","effectiveMaxY","rangeX","rangeY","ratioX","ratioY","assignDimensions","formatTooltip","updateTooltipPosition","pointerY","tooltip","tooltipWidth","tooltipHeight","horizontal","maxVertical","padding","anchorY","vertical","translateX","translateY","hideTooltip","focusLine","focusCircle","attachPointerHandlers","handlePointerMove","rect","pointerX","closest","minDistance","distance","handlePointerLeave","renderLineChart","svg","areaPath","linePath","overlay","xAxis","yAxis","updateLineChart","updateAxes","lineD","areaD","yFormatter","hasValidX","hasValidY","rangeDays","desiredTicks","generateTimeAxisTicks","positionRatio","textAlign","yAxisWidth","yTicks","generateNumericAxisTicks","applyFormatter","top","minValue","maxValue","safeTicks","niceStep","rawStep","step","niceMin","niceMax","minTimestamp","maxTimestamp","formatXAxisLabel","tickCount","ticks","end","_","exponent","fraction","niceFraction","isStringArray","isPortfolioPositionsUpdatedEventDetail","isPortfolioPositionsUpdatedEvent","HOLDINGS_FRACTION_DIGITS","DEFAULT_HISTORY_RANGE","AVAILABLE_HISTORY_RANGES","RANGE_DAY_COUNTS","AVERAGE_COST_SOURCE_LABELS","SECURITY_HISTORY_CACHE","RANGE_STATE_REGISTRY","SNAPSHOT_DETAIL_REGISTRY","LIVE_UPDATE_EVENT","LIVE_UPDATE_HANDLERS","buildCachedSnapshotNotice","params","fallbackUsed","flaggedAsCache","reasons","cacheSecuritySnapshotDetail","getCachedSecuritySnapshot","cached","ensureHistoryCache","invalidateHistoryCache","cache","invalidateSnapshotCaches","handleLiveUpdateForSecurity","ensureLiveUpdateSubscription","handler","removeLiveUpdateSubscription","cleanupSecurityDetailState","setActiveRange","rangeKey","getActiveRange","toEpochDay","epochMs","normaliseDate","toNonEmptyTrimmedString","toUppercaseCode","formatErrorLabel","resolveRangeOptions","now","parseHistoryDate","year","month","day","parseTimestamp","normaliseHistorySeries","prices","close","rawClose","extractSnapshotLastPriceNative","extractSnapshotLastPriceTimestamp","fetchedAt","normalizedFetchedAt","lastPriceRecord","lastPriceFetchedAt","buildHistorySeriesWithSnapshotPrice","historySeries","baseSeries","seriesWithSnapshot","lastPriceTimestamp","candidateDate","targetDay","latestSeriesDay","parsedDate","entryDay","isPositiveFinite","areNumbersClose","first","second","tolerance","absoluteDiff","scale","computePercentageChange","reference","computePriceChangeMetrics","firstEntry","lastEntry","fallbackLast","effectiveLast","rawDelta","priceChange","priceChangePct","resolveRoundedTrendClass","formatPriceChangeValue","formatPrice","trendClass","suffix","formatPercentageChangeValue","buildInfoBar","rangeLabel","rangeCaption","buildRangeSelector","activeRange","buildHistoryPlaceholder","safeRange","ariaSuffix","rangeDescriptor","formatHoldings","minFraction","maxFraction","formatPriceChangeWithCurrency","resolveAccountCurrencyCode","accountAverage","securityAverage","normalizedAverageCost","accountAverageNumeric","rawExplicit","securityAverageNumeric","formatFxRate","resolvePurchaseFxTimestamp","snapshotRecord","candidateKeys","fallbackCandidates","lastPrice","formatFxDateLabel","composeAveragePurchaseTooltip","accountCurrencySafe","formattedRate","inverseRateLabel","inverse","dateLabel","metadataParts","sourceKey","sourceLabel","percentage","datePart","selectAveragePurchaseBaseline","buildHeaderMeta","holdingsSource","holdings","lastPriceNativeRaw","formattedLastPrice","lastPriceDisplay","marketValueRaw","averagePurchaseNativeRaw","averagePurchaseEurRaw","resolvedAccountAverage","performancePayload","dayChangePayload","dayPriceChangeNative","dayPriceChangeEur","dayChangeValue","dayChangeCurrency","wrapValue","content","extraClass","classes","wrapMissingValue","renderGainValue","renderGainPercentage","lastPriceValue","holdingsValue","marketValue","dayChangeAbsolute","dayChangePercentage","totalChangeAbsolute","totalChangePercentage","averagePurchaseTooltip","averageValueGroupAttributes","averagePurchaseValues","normaliseHistoryError","getHistoryChartOptions","host","measuredWidth","safeCurrency","HISTORY_CHART_INSTANCES","renderHistoryChart","chartOptions","chartContainer","updateRangeButtons","button","isActive","updateInfoBarContent","infoBar","fresh","updateHistoryPlaceholder","placeholderContainer","scheduleRangeSetup","initialRange","initialHistory","initialHistoryState","rangeSelector","initialBaseline","initialDisplayHistory","effectiveInitialState","handleRangeClick","historyState","displayHistorySeries","rangeOptions","historyResponse","snapshotLastPriceNative","rangeBaseline","renderSecurityDetail","cachedSnapshot","snapshotPayload","effectiveSnapshot","staleNotice","historyError","registerSecurityDetailTab","setSecurityDetailTabFactory","ACCOUNTS_TAB_KEY","ACCOUNT_TAB_TITLE","partitionAccounts","fx","sumBalances","formatEuroLabel","formatOriginalBalance","formatFxTimestamp","formatFxSource","rateLabel","eurTotal","fxTotal","fxMissingCount","fxTotalLabel","missingNote","buildFxWarningBanner","count","plural","buildAccountsTables","renderAccountsTab","_root","warningBanner","accountsTabDescriptor","addSwipeEventsUnsafe","STICKY_HEADER_ANCHOR_ID","OVERVIEW_TAB_KEY","SECURITY_DETAIL_TAB_PREFIX","baseTabs","detailTabRegistry","detailTabOrder","securityTabLookup","securityDetailTabFactory","navigationInProgress","lastClosedSecurityUuid","currentPage","observer","isPromiseLike","toErrorMessage","isDashboardUpdateType","extractPortfolioUuidFromSingleUpdate","uuidCandidate","camelCaseCandidate","extractPortfolioUuidFromPositionsUpdate","normalizeDashboardUpdate","dataType","data","extractSecurityUuidFromKey","tryReopenLastDetail","reopened","getVisibleTabs","detailTabs","descriptor","getTabAtIndex","tabs","resolveDashboardPanel","normalizedPanels","preferred","rememberCurrentPageScroll","dashboardElement","findDashboardElement","clampPageIndex","navigateToPage","targetIndex","clampedIndex","currentTab","currentSecurityUuid","nextIndex","intendedTarget","closeSecurityDetail","overviewIndex","tab","renderedPage","renderTab","notifyExternalRender","navigateByDelta","delta","registerDetailTab","existingKey","unregisterDetailTab","normalizedDescriptor","cleanupResult","cleanupError","hasDetailTab","getDetailTabDescriptor","factory","getSecurityDetailTabKey","hostCandidates","standalone","requestDashboardRender","page","tabKey","maybeDescriptor","suppressRender","tabIndexBefore","wasActive","tabsAfter","effectivePanel","interval","anchor","parent","setupNavigation","setupSwipeOnHeaderCard","setupHeaderScrollBehavior","navLeft","navRight","updateNavigationState","shouldEnable","PPReaderDashboard","__publicField","narrow","route","conn","eventTypes","subs","eventType","unsubscribe","subscribeError","currentEntryId","eventData","pushedData","clonedData","targetPage","renderResult","restore"],"mappings":";;;AAUA,SAASA,GAAaC,GAA2BC,GAA+B;AAC9E,MAAI;AACF,IAAAA,EAAA;AAAA,EACF,SAASC,GAAO;AACd,YAAQ,KAAK,mBAAmBF,CAAS,kBAAkBE,CAAK;AAAA,EAClE;AACF;AAEO,SAASC,GACdC,GACAC,GACAC,GACM;AACN,MAAIC,IAAwB;AAE5B,QAAMC,IAAc,CAACC,MAAyB;AAC5C,IAAIA,IAAS,MACXV,GAAa,QAAQM,CAAW,IACvBI,IAAS,MAClBV,GAAa,SAASO,CAAY;AAAA,EAEtC,GAEMI,IAAmB,CAACC,MAA4B;AACpD,IAAIA,EAAM,QAAQ,WAAW,MAC3BJ,IAASI,EAAM,QAAQ,CAAC,EAAE;AAAA,EAE9B,GAEMC,IAAiB,CAACD,MAA4B;AAClD,QAAIJ,MAAW;AACb;AAEF,QAAII,EAAM,eAAe,WAAW,GAAG;AACrC,MAAAJ,IAAS;AACT;AAAA,IACF;AACA,UAAMM,IAAQF,EAAM,eAAe,CAAC;AACpC,IAAAH,EAAYK,EAAM,UAAUN,CAAM,GAClCA,IAAS;AAAA,EACX,GAEMO,IAAkB,CAACH,MAA4B;AACnD,IAAAJ,IAASI,EAAM;AAAA,EACjB,GAEMI,IAAgB,CAACJ,MAA4B;AACjD,IAAIJ,MAAW,SAGfC,EAAYG,EAAM,UAAUJ,CAAM,GAClCA,IAAS;AAAA,EACX;AAEA,EAAAH,EAAQ,iBAAiB,cAAcM,GAAkB,EAAE,SAAS,IAAM,GAC1EN,EAAQ,iBAAiB,YAAYQ,GAAgB,EAAE,SAAS,IAAM,GACtER,EAAQ,iBAAiB,aAAaU,CAAe,GACrDV,EAAQ,iBAAiB,WAAWW,CAAa;AACnD;ACxCA,MAAMC,KAAsB,CAC1BC,GACAC,MACwC;AACxC,MAAI,CAAC,OAAO,SAASD,CAAY,KAAKA,MAAiB;AACrD,WAAO;AAGT,QAAME,IAAY,MAAM,KAAK,IAAI,IAAID,CAAQ;AAC7C,SAAI,KAAK,IAAID,CAAY,IAAIE,IACpB,YAGFF,IAAe,IAAI,aAAa;AACzC;AAEO,SAASG,EACdC,GACAC,GACAC,IAA4B,QAC5BC,IAA0C,QAClC;AACR,MAAIC,IAA2B;AAE/B,QAAMC,IAAW,CAACC,MAAuB;AACvC,QAAI,OAAOA,KAAM;AACf,aAAOA;AAET,QAAI,OAAOA,KAAM,YAAYA,EAAE,KAAA,MAAW,IAAI;AAC5C,YAAMC,IAAUD,EACb,QAAQ,QAAQ,EAAE,EAClB,QAAQ,cAAc,EAAE,EACxB,QAAQ,sBAAsB,EAAE,EAChC,QAAQ,KAAK,GAAG,GACbE,IAAS,OAAO,WAAWD,CAAO;AACxC,aAAO,OAAO,MAAMC,CAAM,IAAI,OAAO,MAAMA;AAAA,IAC7C;AACA,WAAO,OAAO;AAAA,EAChB,GAEMC,IAAa,CAACH,GAAYI,IAAU,GAAGC,IAAU,MAAc;AACnE,UAAMC,IAAM,OAAON,KAAM,WAAWA,IAAID,EAASC,CAAC;AAClD,WAAK,OAAO,SAASM,CAAG,IAGjBA,EAAI,eAAe,SAAS;AAAA,MACjC,uBAAuBF;AAAA,MACvB,uBAAuBC;AAAA,IAAA,CACxB,IALQ;AAAA,EAMX,GAEME,IAAqB,CAACC,IAAS,OAAe;AAClD,UAAMC,IAAQD,KAAU;AACxB,WAAO,uDAAuDC,CAAK,YAAYA,CAAK;AAAA,EACtF;AAEA,MAAI,CAAC,YAAY,UAAU,EAAE,SAASf,CAAG,GAAG;AAC1C,QAAIC,KAAS,QAAQC,GAAK;AACxB,YAAMc,IAAcd,EAAI;AACxB,UAAI,OAAOc,KAAgB,YAAYA,MAAgB,MAAM;AAC3D,cAAMC,IAAUD,EAAwChB,CAAG;AAC3D,QAAI,OAAOiB,KAAW,aACpBhB,IAAQgB;AAAA,MAEZ;AAAA,IACF;AACA,UAAMC,KAAgBhB,KAAA,gBAAAA,EAAK,oBAAmB,KAC1C,qDACA;AACJ,QAAID,KAAS,SAAQE,KAAA,gBAAAA,EAAS,cAAa;AACzC,aAAOU,EAAmBK,CAAa;AAEzC,UAAMC,IAAU,OAAOlB,KAAU,WAAWA,IAAQI,EAASJ,CAAK;AAClE,QAAI,CAAC,OAAO,SAASkB,CAAO;AAC1B,aAAON,EAAmBK,CAAa;AAEzC,UAAME,IAASpB,MAAQ,aAAa,MAAM;AAC1C,WAAAI,IAAYK,EAAWU,CAAO,IAAI,SAASC,CAAM,IAE1C,gBADKzB,GAAoBwB,GAAS,CAAC,CAChB,KAAKf,CAAS;AAAA,EAC1C,WAAWJ,MAAQ,kBAAkB;AACnC,UAAMmB,IAAU,OAAOlB,KAAU,WAAWA,IAAQI,EAASJ,CAAK;AAClE,QAAI,CAAC,OAAO,SAASkB,CAAO;AAC1B,aAAON,EAAA;AAET,IAAAT,IAAYe,EAAQ,eAAe,OAAO;AAAA,EAC5C,WAAW,CAAC,WAAW,iBAAiB,gBAAgB,EAAE,SAASnB,CAAG,GAAG;AACvE,UAAMmB,IAAU,OAAOlB,KAAU,WAAWA,IAAQI,EAASJ,CAAK;AAClE,QAAI,CAAC,OAAO,SAASkB,CAAO;AAC1B,aAAIjB,KAAA,QAAAA,EAAK,iBACAW,EAAmB,kDAAkD,KAE1EV,KAAWA,EAAQ,aAAa,IAC3BU,EAAA;AAIX,IAAAT,IAAYK,EAAWU,CAAO,IAAI;AAAA,EACpC,WAAWnB,MAAQ,oBAAoB;AAErC,UAAMmB,IAAU,OAAOlB,KAAU,WAAWA,IAAQI,EAASJ,CAAK;AAClE,QAAI,CAAC,OAAO,SAASkB,CAAO;AAC1B,aAAON,EAAA;AAET,UAAMQ,IAAc,KAAK,IAAIF,IAAU,CAAC,IAAI;AAC5C,IAAAf,IAAYe,EAAQ,eAAe,SAAS;AAAA,MAC1C,uBAAuBE,IAAc,IAAI;AAAA,MACzC,uBAAuB;AAAA,IAAA,CACxB;AAAA,EACH,OAAO;AACL,QAAIC,IAAO;AACX,IAAI,OAAOrB,KAAU,WACnBqB,IAAOrB,IACE,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK,IAC3DqB,IAAOrB,EAAM,SAAA,IACJ,OAAOA,KAAU,YAC1BqB,IAAOrB,IAAQ,SAAS,UACfA,aAAiB,QAAQ,OAAO,SAASA,EAAM,QAAA,CAAS,MACjEqB,IAAOrB,EAAM,YAAA,IAEfG,IAAYkB,GACRlB,MACgB,cAAc,KAAKA,CAAS,MAGxCA,EAAU,SAAS,OACrBA,IAAYA,EAAU,MAAM,GAAG,EAAW,IAAI,MAG5CA,EAAU,WAAW,aAAa,IACpCA,IAAYA,EAAU,UAAU,EAAoB,IAC3CA,EAAU,WAAW,YAAY,MAC1CA,IAAYA,EAAU,UAAU,EAAmB;AAAA,EAI3D;AACA,SAAI,OAAOA,KAAc,YAAYA,MAAc,KAC1CS,EAAA,IAGFT;AACT;AAEO,SAASmB,GACdC,GACAC,GACAC,IAAgC,CAAA,GAChCC,IAAwB,IAChB;AAQR,QAAM,EAAE,UAAAC,IAAW,IAAO,aAAAC,EAAA,IAAgBF,GACpCG,KAAiBD,KAAA,gBAAAA,EAAa,QAAO,IACrCE,KAAgCF,KAAA,gBAAAA,EAAa,SAAQ,SAAS,SAAS,OAEvEG,IAAkB,CAAC/B,MAA2B;AAClD,QAAIA,KAAS;AACX,aAAO;AAET,QAAIqB,IAAO;AACX,QAAI,OAAOrB,KAAU;AACnB,MAAAqB,IAAOrB;AAAA,aACE,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK;AAC3D,MAAAqB,IAAOrB,EAAM,SAAA;AAAA,aACJ,OAAOA,KAAU;AAC1B,MAAAqB,IAAOrB,IAAQ,SAAS;AAAA,aACfA,aAAiB,QAAQ,OAAO,SAASA,EAAM,QAAA,CAAS;AACjE,MAAAqB,IAAOrB,EAAM,YAAA;AAAA;AAEb,aAAO;AAET,WAAOqB,EAAK,QAAQ,MAAM,OAAO,EAAE,QAAQ,MAAM,QAAQ;AAAA,EAC3D;AAEA,MAAIW,IAAO;AACX,EAAAR,EAAK,QAAQ,CAAAS,MAAK;AAChB,UAAMC,IAAaD,EAAE,UAAU,UAAU,yBAAyB;AAElE,IAAIN,KAAYM,EAAE,MAChBD,KAAQ,MAAME,CAAU,mBAAmBD,EAAE,GAAG,KAAKA,EAAE,KAAK,UAE5DD,KAAQ,MAAME,CAAU,IAAID,EAAE,KAAK;AAAA,EAEvC,CAAC,GACDD,KAAQ,wBAERT,EAAK,QAAQ,CAAAY,MAAK;AAChB,IAAAH,KAAQ,QACRR,EAAK,QAAQ,CAAAS,MAAK;AAChB,YAAMC,IAAaD,EAAE,UAAU,UAAU,yBAAyB;AAClE,MAAAD,KAAQ,MAAME,CAAU,IAAIpC,EAAYmC,EAAE,KAAKE,EAAEF,EAAE,GAAG,GAAGE,CAAC,CAAC;AAAA,IAC7D,CAAC,GACDH,KAAQ;AAAA,EACV,CAAC;AAGD,QAAMI,IAAsC,CAAA,GACtCC,IAA8C,CAAA;AACpD,EAAAb,EAAK,QAAQ,CAAAS,MAAK;AAChB,QAAIR,EAAW,SAASQ,EAAE,GAAG,GAAG;AAC9B,YAAMK,IAAcf,EAAK;AAAA,QACvB,CAACgB,GAAKtC,MAAQ;AACZ,cAAIuC,IAAYvC,EAAIgC,EAAE,GAAG;AACzB,eAAKA,EAAE,QAAQ,cAAcA,EAAE,QAAQ,gBAAgB,OAAOO,KAAc,YAAY,CAAC,OAAO,SAASA,CAAS,IAAI;AACpH,kBAAMzB,IAAcd,EAAI;AACxB,gBAAI,OAAOc,KAAgB,YAAYA,MAAgB,MAAM;AAC3D,oBAAMC,IAAUD,EAAwCkB,EAAE,GAAG;AAC7D,cAAI,OAAOjB,KAAW,aACpBwB,IAAYxB;AAAA,YAEhB;AAAA,UACF;AACA,cAAI,OAAOwB,KAAc,YAAY,OAAO,SAASA,CAAS,GAAG;AAC/D,kBAAMC,IAAmBD;AACzB,YAAAD,EAAI,SAASE,GACbF,EAAI,WAAW;AAAA,UACjB;AACA,iBAAOA;AAAA,QACT;AAAA,QACA,EAAE,OAAO,GAAG,UAAU,GAAA;AAAA,MAAM;AAE9B,MAAID,EAAY,YACdF,EAAKH,EAAE,GAAG,IAAIK,EAAY,OAC1BD,EAAQJ,EAAE,GAAG,IAAI,EAAE,UAAU,GAAA,MAE7BG,EAAKH,EAAE,GAAG,IAAI,MACdI,EAAQJ,EAAE,GAAG,IAAI,EAAE,UAAU,GAAA;AAAA,IAEjC;AAAA,EACF,CAAC;AAED,QAAMS,IAAaN,EAAK,YAAe;AACvC,MAAIM,KAAc,MAAM;AACtB,UAAMC,IAAcP,EAAK,kBAAqB;AAC9C,QAAIO,KAAe,QAAQA,IAAc;AACvC,MAAAP,EAAK,WAAeM,IAAaC,IAAe;AAAA,SAC3C;AACL,YAAMC,IAAkBR,EAAK,iBAAoB;AACjD,MAAIQ,KAAmB,QAAQA,MAAoB,MACjDR,EAAK,WAAeM,KAAcE,IAAkBF,KAAe;AAAA,IAEvE;AAAA,EACF;AAEA,QAAMG,IAAoB,OAAO,SAAST,EAAK,YAAe,GAAG,IAAIA,EAAK,WAAc;AACxF,MAAIU,IAAyB,IACzBC,IAAwB;AAyC5B,MAvCIF,KAAqB,SACvBC,IAAyB,GAAGE,EAAaH,CAAiB,CAAC,MACvDA,IAAoB,IACtBE,IAAwB,aACfF,IAAoB,MAC7BE,IAAwB,cAI5Bf,KAAQ,2BACRR,EAAK,QAAQ,CAACS,GAAGgB,MAAQ;AACvB,UAAMf,IAAaD,EAAE,UAAU,UAAU,yBAAyB;AAClE,QAAIgB,MAAQ,GAAG;AACb,MAAAjB,KAAQ,MAAME,CAAU;AACxB;AAAA,IACF;AAEA,QAAIE,EAAKH,EAAE,GAAG,KAAK,MAAM;AACvB,UAAIiB,IAAkB;AACtB,MAAIjB,EAAE,QAAQ,cAAca,MAC1BI,IAAkB,mBAAmBnB,EAAgBe,CAAsB,CAAC,qBAAqBf,EAAgBgB,CAAqB,CAAC,MAEzIf,KAAQ,MAAME,CAAU,GAAGgB,CAAe,IAAIpD,EAAYmC,EAAE,KAAKG,EAAKH,EAAE,GAAG,GAAG,QAAWI,EAAQJ,EAAE,GAAG,CAAC,CAAC;AACxG;AAAA,IACF;AAEA,QAAIA,EAAE,QAAQ,cAAcG,EAAK,YAAe,MAAM;AACpD,MAAAJ,KAAQ,MAAME,CAAU,IAAIpC,EAAY,YAAYsC,EAAK,UAAa,QAAWC,EAAQJ,EAAE,GAAG,CAAC,CAAC;AAChG;AAAA,IACF;AAEA,UAAMkB,IAAkBd,EAAQJ,EAAE,GAAG,KAAK,EAAE,UAAU,GAAA;AACtD,IAAAD,KAAQ,MAAME,CAAU,IAAIpC,EAAYmC,EAAE,KAAK,MAAM,QAAWkB,CAAe,CAAC;AAAA,EAClF,CAAC,GACDnB,KAAQ,SAERA,KAAQ,oBAGJL;AACF,QAAI;AACF,YAAMyB,IAAM,SAAS,cAAc,UAAU;AAC7C,MAAAA,EAAI,YAAYpB,EAAK,KAAA;AACrB,YAAMqB,IAAQD,EAAI,QAAQ,cAAgC,OAAO;AACjE,UAAIC;AACF,eAAAA,EAAM,UAAU,IAAI,gBAAgB,GAChCxB,MACFwB,EAAM,QAAQ,cAAcxB,GAC5BwB,EAAM,QAAQ,aAAavB,IAEtBuB,EAAM;AAAA,IAEjB,SAASC,GAAG;AACV,cAAQ,KAAK,kDAAkDA,CAAC;AAAA,IAClE;AAGF,SAAOtB;AACT;AAEO,SAASuB,GAAiBC,GAAqBC,GAA8B;AAClF,QAAMC,IAAa,SAAS,cAAc,KAAK;AAC/C,SAAAA,EAAW,YAAY,eAEvBA,EAAW,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6BAOIF,CAAW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wCAOAC,CAAI;AAAA,KAGnCC;AACT;AAGO,SAASV,EAAahD,GAAeS,IAAU,GAAGC,IAAU,GAAW;AAE5E,UADgB,OAAO,MAAMV,CAAK,IAAI,IAAIA,GAC3B,eAAe,SAAS;AAAA,IACrC,uBAAuBS;AAAA,IACvB,uBAAuBC;AAAA,EAAA,CACxB;AACH;AAEO,SAASiD,GAAW3D,GAAuB;AAChD,QAAMW,IAAM,OAAO,MAAMX,CAAK,IAAI,IAAIA;AAEtC,SAAO,gBADKN,GAAoBiB,GAAK,CAAC,CACZ,KAAKqC,EAAarC,CAAG,CAAC;AAClD;AAEO,SAASiD,GAAc5D,GAAuB;AACnD,QAAMW,IAAM,OAAO,MAAMX,CAAK,IAAI,IAAIA;AAEtC,SAAO,gBADKN,GAAoBiB,GAAK,CAAC,CACZ,KAAKqC,EAAarC,CAAG,CAAC;AAClD;AAoBO,SAASkD,GACdC,GACA/D,GACAgE,IAAqB,OACrBC,IAAc,IACS;AACvB,MAAI,CAACF;AACH,WAAO,CAAA;AAET,QAAMG,IAAQH,EAAQ,cAAc,OAAO;AAC3C,MAAI,CAACG;AACH,WAAO,CAAA;AAGT,QAAMC,IAASD,EAAM,cAAmC,eAAe,GACjE1C,IAAO,MACV,KAAK0C,EAAM,iBAAsC,IAAI,CAAC,EACtD,OAAO,CAAA9B,MAAKA,MAAM+B,CAAM;AAG3B,MAAIC,IAAS;AACb,MAAIH,GAAa;AASf,UAAMI,IARiC;AAAA,MACrC,MAAM;AAAA,MACN,kBAAkB;AAAA,MAClB,gBAAgB;AAAA,MAChB,eAAe;AAAA,MACf,UAAU;AAAA,MACV,UAAU;AAAA,IAAA,EAEarE,CAAG;AAC5B,IAAI,OAAOqE,KAAc,aACvBD,IAASC;AAAA,EAEb,OAAO;AAEL,UAAMC,IAAM,MAAM,KAAKP,EAAQ,iBAAuC,UAAU,CAAC;AACjF,aAASQ,IAAI,GAAGA,IAAID,EAAI,QAAQC;AAC9B,UAAID,EAAIC,CAAC,EAAE,aAAa,eAAe,MAAMvE,GAAK;AAChD,QAAAoE,IAASG;AACT;AAAA,MACF;AAAA,EAEJ;AACA,MAAIH,IAAS;AACX,WAAO5C;AAGT,QAAMnB,IAAW,CAACmE,MAAwB;AACxC,UAAMjE,IAAUiE,EACb,QAAQ,WAAW,GAAG,EACtB,QAAQ,SAAS,EAAE,EACnB,QAAQ,OAAO,EAAE,EACjB,QAAQ,MAAM,GAAG,EACjB,QAAQ,YAAY,EAAE,EACtB,KAAA;AACH,QAAI,CAACjE,EAAS,QAAO;AACrB,UAAMK,IAAM,WAAWL,CAAO;AAC9B,WAAO,OAAO,SAASK,CAAG,IAAIA,IAAM;AAAA,EACtC;AAEA,EAAAY,EAAK,KAAK,CAACiD,GAAGC,MAAM;AAClB,UAAMC,IAAQF,EAAE,MAAM,KAAKL,CAAM,GAC3BQ,IAAQF,EAAE,MAAM,KAAKN,CAAM,GAC3BS,MAAQF,KAAA,gBAAAA,EAAO,gBAAe,IAAI,KAAA,GAClCG,MAAQF,KAAA,gBAAAA,EAAO,gBAAe,IAAI,KAAA,GAElCG,IAAO1E,EAASwE,CAAI,GACpBG,IAAO3E,EAASyE,CAAI;AAE1B,QAAIG;AACJ,UAAMC,IAAoB,QAAQ,KAAKL,CAAI,KAAK,QAAQ,KAAKC,CAAI;AACjE,WAAI,CAAC,OAAO,MAAMC,CAAI,KAAK,CAAC,OAAO,MAAMC,CAAI,KAAKE,IAChDD,IAAMF,IAAOC,IAEbC,IAAMJ,EAAK,cAAcC,GAAM,MAAM,EAAE,aAAa,QAAQ,GAEvDd,MAAQ,QAAQiB,IAAM,CAACA;AAAA,EAChC,CAAC,GAGDzD,EAAK,QAAQ,CAAAY,MAAK8B,EAAM,YAAY9B,CAAC,CAAC,GAClC+B,KAAQD,EAAM,YAAYC,CAAM,GAGpCJ,EAAQ,iBAAiB,sBAAsB,EAAE,QAAQ,CAAAoB,MAAM;AAC7D,IAAAA,EAAG,UAAU,OAAO,eAAe,WAAW,UAAU;AAAA,EAC1D,CAAC;AACD,QAAMC,IAAWrB,EAAQ,cAA2B,2BAA2B/D,CAAG,IAAI;AACtF,SAAIoF,KACFA,EAAS,UAAU,IAAI,eAAepB,MAAQ,QAAQ,YAAY,UAAU,GAGvExC;AACT;ACneA,SAAS6D,GAASpF,GAAwC;AACxD,SAAO,OAAOA,KAAU,YAAYA,MAAU;AAChD;AAEA,SAASqF,EAAcrF,GAA+B;AACpD,SAAO,OAAOA,KAAU,WAAWA,IAAQ;AAC7C;AAEA,SAASsF,GAAiBtF,GAA+B;AACvD,SAAOA,MAAU,OAAO,OAAOqF,EAAcrF,CAAK;AACpD;AAEA,SAASuF,EAAevF,GAA+B;AACrD,MAAI,OAAOA,KAAU;AACnB,WAAO,OAAO,SAASA,CAAK,IAAIA,IAAQ;AAE1C,MAAI,OAAOA,KAAU,UAAU;AAC7B,UAAMwF,IAAUxF,EAAM,KAAA;AACtB,QAAIwF,EAAQ,WAAW;AACrB,aAAO;AAET,UAAMC,IAAa,OAAOD,EAAQ,QAAQ,KAAK,GAAG,CAAC;AACnD,WAAO,OAAO,SAASC,CAAU,IAAIA,IAAa;AAAA,EACpD;AACA,SAAO;AACT;AAEA,SAASC,GAAU1F,GAA+B;AAChD,QAAMkB,IAAUqE,EAAevF,CAAK;AACpC,MAAIkB,KAAW;AACb,WAAO;AAET,QAAMyE,IAAY,KAAK,MAAMzE,CAAO;AACpC,SAAO,OAAO,SAASyE,CAAS,IAAIA,IAAY;AAClD;AAEA,SAASC,GAAY5F,GAAgD;AACnE,SAAOoF,GAASpF,CAAK,IAAI,EAAE,GAAGA,MAAU;AAC1C;AAEA,SAAS6F,GAAqB7F,GAA0C;AACtE,SAAOoF,GAASpF,CAAK,IAAI,EAAE,GAAGA,MAAU;AAC1C;AAEA,SAAS8F,GAAY9F,GAAqC;AACxD,SAAO,OAAOA,KAAU,YAAYA,IAAQ;AAC9C;AAEO,SAAS+F,GAA2B/F,GAAkD;AAC3F,MAAI,CAACoF,GAASpF,CAAK;AACjB,WAAO;AAGT,QAAMgG,IAAOX,EAAcrF,EAAM,IAAI,GAC/BiG,IAAeZ,EAAcrF,EAAM,aAAa,GAChDkG,IAAcX,EAAevF,EAAM,YAAY;AAErD,MAAI,CAACgG,KAAQ,CAACC,KAAgBC,KAAe;AAC3C,WAAO;AAGT,QAAMC,IAAUnG,EAAM,YAAY,OAAO,OAAOuF,EAAevF,EAAM,OAAO,GAEtEoG,IAAsC;AAAA,IAC1C,MAAMf,EAAcrF,EAAM,IAAI,KAAK;AAAA,IACnC,MAAAgG;AAAA,IACA,eAAeC;AAAA,IACf,cAAcC;AAAA,IACd,SAASC,KAAW;AAAA,EAAA,GAGhBE,IAASd,EAAevF,EAAM,OAAO;AAC3C,EAAIqG,KAAU,SACZD,EAAS,UAAUC;AAErB,QAAMC,IAAejB,EAAcrF,EAAM,cAAc;AACvD,EAAIsG,MACFF,EAAS,iBAAiBE;AAE5B,QAAMC,IAAkBlB,EAAcrF,EAAM,iBAAiB;AAC7D,EAAIuG,MACFH,EAAS,oBAAoBG;AAG/B,QAAMC,IAAgBjB,EAAevF,EAAM,cAAc;AACzD,EAAIwG,KAAiB,SACnBJ,EAAS,iBAAiBI;AAE5B,QAAMC,IAAapB,EAAcrF,EAAM,UAAU;AACjD,EAAIyG,MACFL,EAAS,aAAaK;AAExB,QAAMC,IAAgBpB,GAAiBtF,EAAM,eAAe;AAC5D,EAAI0G,MAAkB,SACpBN,EAAS,kBAAkBM;AAG7B,QAAMC,IAAgBb,GAAY9F,EAAM,cAAc;AACtD,SAAI,OAAO2G,KAAkB,cAC3BP,EAAS,iBAAiBO,IAGrBP;AACT;AAEO,SAASQ,GAA4B5G,GAA6C;AACvF,MAAI,CAAC,MAAM,QAAQA,CAAK;AACtB,WAAO,CAAA;AAET,QAAM6G,IAAyC,CAAA;AAC/C,aAAWC,KAAS9G,GAAO;AACzB,UAAMoG,IAAWL,GAA2Be,CAAK;AACjD,IAAIV,KACFS,EAAU,KAAKT,CAAQ;AAAA,EAE3B;AACA,SAAOS;AACT;AAEO,SAASE,GAA4B/G,GAAmD;AAC7F,MAAI,CAACoF,GAASpF,CAAK;AACjB,WAAO;AAET,QAAMgH,IAAiBhH,EAAM,aACvBiH,IAAe5B,EAAcrF,EAAM,aAAa,GAChDgG,IAAOX,EAAcrF,EAAM,IAAI,GAC/BkH,IAAkB3B,EAAevF,EAAM,gBAAgB,GACvDmH,IACJ5B,EAAevF,EAAM,kBAAkB,MACtCoF,GAAS4B,CAAc,IACpBzB,EAAeyB,EAAe,kBAAkB,KAChDzB,EAAeyB,EAAe,sBAAsB,KACpDzB,EAAeyB,EAAe,sBAAsB,IACpD,SACJzB,EAAevF,EAAM,cAAc,GAC/BoH,IAAe7B,EAAevF,EAAM,aAAa;AAEvD,MAAI,CAACiH,KAAgB,CAACjB,KAAQkB,KAAmB,QAAQC,KAAiB,QAAQC,KAAgB;AAChG,WAAO;AAGT,QAAMhB,IAAuC;AAAA,IAC3C,gBAAgBf,EAAcrF,EAAM,cAAc,KAAK;AAAA,IACvD,eAAeiH;AAAA,IACf,MAAAjB;AAAA,IACA,eAAeX,EAAcrF,EAAM,aAAa;AAAA,IAChD,kBAAkBkH;AAAA,IAClB,gBAAgBC;AAAA,IAChB,eAAeC;AAAA,IACf,cAAcxB,GAAY5F,EAAM,YAAY;AAAA,IAC5C,aAAa4F,GAAY5F,EAAM,WAAW;AAAA,IAC1C,aAAa4F,GAAY5F,EAAM,WAAW;AAAA,IAC1C,YAAY6F,GAAqB7F,EAAM,UAAU;AAAA,EAAA,GAG7CwG,IAAgBjB,EAAevF,EAAM,cAAc;AACzD,EAAIwG,KAAiB,SACnBJ,EAAS,iBAAiBI;AAE5B,QAAMC,IAAapB,EAAcrF,EAAM,UAAU;AACjD,EAAIyG,MACFL,EAAS,aAAaK;AAExB,QAAMC,IAAgBpB,GAAiBtF,EAAM,eAAe;AAC5D,EAAI0G,MAAkB,SACpBN,EAAS,kBAAkBM;AAG7B,QAAMW,IAAkB9B,EAAevF,EAAM,iBAAiB;AAC9D,EAAIqH,KAAmB,SACrBjB,EAAS,oBAAoBiB;AAE/B,QAAMC,IAAe/B,EAAevF,EAAM,cAAc;AACxD,EAAIsH,KAAgB,SAClBlB,EAAS,iBAAiBkB;AAE5B,QAAMC,IAAkBhC,EAAevF,EAAM,iBAAiB;AAC9D,EAAIuH,KAAmB,SACrBnB,EAAS,oBAAoBmB;AAE/B,QAAMC,IAAejC,EAAevF,EAAM,cAAc;AACxD,SAAIwH,KAAgB,SAClBpB,EAAS,iBAAiBoB,IAGrBpB;AACT;AAEO,SAASqB,GAA6BzH,GAA8C;AACzF,MAAI,CAAC,MAAM,QAAQA,CAAK;AACtB,WAAO,CAAA;AAET,QAAM6G,IAA0C,CAAA;AAChD,aAAWC,KAAS9G,GAAO;AACzB,UAAMoG,IAAWW,GAA4BD,CAAK;AAClD,IAAIV,KACFS,EAAU,KAAKT,CAAQ;AAAA,EAE3B;AACA,SAAOS;AACT;AAEO,SAASa,GAA6B1H,GAAoD;AAC/F,MAAI,CAACoF,GAASpF,CAAK;AACjB,WAAO;AAGT,QAAMgG,IAAOX,EAAcrF,EAAM,IAAI,GAC/BoH,IAAe7B,EAAevF,EAAM,iBAAiBA,EAAM,KAAK;AAEtE,MAAI,CAACgG,KAAQoB,KAAgB;AAC3B,WAAO;AAMT,QAAMD,IAHmB5B;AAAAA,IACvBvF,EAAM,gBAAgBA,EAAM,sBAAsBA,EAAM,kBAAkBA,EAAM;AAAA,EAAA,KAExC,GAEpCoG,IAAwC;AAAA,IAC5C,MAAMf,EAAcrF,EAAM,IAAI,KAAK;AAAA,IACnC,MAAAgG;AAAA,IACA,eAAeoB;AAAA,IACf,gBAAgBD;AAAA,IAChB,cAAcA;AAAA,IACd,gBAAgBzB,GAAU1F,EAAM,kBAAkBA,EAAM,KAAK,KAAK;AAAA,IAClE,yBAAyB0F,GAAU1F,EAAM,uBAAuB,KAAK;AAAA,IACrE,mBAAmB8F,GAAY9F,EAAM,iBAAiB;AAAA,IACtD,aAAa4F,GAAY5F,EAAM,WAAW;AAAA,IAC1C,gBAAgBuF,EAAevF,EAAM,cAAc,KAAK;AAAA,IACxD,YAAYqF,EAAcrF,EAAM,UAAU,KAAK;AAAA,IAC/C,iBAAiBsF,GAAiBtF,EAAM,eAAe,KAAK;AAAA,IAC5D,YAAY6F,GAAqB7F,EAAM,UAAU;AAAA,EAAA;AAGnD,SAAI,MAAM,QAAQA,EAAM,SAAS,MAC/BoG,EAAS,YAAYqB,GAA6BzH,EAAM,SAAS,IAG5DoG;AACT;AAEO,SAASuB,GAA8B3H,GAA+C;AAC3F,MAAI,CAAC,MAAM,QAAQA,CAAK;AACtB,WAAO,CAAA;AAET,QAAM6G,IAA2C,CAAA;AACjD,aAAWC,KAAS9G,GAAO;AACzB,UAAMoG,IAAWsB,GAA6BZ,CAAK;AACnD,IAAIV,KACFS,EAAU,KAAKT,CAAQ;AAAA,EAE3B;AACA,SAAOS;AACT;AAEO,SAASe,GAAqC5H,GAAkD;AACrG,MAAI,CAACoF,GAASpF,CAAK;AACjB,WAAO;AAET,QAAM6H,IAAsC,EAAE,GAAG7H,EAAA,GAC3C0G,IAAgBpB,GAAiBtF,EAAM,eAAe;AAC5D,EAAI0G,MAAkB,OACpBmB,EAAS,kBAAkBnB,IAE3B,OAAOmB,EAAS;AAElB,QAAMrB,IAAgBjB,EAAevF,EAAM,cAAc;AACzD,EAAIwG,KAAiB,OACnBqB,EAAS,iBAAiBrB,IAE1B,OAAOqB,EAAS;AAElB,QAAMpB,IAAapB,EAAcrF,EAAM,UAAU;AACjD,EAAIyG,IACFoB,EAAS,aAAapB,IAEtB,OAAOoB,EAAS;AAElB,QAAMC,IAAczC,EAAcrF,EAAM,gBAAgBA,EAAM,qBAAqB;AACnF,SAAI8H,IACFD,EAAS,eAAeC,IAExB,OAAOD,EAAS,cAEXA;AACT;AAEO,SAASE,GACd/H,GACiC;AACjC,MAAI,CAACoF,GAASpF,CAAK;AACjB,WAAO;AAET,QAAMgI,IAAwC,EAAE,GAAGhI,EAAA,GAC7CiI,IAAoBL,GAAqC5H,EAAM,kBAAkB;AACvF,SAAIiI,IACFD,EAAY,qBAAqBC,IACxB,wBAAwBD,KACjC,OAAOA,EAAY,oBAEdA;AACT;AAEO,SAASE,GAAuClI,GAAoD;AACzG,MAAI,CAACoF,GAASpF,CAAK;AACjB,WAAO;AAGT,QAAM8H,IAAczC,EAAcrF,EAAM,YAAY;AACpD,MAAI,CAAC8H;AACH,WAAO;AAET,QAAMpB,IAAgBpB,GAAiBtF,EAAM,eAAe,GAEtDmI,IAAWvB,GAA4B5G,EAAM,QAAQ,GACrDoI,IAAaT,GAA8B3H,EAAM,UAAU,GAC3DgI,IAAcD,GAAoC/H,EAAM,WAAW,GAEnEoG,IAAwC;AAAA,IAC5C,cAAc0B;AAAA,IACd,iBAAiBpB;AAAA,IACjB,UAAAyB;AAAA,IACA,YAAAC;AAAA,EAAA;AAEF,SAAIJ,MACF5B,EAAS,cAAc4B,IAElB5B;AACT;AC5TA,SAASiC,GAAerI,GAA+B;AACrD,SAAO,OAAOA,KAAU,WAAWA,IAAQ;AAC7C;AAMA,SAASsI,GAAgBtI,GAA2C;AAClE,MAAI,OAAOA,KAAU;AACnB,WAAOA;AAET,MAAIA,MAAU;AACZ,WAAO;AAGX;AAEA,SAASuI,GAA0BvI,GAAoC;AACrE,MAAI,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK;AACpD,WAAOA;AAGX;AAEA,SAASwI,GAAcxI,GAAkCyI,GAAuB;AAC9E,MAAI,OAAOzI,KAAU;AACnB,WAAOA;AAET,QAAM,IAAI,MAAM,0CAA0CyI,CAAK,EAAE;AACnE;AAEA,SAASC,GAAc1I,GAAkCyI,GAAuB;AAC9E,MAAI,OAAOzI,KAAU,YAAY,OAAO,SAASA,CAAK;AACpD,WAAOA;AAET,QAAM,IAAI,MAAM,0CAA0CyI,CAAK,EAAE;AACnE;AAEA,SAASE,GAA4BvC,GAAyD;AAC5F,QAAMa,IAAeuB,GAAcpC,EAAS,eAAe,eAAe,GACpEJ,IAAOwC,GAAcpC,EAAS,MAAM,MAAM,GAC1Cc,IAAkBwB,GAActC,EAAS,kBAAkB,kBAAkB,GAC7Ee,IAAgBuB,GAActC,EAAS,gBAAgB,gBAAgB,GACvEgB,IAAesB,GAActC,EAAS,eAAe,eAAe,GAEpEwC,IAA8B;AAAA,IAClC,eAAe3B;AAAA,IACf,MAAAjB;AAAA,IACA,kBAAkBkB;AAAA,IAClB,gBAAgBC;AAAA,IAChB,eAAeC;AAAA,IACf,cAAehB,EAAS,gBAA0D;AAAA,IAClF,aAAcA,EAAS,eAAgE;AAAA,IACvF,aAAcA,EAAS,eAAiE;AAAA,EAAA;AAG1F,SAAIA,EAAS,kBAAkB,WAC7BwC,EAAS,gBAAgBxC,EAAS,gBAEhCA,EAAS,kBAAkB,SAC7BwC,EAAS,iBAAiBxC,EAAS,iBAEjCA,EAAS,eACXwC,EAAS,aAAaxC,EAAS,aAE7BA,EAAS,oBAAoB,WAC/BwC,EAAS,kBAAkBxC,EAAS,kBAElCA,EAAS,qBAAqB,SAChCwC,EAAS,oBAAoBxC,EAAS,oBAEpCA,EAAS,kBAAkB,SAC7BwC,EAAS,iBAAiBxC,EAAS,iBAEjCA,EAAS,qBAAqB,SAChCwC,EAAS,oBAAoBxC,EAAS,oBAEpCA,EAAS,kBAAkB,SAC7BwC,EAAS,iBAAiBxC,EAAS,iBAEjCA,EAAS,eACXwC,EAAS,aAAaxC,EAAS,aAE7BA,EAAS,mBACXwC,EAAS,iBAAiBxC,EAAS,iBAG9BwC;AACT;AA6JA,SAASC,GACPC,GACAC,GACoB;AHhRtB,MAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC;AGiRE,MAAIC,MACFR,IAAAD,KAAA,gBAAAA,EAAa,WAAb,gBAAAC,EAAqB,cACrBD,KAAA,gBAAAA,EAAa,eACbI,KAAAD,KAAAD,IAAAF,KAAA,gBAAAA,EAAa,WAAb,gBAAAE,EAAqB,kBAArB,gBAAAC,EAAoC,WAApC,gBAAAC,EAA4C,aAC5C;AAEF,MAAI,CAACK,MAAWV,KAAA,QAAAA,EAAM,SAAQ;AAC5B,UAAMW,IAASX,EAAK,QACdtG,IACHiH,EAAO,YACPA,EAAO,aACP,OAAO,OAAOA,CAAM,EAAE;AAAA,MACrB,CAAAC,OAAUA,KAAA,gBAAAA,EAAuC,uBAAsB;AAAA,IAAA;AAG3E,IAAAF,MACEJ,IAAA5G,KAAA,gBAAAA,EAAW,WAAX,gBAAA4G,EAAmB,cACnB5G,KAAA,gBAAAA,EAAW,eACX+G,KAAAD,KAAAD,IAAA7G,KAAA,gBAAAA,EAAW,WAAX,gBAAA6G,EAAmB,kBAAnB,gBAAAC,EAAkC,WAAlC,gBAAAC,EAA0C,aAC1C;AAAA,EACJ;AAEA,SAAOC,KAAW;AACpB;AAGO,SAASG,GACdb,GACAC,GACoB;AACpB,SAAOF,GAAcC,GAAMC,CAAW;AACxC;AAqCA,eAAsBa,GACpBd,GACAC,GAC2B;AAC3B,MAAI,CAACD;AACH,UAAM,IAAI,MAAM,iCAAiC;AAGnD,QAAMU,IAAUX,GAAcC,GAAMC,CAAW;AAC/C,MAAI,CAACS;AACH,UAAM,IAAI,MAAM,qCAAqC;AAGvD,QAAMK,IAAM,MAAMf,EAAK,WAAW,mBAAkC;AAAA,IAClE,MAAM;AAAA,IACN,UAAUU;AAAA,EAAA,CACX,GAEKrB,IAAWvB,GAA4BiD,EAAI,QAAQ,GACnD5B,IAAoBC,GAAuC2B,EAAI,kBAAkB;AAEvF,SAAO;AAAA,IACL,UAAA1B;AAAA,IACA,oBAAoBF;AAAA,EAAA;AAExB;AAGA,eAAsB6B,GACpBhB,GACAC,GACiB;AACjB,MAAI,CAACD;AACH,UAAM,IAAI,MAAM,uCAAuC;AAGzD,QAAMU,IAAUX,GAAcC,GAAMC,CAAW;AAC/C,MAAI,CAACS;AACH,UAAM,IAAI,MAAM,2CAA2C;AAG7D,QAAMO,IAAW,MAAMjB,EAAK,WAAW,mBAErC;AAAA,IACA,MAAM;AAAA,IACN,UAAUU;AAAA,EAAA,CACX;AAED,MAAI,OAAOO,KAAa;AACtB,WAAOA;AAGT,QAAMC,IAAiBD,EAAS;AAChC,SAAO,OAAOC,KAAmB,WAAWA,IAAiB;AAC/D;AAGA,eAAsBC,GACpBnB,GACAC,GAC6B;AAC7B,MAAI,CAACD;AACH,UAAM,IAAI,MAAM,mCAAmC;AAGrD,QAAMU,IAAUX,GAAcC,GAAMC,CAAW;AAC/C,MAAI,CAACS;AACH,UAAM,IAAI,MAAM,uCAAuC;AAGzD,QAAMK,IAAM,MAAMf,EAAK,WAAW,mBAAkC;AAAA,IAClE,MAAM;AAAA,IACN,UAAUU;AAAA,EAAA,CACX,GAEKpB,IAAaT,GAA8BkC,EAAI,UAAU,GACzD5B,IAAoBC,GAAuC2B,EAAI,kBAAkB;AAEvF,SAAO;AAAA,IACL,YAAAzB;AAAA,IACA,oBAAoBH;AAAA,EAAA;AAExB;AAGA,eAAsBiC,GACpBpB,GACAC,GACAoB,GACqC;AACrC,MAAI,CAACrB;AACH,UAAM,IAAI,MAAM,2CAA2C;AAG7D,QAAMU,IAAUX,GAAcC,GAAMC,CAAW;AAC/C,MAAI,CAACS;AACH,UAAM,IAAI,MAAM,+CAA+C;AAGjE,MAAI,CAACW;AACH,UAAM,IAAI,MAAM,qDAAqD;AAGvE,QAAMN,IAAM,MAAMf,EAAK,WAAW,mBAAkC;AAAA,IAClE,MAAM;AAAA,IACN,UAAUU;AAAA,IACV,gBAAgBW;AAAA,EAAA,CACjB,GAGKC,IADsB3C,GAA6BoC,EAAI,SAAS,EAChC,IAAIlB,EAA2B,GAE/D0B,IAAwBzC,GAAqCiC,EAAI,kBAAkB,GAEnFE,IAAuC;AAAA,IAC3C,gBAAgB1B,GAAewB,EAAI,cAAc,KAAKM;AAAA,IACtD,WAAAC;AAAA,EAAA;AAGF,EAAI,OAAOP,EAAI,SAAU,aACvBE,EAAS,QAAQF,EAAI;AAEvB,QAAMrD,IAAgB+B,GAA0BsB,EAAI,cAAc;AAClE,EAAIrD,MAAkB,WACpBuD,EAAS,iBAAiBvD;AAE5B,QAAMC,IAAa4B,GAAewB,EAAI,UAAU;AAChD,EAAIpD,MACFsD,EAAS,aAAatD;AAExB,QAAMC,IAAgB4B,GAAgBuB,EAAI,eAAe;AACzD,SAAInD,MAAkB,WACpBqD,EAAS,kBAAkBrD,IAEzB2D,MACFN,EAAS,qBAAqBM,IAGzBN;AACT;AAGA,eAAsBO,GACpBxB,GACAC,GACA9B,GACmC;AACnC,MAAI,CAAC6B;AACH,UAAM,IAAI,MAAM,yCAAyC;AAG3D,QAAMU,IAAUX,GAAcC,GAAMC,CAAW;AAC/C,MAAI,CAACS;AACH,UAAM,IAAI,MAAM,6CAA6C;AAG/D,MAAI,CAACvC;AACH,UAAM,IAAI,MAAM,iDAAiD;AAGnE,SAAO6B,EAAK,WAAW,mBAA6C;AAAA,IAClE,MAAM;AAAA,IACN,UAAUU;AAAA,IACV,eAAevC;AAAA,EAAA,CAChB;AACH;AAGA,eAAsBsD,GACpBzB,GACAC,GACA9B,GACAvF,IAAqD,CAAA,GACnB;AAClC,MAAI,CAACoH;AACH,UAAM,IAAI,MAAM,wCAAwC;AAG1D,QAAMU,IAAUX,GAAcC,GAAMC,CAAW;AAC/C,MAAI,CAACS;AACH,UAAM,IAAI,MAAM,4CAA4C;AAG9D,MAAI,CAACvC;AACH,UAAM,IAAI,MAAM,gDAAgD;AAGlE,QAAMuD,IAAyC;AAAA,IAC7C,MAAM;AAAA,IACN,UAAUhB;AAAA,IACV,eAAevC;AAAA,EAAA,GAGX,EAAE,WAAAwD,GAAW,SAAAC,GAAS,YAAYC,GAAc,UAAUC,MAC9DlJ,KAAW,CAAA,GAEPmJ,IAAgBJ,KAAaE;AACnC,EAAmCE,KAAkB,SACnDL,EAAQ,aAAaK;AAGvB,QAAMC,IAAcJ,KAAWE;AAC/B,SAAiCE,KAAgB,SAC/CN,EAAQ,WAAWM,IAGdhC,EAAK,WAAW,mBAA4C0B,CAAO;AAC5E;AC7gBA,MAAMO,yBAAwB,IAAA,GACxBC,yBAAiB,IAAA,GACjBC,KAAmD,CAAA,GAInDC,KAAqD;AAAA,EACzD;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEA,SAASC,GACPpL,GACAqL,GACM;AACN,EAAI,OAAOA,KAAW,eACpBH,GAAgBlL,CAAG,IAAIqL;AAE3B;AAgBO,SAASC,KAAgE;AAC9E,SAAON;AACT;AAgBO,SAASO,KAAoD;AAClE,SAAON;AACT;AAEO,SAASO,GAAwBC,GAAuC;AAC7E,aAAWzL,KAAOmL;AAChB,IAAAC,GAAkBpL,GAAKyL,EAAQzL,CAAG,CAAC;AAEvC;AAEO,SAAS0L,KAAuD;AACrE,SAAOR;AACT;AC5FA,MAAMS,KAAmB;AAOlB,SAASC,GAAiB3L,GAA+B;ALLhE,MAAAgJ;AKME,MAAI,OAAOhJ,KAAU;AACnB,WAAO,OAAO,SAASA,CAAK,IAAIA,IAAQ;AAG1C,MAAI,OAAOA,KAAU,UAAU;AAC7B,UAAMwF,IAAUxF,EAAM,KAAA,EAAO,QAAQ,WAAW,EAAE;AAClD,QAAI,CAACwF;AACH,aAAO;AAGT,UAAMoG,IAAS,OAAOpG,CAAO;AAC7B,QAAI,OAAO,SAASoG,CAAM;AACxB,aAAOA;AAGT,UAAMC,IAAWrG,EAAQ,QAAQ,eAAe,EAAE;AAClD,QAAI,CAACqG;AACH,aAAO;AAGT,UAAMC,IAAYD,EAAS,YAAY,GAAG,GACpCE,IAAUF,EAAS,YAAY,GAAG;AACxC,QAAIpG,IAAaoG;AAEjB,UAAMG,IAAWF,MAAc,IACzBG,IAASF,MAAY;AAE3B,QAAIC,MAAa,CAACC,KAAUH,IAAYC;AACtC,UAAKE;AAiBH,QAAAxG,IAAaA,EAAW,QAAQ,OAAO,EAAE,EAAE,QAAQ,KAAK,GAAG;AAAA,WAjBhD;AACX,cAAMyG,IAAczG,EAAW,MAAM,GAAG,GAClC0G,MAAgBnD,IAAAkD,EAAYA,EAAY,SAAS,CAAC,MAAlC,gBAAAlD,EAAqC,WAAU,GAC/DoD,IAAcF,EAAY,MAAM,GAAG,EAAE,EAAE,KAAK,EAAE,GAC9CG,IAAgBD,EAAY,QAAQ,SAAS,EAAE,EAAE,QACjDE,IAAiBJ,EAAY,SAAS,GACtCK,IAAgB,WAAW,KAAKH,CAAW;AAOjD,QAAA3G,IAJE6G,KACAH,MAAkB,KACjBA,MAAkB,KAAKE,IAAgB,KAAKA,KAAiB,KAAK,CAACE,IAGlE9G,EAAW,QAAQ,MAAM,EAAE,IAC3BA,EAAW,QAAQ,KAAK,GAAG;AAAA,MACjC;AAAA,QAGF,CAAWwG,KAAUD,KAAYD,IAAUD,IACzCrG,IAAaA,EAAW,QAAQ,MAAM,EAAE,IAC/BwG,KACQxG,EAAW,SAASsG,IAAU,MAC9B,KAAK,SAAS,KAAKtG,EAAW,QAAQ,OAAO,EAAE,CAAC,MAC/DA,IAAaA,EAAW,QAAQ,OAAO,EAAE;AAI7C,QAAIA,MAAe,OAAOA,MAAe;AACvC,aAAO;AAGT,UAAM+G,IAAY,OAAO,WAAW/G,CAAU;AAC9C,QAAI,OAAO,SAAS+G,CAAS;AAC3B,aAAOA;AAGT,UAAMC,IAAU,OAAO,WAAWZ,EAAS,QAAQ,KAAK,GAAG,CAAC;AAC5D,QAAI,OAAO,SAASY,CAAO;AACzB,aAAOA;AAAA,EAEX;AAEA,SAAO;AACT;AAEO,SAASC,GACd1M,GACA,EAAE,UAAAJ,IAAW8L,IAAkB,UAAAiB,IAAW,KAAA,IAA+B,IAC1D;AACf,QAAMzL,IAAUyK,GAAiB3L,CAAK;AACtC,MAAIkB,KAAW;AACb,WAAOyL,KAAY;AAGrB,QAAMC,IAAS,MAAMhN,GACfiN,IAAU,KAAK,MAAM3L,IAAU0L,CAAM,IAAIA;AAC/C,SAAI,OAAO,GAAGC,GAAS,EAAE,IAChB,IAGFA;AACT;AAEO,SAASC,GACd9M,GACA0B,IAAgC,IACjB;AACf,SAAOgL,GAAc1M,GAAO0B,CAAO;AACrC;AAEO,SAASqL,GACd/M,GACA0B,IAAgC,IACjB;AACf,SAAOgL,GAAc1M,GAAO0B,CAAO;AACrC;AC3GA,MAAMsL,KAAyB,mDAEzBzH,IAAiB,CAACvF,MAAkC;AACxD,MAAI,OAAOA,KAAU;AACnB,WAAO,OAAO,SAASA,CAAK,IAAIA,IAAQ;AAG1C,MAAI,OAAOA,KAAU,UAAU;AAC7B,UAAMwF,IAAUxF,EAAM,KAAA;AAKtB,QAJI,CAACwF,KAID,CAACwH,GAAuB,KAAKxH,CAAO;AACtC,aAAO;AAGT,UAAMjF,IAAS,OAAOiF,CAAO;AAC7B,QAAI,OAAO,SAASjF,CAAM;AACxB,aAAOA;AAAA,EAEX;AAEA,SAAO;AACT,GAEM0M,KAAmB,CAACjN,MAAkC;AAC1D,MAAI,OAAOA,KAAU;AACnB,WAAO;AAET,QAAMwF,IAAUxF,EAAM,KAAA;AACtB,SAAOwF,KAAoB;AAC7B;AAEA,SAAS0H,GAA0BrD,GAAkD;AACnF,QAAMrH,IAAYqH,KAAO,OAAOA,KAAQ,WAAYA,IAAkC;AACtF,MAAI,CAACrH;AACH,WAAO;AAGT,QAAM2K,IAAoB5H,EAAe/C,EAAU,mBAAmB,GAChE4K,IAAiB7H,EAAe/C,EAAU,gBAAgB,GAC1D6K,IAAY9H,EAAe/C,EAAU,UAAU;AAErD,MAAI2K,KAAqB,QAAQC,KAAkB,QAAQC,KAAa;AACtE,WAAO;AAGT,QAAMC,IAASL,GAAiBzK,EAAU,MAAM,KAAK,WAC/C+K,IAAWhI,EAAe/C,EAAU,cAAc,KAAK;AAE7D,SAAO;AAAA,IACL,qBAAqB2K;AAAA,IACrB,kBAAkBC;AAAA,IAClB,YAAYC;AAAA,IACZ,QAAAC;AAAA,IACA,gBAAgBC;AAAA,EAAA;AAEpB;AAEO,SAASC,GACd3D,GACkC;AAClC,QAAMrH,IAAYqH,KAAO,OAAOA,KAAQ,WAAYA,IAAkC;AACtF,MAAI,CAACrH;AACH,WAAO;AAGT,QAAMiL,IAAUlI,EAAe/C,EAAU,QAAQ,GAC3CkL,IAAUnI,EAAe/C,EAAU,QAAQ,GAC3CmL,IAAiBpI,EAAe/C,EAAU,gBAAgB,GAC1DoL,IAAiBrI,EAAe/C,EAAU,gBAAgB;AAEhE,MAAIiL,KAAW,QAAQC,KAAW,QAAQC,KAAkB,QAAQC,KAAkB;AACpF,WAAO;AAGT,QAAMN,IAASL,GAAiBzK,EAAU,MAAM,KAAK,WAC/C+K,IAAWhI,EAAe/C,EAAU,cAAc,KAAK,MACvDqL,IAAYX,GAA0B1K,EAAU,UAAU;AAEhE,SAAO;AAAA,IACL,UAAUiL;AAAA,IACV,UAAUC;AAAA,IACV,kBAAkBC;AAAA,IAClB,kBAAkBC;AAAA,IAClB,QAAAN;AAAA,IACA,gBAAgBC;AAAA,IAChB,YAAYM;AAAA,EAAA;AAEhB;ACnEA,MAAMC,yBAA8B,IAAA;AAEpC,SAASC,GAAiB/N,GAA+B;AACvD,MAAI,OAAOA,KAAU;AACnB,WAAO;AAET,QAAMwF,IAAUxF,EAAM,KAAA;AACtB,SAAOwF,EAAQ,SAAS,IAAIA,IAAU;AACxC;AAEA,SAASwI,EAAiBhO,GAA+B;AACvD,MAAIA,MAAU;AACZ,WAAO;AAET,QAAMkB,IAAUyK,GAAiB3L,CAAK;AACtC,SAAO,OAAO,SAASkB,KAAW,GAAG,IAAKA,IAAqB;AACjE;AAEA,SAAS+M,GAA0BjO,GAAkD;AACnF,MAAI,CAACA,KAAS,OAAOA,KAAU;AAC7B,WAAO;AAET,QAAMkO,IAASlO;AACf,SACE,OAAOkO,EAAO,iBAAkB,YAChC,OAAOA,EAAO,QAAS,YACvB,OAAOA,EAAO,oBAAqB,YACnC,OAAOA,EAAO,kBAAmB,YACjC,OAAOA,EAAO,iBAAkB;AAEpC;AAEA,SAASC,GAAcvF,GAA4D;AACjF,QAAMwF,IAAiC,EAAE,GAAGxF,EAAA;AAC5C,SAAIA,EAAS,gBAAgB,OAAOA,EAAS,gBAAiB,aAC5DwF,EAAM,eAAe,EAAE,GAAGxF,EAAS,aAAA,IAEjCA,EAAS,eAAe,OAAOA,EAAS,eAAgB,aAC1DwF,EAAM,cAAc,EAAE,GAAGxF,EAAS,YAAA,IAEhCA,EAAS,eAAe,OAAOA,EAAS,eAAgB,aAC1DwF,EAAM,cAAc,EAAE,GAAGxF,EAAS,YAAA,IAEhCA,EAAS,cAAc,OAAOA,EAAS,cAAe,aACxDwF,EAAM,aAAa,EAAE,GAAGxF,EAAS,WAAA,IAE5BwF;AACT;AAEO,SAASC,GACdlE,GACAC,GACM;AACN,MAAI,CAACD;AACH;AAGF,MAAI,CAAC,MAAM,QAAQC,CAAS,GAAG;AAC7B,IAAA0D,GAAwB,OAAO3D,CAAa;AAC5C;AAAA,EACF;AAEA,QAAMmE,IAAalE,EAChB,OAAO,CAAC5H,MAAoD,EAAQA,CAAU,EAC9E,IAAI2L,EAAa;AACpB,EAAAL,GAAwB,IAAI3D,GAAemE,CAAU;AACvD;AAEO,SAASC,GAAsBpE,GAAmD;AACvF,SAAKA,IAGE2D,GAAwB,IAAI3D,CAAa,IAFvC;AAGX;AAEO,SAASqE,GACdrE,GAC2B;AAC3B,MAAI,CAACA;AACH,WAAO,CAAA;AAET,QAAMsE,IAAUX,GAAwB,IAAI3D,CAAa;AACzD,SAAKsE,IAGEA,EAAQ,IAAIN,EAAa,IAFvB,CAAA;AAGX;AASO,SAASO,KAAmC;AACjD,EAAAZ,GAAwB,MAAA;AAC1B;AAEO,SAASa,KAAgF;AAC9F,SAAO,IAAI;AAAA,IACT,MAAM,KAAKb,GAAwB,QAAA,GAAW,CAAC,CAAC3D,GAAeC,CAAS,MAAM;AAAA,MAC5ED;AAAA,MACAC,EAAU,IAAI+D,EAAa;AAAA,IAAA,CAC5B;AAAA,EAAA;AAEL;AAEO,SAASS,GAA4B5O,GAA2C;AACrF,MAAI,CAACA,KAAS,OAAOA,KAAU;AAC7B,WAAO;AAET,QAAMkO,IAASlO,GACT6O,IAASb,EAAiBE,EAAO,MAAM,GACvCY,IAAWd,EAAiBE,EAAO,QAAQ,GAC3Ca,IAAUf,EAAiBE,EAAO,OAAO,GACzCc,IAAMhB,EAAiBE,EAAO,GAAG,GACjC1H,IAAgBwH,EAAiBE,EAAO,cAAc;AAE5D,MACEW,KAAU,QACVC,KAAY,QACZC,KAAW,QACXC,KAAO,QACPxI,KAAiB;AAEjB,WAAO;AAGT,QAAM8G,IAASS,GAAiBG,EAAO,MAAM;AAI7C,SAAO;AAAA,IACL,QAAAW;AAAA,IACA,UAAAC;AAAA,IACA,SAAAC;AAAA,IACA,KAAAC;AAAA,IACA,QAPA1B,MAAW,YAAYA,MAAW,cAAcA,IAAS;AAAA,IAQzD,gBAAgB9G;AAAA,EAAA;AAEpB;AAEO,SAASyI,GACdjP,GACmC;AACnC,MAAI,CAACA,KAAS,OAAOA,KAAU;AAC7B,WAAO;AAET,QAAMkO,IAASlO,GAETkP,IAAgBlB,EAAiBE,EAAO,cAAc,GACtDiB,IAAmBnB,EAAiBE,EAAO,iBAAiB,GAC5DkB,IAAmBpB,EAAiBE,EAAO,kBAAkB,GAC7DmB,IACJrB,EAAiBE,EAAO,uBAAuB,KAC/CF,EAAiBE,EAAO,uBAAuB,GAC3CoB,IACJtB,EAAiBE,EAAO,sBAAsB,KAC9CF,EAAiBE,EAAO,sBAAsB;AAEhD,MAAIqB,IAAqB;AACzB,MAAI,OAAOrB,EAAO,wBAAyB;AACzC,IAAAqB,IAAqB,OAAO,SAASrB,EAAO,oBAAoB,IAC5D,KAAK,MAAMA,EAAO,oBAAoB,IACtC;AAAA,WACK,OAAOA,EAAO,wBAAyB,UAAU;AAC1D,UAAM3N,IAAS,OAAO,SAAS2N,EAAO,sBAAsB,EAAE;AAC9D,IAAI,OAAO,SAAS3N,CAAM,MACxBgP,IAAqBhP;AAAA,EAEzB;AAUA,SAPE2O,KAAiB,QACjBC,KAAoB,QACpBC,KAAoB,QACpBC,KAAiB,QACjBC,KAAgB,QAChBC,MAAuB,IAMlB;AAAA,IACL,gBAAgBL,KAAiB;AAAA,IACjC,mBAAmBC,KAAoB;AAAA,IACvC,sBAAsBI;AAAA,IACtB,oBAAoBH,KAAoB;AAAA,IACxC,yBAAyBC,KAAiB;AAAA,IAC1C,wBAAwBC,KAAgB;AAAA,IACxC,yBAAyBD,KAAiB;AAAA,IAC1C,wBAAwBC,KAAgB;AAAA,EAAA,IAXjC;AAaX;AAEO,SAASE,GAAwBxP,GAAgD;AACtF,MAAI,CAACA,KAAS,OAAOA,KAAU;AAC7B,WAAO;AAET,QAAMkO,IAASD,GAA0BjO,CAAK,IACzCmO,GAAcnO,CAAK,IACnBA,GACCiH,IAAe8G,GAAiBG,EAAO,aAAa,GACpDlI,IAAO+H,GAAiBG,EAAO,IAAI,GACnChH,IAAkByE,GAAiBuC,EAAO,gBAAgB,GAC1D9G,IAAe0F,GAAuBoB,EAAO,aAAa,GAC1D5L,IAAc2M,GAA4Bf,EAAO,WAAW,GAC5DlH,IACJkH,EAAO,eAAe,OAAOA,EAAO,eAAgB,WAC/CA,EAAO,cACR,MACA/G,IACJ6G,EAAkBE,EAA4C,kBAAkB,KAChFF,EAAiBhH,KAAA,gBAAAA,EAAgB,kBAAkB,KACnDgH,EAAiBhH,KAAA,gBAAAA,EAAgB,sBAAsB,KACvDgH,EAAiBhH,KAAA,gBAAAA,EAAgB,sBAAsB,KACvD8F,GAAuBoB,EAAO,cAAc;AAE9C,MACE,CAACjH,KACD,CAACjB,KACDkB,KAAmB,QACnBC,KAAiB,QACjBC,KAAgB;AAEhB,WAAO;AAGT,QAAM3B,IAAsC;AAAA,IAC1C,eAAewB;AAAA,IACf,MAAAjB;AAAA,IACA,gBACE+H,GAAiBG,EAAO,cAAc,KAAKH,GAAiBG,EAAO,aAAa,KAAK;AAAA,IACvF,eAAeH,GAAiBG,EAAO,aAAa;AAAA,IACpD,kBAAkBhH;AAAA,IAClB,gBAAgBC;AAAA,IAChB,eAAeC;AAAA,EAAA,GAGXqI,IAAcb,GAA4BV,EAAO,YAAY;AACnE,EAAIuB,MACFhK,EAAW,eAAegK,IAExBnN,MACFmD,EAAW,cAAcnD;AAE3B,QAAMvB,IAAcyM,GAA4BU,EAAO,WAAW;AAClE,MAAInN;AACF,IAAA0E,EAAW,cAAc1E,GACzB0E,EAAW,WACT,OAAO1E,EAAY,YAAa,WAAWA,EAAY,WAAW,MACpE0E,EAAW,WACT,OAAO1E,EAAY,YAAa,WAAWA,EAAY,WAAW;AAAA,OAC/D;AACL,UAAM0M,IAAUO,EAAiBE,EAAO,QAAQ,GAC1CR,IAAUM,EAAiBE,EAAO,QAAQ;AAChD,IAAIT,MAAY,SACdhI,EAAW,WAAWgI,IAEpBC,MAAY,SACdjI,EAAW,WAAWiI;AAAA,EAE1B;AAEA,EAAI,oBAAoBQ,MACtBzI,EAAW,iBAAiBuI,EAAiBE,EAAO,cAAc;AAEpE,QAAMzH,IAAasH,GAAiBG,EAAO,UAAU;AACrD,EAAIzH,MACFhB,EAAW,aAAagB;AAE1B,QAAMC,IAAgBqH,GAAiBG,EAAO,eAAe;AAC7D,GAAIxH,KAAiBwH,EAAO,oBAAoB,UAC9CzI,EAAW,kBAAkBiB,KAAiB;AAGhD,QAAMW,IAAkB2G,EAAiBE,EAAO,iBAAiB;AACjE,EAAI7G,MAAoB,SACtB5B,EAAW,oBAAoB4B;AAEjC,QAAMC,IAAe0G,EAAiBE,EAAO,cAAc;AAC3D,EAAI5G,MAAiB,SACnB7B,EAAW,iBAAiB6B;AAE9B,QAAMC,IAAkByG,EAAiBE,EAAO,iBAAiB;AACjE,EAAI3G,MAAoB,SACtB9B,EAAW,oBAAoB8B;AAEjC,QAAMC,IAAewG,EAAiBE,EAAO,cAAc;AAC3D,EAAI1G,MAAiB,SACnB/B,EAAW,iBAAiB+B;AAG9B,QAAMkI,IACJxB,EAAO,cAAc,OAAOA,EAAO,cAAe,WAC9C,EAAE,GAAIA,EAAO,WAAA,IACb;AACN,SAAIwB,MACFjK,EAAW,aAAaiK,IAGnBjK;AACT;AAEO,SAASkK,GAAyBvF,GAA+C;AACtF,MAAI,CAAC,MAAM,QAAQA,CAAS;AAC1B,WAAO,CAAA;AAET,QAAM3E,IAAwC,CAAA;AAC9C,aAAWqB,KAASsD,GAAW;AAC7B,UAAM8D,IAASsB,GAAwB1I,CAAK;AAC5C,IAAIoH,KACFzI,EAAW,KAAKyI,CAAM;AAAA,EAE1B;AACA,SAAOzI;AACT;ACpUA,IAAImK,KAA6C,CAAA;AACjD,MAAMC,yBAAqB,IAAA;AAE3B,SAASxK,GAAcrF,GAAoC;AACzD,SAAO,OAAOA,KAAU,YAAYA,EAAM,SAAS,IAAIA,IAAQ;AACjE;AAEA,SAASsF,GAAiBtF,GAA2C;AACnE,SAAIA,MAAU,OACL,OAEFqF,GAAcrF,CAAK;AAC5B;AAEA,SAASuF,GAAevF,GAAoC;AAC1D,SAAO,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK,IAAIA,IAAQ;AACvE;AAEA,SAASgO,GAAiBhO,GAA2C;AACnE,SAAIA,MAAU,OACL,OAEFuF,GAAevF,CAAK;AAC7B;AAEA,SAAS8P,GAAgB9P,GAAoC;AAC3D,MAAI,SAAOA,KAAU,YAAY,CAAC,OAAO,SAASA,CAAK;AAGvD,WAAO,KAAK,MAAMA,CAAK;AACzB;AAEA,SAAS4F,EAA+C5F,GAA4C;AAClG,MAAI,GAACA,KAAS,OAAOA,KAAU;AAG/B,WAAO,EAAE,GAAGA,EAAA;AACd;AAEA,SAAS+P,GAAsB3J,GAAkE;AAC/F,QAAMgI,IAAoC,EAAE,GAAGhI,EAAA;AAC/C,SAAAgI,EAAM,eAAexI,EAAYQ,EAAS,YAAY,GACtDgI,EAAM,cAAcxI,EAAYQ,EAAS,WAAW,GACpDgI,EAAM,cAAcxI,EAAYQ,EAAS,WAAW,GACpDgI,EAAM,aAAaxI,EAAYQ,EAAS,UAAU,GAC3CgI;AACT;AAEA,SAAS4B,GAAuB5J,GAA4D;AAC1F,QAAMgI,IAAiC,EAAE,GAAGhI,EAAA;AAC5C,SAAAgI,EAAM,cAAcxI,EAAYQ,EAAS,WAAW,GACpDgI,EAAM,aAAaxI,EAAYQ,EAAS,UAAU,GAC9C,MAAM,QAAQA,EAAS,SAAS,MAClCgI,EAAM,YAAYhI,EAAS,UAAU,IAAI2J,EAAqB,IAEzD3B;AACT;AAEA,SAAS6B,GACPzN,GACgC;AAChC,MAAI,CAACA,KAAa,OAAOA,KAAc;AACrC,WAAO;AAGT,QAAM0N,IAAO7K,GAAc7C,EAAU,IAAI;AACzC,MAAI,CAAC0N;AACH,WAAO;AAGT,QAAMzK,IAAsC,EAAE,MAAAyK,EAAA,GAExClK,IAAOX,GAAc7C,EAAU,IAAI;AACzC,EAAIwD,MACFP,EAAW,OAAOO;AAGpB,QAAMoB,IAAe4G,GAAiBxL,EAAU,aAAa;AAC7D,EAAI4E,MAAiB,WACnB3B,EAAW,gBAAgB2B;AAG7B,QAAMD,IACJ6G,GAAiBxL,EAAU,YAAY,KACvCwL,GAAkBxL,EAA+C,kBAAkB,KACnFwL,GAAiBxL,EAAU,cAAc;AAC3C,EAAI2E,MAAkB,WACpB1B,EAAW,iBAAiB0B,GAC5B1B,EAAW,eAAe0B;AAG5B,QAAMgJ,IAAgBL,GAAgBtN,EAAU,cAAc;AAC9D,EAAI2N,MAAkB,WACpB1K,EAAW,iBAAiB0K;AAE9B,QAAMC,IAAmBN,GAAgBtN,EAAU,uBAAuB;AAC1E,EAAI4N,MAAqB,WACvB3K,EAAW,0BAA0B2K,IAEnC,OAAO5N,EAAU,qBAAsB,cACzCiD,EAAW,oBAAoBjD,EAAU;AAG3C,QAAMgE,IAAgBwH,GAAiBxL,EAAU,cAAc;AAC/D,EAAIgE,MAAkB,WACpBf,EAAW,iBAAiBe;AAE9B,QAAMC,IAAapB,GAAc7C,EAAU,UAAU;AACrD,EAAIiE,MACFhB,EAAW,aAAagB,IAEtB,qBAAqBjE,MACvBiD,EAAW,kBAAkBH,GAAiB9C,EAAU,eAAe;AAGzE,QAAMzB,IAAc6E,EAAYpD,EAAU,WAAW;AACrD,EAAIzB,MACF0E,EAAW,cAAc1E;AAE3B,QAAM2O,IAAY9J,EAAYpD,EAAU,UAAU;AAIlD,MAHIkN,MACFjK,EAAW,aAAaiK,IAEtB,MAAM,QAAQlN,EAAU,SAAS,GAAG;AACtC,UAAM6N,IAAW7N,EAAU,UAAU;AAAA,MACnC,CAACsE,MAA+C,EAAQA;AAAA,IAAK;AAE/D,IAAIuJ,EAAS,WACX5K,EAAW,YAAY4K,EAAS,IAAIN,EAAqB;AAAA,EAE7D;AAEA,SAAOtK;AACT;AAEA,SAAS6K,GACPC,GACAC,GACyB;AACzB,QAAMC,IAAkC;AAAA,IACtC,GAAGF;AAAA,IACH,GAAGC;AAAA,EAAA;AAGL,SAAI,CAACA,EAAM,eAAeD,EAAQ,gBAChCE,EAAO,cAAc7K,EAAY2K,EAAQ,WAAW,IAElD,CAACC,EAAM,cAAcD,EAAQ,eAC/BE,EAAO,aAAa7K,EAAY2K,EAAQ,UAAU,IAEhD,CAACC,EAAM,aAAaD,EAAQ,cAC9BE,EAAO,YAAYF,EAAQ,UAAU,IAAIR,EAAqB,IAEzDU;AACT;AAEO,SAASC,GACdvI,GACM;AAEN,EAAAyH,MADgBzH,KAAY,CAAA,GACJ,IAAI,CAAC4G,OAAa,EAAE,GAAGA,IAAU;AAC3D;AAEO,SAAS4B,KAAmD;AACjE,SAAOf,GAAc,IAAI,CAACb,OAAa,EAAE,GAAGA,IAAU;AACxD;AAEO,SAAS6B,GACdxI,GACM;AACN,EAAAyH,GAAe,MAAA;AACf,QAAMpB,IAAUrG,KAAc,CAAA;AAE9B,aAAWhC,KAAYqI,GAAS;AAC9B,UAAMhJ,IAAawK,GAA2B7J,CAAQ;AACtD,IAAKX,KAGLoK,GAAe,IAAIpK,EAAW,MAAMuK,GAAuBvK,CAAU,CAAC;AAAA,EACxE;AACF;AAEO,SAASoL,GACdC,GACM;AACN,QAAMrC,IAAUqC,KAAW,CAAA;AAE3B,aAAWN,KAAS/B,GAAS;AAC3B,UAAMhJ,IAAawK,GAA2BO,CAAK;AACnD,QAAI,CAAC/K;AACH;AAEF,UAAMsL,IAAWlB,GAAe,IAAIpK,EAAW,IAAI,GAC7CW,IAAW2K,IACbT,GAAeS,GAAUtL,CAAU,IACnCuK,GAAuBvK,CAAU;AACrC,IAAAoK,GAAe,IAAIzJ,EAAS,MAAMA,CAAQ;AAAA,EAC5C;AACF;AAEO,SAAS4K,GACd7G,GACAC,GACM;AACN,MAAI,CAACD;AACH;AAEF,QAAMrD,IAAQ+I,GAAe,IAAI1F,CAAa;AAC9C,MAAI,CAACrD;AACH;AAEF,MAAI,CAAC,MAAM,QAAQsD,CAAS,KAAKA,EAAU,WAAW,GAAG;AACvD,UAAM6G,IAAgC,EAAE,GAAGnK,EAAA;AAC3C,WAAOmK,EAAK,WACZpB,GAAe,IAAI1F,GAAe8G,CAAI;AACtC;AAAA,EACF;AACA,QAAMxL,IAAa2E,EAAU,IAAI2F,EAAqB,GAChDkB,IAAgC;AAAA,IACpC,GAAGnK;AAAA,IACH,WAAWrB;AAAA,EAAA;AAEb,EAAAoK,GAAe,IAAI1F,GAAe8G,CAAI;AACxC;AAEO,SAASC,KAAuD;AACrE,SAAO,MAAM,KAAKrB,GAAe,OAAA,GAAU,CAACzJ,MAAa4J,GAAuB5J,CAAQ,CAAC;AAC3F;AAYO,SAAS+K,KAA8C;AAC5D,SAAO;AAAA,IACL,UAAUR,GAAA;AAAA,IACV,YAAYO,GAAA;AAAA,EAAsB;AAEtC;ACjNA,MAAME,KAAsB;AAE5B,SAAS7L,EAAevF,GAA+B;AACrD,SAAI,OAAOA,KAAU,YAAY,CAAC,OAAO,SAASA,CAAK,IAC9C,OAEFA;AACT;AAEA,SAAS0F,GAAU1F,GAAwB;AACzC,QAAMkB,IAAUqE,EAAevF,CAAK;AACpC,SAAIkB,KAAW,OACN,IAEF,KAAK,MAAMA,CAAO;AAC3B;AAEA,SAAS6M,EAAiB/N,GAA+B;AACvD,MAAI,OAAOA,KAAU;AACnB,WAAO;AAET,QAAMwF,IAAUxF,EAAM,KAAA;AACtB,SAAOwF,EAAQ,SAAS,IAAIA,IAAU;AACxC;AAEA,SAAS6L,GAAcrR,GAAgB2M,GAA0B;AAC/D,SAAOoB,EAAiB/N,CAAK,KAAK2M;AACpC;AAEA,SAAS2E,GAAWtR,GAAqC;AACvD,SAAIA,KAAS,QAAQ,CAAC,OAAO,SAASA,CAAK,IAClC,OAELA,IAAQ,IACH,IAELA,IAAQ,IACH,IAEFA;AACT;AAEA,SAASuR,GAAsBvR,GAAuB;AACpD,QAAMoB,IAAc,KAAK,IAAIpB,IAAQ,CAAC,IAAI;AAC1C,SAAOA,EAAM,eAAe,SAAS;AAAA,IACnC,uBAAuBoB,IAAc,IAAI;AAAA,IACzC,uBAAuB;AAAA,EAAA,CACxB;AACH;AAEA,SAASoQ,GACPC,GACAC,GACsB;AACtB,QAAMC,IAAUL,GAAWG,CAAK;AAChC,MAAIE,KAAW;AACb,WAAO;AAET,QAAMC,IAAe,KAAK,MAAMD,IAAU,GAAI,IAAI;AAClD,MAAIE,IAA0B;AAC9B,EAAIF,IAAU,MACZE,IAAO,WACEF,IAAU,QACnBE,IAAO;AAGT,QAAMC,IAAcJ,MAAU,YAAY,iBAAiB,aACrDK,IACJL,MAAU,YACN,+DACA;AAEN,SAAO;AAAA,IACL,KAAK,GAAGA,CAAK;AAAA,IACb,OAAO,GAAGI,CAAW,IAAIP,GAAsBK,CAAY,CAAC;AAAA,IAC5D,MAAAC;AAAA,IACA,aAAAE;AAAA,EAAA;AAEJ;AAEA,SAASC,GAAUhS,GAAuB;AACxC,SAAOA,EACJ,MAAM,SAAS,EACf,OAAO,OAAO,EACd;AAAA,IACC,CAACiS,MAAUA,EAAM,OAAO,CAAC,EAAE,YAAA,IAAgBA,EAAM,MAAM,CAAC,EAAE,YAAA;AAAA,EAAY,EAEvE,KAAK,GAAG;AACb;AAEA,SAASC,GAAuBzL,GAAiD;AAC/E,QAAMhB,IAAa0M,GAAyB1L,CAAU;AACtD,MAAI,CAAChB;AACH,WAAO;AAGT,QAAM2M,IAAW3M;AACjB,SAAO;AAAA,IACL,KAAK,cAAcA,CAAU;AAAA,IAC7B,OAAO,WAAW2M,CAAQ;AAAA,IAC1B,MAAM;AAAA,IACN,aAAa;AAAA,EAAA;AAEjB;AAEA,SAASD,GAAyB1L,GAA0C;AAC1E,QAAMhB,IAAasI,EAAiBtH,CAAU;AAC9C,MAAI,CAAChB;AACH,WAAO;AAGT,QAAM4M,IAAaC,GAA0B7M,CAAU;AACvD,SAAI4M,KAIGL,GAAUvM,CAAU;AAC7B;AAEA,SAAS6M,GAA0B7L,GAAmC;AACpE,QAAMjB,IAAUiB,EAAW,KAAA;AAC3B,MAAI,CAACjB,EAAQ,WAAW,GAAG,KAAK,CAACA,EAAQ,WAAW,GAAG;AACrD,WAAO;AAGT,MAAI;AACF,UAAMgF,IAAU,KAAK,MAAMhF,CAAO,GAC5B+M,IAAaC,GAAqBhI,CAAO,GACzCiI,IACJjI,KAAW,OAAOA,KAAY,WAC1BuD;AAAAA,MACGvD,EAAoC,YAClCA,EAAoC;AAAA,IAAA,IAEzC;AAEN,QAAI+H,EAAW,UAAUE;AACvB,aAAO,GAAGT,GAAUS,CAAQ,CAAC,KAAKF,EAAW,KAAK,IAAI,CAAC;AAEzD,QAAIA,EAAW;AACb,aAAO,OAAOA,EAAW,KAAK,IAAI,CAAC;AAAA,EAEvC,QAAQ;AACN,WAAO;AAAA,EACT;AAEA,SAAO;AACT;AAEA,SAASC,GAAqBhI,GAA4B;AACxD,QAAMkI,IAAgB,CAAC1S,MAAkC;AACvD,QAAI,OAAOA,KAAU;AACnB,aAAO;AAET,UAAMwF,IAAUxF,EAAM,KAAA;AACtB,WAAOwF,IAAUA,EAAQ,YAAA,IAAgB;AAAA,EAC3C,GAEMmN,IAAY,CAACC,MACjBA,EACG,IAAIF,CAAa,EACjB,OAAO,CAACG,MAAyB,EAAQA,CAAK;AAEnD,MAAI,MAAM,QAAQrI,CAAO;AACvB,WAAOmI,EAAUnI,CAAO;AAG1B,MAAIA,KAAW,OAAOA,KAAY,UAAU;AAC1C,UAAM+H,IAAc/H,EAAoC;AACxD,QAAI,MAAM,QAAQ+H,CAAU;AAC1B,aAAOI,EAAUJ,CAAU;AAAA,EAE/B;AAEA,SAAO,CAAA;AACT;AAEA,SAASO,GACP1M,GAC2B;AAC3B,MAAI,CAACA;AACH,WAAO;AAGT,QAAM8J,IACJnC,EAAiB3H,EAAS,IAAI,KAAK,GAAGgL,EAAmB,IAAIhL,EAAS,QAAQ,GAAG,IAC7EJ,IAAOqL,GAAcjL,EAAS,MAAM,mBAAmB,GACvDH,IAAe8H,EAAiB3H,EAAS,aAAa,GACtDD,IAAUZ,EAAea,EAAS,OAAO,GACzCF,IAAcX,EAAea,EAAS,YAAY,GAElDI,IACJ,oBAAoBJ,IAChBkL,GAAW/L,EAAea,EAAS,cAAc,CAAC,IAClD,MACAK,IAAasH,EAAiB3H,EAAS,UAAU,GACjDM,IAA+BqH,EAAiB3H,EAAS,eAAe,GACxEO,IAAgBP,EAAS,mBAAmB,IAC5CC,IAASd,EAAea,EAAS,OAAO,GACxCE,IAAeyH,EAAiB3H,EAAS,cAAc,GACvDG,IAAkBwH,EAAiB3H,EAAS,iBAAiB,GAE7D2M,IAA0B,CAAA,GAC1BC,IAAgBxB,GAAqBhL,GAAe,SAAS;AACnE,EAAIwM,KACFD,EAAO,KAAKC,CAAa;AAE3B,QAAMC,IAAkBf,GAAuBzL,CAAU;AACzD,EAAIwM,KACFF,EAAO,KAAKE,CAAe;AAG7B,QAAMhT,IAA0B;AAAA,IAC9B,MAAAiQ;AAAA,IACA,MAAAlK;AAAA,IACA,eAAeC;AAAA,IACf,SAAAE;AAAA,IACA,cAAcD;AAAA,IACd,gBAAgBS;AAAA,IAChB,gBAAgBH;AAAA,IAChB,YAAAC;AAAA,IACA,iBAAiB;AAAA,IACjB,SAASJ;AAAA,IACT,gBAAgBC;AAAA,IAChB,mBAAmBC;AAAA,IACnB,QAAAwM;AAAA,EAAA,GAGIG,IACJ,OAAOxM,KAAkB,WAAWA,IAAgB;AACtD,SAAAzG,EAAI,kBAAkBiT,GAEfjT;AACT;AAEA,SAASkT,GACP/M,GAC6B;AAC7B,MAAI,CAACA;AACH,WAAO;AAET,QAAM8J,IAAOnC,EAAiB3H,EAAS,IAAI;AAC3C,MAAI,CAAC8J;AACH,WAAO;AAGT,QAAMlK,IAAOqL,GAAcjL,EAAS,MAAM,mBAAmB,GACvD+J,IAAgBzK,GAAUU,EAAS,cAAc,GACjDgN,IAAwB1N,GAAUU,EAAS,uBAAuB,GAClEgB,IAAe7B,EAAea,EAAS,aAAa,GACpDzD,IACJ4C,EAAea,EAAS,YAAY,KACpCb,EAAgBa,KAAA,gBAAAA,EAA+C,kBAAkB,KACjFb,EAAea,EAAS,cAAc,KACtC,GAEIrF,IAAcyM,GAA4BpH,EAAS,WAAW,GAC9DqH,KAAU1M,KAAA,gBAAAA,EAAa,aAAY,MACnC2M,KAAU3M,KAAA,gBAAAA,EAAa,aAAY,MAEnCsS,IAAWjM,KAAgB,MAC3BT,IAAgBP,EAAS,sBAAsB,MAAS,CAACiN,GAEzD7M,IACJ,oBAAoBJ,IAChBkL,GAAW/L,EAAea,EAAS,cAAc,CAAC,IAClD,MACAK,IAAasH,EAAiB3H,EAAS,UAAU,GACjDM,IAAgBqH,EAAiB3H,EAAS,eAAe,GAEzD2M,IAA0B,CAAA,GAC1BC,IAAgBxB,GAAqBhL,GAAe,WAAW;AACrE,EAAIwM,KACFD,EAAO,KAAKC,CAAa;AAE3B,QAAMC,IAAkBf,GAAuBzL,CAAU;AACzD,EAAIwM,KACFF,EAAO,KAAKE,CAAe;AAG7B,QAAMhT,IAA4B;AAAA,IAChC,MAAAiQ;AAAA,IACA,MAAAlK;AAAA,IACA,gBAAgBmK;AAAA,IAChB,eAAe/I;AAAA,IACf,cAAczE;AAAA,IACd,UAAU8K;AAAA,IACV,UAAUC;AAAA,IACV,UAAA2F;AAAA,IACA,gBAAgB1M,KAAiByM,IAAwB;AAAA,IACzD,yBAAyBA;AAAA,IACzB,aAAArS;AAAA,IACA,gBAAgByF;AAAA,IAChB,YAAAC;AAAA,IACA,iBAAiB;AAAA,IACjB,QAAAsM;AAAA,EAAA,GAGIG,IACJ,OAAOxM,KAAkB,WAAWA,IAAgB;AACtD,SAAAzG,EAAI,kBAAkBiT,GAEfjT;AACT;AAEO,SAASqT,KAAkD;AAChE,QAAM,EAAE,UAAAnL,EAAA,IAAagJ,GAAA;AACrB,SAAOhJ,EACJ,IAAI2K,EAAe,EACnB,OAAO,CAAC7S,MAAmC,EAAQA,CAAI;AAC5D;AAEO,SAASsT,KAAsD;AACpE,QAAM,EAAE,YAAAnL,EAAA,IAAe+I,GAAA;AACvB,SAAO/I,EACJ,IAAI+K,EAAiB,EACrB,OAAO,CAAClT,MAAqC,EAAQA,CAAI;AAC9D;AC5WO,SAASuT,GAAWxT,GAA0C;AACnE,SAAKA,IAGEA,EAAM,QAAQ,YAAY,CAACyT,MAAU;AAC1C,YAAQA,GAAA;AAAA,MACN,KAAK;AACH,eAAO;AAAA,MACT,KAAK;AACH,eAAO;AAAA,MACT,KAAK;AACH,eAAO;AAAA,MACT,KAAK;AACH,eAAO;AAAA,MACT,KAAK;AACH,eAAO;AAAA,MACT;AACE,eAAOA;AAAA,IAAA;AAAA,EAEb,CAAC,IAjBQ;AAkBX;AAEO,SAASC,GACdX,GACArR,IAA4B,IACpB;AACR,MAAI,CAACqR,KAAUA,EAAO,WAAW;AAC/B,WAAO;AAET,QAAMY,IAAiB,CAAC,eAAejS,EAAQ,cAAc,EAC1D,OAAO,OAAO,EACd,KAAK,GAAG,GACLkS,IAAQb,EACX,IAAI,CAACc,MAAU;AACd,UAAMC,IAAY,eAAeD,EAAM,IAAI,IACrC/S,IAAQ+S,EAAM,cAChB,WAAWL,GAAWK,EAAM,WAAW,CAAC,MACxC;AACJ,WAAO,2BAA2BC,CAAS,IAAIhT,CAAK,IAAI0S;AAAA,MACtDK,EAAM;AAAA,IAAA,CACP;AAAA,EACH,CAAC,EACA,KAAK,EAAE;AACV,SAAO,gBAAgBF,CAAc,KAAKC,CAAK;AACjD;AAEO,SAASG,GACdC,GACAjB,GACArR,IAAgC,CAAA,GACxB;AACR,QAAMuS,IAAcP,GAAgBX,GAAQrR,CAAO;AACnD,MAAI,CAACuS;AACH,WAAOT,GAAWQ,CAAK;AAEzB,QAAME,IAAaxS,EAAQ,cAAc;AAIzC,SAAO,gBAHgB,CAAC,oBAAoBA,EAAQ,cAAc,EAC/D,OAAO,OAAO,EACd,KAAK,GAAG,CAC0B,kBAAkBwS,CAAU,KAAKV;AAAA,IACpEQ;AAAA,EAAA,CACD,UAAUC,CAAW;AACxB;ACbA,SAASE,GACPC,GACA3L,GACA4L,GACAjN,GACM;AACN,EAAAgN,EAAQ3L,CAAK,IAAI;AAAA,IACf,UAAU4L;AAAA,IACV,SAASjN;AAAA,EAAA;AAEb;AA4BA,MAAMkN,wBAA8B,IAAA,GAC9BC,yBAA0B,IAAA;AAEhC,SAASC,GAAmB5V,GAAwB;AAClD,MAAI,OAAOA,KAAU,UAAU;AAC7B,UAAM4G,IAAU5G,EAAM,KAAA;AACtB,WAAO4G,EAAQ,SAAS,IAAIA,IAAU;AAAA,EACxC;AACA,MAAI5G,aAAiB,OAAO;AAC1B,UAAM4G,IAAU5G,EAAM,QAAQ,KAAA;AAC9B,WAAO4G,EAAQ,SAAS,IAAIA,IAAU;AAAA,EACxC;AACA,MAAI5G,KAAS;AACX,QAAI;AACF,YAAM6V,IAAa,KAAK,UAAU7V,CAAK;AACvC,UAAI6V,KAAcA,MAAe;AAC/B,eAAOA;AAAA,IAEX,QAAQ;AAAA,IAER;AAEF,SAAO;AACT;AAEA,SAAS1G,GAAiB/N,GAA+B;AACvD,MAAI,OAAOA,KAAU;AACnB,WAAO;AAET,QAAMwF,IAAUxF,EAAM,KAAA;AACtB,SAAOwF,EAAQ,SAAS,IAAIA,IAAU;AACxC;AAEA,SAASD,GAAevF,GAAoC;AAC1D,SAAO,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK,IAAIA,IAAQ;AACvE;AAEA,SAASgO,GAAiBhO,GAA2C;AACnE,SAAIA,MAAU,OACL,OAEFuF,GAAevF,CAAK;AAC7B;AAEA,SAASsF,GAAiBtF,GAA2C;AACnE,SAAIA,MAAU,OACL,OAEF+N,GAAiB/N,CAAK;AAC/B;AAEA,SAAS0U,GACP9L,GACkC;AAClC,SAAO4E,GAA4B5E,EAAS,WAAW;AACzD;AAIA,MAAM+L,KAAyB,KACzBC,KAAuB,IAChBC,KAAoC,yCACpCC,KAA8B,yBAErCC,yBAA4B,IAAA,GAC5BC,KAAiE;AAAA,EACrE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEA,SAASC,GAAiBC,GAA8BhF,GAAsB;AAC5E,SAAO,GAAGgF,CAAI,IAAIhF,CAAI;AACxB;AAEA,SAASiF,GAAuBnV,GAA2C;AACzE,MAAIA,MAAU;AACZ;AAEF,MAAIA,MAAU;AACZ,WAAO;AAET,MAAI,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK;AACpD,WAAOA;AAET,QAAMkB,IAAU8M,GAAiBhO,CAAK;AACtC,MAAIkB,MAAY;AACd,WAAO;AAET,MAAI,OAAOA,KAAY,YAAY,OAAO,SAASA,CAAO;AACxD,WAAOA;AAGX;AAEA,SAASkU,GAAwBpV,GAA2C;AAC1E,MAAIA,MAAU;AAGd,WAAOsF,GAAiBtF,CAAK;AAC/B;AAEA,SAASqV,GACP7O,GACAC,GACAC,GACAoB,GACiC;AACjC,QAAM1B,IAAqC,CAAA,GACrCkP,IAAqBH,GAAuB3O,CAAa;AAC/D,EAAI8O,MAAuB,WACzBlP,EAAS,iBAAiBkP;AAE5B,QAAMC,IAAuBH,GAAwB3O,CAAU;AAC/D,EAAI8O,MAAyB,WAC3BnP,EAAS,aAAamP;AAExB,QAAMrC,IAA0BkC,GAAwB1O,CAAa;AACrE,EAAIwM,MAA4B,WAC9B9M,EAAS,kBAAkB8M;AAE7B,QAAMsC,IAAwBJ,GAAwBtN,CAAW;AACjE,SAAI0N,MAA0B,WAC5BpP,EAAS,eAAeoP,IAEnB,OAAO,KAAKpP,CAAQ,EAAE,SAAS,IAAIA,IAAW;AACvD;AAEA,SAASqP,GACPC,GACAzE,GAC0B;AAC1B,QAAMmD,IAA6B,CAAA;AACnC,MAAIuB,IAAa;AACjB,aAAWlN,KAASuM,IAAmB;AACrC,UAAMX,IAAgBqB,KAAA,gBAAAA,EAAWjN,IAC3BrB,IAAe6J,EAAKxI,CAAK;AAC/B,IAAI4L,MAAkBjN,MAGtB+M,GAAoBC,GAAS3L,GAAO4L,GAAejN,CAAY,GAC/DuO,IAAa;AAAA,EACf;AACA,SAAOA,IAAavB,IAAU;AAChC;AAEA,SAASwB,GAAoBF,GAA8D;AACzF,QAAMtB,IAA6B,CAAA;AACnC,MAAIuB,IAAa;AACjB,aAAWlN,KAASuM,IAAmB;AACrC,UAAMX,IAAgBqB,EAASjN,CAAK;AACpC,IAAI4L,MAAkB,WAGtBF,GAAoBC,GAAS3L,GAAO4L,GAAe,MAAS,GAC5DsB,IAAa;AAAA,EACf;AACA,SAAOA,IAAavB,IAAU;AAChC;AAEA,SAASyB,GAAyBC,GAA+C;AAC/E,MAAK,OAAO,KAAKA,EAAO,OAAO,EAAE,QAGjC;AAAA,QAAI;AACF,cAAQ,MAAM,yBAAyBA,CAAM;AAAA,IAC/C,QAAQ;AAAA,IAER;AACA,QAAI,SAAO,SAAW,OAAe,OAAO,OAAO,iBAAkB;AAGrE,UAAI;AACF,eAAO,cAAc,IAAI,YAAYhB,IAA6B,EAAE,QAAAgB,EAAA,CAAQ,CAAC;AAAA,MAC/E,SAASlX,GAAO;AACd,gBAAQ,KAAK,mEAAmEA,CAAK;AAAA,MACvF;AAAA;AACF;AAEA,SAASmX,GACPb,GACA5H,GACA4C,GACA9J,GACM;AACN,QAAMrG,IAAMkV,GAAiBC,GAAMhF,CAAI,GACjCwF,IAAWX,GAAsB,IAAIhV,CAAG;AAC9C,MAAI,CAACqG,GAAU;AACb,QAAI,CAACsP;AACH;AAEF,IAAAX,GAAsB,OAAOhV,CAAG;AAChC,UAAMiW,IAAiBJ,GAAoBF,CAAQ;AACnD,QAAI,CAACM;AACH;AAEF,IAAAH,GAAyB;AAAA,MACvB,MAAAX;AAAA,MACA,MAAAhF;AAAA,MACA,QAAA5C;AAAA,MACA,SAAS0I;AAAA,MACT,UAAU,CAAA;AAAA,MACV,YAAW,oBAAI,KAAA,GAAO,YAAA;AAAA,IAAY,CACnC;AACD;AAAA,EACF;AACA,QAAM5B,IAAUqB,GAAgBC,GAAUtP,CAAQ;AAClD,EAAKgO,MAGLW,GAAsB,IAAIhV,GAAK,EAAE,GAAGqG,GAAU,GAC9CyP,GAAyB;AAAA,IACvB,MAAAX;AAAA,IACA,MAAAhF;AAAA,IACA,QAAA5C;AAAA,IACA,SAAS8G;AAAA,IACT,UAAU,EAAE,GAAGhO,EAAA;AAAA,IACf,YAAW,oBAAI,KAAA,GAAO,YAAA;AAAA,EAAY,CACnC;AACH;AAEA,SAAS6P,GAAuB9N,GAAqD;AACnF,MAAI,GAACA,KAAYA,EAAS,WAAW;AAGrC,eAAW4G,KAAW5G,GAAU;AAC9B,YAAM+H,IAAOnC,GAAiBgB,EAAQ,IAAI;AAC1C,UAAI,CAACmB;AACH;AAEF,YAAM9J,IAAWiP;AAAA,QACftG,EAAQ;AAAA,QACRA,EAAQ;AAAA,QACRA,EAAQ;AAAA,QACR;AAAA,MAAA;AAEF,MAAAgH,GAAwB,WAAW,YAAY7F,GAAM9J,CAAQ;AAAA,IAC/D;AACF;AAEA,SAAS8P,GACP9N,GACM;AACN,MAAI,GAACA,KAAcA,EAAW,WAAW;AAGzC,eAAW+N,KAAa/N,GAAY;AAClC,YAAM8H,IAAOnC,GAAiBoI,EAAU,IAAI;AAC5C,UAAI,CAACjG;AACH;AAEF,YAAM9J,IAAWiP;AAAA,QACfc,EAAU;AAAA,QACVA,EAAU;AAAA,QACVA,EAAU;AAAA,QACV;AAAA,MAAA;AAEF,MAAAJ,GAAwB,aAAa,oBAAoB7F,GAAM9J,CAAQ;AAAA,IACzE;AACF;AAEA,SAASgQ,GACPjM,GACAkM,GACM;AXxWR,MAAArN,GAAAC,GAAAC,GAAAC;AWyWE,MAAI,CAACkN;AACH;AAEF,QAAMjQ,IAAWiP;AAAA,IACfgB,EAAO,oBAAkBrN,IAAAqN,EAAO,uBAAP,gBAAArN,EAA2B;AAAA,IACpDqN,EAAO,gBAAcpN,IAAAoN,EAAO,uBAAP,gBAAApN,EAA2B;AAAA,IAChDoN,EAAO,qBAAmBnN,IAAAmN,EAAO,uBAAP,gBAAAnN,EAA2B;AAAA,KACrDC,IAAAkN,EAAO,uBAAP,gBAAAlN,EAA2B;AAAA,EAAA;AAE7B,EAAA4M,GAAwB,uBAAuB,uBAAuB5L,GAAe/D,CAAQ;AAC/F;AACA,SAASkQ,GAAqB1X,GAAgBuL,GAA+B;AAE3E,SAAO,sBADWqK,GAAmB5V,CAAK,CACJ,8CAA8CuL,CAAa;AACnG;AAEA,SAASoM,GAAmBC,GAA0BC,GAAmBC,GAAmB;AAC1F,QAAMrT,IAAQmT,EAAY,cAAgC,0BAA0B;AACpF,MAAI,CAACnT,EAAO;AAEZ,QAAMtD,IAAMyW,EAAY,QAAQ,WAAWnT,EAAM,QAAQ,eAAe,QAElE3E,KADW8X,EAAY,QAAQ,WAAWnT,EAAM,QAAQ,cAAc,WAC9B,SAAS,SAAS;AAChE,EAAAmT,EAAY,QAAQ,UAAUzW,GAC9ByW,EAAY,QAAQ,UAAU9X;AAE9B,MAAI;AACF,IAAAmF,GAAcR,GAAOtD,GAAKrB,GAAW,EAAI;AAAA,EAC3C,SAAS4E,GAAG;AACV,YAAQ,KAAK,6CAA6CA,CAAC;AAAA,EAC7D;AAEA,QAAM,EAAE,iCAAAqT,GAAiC,8BAAAC,EAAA,IAAiCnL,GAAA;AAE1E,MAAIkL;AACF,QAAI;AACF,MAAAA,EAAgCF,GAAQC,CAAG;AAAA,IAC7C,SAASpT,GAAG;AACV,cAAQ,KAAK,+DAA+DA,CAAC;AAAA,IAC/E;AAGF,MAAIsT;AACF,QAAI;AACF,MAAAA,EAA6BH,GAAQC,CAAG;AAAA,IAC1C,SAASpT,GAAG;AACV,cAAQ,KAAK,4DAA4DA,CAAC;AAAA,IAC5E;AAEJ;AAEA,SAASuT,GACPC,GACA3M,GACAC,GACAxL,GACsB;AACtB,MAAI,CAACkY,KAAQ,CAAC3M;AACZ,WAAO,EAAE,SAAS,IAAO,QAAQ,UAAA;AAGnC,QAAM4M,IAAaD,EAAK;AAAA,IACtB,uDAAuD3M,CAAa;AAAA,EAAA;AAEtE,MAAI,CAAC4M;AACH,WAAO,EAAE,SAAS,IAAO,QAAQ,UAAA;AAGnC,QAAMC,IAAYD,EAAW,cAA2B,sBAAsB;AAC9E,MAAI,CAACC;AACH,WAAO,EAAE,SAAS,IAAO,QAAQ,UAAA;AAGnC,MAAID,EAAW,UAAU,SAAS,QAAQ;AACxC,WAAO,EAAE,SAAS,IAAO,QAAQ,SAAA;AAGnC,MAAInY;AACF,WAAAoY,EAAU,YAAYV,GAAqB1X,GAAOuL,CAAa,GACxD,EAAE,SAAS,GAAA;AAGpB,QAAM8M,IAAUD,EAAU,QAAQ,SAC5BE,IAAUF,EAAU,QAAQ;AAElC,SAAAA,EAAU,YAAYG,GAA2B/M,CAAS,GAEtD6M,MAASD,EAAU,QAAQ,UAAUC,IACrCC,MAASF,EAAU,QAAQ,UAAUE,IAEzCX,GAAmBS,GAAWF,GAAM3M,CAAa,GAC1C,EAAE,SAAS,GAAA;AACpB;AAEO,SAASiN,GAAsBN,GAAoC3M,GAAgC;AACxG,QAAMkN,IAAU/C,EAAwB,IAAInK,CAAa;AACzD,MAAI,CAACkN,EAAS,QAAO;AAErB,QAAMC,IAAST;AAAA,IACbC;AAAA,IACA3M;AAAA,IACAkN,EAAQ;AAAA,IACRA,EAAQ;AAAA,EAAA;AAEV,SAAIC,EAAO,WACThD,EAAwB,OAAOnK,CAAa,GAEvCmN,EAAO;AAChB;AAEO,SAASC,GAAyBT,GAA6C;AACpF,MAAIU,IAAa;AACjB,aAAW,CAACrN,CAAa,KAAKmK;AAC5B,IAAI8C,GAAsBN,GAAM3M,CAAa,MAC3CqN,IAAa;AAGjB,SAAOA;AACT;AAEA,SAASC,GAAqBX,GAAoC3M,GAA6B;AAC7F,QAAM1G,IAAyB8Q,GAAoB,IAAIpK,CAAa,KAAK;AAAA,IACvE,UAAU;AAAA,IACV,OAAO;AAAA,EAAA;AAGT,EAAI1G,EAAK,UAITA,EAAK,QAAQ,WAAW,MAAM;AAC5B,IAAAA,EAAK,QAAQ,MACbA,EAAK,YAAY;AAEjB,UAAMiU,IAAUN,GAAsBN,GAAM3M,CAAa;AACzD,IAAIuN,KAAWjU,EAAK,YAAYmR,MAC9BL,GAAoB,OAAOpK,CAAa,GACnCuN,KACHpD,EAAwB,OAAOnK,CAAa,KAG9CsN,GAAqBX,GAAM3M,CAAa;AAAA,EAE5C,GAAGwK,EAAsB,GAEzBJ,GAAoB,IAAIpK,GAAe1G,CAAI;AAC7C;AAOO,SAASkU,GACdtB,GACAS,GACM;AACN,UAAQ,IAAI,gDAAgDT,CAAM;AAClE,QAAMuB,IAAkB,MAAM,QAAQvB,CAAM,IAAIA,IAAS,CAAA;AAIzD,MAHA3F,GAAoBkH,CAAe,GACnC3B,GAAuB2B,CAAe,GAElC,CAACd;AACH;AAGF,QAAMe,IAAcvE,GAAA;AAGpB,EAAAwE,GAAmBD,GAAaf,CAAI;AAGpC,QAAMiB,IAAiBjB,EAAK,cAAgC,wBAAwB,GAC9E1O,IAAa2P,IACf,MAAM;AAAA,IACJA,EAAe,iBAAsC,2BAA2B;AAAA,EAAA,EAChF,IAAI,CAAA9X,MAAO;AAEX,UAAM+X,IAAmB/X,EAAI,MAAM,KAAK,CAAC,GACnCgY,KAAcD,KAAA,gBAAAA,EAAkB,gBAAe,IAC/C9W,IAAU;AAAA,MACd+W,EAAY,QAAQ,OAAO,EAAE,EAAE,QAAQ,KAAK,GAAG,EAAE,QAAQ,YAAY,EAAE;AAAA,IAAA;AAEzE,WAAO;AAAA,MACL,eAAe,OAAO,SAAS/W,CAAO,IAAIA,IAAU;AAAA,IAAA;AAAA,EAExD,CAAC,IACD,CAAA;AAEJ,EAAAgX,GAAkBL,GAAazP,GAAY0O,CAAI;AACjD;AAOA,SAASgB,GAAmB3P,GAAgC2O,GAAuB;AACjF,QAAMqB,IAAerB,EAAK,cAA2B,gBAAgB,GAC/DsB,IAActB,EAAK,cAA2B,mBAAmB,GAEjEuB,IAAclQ,EAAS,OAAO,QAAY4G,EAAQ,iBAAiB,WAAW,KAAK,GACnFuJ,IAAanQ,EAAS,OAAO,QAAY4G,EAAQ,iBAAiB,WAAW,KAAK;AAExF,MAAIoJ,GAAc;AAChB,UAAMI,IAAUF,EAAY,IAAI,CAAAtJ,OAAY;AAAA,MAC1C,MAAMgF,GAAqBhF,EAAQ,MAAMA,EAAQ,QAAQ;AAAA,QACvD,gBAAgB;AAAA,QAChB,YAAY;AAAA,MAAA,CACb;AAAA,MACD,SAASA,EAAQ,WAAW;AAAA,IAAA,EAC5B;AACF,IAAAoJ,EAAa,YAAY7W;AAAA,MACvBiX;AAAA,MACA;AAAA,QACE,EAAE,KAAK,QAAQ,OAAO,OAAA;AAAA,QACtB,EAAE,KAAK,WAAW,OAAO,oBAAoB,OAAO,QAAA;AAAA,MAAQ;AAAA,MAE9D,CAAC,SAAS;AAAA,IAAA;AAAA,EAEd;AACE,YAAQ,KAAK,oDAAoD;AAGnE,MAAIH,GAAa;AACf,UAAMI,IAASF,EAAW,IAAI,CAAAvJ,MAAW;AACvC,YAAM7I,IAAc6I,EAAQ,cACtB0J,IAAiB,OAAOvS,KAAgB,YAAY,OAAO,SAASA,CAAW,GAC/ED,IAAe8H,GAAiBgB,EAAQ,aAAa,GACrD2J,IAAcD,IAChBvS,EAAY,eAAe,SAAS;AAAA,QAClC,uBAAuB;AAAA,QACvB,uBAAuB;AAAA,MAAA,CACxB,IACD,MACEyS,IAAYD,IACdzS,IACE,GAAGyS,CAAW,IAASzS,CAAY,KACnCyS,IACF;AAEJ,aAAO;AAAA,QACL,MAAM3E,GAAqBhF,EAAQ,MAAMA,EAAQ,QAAQ;AAAA,UACvD,gBAAgB;AAAA,UAChB,YAAY;AAAA,QAAA,CACb;AAAA,QACD,YAAY4J;AAAA,QACZ,SAAS5J,EAAQ,WAAW;AAAA,MAAA;AAAA,IAEhC,CAAC;AACD,IAAAqJ,EAAY,YAAY9W;AAAA,MACtBkX;AAAA,MACA;AAAA,QACE,EAAE,KAAK,QAAQ,OAAO,OAAA;AAAA,QACtB,EAAE,KAAK,cAAc,OAAO,cAAA;AAAA,QAC5B,EAAE,KAAK,WAAW,OAAO,OAAO,OAAO,QAAA;AAAA,MAAQ;AAAA,MAEjD,CAAC,SAAS;AAAA,IAAA;AAAA,EAEd,MAAA,CAAWF,EAAW,UACpB,QAAQ,KAAK,wFAAwF;AAEzG;AAEA,SAASM,GACPvC,GACoB;AACpB,MAAI,CAAC,MAAM,QAAQA,CAAM;AACvB,WAAO,CAAA;AAET,QAAM5Q,IAAiC,CAAA;AACvC,aAAWqB,KAASuP,GAAQ;AAC1B,UAAMjQ,IAAWsB,GAA6BZ,CAAK;AACnD,IAAKV,KAGLX,EAAW,KAAKW,CAAQ;AAAA,EAC1B;AACA,SAAOX;AACT;AAOO,SAASoT,GACdxC,GACAS,GACM;AACN,MAAI,CAAC,MAAM,QAAQT,CAAM,GAAG;AAC1B,YAAQ,KAAK,iDAAiDA,CAAM;AACpE;AAAA,EACF;AAEA,MAAI;AACF,YAAQ,MAAM,mCAAmCA,CAAM;AAAA,EACzD,QAAQ;AAAA,EAER;AAEA,QAAMyC,IAAoBF,GAAgCvC,CAAM;AAMhE,MALIyC,EAAkB,UACpBjI,GAAwBiI,CAAiB,GAE3C5C,GAAyB4C,CAAiB,GAEtC,CAAChC;AACH;AAIF,QAAMzT,IACJyT,EAAK,cAAgC,wBAAwB,KAC7DA,EAAK,cAAgC,kCAAkC;AACzE,MAAI,CAACzT,GAAO;AAOV,IAJE,CAFmByT,EAAK,cAAc,kBAAkB,MAGvDA,EAAK,cAAc,0BAA0B,KAC5CA,EAAK,cAAc,8BAA8B,KAGnD,QAAQ;AAAA,MACN;AAAA,IAAA,IAGF,QAAQ,KAAK,0DAA0D;AAEzE;AAAA,EACF;AAEA,QAAM7S,IAAQZ,EAAM,QAAQ,KAAK,CAAC,KAAKA,EAAM,cAAc,OAAO;AAClE,MAAI,CAACY,GAAO;AACV,YAAQ,KAAK,iDAAiD;AAC9D;AAAA,EACF;AAGA,QAAM8U,IAAoB,CAACC,MAAwB;AACjD,QAAI,OAAO,OAAS;AAClB,UAAI;AACF,cAAMC,IAAS,OAAO,YAAc,OAAe,UAAU,WACzD,UAAU,WACV;AACJ,eAAO,IAAI,KAAK,aAAaA,GAAQ;AAAA,UACnC,uBAAuB;AAAA,UACvB,uBAAuB;AAAA,QAAA,CACxB,EAAE,OAAOD,CAAG;AAAA,MACf,QAAQ;AAAA,MAER;AAGF,YADgBtM,GAAcsM,GAAK,EAAE,UAAU,EAAA,CAAG,KAAK,GACxC,QAAQ,CAAC,EAAE,QAAQ,KAAK,GAAG;AAAA,EAC5C,GAGME,wBAAa,IAAA;AAEnB,EADsBjV,EAAM,iBAAsC,kBAAkB,EACtE,QAAQ,CAAAhE,MAAO;AAC3B,UAAMkW,IAAYlW,EAAI,QAAQ;AAC9B,IAAIkW,KACF+C,EAAO,IAAI/C,GAAWlW,CAAG;AAAA,EAE7B,CAAC;AAED,MAAIkZ,IAAU;AAEd,QAAMC,IAAsB,CAACpZ,MAA6C;AACxE,UAAMkB,IAAU,OAAOlB,KAAU,YAAY,OAAO,SAASA,CAAK,IAAIA,IAAQ;AAC9E,QAAI;AACF,aAAOkB,EAAQ,eAAe,OAAO;AAAA,IACvC,QAAQ;AACN,aAAOA,EAAQ,SAAA;AAAA,IACjB;AAAA,EACF,GAEMmY,wBAAuB,IAAA;AAC7B,aAAWjT,KAAY0S,GAAmB;AACxC,UAAM5I,IAAOnC,GAAiB3H,EAAS,IAAI;AAC3C,IAAK8J,KAGLmJ,EAAiB,IAAInJ,GAAM9J,CAAQ;AAAA,EACrC;AAEA,aAAW,CAAC8J,GAAM9J,CAAQ,KAAKiT,EAAiB,WAAW;AACzD,UAAMpZ,IAAMiZ,EAAO,IAAIhJ,CAAI;AAK3B,QAJI,CAACjQ,KAIDA,EAAI,MAAM,SAAS;AACrB;AAGF,UAAMqZ,IAAerZ,EAAI,MAAM,KAAK,CAAC,GAC/BsZ,IAAatZ,EAAI,MAAM,KAAK,CAAC,GAC7BuZ,IAAcvZ,EAAI,MAAM,KAAK,CAAC,GAC9BwZ,IAAcxZ,EAAI,MAAM,KAAK,CAAC;AAEpC,QAAI,CAACqZ,KAAgB,CAACC;AACpB;AAIF,UAAMG,IACJ,OAAOtT,EAAS,kBAAmB,YAAY,OAAO,SAASA,EAAS,cAAc,IAClFA,EAAS,iBACT,GACAgB,IACJ,OAAOhB,EAAS,iBAAkB,YAAY,OAAO,SAASA,EAAS,aAAa,IAChFA,EAAS,gBACT,MACArF,IAAcyM,GAA4BpH,EAAS,WAAW,GAC9DqH,IAAU,QAAO1M,KAAA,gBAAAA,EAAa,aAAa,WAAWA,EAAY,WAAW,MAC7E2M,IAAU,QAAO3M,KAAA,gBAAAA,EAAa,aAAa,WAAWA,EAAY,WAAW,MAC7E4Y,IACJ,OAAOvT,EAAS,gBAAiB,YAAY,OAAO,SAASA,EAAS,YAAY,IAC9EA,EAAS,eACT,OAAOA,EAAS,kBAAmB,YAAY,OAAO,SAASA,EAAS,cAAc,IACpFA,EAAS,iBACT,MAEFwT,IAASC,GAAcN,EAAW,WAAW;AAGnD,IAFeM,GAAcP,EAAa,WAAW,MAEtCI,MACbJ,EAAa,cAAcF,EAAoBM,CAAQ;AAEzD,UAAMrG,IAAWjM,MAAiB,MAC5B0S,IAAU;AAAA,MACd,gBAAgB7Z,EAAI,QAAQ,kBAAkB;AAAA,MAC9C,eAAemH;AAAA,MACf,aAAArG;AAAA,IAAA,GAEIgZ,IAAa,EAAE,UAAA1G,EAAA,GACf2G,IAAgBla,EAAY,iBAAiBga,EAAQ,eAAeA,GAASC,CAAU,GACvFE,IAAgB7S,KAAgB;AAQtC,SAPI,KAAK,IAAIwS,IAASK,CAAa,KAAK,QAASV,EAAW,cAAcS,OACxET,EAAW,YAAYS,GACvB/Z,EAAI,UAAU,IAAI,cAAc,GAChC,WAAW,MAAM;AACf,MAAAA,EAAI,UAAU,OAAO,cAAc;AAAA,IACrC,GAAG,GAAG,IAEJuZ,GAAa;AACf,YAAMU,IAAapa,EAAY,YAAY2N,GAASqM,GAASC,CAAU;AACvE,MAAAP,EAAY,YAAYU;AAExB,YAAMC,IADa,OAAOzM,KAAY,YAAY,OAAO,SAASA,CAAO,IAC3CA,IAAU;AACxC,MAAA8L,EAAY,QAAQ,UAAUW,KAAY,OACtC,GAAGpB,EAAkBoB,CAAQ,CAAC,OAC9B,KACJX,EAAY,QAAQ,WAAWW,KAAY,OACvCA,IAAW,IACT,aACAA,IAAW,IACT,aACA,YACJ;AAAA,IACN;AACA,IAAIV,MACFA,EAAY,YAAY3Z,EAAY,YAAY4N,GAASoM,GAASC,CAAU,IAG9E9Z,EAAI,QAAQ,gBAAgByZ,EAAS,SAAA,GACrCzZ,EAAI,QAAQ,eAAeoT,IAAW4G,EAAc,aAAa,IACjEha,EAAI,QAAQ,cAAc0Z,KAAY,OAAOA,EAAS,aAAa,IACnE1Z,EAAI,QAAQ,UAAUwN,KAAW,OAAOA,EAAQ,aAAa,IAC7DxN,EAAI,QAAQ,UAAUyN,KAAW,OAAOA,EAAQ,aAAa,IAC7DzN,EAAI,QAAQ,gBACV,OAAOmG,EAAS,kBAAmB,YAAY,OAAO,SAASA,EAAS,cAAc,IAClFA,EAAS,eAAe,aACxB,IACNnG,EAAI,QAAQ,aAAa,OAAOmG,EAAS,cAAe,WAAWA,EAAS,aAAa,IACzFnG,EAAI,QAAQ,gBACV,OAAOmG,EAAS,mBAAoB,WAAWA,EAAS,kBAAkB,IAE5E+S,KAAW;AAAA,EACb;AAEA,MAAIA,MAAY;AACd,YAAQ,MAAM,4EAA4E;AAAA,OACrF;AACL,UAAMiB,IAAejB,EAAQ,eAAe,OAAO;AACnD,YAAQ,MAAM,0BAA0BiB,CAAY,qBAAqB;AAAA,EAC3E;AAEA,MAAI;AACF,IAAAC,GAAsBhX,CAAK;AAAA,EAC7B,SAASzE,GAAO;AACd,YAAQ,KAAK,2DAA2DA,CAAK;AAAA,EAC/E;AAGA,MAAI;AACF,UAAM0b,IAAY,IAAIC,MAAyE;AAC7F,iBAAWC,KAAYD,GAAW;AAChC,YAAI,CAACC,EAAU;AACf,cAAM1W,IAAUgT,EAAK,cAAgC0D,CAAQ;AAC7D,YAAI1W,EAAS,QAAOA;AAAA,MACtB;AACA,aAAO;AAAA,IACT,GAEM2W,IAAWH;AAAA,MACf;AAAA,MACA;AAAA,MACA;AAAA,IAAA,GAEII,IAAUJ;AAAA,MACd;AAAA,MACA;AAAA,IAAA,GAGIK,IAAkB,CAACC,GAA8BC,MAA8C;AACnG,UAAI,CAACD,EAAK,QAAO,CAAA;AACjB,YAAM/C,IAAc+C,EAAI,iBAAsC,sBAAsB;AAKpF,cAJa/C,EAAY,SACrB,MAAM,KAAKA,CAAW,IACtB,MAAM,KAAK+C,EAAI,iBAAsC,2BAA2B,CAAC,GAEzE,IAAI,CAAA3a,MAAO;AACrB,cAAM6a,IAAOD,IAAO5a,EAAI,MAAM,KAAK,CAAC,IAAIA,EAAI,MAAM,KAAK,CAAC;AACxD,eAAO,EAAE,SAAS4Z,GAAciB,KAAA,gBAAAA,EAAM,WAAW,EAAA;AAAA,MACnD,CAAC;AAAA,IACH,GACM3S,IAAW;AAAA,MACf,GAAGwS,EAAgBF,GAAU,EAAK;AAAA,MAClC,GAAGE,EAAgBD,GAAS,EAAI;AAAA,IAAA,GAG5BK,IAAqB,MAAM;AAAA,MAC/B1X,EAAM,iBAAsC,wBAAwB;AAAA,IAAA,EACpE,IAAI,CAAApD,MAAO;AACX,YAAM+a,IAAkB/a,EAAI,QAAQ,cAC9Bgb,IAAiBhb,EAAI,QAAQ,aAC7BmH,IAAe4T,IAAkB,OAAO,WAAWA,CAAe,IAAI,OAAO,KAC7ErY,IAAcsY,IAAiB,OAAO,WAAWA,CAAc,IAAI,OAAO;AAChF,aAAO;AAAA,QACL,eAAe,OAAO,SAAS7T,CAAY,IAAIA,IAAe;AAAA,QAC9D,cAAc,OAAO,SAASzE,CAAW,IAAIA,IAAc;AAAA,MAAA;AAAA,IAE/D,CAAC;AAED,IAAAuV,GAAkB/P,GAAU4S,GAAoBjE,CAAI;AAAA,EACtD,SAASlY,GAAO;AACd,YAAQ,KAAK,0DAA0DA,CAAK;AAAA,EAC9E;AACF;AAOA,SAASsc,GAAuB1Q,GAA4E;AAC1G,MAAI,CAACA,KAAW,OAAOA,KAAY;AACjC,WAAO;AAET,QAAMoB,IAASpB,EAAQ;AACvB,MAAI,OAAOoB,KAAW,YAAYA;AAChC,WAAOA;AAET,QAAMuP,IAAY3Q,EAAQ;AAC1B,SAAI,OAAO2Q,KAAc,YAAYA,IAC5BA,IAEF;AACT;AAEA,SAASC,GACP/E,GACAS,GACS;AACT,QAAM3M,IAAgB+Q,GAAuB7E,CAAM;AACnD,MAAI,CAAClM;AACH,mBAAQ,KAAK,sDAAsDkM,CAAM,GAClE;AAGT,QAAMzX,IAAQyX,KAAA,gBAAAA,EAAQ,OAChBgF,IAAsB1L,IAAyB0G,KAAA,gBAAAA,EAAQ,cAAa,CAAA,CAAE;AAC5E,EAAAD,GAAkCjM,GAAekM,CAAM,GAElDzX,MACHyP,GAAsBlE,GAAekR,CAAmB,GACxDrK,GAA8B7G,GAAekR,CAAmB;AAGlE,QAAM/D,IAAST,GAA6BC,GAAM3M,GAAekR,GAAqBzc,CAAK;AAW3F,MATI0Y,EAAO,UACThD,EAAwB,OAAOnK,CAAa,KAE5CmK,EAAwB,IAAInK,GAAe,EAAE,WAAWkR,GAAqB,OAAAzc,GAAO,GAChF0Y,EAAO,WAAW,YACpBG,GAAqBX,GAAM3M,CAAa,IAIxC,CAACvL,KAASyc,EAAoB,SAAS,GAAG;AAC5C,UAAMC,IAAgB,MAAM;AAAA,MAC1B,IAAI;AAAA,QACFD,EACG,IAAI,CAAAE,MAAOA,EAAI,aAAa,EAC5B,OAAO,CAACrL,MAAyB,OAAOA,KAAS,YAAYA,EAAK,SAAS,CAAC;AAAA,MAAA;AAAA,IACjF;AAGF,QAAIoL,EAAc,UAAU,OAAO,SAAW;AAC5C,UAAI;AACF,eAAO;AAAA,UACL,IAAI;AAAA,YACFzG;AAAA,YACA;AAAA,cACE,QAAQ;AAAA,gBACN,eAAA1K;AAAA,gBACA,eAAAmR;AAAA,cAAA;AAAA,YACF;AAAA,UACF;AAAA,QACF;AAAA,MAEJ,SAASE,GAAe;AACtB,gBAAQ;AAAA,UACN;AAAA,UACAA;AAAA,QAAA;AAAA,MAEJ;AAAA,EAEJ;AAEA,SAAO;AACT;AAEO,SAASC,GACdpF,GACAS,GACM;AACN,MAAI,MAAM,QAAQT,CAAM,GAAG;AACzB,QAAIqF,IAAU;AACd,eAAWC,KAAQtF;AACjB,MAAI+E,GAAgCO,GAAM7E,CAAI,MAC5C4E,IAAU;AAGd,IAAI,CAACA,KAAWrF,EAAO,UACrB,QAAQ,KAAK,mEAAmEA,CAAM;AAExF;AAAA,EACF;AAEA,EAAA+E,GAAgC/E,GAAQS,CAAI;AAC9C;AAIA,SAASK,GAA2B/M,GAA8C;AAEhF,QAAM,EAAE,sBAAAwR,GAAsB,sBAAAC,EAAA,IAAyBpQ,GAAA;AACvD,MAAI;AACF,QAAI,OAAOmQ,KAAyB;AAClC,aAAOA,EAAqBxR,CAAS;AAAA,EAEzC,QAAY;AAAA,EAAC;AAEb,MAAIA,EAAU,WAAW;AACvB,WAAO;AAET,QAAM7I,IAAO6I,EAAU,IAAI,CAAAxB,MAAY;AACrC,UAAM7H,IAAc2T,GAA4B9L,CAAQ;AAExD,WAAO;AAAA,MACL,MAAMA,EAAS;AAAA,MACf,kBAAkBA,EAAS;AAAA,MAC3B,gBAAgBA,EAAS;AAAA,MACzB,eAAeA,EAAS;AAAA,MACxB,aAAA7H;AAAA,IAAA;AAAA,EAEJ,CAAC,GAGK8I,IAAMvI;AAAA,IACVC;AAAA,IACA;AAAA,MACE,EAAE,KAAK,QAAQ,OAAO,aAAA;AAAA,MACtB,EAAE,KAAK,oBAAoB,OAAO,WAAW,OAAO,QAAA;AAAA,MACpD,EAAE,KAAK,kBAAkB,OAAO,YAAY,OAAO,QAAA;AAAA,MACnD,EAAE,KAAK,iBAAiB,OAAO,kBAAkB,OAAO,QAAA;AAAA,MACxD,EAAE,KAAK,YAAY,OAAO,OAAO,OAAO,QAAA;AAAA,MACxC,EAAE,KAAK,YAAY,OAAO,KAAK,OAAO,QAAA;AAAA,IAAQ;AAAA,IAEhD,CAAC,kBAAkB,iBAAiB,UAAU;AAAA,EAAA;AAIhD,MAAI;AACF,UAAM6B,IAAM,SAAS,cAAc,UAAU;AAC7C,IAAAA,EAAI,YAAYyG,EAAI,KAAA;AACpB,UAAMxG,IAAQD,EAAI,QAAQ,cAAgC,OAAO;AACjE,QAAIC,GAAO;AACT,MAAAA,EAAM,UAAU,IAAI,oBAAoB;AACxC,YAAMgB,IAAMhB,EAAM,iBAAuC,UAAU,GAC7DyY,IAAU,CAAC,QAAQ,oBAAoB,kBAAkB,iBAAiB,YAAY,UAAU;AACtG,MAAAzX,EAAI,QAAQ,CAACa,GAAIZ,MAAM;AACrB,cAAMvE,IAAM+b,EAAQxX,CAAC;AACrB,QAAKvE,MACLmF,EAAG,aAAa,iBAAiBnF,CAAG,GACpCmF,EAAG,UAAU,IAAI,cAAc;AAAA,MACjC,CAAC,GACgB7B,EAAM,iBAAsC,UAAU,EAC9D,QAAQ,CAAC0Y,GAAI9Y,MAAQ;AAC5B,YAAI8Y,EAAG,UAAU,SAAS,YAAY;AACpC;AAEF,cAAMR,IAAMnR,EAAUnH,CAAG;AACzB,QAAIsY,EAAI,kBACNQ,EAAG,QAAQ,WAAWR,EAAI,gBAE5BQ,EAAG,UAAU,IAAI,cAAc;AAAA,MACjC,CAAC,GACD1Y,EAAM,QAAQ,cAAc,QAC5BA,EAAM,QAAQ,aAAa;AAC3B,YAAM2Y,IAAkBH;AACxB,UAAIG;AACF,YAAI;AACF,UAAAA,EAAgB3Y,CAAK;AAAA,QACvB,SAAS4Y,GAAK;AACZ,kBAAQ,KAAK,2DAA2DA,CAAG;AAAA,QAC7E;AAAA;AAGA1a,QADa8B,EAAM,iBAAsC,UAAU,EAC9D,QAAQ,CAACpD,GAAKgD,MAAQ;AACzB,cAAIhD,EAAI,UAAU,SAAS,YAAY;AACrC;AAEF,gBAAMic,IAAWjc,EAAI,MAAM,KAAK,CAAC;AACjC,cAAI,CAACic;AACH;AAEF,gBAAMtT,IAAWwB,EAAUnH,CAAG,GACxBlC,IAAc2T,GAA4B9L,CAAQ,GAClDuT,IACJ,QAAOpb,KAAA,gBAAAA,EAAa,aAAa,YACjC,OAAO,SAASA,EAAY,QAAQ,IAChCA,EAAY,WACZ,MACAqb,IACJD,KAAgB,OACZ,GAAGA,EAAa,eAAe,SAAS;AAAA,YACtC,uBAAuB;AAAA,YACvB,uBAAuB;AAAA,UAAA,CACxB,CAAC,OACF,KACAE,IACJF,KAAgB,OACZ,YACAA,IAAe,IACb,aACAA,IAAe,IACb,aACA;AACV,UAAAD,EAAS,QAAQ,UAAUE,GAC3BF,EAAS,QAAQ,WAAWG;AAAA,QAC9B,CAAC;AAEH,aAAOhZ,EAAM;AAAA,IACf;AAAA,EACF,SAASC,GAAG;AACV,YAAQ,KAAK,2EAA2EA,CAAC;AAAA,EAC3F;AACA,SAAOuG;AACT;AAEA,SAASwQ,GAAsBhX,GAAsC;AXjnCrE,MAAA2F;AWknCE,MAAI,CAAC3F,EAAO;AACZ,QAAM,EAAE,uBAAuB+H,EAAA,IAAWK,GAAA;AAC1C,MAAI,OAAOL,KAAW;AACpB,QAAI;AACF,MAAAA,EAAO/H,CAAK;AACZ;AAAA,IACF,SAAS4Y,GAAK;AACZ,cAAQ,KAAK,8CAA8CA,CAAG;AAAA,IAChE;AAGF,QAAM1a,IAAO,MAAM,KAAK8B,EAAM,iBAAsC,wBAAwB,CAAC,GAEvFiZ,IAAqB,CAACtc,MAA6C;AACvE,QAAIA,MAAU;AACZ,aAAO;AAET,UAAMO,IAAS,OAAO,WAAWP,CAAK;AACtC,WAAO,OAAO,SAASO,CAAM,IAAIA,IAAS;AAAA,EAC5C,GAEMgc,IAAUhb,EAAK;AAAA,IACnB,CAACgB,GAAKtC,MAAQ;AAEZ,YAAMkQ,IAAgBmM,EAAmBrc,EAAI,QAAQ,aAAa;AASlE,UARIkQ,KAAiB,SACnB5N,EAAI,gBAAgB4N,IAGlBlQ,EAAI,QAAQ,kBAAkB,WAChCsC,EAAI,gBAAgB,KAGlBtC,EAAI,QAAQ,aAAa;AAC3B,eAAAsC,EAAI,kBAAkB,GACfA;AAGT,MAAAA,EAAI,aAAa;AAEjB,YAAM6E,IAAekV,EAAmBrc,EAAI,QAAQ,YAAY,GAC1DwN,IAAU6O,EAAmBrc,EAAI,QAAQ,OAAO,GAChD0C,IAAc2Z,EAAmBrc,EAAI,QAAQ,WAAW;AAE9D,aAAImH,KAAgB,QAAQqG,KAAW,QAAQ9K,KAAe,QAC5DJ,EAAI,kBAAkB,GACfA,MAGTA,EAAI,cAAc6E,GAClB7E,EAAI,cAAckL,GAClBlL,EAAI,eAAeI,GAEZJ;AAAA,IACT;AAAA,IACA;AAAA,MACE,YAAY;AAAA,MACZ,YAAY;AAAA,MACZ,aAAa;AAAA,MACb,cAAc;AAAA,MACd,WAAW;AAAA,MACX,gBAAgB;AAAA,MAChB,eAAe;AAAA,IAAA;AAAA,EACjB,GAGIia,IAAiBD,EAAQ,YAAY,KAAKA,EAAQ,mBAAmB,GACrEE,IAAaD,KAAkBD,EAAQ,cAAc,IAAKA,EAAQ,aAAaA,EAAQ,cAAe,MAAM;AAElH,MAAIrY,IAASb,EAAM,cAAmC,eAAe;AACrE,EAAKa,MACHA,IAAS,SAAS,cAAc,IAAI,GACpCA,EAAO,YAAY,eACnB8E,IAAA3F,EAAM,cAAc,OAAO,MAA3B,QAAA2F,EAA8B,YAAY9E;AAE5C,QAAMwY,IAAsB,KAAK,MAAMH,EAAQ,YAAY,EAAE,eAAe,OAAO,GAC7EI,IAAgB;AAAA,IACpB,gBAAgBJ,EAAQ,iBAAiB,CAACC;AAAA,IAC1C,eAAeA,IAAiBD,EAAQ,aAAa;AAAA,IACrD,aAAaC,IACT;AAAA,MACE,UAAUD,EAAQ;AAAA,MAClB,UAAUE;AAAA,MACV,kBAAkBF,EAAQ;AAAA,MAC1B,kBAAkBE;AAAA,MAClB,QAAQ;AAAA,MACR,gBAAgB;AAAA,IAAA,IAElB;AAAA,EAAA,GAEAG,IAAgB,EAAE,UAAUJ,EAAA,GAE5BxE,IAAmBlY,EAAY,iBAAiB6c,EAAc,eAAeA,GAAeC,CAAa,GACzGC,IAAeL,IAAiBD,EAAQ,aAAa,MACrDJ,IAAeK,IAAiBC,IAAa,MAC7CK,IAAoBhd,EAAY,YAAY+c,GAAcF,GAAeC,CAAa,GACtFG,IAAoBjd,EAAY,YAAYqc,GAAcQ,GAAeC,CAAa;AAE5F,EAAA1Y,EAAO,YAAY;AAAA;AAAA,8BAESwY,CAAmB;AAAA,8BACnB1E,CAAgB;AAAA,8BAChB8E,CAAiB;AAAA,8BACjBC,CAAiB;AAAA;AAE7C,QAAMC,IAAoB9Y,EAAO,MAAM,KAAK,CAAC;AAC7C,EAAI8Y,MACFA,EAAkB,QAAQ,UAAUR,KAAkB,OAAOC,KAAe,WACxE,GAAGzZ,GAAayZ,CAAU,CAAC,OAC3B,KACJO,EAAkB,QAAQ,WAAWR,KAAkB,OAAOC,KAAe,WACzEA,IAAa,IACX,aACAA,IAAa,IACX,aACA,YACJ,YAENvY,EAAO,QAAQ,gBAAgB,KAAK,MAAMqY,EAAQ,YAAY,EAAE,SAAA,GAChErY,EAAO,QAAQ,eAAesY,IAAiBD,EAAQ,WAAW,aAAa,IAC/ErY,EAAO,QAAQ,cAAcsY,IAAiBD,EAAQ,YAAY,aAAa,IAC/ErY,EAAO,QAAQ,UAAUsY,IAAiBD,EAAQ,WAAW,aAAa,IAC1ErY,EAAO,QAAQ,UAAUsY,KAAkB,OAAOC,KAAe,WAAWA,EAAW,aAAa,IACpGvY,EAAO,QAAQ,WAAWsY,IAAiB,SAAS,SACpDtY,EAAO,QAAQ,gBAAgBqY,EAAQ,iBAAiB,CAACC,IAAiB,SAAS;AACrF;AAEA,SAASS,GAAqBjd,GAAwB;AACpD,MAAI,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK;AACpD,WAAOA;AAET,MAAI,OAAOA,KAAU,UAAU;AAC7B,UAAMO,IAAS,OAAO,WAAWP,CAAK;AACtC,WAAO,OAAO,SAASO,CAAM,IAAIA,IAAS;AAAA,EAC5C;AACA,SAAO;AACT;AAEA,SAASyC,GAAa3C,GAAmB;AAEvC,UADgBqM,GAAcrM,GAAG,EAAE,UAAU,EAAA,CAAG,KAAK,GACtC,eAAe,SAAS;AAAA,IACrC,uBAAuB;AAAA,IACvB,uBAAuB;AAAA,EAAA,CACxB;AACH;AAEA,SAAS6X,GACP/P,GACAC,GACA0O,GACM;AACN,QAAMoG,IAAwBpG,KAAQ,UAGhCqG,KADiB,MAAM,QAAQhV,CAAQ,IAAIA,IAAW,CAAA,GAC1B,OAAO,CAAC5F,GAAKuE,MAAU;AACvD,UAAMtE,IAAYsE,EAAM,WAAWA,EAAM,iBAAiBA,EAAM,OAC1D5F,IAAU+b,GAAqBza,CAAS;AAC9C,WAAOD,IAAMrB;AAAA,EACf,GAAG,CAAC,GAGEkc,KADmB,MAAM,QAAQhV,CAAU,IAAIA,IAAa,CAAA,GAC5B,OAAO,CAAC7F,GAAKuE,MAAU;AAC3D,UAAMtE,IAAYsE,EAAM,iBAAiBA,EAAM,OACzC5F,IAAU+b,GAAqBza,CAAS;AAC9C,WAAOD,IAAMrB;AAAA,EACf,GAAG,CAAC,GAEEmc,IAAcF,IAAaC,GAE3BE,IAAaJ,EAAW,cAA2B,aAAa;AACtE,MAAI,CAACI,GAAY;AACf,YAAQ,KAAK,gDAAgD;AAC7D;AAAA,EACF;AAEA,QAAMC,IACJD,EAAW,cAA2B,QAAQ,KAC9CA,EAAW,cAA2B,qBAAqB;AAC7D,EAAIC,IACFA,EAAa,cAAc,GAAGva,GAAaqa,CAAW,CAAC,OAEvDC,EAAW,cAAc,sBAAsBta,GAAaqa,CAAW,CAAC,MAG1EC,EAAW,QAAQ,iBAAiBD,EAAY,SAAA;AAClD;AAiBO,SAASG,GACdnH,GACAS,GACM;AACN,QAAM2G,IAAiB,OAAOpH,KAAW,WAAWA,IAASA,KAAA,gBAAAA,EAAQ,kBAC/DrW,IAAQ+N,GAAiB0P,CAAc,KAAK;AAElD,MAAI,CAAC3G,GAAM;AACT,YAAQ,KAAK,kCAAkC;AAC/C;AAAA,EACF;AAGA,MAAI4G,IACF5G,EAAK,cAA2B,gCAAgC,KAChEA,EAAK,cAA2B,mBAAmB;AAErD,MAAI,CAAC4G,GAAI;AAEP,UAAMC,IACJ7G,EAAK,cAA2B,oBAAoB,KACpDA,EAAK,cAA2B,aAAa,KAC7CA,EAAK,cAA2B,oBAAoB,KACpDA,EAAK,cAA2B,cAAc;AAChD,QAAI,CAAC6G,GAAU;AACb,cAAQ,KAAK,mDAAmD;AAChE;AAAA,IACF;AACA,IAAAD,IAAK,SAAS,cAAc,KAAK,GACjCA,EAAG,YAAY,oBACfC,EAAS,YAAYD,CAAE;AAAA,EACzB;AAGA,EAAIA,EAAG,QAAQ,cAAc,IAC3BA,EAAG,YAAY1d,IACX,+CAA+CA,CAAK,cACpD,mEAGJ0d,EAAG,cAAc1d,IACb,6BAA6BA,CAAK,KAClC;AAER;AAUO,SAAS4d,GAAqBpH,GAAmD;AACtF,MAAIA,KAAe;AACjB;AAEF,QAAMnT,IAAQmT,EAAY,cAAgC,0BAA0B;AACpF,MAAInT,KAAS;AACX;AAEF,QAAMtD,IAAMyW,EAAY,QAAQ,WAAWnT,EAAM,QAAQ,eAAe,QAElE3E,KADW8X,EAAY,QAAQ,WAAWnT,EAAM,QAAQ,cAAc,WAC9B,SAAS,SAAS;AAEhE,EAAAmT,EAAY,QAAQ,UAAUzW,GAC9ByW,EAAY,QAAQ,UAAU9X,GAC9BmF,GAAcR,GAAOtD,GAAKrB,GAAW,EAAI;AAC3C;AAEO,MAAMmf,KAAgB;AAAA,EAC3B,oCAAoClP;AAAA,EACpC,8BAA8BD;AAAA,EAC9B,wBAAgC;AAC9B,WAAO4F,EAAwB;AAAA,EACjC;AAAA,EACA,mBACEnK,GACAC,GACAxL,GACM;AACN,IAAA0V,EAAwB,IAAInK,GAAe,EAAE,WAAAC,GAAW,OAAAxL,GAAO;AAAA,EACjE;AAAA,EACA,sBAA4B;AAC1B,IAAA0V,EAAwB,MAAA,GACxBC,GAAoB,MAAA;AAAA,EACtB;AACF;AAGA,SAASsF,GAActV,GAAwC;AAC7D,SAAIA,KAAO,OAAa,IAEjB;AAAA,IADSA,EAGX,QAAQ,WAAW,GAAG,EACtB,QAAQ,SAAS,EAAE,EACnB,QAAQ,OAAO,EAAE,EACjB,QAAQ,KAAK,GAAG,EAChB,QAAQ,YAAY,EAAE;AAAA,EAAA,KACtB;AACP;AC72CA,MAAMuZ,KAA4D;AAAA,EAChE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEA,SAASC,GACP/d,GACoC;AACpC,SAAO8d,GAAoB,SAAS9d,CAAkC;AACxE;AAEA,SAASge,GACPhe,GACiC;AACjC,SAAOA,MAAU,SAASA,MAAU;AACtC;AAmBA,IAAIie,KAAiC,MACjCC,KAA0C;AAG9C,MAAMC,KAAwB,EAAE,KAAK,GAAG,KAAK,EAAA;AAE7C,SAASnQ,GAAiBhO,GAA+B;AACvD,SAAO2L,GAAiB3L,CAAK;AAC/B;AAEA,SAASoe,GAAepe,GAAiC;AACvD,SAAO,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK;AAC3D;AAEA,SAASqe,GAAsBre,GAA+B;AAC5D,MAAI,OAAOA,KAAU;AACnB,WAAO;AAET,QAAMwF,IAAUxF,EAAM,KAAA;AACtB,MAAI,CAACwF;AACH,WAAO;AAET,QAAM8Y,IAAQ9Y,EAAQ,YAAA;AACtB,SAAI,aAAa,KAAK8Y,CAAK,IAClBA,IAELA,MAAU,MACL,QAEF;AACT;AAEA,SAASC,GACP3V,GACA4V,GACA7R,IAA0B,MACX;AACf,aAAW5M,KAAOye,GAAM;AACtB,UAAMhc,IAAY6b,GAAsBzV,EAAS7I,CAAG,CAAC;AACrD,QAAIyC;AACF,aAAOA;AAAA,EAEX;AACA,SAAOmK;AACT;AAEA,SAAS8R,GACPze,GACA0e,GACe;AACf,SAAKN,GAAepe,CAAK,IAQlB,GAJWA,EAAM,eAAe,SAAS;AAAA,IAC9C,uBAAuBme,GAAsB;AAAA,IAC7C,uBAAuBA,GAAsB;AAAA,EAAA,CAC9C,CACkB,GAAGO,IAAW,IAASA,CAAQ,KAAK,EAAE,KAPhD;AAQX;AAEA,SAASC,GACP/V,GAC0D;AAC1D,QAAMsF,IAAStF,GACT6G,IAAc7G,EAAS,gBAAgB,MACvCtG,IAAcsG,EAAS,eAAe,MAEtCgW,IAAmBL,GAA4BrQ,GAAQ;AAAA,IAC3D;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA,GACCtF,EAAS,iBAAiB,IAAI,GAE3BiW,IACJN,GAA4BrQ,GAAQ;AAAA,IAClC;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA,GACC0Q,MAAqB,QAAQ,QAAQ,IAAI,MAAMA,MAAqB,QAAQ,QAAQ,SAAS,OAE5FE,IAAgB9Q,GAAiByB,KAAA,gBAAAA,EAAa,MAAM,GACpDsP,IAAkB/Q,GAAiByB,KAAA,gBAAAA,EAAa,QAAQ,GACxDuP,IAAiBhR,GAAiByB,KAAA,gBAAAA,EAAa,OAAO,GACtDwP,IAAajR,GAAiByB,KAAA,gBAAAA,EAAa,GAAG,GAE9CyP,IAAgBH,KAAmBD,GACnCK,IAAaF,MAAeJ,MAAoB,QAAQG,IAAiB,OACzEI,IAA2BR,KAAoBC,KAAmB,OAClEQ,IAAgBD,MAA6B;AAEnD,MAAIE,GACAC;AAEJ,EAAKF,KAYHC,IAAkB,OAClBC,IAAeJ,KAAcD,KAAiBF,KAAkB,QAZ5DE,KAAiB,QACnBI,IAAkBF,GAClBG,IAAeL,KACNF,KAAkB,QAC3BM,IAAkBT,GAClBU,IAAeP,MAEfM,IAAkB,OAClBC,IAAeJ,KAAc;AAOjC,QAAMK,IAAcf,GAAwBc,GAAcD,CAAe,GACnEG,IAAgBJ,IAElB,OADAZ,GAAwBU,GAAY,KAAK,GAGvCO,IACJ,CAAC,CAACD,KAAgBA,MAAiBD,GAE/BG,IAAkB,CAAA,GAClBC,IAAsB,CAAA;AAE5B,EAAIJ,KACFG,EAAM;AAAA,IACJ,wDAAwDH,CAAW;AAAA,EAAA,GAErEI,EAAU,KAAKJ,EAAY,QAAQ,WAAW,GAAG,CAAC,MAIlDG,EAAM,KADJ,yHACgB,GAClBC,EAAU,KAAK,0BAA0B,IAGvCF,KAAuBD,MACzBE,EAAM;AAAA,IACJ,0DAA0DF,CAAY;AAAA,EAAA,GAExEG,EAAU,KAAKH,EAAa,QAAQ,WAAW,GAAG,CAAC;AAGrD,QAAMI,IAASF,EAAM,KAAK,MAAM,GAC1BG,IAAY9R,GAAiB1L,KAAA,gBAAAA,EAAa,kBAAkB,KAAK,GACjEyd,IAAYH,EAAU,KAAK,IAAI;AAErC,SAAO,EAAE,QAAAC,GAAQ,WAAAC,GAAW,WAAAC,EAAA;AAC9B;AAQA,MAAMC,yBAAyB,IAAA;AAM7B,SAASnE,GAAqB/X,GAAoD;AAChF,MAAI,CAACA;AACH;AAGF,EADiB,MAAM,KAAKA,EAAQ,iBAAsC,UAAU,CAAC,EAC5E,QAAQ,CAAA7D,MAAO;AACtB,UAAMuZ,IAAcvZ,EAAI,MAAM,KAAK,CAAC,GAC9BwZ,IAAcxZ,EAAI,MAAM,KAAK,CAAC;AAIpC,QAHI,CAACuZ,KAAe,CAACC,KAGjBD,EAAY,QAAQ,WAAWA,EAAY,QAAQ;AACrD;AAEF,UAAMyG,KAAWxG,EAAY,eAAe,IAAI,UAAU;AAC1D,QAAI4C,IAA+C;AACnD,IAAI5C,EAAY,cAAc,WAAW,IACvC4C,IAAU,aACD5C,EAAY,cAAc,WAAW,MAC9C4C,IAAU,aAEZ7C,EAAY,QAAQ,UAAUyG,GAC9BzG,EAAY,QAAQ,WAAW6C;AAAA,EACjC,CAAC;AACH;AAEF,SAAST,GAAqBxR,GAAuD;AACnF,MAAIA,EAAU,WAAW;AACvB,WAAO;AAGT,QAAM5I,IAAO;AAAA,IACX,EAAE,KAAK,QAAQ,OAAO,aAAA;AAAA,IACtB,EAAE,KAAK,oBAAoB,OAAO,WAAW,OAAO,QAAA;AAAA,IACpD,EAAE,KAAK,kBAAkB,OAAO,eAAe,OAAO,QAAA;AAAA,IACtD,EAAE,KAAK,iBAAiB,OAAO,kBAAkB,OAAO,QAAA;AAAA,IACxD,EAAE,KAAK,YAAY,OAAO,OAAO,OAAO,QAAA;AAAA,IACxC,EAAE,KAAK,YAAY,OAAO,KAAK,OAAO,QAAA;AAAA,EAAiB,GAEnDD,IAAO6I,EAAU,IAAI,CAAC8V,MAAM;AAChC,UAAMnf,IAAcyM,GAA4B0S,EAAE,WAAW,GACvDzS,IAAU,QAAO1M,KAAAA,gBAAAA,EAAa,aAAa,WAAWA,EAAY,WAAW,MAC7E2M,IAAU,QAAO3M,KAAAA,gBAAAA,EAAa,aAAa,WAAWA,EAAY,WAAW;AAEnF,WAAO;AAAA,MACL,MACI,OAAOmf,EAAE,QAAS,WACdA,EAAE,OACF,OAAOA,EAAE,QAAS,WAChB,OAAOA,EAAE,IAAI,IACb;AAAA,MACV,kBACE,OAAOA,EAAE,oBAAqB,YAAY,OAAOA,EAAE,oBAAqB,WACpEA,EAAE,mBACF;AAAA,MACN,gBACE,OAAOA,EAAE,kBAAmB,YAAY,OAAOA,EAAE,kBAAmB,WAChEA,EAAE,iBACF;AAAA,MACN,eACE,OAAOA,EAAE,iBAAkB,YAAY,OAAOA,EAAE,iBAAkB,WAC9DA,EAAE,gBACF;AAAA,MACN,UAAUzS;AAAA,MACV,UAAUC;AAAA,IAAA;AAAA,EAEd,CAAC,GAGK7D,IAAMvI,GAAUC,GAAMC,GAAM,CAAC,kBAAkB,iBAAiB,UAAU,CAAC;AAGjF,MAAI;AACF,UAAM4B,IAAM,SAAS,cAAc,UAAU;AAC7C,IAAAA,EAAI,YAAYyG,EAAI,KAAA;AACpB,UAAMxG,IAAQD,EAAI,QAAQ,cAAgC,OAAO;AACjE,QAAIC,GAAO;AACT,MAAAA,EAAM,UAAU,IAAI,oBAAoB;AACtC,YAAMgB,IAAM,MAAM,KAAKhB,EAAM,iBAA8B,UAAU,CAAC;AACtE,aAAA7B,EAAK,QAAQ,CAAC2e,GAAK7b,MAAM;AACvB,cAAMY,IAAKb,EAAI,GAAGC,CAAC;AACnB,QAAKY,MAGLA,EAAG,aAAa,iBAAiBib,EAAI,GAAG,GACxCjb,EAAG,UAAU,IAAI,cAAc;AAAA,MACjC,CAAC,GACY7B,EAAM,iBAAsC,UAAU,EAC9D,QAAQ,CAAC0Y,GAAI9Y,MAAQ;AAI5B,YAHI8Y,EAAG,UAAU,SAAS,YAAY,KAGlC9Y,KAAOmH,EAAU;AACnB;AAEF,cAAMmR,IAAMnR,EAAUnH,CAAG,GACnBgE,IAAe,OAAOsU,EAAI,iBAAkB,WAAWA,EAAI,gBAAgB;AACjF,QAAItU,MACF8U,EAAG,QAAQ,WAAW9U,IAEpB8U,EAAG,UAAU,IAAI,cAAc;AAC/B,cAAMqE,IAAerE,EAAG,MAAM,KAAK,CAAC;AACtC,YAAIqE,GAAc;AAChB,gBAAM,EAAE,QAAAP,GAAQ,WAAAC,GAAW,WAAAC,EAAA,IAAcpB,GAA0BpD,CAAG;AACtE,UAAA6E,EAAa,YAAYP,GACzBO,EAAa,QAAQ,YAAY,OAAON,CAAS,GAC7CC,IACFK,EAAa,aAAa,cAAcL,CAAS,IAEjDK,EAAa,gBAAgB,YAAY;AAAA,QAE7C;AACE,cAAMlE,IAAWH,EAAG,MAAM,KAAK,CAAC;AAClC,YAAIG,GAAU;AACZ,gBAAMnb,IAAcyM,GAA4B+N,EAAI,WAAW,GACzDY,IACJ,QAAOpb,KAAAA,gBAAAA,EAAa,aAAa,YAAY,OAAO,SAASA,EAAY,QAAQ,IAC7EA,EAAY,WACZ,MACAqb,IACJD,KAAgB,OACZ,GAAGA,EAAa,eAAe,SAAS;AAAA,YACtC,uBAAuB;AAAA,YACvB,uBAAuB;AAAA,UAAA,CACxB,CAAC,OACF,KACAE,IACJF,KAAgB,OACZ,YACAA,IAAe,IACb,aACAA,IAAe,IACb,aACA;AACV,UAAAD,EAAS,QAAQ,UAAUE,GAC3BF,EAAS,QAAQ,WAAWG;AAAA,QAC9B;AACE,cAAM5C,IAAcsC,EAAG,MAAM,KAAK,CAAC;AACrC,QAAItC,KACFA,EAAY,UAAU,IAAI,eAAe;AAAA,MAE7C,CAAC,GAEDpW,EAAM,QAAQ,cAAc,QAC5BA,EAAM,QAAQ,aAAa,OAC3BwY,GAAqBxY,CAAK,GACnBA,EAAM;AAAA,IACf;AAAA,EACF,SAASC,GAAG;AAEV,YAAQ,KAAK,oEAAoEA,CAAC;AAAA,EACpF;AACA,SAAOuG;AACT;AAGO,SAASwW,GACdjW,GACQ;AACR,QAAM3E,IAAakK,GAAyBvF,KAAa,EAAE;AAC3D,SAAOwR,GAAqBnW,CAAU;AACxC;AAEA,SAAS6a,GAA+BxJ,GAA0B3M,GAA6B;AAC7F,MAAI,CAACA,EAAe;AACpB,QAAM4M,IAAaD,EAAK;AAAA,IACtB,sCAAsC3M,CAAa;AAAA,EAAA;AAErD,MAAI,CAAC4M,EAAY;AACf,QAAMC,IAAYD,EAAW,cAAsC,sBAAsB;AACzF,EAAKC,MACDA,EAAU,iCAEdA,EAAU,+BAA+B,IAE3CA,EAAU,iBAAiB,SAAS,CAAC3X,MAAsB;AACzD,UAAMkhB,IAASlhB,EAAM;AACrB,QAAI,EAAEkhB,aAAkB;AACtB;AAGF,UAAMC,IAAcD,EAAO,QAAQ,WAAW;AAC9C,QAAIC,KAAexJ,EAAU,SAASwJ,CAAW;AAC/C;AAGF,UAAMvgB,IAAMsgB,EAAO,QAA6B,mBAAmB;AACnE,QAAI,CAACtgB,KAAO,CAAC+W,EAAU,SAAS/W,CAAG;AACjC;AAGF,UAAMgH,IAAehH,EAAI,aAAa,eAAe;AACrD,QAAKgH;AAIL,UAAI;AAEF,QADewZ,GAAmBxZ,CAAY,KAE5C,QAAQ,KAAK,+EAA+EA,CAAY;AAAA,MAE5G,SAASgV,GAAK;AACZ,gBAAQ,MAAM,sEAAsEA,CAAG;AAAA,MACzF;AAAA,EACF,CAAC;AACH;AAEO,SAASrF,GAA6BE,GAA0B3M,GAA6B;AAClG,EAAAmW,GAA+BxJ,GAAM3M,CAAa;AACpD;AAGA,SAASuW,GAA8BC,GAAiD;AACtF,UAAQ,MAAM,yCAAyCA,EAAO,QAAQ,YAAY;AAChF,QAAM5e,IAAkB,CAAC/B,MACnBA,KAAS,QAGT,OAAOA,KAAU,YAAY,OAAOA,KAAU,YAAY,OAAOA,KAAU,YACtE,KAEF,OAAOA,CAAK,EAChB,QAAQ,MAAM,OAAO,EACrB,QAAQ,MAAM,QAAQ;AAG7B,MAAIgC,IAAO;AAQX,EAPa;AAAA,IACX,EAAE,KAAK,QAAQ,OAAO,OAAA;AAAA,IACtB,EAAE,KAAK,kBAAkB,OAAO,qBAAqB,OAAO,QAAA;AAAA,IAC5D,EAAE,KAAK,iBAAiB,OAAO,kBAAkB,OAAO,QAAA;AAAA,IACxD,EAAE,KAAK,YAAY,OAAO,cAAc,OAAO,QAAA;AAAA,IAC/C,EAAE,KAAK,YAAY,OAAO,KAAK,OAAO,QAAA;AAAA,EAAQ,EAE3C,QAAQ,CAAAC,MAAK;AAChB,UAAM2e,IAAQ3e,EAAE,UAAU,UAAU,yBAAyB;AAC7D,IAAAD,KAAQ,MAAM4e,CAAK,IAAI3e,EAAE,KAAK;AAAA,EAChC,CAAC,GACDD,KAAQ,wBAEN2e,EAAO,QAAQ,CAAAE,MAAK;AAClB,UAAM1Q,IAAgB,OAAO,SAAS0Q,EAAE,cAAc,IAAIA,EAAE,iBAAiB,GACvEle,IAAc,OAAO,SAASke,EAAE,YAAY,IAAIA,EAAE,eAAe,GACjEzZ,IACJyZ,EAAE,YAAY,OAAOA,EAAE,iBAAkB,YAAY,OAAO,SAASA,EAAE,aAAa,IAChFA,EAAE,gBACF,MACAxN,IAAWjM,MAAiB,MAC9BrG,IAAc8f,EAAE,aAChBpT,IACJ,OAAOoT,EAAE,YAAa,WAClBA,EAAE,WACF,QAAO9f,KAAAA,gBAAAA,EAAa,aAAa,WAC/BA,EAAY,WACZ,MACF2M,IACJ,OAAOmT,EAAE,YAAa,WAClBA,EAAE,WACF,QAAO9f,KAAAA,gBAAAA,EAAa,aAAa,WAC/BA,EAAY,WACZ,MACF+f,IAAeD,EAAE,kBAAkBxN,GACnC0N,IACJ,OAAOF,EAAE,kBAAmB,YAAY,OAAO,SAASA,EAAE,cAAc,IACpEA,EAAE,iBACF,IACAG,IAAoB,OAAOH,EAAE,cAAe,WAAWA,EAAE,aAAa,IACtEI,KACJ,OAAOJ,EAAE,mBAAoB,WAAWA,EAAE,kBAAkB,IAExDK,IAAWlB,GAAmB,IAAIa,EAAE,IAAI,GACxCM,IAAcD,IAAW,8BAA8B,oBACvDE,IAAW,qBAAqBP,EAAE,IAAI,IACtC/G,IAAU;AAAA,MACd,gBAAgB+G,EAAE;AAAA,MAClB,eAAezZ;AAAA,MACf,UAAUqG;AAAA,MACV,UAAUC;AAAA,IAAA,GAEN2T,KAAe,EAAE,UAAAhO,EAAA,GACjB2E,KAAmBlY,EAAY,iBAAiBga,EAAQ,eAAeA,GAASuH,EAAY,GAC5F7H,KAAc1Z,EAAY,YAAYga,EAAQ,UAAUA,GAASuH,EAAY,GAC7E5H,KAAc3Z,EAAY,YAAYga,EAAQ,UAAUA,GAASuH,EAAY,GAE7EC,KAAejO,KAAY,OAAO3F,KAAY,YAAY,OAAO,SAASA,CAAO,IACnF,GAAG1K,EAAa0K,CAAO,CAAC,OACxB,IACE6T,KAAclO,KAAY,OAAO3F,KAAY,YAAY,OAAO,SAASA,CAAO,IACjFA,IAAU,IAAI,aAAaA,IAAU,IAAI,aAAa,YACvD,IAEI8T,KAAsBnO,KAAY,OAAOjM,KAAiB,YAAY,OAAO,SAASA,CAAY,IACpGA,IACA,IACEqa,KAAiBpO,KAAY,OAAO5F,KAAY,YAAY,OAAO,SAASA,CAAO,IAAIA,IAAU,IACjGiU,KAAiBrO,KAAY,OAAO3F,KAAY,YAAY,OAAO,SAASA,CAAO,IAAIA,IAAU,IACjGiU,KAAoB,OAAOxR,CAAa;AAEhD,QAAIyR,KAAoB;AACxB,IAAIN,OACFM,KAAoB,mBAAmB7f,EAAgBuf,EAAY,CAAC,qBAAqBvf,EAAgBwf,EAAW,CAAC,MAEnHT,MACFc,MAAqB,yBAGrB5f,KAAQ;AAAA,oCACsB6e,EAAE,IAAI;AAAA,yCACDc,EAAiB;AAAA,wCAClB5f,EAAgByf,EAAmB,CAAC;AAAA,uCACrCzf,EAAgBY,CAAW,CAAC;AAAA,mCAChCZ,EAAgB0f,EAAc,CAAC;AAAA,iCACjC1f,EAAgB2f,EAAc,CAAC;AAAA,kCAC9BrO,IAAW,SAAS,OAAO;AAAA,uCACtBwN,EAAE,iBAAiB,SAAS,OAAO;AAAA,uCACnC9e,EAAgBgf,CAAoB,CAAC;AAAA,mCACzChf,EAAgBif,CAAiB,CAAC;AAAA,wCAC7Bjf,EAAgBkf,EAAoB,CAAC;AACzE,UAAMY,KAAWrO,GAAWqN,EAAE,IAAI,GAC5B5M,KAAcP,GAAgBmN,EAAE,QAAQ,EAAE,gBAAgB,oBAAoB;AACpF,IAAA7e,KAAQ;AAAA;AAAA,yBAEamf,CAAW;AAAA,kCACFN,EAAE,IAAI;AAAA,iCACPK,IAAW,SAAS,OAAO;AAAA,iCAC3BE,CAAQ;AAAA,gCACTF,IAAW,MAAM,GAAG;AAAA,yCACXW,EAAQ,UAAU5N,EAAW;AAAA;AAAA;AAGhE,UAAM6N,KAAuB3R,EAAc,eAAe,OAAO;AACjE,IAAAnO,KAAQ,2BAA2B8f,EAAoB,SACzD9f,KAAQ,2BAA2BgW,EAAgB,SACnDhW,KAAQ,0BAA0B4f,EAAiB,IAAIpI,EAAW,SAClExX,KAAQ,yCAAyCyX,EAAW,SAC5DzX,KAAQ,SAERA,KAAQ,+BAA+Bkf,IAAW,KAAK,SAAS;AAAA,kCAClCL,EAAE,IAAI;AAAA,sBAClBO,CAAQ;AAAA;AAAA,6CAEeP,EAAE,IAAI;AAAA;AAAA,2CAERK,IAChC3S,GAAsBsS,EAAE,IAAI,IAC3BjF,GAAqBpN,GAAsBqS,EAAE,IAAI,CAAC,IAClD,kDACF,EACJ;AAAA;AAAA;AAAA,EAGJ,CAAC;AAEC,QAAMkB,IAAkBpB,EAAO,OAAO,CAAAE,MAAK,OAAOA,EAAE,iBAAkB,YAAY,OAAO,SAASA,EAAE,aAAa,CAAC,GAC5GmB,IAAerB,EAAO,OAAO,CAACnc,GAAGqc,MAAMrc,KAAK,OAAO,SAASqc,EAAE,cAAc,IAAIA,EAAE,iBAAiB,IAAI,CAAC,GAC1GoB,IAAaF,EAAgB,OAAO,CAACvd,GAAGqc,MACxC,OAAOA,EAAE,iBAAkB,YAAY,OAAO,SAASA,EAAE,aAAa,IACjErc,IAAIqc,EAAE,gBAERrc,GACN,CAAC,GACE0d,IAAcH,EAAgB,OAAO,CAACvd,GAAGqc,MACzC,OAAOA,EAAE,gBAAiB,YAAY,OAAO,SAASA,EAAE,YAAY,IAC/Drc,IAAIqc,EAAE,eAERrc,GACN,CAAC,GACE2d,IAAaJ,EAAgB,OAAO,CAACvd,GAAGqc,MAAM;AZ3mBtD,QAAA7X;AY4mBI,QAAI,SAAOA,IAAA6X,EAAE,gBAAF,gBAAA7X,EAAe,aAAa,YAAY,OAAO,SAAS6X,EAAE,YAAY,QAAQ;AACvF,aAAOrc,IAAIqc,EAAE,YAAY;AAE3B,UAAMtQ,IAAU,OAAOsQ,EAAE,iBAAkB,YAAY,OAAO,SAASA,EAAE,aAAa,IAAIA,EAAE,gBAAgB,GACtGlH,IAAW,OAAOkH,EAAE,gBAAiB,YAAY,OAAO,SAASA,EAAE,YAAY,IAAIA,EAAE,eAAe;AAC1G,WAAOrc,KAAK+L,IAAUoJ;AAAA,EACxB,GAAG,CAAC,GACEyI,IAAcL,EAAgB,SAAS,GACvCM,IAAeN,EAAgB,WAAWpB,EAAO,QACjDlE,IAAa2F,KAAeF,IAAc,IAAKC,IAAaD,IAAe,MAAM,MAEjFI,IAAa;AAAA,IACjB,gBAAgBD;AAAA,IAChB,eAAeD,IAAcH,IAAa;AAAA,IAC1C,UAAUG,IAAcD,IAAa;AAAA,IACrC,UAAUC,IAAc3F,IAAa;AAAA,EAAA,GAEjC8F,IAAa,EAAE,UAAUH,EAAA,GACzBI,IAAiB1iB,EAAY,iBAAiBwiB,EAAW,eAAeA,GAAYC,CAAU,GAC9FE,IAAiB3iB,EAAY,YAAYwiB,EAAW,UAAUA,GAAYC,CAAU,GACpFG,IAAiB5iB,EAAY,YAAYwiB,EAAW,UAAUA,GAAYC,CAAU;AAE1F,MAAII,IAAuB;AAC3B,MAAIP,KAAe,OAAO3F,KAAe,YAAY,OAAO,SAASA,CAAU,GAAG;AAChF,UAAMmG,IAAkB,GAAG5f,EAAayZ,CAAU,CAAC,MAC7CoG,IAAiBpG,IAAa,IAAI,aAAaA,IAAa,IAAI,aAAa;AACnF,IAAAkG,IAAuB,mBAAmB5gB,EAAgB6gB,CAAe,CAAC,qBAAqB7gB,EAAgB8gB,CAAc,CAAC;AAAA,EAChI;AACA,EAAIR,MACFM,KAAwB;AAGxB,QAAMG,IAAkB,OAAO,KAAK,MAAMd,CAAY,CAAC,GACjDe,IAAiBX,IAAc,OAAOH,CAAU,IAAI,IACpDe,IAAkBZ,IAAc,OAAOF,CAAW,IAAI,IACtDe,IAAiBb,IAAc,OAAOD,CAAU,IAAI,IACpDe,IAAiBd,KAAe,OAAO3F,KAAe,YAAY,OAAO,SAASA,CAAU,IAC9F,OAAOA,CAAU,IACjB;AAEJ,SAAAza,KAAQ;AAAA,6BACiB8gB,CAAe;AAAA,4BAChB/gB,EAAgBghB,CAAc,CAAC;AAAA,2BAChChhB,EAAgBihB,CAAe,CAAC;AAAA,uBACpCjhB,EAAgBkhB,CAAc,CAAC;AAAA,uBAC/BlhB,EAAgBmhB,CAAc,CAAC;AAAA,wBAC9Bd,IAAc,SAAS,OAAO;AAAA,6BACzBC,IAAe,SAAS,OAAO;AAAA;AAAA,gCAE5B,KAAK,MAAML,CAAY,EAAE,eAAe,OAAO,CAAC;AAAA,8BAClDQ,CAAc;AAAA,6BACfG,CAAoB,IAAIF,CAAc;AAAA,4CACvBC,CAAc;AAAA,UAGxD1gB,KAAQ,oBACDA;AACT;AAEA,SAASmhB,GAAsB5C,GAAkF;AAC/G,MAAIA,aAAkB;AACpB,WAAOA;AAET,MAAIA,KAAU,mBAAmBA,GAAQ;AACvC,UAAM6C,IAAU7C,EAAsB,cAAgC,kCAAkC;AACxG,QAAI6C;AACF,aAAOA;AAET,UAAMC,IAAU9C,EAAsB,cAAgC,wBAAwB;AAC9F,QAAI8C;AACF,aAAOA;AAET,UAAMC,IAAW/C,EAAsB,cAAgC,OAAO;AAC9E,QAAI+C;AACF,aAAOA;AAAA,EAEX;AACA,SAAO,SAAS,cAAgC,mDAAmD,KACjG,SAAS,cAAgC,wBAAwB;AACrE;AAEA,SAASC,GAAkBvjB,GAA0C;AACnE,MAAIA,MAAU;AACZ,WAAO;AAET,QAAMW,IAAM,OAAOX,CAAK;AACxB,SAAO,OAAO,SAASW,CAAG,IAAIA,IAAM;AACtC;AAEO,SAAS6iB,GAA6BjD,GAA+D;AACxG,QAAMld,IAAQ8f,GAAsB5C,CAAM;AAC1C,MAAI,CAACld;AACH;AAEF,QAAMY,IAAQZ,EAAM,QAAQ,KAAK,CAAC;AACpC,MAAI,CAACY;AACH;AAEF,QAAM1C,IAAO,MAAM,KAAK0C,EAAM,iBAAsC,kBAAkB,CAAC;AACvF,MAAI,CAAC1C,EAAK;AACR;AAGF,MAAIygB,IAAe,GACfC,IAAa,GACbC,IAAc,GACdC,IAAa,GACbsB,IAAc,IACdC,IAAkB,IAClB/c,IAAgB;AAEpB,aAAW1G,KAAOsB,GAAM;AACtB,UAAMmY,IAAW6J,GAAkBtjB,EAAI,QAAQ,aAAa;AAC5D,IAAIyZ,KAAY,SACdsI,KAAgBtI,IAGdzZ,EAAI,QAAQ,kBAAkB,WAChC0G,IAAgB;AAGlB,UAAMgd,IAAe1jB,EAAI,QAAQ;AAEjC,QAAI,CADa,EAAE0jB,MAAiB,WAAWA,MAAiB,OAAOA,MAAiB,MAAMA,KAAgB,OAC/F;AACb,MAAAD,IAAkB;AAClB;AAAA,IACF;AAEA,IAAAD,IAAc;AAEd,UAAMrc,IAAemc,GAAkBtjB,EAAI,QAAQ,YAAY,GACzDwN,IAAU8V,GAAkBtjB,EAAI,QAAQ,OAAO,GAC/C0C,IAAc4gB,GAAkBtjB,EAAI,QAAQ,WAAW;AAE7D,QAAImH,KAAgB,QAAQqG,KAAW,QAAQ9K,KAAe,MAAM;AAClE,MAAA+gB,IAAkB;AAClB;AAAA,IACF;AAEA,IAAAzB,KAAc7a,GACd+a,KAAc1U,GACdyU,KAAevf;AAAA,EACjB;AAEA,QAAM6Z,IAAiBiH,KAAeC,GAChCjH,IAAaD,KAAkB0F,IAAc,IAAKC,IAAaD,IAAe,MAAM;AAE1F,MAAIhe,IAAS,MAAM,KAAKD,EAAM,QAAQ,EAAE;AAAA,IAAK,CAAC2f,MAC5CA,aAAiB,uBAAuBA,EAAM,UAAU,SAAS,YAAY;AAAA,EAAA;AAE/E,EAAK1f,MACHA,IAAS,SAAS,cAAc,IAAI,GACpCA,EAAO,UAAU,IAAI,YAAY,GACjCD,EAAM,YAAYC,CAAM;AAG1B,QAAMwY,IAAsB,KAAK,MAAMsF,CAAY,EAAE,eAAe,OAAO,GAErErF,IAAgB;AAAA,IACpB,gBAAgBhW,KAAiB,CAAC6V;AAAA,IAClC,eAAeA,IAAiByF,IAAa;AAAA,IAC7C,UAAUzF,IAAiB2F,IAAa;AAAA,IACxC,UAAU3F,IAAiBC,IAAa;AAAA,EAAA,GAEpCG,IAAgB,EAAE,UAAUJ,EAAA,GAE5BqH,IAAmB/jB,EAAY,iBAAiB6c,EAAc,eAAeA,GAAeC,CAAa,GACzGkH,IAAchkB,EAAY,YAAY6c,EAAc,UAAUA,GAAeC,CAAa,GAC1FmH,IAAcjkB,EAAY,YAAY6c,EAAc,UAAUA,GAAeC,CAAa;AAE9F,EAAA1Y,EAAO,YAAY;AAAA;AAAA,gCAESwY,CAAmB;AAAA,gCACnBmH,CAAgB;AAAA,gCAChBC,CAAW;AAAA,gCACXC,CAAW;AAAA;AAEvC,QAAM/G,IAAoB9Y,EAAO,MAAM,KAAK,CAAC;AAC/C,EAAI8Y,MACFA,EAAkB,QAAQ,UAAUR,KAAkB,OAAOC,KAAe,WACxE,GAAGzZ,EAAayZ,CAAU,CAAC,OAC3B,KACJO,EAAkB,QAAQ,WAAWR,KAAkB,OAAOC,KAAe,WACxEA,IAAa,IAAI,aAAaA,IAAa,IAAI,aAAa,YAC7D,YAENvY,EAAO,QAAQ,gBAAgB,OAAO,KAAK,MAAM8d,CAAY,CAAC,GAC9D9d,EAAO,QAAQ,eAAesY,IAAiB,OAAOyF,CAAU,IAAI,IACpE/d,EAAO,QAAQ,cAAcsY,IAAiB,OAAO0F,CAAW,IAAI,IACpEhe,EAAO,QAAQ,UAAUsY,IAAiB,OAAO2F,CAAU,IAAI,IAC/Dje,EAAO,QAAQ,UAAUsY,KAAkB,OAAOC,KAAe,WAAW,OAAOA,CAAU,IAAI,IACjGvY,EAAO,QAAQ,WAAWsY,IAAiB,SAAS,SACpDtY,EAAO,QAAQ,gBAAgByC,IAAgB,SAAS;AAC1D;AAgCO,SAASgQ,GAAgCG,GAA0B3M,GAA6B;AACrG,MAAI,CAACA,EAAe;AACpB,QAAM4M,IAAaD,EAAK;AAAA,IACtB,sCAAsC3M,CAAa;AAAA,EAAA;AAErD,MAAI,CAAC4M,EAAY;AACf,QAAMC,IAAYD,EAAW,cAAsC,sBAAsB;AACzF,MAAI,CAACC,EAAW;AAChB,QAAM3T,IAAQ2T,EAAU,cAAoC,0BAA0B;AACxF,MAAI,CAAC3T,KAASA,EAAM,uBAAwB;AAE5C,EAAAA,EAAM,yBAAyB;AAE/B,QAAM2gB,IAAY,CAChBjkB,GACAgE,MACS;AACT,UAAME,IAAQZ,EAAM,cAAuC,OAAO;AAClE,QAAI,CAACY,EAAO;AACZ,UAAM1C,IAAO,MAAM,KAAK0C,EAAM,iBAAsC,IAAI,CAAC,EACtE,OAAO,OAAK,CAAC9B,EAAE,UAAU,SAAS,YAAY,CAAC,GAC5C+B,IAASD,EAAM,cAAmC,eAAe,GAEjEggB,IAAW,CAAC1f,MAA2C;AAC3D,UAAIA,KAAO,KAAM,QAAO;AAExB,YAAMjE,IAAUiE,EACb,QAAQ,WAAW,GAAG,EACtB,QAAQ,SAAS,EAAE,EACnB,QAAQ,OAAO,EAAE,EACjB,QAAQ,KAAK,GAAG,EAChB,QAAQ,YAAY,EAAE,GACnBrD,IAAU,OAAO,WAAWZ,CAAO;AACzC,aAAO,OAAO,SAASY,CAAO,IAAIA,IAAU;AAAA,IAC9C;AAEA,IAAAK,EAAK,KAAK,CAACiD,GAAGC,MAAM;AAShB,YAAMN,IARoD;AAAA,QACxD,MAAM;AAAA,QACN,kBAAkB;AAAA,QAClB,gBAAgB;AAAA,QAChB,eAAe;AAAA,QACf,UAAU;AAAA,QACV,UAAU;AAAA,MAAA,EAEUpE,CAAG,GACjBmkB,IAAU1f,EAAE,MAAM,KAAKL,CAAM,GAC7BggB,IAAU1f,EAAE,MAAM,KAAKN,CAAM;AAErC,UAAIO,IAAQ;AACZ,UAAIwf,GAAS;AACX,cAAMra,IAAMqa,EAAQ;AACpB,QAAI,OAAOra,KAAQ,aACjBnF,IAAQmF,EAAI,KAAA;AAAA,MAEhB;AAEA,UAAIlF,IAAQ;AACZ,UAAIwf,GAAS;AACX,cAAMta,IAAMsa,EAAQ;AACpB,QAAI,OAAOta,KAAQ,aACjBlF,IAAQkF,EAAI,KAAA;AAAA,MAEhB;AAEE,YAAMua,IAAmB,CACvBtJ,GACAuJ,MACW;AACX,cAAMC,IAAWxJ,IAAOA,EAAK,QAAQ,YAAY;AACjD,YAAIwJ,KAAY,QAAQA,MAAa,IAAI;AACvC,gBAAMC,IAAc,OAAOD,CAAQ;AACnC,cAAI,OAAO,SAASC,CAAW;AAC7B,mBAAOA;AAAA,QAEX;AACA,eAAON,EAASI,CAAI;AAAA,MACtB;AAEJ,UAAIG;AACJ,UAAIzkB,MAAQ;AACV,QAAAykB,IAAO9f,EAAM,cAAcC,GAAO,MAAM,EAAE,aAAa,QAAQ;AAAA,WAC1D;AACL,cAAM8f,IAASL,EAAiBF,GAASxf,CAAK,GACxCggB,IAASN,EAAiBD,GAASxf,CAAK;AAC9C,QAAA6f,IAAOC,IAASC;AAAA,MAClB;AACA,aAAO3gB,MAAQ,QAAQygB,IAAO,CAACA;AAAA,IACjC,CAAC,GAGDnhB,EAAM,iBAAiB,sBAAsB,EAAE,QAAQ,CAAA6B,MAAM;AAC3DA,MAAAA,EAAG,UAAU,OAAO,eAAe,WAAW,UAAU;AAAA,IAC1D,CAAC;AAGD,UAAMA,IAAK7B,EAAM,cAA2B,2BAA2BtD,CAAG,IAAI;AAC9E,IAAImF,KACFA,EAAG,UAAU,IAAI,eAAenB,MAAQ,QAAQ,YAAY,UAAU,GAIxExC,EAAK,QAAQ,CAAAY,MAAK8B,EAAM,YAAY9B,CAAC,CAAC,GAClC+B,KAAQD,EAAM,YAAYC,CAAM;AAAA,EACtC,GAGMygB,IAAe3N,EAAU,QAAQ,SACjC4N,IAAe5N,EAAU,QAAQ,SACjC6N,IAAaxhB,EAAM,QAAQ,aAC3ByhB,IAAazhB,EAAM,QAAQ,YAE3B0hB,IAAahH,GAA4B4G,CAAY,IACvDA,IACA5G,GAA4B8G,CAAU,IACpCA,IACA,QACAG,IAAahH,GAAyB4G,CAAY,IACpDA,IACA5G,GAAyB8G,CAAU,IACjCA,IACA;AAEN,EAAAd,EAAUe,GAAYC,CAAU,GAEhC3hB,EAAM,iBAAiB,SAAS,CAAChE,MAAsB;AACrD,UAAMkhB,IAASlhB,EAAM;AACrB,QAAI,EAAEkhB,aAAkB;AACtB;AAEF,UAAMrb,IAAKqb,EAAO,QAAQ,mBAAmB;AAC7C,QAAI,CAACrb,KAAM,CAAC7B,EAAM,SAAS6B,CAAE,EAAG;AAChC,UAAM+f,IAAU/f,EAAG,aAAa,eAAe;AAC/C,QAAI,CAAC6Y,GAA4BkH,CAAO;AACtC;AAGF,QAAIlhB,IAA8B;AAClC,IAAIiT,EAAU,QAAQ,YAAYiO,MAIhClhB,KAHiBia,GAAyBhH,EAAU,QAAQ,OAAO,IAC/DA,EAAU,QAAQ,UAClB,WACe,QAAQ,SAAS,QAEtCA,EAAU,QAAQ,UAAUiO,GAC5BjO,EAAU,QAAQ,UAAUjT,GAC5BigB,EAAUiB,GAASlhB,CAAG;AAAA,EACxB,CAAC;AACH;AAGA,eAAemhB,GACb/a,GACAqM,GACAM,GACe;AACf,MAAI,CAAC3M,KAAiB,CAAC8T,MAAY,CAACC,GAAiB;AAErD,QAAMiH,IAAkB3O,KAAeM,EAAK;AAAA,IAC1C,sCAAsC3M,CAAa;AAAA,EAAA;AAErD,MAAI,CAACgb;AACH;AAGF,QAAMpO,IAAaoO,EAAgB,QAA6B,oBAAoB;AACpF,MAAI,EAAApO,KAAcA,EAAW,UAAU,SAAS,QAAQ,IAIxD;AAAA,IAAAoO,EAAgB,YAAY;AAC5B,QAAI;AACF,YAAMC,IAAmC,MAAMlb;AAAA,QAC7C+T;AAAA,QACAC;AAAA,QACA/T;AAAA,MAAA;AAEF,UAAIib,EAAK,OAAO;AACd,cAAMC,IAAY,OAAOD,EAAK,SAAU,WAAWA,EAAK,QAAQ,OAAOA,EAAK,KAAK;AACjF,QAAAD,EAAgB,YAAY,sBAAsBE,CAAS,8CAA8Clb,CAAa;AACtH;AAAA,MACF;AACA,YAAMkR,IAAsB1L;AAAA,QAC1B,MAAM,QAAQyV,EAAK,SAAS,IAAIA,EAAK,YAAY,CAAA;AAAA,MAAC;AAEpD,MAAA/W,GAAsBlE,GAAekR,CAAmB,GACxDrK,GAA8B7G,GAAekR,CAAmB,GAChE8J,EAAgB,YAAYvJ,GAAqBP,CAAmB;AAEpE,UAAI;AACF,QAAA1E,GAAgCG,GAAM3M,CAAa;AAAA,MACrD,SAASvL,GAAO;AACd,gBAAQ,KAAK,kEAAkEA,CAAK;AAAA,MACtF;AACA,UAAI;AACF,QAAAgY,GAA6BE,GAAM3M,CAAa;AAAA,MAClD,SAASvL,GAAO;AACd,gBAAQ,KAAK,6EAA6EA,CAAK;AAAA,MACjG;AAAA,IACF,SAASA,GAAO;AACd,YAAM0mB,IAAU1mB,aAAiB,QAAQA,EAAM,UAAU,OAAOA,CAAK;AACrE,MAAAumB,EAAgB,YAAY,8BAA8BG,CAAO,8CAA8Cnb,CAAa;AAAA,IAC9H;AAAA;AACF;AAGA,eAAeob,GACbzO,GACA0D,GACAgL,IAAY,KACZC,IAAa,IACM;AACnB,QAAMC,IAAQ,YAAY,IAAA;AAC1B,SAAO,IAAI,QAAQ,CAACC,MAAY;AAC9B,UAAMC,IAAO,MAAM;AACjB,YAAMlI,IAAK5G,EAAK,cAAiB0D,CAAQ;AACzC,UAAIkD,GAAI;AACN,QAAAiI,EAAQjI,CAAE;AACV;AAAA,MACF;AACA,UAAI,YAAY,QAAQgI,IAAQF,GAAW;AACzC,QAAAG,EAAQ,IAAI;AACZ;AAAA,MACF;AACA,iBAAWC,GAAMH,CAAU;AAAA,IAC7B;AACA,IAAAG,EAAA;AAAA,EACF,CAAC;AACH;AAES,SAASC,GAA6B/O,GAA+B;AAE1E,QAAM7E,KADgB,OAAO6E,EAAK,yBAA0B,WAAWA,EAAK,wBAAwB,KACtE;AAChC,EAAAA,EAAK,wBAAwB7E,GAC7B6E,EAAK,6BAA6B,KAE1B,YAAY;AAClB,QAAI;AACA,YAAME,IAAY,MAAMuO,GAAuCzO,GAAM,kBAAkB;AACzF,UAAI7E,MAAU6E,EAAK;AACjB;AAEF,UAAI,CAACE,GAAW;AACd,gBAAQ,KAAK,yEAAyE;AACtF;AAAA,MACF;AAQE,UALeA,EAAU,iBAAiB,mBAAmB,EAAE,WAChD,KACf,QAAQ,MAAM,0EAA0E,GAGpFA,EAAU;AACZ;AAEF,MAAAA,EAAU,iCAAiC,IAC7C,QAAQ,MAAM,oDAAoD,GAElEA,EAAU,iBAAiB,SAAS,CAAC3X,MAAsB;AACzD,SAAM,YAAY;AAChB,cAAI;AACF,kBAAMkhB,IAASlhB,EAAM;AACrB,gBAAI,EAAEkhB,aAAkB;AACtB;AAGA,kBAAMuF,IAAWvF,EAAO,QAA2B,YAAY;AACjE,gBAAIuF,KAAY9O,EAAU,SAAS8O,CAAQ,GAAG;AAC5C,oBAAMpP,IAAMoP,EAAS,aAAa,gBAAgB;AAClD,kBAAIpP,GAAK;AACP,sBAAMK,IAAaD,EAAK;AAAA,kBACtB,sCAAsCJ,CAAG;AAAA,gBAAA,GAErCqP,IAAOhP,KAAAA,gBAAAA,EAAY,cAAsC;AAC/D,sBAAMmO,GAAyBxO,GAAKqP,KAAQ,MAAMjP,CAAI;AAAA,cACxD;AACA;AAAA,YACF;AAEA,kBAAMkP,IAAMzF,EAAO,QAA2B,mBAAmB;AACjE,gBAAI,CAACyF,KAAO,CAAChP,EAAU,SAASgP,CAAG,EAAG;AAEtC,kBAAM7b,IAAgB6b,EAAI,aAAa,gBAAgB;AACvD,gBAAI,CAAC7b,EAAe;AAElB,kBAAM4M,IAAaD,EAAK;AAAA,cACxB,sCAAsC3M,CAAa;AAAA,YAAA;AAErD,gBAAI,CAAC4M,EAAY;AAEjB,kBAAMkP,IAAUD,EAAI,cAA2B,QAAQ;AAGvD,gBAFiBjP,EAAW,UAAU,SAAS,QAAQ,GAEzC;AACZ,cAAAA,EAAW,UAAU,OAAO,QAAQ,GACpCiP,EAAI,UAAU,IAAI,UAAU,GAC5BA,EAAI,aAAa,iBAAiB,MAAM,GACpCC,QAAiB,cAAc,MACnCjG,GAAmB,IAAI7V,CAAa;AAEpC,kBAAI;AACF,gBAAAiN,GAAsBN,GAAM3M,CAAa;AAAA,cAC3C,SAASvL,GAAO;AACd,wBAAQ,KAAK,+DAA+DA,CAAK;AAAA,cACnF;AAEA,kBAAK2P,GAAsBpE,CAAa,GAgDjC;AACL,sBAAMqM,IAAcO,EAAW,cAA2B,sBAAsB;AAChF,oBAAIP,GAAa;AACf,kBAAAA,EAAY,YAAYoF;AAAA,oBACtBpN,GAAsBrE,CAAa;AAAA,kBAAA,GAErCwM,GAAgCG,GAAM3M,CAAa;AACnD,sBAAI;AACF,oBAAAyM,GAA6BE,GAAM3M,CAAa;AAAA,kBAClD,SAASvL,GAAO;AACd,4BAAQ,KAAK,mEAAmEA,CAAK;AAAA,kBACvF;AAAA,gBACF;AAAA,cACF,OA7D2C;AACzC,sBAAM4X,IAAcO,EAAW,cAAsC,sBAAsB;AAC3F,gBAAIP,MACFA,EAAY,YAAY;AAE1B,oBAAI;AACF,wBAAM4O,IAAmC,MAAMlb;AAAA,oBAC7C+T;AAAA,oBACAC;AAAA,oBACA/T;AAAA,kBAAA;AAEF,sBAAIib,EAAK,OAAO;AACd,0BAAMC,IAAY,OAAOD,EAAK,SAAU,WAAWA,EAAK,QAAQ,OAAOA,EAAK,KAAK;AACjF,oBAAI5O,MACFA,EAAY,YAAY,sBAAsB6O,CAAS,8CAA8Clb,CAAa;AAEpH;AAAA,kBACF;AACA,wBAAMkR,IAAsB1L;AAAA,oBAC1B,MAAM,QAAQyV,EAAK,SAAS,IAAIA,EAAK,YAAY,CAAA;AAAA,kBAAC;AAOpD,sBALA/W,GAAsBlE,GAAekR,CAAmB,GACxDrK;AAAA,oBACE7G;AAAA,oBACAkR;AAAA,kBAAA,GAEE7E,GAAa;AACf,oBAAAA,EAAY,YAAYoF,GAAqBP,CAAmB;AAEhE,wBAAI;AACF,sBAAA1E,GAAgCG,GAAM3M,CAAa;AAAA,oBACrD,SAASvL,GAAO;AACd,8BAAQ,KAAK,kEAAkEA,CAAK;AAAA,oBACtF;AACA,wBAAI;AACF,sBAAAgY,GAA6BE,GAAM3M,CAAa;AAAA,oBAClD,SAASvL,GAAO;AACd,8BAAQ,KAAK,iFAAiFA,CAAK;AAAA,oBACrG;AAAA,kBACF;AAAA,gBACF,SAASA,GAAO;AACd,wBAAM0mB,IAAU1mB,aAAiB,QAAQA,EAAM,UAAU,OAAOA,CAAK,GAC/D4X,IAAcO,EAAW,cAAsC,sBAAsB;AAC3F,kBAAIP,MACFA,EAAY,YAAY,yCAAyC8O,CAAO,8CAA8Cnb,CAAa,2BAErI,QAAQ,MAAM,6BAA6BA,GAAevL,CAAK;AAAA,gBACjE;AAAA,cACF;AAAA,YAcF;AACE,cAAAmY,EAAW,UAAU,IAAI,QAAQ,GACjCiP,EAAI,UAAU,OAAO,UAAU,GAC/BA,EAAI,aAAa,iBAAiB,OAAO,GACrCC,QAAiB,cAAc,MACnCjG,GAAmB,OAAO7V,CAAa;AAAA,UAEzC,SAASvL,GAAO;AACd,oBAAQ,MAAM,sEAAsEA,CAAK;AAAA,UAC3F;AAAA,QACJ,GAAA;AAAA,MACF,CAAC;AAAA,IACH,UAAA;AACE,MAAIqT,MAAU6E,EAAK,0BACjBA,EAAK,6BAA6B;AAAA,IAEtC;AAAA,EACA,GAAA;AACJ;AAGS,SAASoP,GAAmCpP,GAA+B;AAChF,QAAMzT,IAAQyT,EAAK,cAAoC,6BAA6B;AACpF,EAAKzT,MACDA,EAAM,qCACVA,EAAM,mCAAmC,IAC3CA,EAAM,iBAAiB,SAAS,CAAChE,MAAsB;AACrD,UAAMkhB,IAASlhB,EAAM;AAKrB,QAJI,EAAEkhB,aAAkB,YAIpB,CADQA,EAAO,QAA2B,mBAAmB,EACvD;AAER,UAAM4F,IAAmBrP,EAAK,cAAsC,kBAAkB;AACxF,IAAIqP,KAAA,QAAAA,EAAkB,mCACtB,QAAQ,MAAM,mDAAmD,GACjEN,GAA6B/O,CAAI;AAAA,EACnC,CAAC;AACH;AAEA,eAAsBsP,GACpBtP,GACAhO,GACAC,GACiB;AZ3uCnB,MAAAC,GAAAC,GAAAC;AY4uCE,EAAA+U,KAAWnV,KAAQ,MACnBoV,KAAkBnV,KAAe,MACjC,QAAQ;AAAA,IACN;AAAA,IACAA,KAAA,gBAAAA,EAAa;AAAA,IACb;AAAA,KACAG,KAAAD,KAAAD,IAAAD,KAAA,gBAAAA,EAAa,WAAb,gBAAAC,EAAqB,kBAArB,gBAAAC,EAAoC,WAApC,gBAAAC,EAA4C;AAAA,EAAA;AAG9C,QAAMmd,IAAe,MAAMzc,GAAgBd,GAAMC,CAAW;AAC5D,EAAA2H,GAAoB2V,EAAa,QAAQ;AACzC,QAAMxO,IAAoCvE,GAAA,GAEpCgT,IAAiB,MAAMrc,GAAkBnB,GAAMC,CAAW;AAChE,EAAA6H,GAA0B0V,EAAe,UAAU;AACnD,QAAM3F,IAASpN,GAAA;AAGf,MAAIvJ,IAAiB;AACrB,MAAI;AACF,IAAAA,IAAiB,MAAMF,GAAsBhB,GAAMC,CAAW;AAAA,EAChE,QAAQ;AACN,IAAAiB,IAAiB;AAAA,EACnB;AAGA,QAAMuc,IAAgB1O,EAAY;AAAA,IAChC,CAAC2O,GAAKzX,MAAYyX,KAAO,OAAOzX,EAAQ,WAAY,YAAY,OAAO,SAASA,EAAQ,OAAO,IAAIA,EAAQ,UAAU;AAAA,IACrH;AAAA,EAAA,GAEI0X,IAAsB9F,EAAO,KAAK,CAAA+F,MAASA,EAAM,cAAc,GAC/DC,IAAoB9O,EAAY,KAAK,CAAA9I,MAAWA,EAAQ,mBAAmBA,EAAQ,WAAW,QAAQ,CAAC,OAAO,SAASA,EAAQ,OAAO,EAAE,GACxI6X,IAAcjG,EAAO,OAAO,CAAC6F,GAAKE,MAClCA,EAAM,YAAY,OAAOA,EAAM,iBAAkB,YAAY,OAAO,SAASA,EAAM,aAAa,IAC3FF,IAAME,EAAM,gBAEdF,GACN,CAAC,GACEnJ,IAAckJ,IAAgBK,GAC9BC,IAAsB,wDAGtBC,IAFuBnG,EAAO,KAAK,CAAA+F,MAASA,EAAM,YAAY,OAAOA,EAAM,iBAAkB,YAAY,OAAO,SAASA,EAAM,aAAa,CAAC,KAC9I7O,EAAY,KAAK,CAAA9I,MAAW,OAAOA,EAAQ,WAAY,YAAY,OAAO,SAASA,EAAQ,OAAO,CAAC,IAEpG,GAAG/L,EAAaqa,CAAW,CAAC,YAC5B,uDAAuDwJ,CAAmB,YAAYA,CAAmB,cACvGE,IAAcN,KAAuBE,IACvC,mCAAmCE,CAAmB,YACtD,IAGEvJ,IAAa;AAAA;AAAA,8DAEyCwJ,CAAiB,YAAYC,CAAU;AAAA;AAAA,KAG7FrjB,IAAaH,GAAiB,aAAa+Z,CAAU,GAKrD0J,IAAqBtG,GAA8BC,CAAM,GAGzDtI,IAAcR,EAAY,OAAO,QAAMrT,EAAE,iBAAiB,WAAW,KAAK,GAC1E8T,IAAaT,EAAY,OAAO,QAAMrT,EAAE,iBAAiB,WAAW,KAAK,GAGzEyiB,IADkB3O,EAAW,KAAK,CAAA9T,MAAKA,EAAE,cAAc,IAEzD;AAAA;AAAA;AAAA;AAAA;AAAA,UAMA,IAEE0iB,IAAe;AAAA;AAAA;AAAA;AAAA,UAIb5lB;AAAA,IACN+W,EAAY,IAAI,CAAAtJ,OAAY;AAAA,MAC1B,MAAMgF,GAAqBhF,EAAQ,MAAMA,EAAQ,QAAQ;AAAA,QACvD,gBAAgB;AAAA,QAChB,YAAY;AAAA,MAAA,CACb;AAAA,MACD,SAASA,EAAQ,WAAW;AAAA,IAAA,EAC5B;AAAA,IACF;AAAA,MACE,EAAE,KAAK,QAAQ,OAAO,OAAA;AAAA,MACtB,EAAE,KAAK,WAAW,OAAO,oBAAoB,OAAO,QAAA;AAAA,IAAiB;AAAA,IAEvE,CAAC,SAAS;AAAA,EAAA,CACX;AAAA;AAAA;AAAA,MAGGuJ,EAAW,SAAS;AAAA;AAAA;AAAA;AAAA,YAIdhX;AAAA,IACRgX,EAAW,IAAI,CAAAvJ,MAAW;AACxB,YAAM7I,IAAc6I,EAAQ,cAEtB4J,IADiB,OAAOzS,KAAgB,YAAY,OAAO,SAASA,CAAW,IAEjF,GAAGA,EAAY,eAAe,SAAS;AAAA,QACrC,uBAAuB;AAAA,QACvB,uBAAuB;AAAA,MAAA,CACxB,CAAC,SAAS6I,EAAQ,iBAAiB,EAAE,KACtC;AAEJ,aAAO;AAAA,QACL,MAAMgF,GAAqBhF,EAAQ,MAAMA,EAAQ,QAAQ;AAAA,UACvD,gBAAgB;AAAA,UAChB,YAAY;AAAA,QAAA,CACb;AAAA,QACD,YAAY4J;AAAA,QACZ,SAAS5J,EAAQ,WAAW;AAAA,MAAA;AAAA,IAEhC,CAAC;AAAA,IACD;AAAA,MACE,EAAE,KAAK,QAAQ,OAAO,OAAA;AAAA,MACtB,EAAE,KAAK,cAAc,OAAO,cAAA;AAAA,MAC5B,EAAE,KAAK,WAAW,OAAO,OAAO,OAAO,QAAA;AAAA,IAAiB;AAAA,IAE1D,CAAC,SAAS;AAAA,EAAA,CACX;AAAA;AAAA,UAEOkY,CAAS;AAAA,gBACH,EAAE;AAAA,KAIVE,IAAa;AAAA;AAAA;AAAA;AAAA,wDAImCnd,KAAkB,WAAW;AAAA;AAAA;AAAA;AAAA,KAM7E6V,IAAS;AAAA,MACXnc,EAAW,SAAS;AAAA;AAAA;AAAA;AAAA,UAIhBsjB,CAAkB;AAAA;AAAA;AAAA,MAGtBE,CAAY;AAAA,MACZC,CAAU;AAAA;AAGZ,SAAAC,GAAwBtQ,GAA2B6J,CAAM,GAEpDd;AACT;AAEE,SAASuH,GAAwBtQ,GAAgC6J,GAA+C;AAChH,MAAI,CAAC7J;AACH;AAGF,QAAMuQ,IAAM,MAAM;AAChB,QAAI;AACF,YAAMC,IAAUxQ,GACVyQ,IAAYD,EAAQ,cAA2B,kBAAkB;AACvE,MAAIC,KAAaA,EAAU,iBAAiB,mBAAmB,EAAE,WAAW,MAC1E,QAAQ,MAAM,kDAAkD,GAChEA,EAAU,YAAY7G,GAA8BC,CAAM,IAG5DkF,GAA6B/O,CAAI,GACjCoP,GAAmCpP,CAAI,GAEvCkJ,GAAmB,QAAQ,CAACtJ,MAAQ;AAClC,YAAI;AACF,UAAInI,GAAsBmI,CAAG,MAC3BC,GAAgCG,GAAMJ,CAAG,GACzCE,GAA6BE,GAAMJ,CAAG;AAAA,QAE1C,SAAS9X,GAAO;AACd,kBAAQ,KAAK,0DAA0D8X,GAAK9X,CAAK;AAAA,QACnF;AAAA,MACF,CAAC;AAED,UAAI;AACF,QAAA4kB,GAA6B8D,CAAO;AAAA,MACtC,SAASE,GAAW;AAClB,gBAAQ,KAAK,mEAAmEA,CAAS;AAAA,MAC3F;AAEA,UAAI;AACF,QAAAjQ,GAAyBT,CAAI;AAAA,MAC/B,SAAS2Q,GAAY;AACnB,gBAAQ,KAAK,uEAAuEA,CAAU;AAAA,MAChG;AAEA,cAAQ,MAAM,8CAA8CH,EAAQ,iBAAiB,mBAAmB,EAAE,MAAM;AAAA,IAClH,SAAS1oB,GAAO;AACd,cAAQ,MAAM,iDAAiDA,CAAK;AAAA,IACtE;AAAA,EACF,GAEM8oB,IAAW,OAAO,yBAA0B,aAC9C,CAACC,MAAmB,sBAAsBA,CAAE,IAC5C,CAACA,MAAmB,WAAWA,GAAI,CAAC;AAExC,EAAAD,EAAS,MAAMA,EAASL,CAAG,CAAC;AAC9B;AAEA9b,GAAwB;AAAA,EACtB,sBAAsB,CAACnB,MACrBiW,GAAyBjW,CAA+C;AAAA,EAC1E,sBAAAyR;AAAA,EACA,8BAAAjF;AAAA,EACA,iCAAAD;AAAA,EACA,uBAAuB,CAACtT,MAAU;AAChC,IAAIA,KACFmgB,GAA6BngB,CAAK;AAAA,EAEtC;AACF,CAAC;ACr8CD,MAAMukB,KAAS,8BACTC,KAAgB,KAChBC,KAAiB,KACjBC,KAAiB,EAAE,KAAK,IAAI,OAAO,IAAI,QAAQ,IAAI,MAAM,GAAA,GACzDC,KAAgB,wCAChBC,KAAe,wDACfC,KAAoB,WACpBC,KAAyB,6DACzBC,KAAwB,OACxBC,KAAa,KAAK,KAAK,KAAK;AAElC,SAASC,GAAiBtoB,GAA+B;AACvD,MAAIA,KAAS;AACX,WAAO;AAET,MAAI,OAAOA,KAAU;AACnB,WAAOA;AAET,MAAI,OAAOA,KAAU;AACnB,WAAO,OAAO,SAASA,CAAK,IAAIA,EAAM,aAAa;AAErD,MAAI,OAAOA,KAAU;AACnB,WAAOA,IAAQ,SAAS;AAE1B,MAAIA,aAAiB,MAAM;AACzB,UAAMuoB,IAAYvoB,EAAM,QAAA;AACxB,WAAO,OAAO,SAASuoB,CAAS,IAAIvoB,EAAM,gBAAgB;AAAA,EAC5D;AACA,SAAO;AACT;AAEA,SAASwoB,GAASxoB,GAAwB;AACxC,SAAI,OAAOA,KAAU,WACZA,IAEL,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK,IAC7CA,EAAM,SAAA,IAEXA,aAAiB,QAAQ,OAAO,SAASA,EAAM,QAAA,CAAS,IACnDA,EAAM,YAAA,IAER;AACT;AAEA,SAASyoB,EAAGzoB,GAAuB;AACjC,SAAO,GAAG,OAAOA,CAAK,CAAC;AACzB;AA8GA,SAAS0oB,GACPC,GACAC,IAAiC,IACR;AACzB,QAAM9pB,IAAU,SAAS,gBAAgB8oB,IAAQe,CAAG;AACpD,gBAAO,QAAQC,CAAK,EAAE,QAAQ,CAAC,CAAC7oB,GAAKC,CAAK,MAAM;AAC9C,UAAM6oB,IAAiBP,GAAiBtoB,CAAK;AAC7C,IAAI6oB,KAAkB,QAGtB/pB,EAAQ,aAAaiB,GAAK8oB,CAAc;AAAA,EAC1C,CAAC,GACM/pB;AACT;AAEA,SAASsB,GAASJ,GAAgB2M,IAA0B,MAAqB;AAC/E,MAAI,OAAO3M,KAAU,YAAY,OAAO,SAASA,CAAK;AACpD,WAAOA;AAGT,MAAI,OAAOA,KAAU,YAAYA,EAAM,KAAA,MAAW,IAAI;AACpD,UAAMO,IAAS,OAAO,WAAWP,CAAK;AACtC,QAAI,OAAO,SAASO,CAAM;AACxB,aAAOA;AAAA,EAEX;AAEA,SAAOoM;AACT;AAEA,SAASmc,GAAY9oB,GAAgB+oB,GAA+B;AAClE,MAAI/oB,aAAiB,MAAM;AACzB,UAAMuoB,IAAYvoB,EAAM,QAAA;AACxB,WAAO,OAAO,SAASuoB,CAAS,IAAIA,IAAYQ;AAAA,EAClD;AAEA,MAAI,OAAO/oB,KAAU,YAAY,OAAO,SAASA,CAAK;AACpD,WAAOA;AAGT,MAAI,OAAOA,KAAU,UAAU;AAC7B,UAAMO,IAAS,KAAK,MAAMP,CAAK;AAC/B,QAAI,OAAO,SAASO,CAAM;AACxB,aAAOA;AAAA,EAEX;AAEA,SAAOwoB;AACT;AAEA,MAAMC,KAAsC,CAACliB,MAAU;AACrD,MAAIA,KAAS,OAAOA,KAAU,YAAY,UAAUA;AAClD,WAAQA,EAA6B;AAGzC,GAEMmiB,KAAsC,CAACniB,MAAU;AACrD,MAAIA,KAAS,OAAOA,KAAU,YAAY,WAAWA;AACnD,WAAQA,EAA8B;AAG1C,GAEMoiB,KAAwC,CAACX,GAAWY,GAAWC,MAAW;AAC9E,MAAI,OAAO,SAASb,CAAS,GAAG;AAC9B,UAAMc,IAAO,IAAI,KAAKd,CAAS;AAC/B,QAAI,CAAC,OAAO,MAAMc,EAAK,QAAA,CAAS;AAC9B,aAAOA,EAAK,mBAAmB,OAAO;AAAA,EAE1C;AAEA,MAAIF,KAAa,OAAOA,KAAc,YAAY,UAAUA,GAAW;AACrE,UAAMtf,IAAOsf,EAAiC,MACxCxc,IAAW6b,GAAS3e,CAAG;AAC7B,QAAI8C;AACF,aAAOA;AAAA,EAEX;AAEA,SAAK,OAAO,SAAS4b,CAAS,IAIvBA,EAAU,SAAA,IAHR;AAIX,GAEMe,KAAwC,CAACtpB,GAAOupB,GAAYH,OAChD,OAAO,SAASppB,CAAK,IAAIA,IAAQI,GAASJ,GAAO,CAAC,KAAK,GACxD,eAAe,SAAS;AAAA,EACrC,uBAAuB;AAAA,EACvB,uBAAuB;AAAA,CACxB,GAGGwpB,KAAmD,CAAC,EAAE,YAAAC,GAAY,YAAAC,QAAiB;AAAA,sCACnDD,CAAU;AAAA,uCACTC,CAAU;AAAA;AAGjD,SAASC,GAAiB3S,GAA8D;AACtF,SAAKA,EAAU,iBACbA,EAAU,eAAe;AAAA,IACvB,KAAK;AAAA,IACL,UAAU;AAAA,IACV,UAAU;AAAA,IACV,cAAc;AAAA,IACd,WAAW;AAAA,IACX,aAAa;AAAA,IACb,SAAS;AAAA,IACT,SAAS;AAAA,IACT,OAAO6Q;AAAA,IACP,QAAQC;AAAA,IACR,QAAQ,EAAE,GAAGC,GAAA;AAAA,IACb,QAAQ,CAAA;AAAA,IACR,QAAQ,CAAA;AAAA,IACR,OAAO;AAAA,IACP,WAAWiB;AAAA,IACX,WAAWC;AAAA,IACX,YAAYC;AAAA,IACZ,YAAYI;AAAA,IACZ,iBAAiBE;AAAA,IACjB,OAAOxB;AAAA,IACP,WAAWC;AAAA,IACX,UAAU;AAAA,IACV,kBAAkB;AAAA,EAAA,IAGfjR,EAAU;AACnB;AAEA,SAAS4S,GAAM5pB,GAAe6pB,GAAaC,GAAqB;AAI9D,SAHI,CAAC,OAAO,SAAS9pB,CAAK,KAGtBA,IAAQ6pB,IACHA,IAEL7pB,IAAQ8pB,IACHA,IAEF9pB;AACT;AAEA,SAAS+pB,GAAcC,GAA2CC,GAA2B;AAC3F,MAAID,EAAO,WAAW;AACpB,WAAO;AAGT,QAAME,IAAqB,CAAA;AAC3B,EAAAF,EAAO,QAAQ,CAACG,GAAOC,MAAU;AAC/B,UAAMC,IAAUD,MAAU,IAAI,MAAM,KAC9BE,IAAIH,EAAM,EAAE,QAAQ,CAAC,GACrBI,IAAIJ,EAAM,EAAE,QAAQ,CAAC;AAC3B,IAAAD,EAAS,KAAK,GAAGG,CAAO,GAAGC,CAAC,IAAIC,CAAC,EAAE;AAAA,EACrC,CAAC;AAED,QAAMC,IAAaR,EAAO,CAAC,GAErBS,IAAU,IADET,EAAOA,EAAO,SAAS,CAAC,EACZ,EAAE,QAAQ,CAAC,CAAC,IAAIC,EAAU,QAAQ,CAAC,CAAC,KAAKO,EAAW,EAAE,QAAQ,CAAC,CAAC,IAAIP,EAAU,QAAQ,CAAC,CAAC;AAEtH,SAAO,GAAGC,EAAS,KAAK,GAAG,CAAC,IAAIO,CAAO;AACzC;AAEA,SAASC,GAAcV,GAAmD;AACxE,MAAIA,EAAO,WAAW;AACpB,WAAO;AAGT,QAAME,IAAqB,CAAA;AAC3B,SAAAF,EAAO,QAAQ,CAACG,GAAOC,MAAU;AAC/B,UAAMC,IAAUD,MAAU,IAAI,MAAM,KAC9BE,IAAIH,EAAM,EAAE,QAAQ,CAAC,GACrBI,IAAIJ,EAAM,EAAE,QAAQ,CAAC;AAC3B,IAAAD,EAAS,KAAK,GAAGG,CAAO,GAAGC,CAAC,IAAIC,CAAC,EAAE;AAAA,EACrC,CAAC,GAEML,EAAS,KAAK,GAAG;AAC1B;AAEA,SAASS,GAAwBC,GAAqC;AACpE,QAAM,EAAE,cAAAC,GAAc,UAAAC,EAAA,IAAaF;AACnC,MAAI,CAACC;AACH;AAGF,QAAME,KAASD,KAAA,gBAAAA,EAAU,UAAS3C,IAC5B6C,KAAYF,KAAA,gBAAAA,EAAU,cAAa1C;AAEzC,EAAAyC,EAAa,aAAa,UAAUE,CAAM,GAC1CF,EAAa,aAAa,oBAAoBG,CAAS;AACzD;AAEA,SAASC,GAAmBL,GAAqC;AAC/D,QAAM,EAAE,cAAAC,GAAc,UAAAC,GAAU,OAAAI,GAAO,QAAAC,GAAQ,OAAAC,MAAUR;AACzD,MAAI,CAACC;AACH;AAGF,QAAMQ,IAAgBP,KAAA,gBAAAA,EAAU;AAChC,MAAI,CAACI,KAASG,KAAiB,QAAQ,CAAC,OAAO,SAASA,CAAa,GAAG;AACtE,IAAAR,EAAa,MAAM,UAAU;AAC7B;AAAA,EACF;AAEA,QAAM,EAAE,MAAAS,GAAM,MAAAC,GAAM,eAAAC,EAAA,IAAkBN,GAChCO,IAAW,OAAO,SAASH,CAAI,IAAIA,IAAOD,GAE1CK,KADW,OAAO,SAASH,CAAI,IAAIA,IAAOE,IAAW,KAC5BA,GACzBha,IAAQia,MAAgB,IAAI,OAAOL,IAAgBI,KAAYC,GAC/DC,IAAe/B,GAAMnY,GAAO,GAAG,CAAC,GAEhCma,IAAkB,KAAK,IAAIJ,GAAe,CAAC,GAC3CjB,IAAIY,EAAO,OAAO,IAAIQ,KAAgBC,GACtCC,IAAiB,KAAK,IAAIT,IAAQD,EAAO,OAAOA,EAAO,OAAO,CAAC,GAC/DW,IAAKX,EAAO,MACZY,IAAKZ,EAAO,OAAOU;AAEzB,EAAAhB,EAAa,aAAa,MAAMiB,EAAG,QAAQ,CAAC,CAAC,GAC7CjB,EAAa,aAAa,MAAMkB,EAAG,QAAQ,CAAC,CAAC,GAC7ClB,EAAa,aAAa,MAAMN,EAAE,QAAQ,CAAC,CAAC,GAC5CM,EAAa,aAAa,MAAMN,EAAE,QAAQ,CAAC,CAAC,GAC5CM,EAAa,MAAM,UAAU;AAC/B;AAEA,SAASmB,GACPC,GACAC,GACAC,GACoE;AbxYtE,MAAAnjB;AayYE,QAAM,EAAE,OAAAoiB,GAAO,QAAAgB,GAAQ,QAAAjB,EAAA,IAAWe,GAC5B,EAAE,WAAAG,GAAW,WAAAC,EAAA,IAAcH;AAEjC,MAAIF,EAAO,WAAW;AACpB,WAAO,EAAE,QAAQ,IAAI,OAAO,KAAA;AAG9B,QAAMM,IAAYN,EACf,IAAI,CAACnlB,GAAOsjB,MAAU;AACrB,UAAMoC,IAAOH,EAAUvlB,GAAOsjB,CAAK,GAC7BqC,KAAOH,EAAUxlB,GAAOsjB,CAAK,GAC7BsC,IAAS5D,GAAY0D,GAAMpC,CAAK,GAChCuC,IAASvsB,GAASqsB,IAAM,OAAO,GAAG;AACxC,WAAK,OAAO,SAASE,CAAM,IAGpB;AAAA,MACL,OAAAvC;AAAA,MACA,MAAMtjB;AAAA,MACN,QAAA4lB;AAAA,MACA,QAAAC;AAAA,IAAA,IANO;AAAA,EAQX,CAAC,EACA,OAAO,CAACxC,MAAiG,EAAQA,CAAM;AAE1H,MAAIoC,EAAU,WAAW;AACvB,WAAO,EAAE,QAAQ,IAAI,OAAO,KAAA;AAG9B,QAAMK,IAAOL,EAAU,OAAO,CAAC1C,GAAKM,MAAU,KAAK,IAAIN,GAAKM,EAAM,MAAM,GAAGoC,EAAU,CAAC,EAAE,MAAM,GACxFM,IAAON,EAAU,OAAO,CAACzC,GAAKK,MAAU,KAAK,IAAIL,GAAKK,EAAM,MAAM,GAAGoC,EAAU,CAAC,EAAE,MAAM,GACxFjB,IAAOiB,EAAU,OAAO,CAAC1C,GAAKM,MAAU,KAAK,IAAIN,GAAKM,EAAM,MAAM,GAAGoC,EAAU,CAAC,EAAE,MAAM,GACxFhB,IAAOgB,EAAU,OAAO,CAACzC,GAAKK,MAAU,KAAK,IAAIL,GAAKK,EAAM,MAAM,GAAGoC,EAAU,CAAC,EAAE,MAAM,GAExFO,IAAe,KAAK,IAAI1B,IAAQD,EAAO,OAAOA,EAAO,OAAO,CAAC,GAC7DK,IAAgB,KAAK,IAAIY,IAASjB,EAAO,MAAMA,EAAO,QAAQ,CAAC,GAE/D4B,IAAW,OAAO,SAASH,CAAI,IAAIA,IAAO,GAC1CI,IAAW,OAAO,SAASH,CAAI,IAAIA,IAAOE,IAAW,GACrDtB,IAAW,OAAO,SAASH,CAAI,IAAIA,IAAO,GAC1C2B,IAAW,OAAO,SAAS1B,CAAI,IAAIA,IAAOE,IAAW,GACrDJ,IAAgBjrB,IAAS4I,IAAAkjB,EAAW,aAAX,gBAAAljB,EAAqB,OAAO,IAAI,GAEzDkkB,IACJ7B,KAAiB,QAAQ,OAAO,SAASA,CAAa,IAClD,KAAK,IAAII,GAAUJ,CAAa,IAChCI,GACA0B,IACJ9B,KAAiB,QAAQ,OAAO,SAASA,CAAa,IAClD,KAAK,IAAI4B,GAAU5B,CAAa,IAChC4B,GAEAG,IAAgB,KAAK;AAAA,IACzB;AAAA,IACA,KAAK;AAAA,MACH;AAAA,MACA,KAAK;AAAA,QACH,KAAK,IAAIhB,IAASjB,EAAO,MAAMA,EAAO,QAAQ,CAAC,IAAI;AAAA,MAAA,KAChD;AAAA,IAAA;AAAA,EACP,GAEI,EAAE,SAASkC,GAAY,SAASC,MAAeC;AAAA,IACnDL;AAAA,IACAC;AAAA,IACAC;AAAA,EAAA,GAGII,IAAgB,OAAO,SAASH,CAAU,IAAIA,IAAa5B,GAC3DgC,IAAgB,OAAO,SAASH,CAAU,IAAIA,IAAaL,GAE3DS,IAASV,IAAWD,KAAY,GAChCY,IAASF,IAAgBD,KAAiB;AAchD,SAAO;AAAA,IACL,QAbajB,EAAU,IAAI,CAACpC,MAAU;AACtC,YAAMyD,IAASF,MAAW,IAAI,OAAOvD,EAAM,SAAS4C,KAAYW,GAC1DG,IAASF,MAAW,IAAI,OAAOxD,EAAM,SAASqD,KAAiBG,GAC/DrD,KAAIa,EAAO,OAAOyC,IAASd,GAC3BvC,IAAIY,EAAO,OAAO,IAAI0C,KAAUrC;AACtC,aAAO;AAAA,QACL,GAAGrB;AAAA,QACH,GAAAG;AAAA,QACA,GAAAC;AAAA,MAAA;AAAA,IAEJ,CAAC;AAAA,IAIC,OAAO;AAAA,MACL,MAAMwC;AAAA,MACN,MAAMC;AAAA,MACN,MAAMQ;AAAA,MACN,MAAMC;AAAA,MACN,cAAAX;AAAA,MACA,eAAAtB;AAAA,IAAA;AAAA,EACF;AAEJ;AAEA,SAASsC,GACPlD,GACAQ,GACAgB,GACAjB,GACM;AACN,EAAAP,EAAM,QAAQ,OAAO,SAASQ,CAAK,IAAI,OAAOA,CAAK,IAAIvD,IACvD+C,EAAM,SAAS,OAAO,SAASwB,CAAM,IAAI,OAAOA,CAAM,IAAItE,IAC1D8C,EAAM,SAAS;AAAA,IACb,KAAK,OAAO,SAASO,KAAA,gBAAAA,EAAQ,GAAG,IAAI,OAAOA,KAAA,gBAAAA,EAAQ,GAAG,IAAIpD,GAAe;AAAA,IACzE,OAAO,OAAO,SAASoD,KAAA,gBAAAA,EAAQ,KAAK,IAAI,OAAOA,KAAA,gBAAAA,EAAQ,KAAK,IAAIpD,GAAe;AAAA,IAC/E,QAAQ,OAAO,SAASoD,KAAA,gBAAAA,EAAQ,MAAM,IAAI,OAAOA,KAAA,gBAAAA,EAAQ,MAAM,IAAIpD,GAAe;AAAA,IAClF,MAAM,OAAO,SAASoD,KAAA,gBAAAA,EAAQ,IAAI,IAAI,OAAOA,KAAA,gBAAAA,EAAQ,IAAI,IAAIpD,GAAe;AAAA,EAAA;AAEhF;AAEA,SAASgG,GAAcnD,GAA+BT,GAAuC;AAC3F,QAAMV,IAAamB,EAAM,WAAWT,EAAM,QAAQA,EAAM,MAAMA,EAAM,KAAK,GACnET,IAAakB,EAAM,WAAWT,EAAM,QAAQA,EAAM,MAAMA,EAAM,KAAK;AACzE,SAAOS,EAAM,gBAAgB;AAAA,IAC3B,OAAAT;AAAA,IACA,YAAAV;AAAA,IACA,YAAAC;AAAA,IACA,MAAMS,EAAM;AAAA,IACZ,OAAOA,EAAM;AAAA,EAAA,CACd;AACH;AAEA,SAAS6D,GACPpD,GACAT,GACA8D,GACM;AACN,QAAM,EAAE,SAAAC,GAAS,OAAA9C,GAAO,QAAAD,GAAQ,QAAAiB,MAAWxB;AAC3C,MAAI,CAACsD;AACH;AAGF,QAAMjE,IAAYmC,IAASjB,EAAO;AAClC,EAAA+C,EAAQ,MAAM,aAAa,WAC3BA,EAAQ,MAAM,UAAU;AACxB,QAAMC,IAAeD,EAAQ,eAAe,GACtCE,IAAgBF,EAAQ,gBAAgB,GACxCG,IAAazE,GAAMO,EAAM,IAAIgE,IAAe,GAAGhD,EAAO,MAAMC,IAAQD,EAAO,QAAQgD,CAAY,GAC/FG,IAAc,KAAK,IAAIrE,IAAYmE,GAAe,CAAC,GACnDG,IAAU,IACVC,IAAU,OAAO,SAASP,CAAQ,IACpCrE,GAAMqE,KAAY,GAAG9C,EAAO,KAAKlB,CAAS,IAC1CE,EAAM;AACV,MAAIsE,IAAWD,IAAUJ,IAAgBG;AACzC,EAAIE,IAAWtD,EAAO,QACpBsD,IAAWD,IAAUD,IAEvBE,IAAW7E,GAAM6E,GAAU,GAAGH,CAAW;AACzC,QAAMI,IAAajG,EAAG,KAAK,MAAM4F,CAAU,CAAC,GACtCM,IAAalG,EAAG,KAAK,MAAMgG,CAAQ,CAAC;AAC1C,EAAAP,EAAQ,MAAM,YAAY,aAAaQ,CAAU,KAAKC,CAAU;AAClE;AAEA,SAASC,GAAYhE,GAAqC;AACxD,QAAM,EAAE,SAAAsD,GAAS,WAAAW,GAAW,aAAAC,EAAA,IAAgBlE;AAC5C,EAAIsD,MACFA,EAAQ,MAAM,UAAU,KACxBA,EAAQ,MAAM,aAAa,WAEzBW,MACFA,EAAU,MAAM,UAAU,MAExBC,MACFA,EAAY,MAAM,UAAU;AAEhC;AAEA,SAASC,GACP/X,GACA4T,GACM;AACN,MAAIA,EAAM,oBAAoB,CAACA,EAAM;AACnC;AAGF,QAAMoE,IAAoB,CAAC3vB,MAAwB;AACjD,QAAIurB,EAAM,OAAO,WAAW,KAAK,CAACA,EAAM,KAAK;AAC3C,MAAAgE,GAAYhE,CAAK;AACjB;AAAA,IACF;AAEA,UAAMqE,IAAOrE,EAAM,IAAI,sBAAA,GACjBsE,IAAW7vB,EAAM,UAAU4vB,EAAK,MAChChB,IAAW5uB,EAAM,UAAU4vB,EAAK;AACtC,QAAIE,IAAUvE,EAAM,OAAO,CAAC,GACxBwE,IAAc,KAAK,IAAIF,IAAWC,EAAQ,CAAC;AAE/C,aAASlsB,IAAM,GAAGA,IAAM2nB,EAAM,OAAO,QAAQ3nB,KAAO,GAAG;AACrD,YAAMT,IAAYooB,EAAM,OAAO3nB,CAAG,GAC5BosB,IAAW,KAAK,IAAIH,IAAW1sB,EAAU,CAAC;AAChD,MAAI6sB,IAAWD,MACbA,IAAcC,GACdF,IAAU3sB;AAAA,IAEd;AAEA,IAAIooB,EAAM,gBACRA,EAAM,YAAY,aAAa,MAAMuE,EAAQ,EAAE,QAAQ,CAAC,CAAC,GACzDvE,EAAM,YAAY,aAAa,MAAMuE,EAAQ,EAAE,QAAQ,CAAC,CAAC,GACzDvE,EAAM,YAAY,MAAM,UAAU,MAGhCA,EAAM,cACRA,EAAM,UAAU,aAAa,MAAMuE,EAAQ,EAAE,QAAQ,CAAC,CAAC,GACvDvE,EAAM,UAAU,aAAa,MAAMuE,EAAQ,EAAE,QAAQ,CAAC,CAAC,GACvDvE,EAAM,UAAU,aAAa,MAAMA,EAAM,OAAO,IAAI,QAAQ,CAAC,CAAC,GAC9DA,EAAM,UAAU;AAAA,MACd;AAAA,OACCA,EAAM,SAASA,EAAM,OAAO,QAAQ,QAAQ,CAAC;AAAA,IAAA,GAEhDA,EAAM,UAAU,MAAM,UAAU,MAG9BA,EAAM,YACRA,EAAM,QAAQ,YAAYmD,GAAcnD,GAAOuE,CAAO,GACtDnB,GAAsBpD,GAAOuE,GAASlB,CAAQ;AAAA,EAElD,GAEMqB,IAAqB,MAAM;AAC/B,IAAAV,GAAYhE,CAAK;AAAA,EACnB;AAEA,EAAAA,EAAM,QAAQ,iBAAiB,eAAeoE,CAAiB,GAC/DpE,EAAM,QAAQ,iBAAiB,gBAAgBoE,CAAiB,GAChEpE,EAAM,QAAQ,iBAAiB,gBAAgB0E,CAAkB,GAEjE1E,EAAM,mBAAmB,IACzBA,EAAM,oBAAoBoE,GAC1BpE,EAAM,qBAAqB0E,GAE3BtY,EAAU,iBAAiB,iBAAiBsY,CAAkB;AAChE;AAEO,SAASC,GACdzY,GACApV,IAA4B,IACM;AAClC,QAAMsV,IAAY,SAAS,cAAc,KAAK;AAC9C,EAAAA,EAAU,YAAY,wBACtBA,EAAU,QAAQ,YAAY,QAC9BA,EAAU,MAAM,WAAW;AAE3B,QAAMwY,IAAM9G,GAAiB,OAAO;AAAA,IAClC,OAAOb;AAAA,IACP,QAAQC;AAAA,IACR,SAAS,OAAO,OAAOD,EAAa,CAAC,IAAI,OAAOC,EAAc,CAAC;AAAA,IAC/D,MAAM;AAAA,IACN,eAAe;AAAA,IACf,WAAW;AAAA,EAAA,CACZ;AACD,EAAA0H,EAAI,UAAU,IAAI,gBAAgB;AAElC,QAAMC,IAAW/G,GAAiB,QAAQ;AAAA,IACxC,OAAO;AAAA,IACP,MAAMT;AAAA,IACN,QAAQ;AAAA,EAAA,CACT,GAEK4C,IAAenC,GAAiB,QAAQ;AAAA,IAC5C,OAAO;AAAA,IACP,QAAQP;AAAA,IACR,gBAAgB;AAAA,IAChB,oBAAoBC;AAAA,IACpB,SAAS;AAAA,EAAA,CACV,GAEKsH,IAAWhH,GAAiB,QAAQ;AAAA,IACxC,OAAO;AAAA,IACP,MAAM;AAAA,IACN,QAAQV;AAAA,IACR,gBAAgB;AAAA,IAChB,kBAAkB;AAAA,IAClB,mBAAmB;AAAA,EAAA,CACpB,GAEK6G,IAAYnG,GAAiB,QAAQ;AAAA,IACzC,OAAO;AAAA,IACP,QAAQV;AAAA,IACR,gBAAgB;AAAA,IAChB,oBAAoB;AAAA,IACpB,SAAS;AAAA,EAAA,CACV,GAEK8G,IAAcpG,GAAiB,UAAU;AAAA,IAC7C,OAAO;AAAA,IACP,GAAG;AAAA,IACH,MAAM;AAAA,IACN,QAAQV;AAAA,IACR,gBAAgB;AAAA,IAChB,SAAS;AAAA,EAAA,CACV,GAEK2H,IAAUjH,GAAiB,QAAQ;AAAA,IACvC,OAAO;AAAA,IACP,MAAM;AAAA,IACN,GAAG;AAAA,IACH,GAAG;AAAA,IACH,OAAOb;AAAA,IACP,QAAQC;AAAA,EAAA,CACT;AAED,EAAA0H,EAAI,YAAYC,CAAQ,GACxBD,EAAI,YAAY3E,CAAY,GAC5B2E,EAAI,YAAYE,CAAQ,GACxBF,EAAI,YAAYX,CAAS,GACzBW,EAAI,YAAYV,CAAW,GAC3BU,EAAI,YAAYG,CAAO,GAEvB3Y,EAAU,YAAYwY,CAAG;AAEzB,QAAMtB,IAAU,SAAS,cAAc,KAAK;AAC5C,EAAAA,EAAQ,YAAY,iBACpBA,EAAQ,MAAM,WAAW,YACzBA,EAAQ,MAAM,MAAM,KACpBA,EAAQ,MAAM,OAAO,KACrBA,EAAQ,MAAM,gBAAgB,QAC9BA,EAAQ,MAAM,UAAU,KACxBA,EAAQ,MAAM,aAAa,UAC3BlX,EAAU,YAAYkX,CAAO,GAE7BpX,EAAK,YAAYE,CAAS;AAE1B,QAAM4T,IAAQjB,GAAiB3S,CAAS;AAmBxC,MAlBA4T,EAAM,MAAM4E,GACZ5E,EAAM,WAAW6E,GACjB7E,EAAM,WAAW8E,GACjB9E,EAAM,eAAeC,GACrBD,EAAM,YAAYiE,GAClBjE,EAAM,cAAckE,GACpBlE,EAAM,UAAU+E,GAChB/E,EAAM,UAAUsD,GAChBtD,EAAM,YAAYlpB,EAAQ,aAAasnB,IACvC4B,EAAM,YAAYlpB,EAAQ,aAAaunB,IACvC2B,EAAM,aAAalpB,EAAQ,cAAcwnB,IACzC0B,EAAM,aAAalpB,EAAQ,cAAc4nB,IACzCsB,EAAM,kBAAkBlpB,EAAQ,mBAAmB8nB,IACnDoB,EAAM,QAAQlpB,EAAQ,SAASsmB,IAC/B4C,EAAM,YAAYlpB,EAAQ,aAAaumB,IACvC2C,EAAM,WAAWlpB,EAAQ,YAAY,MACrCkpB,EAAM,mBAAmB,IAErB,CAACA,EAAM,OAAO;AAChB,UAAMgF,IAAQ,SAAS,cAAc,KAAK;AAC1C,IAAAA,EAAM,YAAY,qCAClBA,EAAM,MAAM,WAAW,YACvBA,EAAM,MAAM,OAAO,KACnBA,EAAM,MAAM,QAAQ,KACpBA,EAAM,MAAM,SAAS,KACrBA,EAAM,MAAM,gBAAgB,QAC5BA,EAAM,MAAM,WAAW1H,IACvB0H,EAAM,MAAM,QAAQ,+BACpBA,EAAM,MAAM,UAAU,SACtB5Y,EAAU,YAAY4Y,CAAK,GAC3BhF,EAAM,QAAQgF;AAAA,EAChB;AAEA,MAAI,CAAChF,EAAM,OAAO;AAChB,UAAMiF,IAAQ,SAAS,cAAc,KAAK;AAC1C,IAAAA,EAAM,YAAY,qCAClBA,EAAM,MAAM,WAAW,YACvBA,EAAM,MAAM,MAAM,KAClBA,EAAM,MAAM,SAAS,KACrBA,EAAM,MAAM,OAAO,KACnBA,EAAM,MAAM,gBAAgB,QAC5BA,EAAM,MAAM,WAAW3H,IACvB2H,EAAM,MAAM,QAAQ,+BACpBA,EAAM,MAAM,UAAU,SACtB7Y,EAAU,YAAY6Y,CAAK,GAC3BjF,EAAM,QAAQiF;AAAA,EAChB;AAEA,SAAA/B,GAAiBlD,GAAOlpB,EAAQ,OAAOA,EAAQ,QAAQA,EAAQ,MAAM,GAErEguB,EAAS,aAAa,UAAU9E,EAAM,KAAK,GAC3CiE,EAAU,aAAa,UAAUjE,EAAM,KAAK,GAC5CkE,EAAY,aAAa,UAAUlE,EAAM,KAAK,GAC9C6E,EAAS,aAAa,QAAQ7E,EAAM,SAAS,GAE7CkF,GAAgB9Y,GAAWtV,CAAO,GAClCqtB,GAAsB/X,GAAW4T,CAAK,GAE/B5T;AACT;AAEO,SAAS8Y,GACd9Y,GACAtV,IAA4B,IACtB;AACN,MAAI,CAACsV,GAAW;AACd,YAAQ,MAAM,gDAAgD;AAC9D;AAAA,EACF;AAEA,QAAM4T,IAAQjB,GAAiB3S,CAAS;AACxC,MAAI,CAAC4T,EAAM,OAAO,CAACA,EAAM,YAAY,CAACA,EAAM,SAAS;AACnD,YAAQ,MAAM,iEAAiE;AAC/E;AAAA,EACF;AAEA,EAAIlpB,EAAQ,cACVkpB,EAAM,YAAYlpB,EAAQ,YAExBA,EAAQ,cACVkpB,EAAM,YAAYlpB,EAAQ,YAExBA,EAAQ,eACVkpB,EAAM,aAAalpB,EAAQ,aAEzBA,EAAQ,eACVkpB,EAAM,aAAalpB,EAAQ,aAEzBA,EAAQ,oBACVkpB,EAAM,kBAAkBlpB,EAAQ,kBAE9BA,EAAQ,UACVkpB,EAAM,QAAQlpB,EAAQ,OACtBkpB,EAAM,SAAS,aAAa,UAAUA,EAAM,KAAK,GAC7CA,EAAM,aACRA,EAAM,UAAU,aAAa,UAAUA,EAAM,KAAK,GAEhDA,EAAM,eACRA,EAAM,YAAY,aAAa,UAAUA,EAAM,KAAK,IAGpDlpB,EAAQ,cACVkpB,EAAM,YAAYlpB,EAAQ,WACtBkpB,EAAM,YACRA,EAAM,SAAS,aAAa,QAAQA,EAAM,SAAS,IAInD,OAAO,UAAU,eAAe,KAAKlpB,GAAS,UAAU,MAC1DkpB,EAAM,WAAWlpB,EAAQ,YAAY,OAGvCipB,GAAwBC,CAAK,GAE7BkD,GAAiBlD,GAAOlpB,EAAQ,OAAOA,EAAQ,QAAQA,EAAQ,MAAM;AAErE,QAAM,EAAE,OAAA0pB,GAAO,QAAAgB,GAAQ,QAAAjB,EAAA,IAAWP;AAClC,EAAAA,EAAM,IAAI,aAAa,SAAS,OAAOQ,CAAK,CAAC,GAC7CR,EAAM,IAAI,aAAa,UAAU,OAAOwB,CAAM,CAAC,GAC/CxB,EAAM,IAAI,aAAa,WAAW,OAAO,OAAOQ,CAAK,CAAC,IAAI,OAAOgB,CAAM,CAAC,EAAE,GAE1ExB,EAAM,QAAQ,aAAa,KAAKO,EAAO,KAAK,QAAQ,CAAC,CAAC,GACtDP,EAAM,QAAQ,aAAa,KAAKO,EAAO,IAAI,QAAQ,CAAC,CAAC,GACrDP,EAAM,QAAQ;AAAA,IACZ;AAAA,IACA,KAAK,IAAIQ,IAAQD,EAAO,OAAOA,EAAO,OAAO,CAAC,EAAE,QAAQ,CAAC;AAAA,EAAA,GAE3DP,EAAM,QAAQ;AAAA,IACZ;AAAA,IACA,KAAK,IAAIwB,IAASjB,EAAO,MAAMA,EAAO,QAAQ,CAAC,EAAE,QAAQ,CAAC;AAAA,EAAA,GAGxD,MAAM,QAAQzpB,EAAQ,MAAM,MAC9BkpB,EAAM,SAAS,MAAM,KAAKlpB,EAAQ,MAAM;AAG1C,QAAM,EAAE,QAAAsoB,GAAQ,OAAAkB,EAAA,IAAUc,GAAcpB,EAAM,QAAQA,GAAO;AAAA,IAC3D,WAAWA,EAAM;AAAA,IACjB,WAAWA,EAAM;AAAA,EAAA,CAClB;AAID,MAHAA,EAAM,SAASZ,GACfY,EAAM,QAAQM,GAEVlB,EAAO,WAAW,GAAG;AACvB,IAAAY,EAAM,SAAS,aAAa,KAAK,EAAE,GAC/BA,EAAM,YACRA,EAAM,SAAS,aAAa,KAAK,EAAE,GAErCgE,GAAYhE,CAAK,GACjBmF,GAAWnF,CAAK,GAChBK,GAAmBL,CAAK;AACxB;AAAA,EACF;AAEA,QAAMoF,IAAQtF,GAAcV,CAAM;AAGlC,MAFAY,EAAM,SAAS,aAAa,KAAKoF,CAAK,GAElCpF,EAAM,YAAYM,GAAO;AAC3B,UAAMjB,IAAYW,EAAM,OAAO,MAAMM,EAAM,eACrC+E,IAAQlG,GAAcC,GAAQC,CAAS;AAC7C,IAAAW,EAAM,SAAS,aAAa,KAAKqF,CAAK;AAAA,EACxC;AAEA,EAAAF,GAAWnF,CAAK,GAChBK,GAAmBL,CAAK;AAC1B;AAEA,SAASmF,GAAWnF,GAAqC;AACvD,QAAM,EAAE,OAAAgF,GAAO,OAAAC,GAAO,OAAA3E,GAAO,QAAAC,GAAQ,QAAAiB,GAAQ,YAAA8D,MAAetF;AAC5D,MAAI,CAACgF,KAAS,CAACC;AACb;AAGF,MAAI,CAAC3E,GAAO;AACV,IAAA0E,EAAM,YAAY,IAClBC,EAAM,YAAY;AAClB;AAAA,EACF;AAEA,QAAM,EAAE,MAAAjD,GAAM,MAAAC,GAAM,MAAAvB,GAAM,MAAAC,GAAM,cAAAuB,GAAc,eAAAtB,MAAkBN,GAE1DiF,IAAY,OAAO,SAASvD,CAAI,KAAK,OAAO,SAASC,CAAI,KAAKA,KAAQD,GACtEwD,IAAY,OAAO,SAAS9E,CAAI,KAAK,OAAO,SAASC,CAAI,KAAKA,KAAQD,GAEtEO,IAAiB,KAAK,IAAIiB,GAAc,CAAC,GACzClB,IAAkB,KAAK,IAAIJ,GAAe,CAAC;AAOjD,MALAoE,EAAM,MAAM,OAAOnH,EAAG0C,EAAO,IAAI,GACjCyE,EAAM,MAAM,QAAQnH,EAAGoD,CAAc,GACrC+D,EAAM,MAAM,MAAMnH,EAAG2D,IAASjB,EAAO,SAAS,CAAC,GAC/CyE,EAAM,YAAY,IAEdO,KAAatE,IAAiB,GAAG;AACnC,UAAMwE,KAAaxD,IAAOD,KAAQvE,IAC5BiI,IAAe,KAAK,IAAI,GAAG,KAAK,IAAI,GAAG,KAAK,MAAMzE,IAAiB,GAAG,KAAK,CAAC,CAAC;AAEnF,IADe0E,GAAsB3F,GAAOgC,GAAMC,GAAMyD,GAAcD,CAAS,EACxE,QAAQ,CAAC,EAAE,eAAAG,GAAe,OAAAxc,QAAY;AAC3C,YAAM4R,IAAO,SAAS,cAAc,KAAK;AACzC,MAAAA,EAAK,YAAY,+CACjBA,EAAK,MAAM,WAAW,YACtBA,EAAK,MAAM,SAAS;AACpB,YAAMnU,IAAQmY,GAAM4G,GAAe,GAAG,CAAC;AACvC,MAAA5K,EAAK,MAAM,OAAO6C,EAAGhX,IAAQoa,CAAc;AAC3C,UAAI6C,IAAa,QACb+B,IAA8C;AAClD,MAAIhf,KAAS,QACXid,IAAa,KACb+B,IAAY,QACZ7K,EAAK,MAAM,aAAa,SACfnU,KAAS,UAClBid,IAAa,SACb+B,IAAY,SACZ7K,EAAK,MAAM,cAAc,QAE3BA,EAAK,MAAM,YAAY,cAAc8I,CAAU,KAC/C9I,EAAK,MAAM,YAAY6K,GACvB7K,EAAK,cAAc5R,GACnB4b,EAAM,YAAYhK,CAAI;AAAA,IACxB,CAAC;AAAA,EACH;AAEA,EAAAiK,EAAM,MAAM,MAAMpH,EAAG0C,EAAO,GAAG,GAC/B0E,EAAM,MAAM,SAASpH,EAAGmD,CAAe;AACvC,QAAM8E,IAAa,KAAK,IAAIvF,EAAO,OAAO,GAAG,CAAC;AAK9C,MAJA0E,EAAM,MAAM,OAAO,KACnBA,EAAM,MAAM,QAAQpH,EAAG,KAAK,IAAIiI,GAAY,CAAC,CAAC,GAC9Cb,EAAM,YAAY,IAEdO,KAAaxE,IAAkB,GAAG;AACpC,UAAM0E,IAAe,KAAK,IAAI,GAAG,KAAK,IAAI,GAAG,KAAK,MAAM1E,IAAkB,EAAE,KAAK,CAAC,CAAC,GAC7E+E,IAASC,GAAyBtF,GAAMC,GAAM+E,CAAY,GAC1DO,IAAiBX;AACvB,IAAAS,EAAO,QAAQ,CAAC,EAAE,OAAA3wB,GAAO,eAAAwwB,QAAoB;AAC3C,YAAM5K,IAAO,SAAS,cAAc,KAAK;AACzC,MAAAA,EAAK,YAAY,+CACjBA,EAAK,MAAM,WAAW,YACtBA,EAAK,MAAM,OAAO;AAElB,YAAMkL,KAAO,IADQlH,GAAM4G,GAAe,GAAG,CAAC,KACb5E;AACjC,MAAAhG,EAAK,MAAM,MAAM6C,EAAGqI,CAAG,GACvBlL,EAAK,cAAciL,EAAe7wB,GAAO,MAAM,EAAE,GACjD6vB,EAAM,YAAYjK,CAAI;AAAA,IACxB,CAAC;AAAA,EACH;AACF;AAEA,SAAS2H,GACPwD,GACAC,GACAV,IAAe,GACuB;AACtC,MAAI,CAAC,OAAO,SAASS,CAAQ,KAAK,CAAC,OAAO,SAASC,CAAQ;AACzD,WAAO;AAAA,MACL,SAASD;AAAA,MACT,SAASC;AAAA,IAAA;AAIb,QAAMC,IAAY,KAAK,IAAI,GAAGX,CAAY;AAE1C,MAAIU,MAAaD,GAAU;AACzB,UAAMxC,IAAU2C,GAAS,KAAK,IAAIH,CAAQ,KAAK,CAAC;AAChD,WAAO;AAAA,MACL,SAASA,IAAWxC;AAAA,MACpB,SAASyC,IAAWzC;AAAA,IAAA;AAAA,EAExB;AAGA,QAAM4C,KADQH,IAAWD,MACAE,IAAY,IAC/BG,IAAOF,GAASC,CAAO,GACvBE,IAAU,KAAK,MAAMN,IAAWK,CAAI,IAAIA,GACxCE,IAAU,KAAK,KAAKN,IAAWI,CAAI,IAAIA;AAE7C,SAAIC,MAAYC,IACP;AAAA,IACL,SAASP;AAAA,IACT,SAASC,IAAWI;AAAA,EAAA,IAIjB;AAAA,IACL,SAAAC;AAAA,IACA,SAAAC;AAAA,EAAA;AAEJ;AAEA,SAASf,GACP3F,GACA2G,GACAC,GACAlB,GACAD,GACiD;AACjD,MAAI,CAAC,OAAO,SAASkB,CAAY,KAAK,CAAC,OAAO,SAASC,CAAY,KAAKA,IAAeD;AACrF,WAAO,CAAA;AAGT,MAAI,CAAC,OAAO,SAASlB,CAAS,KAAKA,KAAa;AAE9C,WAAO;AAAA,MACL;AAAA,QACE,eAAe;AAAA,QACf,OAJUoB,GAAiB7G,GAAO2G,GAAclB,KAAa,CAAC;AAAA,MAI9D;AAAA,IACF;AAIJ,QAAMqB,IAAY,KAAK,IAAI,GAAGpB,CAAY,GACpCqB,IAAyD,CAAA,GACzDzG,IAAQsG,IAAeD;AAC7B,WAASnH,IAAQ,GAAGA,IAAQsH,GAAWtH,KAAS,GAAG;AACjD,UAAM3Y,IAAQigB,MAAc,IAAI,MAAMtH,KAASsH,IAAY,IACrD1xB,IAAQuxB,IAAe9f,IAAQyZ;AACrC,IAAAyG,EAAM,KAAK;AAAA,MACT,eAAelgB;AAAA,MACf,OAAOggB,GAAiB7G,GAAO5qB,GAAOqwB,CAAS;AAAA,IAAA,CAChD;AAAA,EACH;AACA,SAAOsB;AACT;AAEA,SAASF,GACP7G,GACArC,GACA8H,GACQ;AACR,QAAMhH,IAAO,IAAI,KAAKd,CAAS;AAC/B,SAAI,OAAO,SAASc,EAAK,QAAA,CAAS,IAC5BgH,IAAY,OACP,OAAOhH,EAAK,aAAa,IAE9BgH,IAAY,MACPhH,EAAK,mBAAmB,SAAS;AAAA,IACtC,MAAM;AAAA,IACN,OAAO;AAAA,EAAA,CACR,IAECgH,IAAY,KACPhH,EAAK,mBAAmB,SAAS;AAAA,IACtC,MAAM;AAAA,IACN,OAAO;AAAA,EAAA,CACR,IAECgH,IAAY,KACPhH,EAAK,mBAAmB,SAAS;AAAA,IACtC,KAAK;AAAA,IACL,OAAO;AAAA,EAAA,CACR,IAEIA,EAAK,mBAAmB,SAAS;AAAA,IACtC,KAAK;AAAA,IACL,OAAO;AAAA,EAAA,CACR,IAGIuB,EAAM,WAAWrC,GAAW,MAAM,EAAE;AAC7C;AAEA,SAASqI,GACPG,GACAC,GACAV,GACiD;AACjD,MAAI,CAAC,OAAO,SAASS,CAAQ,KAAK,CAAC,OAAO,SAASC,CAAQ;AACzD,WAAO,CAAA;AAGT,MAAIA,MAAaD;AACf,WAAO;AAAA,MACL;AAAA,QACE,OAAOA;AAAA,QACP,eAAe;AAAA,MAAA;AAAA,IACjB;AAIJ,QAAM7F,IAAQ8F,IAAWD,GACnBW,IAAY,KAAK,IAAI,GAAGpB,CAAY,GACpCa,IAAUjG,KAASwG,IAAY,IAC/BN,IAAOF,GAASC,CAAO,GACvBzL,IAAQ,KAAK,MAAMqL,IAAWK,CAAI,IAAIA,GACtCQ,IAAM,KAAK,KAAKZ,IAAWI,CAAI,IAAIA,GAEnCO,IAAyD,CAAA;AAC/D,WAAS3xB,IAAQ0lB,GAAO1lB,KAAS4xB,IAAMR,IAAO,GAAGpxB,KAASoxB,GAAM;AAC9D,UAAM3f,KAASzR,IAAQ+wB,MAAaC,IAAWD;AAC/C,IAAAY,EAAM,KAAK;AAAA,MACT,OAAA3xB;AAAA,MACA,eAAe4pB,GAAMnY,GAAO,GAAG,CAAC;AAAA,IAAA,CACjC;AAAA,EACH;AAEA,SAAIkgB,EAAM,SAASD,IAAY,IACtBC,EAAM,OAAO,CAACE,GAAGzH,MAAUA,IAAQ,MAAM,CAAC,IAG5CuH;AACT;AAEA,SAAST,GAASlxB,GAAuB;AACvC,MAAI,CAAC,OAAO,SAASA,CAAK,KAAKA,MAAU;AACvC,WAAO;AAGT,QAAM8xB,IAAW,KAAK,MAAM,KAAK,MAAM,KAAK,IAAI9xB,CAAK,CAAC,CAAC,GACjD+xB,IAAW,KAAK,IAAI/xB,CAAK,IAAI,MAAM8xB;AACzC,MAAIE;AACJ,SAAID,KAAY,IACdC,IAAe,IACND,KAAY,IACrBC,IAAe,IACND,KAAY,IACrBC,IAAe,IAEfA,IAAe,IAEVA,IAAe,MAAMF;AAC9B;ACrmCA,SAASG,GAAcjyB,GAAmC;AACxD,SAAO,MAAM,QAAQA,CAAK,KAAKA,EAAM,MAAM,CAAC8G,MAAU,OAAOA,KAAU,QAAQ;AACjF;AAEA,SAAS1B,GAASpF,GAAwC;AACxD,SAAO,OAAOA,KAAU,YAAYA,MAAU;AAChD;AAmQO,SAASkyB,GACdlyB,GAC+C;AAC/C,MAAI,CAACoF,GAASpF,CAAK;AACjB,WAAO;AAGT,QAAMkO,IAASlO;AAEf,SAAI,OAAOkO,EAAO,iBAAkB,WAC3B,KAGF+jB,GAAc/jB,EAAO,aAAa;AAC3C;AAEO,SAASikB,GACd9yB,GACyC;AACzC,SAAMA,aAAiB,cAIhB6yB,GAAuC7yB,EAAM,MAAM,IAHjD;AAIX;ACvQA,MAAM+yB,KAA2B,EAAE,KAAK,GAAG,KAAK,EAAA,GAC1CjU,KAAwB,EAAE,KAAK,GAAG,KAAK,EAAA,GACvCkU,KAAiD,MACjDC,KAA+D;AAAA,EACnE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,GACMC,KAA4D;AAAA,EAChE,MAAM;AAAA,EACN,MAAM;AAAA,EACN,MAAM;AAAA,EACN,MAAM;AAAA,EACN,KAAO,OAAO;AAChB,GA+CMC,KAAgE;AAAA,EACpE,aAAa;AAAA,EACb,QAAQ;AAAA,EACR,WAAW;AACb,GAIMC,yBAAmD,IAAA,GACnDC,yBAA+C,IAAA,GAC/CC,yBAAuD,IAAA,GACvDC,KAAoB,yCACpBC,yBAA2B,IAAA;AAejC,SAASC,GAA0BC,GAGxB;AACT,QAAM,EAAE,cAAAC,GAAc,gBAAAC,EAAA,IAAmBF,GACnCG,IAAoB,CAAA;AAC1B,SAAIF,KACFE,EAAQ;AAAA,IACN;AAAA,EAAA,GAGAD,KAAkB,CAACD,KACrBE,EAAQ;AAAA,IACN;AAAA,EAAA,GAQG;AAAA;AAAA;AAAA,WAJYA,EAAQ,SACvBA,EAAQ,KAAK,GAAG,IAChB,6CAKe;AAAA;AAAA;AAAA;AAIrB;AAEA,SAASC,GACPlsB,GACAb,GACM;AACN,MAAKa,GAIL;AAAA,QAAIb,GAAU;AACZ,MAAAusB,GAAyB,IAAI1rB,GAAcb,CAAQ;AACnD;AAAA,IACF;AAEA,IAAAusB,GAAyB,OAAO1rB,CAAY;AAAA;AAC9C;AAEA,SAASmsB,GACPnsB,GAC+B;AAC/B,MAAI,CAACA,KAAgB,OAAO,SAAW;AACrC,WAAO;AAGT,MAAI0rB,GAAyB,IAAI1rB,CAAY,GAAG;AAC9C,UAAMosB,IAASV,GAAyB,IAAI1rB,CAAY,KAAK;AAC7D,QAAIosB;AACF,aAAOA;AAAA,EAEX;AAEA,SAAO;AACT;AAEA,SAASC,GAAmBrsB,GAA4C;AACtE,SAAKwrB,GAAuB,IAAIxrB,CAAY,KAC1CwrB,GAAuB,IAAIxrB,GAAc,oBAAI,IAAA,CAAK,GAE7CwrB,GAAuB,IAAIxrB,CAAY;AAChD;AAEA,SAASssB,GAAuBtsB,GAA+C;AAC7E,MAAKA,KAIDwrB,GAAuB,IAAIxrB,CAAY,GAAG;AAC5C,QAAI;AACF,YAAMusB,IAAQf,GAAuB,IAAIxrB,CAAY;AACrD,MAAIusB,KACFA,EAAM,MAAA;AAAA,IAEV,SAAS50B,GAAO;AACd,cAAQ,KAAK,qDAAqDqI,GAAcrI,CAAK;AAAA,IACvF;AACA,IAAA6zB,GAAuB,OAAOxrB,CAAY;AAAA,EAC5C;AACF;AAEA,SAASwsB,GAAyBxsB,GAA+C;AAC/E,EAAKA,KAIL0rB,GAAyB,OAAO1rB,CAAY;AAC9C;AAEA,SAASysB,GACPzsB,GACA6O,GACM;AACN,MAAI,CAAC7O,KAAgB,CAAC6O;AACpB;AAGF,QAAMtL,IAAUsL,EAAO;AAGvB,GAFmB,MAAM,QAAQtL,CAAO,IAAIA,IAAU,CAAA,GAEvC,SAASvD,CAAY,MAClCssB,GAAuBtsB,CAAY,GACnCwsB,GAAyBxsB,CAAY;AAEzC;AAEA,SAAS0sB,GAA6B1sB,GAA+C;AACnF,MAAI,CAACA,KAAgB4rB,GAAqB,IAAI5rB,CAAY;AACxD;AAGF,QAAM2sB,IAA6B,CAACv0B,MAAU;AAC5C,IAAK8yB,GAAiC9yB,CAAK,KAG3Cq0B,GAA4BzsB,GAAc5H,EAAM,MAAM;AAAA,EACxD;AAEA,MAAI;AACF,WAAO,iBAAiBuzB,IAAmBgB,CAAwB,GACnEf,GAAqB,IAAI5rB,GAAc2sB,CAAO;AAAA,EAChD,SAASh1B,GAAO;AACd,YAAQ,MAAM,8DAA8DA,CAAK;AAAA,EACnF;AACF;AAEA,SAASi1B,GAA6B5sB,GAA4B;AAChE,MAAI,CAACA,KAAgB,CAAC4rB,GAAqB,IAAI5rB,CAAY;AACzD;AAGF,QAAM2sB,IAAUf,GAAqB,IAAI5rB,CAAY;AACrD,MAAI;AACF,IAAI2sB,KACF,OAAO,oBAAoBhB,IAAmBgB,CAAwB;AAAA,EAE1E,SAASh1B,GAAO;AACd,YAAQ,MAAM,wEAAwEA,CAAK;AAAA,EAC7F;AAEA,EAAAi0B,GAAqB,OAAO5rB,CAAY;AAC1C;AAEA,SAAS6sB,GAA2B7sB,GAA4B;AAC9D,EAAKA,MAIL4sB,GAA6B5sB,CAAY,GACzCssB,GAAuBtsB,CAAY,GACnCwsB,GAAyBxsB,CAAY;AAGvC;AAEA,SAAS8sB,GAAe9sB,GAAsB+sB,GAAyC;AACrF,MAAI,CAACtB,GAAqB,IAAIzrB,CAAY,GAAG;AAC3C,IAAAyrB,GAAqB,IAAIzrB,GAAc,EAAE,aAAa+sB,GAAU;AAChE;AAAA,EACF;AACA,QAAMpJ,IAAQ8H,GAAqB,IAAIzrB,CAAY;AACnD,EAAI2jB,MACFA,EAAM,cAAcoJ;AAExB;AAEA,SAASC,GAAehtB,GAA+C;Af/SvE,MAAA+B;AegTE,WACEA,IAAA0pB,GAAqB,IAAIzrB,CAAY,MAArC,gBAAA+B,EAAwC,gBAAeqpB;AAE3D;AAEA,SAAS6B,GAAW7K,GAAoB;AACtC,QAAM8K,IAAU,KAAK;AAAA,IACnB9K,EAAK,eAAA;AAAA,IACLA,EAAK,YAAA;AAAA,IACLA,EAAK,WAAA;AAAA,EAAW;AAElB,SAAO,KAAK,MAAM8K,IAAU,KAAQ;AACtC;AAEA,SAASC,GAAc/K,GAAkB;AACvC,QAAMjb,IAAQ,IAAI,KAAKib,EAAK,SAAS;AACrC,SAAAjb,EAAM,YAAY,GAAG,GAAG,GAAG,CAAC,GACrBA;AACT;AAEA,SAAS7I,EAAevF,GAA+B;AACrD,SAAO2L,GAAiB3L,CAAK;AAC/B;AAEA,SAASq0B,GAAwBr0B,GAA+B;AAC9D,MAAI,OAAOA,KAAU;AACnB,WAAO;AAGT,QAAMwF,IAAUxF,EAAM,KAAA;AACtB,SAAOwF,KAAoB;AAC7B;AAEA,SAAS8uB,GAAgBt0B,GAA+B;AACtD,QAAMyF,IAAa4uB,GAAwBr0B,CAAK;AAChD,SAAOyF,IAAaA,EAAW,YAAA,IAAgB;AACjD;AAEA,SAAS8uB,GAAiB31B,GAAgB+N,IAAW,sBAA8B;AACjF,MAAI,OAAO/N,KAAU,UAAU;AAC7B,UAAM4G,IAAU5G,EAAM,KAAA;AACtB,WAAO4G,KAAoBmH;AAAA,EAC7B;AAEA,MAAI/N,aAAiB,OAAO;AAC1B,UAAM4G,IAAU5G,EAAM,QAAQ,KAAA;AAC9B,WAAO4G,KAAoBmH;AAAA,EAC7B;AAEA,MAAI/N,KAAS;AACX,QAAI;AACF,YAAM6V,IAAa,KAAK,UAAU7V,CAAK;AACvC,UAAI6V,KAAcA,MAAe;AAC/B,eAAOA;AAAA,IAEX,QAAQ;AAAA,IAER;AAGF,SAAO9H;AACT;AAEA,SAAS6nB,GAAoBR,GAA2D;AACtF,QAAMS,IAAML,GAAc,oBAAI,MAAM,GAC9B/D,IAAYkC,GAAiByB,CAAQ,GACrCtyB,IAAkC,EAAE,UAAUwyB,GAAWO,CAAG,EAAA;AAElE,MAAI,OAAO,SAASpE,CAAS,KAAKA,IAAY,GAAG;AAC/C,UAAM3K,IAAQ,IAAI,KAAK+O,EAAI,SAAS;AACpC,IAAA/O,EAAM,WAAWA,EAAM,WAAA,KAAgB2K,IAAY,EAAE,GACrD3uB,EAAQ,aAAawyB,GAAWxO,CAAK;AAAA,EACvC;AAEA,SAAOhkB;AACT;AAEA,SAASgzB,GAAiB7qB,GAA2B;AACnD,MAAI,CAACA;AACH,WAAO;AAGT,MAAIA,aAAe,QAAQ,CAAC,OAAO,MAAMA,EAAI,QAAA,CAAS;AACpD,WAAO,IAAI,KAAKA,EAAI,SAAS;AAG/B,MAAI,OAAOA,KAAQ,YAAY,OAAO,SAASA,CAAG,GAAG;AACnD,UAAM0e,IAAY1e,IAAM;AACxB,QAAI,OAAO,SAAS0e,CAAS;AAC3B,aAAO,IAAI,KAAKA,CAAS;AAAA,EAE7B;AAEA,MAAI,OAAO1e,KAAQ,UAAU;AAC3B,UAAMrE,IAAUqE,EAAI,KAAA;AACpB,QAAI,UAAU,KAAKrE,CAAO,GAAG;AAC3B,YAAMmvB,IAAO,OAAO,SAASnvB,EAAQ,MAAM,GAAG,CAAC,GAAG,EAAE,GAC9CovB,IAAQ,OAAO,SAASpvB,EAAQ,MAAM,GAAG,CAAC,GAAG,EAAE,IAAI,GACnDqvB,IAAM,OAAO,SAASrvB,EAAQ,MAAM,GAAG,CAAC,GAAG,EAAE;AACnD,UACE,OAAO,SAASmvB,CAAI,KACpB,OAAO,SAASC,CAAK,KACrB,OAAO,SAASC,CAAG,GACnB;AACA,cAAMxL,IAAO,IAAI,KAAK,KAAK,IAAIsL,GAAMC,GAAOC,CAAG,CAAC;AAChD,YAAI,CAAC,OAAO,MAAMxL,EAAK,QAAA,CAAS;AAC9B,iBAAOA;AAAA,MAEX;AAAA,IACF;AAEA,UAAM9oB,IAAS,KAAK,MAAMiF,CAAO;AACjC,QAAI,OAAO,SAASjF,CAAM;AACxB,aAAO,IAAI,KAAKA,CAAM;AAAA,EAE1B;AAEA,SAAO;AACT;AAEA,SAASu0B,GAAe90B,GAA+B;AACrD,MAAI,CAACA,KAASA,MAAU;AACtB,WAAO;AAGT,MAAIA,aAAiB,QAAQ,CAAC,OAAO,MAAMA,EAAM,QAAA,CAAS;AACxD,WAAOA,EAAM,QAAA;AAGf,MAAI,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK,GAAG;AACvD,QAAIA,IAAQ;AACV,aAAOA;AAGT,QAAIA,IAAQ;AACV,aAAOA,IAAQ;AAAA,EAEnB;AAEA,MAAI,OAAOA,KAAU,UAAU;AAC7B,UAAMwF,IAAUxF,EAAM,KAAA;AACtB,QAAI,CAACwF;AACH,aAAO;AAGT,UAAMjF,IAAS,KAAK,MAAMiF,CAAO;AACjC,QAAI,OAAO,SAASjF,CAAM;AACxB,aAAOA;AAAA,EAEX;AAEA,SAAO;AACT;AAEA,SAASw0B,GAAuBC,GAA2C;AACzE,SAAK,MAAM,QAAQA,CAAM,IAIjBA,EACL,IAAI,CAACluB,MAAyC;AAE7C,QAAImuB,IADoB1vB,EAAeuB,EAAM,KAAK;AAElD,QAAImuB,KAAS,MAAM;AACjB,YAAMC,IAAW3vB,EAAeuB,EAAM,SAAS;AAC/C,MAAIouB,KAAY,SACdD,IAAQC,IAAW;AAAA,IAEvB;AAEA,WAAID,KAAS,OACJ,OAKF;AAAA,MACL,MAHgBP,GAAiB5tB,EAAM,IAAI,KAGvBA,EAAM;AAAA,MAC1B,OAAAmuB;AAAA,IAAA;AAAA,EAEJ,CAAC,EACA,OAAO,CAACnuB,MAA2C,EAAQA,CAAM,IAzB3D,CAAA;AA0BX;AAEA,SAASquB,GACP/uB,GACe;Af1ejB,MAAA4C;Ae2eE,QAAM6F,IACJtJ,EAAea,KAAA,gBAAAA,EAAU,iBAAiB,KAC1Cb,GAAeyD,IAAA5C,KAAA,gBAAAA,EAAU,eAAV,gBAAA4C,EAAsB,MAAM,KAC3C;AAEF,MAAIoV,EAAevP,CAAM;AACvB,WAAOA;AAIT,MADiBylB,GAAgBluB,KAAA,gBAAAA,EAAU,aAAa,MACvC,OAAO;AACtB,UAAMkB,IAAe/B,EAAea,KAAA,gBAAAA,EAAU,cAAc;AAC5D,QAAIgY,EAAe9W,CAAY;AAC7B,aAAOA;AAAA,EAEX;AAEA,SAAO;AACT;AAEA,SAAS8tB,GACPhvB,GACe;AACf,MAAI,CAACA;AACH,WAAO;AAIT,QAAMivB,IADiBjvB,EACU,uBAC3BkvB,IAAsBR,GAAeO,CAAS;AACpD,MAAIC,KAAuB;AACzB,WAAOA;AAGT,QAAMC,IAAkBnvB,EAAS,YAC3BovB,IAAqBD,KAAA,gBAAAA,EAAiB;AAE5C,SADqCT,GAAeU,CAAkB,KAC/B;AACzC;AAEA,SAASC,GACPC,GACAtvB,GAC0B;AAC1B,MAAIuvB,IAAuC,CAAA;AAC3C,EAAI,MAAM,QAAQD,CAAa,MAC7BC,IAAcD,EAA2C,IAAI,CAAC5uB,OAAW;AAAA,IACvE,GAAGA;AAAA,EAAA,EACH;AAEJ,QAAM8uB,IAA+CD,EAAW,MAAA,GAE1DtuB,IAAkB8tB,GAA+B/uB,CAAQ;AAC/D,MAAI,CAACgY,EAAe/W,CAAe;AACjC,WAAOuuB;AAGT,QAAMC,IAAqBT,GAAkChvB,CAAQ,KAAK,KAAK,IAAA,GACzE0vB,IAAgB,IAAI,KAAKD,CAAkB;AACjD,MAAI,OAAO,MAAMC,EAAc,QAAA,CAAS;AACtC,WAAOF;AAGT,QAAMG,IAAY7B,GAAWE,GAAc0B,CAAa,CAAC;AACzD,MAAIE,IAAiC;AAErC,WAAS5L,IAAQwL,EAAmB,SAAS,GAAGxL,KAAS,GAAGA,KAAS,GAAG;AACtE,UAAMtjB,IAAQ8uB,EAAmBxL,CAAK,GAChC6L,IAAavB,GAAiB5tB,EAAM,IAAI;AAC9C,QAAI,CAACmvB;AACH;AAGF,UAAMC,IAAWhC,GAAWE,GAAc6B,CAAU,CAAC;AAKrD,QAJID,KAAmB,SACrBA,IAAkBE,IAGhBA,MAAaH;AACf,aAAIjvB,EAAM,UAAUO,MAClBuuB,EAAmBxL,CAAK,IAAI,EAAE,GAAGtjB,GAAO,OAAOO,EAAA,IAE1CuuB;AAGT,QAAIM,IAAWH;AACb;AAAA,EAEJ;AAEA,SAAIC,KAAmB,QAAQA,IAAkBD,KAIjDH,EAAmB,KAAK;AAAA,IACtB,MAAME;AAAA,IACN,OAAOzuB;AAAA,EAAA,CACR,GAEMuuB;AACT;AAEA,SAASxX,EAAepe,GAAmD;AACzE,SAAO,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK;AAC3D;AAEA,SAASm2B,GAAiBn2B,GAAmD;AAC3E,SAAO,OAAOA,KAAU,YAAY,OAAO,SAASA,CAAK,KAAKA,IAAQ;AACxE;AAEA,SAASo2B,GACPC,GACAC,GACAC,GACS;AACT,MAAI,CAACnY,EAAeiY,CAAK,KAAK,CAACjY,EAAekY,CAAM;AAClD,WAAO;AAGT,QAAME,IAAe,KAAK,IAAIH,IAAQC,CAAM,GAKtCG,IAAQ,KAAK,IAAI,KAAK,IAAIJ,CAAK,GAAG,KAAK,IAAIC,CAAM,GAAG,CAAC;AAC3D,SAAOE,KAAgBC,IAAQ;AACjC;AAEA,SAASC,GACPnmB,GACAomB,GACe;AACf,SAAI,CAACvY,EAAeuY,CAAS,KAAKA,MAAc,KAAK,CAACvY,EAAe7N,CAAO,IACnE,OAGFxD,IAAwBwD,IAAUomB,KAAaA,IAAa,GAAG;AACxE;AAEA,SAASC,GACPlB,GACAruB,GAC+D;AAC/D,MAAIquB,EAAc,WAAW;AAC3B,WAAO,EAAE,aAAa,MAAM,gBAAgB,KAAA;AAG9C,QAAMmB,IAAanB,EAAc,CAAC,GAC5B5K,IAAWvlB,EAAesxB,EAAW,KAAK;AAChD,MAAI,CAACzY,EAAe0M,CAAQ,KAAKA,MAAa;AAC5C,WAAO,EAAE,aAAa,MAAM,gBAAgB,KAAA;AAG9C,QAAMgM,IAAYpB,EAAcA,EAAc,SAAS,CAAC,GAClDqB,IAAexxB,EAAeuxB,EAAU,KAAK,GAC7CE,IACJzxB,EAAe8B,CAAe,KAAK0vB;AAErC,MAAI,CAAC3Y,EAAe4Y,CAAa;AAC/B,WAAO,EAAE,aAAa,MAAM,gBAAgB,KAAA;AAG9C,QAAMC,IAAWD,IAAgBlM,GAC3BoM,IAAc,OAAO,GAAGD,GAAU,EAAE,IAAI,IAAIA,GAC5CE,IAAiBT,GAAwBM,GAAelM,CAAQ;AAEtE,SAAO,EAAE,aAAAoM,GAAa,gBAAAC,EAAA;AACxB;AAEA,SAASC,GACPp3B,GACAJ,GACqC;AACrC,MAAI,CAACwe,EAAepe,CAAK,KAAKA,MAAU;AACtC,WAAO;AAGT,QAAMH,IAAY,MAAM,KAAK,IAAI,IAAID,CAAQ;AAC7C,SAAI,KAAK,IAAII,CAAK,IAAIH,IACb,YAGFG,IAAQ,IAAI,aAAa;AAClC;AAEA,SAASq3B,GACPr3B,GACA0e,GACQ;AACR,MAAI,CAACN,EAAepe,CAAK;AACvB,WAAO;AAGT,QAAMG,IAAYm3B,GAAYt3B,CAAK;AACnC,MAAIG,MAAc;AAChB,WAAO;AAGT,QAAMo3B,IAAaH,GAAyBp3B,GAAOme,GAAsB,GAAG,GACtEqZ,IAAS9Y,IAAW,SAASA,CAAQ,KAAK;AAChD,SAAO,sBAAsB6Y,CAAU,KAAKp3B,CAAS,GAAGq3B,CAAM;AAChE;AAEA,SAASC,GAA4Bz3B,GAA8B;AACjE,SAAKoe,EAAepe,CAAK,IAKlB,sBADYo3B,GAAyBp3B,GAAO,CAAC,CACb,uBAAuBgD,EAAahD,CAAK,CAAC,mBAJxE;AAKX;AAEA,SAAS03B,GACP1D,GACAkD,GACAC,GACAzY,GACQ;AACR,QAAMiZ,IAAa3D,GACb4D,IAAeD,EAAW,SAAS,IAAIA,IAAa;AAC1D,SAAO;AAAA,iDACwCA,CAAU;AAAA;AAAA,6CAEdC,CAAY;AAAA;AAAA,YAE7CP,GAAuBH,GAAaxY,CAAQ,CAAC;AAAA,YAC7C+Y,GAA4BN,CAAc,CAAC;AAAA;AAAA;AAAA;AAAA;AAKvD;AAEA,SAASU,GAAmBC,GAA8C;AAexE,SAAO;AAAA;AAAA,QAdSxF,GAAyB,IAAI,CAAC0B,MAErC;AAAA;AAAA;AAAA,sCADaA,MAAa8D,IAAc,YAAY,EAId;AAAA,sBAC3B9D,CAAQ;AAAA,wBACNA,MAAa8D,IAAc,SAAS,OAAO;AAAA;AAAA,UAEzD9D,CAAQ;AAAA;AAAA,KAGf,EAIa,KAAK;AAAA,CAAI,CAAC;AAAA;AAAA;AAG1B;AAEA,SAAS+D,GACP/D,GACApJ,IAAiC,EAAE,QAAQ,WACnC;AACR,QAAMoN,IAAYhE;AAElB,UAAQpJ,EAAM,QAAA;AAAA,IACZ,KAAK,UAAU;AACb,YAAMqN,IAAaD,EAAU,SAAS,IAAI,QAAQA,CAAS,KAAK;AAChE,aAAO;AAAA;AAAA;AAAA;AAAA,wBAIWA,CAAS;AAAA;AAAA,oCAEGC,CAAU;AAAA;AAAA;AAAA,IAG1C;AAAA,IACA,KAAK,SAAS;AACZ,YAAM3S,IAAUiP;AAAA,QACd3J,EAAM;AAAA,QACN;AAAA,MAAA;AAEF,aAAO;AAAA,0EAC6DoN,CAAS;AAAA,eACpE1S,CAAO;AAAA;AAAA;AAAA,IAGlB;AAAA,IACA,KAAK;AAAA,IACL,SAAS;AACP,YAAM4S,IAAkBF,EAAU,SAAS,IAAIA,IAAY;AAC3D,aAAO;AAAA,0EAC6DA,CAAS;AAAA,wDAC3BE,CAAe;AAAA;AAAA;AAAA,IAGnE;AAAA,EAAA;AAEJ;AAEA,SAASC,GAAen4B,GAAwB;AAC9C,QAAMkB,IAAUqE,EAAevF,CAAK;AACpC,MAAIkB,KAAW;AACb,WAAO;AAGT,QAAME,IAAc,KAAK,IAAIF,IAAU,CAAC,IAAI,GACtCk3B,IAAch3B,IAAc,IAAIgxB,GAAyB,KACzDiG,IAAcj3B,IAAcgxB,GAAyB,MAAMA,GAAyB;AAC1F,SAAOlxB,EAAQ,eAAe,SAAS;AAAA,IACrC,uBAAuBk3B;AAAA,IACvB,uBAAuBC;AAAA,EAAA,CACxB;AACH;AAEA,SAASf,GAAYt3B,GAAwB;AAC3C,QAAMkB,IAAUqE,EAAevF,CAAK;AACpC,SAAIkB,KAAW,OACN,MAGFA,EAAQ,eAAe,SAAS;AAAA,IACrC,uBAAuBid,GAAsB;AAAA,IAC7C,uBAAuBA,GAAsB;AAAA,EAAA,CAC9C;AACH;AAEA,SAASma,GACPt4B,GACA0e,GACQ;AACR,QAAMve,IAAYm3B,GAAYt3B,CAAK,GAC7Bw3B,IAAoB,SAAS9Y,CAAQ;AAE3C,SAAO,gBADW0Y,GAAyBp3B,GAAOme,GAAsB,GAAG,CAC3C,KAAKhe,CAAS,GAAGq3B,CAAM;AACzD;AAEA,SAASz1B,GACP/B,GACQ;AACR,SAAIA,KAAU,OACL,MAGG,OAAOA,KAAU,WAAWA,IAAQ,OAAOA,CAAK,GAGzD,QAAQ,MAAM,OAAO,EACrB,QAAQ,MAAM,QAAQ,EACtB,QAAQ,MAAM,MAAM,EACpB,QAAQ,MAAM,MAAM;AACzB;AAEA,SAASu4B,GACPnyB,GACAoyB,GACAC,GACe;AACf,QAAMC,IAAwB9pB,GAA4BxI,KAAA,gBAAAA,EAAU,YAAY,GAC1EuyB,KACJD,KAAA,gBAAAA,EAAuB,aACtBta,EAAeoa,CAAc,IAAIA,IAAiBjzB,EAAeizB,CAAc;AAElF,MAAI,CAACpa,EAAeua,CAAqB;AACvC,WAAO;AAGT,QAAMC,KACHxyB,KAAA,gBAAAA,EAAqE,2BACrEA,KAAA,gBAAAA,EAAgE;AACnE,MAAI,OAAOwyB,KAAgB,YAAYA,EAAY;AACjD,WAAOA,EAAY,KAAA,EAAO,YAAA;AAG5B,QAAMha,IAAmB0V,GAAgBluB,KAAA,gBAAAA,EAAU,aAAa,KAAK,IAC/DyyB,KACJH,KAAA,gBAAAA,EAAuB,cACvBA,KAAA,gBAAAA,EAAuB,YACtBta,EAAeqa,CAAe,IAAIA,IAAkBlzB,EAAekzB,CAAe,IAE/En2B,IAAc2M,GAA4B7I,KAAA,gBAAAA,EAAU,WAAW;AACrE,MACEwY,KACAR,EAAeya,CAAsB,KACrCzC,GAAgBuC,GAAuBE,CAAsB;AAE7D,WAAOja;AAGT,QAAMvP,IACJ9J,EAAejD,KAAA,gBAAAA,EAAa,uBAAuB,KACnDiD,EAAgBa,KAAA,gBAAAA,EAAuE,uBAAuB,GAC1GkJ,IACJ/J,EAAejD,KAAA,gBAAAA,EAAa,sBAAsB,KAClDiD,EAAgBa,KAAA,gBAAAA,EAAsE,sBAAsB;AAC9G,MAAIqL,IAAuB;AAM3B,MALI2M,EAAe/O,CAAa,KAAKA,MAAkB,KAAK+O,EAAe9O,CAAY,MACrFmC,IAAQnC,IAAeD,KAGHqpB,KAAA,gBAAAA,EAAuB,YACvB;AACpB,WAAO;AAGT,QAAMzZ,IAAayZ,KAAA,gBAAAA,EAAuB;AAC1C,MAAIta,EAAea,CAAU,KAAKmX,GAAgBuC,GAAuB1Z,CAAU;AACjF,WAAO;AAGT,QAAM7P,IAAmB7J,EAAea,KAAA,gBAAAA,EAAU,kBAAkB;AACpE,SAAIgY,EAAehP,CAAgB,IAC1B,QAGLqC,KAAS,QAAQ2kB,GAAgB3kB,GAAO,CAAC,IACpCmN,KAAoB,OAGzBA,MAAqB,QAChB,QAGFA,KAAoB;AAC7B;AAEA,SAASka,GAAa94B,GAAiD;AACrE,SAAI,OAAOA,KAAU,YAAY,CAAC,OAAO,SAASA,CAAK,KAAKA,KAAS,IAC5D,OAGFA,EAAM,eAAe,SAAS;AAAA,IACnC,uBAAuB;AAAA,IACvB,uBAAuB;AAAA,EAAA,CACxB;AACH;AAEA,SAAS+4B,GACP3yB,GACe;AACf,QAAM4yB,IAAiB5yB,GACjB6yB,IAAgB;AAAA,IACpB;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA;AAGF,aAAWl5B,KAAOk5B,GAAe;AAC/B,UAAMj5B,IAAQg5B,KAAA,gBAAAA,EAAiBj5B,IACzBQ,IAASu0B,GAAe90B,CAAK;AACnC,QAAIO,KAAU;AACZ,aAAOA;AAAA,EAEX;AAEA,QAAM24B,IAAgC,CAAA;AACtC,EAAIF,KAAkB,2BAA2BA,KAC/CE,EAAmB,KAAKF,EAAe,qBAAqB;AAE9D,QAAMG,IAAa/yB,KAAA,gBAAAA,EAAsE;AACzF,EAAI+yB,KAAa,OAAOA,KAAc,YACpCD,EAAmB,KAAKC,EAAU,UAAU,GAE1CH,KAAkB,qBAAqBA,KACzCE,EAAmB,KAAKF,EAAe,eAAe;AAGxD,aAAWx2B,KAAa02B,GAAoB;AAC1C,UAAM34B,IAASu0B,GAAetyB,CAAS;AACvC,QAAIjC,KAAU;AACZ,aAAOA;AAAA,EAEX;AAEA,SAAO;AACT;AAEA,SAAS64B,GAAkB7Q,GAAyC;AAClE,MAAIA,KAAa,QAAQ,CAAC,OAAO,SAASA,CAAS;AACjD,WAAO;AAGT,QAAMc,IAAO,IAAI,KAAKd,CAAS;AAC/B,SAAI,OAAO,MAAMc,EAAK,QAAA,CAAS,IACtB,OAGFA,EAAK,mBAAmB,SAAS;AAAA,IACtC,KAAK;AAAA,IACL,OAAO;AAAA,IACP,MAAM;AAAA,EAAA,CACP;AACH;AAEA,SAASgQ,GACPjzB,GACAyY,GACe;AACf,MAAI,CAACzY;AACH,WAAO;AAET,QAAMwY,IAAmB0V,GAAgBluB,EAAS,aAAa,KAAK,IAC9DkzB,IAAsBhF,GAAgBzV,CAAe,KAAK;AAEhE,MAAI,CAACD,KAAoB,CAAC0a,KAAuB1a,MAAqB0a;AACpE,WAAO;AAGT,QAAM7pB,IAAcb,GAA4BxI,EAAS,YAAY;AACrE,MAAI,CAACqJ;AACH,WAAO;AAGT,QAAMgpB,IAAkBhpB,EAAY,UAAUA,EAAY,YAAY,MAChE+oB,IAAiB/oB,EAAY,WAAWA,EAAY,OAAO;AAEjE,MAAI,CAAC0mB,GAAiBsC,CAAe,KAAK,CAACtC,GAAiBqC,CAAc;AACxE,WAAO;AAGT,QAAMnyB,IAASmyB,IAAiBC;AAChC,MAAI,CAAC,OAAO,SAASpyB,CAAM,KAAKA,KAAU;AACxC,WAAO;AAGT,QAAMkzB,IAAgBT,GAAazyB,CAAM;AACzC,MAAI,CAACkzB;AACH,WAAO;AAGT,MAAIC,IAAkC;AACtC,MAAInzB,IAAS,GAAG;AACd,UAAMozB,IAAU,IAAIpzB;AACpB,IAAI,OAAO,SAASozB,CAAO,KAAKA,IAAU,MACxCD,IAAmBV,GAAaW,CAAO;AAAA,EAE3C;AAEA,QAAMlR,IAAYwQ,GAA2B3yB,CAAQ,GAC/CszB,IAAYN,GAAkB7Q,CAAS,GAEvC5I,IAAQ,CAAC,qBAAqBf,CAAgB,MAAM2a,CAAa,IAAID,CAAmB,EAAE;AAChG,EAAIE,KACF7Z,EAAM,KAAK,KAAK2Z,CAAmB,MAAME,CAAgB,IAAI5a,CAAgB,EAAE;AAGjF,QAAM+a,IAA0B,CAAA,GAC1BC,IAAYnqB,EAAY,QACxBoqB,IACJD,KAAapH,KACTA,GAA2BoH,CAAS,IACpCpH,GAA2B;AAGjC,MAFAmH,EAAc,KAAK,WAAWE,CAAW,EAAE,GAEvCzb,EAAe3O,EAAY,cAAc,GAAG;AAC9C,UAAMqqB,IAAa,KAAK,IAAI,KAAK,IAAIrqB,EAAY,iBAAiB,KAAK,CAAC,GAAG,GAAG;AAC9E,IAAAkqB,EAAc;AAAA,MACZ,cAAcG,EAAW,eAAe,SAAS;AAAA,QAC/C,uBAAuB;AAAA,QACvB,uBAAuB;AAAA,MAAA,CACxB,CAAC;AAAA,IAAA;AAAA,EAEN;AAEA,EAAIH,EAAc,UAChBha,EAAM,KAAK,GAAGga,CAAa;AAG7B,QAAMI,IAAWL,KAAa;AAC9B,SAAO,GAAG/Z,EAAM,KAAK,KAAK,CAAC,YAAYoa,CAAQ;AACjD;AAEA,SAASC,GACP5zB,GACe;AACf,MAAI,CAACA;AACH,WAAO;AAET,QAAMqJ,IAAcb,GAA4BxI,EAAS,YAAY,GAC/D0kB,KAAWrb,KAAA,gBAAAA,EAAa,YAAUA,KAAA,gBAAAA,EAAa,aAAY;AACjE,SAAO2O,EAAe0M,CAAQ,IAAIA,IAAW;AAC/C;AAEA,SAASmP,GAAgB7zB,GAAiD;Af1jC1E,MAAA4C;Ae2jCE,MAAI,CAAC5C;AACH,WAAO;AAGT,QAAMsY,IAAWtY,EAAS,iBAAiB,OACrC8zB,IAAiB9zB,EAAS,0BAA0BA,EAAS,gBAC7D+zB,IAAWhC,GAAe+B,CAAc,GACxCE,IACJh0B,EAAS,uBAAqB4C,IAAA5C,EAAS,eAAT,gBAAA4C,EAAqB,WAAU5C,EAAS,gBAClEi0B,IAAqB/C,GAAY8C,CAAkB,GACnDE,IACJD,MAAuB,MACnB,OACA,GAAGA,CAAkB,GAAc,SAAS3b,CAAQ,EAAO,IAC3D6b,IACJh1B,EAAea,EAAS,gBAAgB,KACxCb,EAAea,EAAS,iBAAiB,KACzC,MACIqJ,IAAcb,GAA4BxI,EAAS,YAAY,GAC/Do0B,KACJ/qB,KAAA,gBAAAA,EAAa,YACbA,KAAA,gBAAAA,EAAa,aACb,MACIgrB,KAAwBhrB,KAAA,gBAAAA,EAAa,QAAO,MAE5CirB,KAD4BjrB,KAAA,gBAAAA,EAAa,YAAW,QACEgrB,GACtDE,IAAqBntB,GAA4BpH,EAAS,WAAW,GACrEw0B,KAAmBD,KAAA,gBAAAA,EAAoB,eAAc,MACrDE,KAAuBD,KAAA,gBAAAA,EAAkB,wBAAuB,MAChEE,KAAoBF,KAAA,gBAAAA,EAAkB,qBAAoB,MAC1DG,IAAiB3c,EAAeyc,CAAoB,IACtDA,IACAC,GACEE,IAAoB5c,EAAeyc,CAAoB,IACzDnc,IACA,OAEEuc,IAAY,CAACC,GAAiBC,IAAa,OAAe;AAC9D,UAAMC,IAAU,CAAC,OAAO;AACxB,WAAID,KACFC,EAAQ,KAAK,GAAGD,EAAW,MAAM,GAAG,EAAE,OAAO,OAAO,CAAC,GAEhD,gBAAgBC,EAAQ,KAAK,GAAG,CAAC,KAAKF,CAAO;AAAA,EACtD,GAEMG,IAAmB,CAACF,IAAa,OAAe;AACpD,UAAMC,IAAU,CAAC,gBAAgB;AACjC,WAAID,KACFC,EAAQ,KAAKD,CAAU,GAElBF,EAAU,KAAKG,EAAQ,KAAK,GAAG,CAAC;AAAA,EACzC,GAEME,IAAkB,CACtBt7B,GACAm7B,IAAa,OACF;AACX,QAAI,CAAC/c,EAAepe,CAAK;AACvB,aAAOq7B,EAAiBF,CAAU;AAGpC,UAAMC,IAAU,CAAC,aAAa;AAC9B,WAAID,KACFC,EAAQ,KAAKD,CAAU,GAElBF,EAAUt3B,GAAW3D,CAAK,GAAGo7B,EAAQ,KAAK,GAAG,CAAC;AAAA,EACvD,GAEMG,IAAuB,CAC3Bv7B,GACAm7B,IAAa,OACF;AACX,QAAI,CAAC/c,EAAepe,CAAK;AACvB,aAAOq7B,EAAiBF,CAAU;AAGpC,UAAMC,IAAU,CAAC,wBAAwB;AACzC,WAAID,KACFC,EAAQ,KAAKD,CAAU,GAElBF,EAAUr3B,GAAc5D,CAAK,GAAGo7B,EAAQ,KAAK,GAAG,CAAC;AAAA,EAC1D,GAEMI,IAAiBlB,IACnBW,EAAUX,GAAkB,cAAc,IAC1Ce,EAAiB,cAAc,GAC7BI,IACJtB,MAAa,MACTkB,EAAiB,iBAAiB,IAClCJ,EAAUd,GAAU,iBAAiB,GACrCuB,IAActd,EAAemc,CAAc,IAC7CU,EAAU,GAAGj4B,EAAau3B,CAAc,CAAC,WAAW,qBAAqB,IACzEc,EAAiB,qBAAqB,GACpCM,IAAoBvd,EAAe2c,CAAc,IACnDE;AAAA,IACE3C,GAA8ByC,GAAgBC,CAAiB;AAAA,IAC/D;AAAA,EAAA,IAEFK,EAAiB,iBAAiB,GAChCO,IAAsBL;AAAA,IAC1BX,KAAA,gBAAAA,EAAkB;AAAA,IAClB;AAAA,EAAA,GAEIiB,IAAsBP;AAAA,IAC1BX,KAAA,gBAAAA,EAAoB;AAAA,IACpB;AAAA,EAAA,GAEImB,IAAwBP;AAAA,IAC5BZ,KAAA,gBAAAA,EAAoB;AAAA,IACpB;AAAA,EAAA,GAEI9b,IAAkB0Z;AAAA,IACtBnyB;AAAA,IACAs0B;AAAA,IACAF;AAAA,EAAA,GAEIuB,IAAyB1C;AAAA,IAC7BjzB;AAAA,IACAyY;AAAA,EAAA,GAEImd,IAA8BD,IAChC,WAAWh6B,GAAgBg6B,CAAsB,CAAC,MAClD,IACEE,IAAkC,CAAA;AAExC,SAAI7d,EAAeoc,CAAwB,IACzCyB,EAAsB;AAAA,IACpBhB;AAAA,MACE,GAAG3D,GAAYkD,CAAwB,CAAC,GAC3B,SAAS9b,CAAQ,EAC9B;AAAA,MACA;AAAA,IAAA;AAAA,EACF,IAGFud,EAAsB;AAAA,IACpBZ,EAAiB,sCAAsC;AAAA,EAAA,GAKzDjd,EAAesc,CAAsB,MACpC,CAACtc,EAAeoc,CAAwB,KACvC,CAAC3b,KACD,CAACH,KACDG,MAAoBH,KACpB,CAAC0X,GAAgBsE,GAAwBF,CAAwB,MAErCpc,EAAesc,CAAsB,KACnEuB,EAAsB;AAAA,IACpBhB;AAAA,MACE,GAAG3D,GAAYoD,CAAsB,CAAC,GACpC7b,IAAkB,SAASA,CAAe,KAAK,EACjD;AAAA,MACA;AAAA,IAAA;AAAA,EACF,GAIG;AAAA;AAAA;AAAA;AAAA,mCAI0B2c,CAAc;AAAA;AAAA;AAAA;AAAA,kCAIfQ,CAA2B;AAAA,YACjDC,EAAsB,KAAK,EAAE,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAM9BN,CAAiB;AAAA,YACjBC,CAAmB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAMnBC,CAAmB;AAAA,YACnBC,CAAqB;AAAA;AAAA;AAAA;AAAA;AAAA,mCAKEL,CAAa;AAAA;AAAA;AAAA;AAAA,mCAIbC,CAAW;AAAA;AAAA;AAAA;AAI9C;AAEA,SAASQ,GAAsBt9B,GAA+B;AAC5D,MAAI,CAACA;AACH,WAAO;AAGT,MAAI,OAAOA,KAAU;AACnB,WAAOA;AAGT,MAAIA,aAAiB;AACnB,WAAOA,EAAM,WAAW;AAG1B,MAAI;AACF,UAAM6V,IAAa,KAAK,UAAU7V,CAAK;AACvC,WAAO6V,KAAcA,MAAe,OAAOA,IAAa;AAAA,EAC1D,QAAqB;AACnB,WAAO;AAAA,EACT;AACF;AAEA,SAAS0nB,GACPC,GACAnQ,GACA;AAAA,EACE,UAAAvN;AAAA,EACA,UAAAoM;AACF,IAAoF,IAClE;AAClB,QAAMuR,IAAgBD,EAAK,eAAeA,EAAK,eAAe,GACxDhR,IAAQiR,IAAgB,IAAIA,IAAgB,KAC5CjQ,IAAS,KAAK,IAAI,KAAK,IAAI,KAAK,MAAMhB,IAAQ,IAAI,GAAG,GAAG,GAAG,GAAG,GAC9DkR,KAAgB5d,KAAY,IAAI,YAAA,KAAiB,OACjD2M,IAAgBjN,EAAe0M,CAAQ,IAAIA,IAAW;AAE5D,SAAO;AAAA,IACL,OAAAM;AAAA,IACA,QAAAgB;AAAA,IACA,QAAQ,EAAE,KAAK,IAAI,OAAO,IAAI,QAAQ,IAAI,MAAM,GAAA;AAAA,IAChD,QAAAH;AAAA,IACA,YAAY,CAACjsB,MAAUs3B,GAAYt3B,CAAK;AAAA,IACxC,iBAAiB,CAAC,EAAE,YAAAypB,GAAY,YAAAC,QAAiB;AAAA,wCACbD,CAAU;AAAA,yCACTC,CAAU,SAAS4S,CAAY;AAAA;AAAA,IAEpE,UACEjR,KAAiB,OACb;AAAA,MACE,OAAOA;AAAA,IAAA,IAET;AAAA,EAAA;AAEV;AAEA,MAAMkR,yBAA8B,QAAA;AAKpC,SAASC,GACPJ,GACAnQ,GACAvqB,IAGI,CAAA,GACE;AACN,MAAIuqB,EAAO,WAAW;AACpB;AAGF,QAAMwQ,IAAeN,GAAuBC,GAAMnQ,GAAQvqB,CAAO;AACjE,MAAIg7B,IAAiBH,GAAwB,IAAIH,CAAI,KAAK;AAE1D,MAAI,CAACM,KAAkB,CAACN,EAAK,SAASM,CAAc,GAAG;AACrD,IAAAN,EAAK,YAAY,IACjBM,IAAiBnN,GAAgB6M,GAAMK,CAAY,GAC/CC,KACFH,GAAwB,IAAIH,GAAMM,CAAc;AAElD;AAAA,EACF;AAEA,EAAA5M,GAAgB4M,GAAgBD,CAAY;AAC9C;AAEA,SAASE,GACP3lB,GACA8gB,GACM;AACN,EAAK9gB,MAILA,EAAU,QAAQ,cAAc8gB,GAChC9gB,EAAU,iBAAoC,wBAAwB,EAAE,QAAQ,CAAC4lB,MAAW;AAE1F,UAAMC,IADWD,EAAO,QAAQ,UACF9E;AAC9B,IAAA8E,EAAO,UAAU,OAAO,UAAUC,CAAQ,GAC1CD,EAAO,aAAa,gBAAgBC,IAAW,SAAS,OAAO,GAC/DD,EAAO,WAAW,IAClBA,EAAO,UAAU,OAAO,SAAS;AAAA,EACnC,CAAC;AACH;AAEA,SAASE,GACPhmB,GACAkd,GACAkD,GACAC,GACAzY,GACM;AACN,QAAMqe,IAAUjmB,EAAK,cAAc,oBAAoB;AACvD,MAAI,CAACimB,KAAW,CAACA,EAAQ;AACvB;AAGF,QAAMzV,IAAU,SAAS,cAAc,KAAK;AAC5C,EAAAA,EAAQ,YAAYoQ,GAAa1D,GAAUkD,GAAaC,GAAgBzY,CAAQ,EAAE,KAAA;AAClF,QAAMse,IAAQ1V,EAAQ;AACtB,EAAK0V,KAGLD,EAAQ,cAAc,aAAaC,GAAOD,CAAO;AACnD;AAEA,SAASE,GACPnmB,GACAkd,GACApJ,GACA8K,GACAh0B,IAGI,IACE;AACN,QAAMw7B,IAAuBpmB,EAAK,cAAc,8BAA8B;AAC9E,MAAKomB,MAILA,EAAqB,YAAY;AAAA;AAAA,MAE7BnF,GAAwB/D,GAAUpJ,CAAK,CAAC;AAAA,KAGxCA,EAAM,WAAW,YAAY,MAAM,QAAQ8K,CAAa,KAAKA,EAAc,SAAQ;AACrF,UAAM0G,IAAOc,EAAqB,cAA2B,gBAAgB;AAC7E,IAAId,KACF,sBAAsB,MAAM;AAC1B,MAAAI,GAAmBJ,GAAM1G,GAAeh0B,CAAO;AAAA,IACjD,CAAC;AAAA,EAEL;AACF;AAaA,SAASy7B,GAAmBz7B,GAA0C;AACpE,QAAM;AAAA,IACJ,MAAAoV;AAAA,IACA,MAAAhO;AAAA,IACA,aAAAC;AAAA,IACA,cAAA9B;AAAA,IACA,UAAAb;AAAA,IACA,cAAAg3B;AAAA,IACA,gBAAAC;AAAA,IACA,qBAAAC;AAAA,EAAA,IACE57B;AAEJ,aAAW,MAAM;AACf,UAAM67B,IAAgBzmB,EAAK,cAA2B,0BAA0B;AAChF,QAAI,CAACymB;AACH;AAGF,UAAM/J,IAAQF,GAAmBrsB,CAAY,GACvCu2B,IAAkBxD,GAA8B5zB,CAAQ;AAG9D,IADE,MAAM,QAAQi3B,CAAc,KAAKC,EAAoB,WAAW,WAEhE9J,EAAM,IAAI4J,GAAcC,CAAc,GAGxC1J,GAA6B1sB,CAAY,GAEzC8sB,GAAe9sB,GAAcm2B,CAAY,GACzCT,GAAmBY,GAAeH,CAAY;AAC9C,UAAMK,IAAwBhI;AAAA,MAC5B4H;AAAA,MACAj3B;AAAA,IAAA;AAEF,QAAIs3B,IAAiDJ;AACrD,IAAII,EAAsB,WAAW,YACnCA,IAAwBD,EAAsB,SAC1C,EAAE,QAAQ,aACV,EAAE,QAAQ,QAAA,IAEhBR;AAAA,MACEnmB;AAAA,MACAsmB;AAAA,MACAM;AAAA,MACAD;AAAA,MACA;AAAA,QACE,UAAUr3B,KAAA,gBAAAA,EAAU;AAAA,QACpB,UAAUo3B;AAAA,MAAA;AAAA,IACZ;AAGF,UAAMG,IAAmB,OAAO3J,MAAqD;AACnF,UAAIA,MAAaC,GAAehtB,CAAY;AAC1C;AAGF,YAAM21B,IAASW,EAAc;AAAA,QAC3B,sCAAsCvJ,CAAQ;AAAA,MAAA;AAEhD,MAAI4I,MACFA,EAAO,WAAW,IAClBA,EAAO,UAAU,IAAI,SAAS;AAGhC,UAAIlH,IAAgBlC,EAAM,IAAIQ,CAAQ,KAAK,MACvC4J,IAA+C,MAC/CC,IAAiD,CAAA;AACrD,UAAKnI;AA0BH,QAAAkI,IAAelI,EAAc,SACzB,EAAE,QAAQ,aACV,EAAE,QAAQ,QAAA;AAAA;AA3Bd,YAAI;AACF,gBAAMoI,IAAetJ,GAAoBR,CAAQ,GAC3C+J,IAAkB,MAAMxzB;AAAA,YAC5BzB;AAAA,YACAC;AAAA,YACA9B;AAAA,YACA62B;AAAA,UAAA;AAEA,UAAApI,IAAgBX,GAAuBgJ,EAAgB,MAAM,GAC/DvK,EAAM,IAAIQ,GAAU0B,CAAa,GACjCkI,IAAelI,EAAc,SACzB,EAAE,QAAQ,aACV,EAAE,QAAQ,QAAA;AAAA,QAChB,SAAS92B,GAAO;AACd,kBAAQ,MAAM,uDAAuDA,CAAK,GAC1E82B,IAAgB,CAAA,GAEhBkI,IAAe;AAAA,YACb,QAAQ;AAAA,YACR,SAHc1B,GAAsBt9B,CAAK,KAKvC;AAAA,UAAA;AAAA,QAEN;AAOA,MAAAi/B,IAAuBpI,GAAoCC,GAAetvB,CAAQ,GAC9Ew3B,EAAa,WAAW,YAC1BA,IAAeC,EAAqB,SAChC,EAAE,QAAQ,aACV,EAAE,QAAQ,QAAA;AAGlB,YAAMG,IACJ7I,GAA+B/uB,CAAQ,GACnC,EAAE,aAAA8wB,GAAa,gBAAAC,EAAA,IAAmBP;AAAA,QACtCiH;AAAA,QACAG;AAAA,MAAA;AAGF,MAAAjK,GAAe9sB,GAAc+sB,CAAQ,GACrC2I,GAAmBY,GAAevJ,CAAQ,GAC1C8I;AAAA,QACEhmB;AAAA,QACAkd;AAAA,QACAkD;AAAA,QACAC;AAAA,QACA/wB,KAAA,gBAAAA,EAAU;AAAA,MAAA;AAEZ,YAAM63B,IAAgBjE,GAA8B5zB,CAAQ;AAE5D,MAAA62B;AAAA,QACEnmB;AAAA,QACAkd;AAAA,QACA4J;AAAA,QACAC;AAAA,QACA;AAAA,UACE,UAAUz3B,KAAA,gBAAAA,EAAU;AAAA,UACpB,UAAU63B;AAAA,QAAA;AAAA,MACZ;AAAA,IAEJ;AAEA,IAAAV,EAAc,iBAAiB,SAAS,CAACl+B,MAAU;Af9iDvD,UAAA2J;Ae+iDM,YAAM4zB,KAAU5zB,IAAA3J,EAAM,WAAN,gBAAA2J,EAAqC,QAA2B;AAChF,UAAI,CAAC4zB,KAAUA,EAAO;AACpB;AAEF,YAAM,EAAE,OAAA1R,MAAU0R,EAAO;AACzB,MAAI,CAAC1R,KAAS,CAACoH,GAAyB,SAASpH,CAAgC,KAG1EyS,EAAiBzS,CAAgC;AAAA,IAC1D,CAAC;AAAA,EACH,GAAG,CAAC;AACN;AAEA,eAAsBgT,GACpBpnB,GACAhO,GACAC,GACA9B,GACiB;AACjB,MAAI,CAACA;AACH,mBAAQ,MAAM,0CAA0C,GACjD;AAGT,QAAMk3B,IAAiB/K,GAA0BnsB,CAAY;AAC7D,MAAIb,IAA0C,MAC1CxH,IAAuB;AAE3B,MAAI;AACF,UAAMmL,IAAqC,MAAMO;AAAA,MAC/CxB;AAAA,MACAC;AAAA,MACA9B;AAAA,IAAA,GAEIm3B,IAA2Br0B,EAAS;AAC1C,IAAA3D,IACEg4B,KAAmB,OAAOA,KAAoB,WACzCA,IACAr0B;AAAA,EACT,SAASkS,GAAK;AACZ,YAAQ,MAAM,8DAA8DA,CAAG,GAC/Erd,IAAQ21B,GAAiBtY,CAAG;AAAA,EAC9B;AAEA,QAAMoiB,IAAoBj4B,KAAY+3B,GAChCnL,IAAe,GAAQmL,KAAkB,CAAC/3B,IAC1C6sB,MAAkBoL,KAAA,gBAAAA,EAAmB,WAAU,QAAQ;AAC7D,EAAIp3B,KACFksB,GAA4BlsB,GAAco3B,KAAqB,IAAI;AAErE,QAAMC,IACJD,MAAsBrL,KAAgBC,KAClCH,GAA0B,EAAE,cAAAE,GAAc,gBAAAC,EAAA,CAAgB,IAC1D,IACAzvB,KAAc66B,KAAA,gBAAAA,EAAmB,SAAQ;AAE/C,MAAIz/B;AAKF,WAAO;AAAA,QAJY2E;AAAA,MACjBC;AAAA,MACAy2B,GAAgBoE,CAAiB;AAAA,IAAA,EAGpB,SAAS;AAAA,QACpBC,CAAW;AAAA;AAAA;AAAA,aAGN1/B,CAAK;AAAA;AAAA;AAKhB,QAAMk5B,IAAc7D,GAAehtB,CAAY,GACzCusB,IAAQF,GAAmBrsB,CAAY;AAC7C,MAAIyuB,IAAgBlC,EAAM,IAAIsE,CAAW,IAAItE,EAAM,IAAIsE,CAAW,KAAK,OAAO,MAC1E8F,IAAwC,EAAE,QAAQ,QAAA;AAEtD,MAAI,MAAM,QAAQlI,CAAa;AAC7B,IAAAkI,IAAelI,EAAc,SACzB,EAAE,QAAQ,aACV,EAAE,QAAQ,QAAA;AAAA,OACT;AACL,IAAAA,IAAgB,CAAA;AAChB,QAAI;AACF,YAAMoI,IAAetJ,GAAoBsD,CAAW,GAC9CiG,IAA2C,MAAMxzB;AAAA,QACrDzB;AAAA,QACAC;AAAA,QACA9B;AAAA,QACA62B;AAAA,MAAA;AAEA,MAAApI,IAAgBX,GAAuBgJ,EAAgB,MAAM,GAC/DvK,EAAM,IAAIsE,GAAapC,CAAa,GACpCkI,IAAelI,EAAc,SACzB,EAAE,QAAQ,aACV,EAAE,QAAQ,QAAA;AAAA,IAChB,SAAS6I,GAAc;AACrB,cAAQ;AAAA,QACN;AAAA,QACAA;AAAA,MAAA,GAGFX,IAAe;AAAA,QACb,QAAQ;AAAA,QACR,SAHc1B,GAAsBqC,CAAY,KAK9C;AAAA,MAAA;AAAA,IAEN;AAAA,EACF;AAEA,QAAMV,IAAuBpI;AAAA,IAC3BC;AAAA,IACA2I;AAAA,EAAA;AAEF,EAAIT,EAAa,WAAW,YAC1BA,IAAeC,EAAqB,SAChC,EAAE,QAAQ,aACV,EAAE,QAAQ,QAAA;AAGhB,QAAMn6B,IAAaH;AAAA,IACjBC;AAAA,IACAy2B,GAAgBoE,CAAiB;AAAA,EAAA,GAG7BL,IAA0B7I,GAA+BkJ,CAAiB,GAC1E,EAAE,aAAAnH,GAAa,gBAAAC,EAAA,IAAmBP;AAAA,IACtCiH;AAAA,IACAG;AAAA,EAAA,GAEIjB,IAAUrF;AAAA,IACdI;AAAA,IACAZ;AAAA,IACAC;AAAA,IACAkH,KAAA,gBAAAA,EAAmB;AAAA,EAAA;AAGrB,SAAAlB,GAAmB;AAAA,IACjB,MAAArmB;AAAA,IACA,MAAAhO;AAAA,IACA,aAAAC;AAAA,IACA,cAAA9B;AAAA,IACA,UAAUo3B;AAAA,IACV,cAAcvG;AAAA,IACd,gBAAgBpC;AAAA,IAChB,qBAAqBkI;AAAA,EAAA,CACtB,GAEM;AAAA,MACHl6B,EAAW,SAAS;AAAA,MACpB46B,CAAW;AAAA,MACXvB,CAAO;AAAA,MACPlF,GAAmBC,CAAW,CAAC;AAAA;AAAA;AAAA,QAG7BC,GAAwBD,GAAa8F,CAAY,CAAC;AAAA;AAAA;AAG1D;AAYO,SAASY,GACd98B,GACM;AACN,QAAM,EAAE,6BAAA+8B,MAAgC/8B;AACxC,MAAI,OAAO+8B,KAAgC,YAAY;AACrD,YAAQ,MAAM,iEAAiE;AAC/E;AAAA,EACF;AAEE,EAAAA,EAA4B,CAACx3B,OAAkB;AAAA,IAC7C,OAAO;AAAA,IACP,QAAQ,CAAC6P,GAAMhO,GAAMC,MACnBm1B,GAAqBpnB,GAAMhO,GAAMC,GAAa9B,CAAY;AAAA,IAC5D,SAAS,MAAM;AACb,MAAA6sB,GAA2B7sB,CAAY;AAAA,IACzC;AAAA,EAAA,EACA;AACN;AC1tDO,MAAMy3B,KAAmB,YAE1BC,KAAoB;AAO1B,SAASC,GACPr9B,GACmB;AACnB,QAAMyN,IAA4B,CAAA,GAC5B6vB,IAA2B,CAAA;AAEjC,aAAW9vB,KAAWxN;AAEpB,MADkBwN,EAAQ,iBAAiB,IAAI,iBAAiB,WAC/C,QACfC,EAAI,KAAKD,CAAO,IAEhB8vB,EAAG,KAAK9vB,CAAO;AAInB,SAAO,EAAE,KAAAC,GAAK,IAAA6vB,EAAA;AAChB;AAEA,SAASC,GAAYv9B,GAAoC;AACvD,SAAOA,EAAK,OAAO,CAACilB,GAAKzX,MACnB,OAAOA,EAAQ,WAAY,YAAY,OAAO,SAASA,EAAQ,OAAO,IACjEyX,IAAMzX,EAAQ,UAEhByX,GACN,CAAC;AACN;AAEA,SAASuY,GAAgB/+B,GAAuB;AAC9C,SAAO,GAAGgD,EAAahD,CAAK,CAAC;AAC/B;AAEA,SAASg/B,GAAsBjwB,GAAqC;AAClE,MAAI,OAAOA,EAAQ,gBAAiB,YAAY,CAAC,OAAO,SAASA,EAAQ,YAAY;AACnF,WAAO;AAET,QAAM2P,IAAW3P,EAAQ,iBAAiB;AAK1C,SAAO,GAJQA,EAAQ,aAAa,eAAe,SAAS;AAAA,IAC1D,uBAAuB;AAAA,IACvB,uBAAuB;AAAA,EAAA,CACxB,CACe,GAAG2P,IAAW,IAASA,CAAQ,KAAK,EAAE;AACxD;AAEA,SAASoa,GAAa94B,GAAqC;AACzD,SAAI,OAAOA,KAAU,YAAY,CAAC,OAAO,SAASA,CAAK,KAAKA,KAAS,IAC5D,OAEFA,EAAM,eAAe,SAAS;AAAA,IACnC,uBAAuB;AAAA,IACvB,uBAAuB;AAAA,EAAA,CACxB;AACH;AAEA,SAASi/B,GAAkBj/B,GAAqC;AAC9D,MAAI,CAACA;AACH,WAAO;AAET,QAAMqpB,IAAO,IAAI,KAAKrpB,CAAK;AAC3B,SAAI,OAAO,MAAMqpB,EAAK,QAAA,CAAS,IACtB,OAEFA,EAAK,eAAe,SAAS;AAAA,IAClC,MAAM;AAAA,IACN,OAAO;AAAA,IACP,KAAK;AAAA,IACL,MAAM;AAAA,IACN,QAAQ;AAAA,EAAA,CACT;AACH;AAEA,SAAS6V,GAAenwB,GAAqC;AAC3D,QAAM4Q,IAAkB,CAAA,GAClBrS,IAASyB,EAAQ,gBACjBwZ,IAAY0W,GAAkBlwB,EAAQ,iBAAiB,GACvDowB,IAAYrG,GAAa/pB,EAAQ,OAAO;AAW9C,SATIzB,KACFqS,EAAM,KAAKrS,CAAM,GAEfib,KACF5I,EAAM,KAAK4I,CAAS,GAElB4W,KACFxf,EAAM,KAAK,QAAQwf,CAAS,EAAE,GAE5Bxf,EAAM,WAAW,IACZ5Q,EAAQ,iBAAiB,oBAAoB,MAE/C4Q,EAAM,KAAK,KAAK;AACzB;AAEA,SAASsa,GACPmF,GACAC,GACAC,GACQ;AACR,QAAMC,IACJF,IAAU,IAAIN,GAAgBM,CAAO,IAAI,KACrCG,IAAcF,IAChB,mCAAmC;AAAA,IACjCA;AAAA,EAAA,CACD,qCACD;AAEJ,SAAO;AAAA;AAAA,qCAE4BP,GAAgBK,CAAQ,CAAC;AAAA,0CACpBG,CAAY;AAAA,QAC9CC,CAAW;AAAA;AAAA;AAGnB;AAEA,SAASC,GAAqBC,GAAuB;AACnD,MAAIA,MAAU;AACZ,WAAO;AAET,QAAMC,IAASD,MAAU,IAAI,KAAK;AAClC,SAAO;AAAA;AAAA;AAAA,WAGE;AAAA,IACHA;AAAA,EAAA,CACD,qBAAqBC,CAAM;AAAA;AAAA;AAGlC;AAEA,SAASC,GACPvnB,GACAC,GACuC;AACvC,QAAMC,IAAUF,EAAY,IAAI,CAACtJ,OAAa;AAAA,IAC5C,MAAMgF,GAAqBhF,EAAQ,MAAMA,EAAQ,QAAQ;AAAA,MACvD,gBAAgB;AAAA,MAChB,YAAY;AAAA,IAAA,CACb;AAAA,IACD,SAASA,EAAQ,WAAW;AAAA,IAC5B,gBAAgBA,EAAQ;AAAA,EAAA,EACxB,GAEI0L,IAAWnZ;AAAA,IACfiX;AAAA,IACA;AAAA,MACE,EAAE,KAAK,QAAQ,OAAO,OAAA;AAAA,MACtB,EAAE,KAAK,WAAW,OAAO,oBAAoB,OAAO,QAAA;AAAA,IAAiB;AAAA,IAEvE,CAAC,SAAS;AAAA,EAAA,GAGNC,IAASF,EAAW,IAAI,CAACvJ,OAAa;AAAA,IAC1C,MAAMgF,GAAqBhF,EAAQ,MAAMA,EAAQ,QAAQ;AAAA,MACvD,gBAAgB;AAAA,MAChB,YAAY;AAAA,IAAA,CACb;AAAA,IACD,YAAYiwB,GAAsBjwB,CAAO;AAAA,IACzC,WAAWyE,GAAW0rB,GAAenwB,CAAO,CAAC;AAAA,IAC7C,SAASA,EAAQ,iBAAiB,OAAOA,EAAQ,WAAW;AAAA,IAC5D,gBAAgBA,EAAQ;AAAA,EAAA,EACxB,GAEI2L,IAAUpZ;AAAA,IACdkX;AAAA,IACA;AAAA,MACE,EAAE,KAAK,QAAQ,OAAO,OAAA;AAAA,MACtB,EAAE,KAAK,cAAc,OAAO,cAAA;AAAA,MAC5B,EAAE,KAAK,aAAa,OAAO,gBAAA;AAAA,MAC3B,EAAE,KAAK,WAAW,OAAO,OAAO,OAAO,QAAA;AAAA,IAAiB;AAAA,IAE1D,CAAC,SAAS;AAAA,EAAA;AAGZ,SAAO,EAAE,UAAAiC,GAAU,SAAAC,EAAA;AACrB;AAEA,eAAsBmlB,GACpBC,GACAh3B,GACAC,GACiB;AACjB,QAAMsd,IAAe,MAAMzc,GAAgBd,GAAMC,CAAW;AAC5D,EAAA2H,GAAoB2V,EAAa,QAAQ;AAEzC,QAAM9kB,IAAO+R,GAAA,GACP,EAAE,KAAAtE,GAAK,IAAA6vB,MAAOD,GAAkBr9B,CAAI,GAEpC69B,IAAWN,GAAY9vB,CAAG,GAC1BqwB,IAAUP;AAAA,IACdD,EAAG,OAAO,CAAC9vB,MAAY,CAACA,EAAQ,cAAc;AAAA,EAAA,GAE1CuwB,IAAiBT,EAAG;AAAA,IACxB,CAAC9vB,MAAYA,EAAQ,kBAAkBA,EAAQ,WAAW;AAAA,EAAA,EAC1D,QAEIuO,IAAa2c,GAAgBmF,GAAUC,GAASC,CAAc,GAC9D57B,IAAaH,GAAiBo7B,IAAmBrhB,CAAU,GAE3DyiB,IAAgBN,GAAqBH,CAAc,GACnD,EAAE,UAAA7kB,GAAU,SAAAC,EAAA,IAAYklB,GAAoB5wB,GAAK6vB,CAAE;AAEzD,SAAO;AAAA,MACHn7B,EAAW,SAAS;AAAA,MACpBq8B,CAAa;AAAA;AAAA;AAAA;AAAA,UAITtlB,CAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAMRC,CAAO;AAAA;AAAA,QAGTmkB,EAAG,SACC;AAAA;AAAA;AAAA;AAAA,gBAKA,EACN;AAAA;AAAA;AAGN;AAEO,MAAMmB,KAAwB;AAAA,EACnC,KAAKtB;AAAA,EACL,OAAOC;AAAA,EACP,QAAQkB;AACV,GCjNMhhC,KAAiBohC,IA4CjBC,KAA0B,2BAC1BC,KAAmB,YACnBC,KAA6B,aAE7BC,KAAqC;AAAA,EACzC,EAAE,KAAKF,IAAkB,OAAO,aAAa,QAAQ/Z,GAAA;AAAA,EACrD4Z;AACF,GAEMM,yBAAwB,IAAA,GACxBC,KAA2B,CAAA,GAC3BC,yBAAwB,IAAA;AAE9B,IAAIC,KAAoD,MACpDC,KAAuB,IACvBC,KAAwC,MACxCC,IAAc,GACdC,KAAwC;AAW5C,SAASz7B,GAASpF,GAAkD;AAClE,SAAO,OAAOA,KAAU,YAAYA,MAAU;AAChD;AAEA,SAAS8gC,GAAiB9gC,GAAyC;AACjE,SACE,OAAOA,KAAU,YACjBA,MAAU,QACV,OAAQA,EAAyB,QAAS;AAE9C;AAEA,SAAS+gC,GAAeniC,GAAwB;AAC9C,MAAI,OAAOA,KAAU,UAAU;AAC7B,UAAM4G,IAAU5G,EAAM,KAAA;AACtB,WAAO4G,EAAQ,SAAS,IAAIA,IAAU;AAAA,EACxC;AACA,MAAI5G,aAAiB,OAAO;AAC1B,UAAM4G,IAAU5G,EAAM,QAAQ,KAAA;AAC9B,WAAO4G,EAAQ,SAAS,IAAIA,IAAU5G,EAAM;AAAA,EAC9C;AACA,MAAIA,KAAS;AACX,QAAI;AACF,YAAM6V,IAAa,KAAK,UAAU7V,CAAK;AACvC,UAAI6V,KAAcA,MAAe;AAC/B,eAAOA;AAAA,IAEX,QAAQ;AAAA,IAER;AAEF,SAAO,OAAO7V,CAAK;AACrB;AAEA,SAASoiC,GAAsBhhC,GAA8C;AAC3E,SACEA,MAAU,cACVA,MAAU,sBACVA,MAAU,sBACVA,MAAU;AAEd;AAEA,SAASihC,GACP5qB,GACe;AACf,QAAM6qB,IAAgB7qB,EAAO;AAC7B,MAAI,OAAO6qB,KAAkB,YAAYA;AACvC,WAAOA;AAET,QAAMC,IAAqB9qB,EAAO;AAClC,SAAI,OAAO8qB,KAAuB,YAAYA,IACrCA,IAEF;AACT;AAEA,SAASC,GACP/qB,GACe;AACf,MAAI,CAACA;AACH,WAAO;AAET,MAAI,MAAM,QAAQA,CAAM,GAAG;AACzB,eAAWsF,KAAQtF;AACjB,UAAIjR,GAASuW,CAAI,GAAG;AAClB,cAAMzL,IAAO+wB,GAAqCtlB,CAAI;AACtD,YAAIzL;AACF,iBAAOA;AAAA,MAEX;AAEF,WAAO;AAAA,EACT;AACA,SAAK9K,GAASiR,CAAM,IAGb4qB,GAAqC5qB,CAAM,IAFzC;AAGX;AAEA,SAASgrB,GACPC,GACAC,GACkC;AAClC,UAAQD,GAAA;AAAA,IACN,KAAK;AACH,aAAO;AAAA,QACL,MAAMA;AAAA,QACN,MAAM,MAAM,QAAQC,CAAI,IAAKA,IAAiC;AAAA,MAAA;AAAA,IAElE,KAAK;AACH,aAAI,OAAOA,KAAS,WACX,EAAE,MAAMD,GAAU,MAAAC,EAAA,IAEvBn8B,GAASm8B,CAAI,IACR,EAAE,MAAMD,GAAU,MAAAC,EAAA,IAEpB,EAAE,MAAMD,GAAU,MAAM,KAAA;AAAA,IACjC,KAAK;AACH,aAAI,MAAM,QAAQC,CAAI,IACb,EAAE,MAAMD,GAAU,MAAAC,EAAA,IAEpB,EAAE,MAAMD,GAAU,MAAM,KAAA;AAAA,IACjC,KAAK;AACH,aAAI,MAAM,QAAQC,CAAI,IACb,EAAE,MAAMD,GAAU,MAAAC,EAAA,IAEvBn8B,GAASm8B,CAAI,IACR,EAAE,MAAMD,GAAU,MAAAC,EAAA,IAEpB,EAAE,MAAMD,GAAU,MAAM,KAAA;AAAA,IACjC;AACE,aAAO;AAAA,EAAA;AAEb;AAEA,SAASE,GAA2BzhC,GAA+C;AACjF,SAAI,OAAOA,KAAQ,YAAY,CAACA,EAAI,WAAWqgC,EAA0B,IAChE,OAGIrgC,EAAI,MAAMqgC,GAA2B,MAAM,KACzC;AACjB;AAEA,SAASqB,KAA+B;AACtC,MAAI,CAACd;AACH,WAAO;AAGT,QAAMe,IAAWjhB,GAAmBkgB,EAAsB;AAC1D,SAAKe,MACHf,KAAyB,OAEpBe;AACT;AAEA,SAASC,IAA2C;AAClD,QAAMC,IAAarB,GAChB,IAAI,CAACxgC,MAAQugC,GAAkB,IAAIvgC,CAAG,CAAC,EACvC,OAAO,CAAC8hC,MAAqD,EAAQA,CAAW;AAEnF,SAAO,CAAC,GAAGxB,IAAU,GAAGuB,CAAU;AACpC;AAEA,SAASE,GAAc1X,GAA8C;AACnE,QAAM2X,IAAOJ,EAAA;AACb,SAAIvX,IAAQ,KAAKA,KAAS2X,EAAK,SACtB,OAEFA,EAAK3X,CAAK;AACnB;AAEA,SAAS4X,GAAsBv4B,GAAkD;AAC/E,MAAI,CAACA;AACH,WAAO;AAET,QAAMw4B,IAAmBx4B,GACnBy4B,IAAYD,EAAiB,YAAYA,EAAiB;AAChE,SAAIC,MAGa,OAAO,OAAOD,CAAgB,EAAE,KAAK,CAACl5B,MACjD,CAACA,KAAe,OAAOA,KAAgB,WAClC,KAEKA,EAAgD,sBAC9C,iBACjB,KACkB;AACrB;AACA,SAASo5B,KAAkC;AACzC,MAAI;AACF,UAAMC,IAAmBC,GAAA;AACzB,IAAID,KAAoB,OAAOA,EAAiB,0BAA2B,cACzEA,EAAiB,uBAAA;AAAA,EAErB,SAASxjC,GAAO;AACd,YAAQ,KAAK,mEAAmEA,CAAK;AAAA,EACvF;AACF;AAEA,SAAS0jC,GAAelY,GAAuB;AAC7C,QAAM2X,IAAOJ,EAAA;AAIb,SAHI,CAACI,EAAK,UAGN3X,IAAQ,IACH,IAELA,KAAS2X,EAAK,SACTA,EAAK,SAAS,IAEhB3X;AACT;AAEA,eAAemY,GACbC,GACA1rB,GACAhO,GACAY,GACe;AACf,QAAMq4B,IAAOJ,EAAA,GACPc,IAAeH,GAAeE,CAAW;AAC/C,MAAIC,MAAiB7B,GAAa;AAChC,IAAI4B,IAAc5B,KAChBa,GAAA;AAEF;AAAA,EACF;AAEA,EAAAU,GAAA;AAEA,QAAMO,IAAa9B,KAAe,KAAKA,IAAcmB,EAAK,SAASA,EAAKnB,CAAW,IAAI,MACjF+B,IAAsBD,IACxBlB,GAA2BkB,EAAW,GAAG,IACzC;AACJ,MAAIE,IAAYH;AAEhB,MAAIE,GAAqB;AACvB,UAAME,IAAiBJ,KAAgB,KAAKA,IAAeV,EAAK,SAASA,EAAKU,CAAY,IAAI;AAC9F,QAAII,KAAkBA,EAAe,QAAQ1C,MAC5B2C,GAAoBH,GAAqB,EAAE,gBAAgB,IAAM,GACpE;AAEV,YAAMI,IADcpB,EAAA,EACc,UAAU,CAACqB,MAAQA,EAAI,QAAQ7C,EAAgB;AACjF,MAAAyC,IAAYG,KAAiB,IAAIA,IAAgB;AAAA,IACnD;AAAA,EAEJ;AAEA,MAAI,CAAArC,IAIJ;AAAA,IAAAA,KAAuB;AACvB,QAAI;AACF,MAAAE,IAAc0B,GAAeM,CAAS;AACtC,YAAMK,IAAerC;AACrB,YAAMsC,GAAUpsB,GAAMhO,GAAMY,CAAK,GACjCy5B,GAAqBF,CAAY;AAAA,IACnC,SAASrkC,GAAO;AACd,cAAQ,MAAM,gDAAgDA,CAAK;AAAA,IACrE,UAAA;AACE,MAAA8hC,KAAuB;AAAA,IACzB;AAAA;AACF;AAEA,SAAS0C,GACPC,GACAvsB,GACAhO,GACAY,GACM;AACN,EAAK64B,GAAe3B,IAAcyC,GAAOvsB,GAAMhO,GAAMY,CAAK;AAC5D;AAEO,SAAS45B,GACdvjC,GACA8hC,GACM;AACN,MAAI,CAAC9hC,KAAO,CAAC8hC,KAAc,OAAOA,EAAW,UAAW,YAAY;AAClE,YAAQ,MAAM,gDAAgD9hC,GAAK8hC,CAAU;AAC7E;AAAA,EACF;AAEA,QAAM56B,IAAeu6B,GAA2BzhC,CAAG;AACnD,MAAIkH,GAAc;AAChB,UAAMs8B,IAAc/C,GAAkB,IAAIv5B,CAAY;AACtD,IAAIs8B,KAAeA,MAAgBxjC,KACjCyjC,GAAoBD,CAAW;AAAA,EAEnC;AAEA,QAAME,IAA+C;AAAA,IACnD,GAAG5B;AAAA,IACH,KAAA9hC;AAAA,EAAA;AAGF,EAAAugC,GAAkB,IAAIvgC,GAAK0jC,CAAoB,GAE3Cx8B,KACFu5B,GAAkB,IAAIv5B,GAAclH,CAAG,GAGpCwgC,GAAe,SAASxgC,CAAG,KAC9BwgC,GAAe,KAAKxgC,CAAG;AAE3B;AAEO,SAASyjC,GAAoBzjC,GAAsC;AACxE,MAAI,CAACA;AACH;AAGF,QAAM8hC,IAAavB,GAAkB,IAAIvgC,CAAG;AAC5C,MAAI8hC,KAAc,OAAOA,EAAW,WAAY;AAC9C,QAAI;AACF,YAAM6B,IAAgB7B,EAAW,QAAQ,EAAE,KAAA9hC,GAAK;AAChD,MAAI+gC,GAAuB4C,CAAa,KACtCA,EAAc,MAAM,CAACC,MAA0B;AAC7C,gBAAQ;AAAA,UACN;AAAA,UACAA;AAAA,QAAA;AAAA,MAEJ,CAAC;AAAA,IAEL,SAAS/kC,GAAgB;AACvB,cAAQ,MAAM,0DAA0DA,CAAK;AAAA,IAC/E;AAGF,EAAA0hC,GAAkB,OAAOvgC,CAAG;AAE5B,QAAMqqB,IAAQmW,GAAe,QAAQxgC,CAAG;AACxC,EAAIqqB,KAAS,KACXmW,GAAe,OAAOnW,GAAO,CAAC;AAGhC,QAAMnjB,IAAeu6B,GAA2BzhC,CAAG;AACnD,EAAIkH,KAAgBu5B,GAAkB,IAAIv5B,CAAY,MAAMlH,KAC1DygC,GAAkB,OAAOv5B,CAAY;AAEzC;AAEO,SAAS28B,GAAa7jC,GAAsB;AACjD,SAAOugC,GAAkB,IAAIvgC,CAAG;AAClC;AAEO,SAAS8jC,GAAuB9jC,GAA4C;AACjF,SAAOugC,GAAkB,IAAIvgC,CAAG,KAAK;AACvC;AAEO,SAAS0+B,GACdqF,GACM;AACN,MAAIA,KAAW,QAAQ,OAAOA,KAAY,YAAY;AACpD,YAAQ,MAAM,4DAA4DA,CAAO;AACjF;AAAA,EACF;AAEA,EAAArD,KAA2BqD,KAAW;AACxC;AAEA,SAASC,GAAwB98B,GAA8B;AAC7D,SAAO,GAAGm5B,EAA0B,GAAGn5B,CAAY;AACrD;AAEA,SAASo7B,KAAgD;AjBndzD,MAAAr5B;AiBodE,aAAWlK,KAAWuM;AACpB,QAAIvM,EAAQ;AACV,aAAOA;AAIX,QAAMklC,wBAAqB,IAAA;AAC3B,aAAW5H,KAAQ9wB;AACjB,IAAA04B,EAAe,IAAI5H,CAAI;AAGzB,aAAWA,KAAQ4H,GAAgB;AACjC,UAAM3gB,KAASra,IAAAozB,EAAK,eAAL,gBAAApzB,EAAiB,cAAgC;AAChE,QAAIqa;AACF,aAAOA;AAAA,EAEX;AAEA,MAAI,OAAO,WAAa,KAAa;AACnC,UAAM4gB,IAAa,SAAS,cAAgC,qBAAqB;AACjF,QAAIA;AACF,aAAOA;AAAA,EAEX;AAEA,SAAO;AACT;AAEA,SAASC,KAA+B;AACtC,QAAM9B,IAAmBC,GAAA;AACzB,MAAI,CAACD,GAAkB;AACrB,YAAQ,KAAK,mEAAmE;AAChF;AAAA,EACF;AAEA,MAAI,OAAOA,EAAiB,wBAAyB,YAAY;AAC/D,IAAAA,EAAiB,qBAAA;AACjB;AAAA,EACF;AAEA,EAAI,OAAOA,EAAiB,WAAY,cACtCA,EAAiB,QAAA;AAErB;AAEA,SAASe,GAAqBgB,GAAoB;AAChD,QAAM/B,IAAmBC,GAAA;AACzB,MAAKD,KAID,OAAOA,EAAiB,wBAAyB;AACnD,QAAI;AACF,MAAAA,EAAiB,qBAAqB+B,CAAI;AAAA,IAC5C,SAASvlC,GAAO;AACd,cAAQ,KAAK,oEAAoEA,CAAK;AAAA,IACxF;AAEJ;AAEO,SAAS6hB,GAAmBxZ,GAAkD;AACnF,MAAI,CAACA;AACH,mBAAQ,MAAM,8CAA8CA,CAAY,GACjE;AAGT,QAAMm9B,IAASL,GAAwB98B,CAAY;AACnD,MAAI46B,IAAagC,GAAuBO,CAAM;AAE9C,MAAI,CAACvC,KAAc,OAAOpB,MAA6B;AACrD,QAAI;AACF,YAAM4D,IAAkB5D,GAAyBx5B,CAAY;AAC7D,MAAIo9B,KAAmB,OAAOA,EAAgB,UAAW,cACvDf,GAAkBc,GAAQC,CAAe,GACzCxC,IAAagC,GAAuBO,CAAM,KAE1C,QAAQ,MAAM,8DAA8DC,CAAe;AAAA,IAE/F,SAASzlC,GAAO;AACd,cAAQ,MAAM,gEAAgEA,CAAK;AAAA,IACrF;AAGF,MAAI,CAACijC;AACH,mBAAQ,KAAK,2CAA2C56B,CAAY,YAAY,GACzE;AAGT,EAAAk7B,GAAA;AAGA,MAAIK,IADSb,EAAA,EACU,UAAU,CAACqB,MAAQA,EAAI,QAAQoB,CAAM;AAE5D,SAAI5B,MAAgB,OAElBA,IADoBb,EAAA,EACM,UAAU,CAACqB,MAAQA,EAAI,QAAQoB,CAAM,GAC3D5B,MAAgB,OAClB,QAAQ,MAAM,6DAA6D,GACpE,OAIX5B,IAAc4B,GACd7B,KAAyB,MACzBuD,GAAA,GACO;AACT;AAMO,SAASpB,GACd77B,GACAvF,IAAsC,IAC7B;AACT,MAAI,CAACuF;AACH,mBAAQ,MAAM,+CAA+CA,CAAY,GAClE;AAGT,QAAM,EAAE,gBAAAq9B,IAAiB,GAAA,IAAU5iC,GAE7B0iC,IAASL,GAAwB98B,CAAY;AACnD,MAAI,CAAC28B,GAAaQ,CAAM;AACtB,WAAO;AAIT,QAAMG,IADa5C,EAAA,EACe,UAAU,CAACqB,MAAQA,EAAI,QAAQoB,CAAM,GACjEI,IAAYD,MAAmB3D;AAErC,EAAA4C,GAAoBY,CAAM;AAE1B,QAAMK,IAAY9C,EAAA;AAClB,MAAI,CAAC8C,EAAU;AACb,WAAA7D,IAAc,GACT0D,KACHJ,GAAA,GAEK;AAKT,MAFAvD,KAAyB15B,GAErBu9B,GAAW;AACb,UAAMzB,IAAgB0B,EAAU,UAAU,CAACzB,MAAQA,EAAI,QAAQ7C,EAAgB;AAC/E,IAAI4C,KAAiB,IACnBnC,IAAcmC,IAEdnC,IAAc,KAAK,IAAI,KAAK,IAAI2D,IAAiB,GAAG,CAAC,GAAGE,EAAU,SAAS,CAAC;AAAA,EAEhF,MAAA,CAAW7D,KAAe6D,EAAU,WAClC7D,IAAc,KAAK,IAAI,GAAG6D,EAAU,SAAS,CAAC;AAGhD,SAAKH,KACHJ,GAAA,GAEK;AACT;AACA,eAAehB,GACbpsB,GACAhO,GACAY,GACe;AACf,MAAIg7B,IAAiBh7B;AACrB,EAAKg7B,MACHA,IAAiB1C,GAAsBl5B,IAAOA,EAAK,SAAS,IAAI;AAGlE,QAAMi5B,IAAOJ,EAAA;AACb,EAAIf,KAAemB,EAAK,WACtBnB,IAAc,KAAK,IAAI,GAAGmB,EAAK,SAAS,CAAC;AAG3C,QAAMiB,IAAMlB,GAAclB,CAAW;AACrC,MAAI,CAACoC,GAAK;AACR,YAAQ,MAAM,kEAAkE;AAChF;AAAA,EACF;AAEA,MAAI9H;AACJ,MAAI;AACF,IAAAA,IAAU,MAAM8H,EAAI,OAAOlsB,GAAMhO,GAAM47B,CAAc;AAAA,EACvD,SAAS9lC,GAAgB;AACvB,YAAQ,MAAM,4CAA4CA,CAAK,GAC/DkY,EAAK,YAAY,yCAAyCiqB,GAAeniC,CAAK,CAAC;AAC/E;AAAA,EACF;AAEA,EAAAkY,EAAK,YAAYokB,KAAW,IAExB8H,EAAI,WAAW5c,MACjBP,GAA6B/O,CAAI;AAcnC,QAAMpT,IAAa,MAVjB,IAAI,QAAQ,CAACiiB,MAAY;AACvB,UAAMgf,IAAW,OAAO,YAAY,MAAM;AACxC,YAAMjhC,IAAaoT,EAAK,cAA2B,cAAc;AACjE,MAAIpT,MACF,cAAcihC,CAAQ,GACtBhf,EAAQjiB,CAAU;AAAA,IAEtB,GAAG,EAAE;AAAA,EACP,CAAC;AAIH,MAAIkhC,IAAS9tB,EAAK,cAA2B,IAAIopB,EAAuB,EAAE;AAC1E,MAAI,CAAC0E,GAAQ;AACX,IAAAA,IAAS,SAAS,cAAc,KAAK,GACrCA,EAAO,KAAK1E;AACZ,UAAM2E,IAASnhC,EAAW;AAC1B,IAAImhC,KAAU,kBAAkBA,KAC9BA,EAAO,aAAaD,GAAQlhC,CAAU;AAAA,EAE1C;AAEA,EAAAohC,GAAgBhuB,GAAMhO,GAAMY,CAAK,GACjCq7B,GAAuBjuB,GAAMhO,GAAMY,CAAK,GACxCs7B,GAA0BluB,CAAI;AAChC;AAEA,SAASkuB,GAA0BluB,GAAyB;AAC1D,QAAMpT,IAAaoT,EAAK,cAA2B,cAAc,GAC3D8tB,IAAS9tB,EAAK,cAA2B,IAAIopB,EAAuB,EAAE;AAE5E,MAAI,CAACx8B,KAAc,CAACkhC,GAAQ;AAC1B,YAAQ,MAAM,oEAAoE;AAClF;AAAA,EACF;AAEA,EAAA/D,MAAA,QAAAA,GAAU,cAEVA,KAAW,IAAI;AAAA,IACb,CAAC,CAAC/5B,CAAK,MAAM;AACX,MAAKA,EAAM,iBAGTpD,EAAW,UAAU,OAAO,QAAQ,IAFpCA,EAAW,UAAU,IAAI,QAAQ;AAAA,IAIrC;AAAA,IACA;AAAA,MACE,MAAM;AAAA,MACN,YAAY;AAAA,MACZ,WAAW;AAAA,IAAA;AAAA,EACb,GAGFm9B,GAAS,QAAQ+D,CAAM;AACzB;AAEA,SAASG,GACPjuB,GACAhO,GACAY,GACM;AACN,QAAMhG,IAAaoT,EAAK,cAA2B,cAAc;AACjE,MAAI,CAACpT,GAAY;AACf,YAAQ,MAAM,6BAA6B;AAC3C;AAAA,EACF;AAEA,EAAA7E;AAAA,IACE6E;AAAA,IACA,MAAM;AACJ,MAAA0/B,GAAgB,GAAGtsB,GAAMhO,GAAMY,CAAK;AAAA,IACtC;AAAA,IACA,MAAM;AACJ,MAAA05B,GAAgB,IAAItsB,GAAMhO,GAAMY,CAAK;AAAA,IACvC;AAAA,EAAA;AAEJ;AAEA,SAASo7B,GACPhuB,GACAhO,GACAY,GACM;AACN,QAAMhG,IAAaoT,EAAK,cAA2B,cAAc;AACjE,MAAI,CAACpT,GAAY;AACf,YAAQ,MAAM,6BAA6B;AAC3C;AAAA,EACF;AAEA,QAAMuhC,IAAUvhC,EAAW,cAAiC,WAAW,GACjEwhC,IAAWxhC,EAAW,cAAiC,YAAY;AAEzE,MAAI,CAACuhC,KAAW,CAACC,GAAU;AACzB,YAAQ,MAAM,mCAAmC;AACjD;AAAA,EACF;AAEA,EAAAD,EAAQ,iBAAiB,SAAS,MAAM;AACtC,IAAA7B,GAAgB,IAAItsB,GAAMhO,GAAMY,CAAK;AAAA,EACvC,CAAC,GAEDw7B,EAAS,iBAAiB,SAAS,MAAM;AACvC,IAAA9B,GAAgB,GAAGtsB,GAAMhO,GAAMY,CAAK;AAAA,EACtC,CAAC,GAEDy7B,GAAsBzhC,CAAU;AAClC;AAEA,SAASyhC,GAAsBzhC,GAA+B;AAC5D,QAAMuhC,IAAUvhC,EAAW,cAAiC,WAAW,GACjEwhC,IAAWxhC,EAAW,cAAiC,YAAY;AAYzE,MAVIuhC,MACErE,MAAgB,KAClBqE,EAAQ,WAAW,IACnBA,EAAQ,UAAU,IAAI,UAAU,MAEhCA,EAAQ,WAAW,IACnBA,EAAQ,UAAU,OAAO,UAAU,KAInCC,GAAU;AACZ,UAAMnD,IAAOJ,EAAA,GAEPyD,IAAe,EADPxE,MAAgBmB,EAAK,SAAS,MACb,CAAC,CAACpB;AACjC,IAAAuE,EAAS,WAAW,CAACE,GACrBF,EAAS,UAAU,OAAO,YAAY,CAACE,CAAY;AAAA,EACrD;AACF;AAEA,MAAMC,WAA0B,YAAY;AAAA,EA+B1C,cAAc;AACZ,UAAA;AA/BM,IAAAC,EAAA;AAEA,IAAAA,EAAA,eAA8B;AAE9B,IAAAA,EAAA,gBAAoB;AAEpB,IAAAA,EAAA,iBAA0B;AAE1B,IAAAA,EAAA,gBAA2B;AAE3B,IAAAA,EAAA,oBAAwB;AAExB,IAAAA,EAAA,qBAA8B;AAE9B,IAAAA,EAAA,oBAA+B;AAE/B,IAAAA,EAAA,mBAA2B;AAE3B,IAAAA,EAAA,0BAA2C,CAAA;AAE3C,IAAAA,EAAA,4BAA6C;AAE7C,IAAAA,EAAA,sBAAe;AAEf,IAAAA,EAAA,qBAAc;AAEd,IAAAA,EAAA,yBAA+C,CAAA;AAE/C,IAAAA,EAAA,4BAAqB;AAI3B,SAAK,QAAQ,SAAS,cAAc,KAAK,GACzC,KAAK,MAAM,YAAY,uBACvB,KAAK,YAAY,KAAK,KAAK;AAAA,EAC7B;AAAA,EAEA,IAAI,KAAKx8B,GAAwC;AAC/C,SAAK,QAAQA,KAAQ,MACrB,KAAK,qBAAA;AAAA,EACP;AAAA,EAEA,IAAI,MAAMY,GAAkB;AAC1B,IAAI,KAAK,WAAWA,MAGpB,KAAK,SAASA,KAAS,MACvB,KAAK,qBAAA;AAAA,EACP;AAAA,EAEA,IAAI,OAAO67B,GAAoC;AAC7C,IAAI,KAAK,aAAaA,KAAU,UAGhC,KAAK,UAAUA,KAAU,MACzB,KAAK,qBAAA;AAAA,EACP;AAAA,EAEA,IAAI,MAAMC,GAAqC;AAC7C,IAAI,KAAK,YAAYA,KAAS,UAG9B,KAAK,SAASA,KAAS,MACvB,KAAK,qBAAA;AAAA,EACP;AAAA,EAEA,oBAA0B;AACxB,SAAK,qBAAA;AAAA,EACP;AAAA,EAEA,uBAA6B;AAC3B,SAAK,sBAAA;AAAA,EACP;AAAA,EAEO,uBAA6B;AAClC,QAAI,CAAC,KAAK,SAAS,KAAK;AACtB;AAGF,IAAK,KAAK,WACR,KAAK,SAASxD,GAAsB,KAAK,MAAM,UAAU,IAAI;AAG/D,UAAMx4B,IAAUG,GAAW,KAAK,OAAO,KAAK,MAAM;AAClD,QAAI,CAACH,GAAS;AACZ,MAAK,KAAK,uBACR,QAAQ,KAAK,+EAA+E,GAC5F,KAAK,qBAAqB;AAE5B;AAAA,IACF;AAEA,SAAK,qBAAqB,IAC1B,QAAQ,MAAM,4CAA4CA,CAAO,GACjE,KAAK,eAAe,IACpB,KAAK,0BAAA,GACL,KAAK,QAAA;AAAA,EACP;AAAA,EAEQ,4BAAkC;AjBj4B5C,QAAAR;AiBk4BI,SAAK,sBAAA;AAEL,UAAMy8B,KAAOz8B,IAAA,KAAK,UAAL,gBAAAA,EAAY;AACzB,QAAI,CAACy8B,KAAQ,OAAOA,EAAK,mBAAoB,YAAY;AACvD,cAAQ,MAAM,iFAAiF;AAC/F;AAAA,IACF;AAEA,UAAMC,IAAgC,CAAC,gBAAgB,GAEjDC,IAA0B,CAAA;AAuBhC,IAtB4B,QAAQ;AAAA,MAClCD,EAAW,IAAI,OAAOE,MAAc;AAClC,YAAI;AACF,gBAAMC,IAAc,MAAMJ,EAAK;AAAA,YAC7B,KAAK,gBAAgB,KAAK,IAAI;AAAA,YAC9BG;AAAA,UAAA;AAEF,UAAI,OAAOC,KAAgB,cACzBF,EAAK,KAAKE,CAAW,GACrB,QAAQ,MAAM,oCAAoCD,CAAS,KAE3D,QAAQ;AAAA,YACN;AAAA,YACAA;AAAA,YACAC;AAAA,UAAA;AAAA,QAGN,SAASC,GAAyB;AAChC,kBAAQ,MAAM,qDAAqDF,GAAWE,CAAc;AAAA,QAC9F;AAAA,MACF,CAAC;AAAA,IAAA,EAGA,KAAK,MAAM;AACV,WAAK,qBAAqB,MAAM;AAC9B,QAAAH,EAAK,QAAQ,CAACE,MAAgB;AAC5B,cAAI;AACF,YAAAA,EAAA;AAAA,UACF,QAAyB;AAAA,UAEzB;AAAA,QACF,CAAC,GACD,QAAQ,MAAM,sDAAsD;AAAA,MACtE;AAAA,IACF,CAAC,EACA,MAAM,CAACjnC,MAAmB;AACzB,cAAQ,MAAM,0DAA0DA,CAAK;AAAA,IAC/E,CAAC;AAAA,EACL;AAAA,EACQ,wBAA8B;AACpC,QAAI,OAAO,KAAK,sBAAuB;AACrC,UAAI;AACF,aAAK,mBAAA;AAAA,MACP,SAASA,GAAgB;AACvB,gBAAQ,MAAM,gEAAgEA,CAAK;AAAA,MACrF;AAEF,SAAK,qBAAqB;AAAA,EAC5B;AAAA,EAEQ,gBAAgBS,GAAiC;AACvD,UAAM0mC,IAAiBp8B,GAAW,KAAK,OAAO,KAAK,MAAM;AACzD,QAAI,CAACo8B;AACH;AAGF,UAAMC,IAAY3mC,EAAM;AAKxB,QAJI,CAAC2hC,GAAsBgF,EAAU,SAAS,KAI1CA,EAAU,YAAYA,EAAU,aAAaD;AAC/C;AAGF,UAAMtgC,IAAa47B,GAAyB2E,EAAU,WAAWA,EAAU,IAAI;AAC/E,IAAKvgC,MAIL,KAAK,aAAaA,EAAW,MAAMA,EAAW,IAAI,GAClD,KAAK,UAAUA,EAAW,MAAMA,EAAW,IAAI;AAAA,EACjD;AAAA,EAEQ,UACN67B,GACA2E,GACM;AACN,YAAQ3E,GAAA;AAAA,MACN,KAAK;AACH,QAAA3pB;AAAA,UACEsuB;AAAA,UACA,KAAK;AAAA,QAAA;AAEP;AAAA,MACF,KAAK;AACH,QAAAzoB;AAAA,UACEyoB;AAAA,UACA,KAAK;AAAA,QAAA;AAEP;AAAA,MACF,KAAK;AACH,QAAAptB;AAAA,UACEotB;AAAA,UACA,KAAK;AAAA,QAAA;AAEP;AAAA,MACF,KAAK;AACH,QAAAxqB;AAAA,UACEwqB;AAAA,UACA,KAAK;AAAA,QAAA;AAEP;AAAA,MACF;AACE,gBAAQ,KAAK,4CAA4C3E,CAAQ;AACjE;AAAA,IAAA;AAAA,EAEN;AAAA,EAEQ,aACNA,GACA2E,GACM;AACN,UAAMC,IAAa,KAAK,WAAWD,CAAU,GACvCn/B,IAAsC;AAAA,MAC1C,MAAMw6B;AAAA,MACN,MAAM4E;AAAA,IAAA;AAGR,IAAI5E,MAAa,0BACfx6B,EAAM,gBAAgBs6B;AAAA,MACpB8E;AAAA,IAAA;AAIJ,QAAI9b,IAAQ;AACZ,IAAIkX,MAAa,yBAAyBx6B,EAAM,gBAC9CsjB,IAAQ,KAAK,gBAAgB;AAAA,MAC3B,CAACzO,MAASA,EAAK,SAAS2lB,KAAY3lB,EAAK,kBAAkB7U,EAAM;AAAA,IAAA,IAGnEsjB,IAAQ,KAAK,gBAAgB,UAAU,CAACzO,MAASA,EAAK,SAAS2lB,CAAQ,GAGrElX,KAAS,IACX,KAAK,gBAAgBA,CAAK,IAAItjB,IAE9B,KAAK,gBAAgB,KAAKA,CAAK,GAGjC,KAAK,cAAc;AAAA,EACrB;AAAA,EAEQ,WAAcy6B,GAAY;AAChC,QAAIA,KAAQ;AACV,aAAOA;AAGT,QAAI;AACF,UAAI,OAAO,mBAAoB;AAC7B,eAAO,gBAAgBA,CAAI;AAAA,IAE/B,SAAS3iC,GAAgB;AACvB,cAAQ,KAAK,4EAA4EA,CAAK;AAAA,IAChG;AAEA,QAAI;AACF,aAAO,KAAK,MAAM,KAAK,UAAU2iC,CAAI,CAAC;AAAA,IACxC,SAAS3iC,GAAgB;AACvB,qBAAQ,KAAK,4EAA4EA,CAAK,GACvF2iC;AAAA,IACT;AAAA,EACF;AAAA,EAEQ,yBAA+B;AACrC,QAAI,GAAC,MAAM,QAAQ,KAAK,eAAe,KAAK,KAAK,gBAAgB,WAAW;AAI5E,iBAAW5lB,KAAQ,KAAK;AACtB,YAAI;AACF,eAAK,UAAUA,EAAK,MAAM,KAAK,WAAWA,EAAK,IAAI,CAAC;AAAA,QACtD,SAAS/c,GAAgB;AACvB,kBAAQ,MAAM,kEAAkE+c,GAAM/c,CAAK;AAAA,QAC7F;AAAA,EAEJ;AAAA,EAEO,uBAA6B;AAClC,IAAI,KAAK,gBACP,KAAK,QAAA;AAAA,EAET;AAAA,EAEO,qBAAqBulC,GAAoB;AAC9C,SAAK,aAAaA,CAAI;AAAA,EACxB;AAAA,EAEO,uBAAuBA,IAAevD,GAAmB;AAC9D,UAAMuF,IAAa,OAAO,UAAUhC,CAAI,IAAIA,IAAOvD;AACnD,SAAK,iBAAiBuF,CAAU,IAAI,KAAK,MAAM,aAAa;AAAA,EAC9D;AAAA,EAEQ,UAAgB;AACtB,QAAI,CAAC,KAAK,OAAO;AACf,cAAQ,KAAK,4DAA4D;AACzE;AAAA,IACF;AACA,QAAI,CAAC,KAAK,cAAc;AACtB,cAAQ,MAAM,6DAA6D;AAC3E;AAAA,IACF;AAEA,UAAMhC,IAAOvD;AACb,QACE,CAAC,KAAK,eACN,KAAK,WAAW,KAAK,cACrB,KAAK,YAAY,KAAK,eACtB,KAAK,WAAW,KAAK,cACrB,KAAK,cAAcuD;AAEnB;AAGF,IAAI,KAAK,aAAa,SACpB,KAAK,iBAAiB,KAAK,SAAS,IAAI,KAAK,MAAM;AAGrD,UAAMiC,IAAelD,GAAU,KAAK,OAAO,KAAK,OAAO,KAAK,MAAM;AAClE,QAAIpC,GAAuBsF,CAAY,GAAG;AACxC,MAAAA,EACG,KAAK,MAAM;AACV,aAAK,aAAajC,CAAI;AAAA,MACxB,CAAC,EACA,MAAM,CAACvlC,MAAmB;AACzB,gBAAQ,MAAM,mDAAmDA,CAAK,GACtE,KAAK,aAAaulC,CAAI;AAAA,MACxB,CAAC;AACH;AAAA,IACF;AAEA,SAAK,aAAaA,CAAI;AAAA,EACxB;AAAA,EAEQ,aAAaA,GAAoB;AACvC,UAAMkC,IAAU,KAAK,iBAAiBlC,CAAI,KAAK;AAC/C,SAAK,MAAM,YAAYkC,GAEvB,KAAK,aAAa,KAAK,QACvB,KAAK,cAAc,KAAK,SACxB,KAAK,aAAa,KAAK,QACvB,KAAK,YAAYlC;AAEjB,QAAI;AACF,WAAK,uBAAA;AAAA,IACP,SAASvlC,GAAO;AACd,cAAQ,MAAM,4DAA4DA,CAAK;AAAA,IACjF;AAEA,SAAK,cAAc;AAAA,EACrB;AACF;AAEK,eAAe,IAAI,qBAAqB,KAC3C,eAAe,OAAO,uBAAuBymC,EAAiB;AAGhE,QAAQ,IAAI,8CAA8C;AAE1D7G,GAA0B;AAAA,EACxB,6BAAAC;AACF,CAAC;"}