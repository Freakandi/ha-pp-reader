{"version":3,"file":"dashboard.CExe4k42.js","sources":["../../../../../src/interaction/tab_control.ts","../../../../../src/content/elements.ts","../../../../../src/data/api.ts","../../../../../src/data/updateConfigsWS.ts","../../../../../src/tabs/overview.ts","../../../../../src/content/charting.ts","../../../../../src/tabs/security_detail.ts","../../../../../src/dashboard.ts"],"sourcesContent":["// @ts-nocheck\n\n/**\n * Swipe and tab interaction helpers mirrored from the legacy UI.\n */\n\n/**\n * Fügt einem Element Swipe- und Maus-Events hinzu, um zwischen Tabs zu navigieren.\n * @param {HTMLElement} element - Das Element, das die Events erhalten soll.\n * @param {Function} onSwipeLeft - Callback für Swipe/Klick nach links (nächster Tab).\n * @param {Function} onSwipeRight - Callback für Swipe/Klick nach rechts (vorheriger Tab).\n */\nexport function addSwipeEvents(element, onSwipeLeft, onSwipeRight) {\n  let startX = null;\n\n  // Touch-Events für Mobilgeräte\n  element.addEventListener(\n    'touchstart',\n    e => {\n      if (e.touches.length === 1) {\n        startX = e.touches[0].clientX;\n      }\n    },\n    { passive: true } // Passive Listener für bessere Performance\n  );\n\n  element.addEventListener(\n    'touchend',\n    e => {\n      if (startX === null) return;\n      const deltaX = e.changedTouches[0].clientX - startX;\n      if (deltaX < -50) {\n        onSwipeLeft();\n      } else if (deltaX > 50) {\n        onSwipeRight();\n      }\n      startX = null;\n    },\n    { passive: true } // Passive Listener für bessere Performance\n  );\n\n  // Maus-Events für Desktop\n  element.addEventListener(\n    'mousedown',\n    e => {\n      startX = e.clientX;\n    },\n    { passive: true } // Passive Listener für bessere Performance\n  );\n\n  element.addEventListener(\n    'mouseup',\n    e => {\n      if (startX === null) return;\n      const deltaX = e.clientX - startX;\n      if (deltaX < -50) {\n        onSwipeLeft();\n      } else if (deltaX > 50) {\n        onSwipeRight();\n      }\n      startX = null;\n    },\n    { passive: true } // Passive Listener für bessere Performance\n  );\n}\n\n/**\n * Optional: Funktion zum direkten Wechseln zu einem Tab per Index.\n * @param {number} targetIndex - Der Index des gewünschten Tabs.\n * @param {Function} onTabChange - Callback, der beim Wechsel aufgerufen wird.\n */\nexport function goToTab(targetIndex, onTabChange) {\n  if (typeof onTabChange === 'function') {\n    onTabChange(targetIndex);\n  }\n}","/**\n * HTML rendering helpers mirrored from the legacy dashboard implementation.\n */\n\nexport type SortDirection = 'asc' | 'desc';\n\nexport type TableAlignment = 'left' | 'right' | 'center';\n\nexport interface TableColumn {\n  key: string;\n  label: string;\n  align?: TableAlignment;\n}\n\nexport interface TableFooterContext {\n  hasValue?: boolean;\n}\n\nexport interface TableOptions {\n  sortable?: boolean;\n  defaultSort?: {\n    key: string;\n    dir?: SortDirection;\n  };\n}\n\nexport type TableRow = Record<string, unknown>;\n\nexport function formatValue(\n  key: string,\n  value: unknown,\n  row: TableRow | undefined = undefined,\n  context: TableFooterContext | undefined = undefined,\n): string {\n  let formatted: string | null = null;\n\n  const toNumber = (v: unknown): number => {\n    if (typeof v === 'number') {\n      return v;\n    }\n    if (typeof v === 'string' && v.trim() !== '') {\n      const cleaned = v\n        .replace(/\\s+/g, '')\n        .replace(/[^0-9,.-]/g, '')\n        .replace(/\\.(?=\\d{3}(\\D|$))/g, '')\n        .replace(',', '.');\n      const parsed = Number.parseFloat(cleaned);\n      return Number.isNaN(parsed) ? Number.NaN : parsed;\n    }\n    return Number.NaN;\n  };\n\n  const safeNumber = (v: unknown, minFrac = 2, maxFrac = 2): string => {\n    const num = typeof v === 'number' ? v : toNumber(v);\n    if (!Number.isFinite(num)) {\n      return '';\n    }\n    return num.toLocaleString('de-DE', {\n      minimumFractionDigits: minFrac,\n      maximumFractionDigits: maxFrac\n    });\n  };\n\n  const renderMissingValue = (reason = ''): string => {\n    const title = reason || 'Kein Wert verfügbar';\n    return `<span class=\"missing-value\" role=\"note\" aria-label=\"${title}\" title=\"${title}\">—</span>`;\n  };\n\n  if (['gain_abs', 'gain_pct'].includes(key)) {\n    const rowWithFlags = row as (TableRow & { fx_unavailable?: boolean }) | undefined;\n    const missingReason = rowWithFlags?.fx_unavailable\n      ? 'Wechselkurs nicht verfügbar – EUR-Wert unbekannt'\n      : '';\n    if (value == null || (context && context.hasValue === false)) {\n      return renderMissingValue(missingReason);\n    }\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue(missingReason);\n    }\n    const symbol = key === 'gain_pct' ? '%' : '€';\n    formatted = safeNumber(numeric) + `&nbsp;${symbol}`;\n    let cls = 'neutral';\n    if (numeric > 0) {\n      cls = 'positive';\n    } else if (numeric < 0) {\n      cls = 'negative';\n    }\n    return `<span class=\"${cls}\">${formatted}</span>`;\n  } else if (key === 'position_count') {\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue();\n    }\n    formatted = numeric.toLocaleString('de-DE');\n  } else if (['balance', 'current_value', 'purchase_value'].includes(key)) {\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      if (row?.fx_unavailable) {\n        return renderMissingValue('Wechselkurs nicht verfügbar – EUR-Wert unbekannt');\n      }\n      if (context && context.hasValue === false) {\n        return renderMissingValue();\n      }\n      return renderMissingValue();\n    }\n    formatted = safeNumber(numeric) + '&nbsp;€';\n  } else if (key === 'current_holdings') {\n    // Bestände (Anzahl Anteile) – etwas mehr Präzision (bis 4 Nachkommastellen), aber ohne unnötige Nullen\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue();\n    }\n    const hasFraction = Math.abs(numeric % 1) > 0;\n    formatted = numeric.toLocaleString('de-DE', {\n      minimumFractionDigits: hasFraction ? 2 : 0,\n      maximumFractionDigits: 4\n    });\n  } else {\n    const base = typeof value === 'string' ? value : value != null ? String(value) : '';\n    formatted = base;\n    if (formatted) {\n      const MAX_LEN = 60;\n      if (formatted.length > MAX_LEN) {\n        formatted = formatted.slice(0, MAX_LEN - 1) + '…';\n      }\n      // Entferne frühere Präfixe (Abwärtskompatibilität)\n      if (formatted.startsWith('Kontostand ')) {\n        formatted = formatted.substring('Kontostand '.length);\n      } else if (formatted.startsWith('Depotwert ')) {\n        formatted = formatted.substring('Depotwert '.length);\n      }\n    }\n  }\n  if (formatted == null || formatted === '') {\n    return renderMissingValue();\n  }\n\n  return formatted;\n}\n\nexport function makeTable(\n  rows: TableRow[],\n  cols: TableColumn[],\n  sumColumns: readonly string[] = [],\n  options: TableOptions = {},\n): string {\n  /**\n   * Erweiterung (optional):\n   * options.sortable    -> true | false (default false)\n   * options.defaultSort -> { key: 'name', dir: 'asc' } (nur wirksam falls sortable)\n   *\n   * Bestehende Aufrufer (3 Parameter) bleiben kompatibel.\n   */\n  const { sortable = false, defaultSort } = options || {};\n  const defaultSortKey = defaultSort?.key ?? '';\n  const defaultSortDir: SortDirection = defaultSort?.dir === 'desc' ? 'desc' : 'asc';\n\n  const escapeAttribute = (value: unknown): string => {\n    if (value == null) {\n      return '';\n    }\n    return String(value)\n      .replace(/&/g, '&amp;')\n      .replace(/\"/g, '&quot;');\n  };\n\n  let html = '<table><thead><tr>';\n  cols.forEach(c => {\n    const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n    // Falls sortable: th data-sort-key setzen (nur wenn key vorhanden)\n    if (sortable && c.key) {\n      html += `<th${alignClass} data-sort-key=\"${c.key}\">${c.label}</th>`;\n    } else {\n      html += `<th${alignClass}>${c.label}</th>`;\n    }\n  });\n  html += '</tr></thead><tbody>';\n\n  rows.forEach(r => {\n    html += '<tr>';\n    cols.forEach(c => {\n      const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n      html += `<td${alignClass}>${formatValue(c.key, r[c.key], r)}</td>`;\n    });\n    html += '</tr>';\n  });\n\n  // Summen berechnen (unverändert)\n  const sums: Record<string, number | null> = {};\n  const sumMeta: Record<string, TableFooterContext> = {};\n  cols.forEach(c => {\n    if (sumColumns.includes(c.key)) {\n      let total = 0;\n      let hasValue = false;\n      rows.forEach(row => {\n        const v = row[c.key];\n        if (typeof v === 'number' && Number.isFinite(v)) {\n          total += v;\n          hasValue = true;\n        }\n      });\n      sums[c.key] = hasValue ? total : null;\n      sumMeta[c.key] = { hasValue };\n    }\n  });\n\n  const gainAbsSum = sums['gain_abs'] ?? null;\n  if (gainAbsSum != null) {\n    const purchaseSum = sums['purchase_value'] ?? null;\n    if (purchaseSum != null && purchaseSum > 0) {\n      sums['gain_pct'] = (gainAbsSum / purchaseSum) * 100;\n    } else {\n      const currentValueSum = sums['current_value'] ?? null;\n      if (currentValueSum != null && currentValueSum !== 0) {\n        sums['gain_pct'] = (gainAbsSum / (currentValueSum - gainAbsSum)) * 100;\n      }\n    }\n  }\n\n  const aggregatedGainPct = Number.isFinite(sums['gain_pct'] ?? NaN) ? sums['gain_pct'] : null;\n  let aggregatedGainPctLabel = '';\n  let aggregatedGainPctSign = 'neutral';\n\n  if (aggregatedGainPct != null) {\n    aggregatedGainPctLabel = `${formatNumber(aggregatedGainPct)}\\u00a0%`;\n    if (aggregatedGainPct > 0) {\n      aggregatedGainPctSign = 'positive';\n    } else if (aggregatedGainPct < 0) {\n      aggregatedGainPctSign = 'negative';\n    }\n  }\n\n  html += '<tr class=\"footer-row\">';\n  cols.forEach((c, idx) => {\n    const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n    if (idx === 0) {\n      html += `<td${alignClass}>Summe</td>`;\n      return;\n    }\n\n    if (sums[c.key] != null) {\n      let extraAttributes = '';\n      if (c.key === 'gain_abs' && aggregatedGainPctLabel) {\n        extraAttributes = ` data-gain-pct=\"${escapeAttribute(aggregatedGainPctLabel)}\" data-gain-sign=\"${escapeAttribute(aggregatedGainPctSign)}\"`;\n      }\n      html += `<td${alignClass}${extraAttributes}>${formatValue(c.key, sums[c.key], undefined, sumMeta[c.key])}</td>`;\n      return;\n    }\n\n    if (c.key === 'gain_pct' && sums['gain_pct'] != null) {\n      html += `<td${alignClass}>${formatValue('gain_pct', sums['gain_pct'], undefined, sumMeta[c.key])}</td>`;\n      return;\n    }\n\n    const fallbackContext = sumMeta[c.key] ?? { hasValue: false };\n    html += `<td${alignClass}>${formatValue(c.key, null, undefined, fallbackContext)}</td>`;\n  });\n  html += '</tr>';\n\n  html += '</tbody></table>';\n\n  // Falls sortable: Default-Sort-Metadaten injizieren (nicht doppelt parsen falls nicht nötig)\n  if (sortable) {\n    try {\n      const tpl = document.createElement('template');\n      tpl.innerHTML = html.trim();\n      const table = tpl.content.querySelector<HTMLTableElement>('table');\n      if (table) {\n        table.classList.add('sortable-table');\n        if (defaultSortKey) {\n          table.dataset.defaultSort = defaultSortKey;\n          table.dataset.defaultDir = defaultSortDir;\n        }\n        return table.outerHTML;\n      }\n    } catch (e) {\n      console.warn(\"makeTable(sortable): Injection fehlgeschlagen:\", e);\n    }\n  }\n\n  return html;\n}\n\nexport function createHeaderCard(headerTitle: string, meta: string): HTMLDivElement {\n  const headerCard = document.createElement('div');\n  headerCard.className = 'header-card';\n\n  headerCard.innerHTML = `\n    <div class=\"header-content\">\n      <button id=\"nav-left\" class=\"nav-arrow\" aria-label=\"Vorherige Seite\">\n        <svg viewBox=\"0 0 24 24\">\n          <path d=\"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z\"></path>\n        </svg>\n      </button>\n      <h1 id=\"headerTitle\">${headerTitle}</h1>\n      <button id=\"nav-right\" class=\"nav-arrow\" aria-label=\"Nächste Seite\">\n        <svg viewBox=\"0 0 24 24\">\n          <path d=\"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z\"></path>\n        </svg>\n      </button>\n    </div>\n    <div id=\"headerMeta\" class=\"meta\">${meta}</div>\n  `;\n\n  return headerCard;\n}\n\n// === NEU: Vereinheitlichte Format-Helfer für andere Module (z.B. overview.js) ===\nexport function formatNumber(value: number, minFrac = 2, maxFrac = 2): string {\n  const numeric = Number.isNaN(value) ? 0 : value;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: minFrac,\n    maximumFractionDigits: maxFrac\n  });\n}\n\nexport function formatGain(value: number): string {\n  const num = Number.isNaN(value) ? 0 : value;\n  let cls = 'neutral';\n  if (num > 0) {\n    cls = 'positive';\n  } else if (num < 0) {\n    cls = 'negative';\n  }\n  return `<span class=\"${cls}\">${formatNumber(num)}&nbsp;€</span>`;\n}\n\nexport function formatGainPct(value: number): string {\n  const num = Number.isNaN(value) ? 0 : value;\n  let cls = 'neutral';\n  if (num > 0) {\n    cls = 'positive';\n  } else if (num < 0) {\n    cls = 'negative';\n  }\n  return `<span class=\"${cls}\">${formatNumber(num)}&nbsp;%</span>`;\n}\n\n/**\n * Neue Utility: sortTableRows\n * Sortiert die Datenzeilen (<tr>) einer Tabelle anhand eines Keys.\n *\n * @param {HTMLTableElement} tableEl  Ziel-Tabelle\n * @param {string} key                Daten-Key (muss mit data-sort-key im TH oder Positions-Mapping übereinstimmen)\n * @param {'asc'|'desc'} dir          Sortierrichtung\n * @param {boolean} isPositions       true => Positions-Spalten-Mapping verwenden\n * @returns {HTMLTableRowElement[]}   Array der neu angeordneten Daten-Zeilen (ohne Footer)\n *\n * Erkennung Zahl vs. String:\n *  - Entfernt NBSP, €, %, Tausenderpunkte\n *  - Wandelt Komma in Punkt\n *  - Wenn parseFloat ein valides Zahlenergebnis liefert und der ursprüngliche Text\n *    nicht komplett alphabetisch ist -> numerischer Vergleich; sonst localeCompare.\n *\n * Footer-Zeile ('.footer-row') bleibt am Ende erhalten.\n */\nexport function sortTableRows(\n  tableEl: HTMLTableElement | null | undefined,\n  key: string,\n  dir: SortDirection = 'asc',\n  isPositions = false,\n): HTMLTableRowElement[] {\n  if (!tableEl) return [];\n  const tbody = tableEl.querySelector('tbody');\n  if (!tbody) return [];\n\n  const footer = tbody.querySelector<HTMLTableRowElement>('tr.footer-row');\n  const rows = Array\n    .from(tbody.querySelectorAll<HTMLTableRowElement>('tr'))\n    .filter(r => r !== footer);\n\n  // Spaltenindex bestimmen\n  let colIdx = -1;\n  if (isPositions) {\n    const posMap: Record<string, number> = {\n      name: 0,\n      current_holdings: 1,\n      purchase_value: 2,\n      current_value: 3,\n      gain_abs: 4,\n      gain_pct: 5\n    };\n    colIdx = posMap[key];\n  } else {\n    // Generisch über thead th[data-sort-key]\n    const ths = Array.from(tableEl.querySelectorAll<HTMLTableCellElement>('thead th'));\n    for (let i = 0; i < ths.length; i++) {\n      if (ths[i].getAttribute('data-sort-key') === key) {\n        colIdx = i;\n        break;\n      }\n    }\n  }\n  if (colIdx == null || colIdx < 0) return rows;\n\n  const toNumber = (txt: string): number => {\n    if (txt == null) return NaN;\n    const cleaned = txt\n      .replace(/\\u00A0/g, ' ')\n      .replace(/[%€]/g, '')\n      .replace(/\\./g, '')\n      .replace(/,/g, '.')\n      .replace(/[^\\d.-]/g, '')\n      .trim();\n    if (!cleaned) return NaN;\n    const num = parseFloat(cleaned);\n    return Number.isFinite(num) ? num : NaN;\n  };\n\n  rows.sort((a, b) => {\n    const aCell = a.cells.item(colIdx);\n    const bCell = b.cells.item(colIdx);\n    const aTxt = (aCell?.textContent ?? '').trim();\n    const bTxt = (bCell?.textContent ?? '').trim();\n\n    const aNum = toNumber(aTxt);\n    const bNum = toNumber(bTxt);\n\n    let cmp: number;\n    const hasNumericContext = /[0-9]/.test(aTxt) || /[0-9]/.test(bTxt);\n    if (!Number.isNaN(aNum) && !Number.isNaN(bNum) && hasNumericContext) {\n      cmp = aNum - bNum;\n    } else {\n      cmp = aTxt.localeCompare(bTxt, 'de', { sensitivity: 'base' });\n    }\n    return dir === 'asc' ? cmp : -cmp;\n  });\n\n  // Re-Anordnung im DOM\n  rows.forEach(r => tbody.appendChild(r));\n  if (footer) tbody.appendChild(footer);\n\n  // Visuelle Indikatoren aktualisieren (optional generisch)\n  tableEl.querySelectorAll('thead th.sort-active').forEach(th => {\n    th.classList.remove('sort-active', 'dir-asc', 'dir-desc');\n  });\n  const activeTh = tableEl.querySelector<HTMLElement>(`thead th[data-sort-key=\"${key}\"]`);\n  if (activeTh) {\n    activeTh.classList.add('sort-active', dir === 'asc' ? 'dir-asc' : 'dir-desc');\n  }\n\n  return rows;\n}\n","/**\n * Home Assistant websocket API helpers carried over for TypeScript migration.\n */\n\nimport type { PanelConfigLike } from \"../tabs/types\";\nimport type { HomeAssistant } from \"../types/home-assistant\";\n\nexport interface AccountSummary {\n  name?: string | null;\n  currency_code?: string | null;\n  orig_balance?: number | null;\n  balance?: number | null;\n  fx_unavailable?: boolean;\n  [key: string]: unknown;\n}\n\nexport interface PortfolioSummary {\n  uuid?: string | null;\n  name?: string | null;\n  current_value?: number | null;\n  purchase_sum?: number | null;\n  position_count?: number | null;\n  [key: string]: unknown;\n}\n\nexport interface DashboardDataResponse {\n  accounts: AccountSummary[];\n  portfolios: PortfolioSummary[];\n  last_file_update?: string | null;\n  transactions: unknown[];\n  [key: string]: unknown;\n}\n\nexport interface AccountsResponse {\n  accounts: AccountSummary[];\n  [key: string]: unknown;\n}\n\nexport interface PortfoliosResponse {\n  portfolios: PortfolioSummary[];\n  [key: string]: unknown;\n}\n\nexport interface PortfolioPosition {\n  security_uuid: string;\n  name: string;\n  current_holdings: number;\n  purchase_value: number;\n  current_value: number;\n  gain_abs: number;\n  gain_pct: number;\n  [key: string]: unknown;\n}\n\nexport interface PortfolioPositionsResponse {\n  portfolio_uuid: string;\n  positions: PortfolioPosition[];\n  error?: string;\n  [key: string]: unknown;\n}\n\nexport interface SecuritySnapshotResponse {\n  security_uuid: string;\n  snapshot: {\n    name?: string;\n    currency_code?: string;\n    total_holdings?: number;\n    last_price_native?: number | null;\n    last_price_eur?: number;\n    market_value_eur?: number;\n    [key: string]: unknown;\n  };\n  [key: string]: unknown;\n}\n\nexport interface SecurityHistoryPoint {\n  date: number;\n  close: number;\n  [key: string]: unknown;\n}\n\nexport interface SecurityHistoryResponse {\n  security_uuid: string;\n  prices: SecurityHistoryPoint[];\n  start_date?: number | null;\n  end_date?: number | null;\n  [key: string]: unknown;\n}\n\nexport interface LastFileUpdateResponse {\n  last_file_update?: string | null;\n  [key: string]: unknown;\n}\n\nexport interface SecurityHistoryOptions {\n  startDate?: number | null;\n  endDate?: number | null;\n  start_date?: number | null;\n  end_date?: number | null;\n  [key: string]: unknown;\n}\n\ninterface SecurityHistoryRequestPayload {\n  type: \"pp_reader/get_security_history\";\n  entry_id: string;\n  security_uuid: string;\n  start_date?: number | null;\n  end_date?: number | null;\n  [key: string]: string | number | null | undefined;\n}\n\nfunction deriveEntryId(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): string | undefined {\n  let entryId =\n    panelConfig?.config?.entry_id ??\n    panelConfig?.entry_id ??\n    panelConfig?.config?._panel_custom?.config?.entry_id ??\n    undefined;\n\n  if (!entryId && hass?.panels) {\n    const panels = hass.panels;\n    const candidate =\n      (panels.ppreader as PanelConfigLike | undefined) ??\n      (panels.pp_reader as PanelConfigLike | undefined) ??\n      (Object.values(panels).find(\n        panel => (panel as PanelConfigLike | undefined)?.webcomponent_name === \"pp-reader-panel\",\n      ) as PanelConfigLike | undefined);\n\n    entryId =\n      candidate?.config?.entry_id ??\n      candidate?.entry_id ??\n      candidate?.config?._panel_custom?.config?.entry_id ??\n      undefined;\n  }\n\n  return entryId ?? undefined;\n}\n\n// Export für andere Module (Dashboard/Event-Filter)\nexport function getEntryId(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): string | undefined {\n  return deriveEntryId(hass, panelConfig);\n}\n\n// Dashboard Data\nexport async function fetchDashboardDataWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<DashboardDataResponse> {\n  if (!hass) {\n    throw new Error(\"fetchDashboardDataWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchDashboardDataWS: fehlendes entry_id\");\n  }\n\n  return hass.connection.sendMessagePromise<DashboardDataResponse>({\n    type: \"pp_reader/get_dashboard_data\",\n    entry_id: entryId,\n  });\n}\n\n// Accounts\nexport async function fetchAccountsWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<AccountsResponse> {\n  if (!hass) {\n    throw new Error(\"fetchAccountsWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchAccountsWS: fehlendes entry_id\");\n  }\n\n  return hass.connection.sendMessagePromise<AccountsResponse>({\n    type: \"pp_reader/get_accounts\",\n    entry_id: entryId,\n  });\n}\n\n// Last file update\nexport async function fetchLastFileUpdateWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<string> {\n  if (!hass) {\n    throw new Error(\"fetchLastFileUpdateWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchLastFileUpdateWS: fehlendes entry_id\");\n  }\n\n  const response = await hass.connection.sendMessagePromise<\n    LastFileUpdateResponse | string\n  >({\n    type: \"pp_reader/get_last_file_update\",\n    entry_id: entryId,\n  });\n\n  if (typeof response === \"string\") {\n    return response;\n  }\n\n  const lastFileUpdate = response?.last_file_update;\n  return typeof lastFileUpdate === \"string\" ? lastFileUpdate : \"\";\n}\n\n// Portfolios\nexport async function fetchPortfoliosWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<PortfoliosResponse> {\n  if (!hass) {\n    throw new Error(\"fetchPortfoliosWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchPortfoliosWS: fehlendes entry_id\");\n  }\n\n  return hass.connection.sendMessagePromise<PortfoliosResponse>({\n    type: \"pp_reader/get_portfolio_data\",\n    entry_id: entryId,\n  });\n}\n\n// Positions (lazy)\nexport async function fetchPortfolioPositionsWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  portfolioUuid: string | null | undefined,\n): Promise<PortfolioPositionsResponse> {\n  if (!hass) {\n    throw new Error(\"fetchPortfolioPositionsWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchPortfolioPositionsWS: fehlendes entry_id\");\n  }\n\n  if (!portfolioUuid) {\n    throw new Error(\"fetchPortfolioPositionsWS: fehlendes portfolio_uuid\");\n  }\n\n  return hass.connection.sendMessagePromise<PortfolioPositionsResponse>({\n    type: \"pp_reader/get_portfolio_positions\",\n    entry_id: entryId,\n    portfolio_uuid: portfolioUuid,\n  });\n}\n\n// Security snapshot for detail tab\nexport async function fetchSecuritySnapshotWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  securityUuid: string | null | undefined,\n): Promise<SecuritySnapshotResponse> {\n  if (!hass) {\n    throw new Error(\"fetchSecuritySnapshotWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchSecuritySnapshotWS: fehlendes entry_id\");\n  }\n\n  if (!securityUuid) {\n    throw new Error(\"fetchSecuritySnapshotWS: fehlendes securityUuid\");\n  }\n\n  return hass.connection.sendMessagePromise<SecuritySnapshotResponse>({\n    type: \"pp_reader/get_security_snapshot\",\n    entry_id: entryId,\n    security_uuid: securityUuid,\n  });\n}\n\n// Historical prices for detail tab charting\nexport async function fetchSecurityHistoryWS(\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  securityUuid: string | null | undefined,\n  options: SecurityHistoryOptions | null | undefined = {},\n): Promise<SecurityHistoryResponse> {\n  if (!hass) {\n    throw new Error(\"fetchSecurityHistoryWS: fehlendes hass\");\n  }\n\n  const entryId = deriveEntryId(hass, panelConfig);\n  if (!entryId) {\n    throw new Error(\"fetchSecurityHistoryWS: fehlendes entry_id\");\n  }\n\n  if (!securityUuid) {\n    throw new Error(\"fetchSecurityHistoryWS: fehlendes securityUuid\");\n  }\n\n  const payload: SecurityHistoryRequestPayload = {\n    type: \"pp_reader/get_security_history\",\n    entry_id: entryId,\n    security_uuid: securityUuid,\n  };\n\n  const { startDate, endDate, start_date: startDateRaw, end_date: endDateRaw } =\n    options || {};\n\n  const resolvedStart = startDate ?? startDateRaw;\n  if (resolvedStart !== undefined && resolvedStart !== null) {\n    payload.start_date = resolvedStart;\n  }\n\n  const resolvedEnd = endDate ?? endDateRaw;\n  if (resolvedEnd !== undefined && resolvedEnd !== null) {\n    payload.end_date = resolvedEnd;\n  }\n\n  return hass.connection.sendMessagePromise<SecurityHistoryResponse>(payload);\n}\n","/**\n * Live update handlers mirrored from the legacy websocket client.\n */\n\nimport { makeTable } from '../content/elements';\nimport { sortTableRows } from '../content/elements'; // NEU: generische Sortier-Utility\nimport type { SortDirection } from '../content/elements';\nimport type { PortfolioPositionsUpdatedEventDetail } from '../tabs/types';\nimport type { AccountSummary, PortfolioSummary } from './api';\n\nexport type { PortfolioPositionsUpdatedEventDetail } from '../tabs/types';\n\ntype QueryRoot = HTMLElement | Document;\n\ninterface PortfolioPositionData {\n  security_uuid?: string | null;\n  name?: string | null;\n  current_holdings?: number | null;\n  purchase_value?: number | null;\n  current_value?: number | null;\n  gain_abs?: number | null;\n  gain_pct?: number | null;\n  [key: string]: unknown;\n}\n\ninterface PortfolioPositionsUpdatePayload {\n  portfolio_uuid?: string | null;\n  portfolioUuid?: string | null;\n  positions?: PortfolioPositionData[] | null;\n  error?: unknown;\n  [key: string]: unknown;\n}\n\ninterface PendingPortfolioUpdate {\n  positions: PortfolioPositionData[];\n  error?: unknown;\n}\n\ninterface PendingRetryMeta {\n  attempts: number;\n  timer: ReturnType<typeof setTimeout> | null;\n}\n\ninterface ApplyPositionsResult {\n  applied: boolean;\n  reason?: 'invalid' | 'missing' | 'hidden';\n}\n\ninterface PortfolioUpdatePayload extends Partial<PortfolioSummary> {\n  uuid?: string | null;\n  value?: number | null;\n  purchaseSum?: number | null;\n  count?: number | null;\n  position_count?: number | null;\n  [key: string]: unknown;\n}\n\nconst PENDING_RETRY_INTERVAL = 500;\nconst PENDING_MAX_ATTEMPTS = 10;\nexport const PORTFOLIO_POSITIONS_UPDATED_EVENT = 'pp-reader:portfolio-positions-updated';\n\nfunction ensurePendingMap(): Map<string, PendingPortfolioUpdate> {\n  if (!window.__ppReaderPendingPositions) {\n    window.__ppReaderPendingPositions = new Map<string, PendingPortfolioUpdate>();\n  }\n  return window.__ppReaderPendingPositions!;\n}\n\nfunction ensurePendingRetryMeta(): Map<string, PendingRetryMeta> {\n  if (!window.__ppReaderPendingRetryMeta) {\n    window.__ppReaderPendingRetryMeta = new Map<string, PendingRetryMeta>();\n  }\n  return window.__ppReaderPendingRetryMeta!;\n}\n\nfunction renderPositionsError(error: unknown, portfolioUuid: string): string {\n  const safeError = typeof error === 'string' ? error : String(error ?? 'Unbekannter Fehler');\n  return `<div class=\"error\">${safeError} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n}\n\nfunction restoreSortAndInit(containerEl: HTMLElement, rootEl: QueryRoot, pid: string): void {\n  const table = containerEl.querySelector<HTMLTableElement>('table.sortable-positions');\n  if (!table) return;\n\n  const key = containerEl.dataset.sortKey || table.dataset.defaultSort || 'name';\n  const dirValue = containerEl.dataset.sortDir || table.dataset.defaultDir || 'asc';\n  const direction: SortDirection = dirValue === 'desc' ? 'desc' : 'asc';\n  containerEl.dataset.sortKey = key;\n  containerEl.dataset.sortDir = direction;\n\n  try {\n    sortTableRows(table, key, direction, true);\n  } catch (e) {\n    console.warn('restoreSortAndInit: sortTableRows Fehler:', e);\n  }\n\n  try {\n    if (window.__ppReaderAttachPortfolioPositionsSorting) {\n      window.__ppReaderAttachPortfolioPositionsSorting(rootEl, pid);\n    }\n  } catch (e) {\n    console.warn('restoreSortAndInit: attachPortfolioPositionsSorting Fehler:', e);\n  }\n\n  try {\n    if (window.__ppReaderAttachSecurityDetailListener) {\n      window.__ppReaderAttachSecurityDetailListener(rootEl, pid);\n    }\n  } catch (e) {\n    console.warn('restoreSortAndInit: attachSecurityDetailListener Fehler:', e);\n  }\n}\n\nfunction applyPortfolioPositionsToDom(\n  root: QueryRoot | null | undefined,\n  portfolioUuid: string | null | undefined,\n  positions: PortfolioPositionData[],\n  error?: unknown,\n): ApplyPositionsResult {\n  if (!root || !portfolioUuid) {\n    return { applied: false, reason: 'invalid' };\n  }\n\n  const detailsRow = root.querySelector<HTMLTableRowElement>(\n    `.portfolio-table .portfolio-details[data-portfolio=\"${portfolioUuid}\"]`\n  );\n  if (!detailsRow) {\n    return { applied: false, reason: 'missing' };\n  }\n\n  const container = detailsRow.querySelector<HTMLElement>('.positions-container');\n  if (!container) {\n    return { applied: false, reason: 'missing' };\n  }\n\n  if (detailsRow.classList.contains('hidden')) {\n    return { applied: false, reason: 'hidden' };\n  }\n\n  if (error) {\n    container.innerHTML = renderPositionsError(error, portfolioUuid);\n    return { applied: true };\n  }\n\n  const prevKey = container.dataset.sortKey;\n  const prevDir = container.dataset.sortDir;\n\n  container.innerHTML = renderPositionsTableInline(positions);\n\n  if (prevKey) container.dataset.sortKey = prevKey;\n  if (prevDir) container.dataset.sortDir = prevDir;\n\n  restoreSortAndInit(container, root, portfolioUuid);\n  return { applied: true };\n}\n\nexport function flushPendingPositions(root: QueryRoot | null | undefined, portfolioUuid: string): boolean {\n  const pendingMap = ensurePendingMap();\n  const pending = pendingMap.get(portfolioUuid);\n  if (!pending) return false;\n\n  const result = applyPortfolioPositionsToDom(\n    root,\n    portfolioUuid,\n    pending.positions,\n    pending.error\n  );\n  if (result.applied) {\n    pendingMap.delete(portfolioUuid);\n  }\n  return result.applied;\n}\n\nexport function flushAllPendingPositions(root: QueryRoot | null | undefined): boolean {\n  const pendingMap = ensurePendingMap();\n  let appliedAny = false;\n  for (const [portfolioUuid] of pendingMap) {\n    if (flushPendingPositions(root, portfolioUuid)) {\n      appliedAny = true;\n    }\n  }\n  return appliedAny;\n}\n\nfunction schedulePendingRetry(root: QueryRoot | null | undefined, portfolioUuid: string): void {\n  const retryMetaMap = ensurePendingRetryMeta();\n  const meta: PendingRetryMeta = retryMetaMap.get(portfolioUuid) ?? {\n    attempts: 0,\n    timer: null,\n  };\n\n  if (meta.timer) {\n    return;\n  }\n\n  meta.timer = setTimeout(() => {\n    meta.timer = null;\n    meta.attempts += 1;\n\n    const success = flushPendingPositions(root, portfolioUuid);\n    if (success || meta.attempts >= PENDING_MAX_ATTEMPTS) {\n      retryMetaMap.delete(portfolioUuid);\n      if (!success) {\n        ensurePendingMap().delete(portfolioUuid);\n      }\n    } else {\n      schedulePendingRetry(root, portfolioUuid);\n    }\n  }, PENDING_RETRY_INTERVAL);\n\n  retryMetaMap.set(portfolioUuid, meta);\n}\n\n/**\n * Handler für Kontodaten-Updates (Accounts, inkl. FX).\n * @param update Die empfangenen Kontodaten (mit currency_code, orig_balance, balance(EUR)).\n * @param root Das Root-Element des Dashboards.\n */\nexport function handleAccountUpdate(\n  update: AccountSummary[] | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  console.log('updateConfigsWS: Kontodaten-Update erhalten:', update);\n  const updatedAccounts = Array.isArray(update) ? update : [];\n\n  if (!root) {\n    return;\n  }\n\n  // Tabellen aktualisieren (EUR + FX)\n  updateAccountTable(updatedAccounts, root);\n\n  // Portfolios aus aktueller Tabelle lesen (für Total-Neuberechnung)\n  const portfolioTable = root.querySelector<HTMLTableElement>('.portfolio-table table');\n  const portfolios = portfolioTable\n    ? Array.from(\n        portfolioTable.querySelectorAll<HTMLTableRowElement>('tbody tr:not(.footer-row)'),\n      ).map(row => {\n        // Spalten: Name | position_count | current_value | gain_abs | gain_pct\n        const currentValueCell = row.cells.item(2);\n        const textContent = currentValueCell?.textContent ?? '';\n        const numeric = parseFloat(\n          textContent.replace(/\\./g, '').replace(',', '.').replace(/[^\\d.-]/g, ''),\n        );\n        return {\n          current_value: Number.isFinite(numeric) ? numeric : 0,\n        };\n      })\n    : [];\n\n  updateTotalWealth(updatedAccounts, portfolios, root);\n}\n\n/**\n * Aktualisiert die Tabellen mit den Kontodaten (EUR + FX).\n * @param {Array} accounts - Alle Kontodaten.\n * @param {HTMLElement} root - Root-Element.\n */\nfunction updateAccountTable(accounts: AccountSummary[], root: QueryRoot): void {\n  const eurContainer = root.querySelector<HTMLElement>('.account-table');\n  const fxContainer = root.querySelector<HTMLElement>('.fx-account-table');\n\n  const eurAccounts = accounts.filter(account => (account.currency_code || 'EUR') === 'EUR');\n  const fxAccounts = accounts.filter(account => (account.currency_code || 'EUR') !== 'EUR');\n\n  if (eurContainer) {\n    eurContainer.innerHTML = makeTable(\n      eurAccounts,\n      [\n        { key: 'name', label: 'Name' },\n        { key: 'balance', label: 'Kontostand (EUR)', align: 'right' },\n      ],\n      ['balance'],\n    );\n  } else {\n    console.warn('updateAccountTable: .account-table nicht gefunden.');\n  }\n\n  if (fxContainer) {\n    fxContainer.innerHTML = makeTable(\n      fxAccounts.map(account => ({\n        ...account,\n        fx_display: `${(account.orig_balance ?? 0).toLocaleString('de-DE', {\n          minimumFractionDigits: 2,\n          maximumFractionDigits: 2,\n        })}\\u00A0${account.currency_code}`,\n      })),\n      [\n        { key: 'name', label: 'Name' },\n        { key: 'fx_display', label: 'Betrag (FX)' },\n        { key: 'balance', label: 'EUR', align: 'right' },\n      ],\n      ['balance'],\n    );\n  } else if (fxAccounts.length) {\n    console.warn('updateAccountTable: .fx-account-table nicht gefunden, obwohl FX-Konten vorhanden sind.');\n  }\n}\n\n/**\n * Handler für Depot-Updates (aggregierte Portfolio-Werte).\n * Ersetzt die bisherige komplette Tabellen-Neuerstellung durch ein gezieltes Patchen\n * der vorhandenen expandierbaren Tabelle (gebaut in overview.js).\n */\nexport function handlePortfolioUpdate(\n  update: PortfolioUpdatePayload[] | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  if (!Array.isArray(update)) {\n    console.warn('handlePortfolioUpdate: Update ist kein Array:', update);\n    return;\n  }\n\n  try {\n    console.debug('handlePortfolioUpdate: payload=', update);\n  } catch {\n    // no-op for browsers without console.debug\n  }\n\n  if (!root) {\n    return;\n  }\n\n  // Tabelle finden (neuer Selektor unterstützt beide Varianten)\n  const table =\n    root.querySelector<HTMLTableElement>('.portfolio-table table') ||\n    root.querySelector<HTMLTableElement>('table.expandable-portfolio-table');\n  if (!table) {\n    const overviewHost = root.querySelector('.portfolio-table');\n    const detailViewActive =\n      !overviewHost &&\n      (root.querySelector('.security-range-selector') ||\n        root.querySelector('.security-detail-placeholder'));\n\n    if (detailViewActive) {\n      console.debug(\n        'handlePortfolioUpdate: Übersicht nicht aktiv – Update wird später angewendet.',\n      );\n    } else {\n      console.warn('handlePortfolioUpdate: Keine Portfolio-Tabelle gefunden.');\n    }\n    return;\n  }\n\n  const tbody = table.tBodies.item(0) ?? table.querySelector('tbody');\n  if (!tbody) {\n    console.warn('handlePortfolioUpdate: Kein <tbody> in Tabelle.');\n    return;\n  }\n\n  // Helper Formatierer (lokal oder einfacher Fallback)\n  const formatNumberLocal = (val: number): string => {\n    if (window.Intl) {\n      try {\n        return new Intl.NumberFormat(navigator.language || 'de-DE', {\n          minimumFractionDigits: 2,\n          maximumFractionDigits: 2,\n        }).format(val);\n      } catch {\n        // fallback below\n      }\n    }\n    return (Math.round(val * 100) / 100).toFixed(2).replace('.', ',');\n  };\n\n  // Map: uuid -> Row\n  const rowMap = new Map<string, HTMLTableRowElement>(\n    Array.from(tbody.querySelectorAll<HTMLTableRowElement>('tr.portfolio-row'))\n      .filter(row => Boolean(row.dataset?.portfolio))\n      .map(row => [row.dataset.portfolio as string, row]),\n  );\n\n  let patched = 0;\n\n  const formatPositionCount = (value: number | null | undefined): string => {\n    const numeric = Number.isFinite(value) ? Number(value) : 0;\n    try {\n      return numeric.toLocaleString('de-DE');\n    } catch {\n      return numeric.toString();\n    }\n  };\n\n  for (const entry of update) {\n    const uuid = entry?.uuid;\n    if (typeof uuid !== 'string' || !uuid) {\n      continue;\n    }\n    const row = rowMap.get(uuid);\n    if (!row) {\n      continue;\n    }\n\n    if (row.cells.length < 3) {\n      continue;\n    }\n\n    const posCountCell = row.cells.item(1);\n    const curValCell = row.cells.item(2);\n    const gainAbsCell = row.cells.item(3);\n    const gainPctCell = row.cells.item(4);\n\n    if (!posCountCell || !curValCell) {\n      continue;\n    }\n\n    // Normalisierung (Full Sync nutzt value/purchase_sum; Price Events current_value/purchase_sum)\n    const posCount = Number(entry.position_count ?? entry.count ?? 0);\n    const curVal = Number(entry.current_value ?? entry.value ?? 0);\n    const purchase = Number(entry.purchase_sum ?? entry.purchaseSum ?? 0);\n\n    const gainAbs = curVal - purchase;\n    const gainPct = purchase > 0 ? (gainAbs / purchase) * 100 : 0;\n\n    const oldCur = parseNumLoose(curValCell.textContent);\n    const oldCnt = parseNumLoose(posCountCell.textContent);\n\n    if (oldCnt !== posCount) {\n      posCountCell.textContent = formatPositionCount(posCount);\n    }\n    if (Math.abs(oldCur - curVal) >= 0.005) {\n      curValCell.textContent = `${formatNumberLocal(curVal)} €`;\n      row.classList.add('flash-update');\n      setTimeout(() => row.classList.remove('flash-update'), 800);\n    }\n    if (gainAbsCell) {\n      gainAbsCell.innerHTML = formatGain(gainAbs);\n      gainAbsCell.dataset.gainPct = Number.isFinite(gainPct)\n        ? `${formatNumberLocal(gainPct)} %`\n        : '—';\n      gainAbsCell.dataset.gainSign = Number.isFinite(gainPct)\n        ? gainPct > 0\n          ? 'positive'\n          : gainPct < 0\n            ? 'negative'\n            : 'neutral'\n        : 'neutral';\n    }\n    if (gainPctCell) {\n      gainPctCell.innerHTML = formatGainPct(gainPct);\n    }\n\n    row.dataset.positionCount = String(posCount);\n    row.dataset.currentValue = String(curVal);\n    row.dataset.purchaseSum = String(purchase);\n    row.dataset.gainAbs = String(gainAbs);\n    row.dataset.gainPct = String(gainPct);\n\n    patched += 1;\n  }\n\n  if (patched === 0) {\n    console.debug('handlePortfolioUpdate: Keine passenden Zeilen gefunden / keine Änderungen.');\n  } else {\n    console.debug(`handlePortfolioUpdate: ${patched} Zeile(n) gepatcht.`);\n  }\n\n  try {\n    updatePortfolioFooter(table);\n  } catch (error) {\n    console.warn('handlePortfolioUpdate: Fehler bei Summen-Neuberechnung:', error);\n  }\n\n  // Total-Wealth neu berechnen (Accounts + Portfolios)\n  try {\n    const findTable = (...selectors: Array<string | null | undefined>): HTMLTableElement | null => {\n      for (const selector of selectors) {\n        if (!selector) continue;\n        const tableEl = root.querySelector<HTMLTableElement>(selector);\n        if (tableEl) return tableEl;\n      }\n      return null;\n    };\n\n    const eurTable = findTable(\n      '.account-table table',\n      '.accounts-eur-table table',\n      '.accounts-table table',\n    );\n    const fxTable = findTable(\n      '.fx-account-table table',\n      '.accounts-fx-table table',\n    );\n\n    const extractAccounts = (tbl: HTMLTableElement | null, isFx: boolean): Array<{ balance: number }> => {\n      if (!tbl) return [];\n      const accountRows = tbl.querySelectorAll<HTMLTableRowElement>('tbody tr.account-row');\n      const rows = accountRows.length\n        ? Array.from(accountRows)\n        : Array.from(tbl.querySelectorAll<HTMLTableRowElement>('tbody tr:not(.footer-row)'));\n\n      return rows.map(row => {\n        const cell = isFx ? row.cells.item(2) : row.cells.item(1);\n        return { balance: parseNumLoose(cell?.textContent) };\n      });\n    };\n    const accounts = [\n      ...extractAccounts(eurTable, false),\n      ...extractAccounts(fxTable, true),\n    ];\n\n    const portfolioDomValues = Array.from(\n      table.querySelectorAll<HTMLTableRowElement>('tbody tr.portfolio-row'),\n    ).map(row => {\n      const cv = parseNumLoose(row.cells.item(2)?.textContent);\n      const gain = parseNumLoose(row.cells.item(3)?.textContent);\n      const ps = cv - gain;\n      return { current_value: cv, purchase_sum: ps };\n    });\n\n    updateTotalWealth(accounts, portfolioDomValues, root);\n  } catch (error) {\n    console.warn('handlePortfolioUpdate: Fehler bei Total-Neuberechnung:', error);\n  }\n}\n\n/**\n * NEU: Handler für Einzel-Positions-Updates (Event: portfolio_positions).\n * @param {{portfolio_uuid: string, positions: Array}} update\n * @param {HTMLElement} root\n */\nfunction normalizePortfolioUuid(payload: PortfolioPositionsUpdatePayload | null | undefined): string | null {\n  if (!payload || typeof payload !== 'object') {\n    return null;\n  }\n  const direct = payload.portfolio_uuid;\n  if (typeof direct === 'string' && direct) {\n    return direct;\n  }\n  const camelCase = payload.portfolioUuid;\n  if (typeof camelCase === 'string' && camelCase) {\n    return camelCase;\n  }\n  return null;\n}\n\nfunction processPortfolioPositionsUpdate(\n  update: PortfolioPositionsUpdatePayload | null | undefined,\n  root: QueryRoot | null | undefined,\n): boolean {\n  const portfolioUuid = normalizePortfolioUuid(update);\n  if (!portfolioUuid) {\n    console.warn('handlePortfolioPositionsUpdate: Ungültiges Update:', update);\n    return false;\n  }\n\n  const error = update?.error;\n  const positions = Array.isArray(update?.positions)\n    ? update.positions.filter((pos): pos is PortfolioPositionData => Boolean(pos))\n    : [];\n\n  // Positions-Cache aktualisieren (Lazy-Load bleibt bestehen)\n  try {\n    const cache = window.__ppReaderPortfolioPositionsCache;\n    if (cache && typeof cache.set === 'function' && !error) {\n      cache.set(portfolioUuid, positions);\n    }\n  } catch (e) {\n    console.warn(\"handlePortfolioPositionsUpdate: Positions-Cache konnte nicht aktualisiert werden:\", e);\n  }\n\n  const result = applyPortfolioPositionsToDom(root, portfolioUuid, positions, error);\n  const pendingMap = ensurePendingMap();\n\n  if (result.applied) {\n    pendingMap.delete(portfolioUuid);\n  } else {\n    pendingMap.set(portfolioUuid, { positions, error });\n    if (result.reason !== 'hidden') {\n      schedulePendingRetry(root, portfolioUuid);\n    }\n  }\n\n  if (!error && positions.length > 0) {\n    const securityUuids = Array.from(\n      new Set(\n        positions\n          .map(pos => pos?.security_uuid)\n          .filter((uuid): uuid is string => typeof uuid === 'string' && uuid.length > 0),\n      ),\n    );\n\n    if (securityUuids.length && typeof window !== 'undefined') {\n      try {\n        window.dispatchEvent(\n          new CustomEvent<PortfolioPositionsUpdatedEventDetail>(\n            PORTFOLIO_POSITIONS_UPDATED_EVENT,\n            {\n              detail: {\n                portfolioUuid,\n                securityUuids,\n              },\n            },\n          ),\n        );\n      } catch (dispatchError) {\n        console.warn(\n          'handlePortfolioPositionsUpdate: Dispatch des Portfolio-Events fehlgeschlagen',\n          dispatchError,\n        );\n      }\n    }\n  }\n\n  return true;\n}\n\nexport function handlePortfolioPositionsUpdate(\n  update: PortfolioPositionsUpdatePayload | PortfolioPositionsUpdatePayload[] | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  if (Array.isArray(update)) {\n    let handled = false;\n    for (const item of update) {\n      if (processPortfolioPositionsUpdate(item, root)) {\n        handled = true;\n      }\n    }\n    if (!handled && update.length) {\n      console.warn('handlePortfolioPositionsUpdate: Kein gültiges Element im Array:', update);\n    }\n    return;\n  }\n\n  processPortfolioPositionsUpdate(update, root);\n}\n\n/* ------------------ Hilfsfunktionen (lokal) ------------------ */\n\nfunction renderPositionsTableInline(positions: PortfolioPositionData[]): string {\n  // Konsistenz Push vs Lazy:\n  try {\n    if (window.__ppReaderRenderPositionsTable) {\n      return window.__ppReaderRenderPositionsTable(positions);\n    }\n  } catch (_) { }\n\n  if (!positions || !positions.length) {\n    return '<div class=\"no-positions\">Keine Positionen vorhanden.</div>';\n  }\n  const rows = positions.map(position => ({\n    name: position.name,\n    current_holdings: position.current_holdings,\n    purchase_value: position.purchase_value,\n    current_value: position.current_value,\n    gain_abs: position.gain_abs,\n    gain_pct: position.gain_pct,\n  }));\n\n  // Basis HTML\n  const raw = makeTable(\n    rows,\n    [\n      { key: 'name', label: 'Wertpapier' },\n      { key: 'current_holdings', label: 'Bestand', align: 'right' },\n      { key: 'purchase_value', label: 'Kaufwert', align: 'right' },\n      { key: 'current_value', label: 'Aktueller Wert', align: 'right' },\n      { key: 'gain_abs', label: '+/-', align: 'right' },\n      { key: 'gain_pct', label: '%', align: 'right' }\n    ],\n    ['purchase_value', 'current_value', 'gain_abs']\n  );\n\n  // Sortier-Metadaten wie in overview.js renderPositionsTable injizieren\n  try {\n    const tpl = document.createElement('template');\n    tpl.innerHTML = raw.trim();\n    const table = tpl.content.querySelector<HTMLTableElement>('table');\n    if (table) {\n      table.classList.add('sortable-positions');\n      const ths = table.querySelectorAll<HTMLTableCellElement>('thead th');\n      const colKeys = ['name', 'current_holdings', 'purchase_value', 'current_value', 'gain_abs', 'gain_pct'];\n      ths.forEach((th, i) => {\n        const key = colKeys[i];\n        if (!key) return;\n        th.setAttribute('data-sort-key', key);\n        th.classList.add('sortable-col');\n      });\n      const bodyRows = table.querySelectorAll<HTMLTableRowElement>('tbody tr');\n      bodyRows.forEach((tr, idx) => {\n        if (tr.classList.contains('footer-row')) {\n          return;\n        }\n        const pos = positions[idx];\n        if (pos?.security_uuid) {\n          tr.dataset.security = pos.security_uuid;\n        }\n        tr.classList.add('position-row');\n      });\n      table.dataset.defaultSort = 'name';\n      table.dataset.defaultDir = 'asc';\n      if (window.__ppReaderApplyGainPctMetadata) {\n        try {\n          window.__ppReaderApplyGainPctMetadata(table);\n        } catch (err) {\n          console.warn('renderPositionsTableInline: applyGainPctMetadata failed', err);\n        }\n      } else {\n        const rows = table.querySelectorAll<HTMLTableRowElement>('tbody tr');\n        rows.forEach(row => {\n          const gainCell = row.cells?.[4];\n          const pctCell = row.cells?.[5];\n          if (!gainCell || !pctCell) return;\n          const pctText = (pctCell.textContent || '').trim() || '—';\n          let pctSign = 'neutral';\n          if (pctCell.querySelector('.positive')) {\n            pctSign = 'positive';\n          } else if (pctCell.querySelector('.negative')) {\n            pctSign = 'negative';\n          }\n          gainCell.dataset.gainPct = pctText;\n          gainCell.dataset.gainSign = pctSign;\n        });\n      }\n      return table.outerHTML;\n    }\n  } catch (e) {\n    console.warn(\"renderPositionsTableInline: Sortier-Metadaten Injection fehlgeschlagen:\", e);\n  }\n  return raw;\n}\n\nif (!window.__ppReaderFlushPendingPositions) {\n  window.__ppReaderFlushPendingPositions = (root, portfolioUuid) =>\n    flushPendingPositions(root, portfolioUuid);\n}\n\nif (!window.__ppReaderFlushAllPendingPositions) {\n  window.__ppReaderFlushAllPendingPositions = (root) => flushAllPendingPositions(root);\n}\n\nfunction updatePortfolioFooter(table: HTMLTableElement | null): void {\n  if (!table) return;\n  try {\n    const helper = window.__ppReaderUpdatePortfolioFooter;\n    if (typeof helper === 'function') {\n      helper(table);\n      return;\n    }\n  } catch (err) {\n    console.warn(\"updatePortfolioFooter: global Helper schlug fehl:\", err);\n  }\n\n  const rows = Array.from(table.querySelectorAll<HTMLTableRowElement>('tbody tr.portfolio-row'));\n  let sumCurrent = 0;\n  let sumGainAbs = 0;\n  let sumPurchase = 0;\n  let sumPositions = 0;\n\n  rows.forEach(r => {\n    const datasetCount = Number(r.dataset?.positionCount);\n    const posCount = Number.isFinite(datasetCount)\n      ? datasetCount\n      : parseInt((r.cells.item(1)?.textContent || '').replace(/\\./g, ''), 10) || 0;\n\n    const datasetCurrent = Number(r.dataset?.currentValue);\n    const currentValue = Number.isFinite(datasetCurrent)\n      ? datasetCurrent\n      : parseNumLoose(r.cells.item(2)?.textContent);\n\n    const datasetGain = Number(r.dataset?.gainAbs);\n    const gainAbs = Number.isFinite(datasetGain)\n      ? datasetGain\n      : parseNumLoose(r.cells.item(3)?.textContent);\n\n    const datasetPurchase = Number(r.dataset?.purchaseSum);\n    const purchase = Number.isFinite(datasetPurchase)\n      ? datasetPurchase\n      : (currentValue - gainAbs);\n\n    sumPositions += posCount;\n    sumCurrent += currentValue;\n    sumGainAbs += gainAbs;\n    sumPurchase += purchase;\n  });\n\n  if (sumPurchase <= 0) {\n    sumPurchase = sumCurrent - sumGainAbs;\n  }\n  const sumGainPct = sumPurchase > 0 ? (sumGainAbs / sumPurchase) * 100 : 0;\n\n  let footer = table.querySelector<HTMLTableRowElement>('tr.footer-row');\n  if (!footer) {\n    footer = document.createElement('tr');\n    footer.className = 'footer-row';\n    table.querySelector('tbody')?.appendChild(footer);\n  }\n  const sumPositionsDisplay = Math.round(sumPositions).toLocaleString('de-DE');\n\n  footer.innerHTML = `\n    <td>Summe</td>\n    <td class=\"align-right\">${sumPositionsDisplay}</td>\n    <td class=\"align-right\">${formatNumber(sumCurrent)}&nbsp;€</td>\n    <td class=\"align-right\">${formatGain(sumGainAbs)}</td>\n    <td class=\"align-right\">${formatGainPct(sumGainPct)}</td>\n  `;\n  const footerGainAbsCell = footer.cells?.[3];\n  if (footerGainAbsCell) {\n    footerGainAbsCell.dataset.gainPct = Number.isFinite(sumGainPct)\n      ? `${formatNumber(sumGainPct)} %`\n      : '—';\n    footerGainAbsCell.dataset.gainSign = Number.isFinite(sumGainPct)\n      ? (sumGainPct > 0 ? 'positive' : sumGainPct < 0 ? 'negative' : 'neutral')\n      : 'neutral';\n  }\n  footer.dataset.positionCount = String(Math.round(sumPositions));\n  footer.dataset.currentValue = String(sumCurrent);\n  footer.dataset.purchaseSum = String(sumPurchase);\n  footer.dataset.gainAbs = String(sumGainAbs);\n  footer.dataset.gainPct = String(sumGainPct);\n}\n\nfunction formatNumber(v: number): string {\n  return (Number.isNaN(v) ? 0 : v).toLocaleString('de-DE', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2\n  });\n}\nfunction formatGain(v: number): string {\n  const cls = v >= 0 ? 'positive' : 'negative';\n  return `<span class=\"${cls}\">${formatNumber(v)}&nbsp;€</span>`;\n}\nfunction formatGainPct(v: number): string {\n  const cls = v >= 0 ? 'positive' : 'negative';\n  return `<span class=\"${cls}\">${formatNumber(v)}&nbsp;%</span>`;\n}\n\nfunction updateTotalWealth(\n  accounts: Array<{ balance?: number | null; current_value?: number | null; value?: number | null }> | null | undefined,\n  portfolios: Array<{ current_value?: number | null; value?: number | null; purchase_sum?: number | null }> | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  const targetRoot: QueryRoot = root || document;\n\n  const accountSum = (Array.isArray(accounts) ? accounts : []).reduce((acc, entry) => {\n    const value = entry != null && typeof entry === 'object'\n      ? entry.balance ?? entry.current_value ?? entry.value ?? 0\n      : entry;\n    const numeric = Number(value);\n    return acc + (Number.isFinite(numeric) ? numeric : 0);\n  }, 0);\n\n  const portfolioSum = (Array.isArray(portfolios) ? portfolios : []).reduce((acc, entry) => {\n    const value = entry != null && typeof entry === 'object'\n      ? entry.current_value ?? entry.value ?? 0\n      : entry;\n    const numeric = Number(value);\n    return acc + (Number.isFinite(numeric) ? numeric : 0);\n  }, 0);\n\n  const totalWealth = accountSum + portfolioSum;\n\n  const headerMeta = targetRoot?.querySelector<HTMLElement>('#headerMeta');\n  if (!headerMeta) {\n    console.warn('updateTotalWealth: #headerMeta nicht gefunden.');\n    return;\n  }\n\n  const valueElement =\n    headerMeta.querySelector<HTMLElement>('strong') ||\n    headerMeta.querySelector<HTMLElement>('.total-wealth-value');\n  if (valueElement) {\n    valueElement.textContent = `${formatNumber(totalWealth)}\\u00A0€`;\n  } else {\n    headerMeta.textContent = `💰 Gesamtvermögen: ${formatNumber(totalWealth)}\\u00A0€`;\n  }\n\n  headerMeta.dataset.totalWealthEur = String(totalWealth);\n}\n\n/**\n * HINWEIS (2025-09):\n * Die frühere Funktion updatePortfolioTable (vollständiger Neuaufbau der Depot-Tabelle)\n * wurde durch inkrementelles Patchen via handlePortfolioUpdate + Lazy-Load der Positions-\n * daten ersetzt. Alte Implementierung entfernt, um doppelte Logik und Render-Flashes\n * zu vermeiden.\n *\n * Falls noch Referenzen auf updatePortfolioTable existieren, bitte auf handlePortfolioUpdate\n * umstellen. (dashboard.js ruft bereits nur noch _doRender -> handlePortfolioUpdate auf.)\n */\n// Entfernte Legacy-Funktion:\n// function updatePortfolioTable(...) { /* veraltet, entfernt */ }\n\n// ==== Last File Update Handler (canonical) ====\n// (Ändere zu export function, damit unten kein Sammel-Export nötig ist)\nexport function handleLastFileUpdate(\n  update: string | { last_file_update?: string | null } | null | undefined,\n  root: QueryRoot | null | undefined,\n): void {\n  const value = typeof update === 'string'\n    ? update\n    : (update && update.last_file_update) || '';\n\n  if (!root) {\n    console.warn('handleLastFileUpdate: root fehlt');\n    return;\n  }\n\n  // Bevorzugt Footer-Karte, sonst erste passende Stelle\n  let el =\n    root.querySelector<HTMLElement>('.footer-card .last-file-update') ||\n    root.querySelector<HTMLElement>('.last-file-update');\n\n  if (!el) {\n    // Fallback: existierende Meta-Hosts durchsuchen\n    const metaHost =\n      root.querySelector<HTMLElement>('.footer-card .meta') ||\n      root.querySelector<HTMLElement>('#headerMeta') ||\n      root.querySelector<HTMLElement>('.header-card .meta') ||\n      root.querySelector<HTMLElement>('.header-card');\n    if (!metaHost) {\n      console.warn('handleLastFileUpdate: Kein Einfügepunkt gefunden.');\n      return;\n    }\n    el = document.createElement('div');\n    el.className = 'last-file-update';\n    metaHost.appendChild(el);\n  }\n\n  // Format abhängig vom Ort (Footer behält <strong>)\n  if (el.closest('.footer-card')) {\n    el.innerHTML = value\n      ? `📂 Letzte Aktualisierung der Datei: <strong>${value}</strong>`\n      : '📂 Letzte Aktualisierung der Datei: <strong>Unbekannt</strong>';\n  } else {\n    // Header/Meta-Version (schlichter Text)\n    el.textContent = value\n      ? `📂 Letzte Aktualisierung: ${value}`\n      : '📂 Letzte Aktualisierung: Unbekannt';\n  }\n}\n/// END handleLastFileUpdate (canonical)\n\n/**\n * NEUER HELPER (Änderung 8):\n * Re-applied die gespeicherte Sortierung einer Positions-Tabelle.\n * Liest container.dataset.sortKey / sortDir oder Default-Werte vom <table>.\n * Nutzt sortTableRows(..., true) für Positions-Mapping.\n * @param {HTMLElement} containerEl .positions-container\n */\nexport function reapplyPositionsSort(containerEl: HTMLElement | null): void {\n  if (!containerEl) return;\n  const table = containerEl.querySelector<HTMLTableElement>('table.sortable-positions');\n  if (!table) return;\n  const key = containerEl.dataset.sortKey || table.dataset.defaultSort || 'name';\n  const dirValue = containerEl.dataset.sortDir || table.dataset.defaultDir || 'asc';\n  const direction: SortDirection = dirValue === 'desc' ? 'desc' : 'asc';\n  // Persistiere (falls erstmalig)\n  containerEl.dataset.sortKey = key;\n  containerEl.dataset.sortDir = direction;\n  sortTableRows(table, key, direction, true);\n}\nwindow.__ppReaderReapplyPositionsSort = reapplyPositionsSort; // Optional global für Lazy-Load-Code\n\n// === Globale / modulweite Utilities ===\nfunction parseNumLoose(txt: string | null | undefined): number {\n  if (txt == null) return 0;\n  return parseFloat(\n    String(txt)\n      .replace(/\\u00A0/g, ' ')\n      .replace(/[€%]/g, '')\n      .replace(/\\./g, '')\n      .replace(',', '.')\n      .replace(/[^\\d.-]/g, '')\n  ) || 0;\n}\n","/**\n * Overview tab renderer copied for the TypeScript source tree.\n */\n\nimport {\n  createHeaderCard,\n  makeTable,\n  formatNumber,\n  formatGain,\n  formatGainPct,\n  formatValue,\n} from '../content/elements';\nimport { openSecurityDetail } from '../dashboard';\nimport {\n  fetchAccountsWS,\n  fetchLastFileUpdateWS,\n  fetchPortfoliosWS,\n  fetchPortfolioPositionsWS,\n} from '../data/api';\nimport type { PortfolioPositionsResponse } from '../data/api';\nimport { flushPendingPositions, flushAllPendingPositions } from '../data/updateConfigsWS';\nimport type { HomeAssistant } from '../types/home-assistant';\nimport type { PanelConfigLike, SecuritySnapshotLike } from './types';\n\ninterface PortfolioPositionLike {\n  security_uuid?: unknown;\n  name?: unknown;\n  current_holdings?: unknown;\n  purchase_value?: unknown;\n  current_value?: unknown;\n  gain_abs?: unknown;\n  gain_pct?: unknown;\n  [key: string]: unknown;\n}\n\ninterface PortfolioPositionsCache extends Map<string, PortfolioPositionLike[]> {\n  getSecuritySnapshot?: (securityUuid: string | null | undefined) => SecuritySnapshotLike | null;\n  getSecurityPositions?: (securityUuid: string | null | undefined) => PortfolioPositionLike[];\n}\n\ninterface PortfolioOverviewDepot {\n  uuid: string;\n  name: string;\n  position_count: number;\n  current_value: number | null;\n  purchase_sum: number;\n  gain_abs: number | null;\n  gain_pct: number | null;\n  hasValue: boolean;\n  fx_unavailable: boolean;\n  missing_value_positions: number;\n}\n\ninterface NormalizedAccountRow {\n  name: string;\n  balance: number | null;\n  currency_code: string | null;\n  orig_balance: number | null;\n  fx_unavailable: boolean;\n}\n\ntype PortfolioQueryRoot = Document | HTMLElement;\n\ntype PortfolioPositionsSortKey =\n  | 'name'\n  | 'current_holdings'\n  | 'purchase_value'\n  | 'current_value'\n  | 'gain_abs'\n  | 'gain_pct';\n\ntype PortfolioSortDirection = 'asc' | 'desc';\n\nconst PORTFOLIO_SORT_KEYS: readonly PortfolioPositionsSortKey[] = [\n  'name',\n  'current_holdings',\n  'purchase_value',\n  'current_value',\n  'gain_abs',\n  'gain_pct',\n];\n\nfunction isPortfolioPositionsSortKey(\n  value: string | null | undefined,\n): value is PortfolioPositionsSortKey {\n  return PORTFOLIO_SORT_KEYS.includes(value as PortfolioPositionsSortKey);\n}\n\nfunction isPortfolioSortDirection(\n  value: string | null | undefined,\n): value is PortfolioSortDirection {\n  return value === 'asc' || value === 'desc';\n}\n\n// === Modul-weiter State für Expand/Collapse & Lazy Load ===\n// On-Demand Aggregation liefert frische Portfolio-Werte; nur Positionen bleiben Lazy-Loaded.\nlet _hassRef: HomeAssistant | null = null;\nlet _panelConfigRef: PanelConfigLike | null = null;\nconst portfolioPositionsCache: PortfolioPositionsCache = new Map();      // portfolio_uuid -> positions[]\n\n// --- Security-Aggregation für Detail-Ansicht ---\nconst HOLDINGS_PRECISION = 1e6;\n\nfunction toFiniteNumber(value: unknown): number {\n  const num = Number(value);\n  return Number.isFinite(num) ? num : 0;\n}\n\nfunction roundCurrency(value: unknown): number {\n  const finite = toFiniteNumber(value);\n  return Math.round(finite * 100) / 100;\n}\n\nfunction roundHoldings(value: unknown): number {\n  const finite = toFiniteNumber(value);\n  return Math.round(finite * HOLDINGS_PRECISION) / HOLDINGS_PRECISION;\n}\n\nfunction collectSecurityPositions(securityUuid: string | null | undefined): PortfolioPositionLike[] {\n  if (!securityUuid) {\n    return [];\n  }\n\n  const matches: PortfolioPositionLike[] = [];\n  for (const positions of portfolioPositionsCache.values()) {\n    if (!Array.isArray(positions) || positions.length === 0) {\n      continue;\n    }\n    for (const pos of positions) {\n      const posUuid = typeof pos?.security_uuid === 'string' ? pos.security_uuid : null;\n      if (pos && posUuid === securityUuid) {\n        matches.push(pos);\n      }\n    }\n  }\n  return matches;\n}\n\nexport function getSecurityPositionsFromCache(securityUuid: string | null | undefined): PortfolioPositionLike[] {\n  const positions = collectSecurityPositions(securityUuid);\n  if (!positions.length) {\n    return [];\n  }\n  return positions.map((pos) => ({ ...pos }));\n}\n\nexport function getSecuritySnapshotFromCache(securityUuid: string | null | undefined): SecuritySnapshotLike | null {\n  const positions = collectSecurityPositions(securityUuid);\n  if (!positions.length || !securityUuid) {\n    return null;\n  }\n\n  let name = '';\n  let totalHoldings = 0;\n  let totalPurchaseValue = 0;\n  let totalCurrentValue = 0;\n\n  for (const pos of positions) {\n    const posName = pos?.name;\n    if (!name && typeof posName === 'string') {\n      name = posName;\n    }\n    totalHoldings += toFiniteNumber(pos?.current_holdings);\n    totalPurchaseValue += toFiniteNumber(pos?.purchase_value);\n    totalCurrentValue += toFiniteNumber(pos?.current_value);\n  }\n\n  const gainAbs = totalCurrentValue - totalPurchaseValue;\n  const gainPct = totalPurchaseValue > 0\n    ? (gainAbs / totalPurchaseValue) * 100\n    : 0;\n  const lastPriceEur = totalHoldings > 0 ? totalCurrentValue / totalHoldings : null;\n\n  return {\n    security_uuid: securityUuid,\n    name,\n    total_holdings: roundHoldings(totalHoldings),\n    purchase_value_eur: roundCurrency(totalPurchaseValue),\n    current_value_eur: roundCurrency(totalCurrentValue),\n    gain_abs_eur: roundCurrency(gainAbs),\n    gain_pct: Math.round(gainPct * 100) / 100,\n    last_price_eur: lastPriceEur != null ? roundCurrency(lastPriceEur) : null,\n    source: 'cache',\n  };\n}\n\n// Global für Push-Handler (Events); hält ausschließlich Positionsdaten für Lazy-Loads\nportfolioPositionsCache.getSecuritySnapshot = getSecuritySnapshotFromCache;\nportfolioPositionsCache.getSecurityPositions = getSecurityPositionsFromCache;\n\nwindow.__ppReaderPortfolioPositionsCache = portfolioPositionsCache;\nif (!window.__ppReaderGetSecuritySnapshotFromCache) {\n  window.__ppReaderGetSecuritySnapshotFromCache = getSecuritySnapshotFromCache;\n}\nif (!window.__ppReaderGetSecurityPositionsFromCache) {\n  window.__ppReaderGetSecurityPositionsFromCache = getSecurityPositionsFromCache;\n}\nconst expandedPortfolios = new Set<string>();           // gemerkte geöffnete Depots (persistiert über Re-Renders)\n\n// ENTFERNT: Globaler document-Listener (Section 6 Hardening)\n// Stattdessen scoped Listener über attachPortfolioToggleHandler(root)\n\n// Rendert die Positions-Tabelle für ein Depot\nfunction applyGainPctMetadata(tableEl: HTMLTableElement | null | undefined): void {\n  if (!tableEl) {\n    return;\n  }\n  const bodyRows = Array.from(tableEl.querySelectorAll<HTMLTableRowElement>('tbody tr'));\n  bodyRows.forEach(row => {\n    const gainAbsCell = row.cells?.[4] ?? null;\n    const gainPctCell = row.cells?.[5] ?? null;\n    if (!gainAbsCell || !gainPctCell) {\n      return;\n    }\n    const pctText = (gainPctCell.textContent || '').trim() || '—';\n    let pctSign: 'positive' | 'negative' | 'neutral' = 'neutral';\n    if (gainPctCell.querySelector('.positive')) {\n      pctSign = 'positive';\n    } else if (gainPctCell.querySelector('.negative')) {\n      pctSign = 'negative';\n    }\n    gainAbsCell.dataset.gainPct = pctText;\n    gainAbsCell.dataset.gainSign = pctSign;\n  });\n}\n\nif (!window.__ppReaderApplyGainPctMetadata) {\n  window.__ppReaderApplyGainPctMetadata = (tableEl: HTMLTableElement) => applyGainPctMetadata(tableEl);\n}\n\nfunction renderPositionsTable(positions: readonly PortfolioPositionLike[]): string {\n  if (!positions || positions.length === 0) {\n    return '<div class=\"no-positions\">Keine Positionen vorhanden.</div>';\n  }\n  // Mapping für makeTable\n  const cols = [\n    { key: 'name', label: 'Wertpapier' },\n    { key: 'current_holdings', label: 'Bestand', align: 'right' as const },\n    { key: 'purchase_value', label: 'Kaufwert', align: 'right' as const },\n    { key: 'current_value', label: 'Aktueller Wert', align: 'right' as const },\n    { key: 'gain_abs', label: '+/-', align: 'right' as const },\n    { key: 'gain_pct', label: '%', align: 'right' as const }\n  ];\n  const rows = positions.map(p => ({\n    name: typeof p.name === 'string' ? p.name : p.name != null ? String(p.name) : '',\n    current_holdings: typeof p.current_holdings === 'number' || typeof p.current_holdings === 'string'\n      ? p.current_holdings\n      : null,\n    purchase_value: typeof p.purchase_value === 'number' || typeof p.purchase_value === 'string'\n      ? p.purchase_value\n      : null,\n    current_value: typeof p.current_value === 'number' || typeof p.current_value === 'string'\n      ? p.current_value\n      : null,\n    gain_abs: typeof p.gain_abs === 'number' || typeof p.gain_abs === 'string'\n      ? p.gain_abs\n      : null,\n    gain_pct: typeof p.gain_pct === 'number' || typeof p.gain_pct === 'string'\n      ? p.gain_pct\n      : null,\n  }));\n\n  // Basis-HTML über makeTable erzeugen\n  const raw = makeTable(rows, cols, ['purchase_value', 'current_value', 'gain_abs']);\n\n  // Header um data-sort-key ergänzen + sortable Klasse setzen\n  try {\n    const tpl = document.createElement('template');\n    tpl.innerHTML = raw.trim();\n    const table = tpl.content.querySelector<HTMLTableElement>('table');\n    if (table) {\n      table.classList.add('sortable-positions');\n      const ths = table.querySelectorAll('thead th');\n      cols.forEach((c, i) => {\n        const th = ths[i];\n        if (th) {\n          th.setAttribute('data-sort-key', c.key);\n          th.classList.add('sortable-col');\n        }\n      });\n      const bodyRows = table.querySelectorAll<HTMLTableRowElement>('tbody tr');\n      bodyRows.forEach((tr, idx) => {\n        if (tr.classList.contains('footer-row')) {\n          return;\n        }\n        const pos = positions[idx];\n        if (!pos) {\n          return;\n        }\n        const securityUuid = typeof pos.security_uuid === 'string' ? pos.security_uuid : null;\n        if (securityUuid) {\n          tr.dataset.security = securityUuid;\n        }\n        tr.classList.add('position-row');\n      });\n      // Default-Sortierung (nach Name asc) – bereits durch SQL geliefert, aber markieren\n      table.dataset.defaultSort = 'name';\n      table.dataset.defaultDir = 'asc';\n      applyGainPctMetadata(table);\n      return table.outerHTML;\n    }\n  } catch (e) {\n    // Fallback: unverändertes Markup\n    console.warn(\"renderPositionsTable: Konnte Sortier-Metadaten nicht injizieren:\", e);\n  }\n  return raw;\n}\n\n// NEU: Export / Global bereitstellen für Push-Handler (Konsistenz Push vs Lazy)\nexport function renderPortfolioPositions(positions: readonly PortfolioPositionLike[]): string {\n  return renderPositionsTable(positions);\n}\nwindow.__ppReaderRenderPositionsTable = renderPositionsTable;\n\nfunction attachSecurityDetailDelegation(root: PortfolioQueryRoot, portfolioUuid: string): void {\n  if (!portfolioUuid) return;\n  const detailsRow = root.querySelector<HTMLTableRowElement>(\n    `.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`,\n  );\n  if (!detailsRow) return;\n  const container = detailsRow.querySelector<HTMLElement>('.positions-container');\n  if (!container || container.__ppReaderSecurityClickBound) return;\n\n  container.__ppReaderSecurityClickBound = true;\n\n  container.addEventListener('click', (event: MouseEvent) => {\n    const target = event.target;\n    if (!(target instanceof Element)) {\n      return;\n    }\n\n    const interactive = target.closest('button, a');\n    if (interactive && container.contains(interactive)) {\n      return;\n    }\n\n    const row = target.closest<HTMLTableRowElement>('tr[data-security]');\n    if (!row || !container.contains(row)) {\n      return;\n    }\n\n    const securityUuid = row.getAttribute('data-security');\n    if (!securityUuid) {\n      return;\n    }\n\n    try {\n      const opened = openSecurityDetail(securityUuid);\n      if (!opened) {\n        console.warn('attachSecurityDetailDelegation: Detail-Tab konnte nicht geöffnet werden für', securityUuid);\n      }\n    } catch (err) {\n      console.error('attachSecurityDetailDelegation: Fehler beim Öffnen des Detail-Tabs', err);\n    }\n  });\n}\n\nexport function attachSecurityDetailListener(root: PortfolioQueryRoot, portfolioUuid: string): void {\n  attachSecurityDetailDelegation(root, portfolioUuid);\n}\n\nif (!window.__ppReaderAttachSecurityDetailListener) {\n  window.__ppReaderAttachSecurityDetailListener = attachSecurityDetailListener;\n}\n\n// (1) Entferne evtl. doppelte frühere Definitionen von buildExpandablePortfolioTable – nur diese Version behalten\nfunction buildExpandablePortfolioTable(depots: readonly PortfolioOverviewDepot[]): string {\n  console.debug('buildExpandablePortfolioTable: render', depots.length, 'portfolios');\n  const escapeAttribute = (value: unknown): string => {\n    if (value == null) {\n      return '';\n    }\n    return String(value)\n      .replace(/&/g, '&amp;')\n      .replace(/\"/g, '&quot;');\n  };\n\n  let html = '<table class=\"expandable-portfolio-table\"><thead><tr>';\n  const cols = [\n    { key: 'name', label: 'Name' },\n    { key: 'position_count', label: 'Anzahl Positionen', align: 'right' },\n    { key: 'current_value', label: 'Aktueller Wert', align: 'right' },\n    { key: 'gain_abs', label: 'Gesamt +/-', align: 'right' },\n    { key: 'gain_pct', label: '%', align: 'right' }\n  ];\n  cols.forEach(c => {\n    const align = c.align === 'right' ? ' class=\"align-right\"' : '';\n    html += `<th${align}>${c.label}</th>`;\n  });\n  html += '</tr></thead><tbody>';\n\n  depots.forEach(d => {\n    if (!d || !d.uuid) return;\n    const positionCount = Number.isFinite(d.position_count) ? d.position_count : 0;\n    const purchaseSum = Number.isFinite(d.purchase_sum) ? d.purchase_sum : 0;\n    const hasValue = d.hasValue !== false;\n    const currentValue = hasValue && typeof d.current_value === 'number' && Number.isFinite(d.current_value)\n      ? d.current_value\n      : null;\n    const gainAbs = hasValue && typeof d.gain_abs === 'number' && Number.isFinite(d.gain_abs)\n      ? d.gain_abs\n      : (hasValue && typeof d.current_value === 'number' && Number.isFinite(d.current_value)\n        ? d.current_value - purchaseSum\n        : null);\n    const gainPct = hasValue && typeof d.gain_pct === 'number' && Number.isFinite(d.gain_pct)\n      ? d.gain_pct\n      : (hasValue && purchaseSum > 0 && typeof currentValue === 'number'\n        ? ((currentValue - purchaseSum) / purchaseSum) * 100\n        : null);\n\n    const expanded = expandedPortfolios.has(d.uuid);\n    const toggleClass = expanded ? 'portfolio-toggle expanded' : 'portfolio-toggle';\n    const detailId = `portfolio-details-${d.uuid}`;\n    const rowData = {\n      fx_unavailable: !hasValue,\n      current_value: currentValue,\n      gain_abs: gainAbs,\n      gain_pct: gainPct\n    };\n    const valueContext = { hasValue };\n    const currentValueCell = formatValue('current_value', rowData.current_value, rowData, valueContext);\n    const gainAbsCell = formatValue('gain_abs', rowData.gain_abs, rowData, valueContext);\n    const gainPctCell = formatValue('gain_pct', rowData.gain_pct, rowData, valueContext);\n\n    const gainPctLabel = hasValue && typeof gainPct === 'number' && Number.isFinite(gainPct)\n      ? `${formatNumber(gainPct)} %`\n      : '';\n    const gainPctSign = hasValue && typeof gainPct === 'number' && Number.isFinite(gainPct)\n      ? (gainPct > 0 ? 'positive' : gainPct < 0 ? 'negative' : 'neutral')\n      : '';\n\n    const datasetCurrentValue = hasValue && typeof currentValue === 'number' && Number.isFinite(currentValue) ? currentValue : '';\n    const datasetGainAbs = hasValue && typeof gainAbs === 'number' && Number.isFinite(gainAbs) ? gainAbs : '';\n    const datasetGainPct = hasValue && typeof gainPct === 'number' && Number.isFinite(gainPct) ? gainPct : '';\n\n    let gainAbsAttributes = '';\n    if (gainPctLabel) {\n      gainAbsAttributes = ` data-gain-pct=\"${escapeAttribute(gainPctLabel)}\" data-gain-sign=\"${escapeAttribute(gainPctSign)}\"`;\n    }\n\n    html += `<tr class=\"portfolio-row\"\n                data-portfolio=\"${d.uuid}\"\n                data-position-count=\"${positionCount}\"\n                data-current-value=\"${escapeAttribute(datasetCurrentValue)}\"\n                data-purchase-sum=\"${escapeAttribute(purchaseSum)}\"\n                data-gain-abs=\"${escapeAttribute(datasetGainAbs)}\"\n                data-gain-pct=\"${escapeAttribute(datasetGainPct)}\"\n                data-has-value=\"${hasValue ? 'true' : 'false'}\">`;\n    html += `<td>\n        <button type=\"button\"\n                class=\"${toggleClass}\"\n                data-portfolio=\"${d.uuid}\"\n                aria-expanded=\"${expanded ? 'true' : 'false'}\"\n                aria-controls=\"${detailId}\">\n          <span class=\"caret\">${expanded ? '▼' : '▶'}</span>\n          <span class=\"portfolio-name\">${d.name}</span>\n        </button>\n      </td>`;\n    html += `<td class=\"align-right\">${positionCount}</td>`;\n    html += `<td class=\"align-right\">${currentValueCell}</td>`;\n    html += `<td class=\"align-right\"${gainAbsAttributes}>${gainAbsCell}</td>`;\n    html += `<td class=\"align-right gain-pct-cell\">${gainPctCell}</td>`;\n    html += '</tr>';\n\n    html += `<tr class=\"portfolio-details${expanded ? '' : ' hidden'}\"\n                data-portfolio=\"${d.uuid}\"\n                id=\"${detailId}\"\n                role=\"region\"\n                aria-label=\"Positionen für ${d.name}\">\n      <td colspan=\"5\">\n        <div class=\"positions-container\">${expanded\n        ? (portfolioPositionsCache.has(d.uuid)\n          ? renderPositionsTable(portfolioPositionsCache.get(d.uuid) ?? [])\n          : '<div class=\\\"loading\\\">Lade Positionen...</div>')\n        : ''\n      }</div>\n      </td>\n    </tr>`;\n  });\n\n  const availableDepots = depots.filter(d => d && d.hasValue !== false);\n  const sumPositions = depots.reduce((a, d) => a + (Number.isFinite(d?.position_count) ? d.position_count : 0), 0);\n  const sumCurrent = availableDepots.reduce((a, d) => {\n    if (typeof d.current_value === 'number' && Number.isFinite(d.current_value)) {\n      return a + d.current_value;\n    }\n    return a;\n  }, 0);\n  const sumPurchase = availableDepots.reduce((a, d) => {\n    if (typeof d.purchase_sum === 'number' && Number.isFinite(d.purchase_sum)) {\n      return a + d.purchase_sum;\n    }\n    return a;\n  }, 0);\n  const sumGainAbs = availableDepots.reduce((a, d) => {\n    const current = typeof d.current_value === 'number' && Number.isFinite(d.current_value) ? d.current_value : 0;\n    const purchase = typeof d.purchase_sum === 'number' && Number.isFinite(d.purchase_sum) ? d.purchase_sum : 0;\n    return a + (current - purchase);\n  }, 0);\n  const sumHasValue = availableDepots.length === depots.length;\n  const sumGainPct = sumHasValue && sumPurchase > 0 ? (sumGainAbs / sumPurchase) * 100 : null;\n\n  const sumRowData = {\n    fx_unavailable: !sumHasValue,\n    current_value: sumHasValue ? sumCurrent : null,\n    gain_abs: sumHasValue ? sumGainAbs : null,\n    gain_pct: sumHasValue ? sumGainPct : null\n  };\n  const sumContext = { hasValue: sumHasValue };\n  const sumCurrentCell = formatValue('current_value', sumRowData.current_value, sumRowData, sumContext);\n  const sumGainAbsCell = formatValue('gain_abs', sumRowData.gain_abs, sumRowData, sumContext);\n  const sumGainPctCell = formatValue('gain_pct', sumRowData.gain_pct, sumRowData, sumContext);\n\n  let sumGainAbsAttributes = '';\n  if (sumHasValue && typeof sumGainPct === 'number' && Number.isFinite(sumGainPct)) {\n    const sumGainPctLabel = `${formatNumber(sumGainPct)} %`;\n    const sumGainPctSign = sumGainPct > 0 ? 'positive' : sumGainPct < 0 ? 'negative' : 'neutral';\n    sumGainAbsAttributes = ` data-gain-pct=\"${escapeAttribute(sumGainPctLabel)}\" data-gain-sign=\"${escapeAttribute(sumGainPctSign)}\"`;\n  }\n\n  html += `<tr class=\"footer-row\"\n    data-position-count=\"${sumPositions}\"\n    data-current-value=\"${escapeAttribute(sumHasValue ? sumCurrent : '')}\"\n    data-purchase-sum=\"${escapeAttribute(sumHasValue ? sumPurchase : '')}\"\n    data-gain-abs=\"${escapeAttribute(sumHasValue ? sumGainAbs : '')}\"\n    data-gain-pct=\"${escapeAttribute(sumHasValue && typeof sumGainPct === 'number' && Number.isFinite(sumGainPct) ? sumGainPct : '')}\"\n    data-has-value=\"${sumHasValue ? 'true' : 'false'}\">\n    <td>Summe</td>\n    <td class=\"align-right\">${Math.round(sumPositions).toLocaleString('de-DE')}</td>\n    <td class=\"align-right\">${sumCurrentCell}</td>\n    <td class=\"align-right\"${sumGainAbsAttributes}>${sumGainAbsCell}</td>\n    <td class=\"align-right gain-pct-cell\">${sumGainPctCell}</td>\n  </tr>`;\n\n  html += '</tbody></table>';\n  return html;\n}\n\nfunction resolvePortfolioTable(target: Element | PortfolioQueryRoot | null | undefined): HTMLTableElement | null {\n  if (target instanceof HTMLTableElement) {\n    return target;\n  }\n  if (target && 'querySelector' in target) {\n    const scoped = (target as ParentNode).querySelector<HTMLTableElement>('table.expandable-portfolio-table');\n    if (scoped) {\n      return scoped;\n    }\n    const nested = (target as ParentNode).querySelector<HTMLTableElement>('.portfolio-table table');\n    if (nested) {\n      return nested;\n    }\n    const generic = (target as ParentNode).querySelector<HTMLTableElement>('table');\n    if (generic) {\n      return generic;\n    }\n  }\n  return document.querySelector<HTMLTableElement>('.portfolio-table table.expandable-portfolio-table') ||\n    document.querySelector<HTMLTableElement>('.portfolio-table table');\n}\n\nfunction readDatasetNumber(value: string | undefined): number | null {\n  if (value === undefined) {\n    return null;\n  }\n  const num = Number(value);\n  return Number.isFinite(num) ? num : null;\n}\n\nfunction extractNumericFromCell(cell: HTMLTableCellElement | null | undefined): number {\n  if (!cell) {\n    return 0;\n  }\n  const raw = cell.textContent || '';\n  if (!raw) {\n    return 0;\n  }\n  const cleaned = raw\n    .replace(/[^0-9,.-]/g, '')\n    .replace(/\\./g, '')\n    .replace(',', '.');\n  const parsed = Number.parseFloat(cleaned);\n  return Number.isFinite(parsed) ? parsed : 0;\n}\n\nexport function updatePortfolioFooterFromDom(target: Element | PortfolioQueryRoot | null | undefined): void {\n  const table = resolvePortfolioTable(target);\n  if (!table) {\n    return;\n  }\n  const tbody = table.tBodies?.[0];\n  if (!tbody) {\n    return;\n  }\n  const rows = Array.from(tbody.querySelectorAll<HTMLTableRowElement>('tr.portfolio-row'));\n  if (!rows.length) {\n    return;\n  }\n\n  let sumPositions = 0;\n  let sumCurrent = 0;\n  let sumPurchase = 0;\n  let sumGainAbs = 0;\n  let missingRows = 0;\n\n  for (const row of rows) {\n    const hasValueAttr = row.dataset.hasValue;\n    const hasValue = !(hasValueAttr === 'false' || hasValueAttr === '0' || hasValueAttr === '' || hasValueAttr == null);\n    const posCount = readDatasetNumber(row.dataset.positionCount) ?? extractNumericFromCell(row.cells.item(1));\n    sumPositions += posCount;\n\n    if (!hasValue) {\n      missingRows += 1;\n      continue;\n    }\n\n    const currentValue = readDatasetNumber(row.dataset.currentValue) ?? extractNumericFromCell(row.cells.item(2));\n    const gainAbs = readDatasetNumber(row.dataset.gainAbs) ?? extractNumericFromCell(row.cells.item(3));\n    const purchaseSumDataset = readDatasetNumber(row.dataset.purchaseSum);\n    const purchaseSum = purchaseSumDataset != null ? purchaseSumDataset : (currentValue - gainAbs);\n\n    sumCurrent += currentValue;\n    sumGainAbs += gainAbs;\n    sumPurchase += purchaseSum;\n  }\n\n  const sumHasValue = missingRows === 0;\n  if (!sumHasValue && sumPurchase > 0) {\n    sumPurchase = sumCurrent - sumGainAbs;\n  }\n  if (sumHasValue && sumPurchase <= 0) {\n    sumPurchase = sumCurrent - sumGainAbs;\n  }\n\n  const sumGainPct = sumHasValue && sumPurchase > 0 ? (sumGainAbs / sumPurchase) * 100 : null;\n\n  let footer = Array.from(tbody.children).find((child): child is HTMLTableRowElement =>\n    child instanceof HTMLTableRowElement && child.classList.contains('footer-row')\n  );\n  if (!footer) {\n    footer = document.createElement('tr');\n    footer.classList.add('footer-row');\n    tbody.appendChild(footer);\n  }\n\n  const sumPositionsDisplay = Math.round(sumPositions).toLocaleString('de-DE');\n\n  const renderMissingValue = (reason = 'Wert nicht verfügbar') =>\n    `<span class=\"missing-value\" role=\"note\" aria-label=\"${reason}\" title=\"${reason}\">—</span>`;\n  const missingReason = 'Teilweise fehlende Wechselkurse – Wert unbekannt';\n\n  const currentValueHtml = sumHasValue\n    ? `${formatNumber(sumCurrent)}&nbsp;€`\n    : renderMissingValue(missingReason);\n  const gainAbsHtml = sumHasValue\n    ? formatGain(sumGainAbs)\n    : renderMissingValue(missingReason);\n  const gainPctHtml = sumHasValue && sumGainPct != null\n    ? formatGainPct(sumGainPct)\n    : renderMissingValue(missingReason);\n\n  footer.innerHTML = `\n    <td>Summe</td>\n    <td class=\"align-right\">${sumPositionsDisplay}</td>\n    <td class=\"align-right\">${currentValueHtml}</td>\n    <td class=\"align-right\">${gainAbsHtml}</td>\n    <td class=\"align-right\">${gainPctHtml}</td>\n  `;\n  footer.dataset.positionCount = String(Math.round(sumPositions));\n  footer.dataset.currentValue = sumHasValue ? String(sumCurrent) : '';\n  footer.dataset.purchaseSum = sumHasValue ? String(sumPurchase) : '';\n  footer.dataset.gainAbs = sumHasValue ? String(sumGainAbs) : '';\n  footer.dataset.gainPct = sumHasValue && typeof sumGainPct === 'number' ? String(sumGainPct) : '';\n  footer.dataset.hasValue = sumHasValue ? 'true' : 'false';\n}\nwindow.__ppReaderUpdatePortfolioFooter = updatePortfolioFooterFromDom;\n\n/**\n * Utility-Funktionen zum Auslesen und Wiederherstellen des Expand-States.\n * Perspektivisch nutzbar, falls ein vollständiger Neu-Render (Hard Refresh) der\n * Depot-Tabelle nötig wird (z.B. beim späteren Hinzufügen von Filter-/Sortierlogik).\n */\nexport function getExpandedPortfolios(): string[] {\n  // Primär DOM lesen (falls Tabelle gerendert), Fallback: interner Set\n  const domRows = Array.from(\n    document.querySelectorAll<HTMLTableRowElement>('.portfolio-details:not(.hidden)[data-portfolio]'),\n  );\n  if (domRows.length) {\n    return domRows\n      .map((row) => row.getAttribute('data-portfolio'))\n      .filter((value): value is string => Boolean(value));\n  }\n  return Array.from(expandedPortfolios.values());\n}\n\nexport function setExpandedPortfolios(portfolioIds: Array<string | null | undefined> | null | undefined): void {\n  expandedPortfolios.clear();\n  if (Array.isArray(portfolioIds)) {\n    portfolioIds.forEach(id => {\n      if (id) {\n        expandedPortfolios.add(id);\n      }\n    });\n  }\n}\n\n// NEU: Helper zum Anhängen der Sortier-Logik an eine Positions-Tabelle eines bestimmten Portfolios\nexport function attachPortfolioPositionsSorting(root: PortfolioQueryRoot, portfolioUuid: string): void {\n  if (!portfolioUuid) return;\n  const detailsRow = root.querySelector<HTMLTableRowElement>(\n    `.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`,\n  );\n  if (!detailsRow) return;\n  const container = detailsRow.querySelector<HTMLElement>('.positions-container');\n  if (!container) return;\n  const table = container.querySelector<HTMLTableElement>('table.sortable-positions');\n  if (!table || table.__ppReaderSortingBound) return;\n\n  table.__ppReaderSortingBound = true;\n\n  const applySort = (\n    key: PortfolioPositionsSortKey,\n    dir: PortfolioSortDirection,\n  ): void => {\n    const tbody = table.querySelector<HTMLTableSectionElement>('tbody');\n    if (!tbody) return;\n    const rows = Array.from(tbody.querySelectorAll<HTMLTableRowElement>('tr'))\n      .filter(r => !r.classList.contains('footer-row'));\n    const footer = tbody.querySelector<HTMLTableRowElement>('tr.footer-row');\n\n    const parseNum = (txt: string | null | undefined): number => {\n      if (txt == null) return 0;\n      // Entferne Währungs-/Prozent-Symbole, geschützte Leerzeichen\n      const cleaned = txt\n        .replace(/\\u00A0/g, ' ')\n        .replace(/[%€]/g, '')\n        .replace(/\\./g, '')\n        .replace(',', '.')\n        .replace(/[^\\d.-]/g, '');\n      const numeric = Number.parseFloat(cleaned);\n      return Number.isFinite(numeric) ? numeric : 0;\n    };\n\n    rows.sort((a, b) => {\n      const idxMap: Record<PortfolioPositionsSortKey, number> = {\n        name: 0,\n        current_holdings: 1,\n        purchase_value: 2,\n        current_value: 3,\n        gain_abs: 4,\n        gain_pct: 5,\n      };\n      const colIdx = idxMap[key];\n      if (colIdx == null) return 0;\n      const aCell = a.cells[colIdx]?.textContent?.trim() ?? '';\n      const bCell = b.cells[colIdx]?.textContent?.trim() ?? '';\n\n      let comp: number;\n      if (key === 'name') {\n        comp = aCell.localeCompare(bCell, 'de', { sensitivity: 'base' });\n      } else {\n        comp = parseNum(aCell) - parseNum(bCell);\n      }\n      return dir === 'asc' ? comp : -comp;\n    });\n\n    // Visuelle Indikatoren zurücksetzen\n    table.querySelectorAll('thead th.sort-active').forEach(th => {\n      th.classList.remove('sort-active', 'dir-asc', 'dir-desc');\n    });\n\n    // Aktives TH markieren\n    const th = table.querySelector<HTMLElement>(`thead th[data-sort-key=\"${key}\"]`);\n    if (th) {\n      th.classList.add('sort-active', dir === 'asc' ? 'dir-asc' : 'dir-desc');\n    }\n\n    // Neu einfügen\n    rows.forEach(r => tbody.appendChild(r));\n    if (footer) tbody.appendChild(footer);\n  };\n\n  // Initial ggf. gespeicherten Zustand anwenden\n  const containerKey = container.dataset.sortKey;\n  const containerDir = container.dataset.sortDir;\n  const defaultKey = table.dataset.defaultSort;\n  const defaultDir = table.dataset.defaultDir;\n\n  const currentKey = isPortfolioPositionsSortKey(containerKey)\n    ? containerKey\n    : isPortfolioPositionsSortKey(defaultKey)\n      ? defaultKey\n      : 'name';\n  const currentDir = isPortfolioSortDirection(containerDir)\n    ? containerDir\n    : isPortfolioSortDirection(defaultDir)\n      ? defaultDir\n      : 'asc';\n\n  applySort(currentKey, currentDir);\n\n  table.addEventListener('click', (event: MouseEvent) => {\n    const target = event.target;\n    if (!(target instanceof Element)) {\n      return;\n    }\n    const th = target.closest('th[data-sort-key]');\n    if (!th || !table.contains(th)) return;\n    const keyAttr = th.getAttribute('data-sort-key');\n    if (!isPortfolioPositionsSortKey(keyAttr)) {\n      return;\n    }\n\n    let dir: PortfolioSortDirection = 'asc';\n    if (container.dataset.sortKey === keyAttr) {\n      const existing = isPortfolioSortDirection(container.dataset.sortDir)\n        ? container.dataset.sortDir\n        : 'asc';\n      dir = existing === 'asc' ? 'desc' : 'asc';\n    }\n    container.dataset.sortKey = keyAttr;\n    container.dataset.sortDir = dir;\n    applySort(keyAttr, dir);\n  });\n}\n\n// Exponiere zentrale Sortier-Funktion global für Push-Handler (Race-frei wiederverwendbar)\nif (!window.__ppReaderAttachPortfolioPositionsSorting) {\n  window.__ppReaderAttachPortfolioPositionsSorting = attachPortfolioPositionsSorting;\n}\n\n// NEU: Funktion zum erneuten Laden der Positionsdaten\nasync function reloadPortfolioPositions(\n  portfolioUuid: string,\n  containerEl: HTMLElement | null | undefined,\n  root: HTMLElement,\n): Promise<void> {\n  if (!portfolioUuid || !_hassRef || !_panelConfigRef) return;\n\n  const targetContainer = containerEl || root.querySelector<HTMLElement>(\n    `.portfolio-details[data-portfolio=\"${portfolioUuid}\"] .positions-container`\n  );\n  if (!targetContainer) {\n    return;\n  }\n\n  const detailsRow = targetContainer.closest<HTMLTableRowElement>('.portfolio-details');\n  if (detailsRow && detailsRow.classList.contains('hidden')) {\n    return; // Hidden Rows sollen keinen Silent-Preload anstoßen\n  }\n\n  targetContainer.innerHTML = '<div class=\"loading\">Neu laden...</div>';\n  try {\n    const resp: PortfolioPositionsResponse = await fetchPortfolioPositionsWS(\n      _hassRef,\n      _panelConfigRef,\n      portfolioUuid,\n    );\n    if (resp.error) {\n      const errorText = typeof resp.error === 'string' ? resp.error : String(resp.error);\n      targetContainer.innerHTML = `<div class=\"error\">${errorText} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n      return;\n    }\n    const positions = resp.positions ?? [];\n    portfolioPositionsCache.set(portfolioUuid, positions);\n    targetContainer.innerHTML = renderPositionsTable(positions);\n    // Änderung 11: Nach erstmaligem Lazy-Load Sortierung initialisieren\n    try {\n      attachPortfolioPositionsSorting(root, portfolioUuid);\n    } catch (error) {\n      console.warn('attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:', error);\n    }\n    try {\n      attachSecurityDetailListener(root, portfolioUuid);\n    } catch (error) {\n      console.warn('reloadPortfolioPositions: Security-Listener konnte nicht gebunden werden:', error);\n    }\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    targetContainer.innerHTML = `<div class=\"error\">Fehler: ${message} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Retry</button></div>`;\n  }\n}\n\n// Hilfsfunktion: wartet bis ein Selektor im root existiert\nasync function waitForElement<T extends Element>(\n  root: HTMLElement,\n  selector: string,\n  timeoutMs = 3000,\n  intervalMs = 50,\n): Promise<T | null> {\n  const start = performance.now();\n  return new Promise((resolve) => {\n    const tick = () => {\n      const el = root.querySelector<T>(selector);\n      if (el) return resolve(el);\n      if (performance.now() - start > timeoutMs) return resolve(null);\n      setTimeout(tick, intervalMs);\n    };\n    tick();\n  });\n}\n\nexport function attachPortfolioToggleHandler(root: HTMLElement): void {\n  if (!root) return;\n\n  const token = (root.__ppReaderAttachToken ?? 0) + 1;\n  root.__ppReaderAttachToken = token;\n  root.__ppReaderAttachInProgress = true;\n\n  (async () => {\n    try {\n      const container = await waitForElement<HTMLElement>(root, '.portfolio-table');\n      if (token !== root.__ppReaderAttachToken) {\n        return; // Ein neuer Versuch läuft bereits – diesen abbrechen\n      }\n      if (!container) {\n        console.warn(\"attachPortfolioToggleHandler: .portfolio-table nicht gefunden (Timeout)\");\n        return;\n      }\n\n      // Buttons generiert?\n      const btnCount = container.querySelectorAll('.portfolio-toggle').length;\n      if (btnCount === 0) {\n        console.debug(\"attachPortfolioToggleHandler: Noch keine Buttons – evtl. Recovery später\");\n      }\n\n      if (container.__ppReaderPortfolioToggleBound) {\n        return;\n      }\n      container.__ppReaderPortfolioToggleBound = true;\n      console.debug(\"attachPortfolioToggleHandler: Listener registriert\");\n\n      container.addEventListener('click', async (event: MouseEvent) => {\n        try {\n          const target = event.target;\n          if (!(target instanceof Element)) {\n            return;\n          }\n\n          const retryBtn = target.closest<HTMLButtonElement>('.retry-pos');\n          if (retryBtn && container.contains(retryBtn)) {\n            const pid = retryBtn.getAttribute('data-portfolio');\n            if (pid) {\n              const detailsRow = root.querySelector<HTMLTableRowElement>(\n                `.portfolio-details[data-portfolio=\"${pid}\"]`,\n              );\n              const cont = detailsRow?.querySelector<HTMLElement>('.positions-container');\n              await reloadPortfolioPositions(pid, cont ?? null, root);\n            }\n            return;\n          }\n\n          const btn = target.closest<HTMLButtonElement>('.portfolio-toggle');\n          if (!btn || !container.contains(btn)) return;\n\n          const portfolioUuid = btn.getAttribute('data-portfolio');\n          if (!portfolioUuid) return;\n\n          const detailsRow = root.querySelector<HTMLTableRowElement>(\n            `.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`,\n          );\n          if (!detailsRow) return;\n\n          const caretEl = btn.querySelector<HTMLElement>('.caret');\n          const isHidden = detailsRow.classList.contains('hidden');\n\n          if (isHidden) {\n            detailsRow.classList.remove('hidden');\n            btn.classList.add('expanded');\n            btn.setAttribute('aria-expanded', 'true');\n            if (caretEl) caretEl.textContent = '▼';\n            expandedPortfolios.add(portfolioUuid);\n\n            let pendingApplied = false;\n            try {\n              pendingApplied = flushPendingPositions(root, portfolioUuid);\n            } catch (error) {\n              console.warn('attachPortfolioToggleHandler: Pending-Flush fehlgeschlagen:', error);\n            }\n            if (!pendingApplied && window.__ppReaderFlushPendingPositions) {\n              try {\n                pendingApplied = window.__ppReaderFlushPendingPositions(root, portfolioUuid);\n              } catch (error) {\n                console.warn('attachPortfolioToggleHandler: Global Pending-Flush fehlgeschlagen:', error);\n              }\n            }\n\n            if (!portfolioPositionsCache.has(portfolioUuid)) {\n              const containerEl = detailsRow.querySelector<HTMLElement>('.positions-container');\n              if (containerEl) {\n                containerEl.innerHTML = '<div class=\"loading\">Lade Positionen...</div>';\n              }\n              try {\n                const resp: PortfolioPositionsResponse = await fetchPortfolioPositionsWS(\n                  _hassRef,\n                  _panelConfigRef,\n                  portfolioUuid,\n                );\n                if (resp.error) {\n                  const errorText = typeof resp.error === 'string' ? resp.error : String(resp.error);\n                  if (containerEl) {\n                    containerEl.innerHTML = `<div class=\"error\">${errorText} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n                  }\n                  return;\n                }\n                const positions = resp.positions ?? [];\n                portfolioPositionsCache.set(portfolioUuid, positions);\n                if (containerEl) {\n                  containerEl.innerHTML = renderPositionsTable(positions);\n                  // Änderung 11: Nach erstmaligem Lazy-Load Sortierung initialisieren\n                  try {\n                    attachPortfolioPositionsSorting(root, portfolioUuid);\n                  } catch (error) {\n                    console.warn('attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:', error);\n                  }\n                  try {\n                    attachSecurityDetailListener(root, portfolioUuid);\n                  } catch (error) {\n                    console.warn('attachPortfolioToggleHandler: Security-Listener konnte nicht gebunden werden:', error);\n                  }\n                }\n              } catch (error) {\n                const message = error instanceof Error ? error.message : String(error);\n                const containerEl = detailsRow.querySelector<HTMLElement>('.positions-container');\n                if (containerEl) {\n                  containerEl.innerHTML = `<div class=\"error\">Fehler beim Laden: ${message} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Retry</button></div>`;\n                }\n                console.error('Fehler beim Lazy Load für', portfolioUuid, error);\n              }\n            } else {\n              const containerEl = detailsRow.querySelector<HTMLElement>('.positions-container');\n              if (containerEl) {\n                containerEl.innerHTML = renderPositionsTable(\n                  portfolioPositionsCache.get(portfolioUuid) ?? [],\n                );\n                attachPortfolioPositionsSorting(root, portfolioUuid);\n                try {\n                  attachSecurityDetailListener(root, portfolioUuid);\n                } catch (error) {\n                  console.warn('attachPortfolioToggleHandler: Security-Listener (Cache) Fehler:', error);\n                }\n              }\n            }\n          } else {\n            detailsRow.classList.add('hidden');\n            btn.classList.remove('expanded');\n            btn.setAttribute('aria-expanded', 'false');\n            if (caretEl) caretEl.textContent = '▶';\n            expandedPortfolios.delete(portfolioUuid);\n          }\n        } catch (error) {\n          console.error('attachPortfolioToggleHandler: Ungefangener Fehler im Click-Handler', error);\n        }\n      });\n    } finally {\n      if (token === root.__ppReaderAttachToken) {\n        root.__ppReaderAttachInProgress = false;\n      }\n    }\n  })();\n}\n\n// Fallback: direkter Listener auf die Tabelle selbst (falls outer container nicht klickt)\nexport function ensurePortfolioRowFallbackListener(root: HTMLElement): void {\n  const table = root.querySelector<HTMLTableElement>('.expandable-portfolio-table');\n  if (!table) return;\n  if (table.__ppReaderPortfolioFallbackBound) return;\n  table.__ppReaderPortfolioFallbackBound = true;\n  table.addEventListener('click', (event: MouseEvent) => {\n    const target = event.target;\n    if (!(target instanceof Element)) {\n      return;\n    }\n    const btn = target.closest<HTMLButtonElement>('.portfolio-toggle');\n    if (!btn) return;\n    // Falls der Haupt-Listener schon aktiv war, nichts doppelt machen\n    const primaryContainer = root.querySelector<HTMLElement>('.portfolio-table');\n    if (primaryContainer?.__ppReaderPortfolioToggleBound) return;\n    console.debug('Fallback-Listener aktiv – re-attach Hauptlistener');\n    attachPortfolioToggleHandler(root);\n  });\n}\n\nexport async function renderDashboard(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n): Promise<string> {\n  _hassRef = hass ?? null;\n  _panelConfigRef = panelConfig ?? null;\n  console.debug(\n    'renderDashboard: start – panelConfig:',\n    panelConfig?.config,\n    'derived entry_id?',\n    panelConfig?.config?._panel_custom?.config?.entry_id,\n  );\n\n  const accountsResp = await fetchAccountsWS(hass, panelConfig);\n  const accounts = accountsResp?.accounts ?? [];\n  const normalizedAccounts: NormalizedAccountRow[] = accounts.map((account) => ({\n    name: account.name ?? '—',\n    balance: typeof account.balance === 'number' && Number.isFinite(account.balance)\n      ? account.balance\n      : null,\n    currency_code: account.currency_code ?? null,\n    orig_balance: typeof account.orig_balance === 'number' && Number.isFinite(account.orig_balance)\n      ? account.orig_balance\n      : null,\n    fx_unavailable: Boolean(account.fx_unavailable),\n  }));\n\n  const portfoliosResp = await fetchPortfoliosWS(hass, panelConfig);\n  const depots: PortfolioOverviewDepot[] = (portfoliosResp.portfolios ?? [])\n    .map((p): PortfolioOverviewDepot | null => {\n      const uuid = typeof p.uuid === 'string' && p.uuid ? p.uuid : null;\n      if (!uuid) {\n        return null;\n      }\n      const missingPositions = typeof (p as Record<string, unknown>).missing_value_positions === 'number'\n        ? (p as Record<string, unknown>).missing_value_positions as number\n        : 0;\n      const hasCurrentValue = p.has_current_value != null\n        ? Boolean(p.has_current_value)\n        : missingPositions === 0;\n      const baseCurrentValue = typeof p.current_value === 'number' ? p.current_value : 0;\n      const purchaseSum = typeof p.purchase_sum === 'number' ? p.purchase_sum : 0;\n      const currentValue = hasCurrentValue ? baseCurrentValue : null;\n      const gainAbs = hasCurrentValue ? baseCurrentValue - purchaseSum : null;\n      const gainPct = hasCurrentValue && purchaseSum > 0 && gainAbs != null\n        ? (gainAbs / purchaseSum) * 100\n        : null;\n\n      return {\n        uuid,\n        name: p.name ?? 'Unbenanntes Depot',\n        position_count: typeof p.position_count === 'number' ? p.position_count : 0,\n        current_value: currentValue,\n        purchase_sum: purchaseSum,\n        gain_abs: gainAbs,\n        gain_pct: gainPct,\n        hasValue: hasCurrentValue,\n        missing_value_positions: missingPositions,\n        fx_unavailable: !hasCurrentValue,\n      };\n    })\n    .filter((depot): depot is PortfolioOverviewDepot => depot !== null);\n\n  // 3. Last file update (optional – falls bereits WS-Command vorhanden)\n  let lastFileUpdate = '';\n  try {\n    lastFileUpdate = await fetchLastFileUpdateWS(hass, panelConfig);\n  } catch {\n    lastFileUpdate = '';\n  }\n\n  // 4. Gesamtvermögen berechnen (nur Anzeige)\n  const totalAccounts = normalizedAccounts.reduce(\n    (sum, account) => sum + (account.balance ?? 0),\n    0,\n  );\n  const anyPortfolioMissing = depots.some(depot => depot.hasValue === false);\n  const totalDepots = depots.reduce((sum, depot) => {\n    if (depot.hasValue && typeof depot.current_value === 'number' && Number.isFinite(depot.current_value)) {\n      return sum + depot.current_value;\n    }\n    return sum;\n  }, 0);\n  const totalWealth = totalAccounts + totalDepots;\n  const missingWealthReason = 'Teilweise fehlende Wechselkurse – Gesamtvermögen unbekannt';\n  const wealthValueMarkup = anyPortfolioMissing\n    ? `<span class=\"missing-value\" role=\"note\" aria-label=\"${missingWealthReason}\" title=\"${missingWealthReason}\">—</span>`\n    : `${formatNumber(totalWealth)}&nbsp;€`;\n  const wealthNote = anyPortfolioMissing\n    ? `<span class=\"total-wealth-note\">${missingWealthReason}</span>`\n    : '';\n\n  // 5. Header (ohne Last-File-Update – kommt jetzt wieder in Footer-Karte)\n  const headerMeta = `\n    <div class=\"header-meta-row\">\n      💰 Gesamtvermögen: <strong class=\"total-wealth-value\">${wealthValueMarkup}</strong>${wealthNote}\n    </div>\n  `;\n  const headerCard = createHeaderCard('Übersicht', headerMeta);\n\n  // 6. Sicherstellen, dass die Struktur exakt der erwartet wird:\n  //    - .portfolio-table (Wrapper)\n  //    - darin eine <table class=\"expandable-portfolio-table\"> mit <tr class=\"portfolio-row\" data-portfolio=\"UUID\">\n  const portfolioTableHtml = buildExpandablePortfolioTable(depots);\n\n  // 7. Konten-Tabellen\n  const eurAccounts = normalizedAccounts.filter(a => (a.currency_code ?? 'EUR') === 'EUR');\n  const fxAccounts = normalizedAccounts.filter(a => (a.currency_code ?? 'EUR') !== 'EUR');\n\n  const fxWarningNeeded = fxAccounts.some(a => a.fx_unavailable);\n  const fxWarning = fxWarningNeeded\n    ? `\n        <p class=\"table-note\" role=\"note\">\n          <span class=\"table-note__icon\" aria-hidden=\"true\">⚠️</span>\n          <span>Wechselkurse konnten nicht geladen werden. EUR-Werte werden derzeit nicht angezeigt.</span>\n        </p>\n      `\n    : '';\n\n  const accountsHtml = `\n    <div class=\"card\">\n      <h2>Liquidität</h2>\n      <div class=\"scroll-container account-table\">\n        ${makeTable(\n    eurAccounts.map(account => ({\n      name: account.name,\n      balance: account.balance ?? null,\n    })),\n    [\n      { key: 'name', label: 'Name' },\n      { key: 'balance', label: 'Kontostand (EUR)', align: 'right' as const },\n    ],\n    ['balance'],\n  )}\n      </div>\n    </div>\n    ${fxAccounts.length ? `\n      <div class=\"card\">\n        <h2>Fremdwährungen</h2>\n        <div class=\"scroll-container fx-account-table\">\n          ${makeTable(\n    fxAccounts.map(account => ({\n      name: account.name,\n      fx_display: `${(account.orig_balance ?? 0).toLocaleString('de-DE', {\n        minimumFractionDigits: 2,\n        maximumFractionDigits: 2,\n      })}&nbsp;${account.currency_code ?? ''}`,\n      balance: account.balance ?? null,\n    })),\n    [\n      { key: 'name', label: 'Name' },\n      { key: 'fx_display', label: 'Betrag (FX)' },\n      { key: 'balance', label: 'EUR', align: 'right' as const },\n    ],\n    ['balance'],\n  )}\n        </div>\n        ${fxWarning}\n      </div>` : ''}\n  `;\n\n  // 8. Footer-Karte mit letztem Datei-Änderungszeitpunkt (reintroduziert)\n  const footerCard = `\n    <div class=\"card footer-card\">\n      <div class=\"meta\">\n        <div class=\"last-file-update\">\n          📂 Letzte Aktualisierung der Datei: <strong>${lastFileUpdate || 'Unbekannt'}</strong>\n        </div>\n      </div>\n    </div>\n  `;\n\n  const markup = `\n    ${headerCard.outerHTML}\n    <div class=\"card\">\n      <h2>Investment</h2>\n      <div class=\"scroll-container portfolio-table\">\n        ${portfolioTableHtml}\n      </div>\n    </div>\n    ${accountsHtml}\n    ${footerCard}\n  `;\n\n  schedulePostRenderSetup(root, depots);\n\n  return markup;\n}\n\nfunction schedulePostRenderSetup(root: HTMLElement | null, depots: readonly PortfolioOverviewDepot[]): void {\n  if (!root) {\n    return;\n  }\n\n  const run = () => {\n    try {\n      const wrapper = root;\n      const tableHost = wrapper.querySelector<HTMLElement>('.portfolio-table');\n      if (tableHost && tableHost.querySelectorAll('.portfolio-toggle').length === 0) {\n        console.debug('Recovery: Tabelle ohne Buttons – erneuter Aufbau');\n        tableHost.innerHTML = buildExpandablePortfolioTable(depots);\n      }\n\n      attachPortfolioToggleHandler(root);\n      ensurePortfolioRowFallbackListener(root);\n\n      expandedPortfolios.forEach((pid) => {\n        try {\n          if (portfolioPositionsCache.has(pid)) {\n            attachPortfolioPositionsSorting(root, pid);\n            attachSecurityDetailListener(root, pid);\n          }\n        } catch (error) {\n          console.warn('Init-Sortierung für expandiertes Depot fehlgeschlagen:', pid, error);\n        }\n      });\n\n      try {\n        updatePortfolioFooterFromDom(wrapper);\n      } catch (footerErr) {\n        console.warn('renderDashboard: Footer-Summe konnte nicht aktualisiert werden:', footerErr);\n      }\n\n      try {\n        flushAllPendingPositions(root);\n      } catch (pendingErr) {\n        console.warn('renderDashboard: Pending-Positions konnten nicht angewendet werden:', pendingErr);\n      }\n\n      console.debug('renderDashboard: portfolio-toggle Buttons:', wrapper.querySelectorAll('.portfolio-toggle').length);\n    } catch (error) {\n      console.error('renderDashboard: Fehler bei Recovery/Listener', error);\n    }\n  };\n\n  const schedule = typeof requestAnimationFrame === 'function'\n    ? (cb: () => void) => requestAnimationFrame(cb)\n    : (cb: () => void) => setTimeout(cb, 0);\n\n  schedule(() => schedule(run));\n}\n","/**\n * Chart preparation utilities preserved from the legacy dashboard.\n */\n\n/**\n * Lightweight SVG chart helpers for the PP Reader dashboard.\n *\n * Provides rendering logic for historical security price charts without\n * introducing external dependencies. The helpers expose a simple API with\n * `renderLineChart` for initial setup and `updateLineChart` to mutate an\n * existing chart instance.\n */\n\nconst SVG_NS = 'http://www.w3.org/2000/svg';\nconst DEFAULT_WIDTH = 640;\nconst DEFAULT_HEIGHT = 260;\nconst DEFAULT_MARGIN = { top: 12, right: 16, bottom: 24, left: 16 } as const;\nconst DEFAULT_COLOR = 'var(--pp-reader-chart-line, #3f51b5)';\nconst DEFAULT_AREA = 'var(--pp-reader-chart-area, rgba(63, 81, 181, 0.12))';\nconst DEFAULT_TICK_FONT = '0.75rem';\nconst ONE_DAY_MS = 24 * 60 * 60 * 1000;\n\nexport type LineChartInputDatum = unknown;\n\nexport type LineChartAccessor = (\n  entry: LineChartInputDatum,\n  index: number,\n) => unknown;\n\nexport type LineChartFormatter = (\n  value: number,\n  entry: LineChartInputDatum,\n  index: number,\n) => string;\n\nexport interface LineChartTooltipPayload {\n  point: LineChartComputedPoint;\n  xFormatted: string;\n  yFormatted: string;\n  data: LineChartInputDatum;\n  index: number;\n}\n\nexport type LineChartTooltipRenderer = (\n  payload: LineChartTooltipPayload,\n) => string;\n\nexport interface ChartMargin {\n  top: number;\n  right: number;\n  bottom: number;\n  left: number;\n}\n\ninterface ChartDimensions {\n  width: number;\n  height: number;\n  margin: ChartMargin;\n}\n\nexport interface LineChartOptions {\n  series?: readonly LineChartInputDatum[];\n  width?: number;\n  height?: number;\n  margin?: Partial<ChartMargin>;\n  xAccessor?: LineChartAccessor;\n  yAccessor?: LineChartAccessor;\n  xFormatter?: LineChartFormatter;\n  yFormatter?: LineChartFormatter;\n  tooltipRenderer?: LineChartTooltipRenderer;\n  color?: string;\n  areaColor?: string;\n}\n\ninterface LineChartRange {\n  minX: number;\n  maxX: number;\n  minY: number;\n  maxY: number;\n  boundedWidth: number;\n  boundedHeight: number;\n}\n\nexport interface LineChartComputedPoint {\n  index: number;\n  data: LineChartInputDatum;\n  xValue: number;\n  yValue: number;\n  x: number;\n  y: number;\n}\n\ninterface LineChartInternalState extends ChartDimensions {\n  svg: SVGSVGElement | null;\n  areaPath: SVGPathElement | null;\n  linePath: SVGPathElement | null;\n  focusLine: SVGLineElement | null;\n  focusCircle: SVGCircleElement | null;\n  overlay: SVGRectElement | null;\n  tooltip: HTMLDivElement | null;\n  xAxis?: HTMLDivElement;\n  yAxis?: HTMLDivElement;\n  series: LineChartInputDatum[];\n  points: LineChartComputedPoint[];\n  range: LineChartRange | null;\n  xAccessor: LineChartAccessor;\n  yAccessor: LineChartAccessor;\n  xFormatter: LineChartFormatter;\n  yFormatter: LineChartFormatter;\n  tooltipRenderer: LineChartTooltipRenderer;\n  color: string;\n  areaColor: string;\n  handlersAttached: boolean;\n  handlePointerMove?: (event: PointerEvent) => void;\n  handlePointerLeave?: (event: PointerEvent) => void;\n}\n\ninterface LineChartContainerElement extends HTMLDivElement {\n  __chartState?: LineChartInternalState;\n}\n\nfunction createSvgElement<K extends keyof SVGElementTagNameMap>(\n  tag: K,\n  attrs: Record<string, unknown> = {},\n): SVGElementTagNameMap[K] {\n  const element = document.createElementNS(SVG_NS, tag) as SVGElementTagNameMap[K];\n  Object.entries(attrs).forEach(([key, value]) => {\n    if (value == null) {\n      return;\n    }\n    element.setAttribute(key, String(value));\n  });\n  return element;\n}\n\nfunction toNumber(value: unknown, fallback: number | null = null): number | null {\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n\n  if (typeof value === 'string' && value.trim() !== '') {\n    const parsed = Number.parseFloat(value);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return fallback;\n}\n\nfunction toTimestamp(value: unknown, fallbackIndex: number): number {\n  if (value instanceof Date) {\n    const timestamp = value.getTime();\n    return Number.isFinite(timestamp) ? timestamp : fallbackIndex;\n  }\n\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n\n  if (typeof value === 'string') {\n    const parsed = Date.parse(value);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return fallbackIndex;\n}\n\nconst defaultXAccessor: LineChartAccessor = (entry) => {\n  if (entry && typeof entry === 'object' && 'date' in entry) {\n    return (entry as { date?: unknown }).date;\n  }\n  return undefined;\n};\n\nconst defaultYAccessor: LineChartAccessor = (entry) => {\n  if (entry && typeof entry === 'object' && 'close' in entry) {\n    return (entry as { close?: unknown }).close;\n  }\n  return undefined;\n};\n\nconst defaultXFormatter: LineChartFormatter = (timestamp, dataPoint, _index) => {\n  if (Number.isFinite(timestamp)) {\n    const date = new Date(timestamp);\n    if (!Number.isNaN(date.getTime())) {\n      return date.toLocaleDateString('de-DE');\n    }\n  }\n\n  if (dataPoint && typeof dataPoint === 'object' && 'date' in dataPoint) {\n    const raw = (dataPoint as { date?: unknown }).date;\n    return raw != null ? String(raw) : '';\n  }\n\n  if (timestamp == null) {\n    return '';\n  }\n\n  return String(timestamp);\n};\n\nconst defaultYFormatter: LineChartFormatter = (value, _dataPoint, _index) => {\n  const numeric = Number.isFinite(value) ? value : Number.parseFloat(String(value)) || 0;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2,\n  });\n};\n\nconst defaultTooltipRenderer: LineChartTooltipRenderer = ({ xFormatted, yFormatted }) => `\n    <div class=\"chart-tooltip-date\">${xFormatted}</div>\n    <div class=\"chart-tooltip-value\">${yFormatted}&nbsp;€</div>\n  `;\n\nfunction ensureChartState(container: LineChartContainerElement): LineChartInternalState {\n  if (!container.__chartState) {\n    container.__chartState = {\n      svg: null,\n      areaPath: null,\n      linePath: null,\n      focusLine: null,\n      focusCircle: null,\n      overlay: null,\n      tooltip: null,\n      width: DEFAULT_WIDTH,\n      height: DEFAULT_HEIGHT,\n      margin: { ...DEFAULT_MARGIN },\n      series: [],\n      points: [],\n      range: null,\n      xAccessor: defaultXAccessor,\n      yAccessor: defaultYAccessor,\n      xFormatter: defaultXFormatter,\n      yFormatter: defaultYFormatter,\n      tooltipRenderer: defaultTooltipRenderer,\n      color: DEFAULT_COLOR,\n      areaColor: DEFAULT_AREA,\n      handlersAttached: false,\n    };\n  }\n  return container.__chartState;\n}\n\nfunction clamp(value: number, min: number, max: number): number {\n  if (!Number.isFinite(value)) {\n    return min;\n  }\n  if (value < min) {\n    return min;\n  }\n  if (value > max) {\n    return max;\n  }\n  return value;\n}\n\nfunction buildAreaPath(points: readonly LineChartComputedPoint[], baselineY: number): string {\n  if (!Array.isArray(points) || points.length === 0) {\n    return '';\n  }\n\n  const moveLine = points\n    .map((point, index) => {\n      const command = index === 0 ? 'M' : 'L';\n      return `${command}${point.x.toFixed(2)} ${point.y.toFixed(2)}`;\n    })\n    .join(' ');\n\n  const closing = `L${points[points.length - 1].x.toFixed(2)} ${baselineY.toFixed(2)} L${points[0].x.toFixed(2)} ${baselineY.toFixed(2)} Z`;\n\n  return `${moveLine} ${closing}`;\n}\n\nfunction buildLinePath(points: readonly LineChartComputedPoint[]): string {\n  if (!Array.isArray(points) || points.length === 0) {\n    return '';\n  }\n\n  return points\n    .map((point, index) => {\n      const command = index === 0 ? 'M' : 'L';\n      return `${command}${point.x.toFixed(2)} ${point.y.toFixed(2)}`;\n    })\n    .join(' ');\n}\n\nfunction computePoints(\n  series: readonly LineChartInputDatum[],\n  dimensions: ChartDimensions,\n  accessors: { xAccessor: LineChartAccessor; yAccessor: LineChartAccessor },\n): { points: LineChartComputedPoint[]; range: LineChartRange | null } {\n  const { width, height, margin } = dimensions;\n  const { xAccessor, yAccessor } = accessors;\n\n  if (!Array.isArray(series) || series.length === 0) {\n    return { points: [], range: null };\n  }\n\n  const rawPoints = series\n    .map((entry, index) => {\n      const rawX = xAccessor(entry, index);\n      const rawY = yAccessor(entry, index);\n      const xValue = toTimestamp(rawX, index);\n      const yValue = toNumber(rawY, Number.NaN);\n      if (!Number.isFinite(yValue)) {\n        return null;\n      }\n      return {\n        index,\n        data: entry,\n        xValue,\n        yValue,\n      };\n    })\n    .filter((point): point is { index: number; data: LineChartInputDatum; xValue: number; yValue: number } => Boolean(point));\n\n  if (rawPoints.length === 0) {\n    return { points: [], range: null };\n  }\n\n  const minX = rawPoints.reduce((min, point) => Math.min(min, point.xValue), rawPoints[0].xValue);\n  const maxX = rawPoints.reduce((max, point) => Math.max(max, point.xValue), rawPoints[0].xValue);\n  const minY = rawPoints.reduce((min, point) => Math.min(min, point.yValue), rawPoints[0].yValue);\n  const maxY = rawPoints.reduce((max, point) => Math.max(max, point.yValue), rawPoints[0].yValue);\n\n  const boundedWidth = Math.max(width - margin.left - margin.right, 1);\n  const boundedHeight = Math.max(height - margin.top - margin.bottom, 1);\n\n  const safeMinX = Number.isFinite(minX) ? minX : 0;\n  const safeMaxX = Number.isFinite(maxX) ? maxX : safeMinX + 1;\n  const safeMinY = Number.isFinite(minY) ? minY : 0;\n  const safeMaxY = Number.isFinite(maxY) ? maxY : safeMinY + 1;\n\n  const desiredYTicks = Math.max(\n    2,\n    Math.min(\n      6,\n      Math.round(\n        Math.max(height - margin.top - margin.bottom, 0) / 60,\n      ) || 4,\n    ),\n  );\n  const { niceMin: domainMinY, niceMax: domainMaxY } = computeNiceDomain(\n    safeMinY,\n    safeMaxY,\n    desiredYTicks,\n  );\n\n  const effectiveMinY = Number.isFinite(domainMinY) ? domainMinY : safeMinY;\n  const effectiveMaxY = Number.isFinite(domainMaxY) ? domainMaxY : safeMaxY;\n\n  const rangeX = safeMaxX - safeMinX || 1;\n  const rangeY = effectiveMaxY - effectiveMinY || 1;\n\n  const points = rawPoints.map((point) => {\n    const ratioX = rangeX === 0 ? 0.5 : (point.xValue - safeMinX) / rangeX;\n    const ratioY = rangeY === 0 ? 0.5 : (point.yValue - effectiveMinY) / rangeY;\n    const x = margin.left + ratioX * boundedWidth;\n    const y = margin.top + (1 - ratioY) * boundedHeight;\n    return {\n      ...point,\n      x,\n      y,\n    } satisfies LineChartComputedPoint;\n  });\n\n  return {\n    points,\n    range: {\n      minX: safeMinX,\n      maxX: safeMaxX,\n      minY: effectiveMinY,\n      maxY: effectiveMaxY,\n      boundedWidth,\n      boundedHeight,\n    },\n  };\n}\n\nfunction assignDimensions(\n  state: LineChartInternalState,\n  width: number | undefined,\n  height: number | undefined,\n  margin: Partial<ChartMargin> | undefined,\n): void {\n  state.width = Number.isFinite(width) ? Number(width) : DEFAULT_WIDTH;\n  state.height = Number.isFinite(height) ? Number(height) : DEFAULT_HEIGHT;\n  state.margin = {\n    top: Number.isFinite(margin?.top) ? Number(margin?.top) : DEFAULT_MARGIN.top,\n    right: Number.isFinite(margin?.right) ? Number(margin?.right) : DEFAULT_MARGIN.right,\n    bottom: Number.isFinite(margin?.bottom) ? Number(margin?.bottom) : DEFAULT_MARGIN.bottom,\n    left: Number.isFinite(margin?.left) ? Number(margin?.left) : DEFAULT_MARGIN.left,\n  };\n}\n\nfunction formatTooltip(state: LineChartInternalState, point: LineChartComputedPoint): string {\n  const xFormatted = state.xFormatter(point.xValue, point.data, point.index);\n  const yFormatted = state.yFormatter(point.yValue, point.data, point.index);\n  return state.tooltipRenderer({\n    point,\n    xFormatted,\n    yFormatted,\n    data: point.data,\n    index: point.index,\n  });\n}\n\nfunction updateTooltipPosition(\n  state: LineChartInternalState,\n  point: LineChartComputedPoint,\n  pointerY: number | null,\n): void {\n  const { tooltip, width, margin, height } = state;\n  if (!tooltip) {\n    return;\n  }\n\n  const baselineY = height - margin.bottom;\n  tooltip.style.visibility = 'visible';\n  tooltip.style.opacity = '1';\n  const tooltipWidth = tooltip.offsetWidth || 0;\n  const tooltipHeight = tooltip.offsetHeight || 0;\n  const horizontal = clamp(point.x - tooltipWidth / 2, margin.left, width - margin.right - tooltipWidth);\n  const maxVertical = Math.max(baselineY - tooltipHeight, 0);\n  const padding = 12;\n  const anchorY = Number.isFinite(pointerY)\n    ? clamp(pointerY ?? 0, margin.top, baselineY)\n    : point.y;\n  let vertical = anchorY + padding;\n  if (vertical > maxVertical) {\n    vertical = anchorY - tooltipHeight - padding;\n  }\n  vertical = clamp(vertical, 0, maxVertical);\n  tooltip.style.transform = `translate(${Math.round(horizontal)}px, ${Math.round(vertical)}px)`;\n}\n\nfunction hideTooltip(state: LineChartInternalState): void {\n  const { tooltip, focusLine, focusCircle } = state;\n  if (tooltip) {\n    tooltip.style.opacity = '0';\n    tooltip.style.visibility = 'hidden';\n  }\n  if (focusLine) {\n    focusLine.style.opacity = '0';\n  }\n  if (focusCircle) {\n    focusCircle.style.opacity = '0';\n  }\n}\n\nfunction attachPointerHandlers(\n  container: LineChartContainerElement,\n  state: LineChartInternalState,\n): void {\n  if (state.handlersAttached || !state.overlay) {\n    return;\n  }\n\n  const handlePointerMove = (event: PointerEvent) => {\n    if (!state.points || state.points.length === 0 || !state.svg) {\n      hideTooltip(state);\n      return;\n    }\n\n    const rect = state.svg.getBoundingClientRect();\n    const pointerX = event.clientX - rect.left;\n    const pointerY = event.clientY - rect.top;\n    let closest = state.points[0];\n    let minDistance = Math.abs(pointerX - closest.x);\n\n    for (let idx = 1; idx < state.points.length; idx += 1) {\n      const candidate = state.points[idx];\n      const distance = Math.abs(pointerX - candidate.x);\n      if (distance < minDistance) {\n        minDistance = distance;\n        closest = candidate;\n      }\n    }\n\n    if (!closest) {\n      hideTooltip(state);\n      return;\n    }\n\n    if (state.focusCircle) {\n      state.focusCircle.setAttribute('cx', closest.x.toFixed(2));\n      state.focusCircle.setAttribute('cy', closest.y.toFixed(2));\n      state.focusCircle.style.opacity = '1';\n    }\n\n    if (state.focusLine) {\n      state.focusLine.setAttribute('x1', closest.x.toFixed(2));\n      state.focusLine.setAttribute('x2', closest.x.toFixed(2));\n      state.focusLine.setAttribute('y1', state.margin.top.toFixed(2));\n      state.focusLine.setAttribute(\n        'y2',\n        (state.height - state.margin.bottom).toFixed(2),\n      );\n      state.focusLine.style.opacity = '1';\n    }\n\n    if (state.tooltip) {\n      state.tooltip.innerHTML = formatTooltip(state, closest);\n      updateTooltipPosition(state, closest, pointerY);\n    }\n  };\n\n  const handlePointerLeave = () => {\n    hideTooltip(state);\n  };\n\n  state.overlay.addEventListener('pointermove', handlePointerMove);\n  state.overlay.addEventListener('pointerenter', handlePointerMove);\n  state.overlay.addEventListener('pointerleave', handlePointerLeave);\n\n  state.handlersAttached = true;\n  state.handlePointerMove = handlePointerMove;\n  state.handlePointerLeave = handlePointerLeave;\n\n  container.addEventListener('pointercancel', handlePointerLeave);\n}\n\nexport function renderLineChart(\n  root: HTMLElement,\n  options: LineChartOptions = {},\n): LineChartContainerElement | null {\n  if (!root) {\n    console.error('renderLineChart: root element is required');\n    return null;\n  }\n\n  const container = document.createElement('div') as LineChartContainerElement;\n  container.className = 'line-chart-container';\n  container.dataset.chartType = 'line';\n  container.style.position = 'relative';\n\n  const svg = createSvgElement('svg', {\n    width: DEFAULT_WIDTH,\n    height: DEFAULT_HEIGHT,\n    viewBox: `0 0 ${DEFAULT_WIDTH} ${DEFAULT_HEIGHT}`,\n    role: 'img',\n    'aria-hidden': 'true',\n    focusable: 'false',\n  });\n  svg.classList.add('line-chart-svg');\n\n  const areaPath = createSvgElement('path', {\n    class: 'line-chart-area',\n    fill: DEFAULT_AREA,\n    stroke: 'none',\n  });\n\n  const linePath = createSvgElement('path', {\n    class: 'line-chart-path',\n    fill: 'none',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 2,\n    'stroke-linecap': 'round',\n    'stroke-linejoin': 'round',\n  });\n\n  const focusLine = createSvgElement('line', {\n    class: 'line-chart-focus-line',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 1,\n    'stroke-dasharray': '4 4',\n    opacity: 0,\n  });\n\n  const focusCircle = createSvgElement('circle', {\n    class: 'line-chart-focus-circle',\n    r: 4,\n    fill: '#fff',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 2,\n    opacity: 0,\n  });\n\n  const overlay = createSvgElement('rect', {\n    class: 'line-chart-overlay',\n    fill: 'transparent',\n    x: 0,\n    y: 0,\n    width: DEFAULT_WIDTH,\n    height: DEFAULT_HEIGHT,\n  });\n\n  svg.appendChild(areaPath);\n  svg.appendChild(linePath);\n  svg.appendChild(focusLine);\n  svg.appendChild(focusCircle);\n  svg.appendChild(overlay);\n\n  container.appendChild(svg);\n\n  const tooltip = document.createElement('div');\n  tooltip.className = 'chart-tooltip';\n  tooltip.style.position = 'absolute';\n  tooltip.style.top = '0';\n  tooltip.style.left = '0';\n  tooltip.style.pointerEvents = 'none';\n  tooltip.style.opacity = '0';\n  tooltip.style.visibility = 'hidden';\n  container.appendChild(tooltip);\n\n  root.appendChild(container);\n\n  const state = ensureChartState(container);\n  state.svg = svg;\n  state.areaPath = areaPath;\n  state.linePath = linePath;\n  state.focusLine = focusLine;\n  state.focusCircle = focusCircle;\n  state.overlay = overlay;\n  state.tooltip = tooltip;\n  state.xAccessor = options.xAccessor ?? defaultXAccessor;\n  state.yAccessor = options.yAccessor ?? defaultYAccessor;\n  state.xFormatter = options.xFormatter ?? defaultXFormatter;\n  state.yFormatter = options.yFormatter ?? defaultYFormatter;\n  state.tooltipRenderer = options.tooltipRenderer ?? defaultTooltipRenderer;\n  state.color = options.color ?? DEFAULT_COLOR;\n  state.areaColor = options.areaColor ?? DEFAULT_AREA;\n  state.handlersAttached = false;\n\n  if (!state.xAxis) {\n    const xAxis = document.createElement('div');\n    xAxis.className = 'line-chart-axis line-chart-axis-x';\n    xAxis.style.position = 'absolute';\n    xAxis.style.left = '0';\n    xAxis.style.right = '0';\n    xAxis.style.bottom = '0';\n    xAxis.style.pointerEvents = 'none';\n    xAxis.style.fontSize = DEFAULT_TICK_FONT;\n    xAxis.style.color = 'var(--secondary-text-color)';\n    xAxis.style.display = 'block';\n    container.appendChild(xAxis);\n    state.xAxis = xAxis;\n  }\n\n  if (!state.yAxis) {\n    const yAxis = document.createElement('div');\n    yAxis.className = 'line-chart-axis line-chart-axis-y';\n    yAxis.style.position = 'absolute';\n    yAxis.style.top = '0';\n    yAxis.style.bottom = '0';\n    yAxis.style.left = '0';\n    yAxis.style.pointerEvents = 'none';\n    yAxis.style.fontSize = DEFAULT_TICK_FONT;\n    yAxis.style.color = 'var(--secondary-text-color)';\n    yAxis.style.display = 'block';\n    container.appendChild(yAxis);\n    state.yAxis = yAxis;\n  }\n\n  assignDimensions(state, options.width, options.height, options.margin);\n\n  if (state.linePath) {\n    state.linePath.setAttribute('stroke', state.color);\n  }\n  if (state.focusLine) {\n    state.focusLine.setAttribute('stroke', state.color);\n  }\n  if (state.focusCircle) {\n    state.focusCircle.setAttribute('stroke', state.color);\n  }\n  if (state.areaPath) {\n    state.areaPath.setAttribute('fill', state.areaColor);\n  }\n\n  updateLineChart(container, options);\n  attachPointerHandlers(container, state);\n\n  return container;\n}\n\nexport function updateLineChart(\n  container: LineChartContainerElement | null,\n  options: LineChartOptions = {},\n): void {\n  if (!container) {\n    console.error('updateLineChart: container element is required');\n    return;\n  }\n\n  const state = ensureChartState(container);\n  if (!state.svg || !state.linePath || !state.overlay) {\n    console.error('updateLineChart: chart was not initialised with renderLineChart');\n    return;\n  }\n\n  if (options.xAccessor) {\n    state.xAccessor = options.xAccessor;\n  }\n  if (options.yAccessor) {\n    state.yAccessor = options.yAccessor;\n  }\n  if (options.xFormatter) {\n    state.xFormatter = options.xFormatter;\n  }\n  if (options.yFormatter) {\n    state.yFormatter = options.yFormatter;\n  }\n  if (options.tooltipRenderer) {\n    state.tooltipRenderer = options.tooltipRenderer;\n  }\n  if (options.color) {\n    state.color = options.color;\n    state.linePath.setAttribute('stroke', state.color);\n    if (state.focusLine) {\n      state.focusLine.setAttribute('stroke', state.color);\n    }\n    if (state.focusCircle) {\n      state.focusCircle.setAttribute('stroke', state.color);\n    }\n  }\n  if (options.areaColor) {\n    state.areaColor = options.areaColor;\n    if (state.areaPath) {\n      state.areaPath.setAttribute('fill', state.areaColor);\n    }\n  }\n\n  assignDimensions(state, options.width, options.height, options.margin);\n\n  const { width, height, margin } = state;\n  state.svg.setAttribute('width', String(width));\n  state.svg.setAttribute('height', String(height));\n  state.svg.setAttribute('viewBox', `0 0 ${width} ${height}`);\n\n  state.overlay.setAttribute('x', margin.left.toFixed(2));\n  state.overlay.setAttribute('y', margin.top.toFixed(2));\n  state.overlay.setAttribute(\n    'width',\n    Math.max(width - margin.left - margin.right, 0).toFixed(2),\n  );\n  state.overlay.setAttribute(\n    'height',\n    Math.max(height - margin.top - margin.bottom, 0).toFixed(2),\n  );\n\n  const series = Array.isArray(options.series) ? options.series : state.series;\n  state.series = Array.isArray(series) ? [...series] : [];\n\n  const { points, range } = computePoints(state.series, state, {\n    xAccessor: state.xAccessor,\n    yAccessor: state.yAccessor,\n  });\n  state.points = points;\n  state.range = range;\n\n  if (!points || points.length === 0) {\n    state.linePath.setAttribute('d', '');\n    if (state.areaPath) {\n      state.areaPath.setAttribute('d', '');\n    }\n    hideTooltip(state);\n    updateAxes(state);\n    return;\n  }\n\n  const lineD = buildLinePath(points);\n  state.linePath.setAttribute('d', lineD);\n\n  if (state.areaPath && range) {\n    const baselineY = state.margin.top + range.boundedHeight;\n    const areaD = buildAreaPath(points, baselineY);\n    state.areaPath.setAttribute('d', areaD);\n  }\n\n  updateAxes(state);\n}\n\nfunction updateAxes(state: LineChartInternalState): void {\n  const { xAxis, yAxis, range, margin, height, yFormatter } = state;\n  if (!xAxis || !yAxis) {\n    return;\n  }\n\n  if (!range) {\n    xAxis.innerHTML = '';\n    yAxis.innerHTML = '';\n    return;\n  }\n\n  const { minX, maxX, minY, maxY, boundedWidth, boundedHeight } = range;\n\n  const hasValidX = Number.isFinite(minX) && Number.isFinite(maxX) && maxX >= minX;\n  const hasValidY = Number.isFinite(minY) && Number.isFinite(maxY) && maxY >= minY;\n\n  const effectiveWidth = Math.max(boundedWidth, 0);\n  const effectiveHeight = Math.max(boundedHeight, 0);\n\n  xAxis.style.left = `${margin.left}px`;\n  xAxis.style.width = `${effectiveWidth}px`;\n  xAxis.style.top = `${height - margin.bottom + 6}px`;\n  xAxis.innerHTML = '';\n\n  if (hasValidX && effectiveWidth > 0) {\n    const rangeDays = (maxX - minX) / ONE_DAY_MS;\n    const desiredTicks = Math.max(2, Math.min(6, Math.round(effectiveWidth / 140) || 4));\n    const xTicks = generateTimeAxisTicks(state, minX, maxX, desiredTicks, rangeDays);\n    xTicks.forEach(({ positionRatio, label }) => {\n      const tick = document.createElement('div');\n      tick.className = 'line-chart-axis-tick line-chart-axis-tick-x';\n      tick.style.position = 'absolute';\n      tick.style.bottom = '0';\n      tick.style.transform = 'translateX(-50%)';\n      const ratio = clamp(positionRatio, 0, 1);\n      tick.style.left = `${ratio * effectiveWidth}px`;\n      tick.textContent = label;\n      xAxis.appendChild(tick);\n    });\n  }\n\n  yAxis.style.top = `${margin.top}px`;\n  yAxis.style.height = `${effectiveHeight}px`;\n  const yAxisWidth = Math.max(margin.left - 6, 0);\n  yAxis.style.left = '0';\n  yAxis.style.width = `${Math.max(yAxisWidth, 0)}px`;\n  yAxis.innerHTML = '';\n\n  if (hasValidY && effectiveHeight > 0) {\n    const desiredTicks = Math.max(2, Math.min(6, Math.round(effectiveHeight / 60) || 4));\n    const yTicks = generateNumericAxisTicks(minY, maxY, desiredTicks);\n    const applyFormatter = yFormatter ?? defaultYFormatter;\n    yTicks.forEach(({ value, positionRatio }) => {\n      const tick = document.createElement('div');\n      tick.className = 'line-chart-axis-tick line-chart-axis-tick-y';\n      tick.style.position = 'absolute';\n      tick.style.left = '0';\n      const clampedRatio = clamp(positionRatio, 0, 1);\n      const top = (1 - clampedRatio) * effectiveHeight;\n      tick.style.top = `${top}px`;\n      tick.textContent = applyFormatter(value, null, -1);\n      yAxis.appendChild(tick);\n    });\n  }\n}\n\nfunction computeNiceDomain(\n  minValue: number,\n  maxValue: number,\n  desiredTicks = 4,\n): { niceMin: number; niceMax: number } {\n  if (!Number.isFinite(minValue) || !Number.isFinite(maxValue)) {\n    return {\n      niceMin: minValue,\n      niceMax: maxValue,\n    };\n  }\n\n  const safeTicks = Math.max(2, desiredTicks);\n\n  if (maxValue === minValue) {\n    const padding = niceStep(Math.abs(minValue) || 1);\n    return {\n      niceMin: minValue - padding,\n      niceMax: maxValue + padding,\n    };\n  }\n\n  const range = maxValue - minValue;\n  const rawStep = range / (safeTicks - 1);\n  const step = niceStep(rawStep);\n  const niceMin = Math.floor(minValue / step) * step;\n  const niceMax = Math.ceil(maxValue / step) * step;\n\n  if (niceMin === niceMax) {\n    return {\n      niceMin: minValue,\n      niceMax: maxValue + step,\n    };\n  }\n\n  return {\n    niceMin,\n    niceMax,\n  };\n}\n\nfunction generateTimeAxisTicks(\n  state: LineChartInternalState,\n  minTimestamp: number,\n  maxTimestamp: number,\n  desiredTicks: number,\n  rangeDays: number,\n): Array<{ positionRatio: number; label: string }> {\n  if (!Number.isFinite(minTimestamp) || !Number.isFinite(maxTimestamp) || maxTimestamp < minTimestamp) {\n    return [];\n  }\n\n  if (!Number.isFinite(rangeDays) || rangeDays <= 0) {\n    const label = formatXAxisLabel(state, minTimestamp, rangeDays || 0);\n    return [\n      {\n        positionRatio: 0.5,\n        label,\n      },\n    ];\n  }\n\n  const tickCount = Math.max(2, desiredTicks);\n  const ticks: Array<{ positionRatio: number; label: string }> = [];\n  const range = maxTimestamp - minTimestamp;\n  for (let index = 0; index < tickCount; index += 1) {\n    const ratio = tickCount === 1 ? 0.5 : index / (tickCount - 1);\n    const value = minTimestamp + ratio * range;\n    ticks.push({\n      positionRatio: ratio,\n      label: formatXAxisLabel(state, value, rangeDays),\n    });\n  }\n  return ticks;\n}\n\nfunction formatXAxisLabel(\n  state: LineChartInternalState,\n  timestamp: number,\n  rangeDays: number,\n): string {\n  const date = new Date(timestamp);\n  if (Number.isFinite(date.getTime())) {\n    if (rangeDays > 1095) {\n      return String(date.getFullYear());\n    }\n    if (rangeDays > 365) {\n      return date.toLocaleDateString('de-DE', {\n        year: 'numeric',\n        month: 'short',\n      });\n    }\n    if (rangeDays > 90) {\n      return date.toLocaleDateString('de-DE', {\n        year: '2-digit',\n        month: 'short',\n      });\n    }\n    if (rangeDays > 30) {\n      return date.toLocaleDateString('de-DE', {\n        day: '2-digit',\n        month: 'short',\n      });\n    }\n    return date.toLocaleDateString('de-DE', {\n      day: '2-digit',\n      month: '2-digit',\n    });\n  }\n\n  return state.xFormatter ? state.xFormatter(timestamp, null, -1) : String(timestamp);\n}\n\nfunction generateNumericAxisTicks(\n  minValue: number,\n  maxValue: number,\n  desiredTicks: number,\n): Array<{ value: number; positionRatio: number }> {\n  if (!Number.isFinite(minValue) || !Number.isFinite(maxValue)) {\n    return [];\n  }\n\n  if (maxValue === minValue) {\n    return [\n      {\n        value: minValue,\n        positionRatio: 0.5,\n      },\n    ];\n  }\n\n  const range = maxValue - minValue;\n  const tickCount = Math.max(2, desiredTicks);\n  const rawStep = range / (tickCount - 1);\n  const step = niceStep(rawStep);\n  const start = Math.floor(minValue / step) * step;\n  const end = Math.ceil(maxValue / step) * step;\n\n  const ticks: Array<{ value: number; positionRatio: number }> = [];\n  for (let value = start; value <= end + step / 2; value += step) {\n    const ratio = (value - minValue) / (maxValue - minValue);\n    ticks.push({\n      value,\n      positionRatio: clamp(ratio, 0, 1),\n    });\n  }\n\n  if (ticks.length > tickCount + 2) {\n    return ticks.filter((_, index) => index % 2 === 0);\n  }\n\n  return ticks;\n}\n\nfunction niceStep(value: number): number {\n  if (!Number.isFinite(value) || value === 0) {\n    return 1;\n  }\n\n  const exponent = Math.floor(Math.log10(Math.abs(value)));\n  const fraction = Math.abs(value) / 10 ** exponent;\n  let niceFraction: number;\n  if (fraction <= 1) {\n    niceFraction = 1;\n  } else if (fraction <= 2) {\n    niceFraction = 2;\n  } else if (fraction <= 5) {\n    niceFraction = 5;\n  } else {\n    niceFraction = 10;\n  }\n  return niceFraction * 10 ** exponent;\n}\n","/**\n * Security detail tab renderer migrated verbatim for TypeScript.\n */\n\n/**\n * Security detail tab renderer and registration.\n *\n * Provides the render function used by dynamic security tabs and\n * exposes a helper to register the descriptor factory with the\n * dashboard controller.\n */\nimport { createHeaderCard, formatNumber, formatGain } from '../content/elements';\nimport { renderLineChart, updateLineChart } from '../content/charting';\nimport type { LineChartOptions } from '../content/charting';\nimport {\n  fetchSecuritySnapshotWS,\n  fetchSecurityHistoryWS,\n} from '../data/api';\nimport type {\n  SecuritySnapshotResponse,\n  SecurityHistoryResponse,\n  SecurityHistoryOptions,\n} from '../data/api';\nimport type { HomeAssistant } from '../types/home-assistant';\nimport type {\n  DashboardTabRenderFn,\n  PanelConfigLike,\n  PortfolioPositionsUpdatedEventDetail,\n  SecurityHistoryRangeKey,\n  SecurityHistoryRangeState,\n  SecuritySnapshotLike,\n} from './types';\n\nconst HOLDINGS_FRACTION_DIGITS = { min: 0, max: 6 } as const;\nconst PRICE_FRACTION_DIGITS = { min: 2, max: 4 } as const;\nconst PRICE_SCALE = 1e8;\nconst DEFAULT_HISTORY_RANGE: SecurityHistoryRangeKey = '1Y';\nconst AVAILABLE_HISTORY_RANGES: readonly SecurityHistoryRangeKey[] = [\n  '1M',\n  '6M',\n  '1Y',\n  '5Y',\n];\nconst RANGE_DAY_COUNTS: Record<SecurityHistoryRangeKey, number> = {\n  '1M': 30,\n  '6M': 182,\n  '1Y': 365,\n  '5Y': 1826,\n};\n\ntype SecuritySnapshotDetail = Partial<Omit<SecuritySnapshotLike, 'security_uuid'>> & {\n  security_uuid?: string | null;\n  name?: string | null;\n  total_holdings?: number | string | null;\n  total_holdings_precise?: number | string | null;\n  last_price_native?: number | string | null;\n  last_price_eur?: number | string | null;\n  market_value_eur?: number | string | null;\n  current_value_eur?: number | string | null;\n  currency_code?: string | null;\n  last_price?: {\n    native?: number | string | null;\n    [key: string]: unknown;\n  } | null;\n  source?: string | null;\n  [key: string]: unknown;\n};\n\ninterface RawHistoryEntry {\n  date?: unknown;\n  close?: unknown;\n  [key: string]: unknown;\n}\n\ninterface NormalizedHistoryEntry {\n  date: Date | string | number;\n  close: number;\n}\n\ntype HistoryPlaceholderState =\n  | { status: 'loaded' }\n  | { status: 'empty' }\n  | { status: 'error'; message?: string };\n\ntype SecurityHistoryCache = Map<SecurityHistoryRangeKey, NormalizedHistoryEntry[]>;\n\ntype HistoryCacheRegistry = Map<string, SecurityHistoryCache>;\n\ntype RangeStateRegistry = Map<string, SecurityHistoryRangeState>;\n\ntype LiveUpdateHandler = (event: Event) => void;\n\nconst SECURITY_HISTORY_CACHE: HistoryCacheRegistry = new Map();\nconst RANGE_STATE_REGISTRY: RangeStateRegistry = new Map();\nconst LIVE_UPDATE_EVENT = 'pp-reader:portfolio-positions-updated';\nconst LIVE_UPDATE_HANDLERS = new Map<string, LiveUpdateHandler>();\n\nfunction buildCachedSnapshotNotice(params: {\n  fallbackUsed: boolean;\n  flaggedAsCache: boolean;\n}): string {\n  const { fallbackUsed, flaggedAsCache } = params;\n  const reasons: string[] = [];\n  if (fallbackUsed) {\n    reasons.push(\n      'Der aktuelle Snapshot konnte nicht geladen werden. Es werden die zuletzt gespeicherten Werte angezeigt.',\n    );\n  }\n  if (flaggedAsCache && !fallbackUsed) {\n    reasons.push(\n      'Der Snapshot ist vom Datenanbieter als Zwischenspeicherstand markiert.',\n    );\n  }\n\n  const reasonText = reasons.length\n    ? reasons.join(' ')\n    : 'Die Daten stammen aus dem Zwischenspeicher.';\n\n  return `\n    <div class=\"card warning-card stale-notice\" role=\"status\" aria-live=\"polite\">\n      <h2>Zwischengespeicherte Werte</h2>\n      <p>${reasonText}</p>\n      <p class=\"stale-notice__hint\">Die angezeigten Beträge können von den aktuellen Marktwerten abweichen. Laden Sie die Ansicht erneut, sobald eine Verbindung verfügbar ist.</p>\n    </div>\n  `;\n}\n\nfunction getCachedSecuritySnapshot(\n  securityUuid: string | null | undefined,\n): SecuritySnapshotDetail | null {\n  if (!securityUuid || typeof window === 'undefined') {\n    return null;\n  }\n\n  try {\n    const getter = window.__ppReaderGetSecuritySnapshotFromCache;\n    if (typeof getter === 'function') {\n      const snapshot = getter(securityUuid);\n      if (snapshot && typeof snapshot === 'object') {\n        return snapshot as SecuritySnapshotDetail;\n      }\n    }\n  } catch (error) {\n    console.warn('getCachedSecuritySnapshot: Zugriff auf Cache fehlgeschlagen', error);\n  }\n\n  return null;\n}\n\nfunction ensureHistoryCache(securityUuid: string): SecurityHistoryCache {\n  if (!SECURITY_HISTORY_CACHE.has(securityUuid)) {\n    SECURITY_HISTORY_CACHE.set(securityUuid, new Map());\n  }\n  return SECURITY_HISTORY_CACHE.get(securityUuid) as SecurityHistoryCache;\n}\n\nfunction invalidateHistoryCache(securityUuid: string | null | undefined): void {\n  if (!securityUuid) {\n    return;\n  }\n\n  if (SECURITY_HISTORY_CACHE.has(securityUuid)) {\n    try {\n      const cache = SECURITY_HISTORY_CACHE.get(securityUuid);\n      cache?.clear();\n    } catch (error) {\n      console.warn('invalidateHistoryCache: Konnte Cache nicht leeren', securityUuid, error);\n    }\n    SECURITY_HISTORY_CACHE.delete(securityUuid);\n  }\n}\n\nfunction handleLiveUpdateForSecurity(\n  securityUuid: string,\n  detail: PortfolioPositionsUpdatedEventDetail,\n): void {\n  if (!securityUuid || !detail) {\n    return;\n  }\n\n  const payload = detail.securityUuids;\n  const candidates = Array.isArray(payload) ? payload : [];\n\n  if (candidates.includes(securityUuid)) {\n    invalidateHistoryCache(securityUuid);\n  }\n}\n\nfunction ensureLiveUpdateSubscription(securityUuid: string): void {\n  if (!securityUuid || LIVE_UPDATE_HANDLERS.has(securityUuid)) {\n    return;\n  }\n\n  const handler: LiveUpdateHandler = (event) => {\n    if (!(event instanceof CustomEvent)) {\n      return;\n    }\n    const detail = event.detail as PortfolioPositionsUpdatedEventDetail | undefined;\n    if (!detail) {\n      return;\n    }\n    handleLiveUpdateForSecurity(securityUuid, detail);\n  };\n\n  try {\n    window.addEventListener(LIVE_UPDATE_EVENT, handler as EventListener);\n    LIVE_UPDATE_HANDLERS.set(securityUuid, handler);\n  } catch (error) {\n    console.error('ensureLiveUpdateSubscription: Registrierung fehlgeschlagen', error);\n  }\n}\n\nfunction removeLiveUpdateSubscription(securityUuid: string): void {\n  if (!securityUuid || !LIVE_UPDATE_HANDLERS.has(securityUuid)) {\n    return;\n  }\n\n  const handler = LIVE_UPDATE_HANDLERS.get(securityUuid);\n  try {\n    if (handler) {\n      window.removeEventListener(LIVE_UPDATE_EVENT, handler as EventListener);\n    }\n  } catch (error) {\n    console.error('removeLiveUpdateSubscription: Entfernen des Listeners fehlgeschlagen', error);\n  }\n\n  LIVE_UPDATE_HANDLERS.delete(securityUuid);\n}\n\nfunction cleanupSecurityDetailState(securityUuid: string): void {\n  if (!securityUuid) {\n    return;\n  }\n\n  removeLiveUpdateSubscription(securityUuid);\n  invalidateHistoryCache(securityUuid);\n  // RANGE_STATE_REGISTRY intentionally left intact so the last chosen\n  // range remains active when the user reopens the security detail.\n}\n\nfunction setActiveRange(securityUuid: string, rangeKey: SecurityHistoryRangeKey): void {\n  if (!RANGE_STATE_REGISTRY.has(securityUuid)) {\n    RANGE_STATE_REGISTRY.set(securityUuid, { activeRange: rangeKey });\n    return;\n  }\n  const state = RANGE_STATE_REGISTRY.get(securityUuid);\n  if (state) {\n    state.activeRange = rangeKey;\n  }\n}\n\nfunction getActiveRange(securityUuid: string): SecurityHistoryRangeKey {\n  return (\n    RANGE_STATE_REGISTRY.get(securityUuid)?.activeRange ?? DEFAULT_HISTORY_RANGE\n  );\n}\n\nfunction toEpochDay(date: Date): number {\n  const epochMs = Date.UTC(\n    date.getUTCFullYear(),\n    date.getUTCMonth(),\n    date.getUTCDate(),\n  );\n  return Math.floor(epochMs / 86400000);\n}\n\nfunction normaliseDate(date: Date): Date {\n  const clone = new Date(date.getTime());\n  clone.setUTCHours(0, 0, 0, 0);\n  return clone;\n}\n\nfunction toFiniteNumber(value: unknown): number | null {\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n\n  if (typeof value === 'string' && value.trim() !== '') {\n    const parsed = Number.parseFloat(value);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return null;\n}\n\nfunction resolveRangeOptions(rangeKey: SecurityHistoryRangeKey): SecurityHistoryOptions {\n  const now = normaliseDate(new Date());\n  const rangeDays = RANGE_DAY_COUNTS[rangeKey];\n  const options: SecurityHistoryOptions = { end_date: toEpochDay(now) };\n\n  if (Number.isFinite(rangeDays) && rangeDays > 0) {\n    const start = new Date(now.getTime());\n    start.setUTCDate(start.getUTCDate() - (rangeDays - 1));\n    options.start_date = toEpochDay(start);\n  }\n\n  return options;\n}\n\nfunction parseHistoryDate(raw: unknown): Date | null {\n  if (!raw) {\n    return null;\n  }\n\n  if (raw instanceof Date && !Number.isNaN(raw.getTime())) {\n    return new Date(raw.getTime());\n  }\n\n  if (typeof raw === 'number' && Number.isFinite(raw)) {\n    const timestamp = raw * 86400000;\n    if (Number.isFinite(timestamp)) {\n      return new Date(timestamp);\n    }\n  }\n\n  if (typeof raw === 'string') {\n    const trimmed = raw.trim();\n    if (/^\\d{8}$/.test(trimmed)) {\n      const year = Number.parseInt(trimmed.slice(0, 4), 10);\n      const month = Number.parseInt(trimmed.slice(4, 6), 10) - 1;\n      const day = Number.parseInt(trimmed.slice(6, 8), 10);\n      if (\n        Number.isFinite(year) &&\n        Number.isFinite(month) &&\n        Number.isFinite(day)\n      ) {\n        const date = new Date(Date.UTC(year, month, day));\n        if (!Number.isNaN(date.getTime())) {\n          return date;\n        }\n      }\n    }\n\n    const parsed = Date.parse(trimmed);\n    if (Number.isFinite(parsed)) {\n      return new Date(parsed);\n    }\n  }\n\n  return null;\n}\n\nfunction normaliseHistorySeries(prices: unknown): NormalizedHistoryEntry[] {\n  if (!Array.isArray(prices)) {\n    return [];\n  }\n\n  return (prices as RawHistoryEntry[])\n    .map((entry) => {\n      const numericClose = toFiniteNumber(entry?.close);\n      if (numericClose == null) {\n        return null;\n      }\n\n      const dateValue = parseHistoryDate(entry?.date);\n\n      return {\n        date: dateValue ?? (entry?.date as Date | string | number),\n        close: numericClose / PRICE_SCALE,\n      };\n    })\n    .filter((entry): entry is NormalizedHistoryEntry => Boolean(entry));\n}\n\nfunction deriveFxRate(\n  snapshot: SecuritySnapshotDetail | null,\n  latestNativePrice: unknown,\n): number | null {\n  const currency = String(snapshot?.currency_code || '').toUpperCase();\n  if (!currency || currency === 'EUR') {\n    return 1;\n  }\n\n  const lastPriceEur = toFiniteNumber(snapshot?.last_price_eur);\n\n  if (lastPriceEur == null || lastPriceEur <= 0) {\n    return null;\n  }\n\n  const snapshotNative = toFiniteNumber(snapshot?.last_price_native);\n\n  if (snapshotNative != null && snapshotNative > 0) {\n    return lastPriceEur / snapshotNative;\n  }\n\n  const historyNative = toFiniteNumber(latestNativePrice);\n  if (historyNative != null && historyNative > 0) {\n    return lastPriceEur / historyNative;\n  }\n\n  return null;\n}\n\nfunction roundCurrency(value: unknown): number | null {\n  const numeric = toFiniteNumber(value);\n  if (numeric == null) {\n    return null;\n  }\n\n  const rounded = Math.round(numeric * 100) / 100;\n  return Object.is(rounded, -0) ? 0 : rounded;\n}\n\nfunction computeGainValues(\n  historySeries: readonly NormalizedHistoryEntry[],\n  holdings: unknown,\n  fxRate: number | null,\n): { periodGain: number | null; dailyGain: number | null } {\n  if (!Array.isArray(historySeries) || historySeries.length === 0) {\n    return { periodGain: null, dailyGain: null };\n  }\n\n  const holdingsNumeric = toFiniteNumber(holdings);\n  const safeHoldings = holdingsNumeric ?? 0;\n  const safeFx = typeof fxRate === 'number' && Number.isFinite(fxRate) && fxRate > 0\n    ? fxRate\n    : null;\n\n  if (safeFx == null) {\n    return { periodGain: null, dailyGain: null };\n  }\n\n  const lastEntry = historySeries[historySeries.length - 1];\n  const firstEntry = historySeries[0];\n  const previousEntry =\n    historySeries.length >= 2 ? historySeries[historySeries.length - 2] : null;\n\n  const periodDiff = (lastEntry.close - firstEntry.close) * safeHoldings * safeFx;\n  const dailyDiff = previousEntry\n    ? (lastEntry.close - previousEntry.close) * safeHoldings * safeFx\n    : null;\n\n  return {\n    periodGain: roundCurrency(periodDiff),\n    dailyGain: roundCurrency(dailyDiff),\n  };\n}\n\nfunction formatGainValue(value: number | null): string {\n  if (value == null || Number.isNaN(value)) {\n    return '<span class=\"value neutral\">—</span>';\n  }\n\n  return `<span class=\"value\">${formatGain(value)}</span>`;\n}\n\nfunction buildInfoBar(\n  rangeKey: SecurityHistoryRangeKey | string,\n  periodGain: number | null,\n  dailyGain: number | null,\n): string {\n  const rangeLabel = rangeKey ? rangeKey : '';\n  return `\n    <div class=\"security-info-bar\" data-range=\"${rangeLabel}\">\n      <div class=\"security-info-item\">\n        <span class=\"label\">Gesamt (${rangeLabel || 'Zeitraum'})</span>\n        ${formatGainValue(periodGain)}\n      </div>\n      <div class=\"security-info-item\">\n        <span class=\"label\">Letzter Tag</span>\n        ${formatGainValue(dailyGain)}\n      </div>\n    </div>\n  `;\n}\n\nfunction buildRangeSelector(activeRange: SecurityHistoryRangeKey): string {\n  const buttons = AVAILABLE_HISTORY_RANGES.map((rangeKey) => {\n    const activeClass = rangeKey === activeRange ? ' active' : '';\n    return `\n      <button\n        type=\"button\"\n        class=\"security-range-button${activeClass}\"\n        data-range=\"${rangeKey}\"\n        aria-pressed=\"${rangeKey === activeRange}\"\n      >\n        ${rangeKey}\n      </button>\n    `;\n  });\n\n  return `\n    <div class=\"security-range-selector\" role=\"group\" aria-label=\"Zeitraum\">\n      ${buttons.join('\\n')}\n    </div>\n  `;\n}\n\nfunction buildHistoryPlaceholder(\n  rangeKey: SecurityHistoryRangeKey,\n  state: HistoryPlaceholderState = { status: 'empty' },\n): string {\n  const safeRange = rangeKey || '';\n\n  switch (state.status) {\n    case 'loaded':\n      return `\n        <div\n          class=\"history-chart\"\n          data-state=\"loaded\"\n          data-range=\"${safeRange}\"\n          role=\"img\"\n          aria-label=\"Preisverlauf${safeRange ? ` für ${safeRange}` : ''}\"\n        ></div>\n      `;\n    case 'error': {\n      const message = state?.message\n        ? String(state.message)\n        : 'Die historischen Daten konnten nicht geladen werden.';\n      return `\n        <div class=\"history-placeholder\" data-state=\"error\" data-range=\"${safeRange}\">\n          <p>${message}</p>\n        </div>\n      `;\n    }\n    case 'empty':\n    default:\n      return `\n        <div class=\"history-placeholder\" data-state=\"empty\" data-range=\"${safeRange}\">\n          <p>Für dieses Wertpapier liegen im Zeitraum ${safeRange || 'den gewählten Zeitraum'} keine historischen Daten vor.</p>\n        </div>\n      `;\n  }\n}\n\nfunction formatHoldings(value: unknown): string {\n  const numeric = toFiniteNumber(value);\n  if (numeric == null) {\n    return '—';\n  }\n\n  const hasFraction = Math.abs(numeric % 1) > 0;\n  const minFraction = hasFraction ? 2 : HOLDINGS_FRACTION_DIGITS.min;\n  const maxFraction = hasFraction ? HOLDINGS_FRACTION_DIGITS.max : HOLDINGS_FRACTION_DIGITS.min;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: minFraction,\n    maximumFractionDigits: maxFraction,\n  });\n}\n\nfunction formatPrice(value: unknown): string {\n  const numeric = toFiniteNumber(value);\n  if (numeric == null) {\n    return '—';\n  }\n\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: PRICE_FRACTION_DIGITS.min,\n    maximumFractionDigits: PRICE_FRACTION_DIGITS.max,\n  });\n}\n\nfunction buildHeaderMeta(snapshot: SecuritySnapshotDetail | null): string {\n  if (!snapshot) {\n    return '<div class=\"meta-error\">Keine Snapshot-Daten verfügbar.</div>';\n  }\n\n  const currency = snapshot.currency_code || 'EUR';\n  const holdings = formatHoldings(snapshot.total_holdings);\n  const lastPriceNative =\n    snapshot.last_price_native ?? snapshot.last_price?.native ?? snapshot.last_price_eur;\n  const formattedLastPrice = formatPrice(lastPriceNative);\n  const lastPriceDisplay =\n    formattedLastPrice === '—'\n      ? '—'\n      : `${formattedLastPrice}${currency ? `&nbsp;${currency}` : ''}`;\n  const marketValueRaw =\n    toFiniteNumber(snapshot.market_value_eur) ??\n    toFiniteNumber(snapshot.current_value_eur) ??\n    0;\n  const marketValue = formatNumber(marketValueRaw);\n\n  return `\n    <div class=\"security-meta-grid\">\n      <div class=\"security-meta-item\">\n        <span class=\"label\">Währung</span>\n        <span class=\"value\">${currency}</span>\n      </div>\n      <div class=\"security-meta-item\">\n        <span class=\"label\">Bestand</span>\n        <span class=\"value\">${holdings}</span>\n      </div>\n      <div class=\"security-meta-item\">\n        <span class=\"label\">Letzter Preis (${currency})</span>\n        <span class=\"value\">${lastPriceDisplay}</span>\n      </div>\n      <div class=\"security-meta-item\">\n        <span class=\"label\">Marktwert (EUR)</span>\n        <span class=\"value\">${marketValue}&nbsp;€</span>\n      </div>\n    </div>\n  `;\n}\n\nfunction normaliseHistoryError(error: unknown): string | null {\n  if (!error) {\n    return null;\n  }\n\n  if (typeof error === 'string') {\n    return error;\n  }\n\n  if (error instanceof Error) {\n    return error.message || null;\n  }\n\n  try {\n    return JSON.stringify(error);\n  } catch (_jsonError) {\n    return String(error);\n  }\n}\n\nfunction getHistoryChartOptions(\n  host: HTMLElement,\n  series: readonly NormalizedHistoryEntry[],\n  { currency }: { currency?: string | null | undefined } = {},\n): LineChartOptions {\n  const measuredWidth = host.clientWidth || host.offsetWidth || 0;\n  const width = measuredWidth > 0 ? measuredWidth : 640;\n  const height = Math.min(Math.max(Math.floor(width * 0.55), 220), 420);\n  const safeCurrency = (currency || '').toUpperCase() || 'EUR';\n\n  return {\n    width,\n    height,\n    margin: { top: 16, right: 20, bottom: 32, left: 20 },\n    series,\n    yFormatter: (value) => formatPrice(value),\n    tooltipRenderer: ({ xFormatted, yFormatted }) => `\n      <div class=\"chart-tooltip-date\">${xFormatted}</div>\n      <div class=\"chart-tooltip-value\">${yFormatted}&nbsp;${safeCurrency}</div>\n    `,\n  };\n}\n\nconst HISTORY_CHART_INSTANCES = new WeakMap<\n  HTMLElement,\n  ReturnType<typeof renderLineChart>\n>();\n\nfunction renderHistoryChart(\n  host: HTMLElement,\n  series: readonly NormalizedHistoryEntry[],\n  options: { currency?: string | null | undefined } = {},\n): void {\n  if (!host || !Array.isArray(series) || series.length === 0) {\n    return;\n  }\n\n  const chartOptions = getHistoryChartOptions(host, series, options);\n  let chartContainer = HISTORY_CHART_INSTANCES.get(host) || null;\n\n  if (!chartContainer || !host.contains(chartContainer)) {\n    host.innerHTML = '';\n    chartContainer = renderLineChart(host, chartOptions);\n    if (chartContainer) {\n      HISTORY_CHART_INSTANCES.set(host, chartContainer);\n    }\n    return;\n  }\n\n  updateLineChart(chartContainer, chartOptions);\n}\n\nfunction updateRangeButtons(\n  container: HTMLElement | null,\n  activeRange: SecurityHistoryRangeKey,\n): void {\n  if (!container) {\n    return;\n  }\n\n  container.dataset.activeRange = activeRange;\n  container.querySelectorAll<HTMLButtonElement>('.security-range-button').forEach((button) => {\n    const rangeKey = button.dataset.range as SecurityHistoryRangeKey | undefined;\n    const isActive = rangeKey === activeRange;\n    button.classList.toggle('active', isActive);\n    button.setAttribute('aria-pressed', isActive ? 'true' : 'false');\n    button.disabled = false;\n    button.classList.remove('loading');\n  });\n}\n\nfunction updateInfoBarContent(\n  root: HTMLElement,\n  rangeKey: SecurityHistoryRangeKey,\n  periodGain: number | null,\n  dailyGain: number | null,\n): void {\n  const infoBar = root.querySelector('.security-info-bar');\n  if (!infoBar || !infoBar.parentElement) {\n    return;\n  }\n\n  const wrapper = document.createElement('div');\n  wrapper.innerHTML = buildInfoBar(rangeKey, periodGain, dailyGain).trim();\n  const fresh = wrapper.firstElementChild;\n  if (!fresh) {\n    return;\n  }\n  infoBar.parentElement.replaceChild(fresh, infoBar);\n}\n\nfunction updateHistoryPlaceholder(\n  root: HTMLElement,\n  rangeKey: SecurityHistoryRangeKey,\n  state: HistoryPlaceholderState,\n  historySeries: readonly NormalizedHistoryEntry[],\n  options: { currency?: string | null | undefined } = {},\n): void {\n  const placeholderContainer = root.querySelector('.security-detail-placeholder');\n  if (!placeholderContainer) {\n    return;\n  }\n\n  placeholderContainer.innerHTML = `\n    <h2>Historie</h2>\n    ${buildHistoryPlaceholder(rangeKey, state)}\n  `;\n\n  if (state?.status === 'loaded' && Array.isArray(historySeries) && historySeries.length) {\n    const host = placeholderContainer.querySelector<HTMLElement>('.history-chart');\n    if (host) {\n      requestAnimationFrame(() => {\n        renderHistoryChart(host, historySeries, options);\n      });\n    }\n  }\n}\n\ninterface ScheduleRangeSetupOptions {\n  root: HTMLElement;\n  hass: HomeAssistant | null | undefined;\n  panelConfig: PanelConfigLike | null | undefined;\n  securityUuid: string;\n  snapshot: SecuritySnapshotDetail | null;\n  holdings: unknown;\n  initialRange: SecurityHistoryRangeKey;\n  initialHistory: NormalizedHistoryEntry[];\n  initialHistoryState: HistoryPlaceholderState;\n}\n\nfunction scheduleRangeSetup(options: ScheduleRangeSetupOptions): void {\n  const {\n    root,\n    hass,\n    panelConfig,\n    securityUuid,\n    snapshot,\n    holdings,\n    initialRange,\n    initialHistory,\n    initialHistoryState,\n  } = options;\n\n  if (!root) {\n    return;\n  }\n\n  setTimeout(() => {\n    const rangeSelector = root.querySelector<HTMLElement>('.security-range-selector');\n    if (!rangeSelector) {\n      return;\n    }\n\n    const cache = ensureHistoryCache(securityUuid);\n    const shouldCacheInitial =\n      Array.isArray(initialHistory) && initialHistoryState?.status !== 'error';\n    if (shouldCacheInitial) {\n      cache.set(initialRange, initialHistory);\n    }\n\n    ensureLiveUpdateSubscription(securityUuid);\n\n    setActiveRange(securityUuid, initialRange);\n    updateRangeButtons(rangeSelector, initialRange);\n    if (initialHistoryState) {\n      updateHistoryPlaceholder(\n        root,\n        initialRange,\n        initialHistoryState,\n        initialHistory,\n        { currency: snapshot?.currency_code },\n      );\n    }\n\n    const handleRangeClick = async (rangeKey: SecurityHistoryRangeKey): Promise<void> => {\n      if (!rangeKey || rangeKey === getActiveRange(securityUuid)) {\n        return;\n      }\n\n      const button = rangeSelector.querySelector<HTMLButtonElement>(\n        `.security-range-button[data-range=\"${rangeKey}\"]`,\n      );\n      if (button) {\n        button.disabled = true;\n        button.classList.add('loading');\n      }\n\n      let historySeries = cache.get(rangeKey) || null;\n      let historyState: HistoryPlaceholderState | null = null;\n      if (!historySeries) {\n        try {\n          const rangeOptions = resolveRangeOptions(rangeKey);\n          const historyResponse = await fetchSecurityHistoryWS(\n            hass,\n            panelConfig,\n            securityUuid,\n            rangeOptions,\n          );\n          historySeries = normaliseHistorySeries(historyResponse?.prices);\n          cache.set(rangeKey, historySeries);\n          historyState = historySeries.length\n            ? { status: 'loaded' }\n            : { status: 'empty' };\n        } catch (error) {\n          console.error('Range-Wechsel: Historie konnte nicht geladen werden', error);\n          historySeries = [];\n          const message = normaliseHistoryError(error);\n          historyState = {\n            status: 'error',\n            message:\n              message ||\n              'Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden.',\n          };\n        }\n      } else {\n        historyState = historySeries.length\n          ? { status: 'loaded' }\n          : { status: 'empty' };\n      }\n\n      const lastClose = historySeries.length\n        ? historySeries[historySeries.length - 1].close\n        : snapshot?.last_price_native;\n      const activeFxRate = deriveFxRate(snapshot, lastClose);\n      const { periodGain, dailyGain } = computeGainValues(\n        historySeries,\n        holdings,\n        activeFxRate,\n      );\n\n      setActiveRange(securityUuid, rangeKey);\n      updateRangeButtons(rangeSelector, rangeKey);\n      updateInfoBarContent(root, rangeKey, periodGain, dailyGain);\n      updateHistoryPlaceholder(\n        root,\n        rangeKey,\n        historyState,\n        historySeries,\n        { currency: snapshot?.currency_code },\n      );\n    };\n\n    rangeSelector.addEventListener('click', (event) => {\n      const button = (event.target as HTMLElement | null)?.closest<HTMLButtonElement>('.security-range-button');\n      if (!button || button.disabled) {\n        return;\n      }\n      const { range } = button.dataset;\n      if (!range || !AVAILABLE_HISTORY_RANGES.includes(range as SecurityHistoryRangeKey)) {\n        return;\n      }\n      handleRangeClick(range as SecurityHistoryRangeKey);\n    });\n  }, 0);\n}\n\nexport async function renderSecurityDetail(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panelConfig: PanelConfigLike | null | undefined,\n  securityUuid: string | null | undefined,\n): Promise<string> {\n  if (!securityUuid) {\n    console.error('renderSecurityDetail: securityUuid fehlt');\n    return '<div class=\"card\"><h2>Fehler</h2><p>Kein Wertpapier angegeben.</p></div>';\n  }\n\n  const cachedSnapshot = getCachedSecuritySnapshot(securityUuid);\n  let snapshot: SecuritySnapshotDetail | null = null;\n  let error: string | null = null;\n\n  try {\n    const response: SecuritySnapshotResponse = await fetchSecuritySnapshotWS(\n      hass,\n      panelConfig,\n      securityUuid,\n    );\n    if (response && typeof response === 'object') {\n      snapshot =\n        response.snapshot && typeof response.snapshot === 'object'\n          ? (response.snapshot as SecuritySnapshotDetail)\n          : (response as unknown as SecuritySnapshotDetail);\n    } else {\n      snapshot = response as unknown as SecuritySnapshotDetail;\n    }\n  } catch (err) {\n    console.error('renderSecurityDetail: Snapshot konnte nicht geladen werden', err);\n    error = err instanceof Error ? err.message : String(err);\n  }\n\n  const effectiveSnapshot = snapshot || cachedSnapshot;\n  const fallbackUsed = Boolean(cachedSnapshot && !snapshot);\n  const flaggedAsCache = (effectiveSnapshot?.source ?? '') === 'cache';\n  const staleNotice =\n    effectiveSnapshot && (fallbackUsed || flaggedAsCache)\n      ? buildCachedSnapshotNotice({ fallbackUsed, flaggedAsCache })\n      : '';\n  const headerTitle = effectiveSnapshot?.name || 'Wertpapierdetails';\n  const headerCard = createHeaderCard(headerTitle, buildHeaderMeta(effectiveSnapshot));\n\n  if (error) {\n    return `\n      ${headerCard.outerHTML}\n      ${staleNotice}\n      <div class=\"card error-card\">\n        <h2>Fehler beim Laden</h2>\n        <p>${error}</p>\n      </div>\n    `;\n  }\n\n  const activeRange = getActiveRange(securityUuid);\n  const cache = ensureHistoryCache(securityUuid);\n  let historySeries = cache.has(activeRange) ? cache.get(activeRange) ?? null : null;\n  let historyState: HistoryPlaceholderState = { status: 'empty' };\n\n  if (Array.isArray(historySeries)) {\n    historyState = historySeries.length\n      ? { status: 'loaded' }\n      : { status: 'empty' };\n  } else {\n    historySeries = [];\n    try {\n      const rangeOptions = resolveRangeOptions(activeRange);\n      const historyResponse: SecurityHistoryResponse = await fetchSecurityHistoryWS(\n        hass,\n        panelConfig,\n        securityUuid,\n        rangeOptions,\n      );\n      historySeries = normaliseHistorySeries(historyResponse?.prices);\n      cache.set(activeRange, historySeries);\n      historyState = historySeries.length\n        ? { status: 'loaded' }\n        : { status: 'empty' };\n    } catch (historyError) {\n      console.error(\n        'renderSecurityDetail: Historie konnte nicht geladen werden',\n        historyError,\n      );\n      const message = normaliseHistoryError(historyError);\n      historyState = {\n        status: 'error',\n        message:\n          message ||\n          'Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden.',\n      };\n    }\n  }\n\n  const latestNativePrice =\n    historySeries.length > 0\n      ? historySeries[historySeries.length - 1].close\n      : effectiveSnapshot?.last_price_native;\n  const fxRate = deriveFxRate(effectiveSnapshot, latestNativePrice);\n  const holdings = effectiveSnapshot?.total_holdings ?? 0;\n  const { periodGain, dailyGain } = computeGainValues(\n    historySeries,\n    holdings,\n    fxRate,\n  );\n  const infoBar = buildInfoBar(activeRange, periodGain, dailyGain);\n\n  scheduleRangeSetup({\n    root,\n    hass,\n    panelConfig,\n    securityUuid,\n    snapshot: effectiveSnapshot,\n    holdings,\n    initialRange: activeRange,\n    initialHistory: historySeries,\n    initialHistoryState: historyState,\n  });\n\n  return `\n    ${headerCard.outerHTML}\n    ${staleNotice}\n    ${infoBar}\n    ${buildRangeSelector(activeRange)}\n    <div class=\"card security-detail-placeholder\">\n      <h2>Historie</h2>\n      ${buildHistoryPlaceholder(activeRange, historyState)}\n    </div>\n  `;\n}\n\ninterface RegisterSecurityDetailTabOptions {\n  setSecurityDetailTabFactory?: ((\n    factory: (securityUuid: string) => {\n      title: string;\n      render: DashboardTabRenderFn;\n      cleanup: (context?: { key: string }) => void;\n    },\n  ) => void) | null;\n}\n\nexport function registerSecurityDetailTab(\n  options: RegisterSecurityDetailTabOptions,\n): void {\n  const { setSecurityDetailTabFactory } = options;\n  if (typeof setSecurityDetailTabFactory !== 'function') {\n    console.error('registerSecurityDetailTab: Ungültige Factory-Funktion übergeben');\n    return;\n  }\n\n  setSecurityDetailTabFactory((securityUuid) => ({\n    title: 'Wertpapier',\n    render: (root, hass, panelConfig) => renderSecurityDetail(root, hass, panelConfig, securityUuid),\n    cleanup: () => cleanupSecurityDetailState(securityUuid),\n  }));\n}\n","/**\n * Mirrors the legacy dashboard controller for initial TypeScript migration.\n */\n\nimport { addSwipeEvents as addSwipeEventsUnsafe } from './interaction/tab_control';\nimport { renderDashboard, attachPortfolioToggleHandler } from './tabs/overview';\nimport { registerSecurityDetailTab } from './tabs/security_detail';\nimport {\n  handleAccountUpdate,\n  handleLastFileUpdate,\n  handlePortfolioUpdate,\n  handlePortfolioPositionsUpdate,\n} from './data/updateConfigsWS';\nimport { getEntryId } from './data/api';\nimport type {\n  DashboardTabDescriptor,\n  PanelConfigLike,\n} from './tabs/types';\nimport type {\n  HassEvent,\n  HassPanel,\n  HassPanels,\n  HassRoute,\n  HassUnsubscribe,\n  HomeAssistant,\n} from './types/home-assistant';\n\ntype AddSwipeEvents = (\n  element: HTMLElement,\n  onSwipeLeft: () => void,\n  onSwipeRight: () => void,\n) => void;\n\nconst addSwipeEvents = addSwipeEventsUnsafe as AddSwipeEvents;\n\ntype PanelLike = PanelConfigLike | HassPanel | null | undefined;\n\ntype AccountsUpdatePayload = Parameters<typeof handleAccountUpdate>[0];\ntype LastFileUpdatePayload = Parameters<typeof handleLastFileUpdate>[0];\ntype PortfolioValuesUpdatePayload = Parameters<typeof handlePortfolioUpdate>[0];\ntype PortfolioPositionsUpdatePayload = Parameters<typeof handlePortfolioPositionsUpdate>[0];\n\ntype PortfolioPositionsSingleUpdate = Extract<\n  PortfolioPositionsUpdatePayload,\n  Record<string, unknown>\n>;\n\ntype PortfolioPositionsArrayUpdate = Extract<\n  PortfolioPositionsUpdatePayload,\n  readonly unknown[]\n>;\n\ntype DashboardUpdateType =\n  | 'accounts'\n  | 'last_file_update'\n  | 'portfolio_values'\n  | 'portfolio_positions';\n\ntype DashboardUpdatePayloadMap = {\n  accounts: AccountsUpdatePayload;\n  last_file_update: LastFileUpdatePayload;\n  portfolio_values: PortfolioValuesUpdatePayload;\n  portfolio_positions: PortfolioPositionsUpdatePayload;\n};\n\ntype DashboardUpdateQueueEntry<T extends DashboardUpdateType = DashboardUpdateType> = {\n  type: T;\n  data: DashboardUpdatePayloadMap[T] | null | undefined;\n  portfolioUuid?: string | null;\n};\n\ninterface PanelsUpdatedEventData {\n  entry_id?: string | null;\n  data_type?: string | null;\n  data?: unknown;\n  [key: string]: unknown;\n}\n\ntype PanelsUpdatedEvent = HassEvent<PanelsUpdatedEventData>;\n\ninterface DashboardElement extends HTMLElement {\n  rememberScrollPosition?: (page?: number) => void;\n  _renderIfInitialized?: () => void;\n  _render?: () => void;\n}\n\nconst STICKY_HEADER_ANCHOR_ID = 'pp-reader-sticky-anchor';\nconst OVERVIEW_TAB_KEY = 'overview';\nconst SECURITY_DETAIL_TAB_PREFIX = 'security:';\n\nconst baseTabs: DashboardTabDescriptor[] = [\n  { key: OVERVIEW_TAB_KEY, title: 'Dashboard', render: renderDashboard },\n];\n\nconst detailTabRegistry = new Map<string, DashboardTabDescriptor>();\nconst detailTabOrder: string[] = [];\nconst securityTabLookup = new Map<string, string>();\n\nlet securityDetailTabFactory: DetailTabFactory | null = null;\nlet navigationInProgress = false;\nlet lastClosedSecurityUuid: string | null = null;\nlet currentPage = 0;\nlet observer: IntersectionObserver | null = null;\n\ntype DetailTabDescriptorInput = {\n  title: string;\n  render: DashboardTabDescriptor['render'];\n  cleanup?: DashboardTabDescriptor['cleanup'];\n  key?: string;\n  [key: string]: unknown;\n};\ntype DetailTabFactory = (securityUuid: string) => DetailTabDescriptorInput | null | undefined;\n\nfunction isRecord(value: unknown): value is Record<string, unknown> {\n  return typeof value === 'object' && value !== null;\n}\n\nfunction isDashboardUpdateType(value: unknown): value is DashboardUpdateType {\n  return (\n    value === 'accounts' ||\n    value === 'last_file_update' ||\n    value === 'portfolio_values' ||\n    value === 'portfolio_positions'\n  );\n}\n\nfunction extractPortfolioUuidFromSingleUpdate(\n  update: PortfolioPositionsSingleUpdate,\n): string | null {\n  const uuidCandidate = update.portfolio_uuid;\n  if (typeof uuidCandidate === 'string' && uuidCandidate) {\n    return uuidCandidate;\n  }\n  const camelCaseCandidate = (update as Record<string, unknown>).portfolioUuid;\n  if (typeof camelCaseCandidate === 'string' && camelCaseCandidate) {\n    return camelCaseCandidate;\n  }\n  return null;\n}\n\nfunction extractPortfolioUuidFromPositionsUpdate(\n  update: PortfolioPositionsUpdatePayload | null | undefined,\n): string | null {\n  if (!update) {\n    return null;\n  }\n  if (Array.isArray(update)) {\n    for (const item of update as PortfolioPositionsArrayUpdate) {\n      if (isRecord(item)) {\n        const uuid = extractPortfolioUuidFromSingleUpdate(item as PortfolioPositionsSingleUpdate);\n        if (uuid) {\n          return uuid;\n        }\n      }\n    }\n    return null;\n  }\n  if (!isRecord(update)) {\n    return null;\n  }\n  return extractPortfolioUuidFromSingleUpdate(update as PortfolioPositionsSingleUpdate);\n}\n\nfunction normalizeDashboardUpdate(\n  dataType: DashboardUpdateType,\n  data: unknown,\n): DashboardUpdateQueueEntry | null {\n  switch (dataType) {\n    case 'accounts':\n      return {\n        type: dataType,\n        data: Array.isArray(data) ? (data as AccountsUpdatePayload) : null,\n      };\n    case 'last_file_update':\n      if (typeof data === 'string') {\n        return { type: dataType, data: data as LastFileUpdatePayload };\n      }\n      if (isRecord(data)) {\n        return { type: dataType, data: data as LastFileUpdatePayload };\n      }\n      return { type: dataType, data: null };\n    case 'portfolio_values':\n      if (Array.isArray(data)) {\n        return { type: dataType, data: data as PortfolioValuesUpdatePayload };\n      }\n      return { type: dataType, data: null };\n    case 'portfolio_positions':\n      if (Array.isArray(data)) {\n        return { type: dataType, data: data as PortfolioPositionsUpdatePayload };\n      }\n      if (isRecord(data)) {\n        return { type: dataType, data: data as PortfolioPositionsUpdatePayload };\n      }\n      return { type: dataType, data: null };\n    default:\n      return null;\n  }\n}\n\nfunction extractSecurityUuidFromKey(key: string | null | undefined): string | null {\n  if (typeof key !== 'string' || !key.startsWith(SECURITY_DETAIL_TAB_PREFIX)) {\n    return null;\n  }\n\n  const uuid = key.slice(SECURITY_DETAIL_TAB_PREFIX.length);\n  return uuid || null;\n}\n\nfunction tryReopenLastDetail(): boolean {\n  if (!lastClosedSecurityUuid) {\n    return false;\n  }\n\n  const reopened = openSecurityDetail(lastClosedSecurityUuid);\n  if (!reopened) {\n    lastClosedSecurityUuid = null;\n  }\n  return reopened;\n}\n\nfunction getVisibleTabs(): DashboardTabDescriptor[] {\n  const detailTabs = detailTabOrder\n    .map((key) => detailTabRegistry.get(key))\n    .filter((descriptor): descriptor is DashboardTabDescriptor => Boolean(descriptor));\n\n  return [...baseTabs, ...detailTabs];\n}\nfunction rememberCurrentPageScroll(): void {\n  try {\n    const dashboardElement = findDashboardElement();\n    if (dashboardElement && typeof dashboardElement.rememberScrollPosition === 'function') {\n      dashboardElement.rememberScrollPosition();\n    }\n  } catch (error) {\n    console.warn('rememberCurrentPageScroll: konnte Scroll-Position nicht sichern', error);\n  }\n}\n\nfunction clampPageIndex(index: number): number {\n  const tabs = getVisibleTabs();\n  if (!tabs.length) {\n    return 0;\n  }\n  if (index < 0) {\n    return 0;\n  }\n  if (index >= tabs.length) {\n    return tabs.length - 1;\n  }\n  return index;\n}\n\nasync function navigateToPage(\n  targetIndex: number,\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): Promise<void> {\n  const tabs = getVisibleTabs();\n  const clampedIndex = clampPageIndex(targetIndex);\n  if (clampedIndex === currentPage) {\n    if (targetIndex > currentPage) {\n      tryReopenLastDetail();\n    }\n    return;\n  }\n\n  rememberCurrentPageScroll();\n\n  const currentTab = tabs[currentPage];\n  const currentSecurityUuid = extractSecurityUuidFromKey(currentTab?.key);\n  let nextIndex = clampedIndex;\n\n  if (currentSecurityUuid) {\n    const intendedTarget = tabs[clampedIndex];\n    if (intendedTarget?.key === OVERVIEW_TAB_KEY) {\n      const closed = closeSecurityDetail(currentSecurityUuid, { suppressRender: true });\n      if (closed) {\n        const updatedTabs = getVisibleTabs();\n        const overviewIndex = updatedTabs.findIndex((tab) => tab.key === OVERVIEW_TAB_KEY);\n        nextIndex = overviewIndex >= 0 ? overviewIndex : 0;\n      }\n    }\n  }\n\n  if (navigationInProgress) {\n    return;\n  }\n\n  navigationInProgress = true;\n  try {\n    currentPage = clampPageIndex(nextIndex);\n    await renderTab(root, hass, panel);\n  } catch (error) {\n    console.error('navigateToPage: Fehler beim Rendern des Tabs', error);\n  } finally {\n    navigationInProgress = false;\n  }\n}\n\nfunction navigateByDelta(\n  delta: number,\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): void {\n  void navigateToPage(currentPage + delta, root, hass, panel);\n}\n\nexport function registerDetailTab(\n  key: string,\n  descriptor: DetailTabDescriptorInput | null | undefined,\n): void {\n  if (!key || !descriptor || typeof descriptor.render !== 'function') {\n    console.error('registerDetailTab: Ungültiger Tab-Descriptor', key, descriptor);\n    return;\n  }\n\n  const securityUuid = extractSecurityUuidFromKey(key);\n  if (securityUuid) {\n    const existingKey = securityTabLookup.get(securityUuid);\n    if (existingKey && existingKey !== key) {\n      unregisterDetailTab(existingKey);\n    }\n  }\n\n  const normalizedDescriptor: DashboardTabDescriptor = {\n    ...descriptor,\n    key,\n  };\n\n  detailTabRegistry.set(key, normalizedDescriptor);\n\n  if (securityUuid) {\n    securityTabLookup.set(securityUuid, key);\n  }\n\n  if (!detailTabOrder.includes(key)) {\n    detailTabOrder.push(key);\n  }\n}\n\nexport function unregisterDetailTab(key: string | null | undefined): void {\n  if (!key) {\n    return;\n  }\n\n  const descriptor = detailTabRegistry.get(key);\n  if (descriptor && typeof descriptor.cleanup === 'function') {\n    try {\n      descriptor.cleanup({ key });\n    } catch (error) {\n      console.error('unregisterDetailTab: Fehler beim Ausführen von cleanup', error);\n    }\n  }\n\n  detailTabRegistry.delete(key);\n\n  const index = detailTabOrder.indexOf(key);\n  if (index >= 0) {\n    detailTabOrder.splice(index, 1);\n  }\n\n  const securityUuid = extractSecurityUuidFromKey(key);\n  if (securityUuid && securityTabLookup.get(securityUuid) === key) {\n    securityTabLookup.delete(securityUuid);\n  }\n}\n\nexport function hasDetailTab(key: string): boolean {\n  return detailTabRegistry.has(key);\n}\n\nexport function getDetailTabDescriptor(key: string): DashboardTabDescriptor | null {\n  return detailTabRegistry.get(key) ?? null;\n}\n\nexport function setSecurityDetailTabFactory(\n  factory: DetailTabFactory | null | undefined,\n): void {\n  if (factory != null && typeof factory !== 'function') {\n    console.error('setSecurityDetailTabFactory: Erwartet Funktion oder null', factory);\n    return;\n  }\n\n  securityDetailTabFactory = factory ?? null;\n}\n\nfunction getSecurityDetailTabKey(securityUuid: string): string {\n  return `${SECURITY_DETAIL_TAB_PREFIX}${securityUuid}`;\n}\n\nfunction findDashboardElement(): DashboardElement | null {\n  const registered = window.__ppReaderDashboardElements;\n  if (registered instanceof Set) {\n    for (const element of registered) {\n      if (element && element.isConnected) {\n        return element as DashboardElement;\n      }\n    }\n  }\n\n  const direct = document.querySelector<DashboardElement>('pp-reader-dashboard');\n  if (direct) {\n    return direct;\n  }\n\n  const panelElements = document.querySelectorAll<HTMLElement>('pp-reader-panel');\n  for (const panelElement of panelElements) {\n    if (!panelElement || !panelElement.shadowRoot) {\n      continue;\n    }\n\n    const nested = panelElement.shadowRoot.querySelector<DashboardElement>('pp-reader-dashboard');\n    if (nested) {\n      return nested;\n    }\n  }\n\n  return null;\n}\n\nfunction requestDashboardRender(): void {\n  const dashboardElement = findDashboardElement();\n  if (!dashboardElement) {\n    console.warn('requestDashboardRender: Kein pp-reader-dashboard Element gefunden');\n    return;\n  }\n\n  if (typeof dashboardElement._renderIfInitialized === 'function') {\n    dashboardElement._renderIfInitialized();\n    return;\n  }\n\n  if (typeof dashboardElement._render === 'function') {\n    dashboardElement._render();\n  }\n}\n\nexport function openSecurityDetail(securityUuid: string | null | undefined): boolean {\n  if (!securityUuid) {\n    console.error('openSecurityDetail: Ungültige securityUuid', securityUuid);\n    return false;\n  }\n\n  const tabKey = getSecurityDetailTabKey(securityUuid);\n  let descriptor = getDetailTabDescriptor(tabKey);\n\n  if (!descriptor && typeof securityDetailTabFactory === 'function') {\n    try {\n      const maybeDescriptor = securityDetailTabFactory(securityUuid);\n      if (maybeDescriptor && typeof maybeDescriptor.render === 'function') {\n        registerDetailTab(tabKey, maybeDescriptor);\n        descriptor = getDetailTabDescriptor(tabKey);\n      } else {\n        console.error('openSecurityDetail: Factory lieferte ungültigen Descriptor', maybeDescriptor);\n      }\n    } catch (error) {\n      console.error('openSecurityDetail: Fehler beim Erzeugen des Tab-Descriptors', error);\n    }\n  }\n\n  if (!descriptor) {\n    console.warn(`openSecurityDetail: Kein Detail-Tab für ${securityUuid} verfügbar`);\n    return false;\n  }\n\n  rememberCurrentPageScroll();\n\n  const tabs = getVisibleTabs();\n  let targetIndex = tabs.findIndex((tab) => tab.key === tabKey);\n\n  if (targetIndex === -1) {\n    const updatedTabs = getVisibleTabs();\n    targetIndex = updatedTabs.findIndex((tab) => tab.key === tabKey);\n    if (targetIndex === -1) {\n      console.error('openSecurityDetail: Tab nach Registrierung nicht auffindbar');\n      return false;\n    }\n  }\n\n  currentPage = targetIndex;\n  lastClosedSecurityUuid = null;\n  requestDashboardRender();\n  return true;\n}\n\ninterface CloseSecurityDetailOptions {\n  suppressRender?: boolean;\n}\n\nexport function closeSecurityDetail(\n  securityUuid: string | null | undefined,\n  options: CloseSecurityDetailOptions = {},\n): boolean {\n  if (!securityUuid) {\n    console.error('closeSecurityDetail: Ungültige securityUuid', securityUuid);\n    return false;\n  }\n\n  const { suppressRender = false } = options;\n\n  const tabKey = getSecurityDetailTabKey(securityUuid);\n  if (!hasDetailTab(tabKey)) {\n    return false;\n  }\n\n  const tabsBefore = getVisibleTabs();\n  const tabIndexBefore = tabsBefore.findIndex((tab) => tab.key === tabKey);\n  const wasActive = tabIndexBefore === currentPage;\n\n  unregisterDetailTab(tabKey);\n\n  const tabsAfter = getVisibleTabs();\n  if (!tabsAfter.length) {\n    currentPage = 0;\n    if (!suppressRender) {\n      requestDashboardRender();\n    }\n    return true;\n  }\n\n  lastClosedSecurityUuid = securityUuid;\n\n  if (wasActive) {\n    const overviewIndex = tabsAfter.findIndex((tab) => tab.key === OVERVIEW_TAB_KEY);\n    if (overviewIndex >= 0) {\n      currentPage = overviewIndex;\n    } else {\n      currentPage = Math.min(Math.max(tabIndexBefore - 1, 0), tabsAfter.length - 1);\n    }\n  } else if (currentPage >= tabsAfter.length) {\n    currentPage = Math.max(0, tabsAfter.length - 1);\n  }\n\n  if (!suppressRender) {\n    requestDashboardRender();\n  }\n  return true;\n}\nasync function renderTab(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): Promise<void> {\n  let effectivePanel = panel;\n  if (!effectivePanel && hass?.panels) {\n    const panels: HassPanels = hass.panels;\n    effectivePanel =\n      panels.ppreader ||\n      panels.pp_reader ||\n      Object.values(panels).find((p) => p?.webcomponent_name === 'pp-reader-panel') ||\n      null;\n  }\n\n  const tabs = getVisibleTabs();\n  if (currentPage >= tabs.length) {\n    currentPage = Math.max(0, tabs.length - 1);\n  }\n\n  const tab = tabs[currentPage];\n  if (!tab || typeof tab.render !== 'function') {\n    console.error('renderTab: Kein gültiger Tab oder keine render-Methode gefunden!');\n    return;\n  }\n\n  let content: string | void;\n  try {\n    content = await tab.render(root, hass, effectivePanel);\n  } catch (error) {\n    console.error('renderTab: Fehler beim Rendern des Tabs:', error);\n    root.innerHTML = `<div class=\"card\"><h2>Fehler</h2><pre>${(error as Error)?.message || error}</pre></div>`;\n    return;\n  }\n\n  if (!root) {\n    console.error('renderTab: Root-Element nicht gefunden!');\n    return;\n  }\n\n  root.innerHTML = content ?? '';\n\n  if (tab.render === renderDashboard) {\n    attachPortfolioToggleHandler(root);\n  }\n\n  const waitForHeaderCard = (): Promise<HTMLElement> =>\n    new Promise((resolve) => {\n      const interval = window.setInterval(() => {\n        const headerCard = root.querySelector<HTMLElement>('.header-card');\n        if (headerCard) {\n          clearInterval(interval);\n          resolve(headerCard);\n        }\n      }, 50);\n    });\n\n  const headerCard = await waitForHeaderCard();\n  if (!headerCard) {\n    console.error('Header-Card nicht gefunden!');\n    return;\n  }\n\n  let anchor = root.querySelector<HTMLElement>(`#${STICKY_HEADER_ANCHOR_ID}`);\n  if (!anchor) {\n    anchor = document.createElement('div');\n    anchor.id = STICKY_HEADER_ANCHOR_ID;\n    const parent = headerCard.parentNode as (ParentNode & Node) | null;\n    if (parent && 'insertBefore' in parent) {\n      parent.insertBefore(anchor, headerCard);\n    }\n  }\n\n  setupNavigation(root, hass, panel);\n  setupSwipeOnHeaderCard(root, hass, panel);\n  setupHeaderScrollBehavior(root);\n}\n\nfunction setupHeaderScrollBehavior(root: HTMLElement): void {\n  const headerCard = root.querySelector<HTMLElement>('.header-card');\n  const scrollBorder = root;\n  const anchor = root.querySelector<HTMLElement>(`#${STICKY_HEADER_ANCHOR_ID}`);\n\n  if (!headerCard || !scrollBorder || !anchor) {\n    console.error('Fehlende Elemente für das Scrollverhalten: headerCard, scrollBorder oder anchor.');\n    return;\n  }\n\n  observer?.disconnect();\n\n  observer = new IntersectionObserver(\n    ([entry]) => {\n      if (!entry.isIntersecting) {\n        headerCard.classList.add('sticky');\n      } else {\n        headerCard.classList.remove('sticky');\n      }\n    },\n    {\n      root: null,\n      rootMargin: '0px 0px 0px 0px',\n      threshold: 0,\n    },\n  );\n\n  observer.observe(anchor);\n}\n\nfunction setupSwipeOnHeaderCard(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): void {\n  const headerCard = root.querySelector<HTMLElement>('.header-card');\n  if (!headerCard) {\n    console.error('Header-Card nicht gefunden!');\n    return;\n  }\n\n  addSwipeEvents(\n    headerCard,\n    () => navigateByDelta(1, root, hass, panel),\n    () => navigateByDelta(-1, root, hass, panel),\n  );\n}\n\nfunction setupNavigation(\n  root: HTMLElement,\n  hass: HomeAssistant | null | undefined,\n  panel: PanelLike,\n): void {\n  const headerCard = root.querySelector<HTMLElement>('.header-card');\n  if (!headerCard) {\n    console.error('Header-Card nicht gefunden!');\n    return;\n  }\n\n  const navLeft = headerCard.querySelector<HTMLButtonElement>('#nav-left');\n  const navRight = headerCard.querySelector<HTMLButtonElement>('#nav-right');\n\n  if (!navLeft || !navRight) {\n    console.error('Navigationspfeile nicht gefunden!');\n    return;\n  }\n\n  navLeft.addEventListener('click', () => {\n    navigateByDelta(-1, root, hass, panel);\n  });\n\n  navRight.addEventListener('click', () => {\n    navigateByDelta(1, root, hass, panel);\n  });\n\n  updateNavigationState(headerCard);\n}\n\nfunction updateNavigationState(headerCard: HTMLElement): void {\n  const navLeft = headerCard.querySelector<HTMLButtonElement>('#nav-left');\n  const navRight = headerCard.querySelector<HTMLButtonElement>('#nav-right');\n\n  if (navLeft) {\n    if (currentPage === 0) {\n      navLeft.disabled = true;\n      navLeft.classList.add('disabled');\n    } else {\n      navLeft.disabled = false;\n      navLeft.classList.remove('disabled');\n    }\n  }\n\n  if (navRight) {\n    const tabs = getVisibleTabs();\n    const atEnd = currentPage === tabs.length - 1;\n    const shouldEnable = !atEnd || !!lastClosedSecurityUuid;\n    navRight.disabled = !shouldEnable;\n    navRight.classList.toggle('disabled', !shouldEnable);\n  }\n}\n\nclass PPReaderDashboard extends HTMLElement {\n  private _root: HTMLElement;\n\n  private _hass: HomeAssistant | null = null;\n\n  private _panel: PanelLike = null;\n\n  private _narrow: boolean | null = null;\n\n  private _route: HassRoute | null = null;\n\n  private _lastPanel: PanelLike = null;\n\n  private _lastNarrow: boolean | null = null;\n\n  private _lastRoute: HassRoute | null = null;\n\n  private _lastPage: number | null = null;\n\n  private _scrollPositions: Record<number, number> = {};\n\n  private _unsubscribeEvents: HassUnsubscribe | null = null;\n\n  private _initialized = false;\n\n  private _hasNewData = false;\n\n  private _pendingUpdates: DashboardUpdateQueueEntry[] = [];\n\n  private _entryIdWaitWarned = false;\n\n  constructor() {\n    super();\n    this._root = document.createElement('div');\n    this._root.className = 'pp-reader-dashboard';\n    this.appendChild(this._root);\n  }\n\n  set hass(hass: HomeAssistant | null | undefined) {\n    this._hass = hass ?? null;\n    this._checkInitialization();\n  }\n\n  set panel(panel: PanelLike) {\n    if (this._panel === panel) {\n      return;\n    }\n    this._panel = panel ?? null;\n    this._checkInitialization();\n  }\n\n  set narrow(narrow: boolean | null | undefined) {\n    if (this._narrow === (narrow ?? null)) {\n      return;\n    }\n    this._narrow = narrow ?? null;\n    this._renderIfInitialized();\n  }\n\n  set route(route: HassRoute | null | undefined) {\n    if (this._route === (route ?? null)) {\n      return;\n    }\n    this._route = route ?? null;\n    this._renderIfInitialized();\n  }\n\n  connectedCallback(): void {\n    this._checkInitialization();\n  }\n\n  disconnectedCallback(): void {\n    this._removeEventListeners();\n  }\n\n  public _checkInitialization(): void {\n    if (!this._hass || this._initialized) {\n      return;\n    }\n\n    if (!this._panel && this._hass.panels) {\n      const panels: HassPanels = this._hass.panels;\n      this._panel =\n        panels.ppreader ||\n        panels.pp_reader ||\n        (Object.values(panels).find(\n          (panelConfig) => panelConfig?.webcomponent_name === 'pp-reader-panel',\n        ) as PanelLike) ||\n        null;\n    }\n\n    const entryId = getEntryId(this._hass, this._panel);\n    if (!entryId) {\n      if (!this._entryIdWaitWarned) {\n        console.warn('PPReaderDashboard: kein entry_id ermittelbar – warte auf Panel-Konfiguration.');\n        this._entryIdWaitWarned = true;\n      }\n      return;\n    }\n\n    this._entryIdWaitWarned = false;\n    console.debug('PPReaderDashboard: entry_id (fallback) =', entryId);\n    this._initialized = true;\n    this._initializeEventListeners();\n    this._render();\n  }\n\n  private _initializeEventListeners(): void {\n    this._removeEventListeners();\n\n    const conn = this._hass?.connection;\n    if (!conn || typeof conn.subscribeEvents !== 'function') {\n      console.error('PPReaderDashboard: keine valide WebSocket-Verbindung oder subscribeEvents fehlt');\n      return;\n    }\n\n    const eventTypes: readonly string[] = ['panels_updated'];\n\n    const subs: HassUnsubscribe[] = [];\n    Promise.all(\n      eventTypes.map((et) =>\n        conn\n          .subscribeEvents(this._handleBusEvent.bind(this), et)\n          .then((unsub) => {\n            if (typeof unsub === 'function') {\n              subs.push(unsub);\n              console.debug('PPReaderDashboard: subscribed to', et);\n            } else {\n              console.error(\n                'PPReaderDashboard: subscribeEvents lieferte kein Unsubscribe-Func für',\n                et,\n                unsub,\n              );\n            }\n          })\n          .catch((err) => {\n            console.error('PPReaderDashboard: Fehler bei subscribeEvents für', et, err);\n          }),\n      ),\n    ).then(() => {\n      this._unsubscribeEvents = () => {\n        subs.forEach((unsubscribe) => {\n          try {\n            unsubscribe();\n          } catch (error) {\n            // ignore cleanup errors\n          }\n        });\n        console.debug('PPReaderDashboard: alle Event-Subscriptions entfernt');\n      };\n    });\n  }\n  private _removeEventListeners(): void {\n    if (typeof this._unsubscribeEvents === 'function') {\n      try {\n        this._unsubscribeEvents();\n      } catch (error) {\n        console.error('PPReaderDashboard: Fehler beim Entfernen der Event-Listener:', error);\n      }\n    }\n    this._unsubscribeEvents = null;\n  }\n\n  private _handleBusEvent(event: PanelsUpdatedEvent): void {\n    const currentEntryId = getEntryId(this._hass, this._panel);\n    if (!currentEntryId) {\n      return;\n    }\n\n    const eventData = event?.data;\n    if (!eventData || !isDashboardUpdateType(eventData.data_type)) {\n      return;\n    }\n\n    if (eventData.entry_id && eventData.entry_id !== currentEntryId) {\n      return;\n    }\n\n    const normalized = normalizeDashboardUpdate(eventData.data_type, eventData.data);\n    if (!normalized) {\n      return;\n    }\n\n    this._queueUpdate(normalized.type, normalized.data);\n    this._doRender(normalized.type, normalized.data);\n  }\n\n  private _doRender<T extends DashboardUpdateType>(\n    dataType: T,\n    pushedData: DashboardUpdatePayloadMap[T] | null | undefined,\n  ): void {\n    switch (dataType) {\n      case 'accounts':\n        handleAccountUpdate(\n          pushedData as DashboardUpdatePayloadMap['accounts'],\n          this._root,\n        );\n        break;\n      case 'last_file_update':\n        handleLastFileUpdate(\n          pushedData as DashboardUpdatePayloadMap['last_file_update'],\n          this._root,\n        );\n        break;\n      case 'portfolio_values':\n        handlePortfolioUpdate(\n          pushedData as DashboardUpdatePayloadMap['portfolio_values'],\n          this._root,\n        );\n        break;\n      case 'portfolio_positions':\n        handlePortfolioPositionsUpdate(\n          pushedData as DashboardUpdatePayloadMap['portfolio_positions'],\n          this._root,\n        );\n        break;\n      default:\n        console.warn('PPReaderDashboard: Unbekannter Datentyp:', dataType);\n        break;\n    }\n  }\n\n  private _queueUpdate<T extends DashboardUpdateType>(\n    dataType: T,\n    pushedData: DashboardUpdatePayloadMap[T] | null | undefined,\n  ): void {\n    const clonedData = this._cloneData(pushedData);\n    const entry: DashboardUpdateQueueEntry<T> = {\n      type: dataType,\n      data: clonedData,\n    };\n\n    if (dataType === 'portfolio_positions') {\n      entry.portfolioUuid = extractPortfolioUuidFromPositionsUpdate(\n        clonedData as DashboardUpdatePayloadMap['portfolio_positions'],\n      );\n    }\n\n    let index = -1;\n    if (dataType === 'portfolio_positions' && entry.portfolioUuid) {\n      index = this._pendingUpdates.findIndex(\n        (item) => item.type === dataType && item.portfolioUuid === entry.portfolioUuid,\n      );\n    } else {\n      index = this._pendingUpdates.findIndex((item) => item.type === dataType);\n    }\n\n    if (index >= 0) {\n      this._pendingUpdates[index] = entry;\n    } else {\n      this._pendingUpdates.push(entry);\n    }\n\n    this._hasNewData = true;\n  }\n\n  private _cloneData<T>(data: T): T {\n    if (data == null) {\n      return data;\n    }\n\n    try {\n      if (typeof structuredClone === 'function') {\n        return structuredClone(data);\n      }\n    } catch (error) {\n      console.warn('PPReaderDashboard: structuredClone fehlgeschlagen, falle auf JSON zurück', error);\n    }\n\n    try {\n      return JSON.parse(JSON.stringify(data)) as T;\n    } catch (error) {\n      console.warn('PPReaderDashboard: JSON-Clone fehlgeschlagen, referenziere Originaldaten', error);\n      return data;\n    }\n  }\n\n  private _reapplyPendingUpdates(): void {\n    if (!Array.isArray(this._pendingUpdates) || this._pendingUpdates.length === 0) {\n      return;\n    }\n\n    for (const item of this._pendingUpdates) {\n      try {\n        this._doRender(item.type, this._cloneData(item.data));\n      } catch (error) {\n        console.error('PPReaderDashboard: Fehler beim erneuten Anwenden eines Updates', item, error);\n      }\n    }\n  }\n\n  public _renderIfInitialized(): void {\n    if (this._initialized) {\n      this._render();\n    }\n  }\n\n  public rememberScrollPosition(page: number = currentPage): void {\n    if (!this._root) {\n      return;\n    }\n\n    const targetPage = Number.isInteger(page) ? page : currentPage;\n    if (targetPage == null) {\n      return;\n    }\n\n    this._scrollPositions[targetPage] = this._root.scrollTop || 0;\n  }\n\n  private _render(): void {\n    if (!this._hass) {\n      console.warn('pp-reader-dashboard: noch kein hass, überspringe _render()');\n      return;\n    }\n    if (!this._initialized) {\n      console.debug('pp-reader-dashboard: _render aufgerufen bevor initialisiert');\n      return;\n    }\n\n    const page = currentPage;\n    if (\n      !this._hasNewData &&\n      this._panel === this._lastPanel &&\n      this._narrow === this._lastNarrow &&\n      this._route === this._lastRoute &&\n      this._lastPage === page\n    ) {\n      return;\n    }\n\n    if (this._lastPage != null) {\n      this._scrollPositions[this._lastPage] = this._root.scrollTop;\n    }\n\n    const maybePromise = renderTab(this._root, this._hass, this._panel);\n    if (maybePromise && typeof (maybePromise as Promise<void>).then === 'function') {\n      (maybePromise as Promise<void>)\n        .then(() => {\n          this._afterRender(page);\n        })\n        .catch((error) => {\n          console.error('PPReaderDashboard: Fehler beim Rendern des Tabs', error);\n          this._afterRender(page);\n        });\n    } else {\n      this._afterRender(page);\n    }\n  }\n\n  private _afterRender(page: number): void {\n    if (!this._root) {\n      return;\n    }\n\n    const restore = this._scrollPositions[page] || 0;\n    this._root.scrollTop = restore;\n\n    this._lastPanel = this._panel;\n    this._lastNarrow = this._narrow;\n    this._lastRoute = this._route;\n    this._lastPage = page;\n\n    try {\n      this._reapplyPendingUpdates();\n    } catch (error) {\n      console.error('PPReaderDashboard: Fehler beim Wiederanlegen der Updates', error);\n    }\n\n    this._hasNewData = false;\n  }\n}\n\nif (!customElements.get('pp-reader-dashboard')) {\n  customElements.define('pp-reader-dashboard', PPReaderDashboard);\n}\n\nconsole.log('PPReader dashboard.js v20250914b geladen');\n\nregisterSecurityDetailTab({\n  setSecurityDetailTabFactory,\n});\n"],"names":["addSwipeEvents","element","onSwipeLeft","onSwipeRight","startX","e","deltaX","formatValue","key","value","row","context","formatted","toNumber","v","cleaned","parsed","safeNumber","minFrac","maxFrac","num","renderMissingValue","reason","title","rowWithFlags","missingReason","numeric","symbol","cls","hasFraction","makeTable","rows","cols","sumColumns","options","sortable","defaultSort","defaultSortKey","defaultSortDir","escapeAttribute","html","c","alignClass","r","sums","sumMeta","total","hasValue","gainAbsSum","purchaseSum","currentValueSum","aggregatedGainPct","aggregatedGainPctLabel","aggregatedGainPctSign","formatNumber","idx","extraAttributes","fallbackContext","tpl","table","createHeaderCard","headerTitle","meta","headerCard","formatGain","formatGainPct","sortTableRows","tableEl","dir","isPositions","tbody","footer","colIdx","ths","i","txt","a","b","aCell","bCell","aTxt","bTxt","aNum","bNum","cmp","hasNumericContext","th","activeTh","deriveEntryId","hass","panelConfig","_a","_b","_c","_d","_e","_f","_g","_h","entryId","panels","candidate","panel","getEntryId","fetchAccountsWS","fetchLastFileUpdateWS","response","lastFileUpdate","fetchPortfoliosWS","fetchPortfolioPositionsWS","portfolioUuid","fetchSecuritySnapshotWS","securityUuid","fetchSecurityHistoryWS","payload","startDate","endDate","startDateRaw","endDateRaw","resolvedStart","resolvedEnd","PENDING_RETRY_INTERVAL","PENDING_MAX_ATTEMPTS","PORTFOLIO_POSITIONS_UPDATED_EVENT","ensurePendingMap","ensurePendingRetryMeta","renderPositionsError","error","restoreSortAndInit","containerEl","rootEl","pid","direction","applyPortfolioPositionsToDom","root","positions","detailsRow","container","prevKey","prevDir","renderPositionsTableInline","flushPendingPositions","pendingMap","pending","result","flushAllPendingPositions","appliedAny","schedulePendingRetry","retryMetaMap","success","handleAccountUpdate","update","updatedAccounts","updateAccountTable","portfolioTable","portfolios","currentValueCell","textContent","updateTotalWealth","accounts","eurContainer","fxContainer","eurAccounts","account","fxAccounts","handlePortfolioUpdate","formatNumberLocal","val","rowMap","patched","formatPositionCount","entry","uuid","posCountCell","curValCell","gainAbsCell","gainPctCell","posCount","curVal","purchase","gainAbs","gainPct","oldCur","parseNumLoose","updatePortfolioFooter","findTable","selectors","selector","eurTable","fxTable","extractAccounts","tbl","isFx","accountRows","cell","portfolioDomValues","cv","gain","ps","normalizePortfolioUuid","direct","camelCase","processPortfolioPositionsUpdate","pos","cache","securityUuids","dispatchError","handlePortfolioPositionsUpdate","handled","item","position","raw","colKeys","tr","err","gainCell","pctCell","pctText","pctSign","helper","sumCurrent","sumGainAbs","sumPurchase","sumPositions","datasetCount","datasetCurrent","currentValue","datasetGain","datasetPurchase","sumGainPct","sumPositionsDisplay","footerGainAbsCell","targetRoot","accountSum","acc","portfolioSum","totalWealth","headerMeta","valueElement","handleLastFileUpdate","el","metaHost","reapplyPositionsSort","PORTFOLIO_SORT_KEYS","isPortfolioPositionsSortKey","isPortfolioSortDirection","_hassRef","_panelConfigRef","portfolioPositionsCache","HOLDINGS_PRECISION","toFiniteNumber","roundCurrency","finite","roundHoldings","collectSecurityPositions","matches","posUuid","getSecurityPositionsFromCache","getSecuritySnapshotFromCache","name","totalHoldings","totalPurchaseValue","totalCurrentValue","posName","lastPriceEur","expandedPortfolios","applyGainPctMetadata","renderPositionsTable","p","attachSecurityDetailDelegation","event","target","interactive","openSecurityDetail","attachSecurityDetailListener","buildExpandablePortfolioTable","depots","align","d","positionCount","expanded","toggleClass","detailId","rowData","valueContext","gainPctLabel","gainPctSign","datasetCurrentValue","datasetGainAbs","datasetGainPct","gainAbsAttributes","availableDepots","current","sumHasValue","sumRowData","sumContext","sumCurrentCell","sumGainAbsCell","sumGainPctCell","sumGainAbsAttributes","sumGainPctLabel","sumGainPctSign","resolvePortfolioTable","scoped","nested","generic","readDatasetNumber","extractNumericFromCell","updatePortfolioFooterFromDom","missingRows","hasValueAttr","purchaseSumDataset","child","currentValueHtml","gainAbsHtml","gainPctHtml","attachPortfolioPositionsSorting","applySort","parseNum","comp","containerKey","containerDir","defaultKey","defaultDir","currentKey","currentDir","keyAttr","reloadPortfolioPositions","targetContainer","resp","errorText","message","waitForElement","timeoutMs","intervalMs","start","resolve","tick","attachPortfolioToggleHandler","token","retryBtn","cont","btn","caretEl","pendingApplied","ensurePortfolioRowFallbackListener","primaryContainer","renderDashboard","accountsResp","normalizedAccounts","missingPositions","hasCurrentValue","baseCurrentValue","depot","totalAccounts","sum","anyPortfolioMissing","totalDepots","missingWealthReason","wealthValueMarkup","wealthNote","portfolioTableHtml","fxWarning","accountsHtml","footerCard","markup","schedulePostRenderSetup","run","wrapper","tableHost","footerErr","pendingErr","schedule","cb","SVG_NS","DEFAULT_WIDTH","DEFAULT_HEIGHT","DEFAULT_MARGIN","DEFAULT_COLOR","DEFAULT_AREA","DEFAULT_TICK_FONT","ONE_DAY_MS","createSvgElement","tag","attrs","fallback","toTimestamp","fallbackIndex","timestamp","defaultXAccessor","defaultYAccessor","defaultXFormatter","dataPoint","_index","date","defaultYFormatter","_dataPoint","defaultTooltipRenderer","xFormatted","yFormatted","ensureChartState","clamp","min","max","buildAreaPath","points","baselineY","moveLine","point","index","closing","buildLinePath","computePoints","series","dimensions","accessors","width","height","margin","xAccessor","yAccessor","rawPoints","rawX","rawY","xValue","yValue","minX","maxX","minY","maxY","boundedWidth","boundedHeight","safeMinX","safeMaxX","safeMinY","safeMaxY","desiredYTicks","domainMinY","domainMaxY","computeNiceDomain","effectiveMinY","effectiveMaxY","rangeX","rangeY","ratioX","ratioY","x","y","assignDimensions","state","formatTooltip","updateTooltipPosition","pointerY","tooltip","tooltipWidth","tooltipHeight","horizontal","maxVertical","padding","anchorY","vertical","hideTooltip","focusLine","focusCircle","attachPointerHandlers","handlePointerMove","rect","pointerX","closest","minDistance","distance","handlePointerLeave","renderLineChart","svg","areaPath","linePath","overlay","xAxis","yAxis","updateLineChart","range","updateAxes","lineD","areaD","yFormatter","hasValidX","hasValidY","effectiveWidth","effectiveHeight","rangeDays","desiredTicks","generateTimeAxisTicks","positionRatio","label","ratio","yAxisWidth","yTicks","generateNumericAxisTicks","applyFormatter","top","minValue","maxValue","safeTicks","niceStep","rawStep","step","niceMin","niceMax","minTimestamp","maxTimestamp","formatXAxisLabel","tickCount","ticks","end","_","exponent","fraction","niceFraction","HOLDINGS_FRACTION_DIGITS","PRICE_FRACTION_DIGITS","PRICE_SCALE","DEFAULT_HISTORY_RANGE","AVAILABLE_HISTORY_RANGES","RANGE_DAY_COUNTS","SECURITY_HISTORY_CACHE","RANGE_STATE_REGISTRY","LIVE_UPDATE_EVENT","LIVE_UPDATE_HANDLERS","buildCachedSnapshotNotice","params","fallbackUsed","flaggedAsCache","reasons","getCachedSecuritySnapshot","getter","snapshot","ensureHistoryCache","invalidateHistoryCache","handleLiveUpdateForSecurity","detail","ensureLiveUpdateSubscription","handler","removeLiveUpdateSubscription","cleanupSecurityDetailState","setActiveRange","rangeKey","getActiveRange","toEpochDay","epochMs","normaliseDate","clone","resolveRangeOptions","now","parseHistoryDate","trimmed","year","month","day","normaliseHistorySeries","prices","numericClose","deriveFxRate","latestNativePrice","currency","snapshotNative","historyNative","rounded","computeGainValues","historySeries","holdings","fxRate","safeHoldings","safeFx","lastEntry","firstEntry","previousEntry","periodDiff","dailyDiff","formatGainValue","buildInfoBar","periodGain","dailyGain","rangeLabel","buildRangeSelector","activeRange","buildHistoryPlaceholder","safeRange","formatHoldings","minFraction","maxFraction","formatPrice","buildHeaderMeta","lastPriceNative","formattedLastPrice","lastPriceDisplay","marketValueRaw","marketValue","normaliseHistoryError","getHistoryChartOptions","host","measuredWidth","safeCurrency","HISTORY_CHART_INSTANCES","renderHistoryChart","chartOptions","chartContainer","updateRangeButtons","button","isActive","updateInfoBarContent","infoBar","fresh","updateHistoryPlaceholder","placeholderContainer","scheduleRangeSetup","initialRange","initialHistory","initialHistoryState","rangeSelector","handleRangeClick","historyState","rangeOptions","historyResponse","lastClose","activeFxRate","renderSecurityDetail","cachedSnapshot","effectiveSnapshot","staleNotice","historyError","registerSecurityDetailTab","setSecurityDetailTabFactory","addSwipeEventsUnsafe","STICKY_HEADER_ANCHOR_ID","OVERVIEW_TAB_KEY","SECURITY_DETAIL_TAB_PREFIX","baseTabs","detailTabRegistry","detailTabOrder","securityTabLookup","securityDetailTabFactory","navigationInProgress","lastClosedSecurityUuid","currentPage","observer","isRecord","isDashboardUpdateType","extractPortfolioUuidFromSingleUpdate","uuidCandidate","camelCaseCandidate","extractPortfolioUuidFromPositionsUpdate","normalizeDashboardUpdate","dataType","data","extractSecurityUuidFromKey","tryReopenLastDetail","reopened","getVisibleTabs","detailTabs","descriptor","rememberCurrentPageScroll","dashboardElement","findDashboardElement","clampPageIndex","tabs","navigateToPage","targetIndex","clampedIndex","currentTab","currentSecurityUuid","nextIndex","intendedTarget","closeSecurityDetail","overviewIndex","tab","renderTab","navigateByDelta","delta","registerDetailTab","existingKey","unregisterDetailTab","normalizedDescriptor","hasDetailTab","getDetailTabDescriptor","factory","getSecurityDetailTabKey","registered","panelElements","panelElement","requestDashboardRender","tabKey","maybeDescriptor","suppressRender","tabIndexBefore","wasActive","tabsAfter","effectivePanel","content","interval","anchor","parent","setupNavigation","setupSwipeOnHeaderCard","setupHeaderScrollBehavior","scrollBorder","navLeft","navRight","updateNavigationState","shouldEnable","PPReaderDashboard","__publicField","narrow","route","conn","eventTypes","subs","et","unsub","unsubscribe","currentEntryId","eventData","normalized","pushedData","clonedData","page","targetPage","maybePromise","restore"],"mappings":"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"}