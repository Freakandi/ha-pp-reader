var wn=Object.defineProperty;var An=(e,t,n)=>t in e?wn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var M=(e,t,n)=>An(e,typeof t!="symbol"?t+"":t,n);function Nn(e,t,n){let r=null;e.addEventListener("touchstart",i=>{i.touches.length===1&&(r=i.touches[0].clientX)},{passive:!0}),e.addEventListener("touchend",i=>{if(r===null)return;const a=i.changedTouches[0].clientX-r;a<-50?t():a>50&&n(),r=null},{passive:!0}),e.addEventListener("mousedown",i=>{r=i.clientX},{passive:!0}),e.addEventListener("mouseup",i=>{if(r===null)return;const a=i.clientX-r;a<-50?t():a>50&&n(),r=null},{passive:!0})}function U(e,t,n=void 0,r=void 0){let i=null;const a=o=>{if(typeof o=="number")return o;if(typeof o=="string"&&o.trim()!==""){const u=o.replace(/\s+/g,"").replace(/[^0-9,.-]/g,"").replace(/\.(?=\d{3}(\D|$))/g,"").replace(",","."),c=Number.parseFloat(u);return Number.isNaN(c)?Number.NaN:c}return Number.NaN},l=(o,u=2,c=2)=>{const d=typeof o=="number"?o:a(o);return Number.isFinite(d)?d.toLocaleString("de-DE",{minimumFractionDigits:u,maximumFractionDigits:c}):""},s=(o="")=>{const u=o||"Kein Wert verfügbar";return`<span class="missing-value" role="note" aria-label="${u}" title="${u}">—</span>`};if(["gain_abs","gain_pct"].includes(e)){const o=n,u=o!=null&&o.fx_unavailable?"Wechselkurs nicht verfügbar – EUR-Wert unbekannt":"";if(t==null||r&&r.hasValue===!1)return s(u);const c=typeof t=="number"?t:a(t);if(!Number.isFinite(c))return s(u);const d=e==="gain_pct"?"%":"€";i=l(c)+`&nbsp;${d}`;let f="neutral";return c>0?f="positive":c<0&&(f="negative"),`<span class="${f}">${i}</span>`}else if(e==="position_count"){const o=typeof t=="number"?t:a(t);if(!Number.isFinite(o))return s();i=o.toLocaleString("de-DE")}else if(["balance","current_value","purchase_value"].includes(e)){const o=typeof t=="number"?t:a(t);if(!Number.isFinite(o))return n!=null&&n.fx_unavailable?s("Wechselkurs nicht verfügbar – EUR-Wert unbekannt"):(r&&r.hasValue===!1,s());i=l(o)+"&nbsp;€"}else if(e==="current_holdings"){const o=typeof t=="number"?t:a(t);if(!Number.isFinite(o))return s();const u=Math.abs(o%1)>0;i=o.toLocaleString("de-DE",{minimumFractionDigits:u?2:0,maximumFractionDigits:4})}else i=typeof t=="string"?t:t!=null?String(t):"",i&&(i.length>60&&(i=i.slice(0,59)+"…"),i.startsWith("Kontostand ")?i=i.substring(11):i.startsWith("Depotwert ")&&(i=i.substring(10)));return i==null||i===""?s():i}function ne(e,t,n=[],r={}){const{sortable:i=!1,defaultSort:a}=r||{},l=(a==null?void 0:a.key)??"",s=(a==null?void 0:a.dir)==="desc"?"desc":"asc",o=h=>h==null?"":String(h).replace(/&/g,"&amp;").replace(/"/g,"&quot;");let u="<table><thead><tr>";t.forEach(h=>{const _=h.align==="right"?' class="align-right"':"";i&&h.key?u+=`<th${_} data-sort-key="${h.key}">${h.label}</th>`:u+=`<th${_}>${h.label}</th>`}),u+="</tr></thead><tbody>",e.forEach(h=>{u+="<tr>",t.forEach(_=>{const g=_.align==="right"?' class="align-right"':"";u+=`<td${g}>${U(_.key,h[_.key],h)}</td>`}),u+="</tr>"});const c={},d={};t.forEach(h=>{if(n.includes(h.key)){let _=0,g=!1;e.forEach(p=>{const P=p[h.key];typeof P=="number"&&Number.isFinite(P)&&(_+=P,g=!0)}),c[h.key]=g?_:null,d[h.key]={hasValue:g}}});const f=c.gain_abs??null;if(f!=null){const h=c.purchase_value??null;if(h!=null&&h>0)c.gain_pct=f/h*100;else{const _=c.current_value??null;_!=null&&_!==0&&(c.gain_pct=f/(_-f)*100)}}const b=Number.isFinite(c.gain_pct??NaN)?c.gain_pct:null;let m="",v="neutral";if(b!=null&&(m=`${B(b)} %`,b>0?v="positive":b<0&&(v="negative")),u+='<tr class="footer-row">',t.forEach((h,_)=>{const g=h.align==="right"?' class="align-right"':"";if(_===0){u+=`<td${g}>Summe</td>`;return}if(c[h.key]!=null){let P="";h.key==="gain_abs"&&m&&(P=` data-gain-pct="${o(m)}" data-gain-sign="${o(v)}"`),u+=`<td${g}${P}>${U(h.key,c[h.key],void 0,d[h.key])}</td>`;return}if(h.key==="gain_pct"&&c.gain_pct!=null){u+=`<td${g}>${U("gain_pct",c.gain_pct,void 0,d[h.key])}</td>`;return}const p=d[h.key]??{hasValue:!1};u+=`<td${g}>${U(h.key,null,void 0,p)}</td>`}),u+="</tr>",u+="</tbody></table>",i)try{const h=document.createElement("template");h.innerHTML=u.trim();const _=h.content.querySelector("table");if(_)return _.classList.add("sortable-table"),l&&(_.dataset.defaultSort=l,_.dataset.defaultDir=s),_.outerHTML}catch(h){console.warn("makeTable(sortable): Injection fehlgeschlagen:",h)}return u}function Ue(e,t){const n=document.createElement("div");return n.className="header-card",n.innerHTML=`
    <div class="header-content">
      <button id="nav-left" class="nav-arrow" aria-label="Vorherige Seite">
        <svg viewBox="0 0 24 24">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
        </svg>
      </button>
      <h1 id="headerTitle">${e}</h1>
      <button id="nav-right" class="nav-arrow" aria-label="Nächste Seite">
        <svg viewBox="0 0 24 24">
          <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
        </svg>
      </button>
    </div>
    <div id="headerMeta" class="meta">${t}</div>
  `,n}function B(e,t=2,n=2){return(Number.isNaN(e)?0:e).toLocaleString("de-DE",{minimumFractionDigits:t,maximumFractionDigits:n})}function Nt(e){const t=Number.isNaN(e)?0:e;let n="neutral";return t>0?n="positive":t<0&&(n="negative"),`<span class="${n}">${B(t)}&nbsp;€</span>`}function Ft(e){const t=Number.isNaN(e)?0:e;let n="neutral";return t>0?n="positive":t<0&&(n="negative"),`<span class="${n}">${B(t)}&nbsp;%</span>`}function xt(e,t,n="asc",r=!1){if(!e)return[];const i=e.querySelector("tbody");if(!i)return[];const a=i.querySelector("tr.footer-row"),l=Array.from(i.querySelectorAll("tr")).filter(c=>c!==a);let s=-1;if(r)s={name:0,current_holdings:1,purchase_value:2,current_value:3,gain_abs:4,gain_pct:5}[t];else{const c=Array.from(e.querySelectorAll("thead th"));for(let d=0;d<c.length;d++)if(c[d].getAttribute("data-sort-key")===t){s=d;break}}if(s==null||s<0)return l;const o=c=>{if(c==null)return NaN;const d=c.replace(/\u00A0/g," ").replace(/[%€]/g,"").replace(/\./g,"").replace(/,/g,".").replace(/[^\d.-]/g,"").trim();if(!d)return NaN;const f=parseFloat(d);return Number.isFinite(f)?f:NaN};l.sort((c,d)=>{const f=c.cells.item(s),b=d.cells.item(s),m=((f==null?void 0:f.textContent)??"").trim(),v=((b==null?void 0:b.textContent)??"").trim(),h=o(m),_=o(v);let g;const p=/[0-9]/.test(m)||/[0-9]/.test(v);return!Number.isNaN(h)&&!Number.isNaN(_)&&p?g=h-_:g=m.localeCompare(v,"de",{sensitivity:"base"}),n==="asc"?g:-g}),l.forEach(c=>i.appendChild(c)),a&&i.appendChild(a),e.querySelectorAll("thead th.sort-active").forEach(c=>{c.classList.remove("sort-active","dir-asc","dir-desc")});const u=e.querySelector(`thead th[data-sort-key="${t}"]`);return u&&u.classList.add("sort-active",n==="asc"?"dir-asc":"dir-desc"),l}function X(e,t){var r,i,a,l,s,o,u,c;let n=((r=t==null?void 0:t.config)==null?void 0:r.entry_id)??(t==null?void 0:t.entry_id)??((l=(a=(i=t==null?void 0:t.config)==null?void 0:i._panel_custom)==null?void 0:a.config)==null?void 0:l.entry_id)??void 0;if(!n&&(e!=null&&e.panels)){const d=e.panels,f=d.ppreader??d.pp_reader??Object.values(d).find(b=>(b==null?void 0:b.webcomponent_name)==="pp-reader-panel");n=((s=f==null?void 0:f.config)==null?void 0:s.entry_id)??(f==null?void 0:f.entry_id)??((c=(u=(o=f==null?void 0:f.config)==null?void 0:o._panel_custom)==null?void 0:u.config)==null?void 0:c.entry_id)??void 0}return n??void 0}function at(e,t){return X(e,t)}async function Fn(e,t){if(!e)throw new Error("fetchAccountsWS: fehlendes hass");const n=X(e,t);if(!n)throw new Error("fetchAccountsWS: fehlendes entry_id");return e.connection.sendMessagePromise({type:"pp_reader/get_accounts",entry_id:n})}async function xn(e,t){if(!e)throw new Error("fetchLastFileUpdateWS: fehlendes hass");const n=X(e,t);if(!n)throw new Error("fetchLastFileUpdateWS: fehlendes entry_id");const r=await e.connection.sendMessagePromise({type:"pp_reader/get_last_file_update",entry_id:n});if(typeof r=="string")return r;const i=r==null?void 0:r.last_file_update;return typeof i=="string"?i:""}async function En(e,t){if(!e)throw new Error("fetchPortfoliosWS: fehlendes hass");const n=X(e,t);if(!n)throw new Error("fetchPortfoliosWS: fehlendes entry_id");return e.connection.sendMessagePromise({type:"pp_reader/get_portfolio_data",entry_id:n})}async function Et(e,t,n){if(!e)throw new Error("fetchPortfolioPositionsWS: fehlendes hass");const r=X(e,t);if(!r)throw new Error("fetchPortfolioPositionsWS: fehlendes entry_id");if(!n)throw new Error("fetchPortfolioPositionsWS: fehlendes portfolio_uuid");return e.connection.sendMessagePromise({type:"pp_reader/get_portfolio_positions",entry_id:r,portfolio_uuid:n})}async function Dn(e,t,n){if(!e)throw new Error("fetchSecuritySnapshotWS: fehlendes hass");const r=X(e,t);if(!r)throw new Error("fetchSecuritySnapshotWS: fehlendes entry_id");if(!n)throw new Error("fetchSecuritySnapshotWS: fehlendes securityUuid");return e.connection.sendMessagePromise({type:"pp_reader/get_security_snapshot",entry_id:r,security_uuid:n})}async function Dt(e,t,n,r={}){if(!e)throw new Error("fetchSecurityHistoryWS: fehlendes hass");const i=X(e,t);if(!i)throw new Error("fetchSecurityHistoryWS: fehlendes entry_id");if(!n)throw new Error("fetchSecurityHistoryWS: fehlendes securityUuid");const a={type:"pp_reader/get_security_history",entry_id:i,security_uuid:n},{startDate:l,endDate:s,start_date:o,end_date:u}=r||{},c=l??o;c!=null&&(a.start_date=c);const d=s??u;return d!=null&&(a.end_date=d),e.connection.sendMessagePromise(a)}const Cn=500,Ln=10,Rn="pp-reader:portfolio-positions-updated";function $e(){return window.__ppReaderPendingPositions||(window.__ppReaderPendingPositions=new Map),window.__ppReaderPendingPositions}function Tn(){return window.__ppReaderPendingRetryMeta||(window.__ppReaderPendingRetryMeta=new Map),window.__ppReaderPendingRetryMeta}function $n(e,t){return`<div class="error">${typeof e=="string"?e:String(e??"Unbekannter Fehler")} <button class="retry-pos" data-portfolio="${t}">Erneut laden</button></div>`}function Mn(e,t,n){const r=e.querySelector("table.sortable-positions");if(!r)return;const i=e.dataset.sortKey||r.dataset.defaultSort||"name",l=(e.dataset.sortDir||r.dataset.defaultDir||"asc")==="desc"?"desc":"asc";e.dataset.sortKey=i,e.dataset.sortDir=l;try{xt(r,i,l,!0)}catch(s){console.warn("restoreSortAndInit: sortTableRows Fehler:",s)}try{window.__ppReaderAttachPortfolioPositionsSorting&&window.__ppReaderAttachPortfolioPositionsSorting(t,n)}catch(s){console.warn("restoreSortAndInit: attachPortfolioPositionsSorting Fehler:",s)}try{window.__ppReaderAttachSecurityDetailListener&&window.__ppReaderAttachSecurityDetailListener(t,n)}catch(s){console.warn("restoreSortAndInit: attachSecurityDetailListener Fehler:",s)}}function Ct(e,t,n,r){if(!e||!t)return{applied:!1,reason:"invalid"};const i=e.querySelector(`.portfolio-table .portfolio-details[data-portfolio="${t}"]`);if(!i)return{applied:!1,reason:"missing"};const a=i.querySelector(".positions-container");if(!a)return{applied:!1,reason:"missing"};if(i.classList.contains("hidden"))return{applied:!1,reason:"hidden"};if(r)return a.innerHTML=$n(r,t),{applied:!0};const l=a.dataset.sortKey,s=a.dataset.sortDir;return a.innerHTML=Vn(n),l&&(a.dataset.sortKey=l),s&&(a.dataset.sortDir=s),Mn(a,e,t),{applied:!0}}function Me(e,t){const n=$e(),r=n.get(t);if(!r)return!1;const i=Ct(e,t,r.positions,r.error);return i.applied&&n.delete(t),i.applied}function Lt(e){const t=$e();let n=!1;for(const[r]of t)Me(e,r)&&(n=!0);return n}function Rt(e,t){const n=Tn(),r=n.get(t)??{attempts:0,timer:null};r.timer||(r.timer=setTimeout(()=>{r.timer=null,r.attempts+=1;const i=Me(e,t);i||r.attempts>=Ln?(n.delete(t),i||$e().delete(t)):Rt(e,t)},Cn),n.set(t,r))}function kn(e,t){console.log("updateConfigsWS: Kontodaten-Update erhalten:",e);const n=Array.isArray(e)?e:[];if(!t)return;Hn(n,t);const r=t.querySelector(".portfolio-table table"),i=r?Array.from(r.querySelectorAll("tbody tr:not(.footer-row)")).map(a=>{const l=a.cells.item(2),s=(l==null?void 0:l.textContent)??"",o=parseFloat(s.replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""));return{current_value:Number.isFinite(o)?o:0}}):[];Mt(n,i,t)}function Hn(e,t){const n=t.querySelector(".account-table"),r=t.querySelector(".fx-account-table"),i=e.filter(l=>(l.currency_code||"EUR")==="EUR"),a=e.filter(l=>(l.currency_code||"EUR")!=="EUR");n?n.innerHTML=ne(i,[{key:"name",label:"Name"},{key:"balance",label:"Kontostand (EUR)",align:"right"}],["balance"]):console.warn("updateAccountTable: .account-table nicht gefunden."),r?r.innerHTML=ne(a.map(l=>({...l,fx_display:`${(l.orig_balance??0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})} ${l.currency_code}`})),[{key:"name",label:"Name"},{key:"fx_display",label:"Betrag (FX)"},{key:"balance",label:"EUR",align:"right"}],["balance"]):a.length&&console.warn("updateAccountTable: .fx-account-table nicht gefunden, obwohl FX-Konten vorhanden sind.")}function In(e,t){if(!Array.isArray(e)){console.warn("handlePortfolioUpdate: Update ist kein Array:",e);return}try{console.debug("handlePortfolioUpdate: payload=",e)}catch{}if(!t)return;const n=t.querySelector(".portfolio-table table")||t.querySelector("table.expandable-portfolio-table");if(!n){!t.querySelector(".portfolio-table")&&(t.querySelector(".security-range-selector")||t.querySelector(".security-detail-placeholder"))?console.debug("handlePortfolioUpdate: Übersicht nicht aktiv – Update wird später angewendet."):console.warn("handlePortfolioUpdate: Keine Portfolio-Tabelle gefunden.");return}const r=n.tBodies.item(0)??n.querySelector("tbody");if(!r){console.warn("handlePortfolioUpdate: Kein <tbody> in Tabelle.");return}const i=o=>{if(window.Intl)try{return new Intl.NumberFormat(navigator.language||"de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(o)}catch{}return(Math.round(o*100)/100).toFixed(2).replace(".",",")},a=new Map(Array.from(r.querySelectorAll("tr.portfolio-row")).filter(o=>{var u;return!!((u=o.dataset)!=null&&u.portfolio)}).map(o=>[o.dataset.portfolio,o]));let l=0;const s=o=>{const u=Number.isFinite(o)?Number(o):0;try{return u.toLocaleString("de-DE")}catch{return u.toString()}};for(const o of e){const u=o==null?void 0:o.uuid;if(typeof u!="string"||!u)continue;const c=a.get(u);if(!c||c.cells.length<3)continue;const d=c.cells.item(1),f=c.cells.item(2),b=c.cells.item(3),m=c.cells.item(4);if(!d||!f)continue;const v=Number(o.position_count??o.count??0),h=Number(o.current_value??o.value??0),_=Number(o.purchase_sum??o.purchaseSum??0),g=h-_,p=_>0?g/_*100:0,P=z(f.textContent);z(d.textContent)!==v&&(d.textContent=s(v)),Math.abs(P-h)>=.005&&(f.textContent=`${i(h)} €`,c.classList.add("flash-update"),setTimeout(()=>c.classList.remove("flash-update"),800)),b&&(b.innerHTML=Tt(g),b.dataset.gainPct=Number.isFinite(p)?`${i(p)} %`:"—",b.dataset.gainSign=Number.isFinite(p)?p>0?"positive":p<0?"negative":"neutral":"neutral"),m&&(m.innerHTML=$t(p)),c.dataset.positionCount=String(v),c.dataset.currentValue=String(h),c.dataset.purchaseSum=String(_),c.dataset.gainAbs=String(g),c.dataset.gainPct=String(p),l+=1}console.debug(l===0?"handlePortfolioUpdate: Keine passenden Zeilen gefunden / keine Änderungen.":`handlePortfolioUpdate: ${l} Zeile(n) gepatcht.`);try{Un(n)}catch(o){console.warn("handlePortfolioUpdate: Fehler bei Summen-Neuberechnung:",o)}try{const o=(...m)=>{for(const v of m){if(!v)continue;const h=t.querySelector(v);if(h)return h}return null},u=o(".account-table table",".accounts-eur-table table",".accounts-table table"),c=o(".fx-account-table table",".accounts-fx-table table"),d=(m,v)=>{if(!m)return[];const h=m.querySelectorAll("tbody tr.account-row");return(h.length?Array.from(h):Array.from(m.querySelectorAll("tbody tr:not(.footer-row)"))).map(g=>{const p=v?g.cells.item(2):g.cells.item(1);return{balance:z(p==null?void 0:p.textContent)}})},f=[...d(u,!1),...d(c,!0)],b=Array.from(n.querySelectorAll("tbody tr.portfolio-row")).map(m=>{var g,p;const v=z((g=m.cells.item(2))==null?void 0:g.textContent),h=z((p=m.cells.item(3))==null?void 0:p.textContent),_=v-h;return{current_value:v,purchase_sum:_}});Mt(f,b,t)}catch(o){console.warn("handlePortfolioUpdate: Fehler bei Total-Neuberechnung:",o)}}function qn(e){if(!e||typeof e!="object")return null;const t=e.portfolio_uuid;if(typeof t=="string"&&t)return t;const n=e.portfolioUuid;return typeof n=="string"&&n?n:null}function ot(e,t){const n=qn(e);if(!n)return console.warn("handlePortfolioPositionsUpdate: Ungültiges Update:",e),!1;const r=e==null?void 0:e.error,i=Array.isArray(e==null?void 0:e.positions)?e.positions.filter(s=>!!s):[];try{const s=window.__ppReaderPortfolioPositionsCache;s&&typeof s.set=="function"&&!r&&s.set(n,i)}catch(s){console.warn("handlePortfolioPositionsUpdate: Positions-Cache konnte nicht aktualisiert werden:",s)}const a=Ct(t,n,i,r),l=$e();if(a.applied?l.delete(n):(l.set(n,{positions:i,error:r}),a.reason!=="hidden"&&Rt(t,n)),!r&&i.length>0){const s=Array.from(new Set(i.map(o=>o==null?void 0:o.security_uuid).filter(o=>typeof o=="string"&&o.length>0)));if(s.length&&typeof window<"u")try{window.dispatchEvent(new CustomEvent(Rn,{detail:{portfolioUuid:n,securityUuids:s}}))}catch(o){console.warn("handlePortfolioPositionsUpdate: Dispatch des Portfolio-Events fehlgeschlagen",o)}}return!0}function Wn(e,t){if(Array.isArray(e)){let n=!1;for(const r of e)ot(r,t)&&(n=!0);!n&&e.length&&console.warn("handlePortfolioPositionsUpdate: Kein gültiges Element im Array:",e);return}ot(e,t)}function Vn(e){try{if(window.__ppReaderRenderPositionsTable)return window.__ppReaderRenderPositionsTable(e)}catch{}if(!e||!e.length)return'<div class="no-positions">Keine Positionen vorhanden.</div>';const t=e.map(r=>({name:r.name,current_holdings:r.current_holdings,purchase_value:r.purchase_value,current_value:r.current_value,gain_abs:r.gain_abs,gain_pct:r.gain_pct})),n=ne(t,[{key:"name",label:"Wertpapier"},{key:"current_holdings",label:"Bestand",align:"right"},{key:"purchase_value",label:"Kaufwert",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"+/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}],["purchase_value","current_value","gain_abs"]);try{const r=document.createElement("template");r.innerHTML=n.trim();const i=r.content.querySelector("table");if(i){i.classList.add("sortable-positions");const a=i.querySelectorAll("thead th"),l=["name","current_holdings","purchase_value","current_value","gain_abs","gain_pct"];if(a.forEach((o,u)=>{const c=l[u];c&&(o.setAttribute("data-sort-key",c),o.classList.add("sortable-col"))}),i.querySelectorAll("tbody tr").forEach((o,u)=>{if(o.classList.contains("footer-row"))return;const c=e[u];c!=null&&c.security_uuid&&(o.dataset.security=c.security_uuid),o.classList.add("position-row")}),i.dataset.defaultSort="name",i.dataset.defaultDir="asc",window.__ppReaderApplyGainPctMetadata)try{window.__ppReaderApplyGainPctMetadata(i)}catch(o){console.warn("renderPositionsTableInline: applyGainPctMetadata failed",o)}else i.querySelectorAll("tbody tr").forEach(u=>{var m,v;const c=(m=u.cells)==null?void 0:m[4],d=(v=u.cells)==null?void 0:v[5];if(!c||!d)return;const f=(d.textContent||"").trim()||"—";let b="neutral";d.querySelector(".positive")?b="positive":d.querySelector(".negative")&&(b="negative"),c.dataset.gainPct=f,c.dataset.gainSign=b});return i.outerHTML}}catch(r){console.warn("renderPositionsTableInline: Sortier-Metadaten Injection fehlgeschlagen:",r)}return n}window.__ppReaderFlushPendingPositions||(window.__ppReaderFlushPendingPositions=(e,t)=>Me(e,t));window.__ppReaderFlushAllPendingPositions||(window.__ppReaderFlushAllPendingPositions=e=>Lt(e));function Un(e){var c,d;if(!e)return;try{const f=window.__ppReaderUpdatePortfolioFooter;if(typeof f=="function"){f(e);return}}catch(f){console.warn("updatePortfolioFooter: global Helper schlug fehl:",f)}const t=Array.from(e.querySelectorAll("tbody tr.portfolio-row"));let n=0,r=0,i=0,a=0;t.forEach(f=>{var A,F,S,w,E,C,T;const b=Number((A=f.dataset)==null?void 0:A.positionCount),m=Number.isFinite(b)?b:parseInt((((F=f.cells.item(1))==null?void 0:F.textContent)||"").replace(/\./g,""),10)||0,v=Number((S=f.dataset)==null?void 0:S.currentValue),h=Number.isFinite(v)?v:z((w=f.cells.item(2))==null?void 0:w.textContent),_=Number((E=f.dataset)==null?void 0:E.gainAbs),g=Number.isFinite(_)?_:z((C=f.cells.item(3))==null?void 0:C.textContent),p=Number((T=f.dataset)==null?void 0:T.purchaseSum),P=Number.isFinite(p)?p:h-g;a+=m,n+=h,r+=g,i+=P}),i<=0&&(i=n-r);const l=i>0?r/i*100:0;let s=e.querySelector("tr.footer-row");s||(s=document.createElement("tr"),s.className="footer-row",(c=e.querySelector("tbody"))==null||c.appendChild(s));const o=Math.round(a).toLocaleString("de-DE");s.innerHTML=`
    <td>Summe</td>
    <td class="align-right">${o}</td>
    <td class="align-right">${re(n)}&nbsp;€</td>
    <td class="align-right">${Tt(r)}</td>
    <td class="align-right">${$t(l)}</td>
  `;const u=(d=s.cells)==null?void 0:d[3];u&&(u.dataset.gainPct=Number.isFinite(l)?`${re(l)} %`:"—",u.dataset.gainSign=Number.isFinite(l)?l>0?"positive":l<0?"negative":"neutral":"neutral"),s.dataset.positionCount=String(Math.round(a)),s.dataset.currentValue=String(n),s.dataset.purchaseSum=String(i),s.dataset.gainAbs=String(r),s.dataset.gainPct=String(l)}function re(e){return(Number.isNaN(e)?0:e).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}function Tt(e){return`<span class="${e>=0?"positive":"negative"}">${re(e)}&nbsp;€</span>`}function $t(e){return`<span class="${e>=0?"positive":"negative"}">${re(e)}&nbsp;%</span>`}function Mt(e,t,n){const r=n||document,i=(Array.isArray(e)?e:[]).reduce((u,c)=>{const d=c!=null&&typeof c=="object"?c.balance??c.current_value??c.value??0:c,f=Number(d);return u+(Number.isFinite(f)?f:0)},0),a=(Array.isArray(t)?t:[]).reduce((u,c)=>{const d=c!=null&&typeof c=="object"?c.current_value??c.value??0:c,f=Number(d);return u+(Number.isFinite(f)?f:0)},0),l=i+a,s=r==null?void 0:r.querySelector("#headerMeta");if(!s){console.warn("updateTotalWealth: #headerMeta nicht gefunden.");return}const o=s.querySelector("strong")||s.querySelector(".total-wealth-value");o?o.textContent=`${re(l)} €`:s.textContent=`💰 Gesamtvermögen: ${re(l)} €`,s.dataset.totalWealthEur=String(l)}function Bn(e,t){const n=typeof e=="string"?e:e&&e.last_file_update||"";if(!t){console.warn("handleLastFileUpdate: root fehlt");return}let r=t.querySelector(".footer-card .last-file-update")||t.querySelector(".last-file-update");if(!r){const i=t.querySelector(".footer-card .meta")||t.querySelector("#headerMeta")||t.querySelector(".header-card .meta")||t.querySelector(".header-card");if(!i){console.warn("handleLastFileUpdate: Kein Einfügepunkt gefunden.");return}r=document.createElement("div"),r.className="last-file-update",i.appendChild(r)}r.closest(".footer-card")?r.innerHTML=n?`📂 Letzte Aktualisierung der Datei: <strong>${n}</strong>`:"📂 Letzte Aktualisierung der Datei: <strong>Unbekannt</strong>":r.textContent=n?`📂 Letzte Aktualisierung: ${n}`:"📂 Letzte Aktualisierung: Unbekannt"}function Gn(e){if(!e)return;const t=e.querySelector("table.sortable-positions");if(!t)return;const n=e.dataset.sortKey||t.dataset.defaultSort||"name",i=(e.dataset.sortDir||t.dataset.defaultDir||"asc")==="desc"?"desc":"asc";e.dataset.sortKey=n,e.dataset.sortDir=i,xt(t,n,i,!0)}window.__ppReaderReapplyPositionsSort=Gn;function z(e){return e==null?0:parseFloat(String(e).replace(/\u00A0/g," ").replace(/[€%]/g,"").replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""))||0}const On=["name","current_holdings","purchase_value","current_value","gain_abs","gain_pct"];function ke(e){return On.includes(e)}function He(e){return e==="asc"||e==="desc"}let Ne=null,Fe=null;const q=new Map,st=1e6;function le(e){const t=Number(e);return Number.isFinite(t)?t:0}function ve(e){const t=le(e);return Math.round(t*100)/100}function Yn(e){const t=le(e);return Math.round(t*st)/st}function kt(e){if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=e.trim();if(t==="")return null;const n=Number(t);return Number.isFinite(n)?n:null}return null}function Se(e){const t=kt(e);return t==null?null:Math.round(t*100)/100}function lt(e){const t=kt(e);return t==null?null:Math.round(t*100)/100}function Ht(e){if(!e)return[];const t=[];for(const n of q.values())if(!(!Array.isArray(n)||n.length===0))for(const r of n){const i=typeof(r==null?void 0:r.security_uuid)=="string"?r.security_uuid:null;r&&i===e&&t.push(r)}return t}function It(e){const t=Ht(e);return t.length?t.map(n=>({...n})):[]}function qt(e){const t=Ht(e);if(!t.length||!e)return null;let n="",r=0,i=0,a=0;for(const u of t){const c=u==null?void 0:u.name;!n&&typeof c=="string"&&(n=c),r+=le(u==null?void 0:u.current_holdings),i+=le(u==null?void 0:u.purchase_value),a+=le(u==null?void 0:u.current_value)}const l=a-i,s=i>0?l/i*100:0,o=r>0?a/r:null;return{security_uuid:e,name:n,total_holdings:Yn(r),purchase_value_eur:ve(i),current_value_eur:ve(a),gain_abs_eur:ve(l),gain_pct:Math.round(s*100)/100,last_price_eur:o!=null?ve(o):null,source:"cache"}}q.getSecuritySnapshot=qt;q.getSecurityPositions=It;window.__ppReaderPortfolioPositionsCache=q;window.__ppReaderGetSecuritySnapshotFromCache||(window.__ppReaderGetSecuritySnapshotFromCache=qt);window.__ppReaderGetSecurityPositionsFromCache||(window.__ppReaderGetSecurityPositionsFromCache=It);const xe=new Set;function Wt(e){if(!e)return;Array.from(e.querySelectorAll("tbody tr")).forEach(n=>{var s,o;const r=((s=n.cells)==null?void 0:s[4])??null,i=((o=n.cells)==null?void 0:o[5])??null;if(!r||!i)return;const a=(i.textContent||"").trim()||"—";let l="neutral";i.querySelector(".positive")?l="positive":i.querySelector(".negative")&&(l="negative"),r.dataset.gainPct=a,r.dataset.gainSign=l})}window.__ppReaderApplyGainPctMetadata||(window.__ppReaderApplyGainPctMetadata=e=>Wt(e));function fe(e){if(!e||e.length===0)return'<div class="no-positions">Keine Positionen vorhanden.</div>';const t=[{key:"name",label:"Wertpapier"},{key:"current_holdings",label:"Bestand",align:"right"},{key:"purchase_value",label:"Kaufwert",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"+/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}],n=e.map(i=>({name:typeof i.name=="string"?i.name:i.name!=null?String(i.name):"",current_holdings:typeof i.current_holdings=="number"||typeof i.current_holdings=="string"?i.current_holdings:null,purchase_value:typeof i.purchase_value=="number"||typeof i.purchase_value=="string"?i.purchase_value:null,current_value:typeof i.current_value=="number"||typeof i.current_value=="string"?i.current_value:null,gain_abs:typeof i.gain_abs=="number"||typeof i.gain_abs=="string"?i.gain_abs:null,gain_pct:typeof i.gain_pct=="number"||typeof i.gain_pct=="string"?i.gain_pct:null})),r=ne(n,t,["purchase_value","current_value","gain_abs"]);try{const i=document.createElement("template");i.innerHTML=r.trim();const a=i.content.querySelector("table");if(a){a.classList.add("sortable-positions");const l=a.querySelectorAll("thead th");return t.forEach((o,u)=>{const c=l[u];c&&(c.setAttribute("data-sort-key",o.key),c.classList.add("sortable-col"))}),a.querySelectorAll("tbody tr").forEach((o,u)=>{if(o.classList.contains("footer-row"))return;const c=e[u];if(!c)return;const d=typeof c.security_uuid=="string"?c.security_uuid:null;d&&(o.dataset.security=d),o.classList.add("position-row")}),a.dataset.defaultSort="name",a.dataset.defaultDir="asc",Wt(a),a.outerHTML}}catch(i){console.warn("renderPositionsTable: Konnte Sortier-Metadaten nicht injizieren:",i)}return r}window.__ppReaderRenderPositionsTable=fe;function zn(e,t){if(!t)return;const n=e.querySelector(`.portfolio-details[data-portfolio="${t}"]`);if(!n)return;const r=n.querySelector(".positions-container");!r||r.__ppReaderSecurityClickBound||(r.__ppReaderSecurityClickBound=!0,r.addEventListener("click",i=>{const a=i.target;if(!(a instanceof Element))return;const l=a.closest("button, a");if(l&&r.contains(l))return;const s=a.closest("tr[data-security]");if(!s||!r.contains(s))return;const o=s.getAttribute("data-security");if(o)try{_n(o)||console.warn("attachSecurityDetailDelegation: Detail-Tab konnte nicht geöffnet werden für",o)}catch(u){console.error("attachSecurityDetailDelegation: Fehler beim Öffnen des Detail-Tabs",u)}}))}function he(e,t){zn(e,t)}window.__ppReaderAttachSecurityDetailListener||(window.__ppReaderAttachSecurityDetailListener=he);function Vt(e){console.debug("buildExpandablePortfolioTable: render",e.length,"portfolios");const t=g=>g==null?"":String(g).replace(/&/g,"&amp;").replace(/"/g,"&quot;");let n='<table class="expandable-portfolio-table"><thead><tr>';[{key:"name",label:"Name"},{key:"position_count",label:"Anzahl Positionen",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"Gesamt +/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}].forEach(g=>{const p=g.align==="right"?' class="align-right"':"";n+=`<th${p}>${g.label}</th>`}),n+="</tr></thead><tbody>",e.forEach(g=>{if(!g||!g.uuid)return;const p=Number.isFinite(g.position_count)?g.position_count:0,P=Number.isFinite(g.purchase_sum)?g.purchase_sum:0,A=g.hasValue&&typeof g.current_value=="number"&&Number.isFinite(g.current_value),F=A?g.current_value:null,S=typeof g.gain_abs=="number"&&Number.isFinite(g.gain_abs)?g.gain_abs:A&&F!=null?F-P:null,w=typeof g.gain_pct=="number"&&Number.isFinite(g.gain_pct)?g.gain_pct:A&&P>0&&S!=null?S/P*100:null,E=g.fx_unavailable&&A,C=xe.has(g.uuid),T=C?"portfolio-toggle expanded":"portfolio-toggle",I=`portfolio-details-${g.uuid}`,k={fx_unavailable:g.fx_unavailable,current_value:F,gain_abs:S,gain_pct:w},H={hasValue:A},y=U("current_value",k.current_value,k,H),N=U("gain_abs",k.gain_abs,k,H),L=U("gain_pct",k.gain_pct,k,H),$=A&&typeof w=="number"&&Number.isFinite(w)?`${B(w)} %`:"",W=A&&typeof w=="number"&&Number.isFinite(w)?w>0?"positive":w<0?"negative":"neutral":"",O=A&&typeof F=="number"&&Number.isFinite(F)?F:"",ye=A&&typeof S=="number"&&Number.isFinite(S)?S:"",Z=A&&typeof w=="number"&&Number.isFinite(w)?w:"";let V="";$&&(V=` data-gain-pct="${t($)}" data-gain-sign="${t(W)}"`),E&&(V+=' data-partial="true"'),n+=`<tr class="portfolio-row"
                data-portfolio="${g.uuid}"
                data-position-count="${p}"
                data-current-value="${t(O)}"
                data-purchase-sum="${t(P)}"
                data-gain-abs="${t(ye)}"
                data-gain-pct="${t(Z)}"
                data-has-value="${A?"true":"false"}"
                data-fx-unavailable="${g.fx_unavailable?"true":"false"}">`,n+=`<td>
        <button type="button"
                class="${T}"
                data-portfolio="${g.uuid}"
                aria-expanded="${C?"true":"false"}"
                aria-controls="${I}">
          <span class="caret">${C?"▼":"▶"}</span>
          <span class="portfolio-name">${g.name}</span>
        </button>
      </td>`,n+=`<td class="align-right">${p}</td>`,n+=`<td class="align-right">${y}</td>`,n+=`<td class="align-right"${V}>${N}</td>`,n+=`<td class="align-right gain-pct-cell">${L}</td>`,n+="</tr>",n+=`<tr class="portfolio-details${C?"":" hidden"}"
                data-portfolio="${g.uuid}"
                id="${I}"
                role="region"
                aria-label="Positionen für ${g.name}">
      <td colspan="5">
        <div class="positions-container">${C?q.has(g.uuid)?fe(q.get(g.uuid)??[]):'<div class="loading">Lade Positionen...</div>':""}</div>
      </td>
    </tr>`});const i=e.filter(g=>typeof(g==null?void 0:g.current_value)=="number"&&Number.isFinite(g.current_value)),a=e.reduce((g,p)=>g+(Number.isFinite(p==null?void 0:p.position_count)?p.position_count:0),0),l=i.reduce((g,p)=>typeof p.current_value=="number"&&Number.isFinite(p.current_value)?g+p.current_value:g,0),s=i.reduce((g,p)=>typeof p.purchase_sum=="number"&&Number.isFinite(p.purchase_sum)?g+p.purchase_sum:g,0),o=i.reduce((g,p)=>{const P=typeof p.current_value=="number"&&Number.isFinite(p.current_value)?p.current_value:0,A=typeof p.purchase_sum=="number"&&Number.isFinite(p.purchase_sum)?p.purchase_sum:0;return g+(P-A)},0),u=i.length>0,c=i.length!==e.length,d=u&&s>0?o/s*100:null,f={fx_unavailable:c,current_value:u?l:null,gain_abs:u?o:null,gain_pct:u?d:null},b={hasValue:u},m=U("current_value",f.current_value,f,b),v=U("gain_abs",f.gain_abs,f,b),h=U("gain_pct",f.gain_pct,f,b);let _="";if(u&&typeof d=="number"&&Number.isFinite(d)){const g=`${B(d)} %`,p=d>0?"positive":d<0?"negative":"neutral";_=` data-gain-pct="${t(g)}" data-gain-sign="${t(p)}"`}return c&&(_+=' data-partial="true"'),n+=`<tr class="footer-row"
    data-position-count="${a}"
    data-current-value="${t(u?l:"")}"
    data-purchase-sum="${t(u?s:"")}"
    data-gain-abs="${t(u?o:"")}"
    data-gain-pct="${t(u&&typeof d=="number"&&Number.isFinite(d)?d:"")}"
    data-has-value="${u?"true":"false"}"
    data-fx-unavailable="${c?"true":"false"}">
    <td>Summe</td>
    <td class="align-right">${Math.round(a).toLocaleString("de-DE")}</td>
    <td class="align-right">${m}</td>
    <td class="align-right"${_}>${v}</td>
    <td class="align-right gain-pct-cell">${h}</td>
  </tr>`,n+="</tbody></table>",n}function Kn(e){if(e instanceof HTMLTableElement)return e;if(e&&"querySelector"in e){const t=e.querySelector("table.expandable-portfolio-table");if(t)return t;const n=e.querySelector(".portfolio-table table");if(n)return n;const r=e.querySelector("table");if(r)return r}return document.querySelector(".portfolio-table table.expandable-portfolio-table")||document.querySelector(".portfolio-table table")}function Pe(e){if(e===void 0)return null;const t=Number(e);return Number.isFinite(t)?t:null}function Ie(e){if(!e)return 0;const t=e.textContent||"";if(!t)return 0;const n=t.replace(/[^0-9,.-]/g,"").replace(/\./g,"").replace(",","."),r=Number.parseFloat(n);return Number.isFinite(r)?r:0}function Ut(e){var g;const t=Kn(e);if(!t)return;const n=(g=t.tBodies)==null?void 0:g[0];if(!n)return;const r=Array.from(n.querySelectorAll("tr.portfolio-row"));if(!r.length)return;let i=0,a=0,l=0,s=0,o=0;for(const p of r){const P=p.dataset.hasValue,A=!(P==="false"||P==="0"||P===""||P==null),F=Pe(p.dataset.positionCount)??Ie(p.cells.item(1));if(i+=F,!A){o+=1;continue}const S=Pe(p.dataset.currentValue)??Ie(p.cells.item(2)),w=Pe(p.dataset.gainAbs)??Ie(p.cells.item(3)),E=Pe(p.dataset.purchaseSum),C=E??S-w;a+=S,s+=w,l+=C}const u=o===0;!u&&l>0&&(l=a-s),u&&l<=0&&(l=a-s);const c=u&&l>0?s/l*100:null;let d=Array.from(n.children).find(p=>p instanceof HTMLTableRowElement&&p.classList.contains("footer-row"));d||(d=document.createElement("tr"),d.classList.add("footer-row"),n.appendChild(d));const f=Math.round(i).toLocaleString("de-DE"),b=(p="Wert nicht verfügbar")=>`<span class="missing-value" role="note" aria-label="${p}" title="${p}">—</span>`,m="Teilweise fehlende Wechselkurse – Wert unbekannt",v=u?`${B(a)}&nbsp;€`:b(m),h=u?Nt(s):b(m),_=u&&c!=null?Ft(c):b(m);d.innerHTML=`
    <td>Summe</td>
    <td class="align-right">${f}</td>
    <td class="align-right">${v}</td>
    <td class="align-right">${h}</td>
    <td class="align-right">${_}</td>
  `,d.dataset.positionCount=String(Math.round(i)),d.dataset.currentValue=u?String(a):"",d.dataset.purchaseSum=u?String(l):"",d.dataset.gainAbs=u?String(s):"",d.dataset.gainPct=u&&typeof c=="number"?String(c):"",d.dataset.hasValue=u?"true":"false"}window.__ppReaderUpdatePortfolioFooter=Ut;function pe(e,t){if(!t)return;const n=e.querySelector(`.portfolio-details[data-portfolio="${t}"]`);if(!n)return;const r=n.querySelector(".positions-container");if(!r)return;const i=r.querySelector("table.sortable-positions");if(!i||i.__ppReaderSortingBound)return;i.__ppReaderSortingBound=!0;const a=(f,b)=>{const m=i.querySelector("tbody");if(!m)return;const v=Array.from(m.querySelectorAll("tr")).filter(p=>!p.classList.contains("footer-row")),h=m.querySelector("tr.footer-row"),_=p=>{if(p==null)return 0;const P=p.replace(/\u00A0/g," ").replace(/[%€]/g,"").replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""),A=Number.parseFloat(P);return Number.isFinite(A)?A:0};v.sort((p,P)=>{var C,T,I,k;const F={name:0,current_holdings:1,purchase_value:2,current_value:3,gain_abs:4,gain_pct:5}[f];if(F==null)return 0;const S=((T=(C=p.cells[F])==null?void 0:C.textContent)==null?void 0:T.trim())??"",w=((k=(I=P.cells[F])==null?void 0:I.textContent)==null?void 0:k.trim())??"";let E;return f==="name"?E=S.localeCompare(w,"de",{sensitivity:"base"}):E=_(S)-_(w),b==="asc"?E:-E}),i.querySelectorAll("thead th.sort-active").forEach(p=>{p.classList.remove("sort-active","dir-asc","dir-desc")});const g=i.querySelector(`thead th[data-sort-key="${f}"]`);g&&g.classList.add("sort-active",b==="asc"?"dir-asc":"dir-desc"),v.forEach(p=>m.appendChild(p)),h&&m.appendChild(h)},l=r.dataset.sortKey,s=r.dataset.sortDir,o=i.dataset.defaultSort,u=i.dataset.defaultDir,c=ke(l)?l:ke(o)?o:"name",d=He(s)?s:He(u)?u:"asc";a(c,d),i.addEventListener("click",f=>{const b=f.target;if(!(b instanceof Element))return;const m=b.closest("th[data-sort-key]");if(!m||!i.contains(m))return;const v=m.getAttribute("data-sort-key");if(!ke(v))return;let h="asc";r.dataset.sortKey===v&&(h=(He(r.dataset.sortDir)?r.dataset.sortDir:"asc")==="asc"?"desc":"asc"),r.dataset.sortKey=v,r.dataset.sortDir=h,a(v,h)})}window.__ppReaderAttachPortfolioPositionsSorting||(window.__ppReaderAttachPortfolioPositionsSorting=pe);async function jn(e,t,n){if(!e||!Ne||!Fe)return;const r=t||n.querySelector(`.portfolio-details[data-portfolio="${e}"] .positions-container`);if(!r)return;const i=r.closest(".portfolio-details");if(!(i&&i.classList.contains("hidden"))){r.innerHTML='<div class="loading">Neu laden...</div>';try{const a=await Et(Ne,Fe,e);if(a.error){const s=typeof a.error=="string"?a.error:String(a.error);r.innerHTML=`<div class="error">${s} <button class="retry-pos" data-portfolio="${e}">Erneut laden</button></div>`;return}const l=a.positions??[];q.set(e,l),r.innerHTML=fe(l);try{pe(n,e)}catch(s){console.warn("attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:",s)}try{he(n,e)}catch(s){console.warn("reloadPortfolioPositions: Security-Listener konnte nicht gebunden werden:",s)}}catch(a){const l=a instanceof Error?a.message:String(a);r.innerHTML=`<div class="error">Fehler: ${l} <button class="retry-pos" data-portfolio="${e}">Retry</button></div>`}}}async function Xn(e,t,n=3e3,r=50){const i=performance.now();return new Promise(a=>{const l=()=>{const s=e.querySelector(t);if(s)return a(s);if(performance.now()-i>n)return a(null);setTimeout(l,r)};l()})}function Ze(e){if(!e)return;const t=(e.__ppReaderAttachToken??0)+1;e.__ppReaderAttachToken=t,e.__ppReaderAttachInProgress=!0,(async()=>{try{const n=await Xn(e,".portfolio-table");if(t!==e.__ppReaderAttachToken)return;if(!n){console.warn("attachPortfolioToggleHandler: .portfolio-table nicht gefunden (Timeout)");return}if(n.querySelectorAll(".portfolio-toggle").length===0&&console.debug("attachPortfolioToggleHandler: Noch keine Buttons – evtl. Recovery später"),n.__ppReaderPortfolioToggleBound)return;n.__ppReaderPortfolioToggleBound=!0,console.debug("attachPortfolioToggleHandler: Listener registriert"),n.addEventListener("click",async i=>{try{const a=i.target;if(!(a instanceof Element))return;const l=a.closest(".retry-pos");if(l&&n.contains(l)){const f=l.getAttribute("data-portfolio");if(f){const b=e.querySelector(`.portfolio-details[data-portfolio="${f}"]`),m=b==null?void 0:b.querySelector(".positions-container");await jn(f,m??null,e)}return}const s=a.closest(".portfolio-toggle");if(!s||!n.contains(s))return;const o=s.getAttribute("data-portfolio");if(!o)return;const u=e.querySelector(`.portfolio-details[data-portfolio="${o}"]`);if(!u)return;const c=s.querySelector(".caret");if(u.classList.contains("hidden")){u.classList.remove("hidden"),s.classList.add("expanded"),s.setAttribute("aria-expanded","true"),c&&(c.textContent="▼"),xe.add(o);let f=!1;try{f=Me(e,o)}catch(b){console.warn("attachPortfolioToggleHandler: Pending-Flush fehlgeschlagen:",b)}if(!f&&window.__ppReaderFlushPendingPositions)try{f=window.__ppReaderFlushPendingPositions(e,o)}catch(b){console.warn("attachPortfolioToggleHandler: Global Pending-Flush fehlgeschlagen:",b)}if(q.has(o)){const b=u.querySelector(".positions-container");if(b){b.innerHTML=fe(q.get(o)??[]),pe(e,o);try{he(e,o)}catch(m){console.warn("attachPortfolioToggleHandler: Security-Listener (Cache) Fehler:",m)}}}else{const b=u.querySelector(".positions-container");b&&(b.innerHTML='<div class="loading">Lade Positionen...</div>');try{const m=await Et(Ne,Fe,o);if(m.error){const h=typeof m.error=="string"?m.error:String(m.error);b&&(b.innerHTML=`<div class="error">${h} <button class="retry-pos" data-portfolio="${o}">Erneut laden</button></div>`);return}const v=m.positions??[];if(q.set(o,v),b){b.innerHTML=fe(v);try{pe(e,o)}catch(h){console.warn("attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:",h)}try{he(e,o)}catch(h){console.warn("attachPortfolioToggleHandler: Security-Listener konnte nicht gebunden werden:",h)}}}catch(m){const v=m instanceof Error?m.message:String(m),h=u.querySelector(".positions-container");h&&(h.innerHTML=`<div class="error">Fehler beim Laden: ${v} <button class="retry-pos" data-portfolio="${o}">Retry</button></div>`),console.error("Fehler beim Lazy Load für",o,m)}}}else u.classList.add("hidden"),s.classList.remove("expanded"),s.setAttribute("aria-expanded","false"),c&&(c.textContent="▶"),xe.delete(o)}catch(a){console.error("attachPortfolioToggleHandler: Ungefangener Fehler im Click-Handler",a)}})}finally{t===e.__ppReaderAttachToken&&(e.__ppReaderAttachInProgress=!1)}})()}function Zn(e){const t=e.querySelector(".expandable-portfolio-table");t&&(t.__ppReaderPortfolioFallbackBound||(t.__ppReaderPortfolioFallbackBound=!0,t.addEventListener("click",n=>{const r=n.target;if(!(r instanceof Element)||!r.closest(".portfolio-toggle"))return;const a=e.querySelector(".portfolio-table");a!=null&&a.__ppReaderPortfolioToggleBound||(console.debug("Fallback-Listener aktiv – re-attach Hauptlistener"),Ze(e))})))}async function Bt(e,t,n){var I,k,H;Ne=t??null,Fe=n??null,console.debug("renderDashboard: start – panelConfig:",n==null?void 0:n.config,"derived entry_id?",(H=(k=(I=n==null?void 0:n.config)==null?void 0:I._panel_custom)==null?void 0:k.config)==null?void 0:H.entry_id);const r=await Fn(t,n),a=((r==null?void 0:r.accounts)??[]).map(y=>({name:y.name??"—",balance:typeof y.balance=="number"&&Number.isFinite(y.balance)?y.balance:null,currency_code:y.currency_code??null,orig_balance:typeof y.orig_balance=="number"&&Number.isFinite(y.orig_balance)?y.orig_balance:null,fx_unavailable:!!y.fx_unavailable})),s=((await En(t,n)).portfolios??[]).map(y=>{const N=typeof y.uuid=="string"&&y.uuid?y.uuid:null;if(!N)return null;const L=typeof y.missing_value_positions=="number"?y.missing_value_positions:0,$=Se(y.current_value),W=Se(y.purchase_sum)??0,O=Se(y.gain_abs),ye=lt(y.gain_pct),Z=$!=null;let V;O!=null?V=O:Z?V=Se($-W):V=null;let _e;ye!=null?_e=ye:Z&&W>0&&V!=null?_e=lt(V/W*100):_e=null;const Sn=L>0,it=Z,Pn=Sn||!it;return{uuid:N,name:y.name??"Unbenanntes Depot",position_count:typeof y.position_count=="number"?y.position_count:0,current_value:Z?$:null,purchase_sum:W,gain_abs:V,gain_pct:_e,hasValue:it,missing_value_positions:L,fx_unavailable:Pn}}).filter(y=>y!==null);let o="";try{o=await xn(t,n)}catch{o=""}const u=a.reduce((y,N)=>y+(typeof N.balance=="number"&&Number.isFinite(N.balance)?N.balance:0),0),c=s.some(y=>y.fx_unavailable),d=a.some(y=>y.fx_unavailable&&(y.balance==null||!Number.isFinite(y.balance))),f=s.reduce((y,N)=>N.hasValue&&typeof N.current_value=="number"&&Number.isFinite(N.current_value)?y+N.current_value:y,0),b=u+f,m="Teilw. fehlende FX-Kurse – Gesamtvermögen abweichend",h=s.some(y=>y.hasValue&&typeof y.current_value=="number"&&Number.isFinite(y.current_value))||a.some(y=>typeof y.balance=="number"&&Number.isFinite(y.balance))?`${B(b)}&nbsp;€`:`<span class="missing-value" role="note" aria-label="${m}" title="${m}">—</span>`,_=c||d?`<span class="total-wealth-note">${m}</span>`:"",g=`
    <div class="header-meta-row">
      💰 Gesamtvermögen: <strong class="total-wealth-value">${h}</strong>${_}
    </div>
  `,p=Ue("Übersicht",g),P=Vt(s),A=a.filter(y=>(y.currency_code??"EUR")==="EUR"),F=a.filter(y=>(y.currency_code??"EUR")!=="EUR"),w=F.some(y=>y.fx_unavailable)?`
        <p class="table-note" role="note">
          <span class="table-note__icon" aria-hidden="true">⚠️</span>
          <span>Wechselkurse konnten nicht geladen werden. EUR-Werte werden derzeit nicht angezeigt.</span>
        </p>
      `:"",E=`
    <div class="card">
      <h2>Liquidität</h2>
      <div class="scroll-container account-table">
        ${ne(A.map(y=>({name:y.name,balance:y.balance??null})),[{key:"name",label:"Name"},{key:"balance",label:"Kontostand (EUR)",align:"right"}],["balance"])}
      </div>
    </div>
    ${F.length?`
      <div class="card">
        <h2>Fremdwährungen</h2>
        <div class="scroll-container fx-account-table">
          ${ne(F.map(y=>({name:y.name,fx_display:`${(y.orig_balance??0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}&nbsp;${y.currency_code??""}`,balance:y.balance??null})),[{key:"name",label:"Name"},{key:"fx_display",label:"Betrag (FX)"},{key:"balance",label:"EUR",align:"right"}],["balance"])}
        </div>
        ${w}
      </div>`:""}
  `,C=`
    <div class="card footer-card">
      <div class="meta">
        <div class="last-file-update">
          📂 Letzte Aktualisierung der Datei: <strong>${o||"Unbekannt"}</strong>
        </div>
      </div>
    </div>
  `,T=`
    ${p.outerHTML}
    <div class="card">
      <h2>Investment</h2>
      <div class="scroll-container portfolio-table">
        ${P}
      </div>
    </div>
    ${E}
    ${C}
  `;return Jn(e,s),T}function Jn(e,t){if(!e)return;const n=()=>{try{const i=e,a=i.querySelector(".portfolio-table");a&&a.querySelectorAll(".portfolio-toggle").length===0&&(console.debug("Recovery: Tabelle ohne Buttons – erneuter Aufbau"),a.innerHTML=Vt(t)),Ze(e),Zn(e),xe.forEach(l=>{try{q.has(l)&&(pe(e,l),he(e,l))}catch(s){console.warn("Init-Sortierung für expandiertes Depot fehlgeschlagen:",l,s)}});try{Ut(i)}catch(l){console.warn("renderDashboard: Footer-Summe konnte nicht aktualisiert werden:",l)}try{Lt(e)}catch(l){console.warn("renderDashboard: Pending-Positions konnten nicht angewendet werden:",l)}console.debug("renderDashboard: portfolio-toggle Buttons:",i.querySelectorAll(".portfolio-toggle").length)}catch(i){console.error("renderDashboard: Fehler bei Recovery/Listener",i)}},r=typeof requestAnimationFrame=="function"?i=>requestAnimationFrame(i):i=>setTimeout(i,0);r(()=>r(n))}const Qn="http://www.w3.org/2000/svg",ce=640,ue=260,oe={top:12,right:16,bottom:24,left:16},se="var(--pp-reader-chart-line, #3f51b5)",Be="var(--pp-reader-chart-area, rgba(63, 81, 181, 0.12))",ct="0.75rem",Gt="var(--pp-reader-chart-baseline, rgba(96, 125, 139, 0.75))",Ot="6 4",er=24*60*60*1e3;function Y(e,t={}){const n=document.createElementNS(Qn,e);return Object.entries(t).forEach(([r,i])=>{i!=null&&n.setAttribute(r,String(i))}),n}function ut(e,t=null){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"&&e.trim()!==""){const n=Number.parseFloat(e);if(Number.isFinite(n))return n}return t}function tr(e,t){if(e instanceof Date){const n=e.getTime();return Number.isFinite(n)?n:t}if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"){const n=Date.parse(e);if(Number.isFinite(n))return n}return t}const Yt=e=>{if(e&&typeof e=="object"&&"date"in e)return e.date},zt=e=>{if(e&&typeof e=="object"&&"close"in e)return e.close},Kt=(e,t,n)=>{if(Number.isFinite(e)){const r=new Date(e);if(!Number.isNaN(r.getTime()))return r.toLocaleDateString("de-DE")}if(t&&typeof t=="object"&&"date"in t){const r=t.date;return r!=null?String(r):""}return e==null?"":String(e)},Je=(e,t,n)=>(Number.isFinite(e)?e:Number.parseFloat(String(e))||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}),jt=({xFormatted:e,yFormatted:t})=>`
    <div class="chart-tooltip-date">${e}</div>
    <div class="chart-tooltip-value">${t}&nbsp;€</div>
  `;function Xt(e){return e.__chartState||(e.__chartState={svg:null,areaPath:null,linePath:null,baselineLine:null,focusLine:null,focusCircle:null,overlay:null,tooltip:null,width:ce,height:ue,margin:{...oe},series:[],points:[],range:null,xAccessor:Yt,yAccessor:zt,xFormatter:Kt,yFormatter:Je,tooltipRenderer:jt,color:se,areaColor:Be,baseline:null,handlersAttached:!1}),e.__chartState}function j(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function nr(e,t){if(!Array.isArray(e)||e.length===0)return"";const n=e.map((i,a)=>`${a===0?"M":"L"}${i.x.toFixed(2)} ${i.y.toFixed(2)}`).join(" "),r=`L${e[e.length-1].x.toFixed(2)} ${t.toFixed(2)} L${e[0].x.toFixed(2)} ${t.toFixed(2)} Z`;return`${n} ${r}`}function rr(e){return!Array.isArray(e)||e.length===0?"":e.map((t,n)=>`${n===0?"M":"L"}${t.x.toFixed(2)} ${t.y.toFixed(2)}`).join(" ")}function ir(e){const{baselineLine:t,baseline:n}=e;if(!t)return;const r=(n==null?void 0:n.color)??Gt,i=(n==null?void 0:n.dashArray)??Ot;t.setAttribute("stroke",r),t.setAttribute("stroke-dasharray",i)}function dt(e){const{baselineLine:t,baseline:n,range:r,margin:i,width:a}=e;if(!t)return;const l=n==null?void 0:n.value;if(!r||l==null||!Number.isFinite(l)){t.style.opacity="0";return}const{minY:s,maxY:o,boundedHeight:u}=r,c=Number.isFinite(s)?s:l,f=(Number.isFinite(o)?o:c+1)-c,b=f===0?.5:(l-c)/f,m=j(b,0,1),v=Math.max(u,0),h=i.top+(1-m)*v,_=Math.max(a-i.left-i.right,0),g=i.left,p=i.left+_;t.setAttribute("x1",g.toFixed(2)),t.setAttribute("x2",p.toFixed(2)),t.setAttribute("y1",h.toFixed(2)),t.setAttribute("y2",h.toFixed(2)),t.style.opacity="1"}function ar(e,t,n){var H;const{width:r,height:i,margin:a}=t,{xAccessor:l,yAccessor:s}=n;if(!Array.isArray(e)||e.length===0)return{points:[],range:null};const o=e.map((y,N)=>{const L=l(y,N),$=s(y,N),W=tr(L,N),O=ut($,Number.NaN);return Number.isFinite(O)?{index:N,data:y,xValue:W,yValue:O}:null}).filter(y=>!!y);if(o.length===0)return{points:[],range:null};const u=o.reduce((y,N)=>Math.min(y,N.xValue),o[0].xValue),c=o.reduce((y,N)=>Math.max(y,N.xValue),o[0].xValue),d=o.reduce((y,N)=>Math.min(y,N.yValue),o[0].yValue),f=o.reduce((y,N)=>Math.max(y,N.yValue),o[0].yValue),b=Math.max(r-a.left-a.right,1),m=Math.max(i-a.top-a.bottom,1),v=Number.isFinite(u)?u:0,h=Number.isFinite(c)?c:v+1,_=Number.isFinite(d)?d:0,g=Number.isFinite(f)?f:_+1,p=ut((H=t.baseline)==null?void 0:H.value,null),P=p!=null&&Number.isFinite(p)?Math.min(_,p):_,A=p!=null&&Number.isFinite(p)?Math.max(g,p):g,F=Math.max(2,Math.min(6,Math.round(Math.max(i-a.top-a.bottom,0)/60)||4)),{niceMin:S,niceMax:w}=ur(P,A,F),E=Number.isFinite(S)?S:_,C=Number.isFinite(w)?w:g,T=h-v||1,I=C-E||1;return{points:o.map(y=>{const N=T===0?.5:(y.xValue-v)/T,L=I===0?.5:(y.yValue-E)/I,$=a.left+N*b,W=a.top+(1-L)*m;return{...y,x:$,y:W}}),range:{minX:v,maxX:h,minY:E,maxY:C,boundedWidth:b,boundedHeight:m}}}function Zt(e,t,n,r){e.width=Number.isFinite(t)?Number(t):ce,e.height=Number.isFinite(n)?Number(n):ue,e.margin={top:Number.isFinite(r==null?void 0:r.top)?Number(r==null?void 0:r.top):oe.top,right:Number.isFinite(r==null?void 0:r.right)?Number(r==null?void 0:r.right):oe.right,bottom:Number.isFinite(r==null?void 0:r.bottom)?Number(r==null?void 0:r.bottom):oe.bottom,left:Number.isFinite(r==null?void 0:r.left)?Number(r==null?void 0:r.left):oe.left}}function or(e,t){const n=e.xFormatter(t.xValue,t.data,t.index),r=e.yFormatter(t.yValue,t.data,t.index);return e.tooltipRenderer({point:t,xFormatted:n,yFormatted:r,data:t.data,index:t.index})}function sr(e,t,n){const{tooltip:r,width:i,margin:a,height:l}=e;if(!r)return;const s=l-a.bottom;r.style.visibility="visible",r.style.opacity="1";const o=r.offsetWidth||0,u=r.offsetHeight||0,c=j(t.x-o/2,a.left,i-a.right-o),d=Math.max(s-u,0),f=12,b=Number.isFinite(n)?j(n??0,a.top,s):t.y;let m=b-u-f;m<a.top&&(m=b+f),m=j(m,0,d),r.style.transform=`translate(${Math.round(c)}px, ${Math.round(m)}px)`}function we(e){const{tooltip:t,focusLine:n,focusCircle:r}=e;t&&(t.style.opacity="0",t.style.visibility="hidden"),n&&(n.style.opacity="0"),r&&(r.style.opacity="0")}function lr(e,t){if(t.handlersAttached||!t.overlay)return;const n=i=>{if(!t.points||t.points.length===0||!t.svg){we(t);return}const a=t.svg.getBoundingClientRect(),l=i.clientX-a.left,s=i.clientY-a.top;let o=t.points[0],u=Math.abs(l-o.x);for(let c=1;c<t.points.length;c+=1){const d=t.points[c],f=Math.abs(l-d.x);f<u&&(u=f,o=d)}if(!o){we(t);return}t.focusCircle&&(t.focusCircle.setAttribute("cx",o.x.toFixed(2)),t.focusCircle.setAttribute("cy",o.y.toFixed(2)),t.focusCircle.style.opacity="1"),t.focusLine&&(t.focusLine.setAttribute("x1",o.x.toFixed(2)),t.focusLine.setAttribute("x2",o.x.toFixed(2)),t.focusLine.setAttribute("y1",t.margin.top.toFixed(2)),t.focusLine.setAttribute("y2",(t.height-t.margin.bottom).toFixed(2)),t.focusLine.style.opacity="1"),t.tooltip&&(t.tooltip.innerHTML=or(t,o),sr(t,o,s))},r=()=>{we(t)};t.overlay.addEventListener("pointermove",n),t.overlay.addEventListener("pointerenter",n),t.overlay.addEventListener("pointerleave",r),t.handlersAttached=!0,t.handlePointerMove=n,t.handlePointerLeave=r,e.addEventListener("pointercancel",r)}function cr(e,t={}){if(!e)return console.error("renderLineChart: root element is required"),null;const n=document.createElement("div");n.className="line-chart-container",n.dataset.chartType="line",n.style.position="relative";const r=Y("svg",{width:ce,height:ue,viewBox:`0 0 ${ce} ${ue}`,role:"img","aria-hidden":"true",focusable:"false"});r.classList.add("line-chart-svg");const i=Y("path",{class:"line-chart-area",fill:Be,stroke:"none"}),a=Y("line",{class:"line-chart-baseline",stroke:Gt,"stroke-width":1,"stroke-dasharray":Ot,opacity:0}),l=Y("path",{class:"line-chart-path",fill:"none",stroke:se,"stroke-width":2,"stroke-linecap":"round","stroke-linejoin":"round"}),s=Y("line",{class:"line-chart-focus-line",stroke:se,"stroke-width":1,"stroke-dasharray":"4 4",opacity:0}),o=Y("circle",{class:"line-chart-focus-circle",r:4,fill:"#fff",stroke:se,"stroke-width":2,opacity:0}),u=Y("rect",{class:"line-chart-overlay",fill:"transparent",x:0,y:0,width:ce,height:ue});r.appendChild(i),r.appendChild(a),r.appendChild(l),r.appendChild(s),r.appendChild(o),r.appendChild(u),n.appendChild(r);const c=document.createElement("div");c.className="chart-tooltip",c.style.position="absolute",c.style.top="0",c.style.left="0",c.style.pointerEvents="none",c.style.opacity="0",c.style.visibility="hidden",n.appendChild(c),e.appendChild(n);const d=Xt(n);if(d.svg=r,d.areaPath=i,d.linePath=l,d.baselineLine=a,d.focusLine=s,d.focusCircle=o,d.overlay=u,d.tooltip=c,d.xAccessor=t.xAccessor??Yt,d.yAccessor=t.yAccessor??zt,d.xFormatter=t.xFormatter??Kt,d.yFormatter=t.yFormatter??Je,d.tooltipRenderer=t.tooltipRenderer??jt,d.color=t.color??se,d.areaColor=t.areaColor??Be,d.baseline=t.baseline??null,d.handlersAttached=!1,!d.xAxis){const f=document.createElement("div");f.className="line-chart-axis line-chart-axis-x",f.style.position="absolute",f.style.left="0",f.style.right="0",f.style.bottom="0",f.style.pointerEvents="none",f.style.fontSize=ct,f.style.color="var(--secondary-text-color)",f.style.display="block",n.appendChild(f),d.xAxis=f}if(!d.yAxis){const f=document.createElement("div");f.className="line-chart-axis line-chart-axis-y",f.style.position="absolute",f.style.top="0",f.style.bottom="0",f.style.left="0",f.style.pointerEvents="none",f.style.fontSize=ct,f.style.color="var(--secondary-text-color)",f.style.display="block",n.appendChild(f),d.yAxis=f}return Zt(d,t.width,t.height,t.margin),d.linePath&&d.linePath.setAttribute("stroke",d.color),d.focusLine&&d.focusLine.setAttribute("stroke",d.color),d.focusCircle&&d.focusCircle.setAttribute("stroke",d.color),d.areaPath&&d.areaPath.setAttribute("fill",d.areaColor),Jt(n,t),lr(n,d),n}function Jt(e,t={}){if(!e){console.error("updateLineChart: container element is required");return}const n=Xt(e);if(!n.svg||!n.linePath||!n.overlay){console.error("updateLineChart: chart was not initialised with renderLineChart");return}t.xAccessor&&(n.xAccessor=t.xAccessor),t.yAccessor&&(n.yAccessor=t.yAccessor),t.xFormatter&&(n.xFormatter=t.xFormatter),t.yFormatter&&(n.yFormatter=t.yFormatter),t.tooltipRenderer&&(n.tooltipRenderer=t.tooltipRenderer),t.color&&(n.color=t.color,n.linePath.setAttribute("stroke",n.color),n.focusLine&&n.focusLine.setAttribute("stroke",n.color),n.focusCircle&&n.focusCircle.setAttribute("stroke",n.color)),t.areaColor&&(n.areaColor=t.areaColor,n.areaPath&&n.areaPath.setAttribute("fill",n.areaColor)),Object.prototype.hasOwnProperty.call(t,"baseline")&&(n.baseline=t.baseline??null),ir(n),Zt(n,t.width,t.height,t.margin);const{width:r,height:i,margin:a}=n;n.svg.setAttribute("width",String(r)),n.svg.setAttribute("height",String(i)),n.svg.setAttribute("viewBox",`0 0 ${r} ${i}`),n.overlay.setAttribute("x",a.left.toFixed(2)),n.overlay.setAttribute("y",a.top.toFixed(2)),n.overlay.setAttribute("width",Math.max(r-a.left-a.right,0).toFixed(2)),n.overlay.setAttribute("height",Math.max(i-a.top-a.bottom,0).toFixed(2));const l=Array.isArray(t.series)?t.series:n.series;n.series=Array.isArray(l)?[...l]:[];const{points:s,range:o}=ar(n.series,n,{xAccessor:n.xAccessor,yAccessor:n.yAccessor});if(n.points=s,n.range=o,!s||s.length===0){n.linePath.setAttribute("d",""),n.areaPath&&n.areaPath.setAttribute("d",""),we(n),ft(n),dt(n);return}const u=rr(s);if(n.linePath.setAttribute("d",u),n.areaPath&&o){const c=n.margin.top+o.boundedHeight,d=nr(s,c);n.areaPath.setAttribute("d",d)}ft(n),dt(n)}function ft(e){const{xAxis:t,yAxis:n,range:r,margin:i,height:a,yFormatter:l}=e;if(!t||!n)return;if(!r){t.innerHTML="",n.innerHTML="";return}const{minX:s,maxX:o,minY:u,maxY:c,boundedWidth:d,boundedHeight:f}=r,b=Number.isFinite(s)&&Number.isFinite(o)&&o>=s,m=Number.isFinite(u)&&Number.isFinite(c)&&c>=u,v=Math.max(d,0),h=Math.max(f,0);if(t.style.left=`${i.left}px`,t.style.width=`${v}px`,t.style.top=`${a-i.bottom+6}px`,t.innerHTML="",b&&v>0){const g=(o-s)/er,p=Math.max(2,Math.min(6,Math.round(v/140)||4));dr(e,s,o,p,g).forEach(({positionRatio:A,label:F})=>{const S=document.createElement("div");S.className="line-chart-axis-tick line-chart-axis-tick-x",S.style.position="absolute",S.style.bottom="0";const w=j(A,0,1);S.style.left=`${w*v}px`;let E="-50%",C="center";w<=.001?(E="0",C="left",S.style.marginLeft="2px"):w>=.999&&(E="-100%",C="right",S.style.marginRight="2px"),S.style.transform=`translateX(${E})`,S.style.textAlign=C,S.textContent=F,t.appendChild(S)})}n.style.top=`${i.top}px`,n.style.height=`${h}px`;const _=Math.max(i.left-6,0);if(n.style.left="0",n.style.width=`${Math.max(_,0)}px`,n.innerHTML="",m&&h>0){const g=Math.max(2,Math.min(6,Math.round(h/60)||4)),p=fr(u,c,g),P=l??Je;p.forEach(({value:A,positionRatio:F})=>{const S=document.createElement("div");S.className="line-chart-axis-tick line-chart-axis-tick-y",S.style.position="absolute",S.style.left="0";const E=(1-j(F,0,1))*h;S.style.top=`${E}px`,S.textContent=P(A,null,-1),n.appendChild(S)})}}function ur(e,t,n=4){if(!Number.isFinite(e)||!Number.isFinite(t))return{niceMin:e,niceMax:t};const r=Math.max(2,n);if(t===e){const u=Ge(Math.abs(e)||1);return{niceMin:e-u,niceMax:t+u}}const a=(t-e)/(r-1),l=Ge(a),s=Math.floor(e/l)*l,o=Math.ceil(t/l)*l;return s===o?{niceMin:e,niceMax:t+l}:{niceMin:s,niceMax:o}}function dr(e,t,n,r,i){if(!Number.isFinite(t)||!Number.isFinite(n)||n<t)return[];if(!Number.isFinite(i)||i<=0)return[{positionRatio:.5,label:ht(e,t,i||0)}];const a=Math.max(2,r),l=[],s=n-t;for(let o=0;o<a;o+=1){const u=a===1?.5:o/(a-1),c=t+u*s;l.push({positionRatio:u,label:ht(e,c,i)})}return l}function ht(e,t,n){const r=new Date(t);return Number.isFinite(r.getTime())?n>1095?String(r.getFullYear()):n>365?r.toLocaleDateString("de-DE",{year:"numeric",month:"short"}):n>90?r.toLocaleDateString("de-DE",{year:"2-digit",month:"short"}):n>30?r.toLocaleDateString("de-DE",{day:"2-digit",month:"short"}):r.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"}):e.xFormatter?e.xFormatter(t,null,-1):String(t)}function fr(e,t,n){if(!Number.isFinite(e)||!Number.isFinite(t))return[];if(t===e)return[{value:e,positionRatio:.5}];const r=t-e,i=Math.max(2,n),a=r/(i-1),l=Ge(a),s=Math.floor(e/l)*l,o=Math.ceil(t/l)*l,u=[];for(let c=s;c<=o+l/2;c+=l){const d=(c-e)/(t-e);u.push({value:c,positionRatio:j(d,0,1)})}return u.length>i+2?u.filter((c,d)=>d%2===0):u}function Ge(e){if(!Number.isFinite(e)||e===0)return 1;const t=Math.floor(Math.log10(Math.abs(e))),n=Math.abs(e)/10**t;let r;return n<=1?r=1:n<=2?r=2:n<=5?r=5:r=10,r*10**t}const qe={min:0,max:6},pt={min:2,max:4},hr=1e8,pr=6*60*60*1e3,gr=36*60*60*1e3,br="1Y",Qt=["1M","6M","1Y","5Y","ALL"],mr={"1M":30,"6M":182,"1Y":365,"5Y":1826,ALL:Number.POSITIVE_INFINITY},Q=new Map,Ae=new Map,ge=new Map,be=new Map,en="pp-reader:portfolio-positions-updated",de=new Map;function yr(e){const{fallbackUsed:t,flaggedAsCache:n}=e,r=[];return t&&r.push("Der aktuelle Snapshot konnte nicht geladen werden. Es werden die zuletzt gespeicherten Werte angezeigt."),n&&!t&&r.push("Der Snapshot ist vom Datenanbieter als Zwischenspeicherstand markiert."),`
    <div class="card warning-card stale-notice" role="status" aria-live="polite">
      <h2>Zwischengespeicherte Werte</h2>
      <p>${r.length?r.join(" "):"Die Daten stammen aus dem Zwischenspeicher."}</p>
      <p class="stale-notice__hint">Die angezeigten Beträge können von den aktuellen Marktwerten abweichen. Laden Sie die Ansicht erneut, sobald eine Verbindung verfügbar ist.</p>
    </div>
  `}function tn(e,t){if(e){if(t){ge.set(e,t);return}ge.delete(e)}}function _r(e){if(!e||typeof window>"u")return null;if(ge.has(e)){const t=ge.get(e)||null;if(t)return t}try{const t=window.__ppReaderGetSecuritySnapshotFromCache;if(typeof t=="function"){const n=t(e);if(n&&typeof n=="object"){const r=n;return tn(e,r),r}}}catch(t){console.warn("getCachedSecuritySnapshot: Zugriff auf Cache fehlgeschlagen",t)}return null}function nn(e){return Q.has(e)||Q.set(e,new Map),Q.get(e)}function rn(e){if(e&&Q.has(e)){try{const t=Q.get(e);t==null||t.clear()}catch(t){console.warn("invalidateHistoryCache: Konnte Cache nicht leeren",e,t)}Q.delete(e)}}function an(e){e&&(ge.delete(e),be.delete(e))}function vr(e,t){if(!e||!t)return;const n=t.securityUuids;(Array.isArray(n)?n:[]).includes(e)&&(rn(e),an(e))}function Sr(e){if(!e||de.has(e))return;const t=n=>{if(!(n instanceof CustomEvent))return;const r=n.detail;r&&vr(e,r)};try{window.addEventListener(en,t),de.set(e,t)}catch(n){console.error("ensureLiveUpdateSubscription: Registrierung fehlgeschlagen",n)}}function Pr(e){if(!e||!de.has(e))return;const t=de.get(e);try{t&&window.removeEventListener(en,t)}catch(n){console.error("removeLiveUpdateSubscription: Entfernen des Listeners fehlgeschlagen",n)}de.delete(e)}function wr(e){e&&(Pr(e),rn(e),an(e))}function gt(e,t){if(!Ae.has(e)){Ae.set(e,{activeRange:t});return}const n=Ae.get(e);n&&(n.activeRange=t)}function on(e){var t;return((t=Ae.get(e))==null?void 0:t.activeRange)??br}function Ee(e){const t=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate());return Math.floor(t/864e5)}function Oe(e){const t=new Date(e.getTime());return t.setUTCHours(0,0,0,0),t}function x(e){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"&&e.trim()!==""){const t=Number.parseFloat(e);if(Number.isFinite(t))return t}return null}function sn(e){const t=Oe(new Date),n=mr[e],r={end_date:Ee(t)};if(Number.isFinite(n)&&n>0){const i=new Date(t.getTime());i.setUTCDate(i.getUTCDate()-(n-1)),r.start_date=Ee(i)}return r}function Qe(e){if(!e)return null;if(e instanceof Date&&!Number.isNaN(e.getTime()))return new Date(e.getTime());if(typeof e=="number"&&Number.isFinite(e)){const t=e*864e5;if(Number.isFinite(t))return new Date(t)}if(typeof e=="string"){const t=e.trim();if(/^\d{8}$/.test(t)){const r=Number.parseInt(t.slice(0,4),10),i=Number.parseInt(t.slice(4,6),10)-1,a=Number.parseInt(t.slice(6,8),10);if(Number.isFinite(r)&&Number.isFinite(i)&&Number.isFinite(a)){const l=new Date(Date.UTC(r,i,a));if(!Number.isNaN(l.getTime()))return l}}const n=Date.parse(t);if(Number.isFinite(n))return new Date(n)}return null}function De(e){if(!e&&e!==0)return null;if(e instanceof Date&&!Number.isNaN(e.getTime()))return e.getTime();if(typeof e=="number"&&Number.isFinite(e)){if(e>1e12)return e;if(e>1e9)return e*1e3}if(typeof e=="string"){const t=e.trim();if(!t)return null;const n=Date.parse(t);if(Number.isFinite(n))return n}return null}function ln(e){return Array.isArray(e)?e.map(t=>{const n=x(t==null?void 0:t.close);return n==null?null:{date:Qe(t==null?void 0:t.date)??(t==null?void 0:t.date),close:n/hr}}).filter(t=>!!t):[]}function et(e){var r;const t=x(e==null?void 0:e.last_price_native)??x((r=e==null?void 0:e.last_price)==null?void 0:r.native)??null;if(D(t))return t;if(String((e==null?void 0:e.currency_code)||"").toUpperCase()==="EUR"){const i=x(e==null?void 0:e.last_price_eur);if(D(i))return i}return null}function Ar(e){var t;return e?De(e==null?void 0:e.last_price_fetched_at)??De((t=e.last_price)==null?void 0:t.fetched_at)??null:null}function Ye(e,t){const r=(Array.isArray(e)?e:[]).slice(),i=et(t);if(!D(i))return r;const a=Ar(t)??Date.now(),l=new Date(a);if(Number.isNaN(l.getTime()))return r;const s=Ee(Oe(l));let o=null;for(let u=r.length-1;u>=0;u-=1){const c=r[u];if(!c)continue;const d=Qe(c.date);if(!d)continue;const f=Ee(Oe(d));if(o==null&&(o=f),f===s)return c.close!==i&&(r[u]={...c,close:i}),r;if(f<s)break}return o!=null&&o>s||r.push({date:l,close:i}),r}function Nr(e,t){const n=String((e==null?void 0:e.currency_code)||"").toUpperCase();if(!n||n==="EUR")return 1;const r=x(e==null?void 0:e.last_price_eur);if(r==null||r<=0)return null;const i=x(e==null?void 0:e.last_price_native);if(i!=null&&i>0)return r/i;const a=x(t);return a!=null&&a>0?r/a:null}function cn(e){const t=x(e);if(t==null)return null;const n=Math.round(t*100)/100;return Object.is(n,-0)?0:n}function D(e){return typeof e=="number"&&Number.isFinite(e)}function tt(e){return typeof e=="number"&&Number.isFinite(e)&&e>0}function Fr(e){if(e==null||Number.isNaN(e))return null;const t=Math.round(e*100)/100;return Object.is(t,-0)?0:t}function J(e,t){return!D(e)||!D(t)?null:e-t}function un(e,t){return!D(e)||!tt(t)?null:e*t}function xr(e,t,n){if(!D(e))return null;const r=un(t,n);return r==null?null:cn(r*e)}function dn(e,t){return!tt(t)||!D(e)?null:e/t}function K(e,t){return!D(t)||t===0||!D(e)?null:Fr((e-t)/t*100)}function Er(e,t){var w,E;if(!e)return null;if(!t)return be.delete(e),null;const n=t.total_holdings_precise??t.total_holdings??null,r=x(n),i=x(t.purchase_value_eur),a=x(t.market_value_eur)??x(t.current_value_eur),l=x(t.average_purchase_price_native),s=dn(i,r),o=x(t.last_price_native)??x((w=t.last_price)==null?void 0:w.native)??null,u=x(t.last_price_eur),c=x(t.last_close_native),d=x(t.last_close_eur),f=De(t==null?void 0:t.last_price_fetched_at)??De((E=t.last_price)==null?void 0:E.fetched_at),b=Nr(t,o),m=tt(b)?b:null,v=D(r)?r:null,h=J(o,c),_=J(u,d),g=K(o,c)??K(u,d),p=xr(v,J(o,l),m),P=J(a,i),A=P!=null?cn(P):p,F=K(a,i)??K(o,l)??K(u,s),S={holdings:v,fxRate:m,purchaseValueEur:i,currentValueEur:a,averagePurchaseNative:l,averagePurchaseEur:s,dayPriceChangeNative:h,dayPriceChangeEur:_,dayChangePct:g,totalChangeEur:A,totalChangePct:F,lastPriceFetchedAt:f??null};return be.set(e,S),S}function bt(e){return e?be.get(e)??null:null}function fn(e,t){if(!Array.isArray(e)||e.length===0)return{priceChange:null,priceChangePct:null};const n=e[0],r=x(n==null?void 0:n.close);if(!D(r)||r===0)return{priceChange:null,priceChangePct:null};const i=e[e.length-1],a=x(i==null?void 0:i.close),l=x(t)??a;if(!D(l))return{priceChange:null,priceChangePct:null};const s=l-r,o=Object.is(s,-0)?0:s,u=K(l,r);return{priceChange:o,priceChangePct:u}}function Dr(e){var l;if(!Array.isArray(e)||e.length<2)return null;let t=null,n=null;for(let s=e.length-1;s>=0;s-=1){const o=x((l=e[s])==null?void 0:l.close);if(D(o)){if(t==null){t=o;continue}n=o;break}}if(!D(t)||!D(n))return null;const r=t-n,i=Object.is(r,-0)?0:r,a=K(t,n);return{diff:i,pct:a}}function Cr(e){if(!Array.isArray(e)||e.length===0)return null;for(let t=e.length-1;t>=0;t-=1){const n=e[t];if(!n)continue;const r=Qe(n.date);if(r)return r.getTime()}return null}function Lr(e,t){if(!e)return!1;const n=e.lastPriceFetchedAt;if(!D(n)||Date.now()-n>gr)return!1;const i=Cr(t);return!(i!=null&&n+pr<i)}function We(e){return D(e)?e===0||Object.is(e,-0):!0}function Rr(e,t){if(!e)return!1;const n=We(e.dayPriceChangeNative),r=We(e.dayPriceChangeEur)||n,i=We(e.dayChangePct);if(!n&&!r&&!i||Lr(e,t))return!1;const a=Dr(t);if(!a)return!1;const{diff:l,pct:s}=a;if(n&&(e.dayPriceChangeNative=l),r){const o=un(l,e.fxRate);D(o)?e.dayPriceChangeEur=o:n&&(e.dayPriceChangeEur=l)}return i&&s!=null&&(e.dayChangePct=s),!0}function Tr(e,t){if(!D(e))return'<span class="value neutral">—</span>';const n=ee(e);if(n==="—")return'<span class="value neutral">—</span>';const r=e>0?"positive":e<0?"negative":"neutral",i=t?`&nbsp;${t}`:"";return`<span class="value ${r}">${n}${i}</span>`}function $r(e){return D(e)?`<span class="value ${e>0?"positive":e<0?"negative":"neutral"} value--percentage">${B(e)}&nbsp;%</span>`:'<span class="value neutral">—</span>'}function hn(e,t,n,r){const i=e||"";return`
    <div class="security-info-bar" data-range="${i}">
      <div class="security-info-item">
        <span class="label">Preisänderung (${i||"Zeitraum"})</span>
        <div class="value-row">
          ${Tr(t,r)}
          ${$r(n)}
        </div>
      </div>
    </div>
  `}function Mr(e){return`
    <div class="security-range-selector" role="group" aria-label="Zeitraum">
      ${Qt.map(n=>`
      <button
        type="button"
        class="security-range-button${n===e?" active":""}"
        data-range="${n}"
        aria-pressed="${n===e}"
      >
        ${n}
      </button>
    `).join(`
`)}
    </div>
  `}function pn(e,t={status:"empty"}){const n=e||"";switch(t.status){case"loaded":return`
        <div
          class="history-chart"
          data-state="loaded"
          data-range="${n}"
          role="img"
          aria-label="Preisverlauf${n?` für ${n}`:""}"
        ></div>
      `;case"error":{const r=t!=null&&t.message?String(t.message):"Die historischen Daten konnten nicht geladen werden.";return`
        <div class="history-placeholder" data-state="error" data-range="${n}">
          <p>${r}</p>
        </div>
      `}case"empty":default:return`
        <div class="history-placeholder" data-state="empty" data-range="${n}">
          <p>Für dieses Wertpapier liegen im Zeitraum ${n||"den gewählten Zeitraum"} keine historischen Daten vor.</p>
        </div>
      `}}function kr(e){const t=x(e);if(t==null)return"—";const n=Math.abs(t%1)>0,r=n?2:qe.min,i=n?qe.max:qe.min;return t.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:i})}function ee(e){const t=x(e);return t==null?"—":t.toLocaleString("de-DE",{minimumFractionDigits:pt.min,maximumFractionDigits:pt.max})}function Hr(e,t){const n=ee(e),r=`&nbsp;${t}`;return`<span class="${e>0?"positive":e<0?"negative":"neutral"}">${n}${r}</span>`}function mt(e,t=null){var y;if(!e)return'<div class="meta-error">Keine Snapshot-Daten verfügbar.</div>';const n=e.currency_code||"EUR",r=(t==null?void 0:t.holdings)??e.total_holdings_precise??e.total_holdings,i=kr(r),a=e.last_price_native??((y=e.last_price)==null?void 0:y.native)??e.last_price_eur,l=x(a),s=ee(a),o=s==="—"?null:`${s}${`&nbsp;${n}`}`,u=x(e.market_value_eur)??x(e.current_value_eur)??null,c=x(e.last_close_native),d=x(e.last_price_eur),f=x(e.last_close_eur),b=(t==null?void 0:t.averagePurchaseNative)??x(e.average_purchase_price_native),m=(t==null?void 0:t.averagePurchaseEur)??dn(x(e.purchase_value_eur),x((t==null?void 0:t.holdings)??e.total_holdings_precise??e.total_holdings)),v=(t==null?void 0:t.dayPriceChangeNative)??J(l,c),h=(t==null?void 0:t.dayPriceChangeEur)??J(d,f),_=D(v)?v:h,g=D(v)?n:"EUR",p=(N,L="")=>{const $=["value"];return L&&$.push(...L.split(" ").filter(Boolean)),`<span class="${$.join(" ")}">${N}</span>`},P=(N="")=>{const L=["value--missing"];return N&&L.push(N),p("—",L.join(" "))},A=(N,L="")=>{if(!D(N))return P(L);const $=["value--gain"];return L&&$.push(L),p(Nt(N),$.join(" "))},F=(N,L="")=>{if(!D(N))return P(L);const $=["value--gain-percentage"];return L&&$.push(L),p(Ft(N),$.join(" "))},S=o?p(o,"value--price"):P("value--price"),w=i==="—"?P("value--holdings"):p(i,"value--holdings"),E=D(u)?p(`${B(u)}&nbsp;€`,"value--market-value"):P("value--market-value"),C=D(_)?p(Hr(_,g),"value--gain value--absolute"):P("value--absolute"),T=F(t==null?void 0:t.dayChangePct,"value--percentage"),I=A(t==null?void 0:t.totalChangeEur,"value--absolute"),k=F(t==null?void 0:t.totalChangePct,"value--percentage"),H=[];return D(b)&&H.push(p(`${ee(b)}${`&nbsp;${n}`}`,"value--average value--average-native")),D(m)&&H.push(p(`${ee(m)}&nbsp;€`,"value--average value--average-eur")),H.length===0&&H.push(P("value--average value--average-native")),`
    <div class="security-meta-grid security-meta-grid--expanded">
      <div class="security-meta-item security-meta-item--price">
        <span class="label">Letzter Preis</span>
        <div class="value-group">${S}</div>
      </div>
      <div class="security-meta-item security-meta-item--average">
        <span class="label">Durchschnittlicher Kaufpreis</span>
        <div class="value-group">
          ${H.join("")}
        </div>
      </div>
      <div class="security-meta-item security-meta-item--day-change">
        <span class="label">Tagesänderung</span>
        <div class="value-group">
          ${C}
          ${T}
        </div>
      </div>
      <div class="security-meta-item security-meta-item--total-change">
        <span class="label">Gesamtänderung</span>
        <div class="value-group">
          ${I}
          ${k}
        </div>
      </div>
      <div class="security-meta-item security-meta-item--holdings">
        <span class="label">Bestand</span>
        <div class="value-group">${w}</div>
      </div>
      <div class="security-meta-item security-meta-item--market-value">
        <span class="label">Marktwert (EUR)</span>
        <div class="value-group">${E}</div>
      </div>
    </div>
  `}function gn(e){if(!e)return null;if(typeof e=="string")return e;if(e instanceof Error)return e.message||null;try{return JSON.stringify(e)}catch{return String(e)}}function yt(e,t){const n=e==null?void 0:e.averagePurchaseNative;return typeof n=="number"&&Number.isFinite(n)?n:x(t==null?void 0:t.average_purchase_price_native)}function Ir(e,t,{currency:n,baseline:r}={}){const i=e.clientWidth||e.offsetWidth||0,a=i>0?i:640,l=Math.min(Math.max(Math.floor(a*.55),220),420),s=(n||"").toUpperCase()||"EUR",o=D(r)?r:null;return{width:a,height:l,margin:{top:16,right:20,bottom:32,left:20},series:t,yFormatter:u=>ee(u),tooltipRenderer:({xFormatted:u,yFormatted:c})=>`
      <div class="chart-tooltip-date">${u}</div>
      <div class="chart-tooltip-value">${c}&nbsp;${s}</div>
    `,baseline:o!=null?{value:o}:null}}const _t=new WeakMap;function qr(e,t,n={}){if(!e||!Array.isArray(t)||t.length===0)return;const r=Ir(e,t,n);let i=_t.get(e)||null;if(!i||!e.contains(i)){e.innerHTML="",i=cr(e,r),i&&_t.set(e,i);return}Jt(i,r)}function vt(e,t){e&&(e.dataset.activeRange=t,e.querySelectorAll(".security-range-button").forEach(n=>{const i=n.dataset.range===t;n.classList.toggle("active",i),n.setAttribute("aria-pressed",i?"true":"false"),n.disabled=!1,n.classList.remove("loading")}))}function Wr(e,t,n,r,i){const a=e.querySelector(".security-info-bar");if(!a||!a.parentElement)return;const l=document.createElement("div");l.innerHTML=hn(t,n,r,i).trim();const s=l.firstElementChild;s&&a.parentElement.replaceChild(s,a)}function St(e,t,n,r,i={}){const a=e.querySelector(".security-detail-placeholder");if(a&&(a.innerHTML=`
    <h2>Historie</h2>
    ${pn(t,n)}
  `,(n==null?void 0:n.status)==="loaded"&&Array.isArray(r)&&r.length)){const l=a.querySelector(".history-chart");l&&requestAnimationFrame(()=>{qr(l,r,i)})}}function Vr(e){const{root:t,hass:n,panelConfig:r,securityUuid:i,snapshot:a,metrics:l,initialRange:s,initialHistory:o,initialHistoryState:u}=e;t&&setTimeout(()=>{const c=t.querySelector(".security-range-selector");if(!c)return;const d=nn(i),f=l??bt(i),b=yt(f,a);if(Array.isArray(o)&&(u==null?void 0:u.status)!=="error"&&d.set(s,o),Sr(i),gt(i,s),vt(c,s),u){const h=Ye(o,a);let _=u;_.status!=="error"&&(_=h.length?{status:"loaded"}:{status:"empty"}),St(t,s,_,h,{currency:a==null?void 0:a.currency_code,baseline:b})}const v=async h=>{if(!h||h===on(i))return;const _=c.querySelector(`.security-range-button[data-range="${h}"]`);_&&(_.disabled=!0,_.classList.add("loading"));let g=d.get(h)||null,p=null,P=[];if(g)p=g.length?{status:"loaded"}:{status:"empty"};else try{const C=sn(h),T=await Dt(n,r,i,C);g=ln(T==null?void 0:T.prices),d.set(h,g),p=g.length?{status:"loaded"}:{status:"empty"}}catch(C){console.error("Range-Wechsel: Historie konnte nicht geladen werden",C),g=[],p={status:"error",message:gn(C)||"Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden."}}P=Ye(g,a),(p==null?void 0:p.status)!=="error"&&(p=P.length?{status:"loaded"}:{status:"empty"});const A=et(a),{priceChange:F,priceChangePct:S}=fn(P,A);gt(i,h),vt(c,h),Wr(t,h,F,S,a==null?void 0:a.currency_code);const w=bt(i)??f,E=yt(w,a);St(t,h,p,P,{currency:a==null?void 0:a.currency_code,baseline:E})};c.addEventListener("click",h=>{var p;const _=(p=h.target)==null?void 0:p.closest(".security-range-button");if(!_||_.disabled)return;const{range:g}=_.dataset;!g||!Qt.includes(g)||v(g)})},0)}async function Ur(e,t,n,r){if(!r)return console.error("renderSecurityDetail: securityUuid fehlt"),'<div class="card"><h2>Fehler</h2><p>Kein Wertpapier angegeben.</p></div>';const i=_r(r);let a=null,l=null;try{const S=await Dn(t,n,r);S&&typeof S=="object"?a=S.snapshot&&typeof S.snapshot=="object"?S.snapshot:S:a=S}catch(S){console.error("renderSecurityDetail: Snapshot konnte nicht geladen werden",S),l=S instanceof Error?S.message:String(S)}const s=a||i,o=!!(i&&!a),u=((s==null?void 0:s.source)??"")==="cache";let c=null;r&&(tn(r,s??null),c=Er(r,s??null));const d=s&&(o||u)?yr({fallbackUsed:o,flaggedAsCache:u}):"",f=(s==null?void 0:s.name)||"Wertpapierdetails";if(l)return`
      ${Ue(f,mt(s,c)).outerHTML}
      ${d}
      <div class="card error-card">
        <h2>Fehler beim Laden</h2>
        <p>${l}</p>
      </div>
    `;const b=on(r),m=nn(r);let v=m.has(b)?m.get(b)??null:null,h={status:"empty"};if(Array.isArray(v))h=v.length?{status:"loaded"}:{status:"empty"};else{v=[];try{const S=sn(b),w=await Dt(t,n,r,S);v=ln(w==null?void 0:w.prices),m.set(b,v),h=v.length?{status:"loaded"}:{status:"empty"}}catch(S){console.error("renderSecurityDetail: Historie konnte nicht geladen werden",S),h={status:"error",message:gn(S)||"Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden."}}}Rr(c,v)&&c&&be.set(r,c);const _=Ye(v,s);(h==null?void 0:h.status)!=="error"&&(h=_.length?{status:"loaded"}:{status:"empty"});const g=Ue(f,mt(s,c)),p=et(s),{priceChange:P,priceChangePct:A}=fn(_,p),F=hn(b,P,A,s==null?void 0:s.currency_code);return Vr({root:e,hass:t,panelConfig:n,securityUuid:r,snapshot:s,metrics:c,initialRange:b,initialHistory:v,initialHistoryState:h}),`
    ${g.outerHTML}
    ${d}
    ${F}
    ${Mr(b)}
    <div class="card security-detail-placeholder">
      <h2>Historie</h2>
      ${pn(b,h)}
    </div>
  `}function Br(e){const{setSecurityDetailTabFactory:t}=e;if(typeof t!="function"){console.error("registerSecurityDetailTab: Ungültige Factory-Funktion übergeben");return}t(n=>({title:"Wertpapier",render:(r,i,a)=>Ur(r,i,a,n),cleanup:()=>wr(n)}))}const Gr=Nn,ze="pp-reader-sticky-anchor",Ce="overview",Ke="security:",Or=[{key:Ce,title:"Dashboard",render:Bt}],ie=new Map,me=[],Le=new Map;let je=null,Ve=!1,te=null,R=0,ae=null;function Re(e){return typeof e=="object"&&e!==null}function Yr(e){return e==="accounts"||e==="last_file_update"||e==="portfolio_values"||e==="portfolio_positions"}function Pt(e){const t=e.portfolio_uuid;if(typeof t=="string"&&t)return t;const n=e.portfolioUuid;return typeof n=="string"&&n?n:null}function zr(e){if(!e)return null;if(Array.isArray(e)){for(const t of e)if(Re(t)){const n=Pt(t);if(n)return n}return null}return Re(e)?Pt(e):null}function Kr(e,t){switch(e){case"accounts":return{type:e,data:Array.isArray(t)?t:null};case"last_file_update":return typeof t=="string"?{type:e,data:t}:Re(t)?{type:e,data:t}:{type:e,data:null};case"portfolio_values":return Array.isArray(t)?{type:e,data:t}:{type:e,data:null};case"portfolio_positions":return Array.isArray(t)?{type:e,data:t}:Re(t)?{type:e,data:t}:{type:e,data:null};default:return null}}function nt(e){return typeof e!="string"||!e.startsWith(Ke)?null:e.slice(Ke.length)||null}function jr(){if(!te)return!1;const e=_n(te);return e||(te=null),e}function G(){const e=me.map(t=>ie.get(t)).filter(t=>!!t);return[...Or,...e]}function bn(){try{const e=rt();e&&typeof e.rememberScrollPosition=="function"&&e.rememberScrollPosition()}catch(e){console.warn("rememberCurrentPageScroll: konnte Scroll-Position nicht sichern",e)}}function wt(e){const t=G();return!t.length||e<0?0:e>=t.length?t.length-1:e}async function Xr(e,t,n,r){const i=G(),a=wt(e);if(a===R){e>R&&jr();return}bn();const l=i[R],s=nt(l==null?void 0:l.key);let o=a;if(s){const u=i[a];if((u==null?void 0:u.key)===Ce&&ti(s,{suppressRender:!0})){const f=G().findIndex(b=>b.key===Ce);o=f>=0?f:0}}if(!Ve){Ve=!0;try{R=wt(o);const u=R;await vn(t,n,r),ei(u)}catch(u){console.error("navigateToPage: Fehler beim Rendern des Tabs",u)}finally{Ve=!1}}}function Te(e,t,n,r){Xr(R+e,t,n,r)}function Zr(e,t){if(!e||!t||typeof t.render!="function"){console.error("registerDetailTab: Ungültiger Tab-Descriptor",e,t);return}const n=nt(e);if(n){const i=Le.get(n);i&&i!==e&&mn(i)}const r={...t,key:e};ie.set(e,r),n&&Le.set(n,e),me.includes(e)||me.push(e)}function mn(e){if(!e)return;const t=ie.get(e);if(t&&typeof t.cleanup=="function")try{t.cleanup({key:e})}catch(i){console.error("unregisterDetailTab: Fehler beim Ausführen von cleanup",i)}ie.delete(e);const n=me.indexOf(e);n>=0&&me.splice(n,1);const r=nt(e);r&&Le.get(r)===e&&Le.delete(r)}function Jr(e){return ie.has(e)}function At(e){return ie.get(e)??null}function Qr(e){if(e!=null&&typeof e!="function"){console.error("setSecurityDetailTabFactory: Erwartet Funktion oder null",e);return}je=e??null}function yn(e){return`${Ke}${e}`}function rt(){const e=window.__ppReaderDashboardElements;if(e instanceof Set){for(const r of e)if(r&&r.isConnected)return r}const t=document.querySelector("pp-reader-dashboard");if(t)return t;const n=document.querySelectorAll("pp-reader-panel");for(const r of n){if(!r||!r.shadowRoot)continue;const i=r.shadowRoot.querySelector("pp-reader-dashboard");if(i)return i}return null}function Xe(){const e=rt();if(!e){console.warn("requestDashboardRender: Kein pp-reader-dashboard Element gefunden");return}if(typeof e._renderIfInitialized=="function"){e._renderIfInitialized();return}typeof e._render=="function"&&e._render()}function ei(e){const t=rt();if(t&&typeof t.handleExternalRender=="function")try{t.handleExternalRender(e)}catch(n){console.warn("notifyExternalRender: Fehler beim Synchronisieren des Dashboards",n)}}function _n(e){if(!e)return console.error("openSecurityDetail: Ungültige securityUuid",e),!1;const t=yn(e);let n=At(t);if(!n&&typeof je=="function")try{const a=je(e);a&&typeof a.render=="function"?(Zr(t,a),n=At(t)):console.error("openSecurityDetail: Factory lieferte ungültigen Descriptor",a)}catch(a){console.error("openSecurityDetail: Fehler beim Erzeugen des Tab-Descriptors",a)}if(!n)return console.warn(`openSecurityDetail: Kein Detail-Tab für ${e} verfügbar`),!1;bn();let i=G().findIndex(a=>a.key===t);return i===-1&&(i=G().findIndex(l=>l.key===t),i===-1)?(console.error("openSecurityDetail: Tab nach Registrierung nicht auffindbar"),!1):(R=i,te=null,Xe(),!0)}function ti(e,t={}){if(!e)return console.error("closeSecurityDetail: Ungültige securityUuid",e),!1;const{suppressRender:n=!1}=t,r=yn(e);if(!Jr(r))return!1;const a=G().findIndex(o=>o.key===r),l=a===R;mn(r);const s=G();if(!s.length)return R=0,n||Xe(),!0;if(te=e,l){const o=s.findIndex(u=>u.key===Ce);o>=0?R=o:R=Math.min(Math.max(a-1,0),s.length-1)}else R>=s.length&&(R=Math.max(0,s.length-1));return n||Xe(),!0}async function vn(e,t,n){let r=n;if(!r&&(t!=null&&t.panels)){const c=t.panels;r=c.ppreader||c.pp_reader||Object.values(c).find(d=>(d==null?void 0:d.webcomponent_name)==="pp-reader-panel")||null}const i=G();R>=i.length&&(R=Math.max(0,i.length-1));const a=i[R];if(!a||typeof a.render!="function"){console.error("renderTab: Kein gültiger Tab oder keine render-Methode gefunden!");return}let l;try{l=await a.render(e,t,r)}catch(c){console.error("renderTab: Fehler beim Rendern des Tabs:",c),e.innerHTML=`<div class="card"><h2>Fehler</h2><pre>${(c==null?void 0:c.message)||c}</pre></div>`;return}if(!e){console.error("renderTab: Root-Element nicht gefunden!");return}e.innerHTML=l??"",a.render===Bt&&Ze(e);const o=await new Promise(c=>{const d=window.setInterval(()=>{const f=e.querySelector(".header-card");f&&(clearInterval(d),c(f))},50)});if(!o){console.error("Header-Card nicht gefunden!");return}let u=e.querySelector(`#${ze}`);if(!u){u=document.createElement("div"),u.id=ze;const c=o.parentNode;c&&"insertBefore"in c&&c.insertBefore(u,o)}ii(e,t,n),ri(e,t,n),ni(e)}function ni(e){const t=e.querySelector(".header-card"),n=e,r=e.querySelector(`#${ze}`);if(!t||!n||!r){console.error("Fehlende Elemente für das Scrollverhalten: headerCard, scrollBorder oder anchor.");return}ae==null||ae.disconnect(),ae=new IntersectionObserver(([i])=>{i.isIntersecting?t.classList.remove("sticky"):t.classList.add("sticky")},{root:null,rootMargin:"0px 0px 0px 0px",threshold:0}),ae.observe(r)}function ri(e,t,n){const r=e.querySelector(".header-card");if(!r){console.error("Header-Card nicht gefunden!");return}Gr(r,()=>Te(1,e,t,n),()=>Te(-1,e,t,n))}function ii(e,t,n){const r=e.querySelector(".header-card");if(!r){console.error("Header-Card nicht gefunden!");return}const i=r.querySelector("#nav-left"),a=r.querySelector("#nav-right");if(!i||!a){console.error("Navigationspfeile nicht gefunden!");return}i.addEventListener("click",()=>{Te(-1,e,t,n)}),a.addEventListener("click",()=>{Te(1,e,t,n)}),ai(r)}function ai(e){const t=e.querySelector("#nav-left"),n=e.querySelector("#nav-right");if(t&&(R===0?(t.disabled=!0,t.classList.add("disabled")):(t.disabled=!1,t.classList.remove("disabled"))),n){const r=G(),a=!(R===r.length-1)||!!te;n.disabled=!a,n.classList.toggle("disabled",!a)}}class oi extends HTMLElement{constructor(){super();M(this,"_root");M(this,"_hass",null);M(this,"_panel",null);M(this,"_narrow",null);M(this,"_route",null);M(this,"_lastPanel",null);M(this,"_lastNarrow",null);M(this,"_lastRoute",null);M(this,"_lastPage",null);M(this,"_scrollPositions",{});M(this,"_unsubscribeEvents",null);M(this,"_initialized",!1);M(this,"_hasNewData",!1);M(this,"_pendingUpdates",[]);M(this,"_entryIdWaitWarned",!1);this._root=document.createElement("div"),this._root.className="pp-reader-dashboard",this.appendChild(this._root)}set hass(n){this._hass=n??null,this._checkInitialization()}set panel(n){this._panel!==n&&(this._panel=n??null,this._checkInitialization())}set narrow(n){this._narrow!==(n??null)&&(this._narrow=n??null,this._renderIfInitialized())}set route(n){this._route!==(n??null)&&(this._route=n??null,this._renderIfInitialized())}connectedCallback(){this._checkInitialization()}disconnectedCallback(){this._removeEventListeners()}_checkInitialization(){if(!this._hass||this._initialized)return;if(!this._panel&&this._hass.panels){const r=this._hass.panels;this._panel=r.ppreader||r.pp_reader||Object.values(r).find(i=>(i==null?void 0:i.webcomponent_name)==="pp-reader-panel")||null}const n=at(this._hass,this._panel);if(!n){this._entryIdWaitWarned||(console.warn("PPReaderDashboard: kein entry_id ermittelbar – warte auf Panel-Konfiguration."),this._entryIdWaitWarned=!0);return}this._entryIdWaitWarned=!1,console.debug("PPReaderDashboard: entry_id (fallback) =",n),this._initialized=!0,this._initializeEventListeners(),this._render()}_initializeEventListeners(){var a;this._removeEventListeners();const n=(a=this._hass)==null?void 0:a.connection;if(!n||typeof n.subscribeEvents!="function"){console.error("PPReaderDashboard: keine valide WebSocket-Verbindung oder subscribeEvents fehlt");return}const r=["panels_updated"],i=[];Promise.all(r.map(l=>n.subscribeEvents(this._handleBusEvent.bind(this),l).then(s=>{typeof s=="function"?(i.push(s),console.debug("PPReaderDashboard: subscribed to",l)):console.error("PPReaderDashboard: subscribeEvents lieferte kein Unsubscribe-Func für",l,s)}).catch(s=>{console.error("PPReaderDashboard: Fehler bei subscribeEvents für",l,s)}))).then(()=>{this._unsubscribeEvents=()=>{i.forEach(l=>{try{l()}catch{}}),console.debug("PPReaderDashboard: alle Event-Subscriptions entfernt")}})}_removeEventListeners(){if(typeof this._unsubscribeEvents=="function")try{this._unsubscribeEvents()}catch(n){console.error("PPReaderDashboard: Fehler beim Entfernen der Event-Listener:",n)}this._unsubscribeEvents=null}_handleBusEvent(n){const r=at(this._hass,this._panel);if(!r)return;const i=n==null?void 0:n.data;if(!i||!Yr(i.data_type)||i.entry_id&&i.entry_id!==r)return;const a=Kr(i.data_type,i.data);a&&(this._queueUpdate(a.type,a.data),this._doRender(a.type,a.data))}_doRender(n,r){switch(n){case"accounts":kn(r,this._root);break;case"last_file_update":Bn(r,this._root);break;case"portfolio_values":In(r,this._root);break;case"portfolio_positions":Wn(r,this._root);break;default:console.warn("PPReaderDashboard: Unbekannter Datentyp:",n);break}}_queueUpdate(n,r){const i=this._cloneData(r),a={type:n,data:i};n==="portfolio_positions"&&(a.portfolioUuid=zr(i));let l=-1;n==="portfolio_positions"&&a.portfolioUuid?l=this._pendingUpdates.findIndex(s=>s.type===n&&s.portfolioUuid===a.portfolioUuid):l=this._pendingUpdates.findIndex(s=>s.type===n),l>=0?this._pendingUpdates[l]=a:this._pendingUpdates.push(a),this._hasNewData=!0}_cloneData(n){if(n==null)return n;try{if(typeof structuredClone=="function")return structuredClone(n)}catch(r){console.warn("PPReaderDashboard: structuredClone fehlgeschlagen, falle auf JSON zurück",r)}try{return JSON.parse(JSON.stringify(n))}catch(r){return console.warn("PPReaderDashboard: JSON-Clone fehlgeschlagen, referenziere Originaldaten",r),n}}_reapplyPendingUpdates(){if(!(!Array.isArray(this._pendingUpdates)||this._pendingUpdates.length===0))for(const n of this._pendingUpdates)try{this._doRender(n.type,this._cloneData(n.data))}catch(r){console.error("PPReaderDashboard: Fehler beim erneuten Anwenden eines Updates",n,r)}}_renderIfInitialized(){this._initialized&&this._render()}handleExternalRender(n){this._afterRender(n)}rememberScrollPosition(n=R){if(!this._root)return;const r=Number.isInteger(n)?n:R;r!=null&&(this._scrollPositions[r]=this._root.scrollTop||0)}_render(){if(!this._hass){console.warn("pp-reader-dashboard: noch kein hass, überspringe _render()");return}if(!this._initialized){console.debug("pp-reader-dashboard: _render aufgerufen bevor initialisiert");return}const n=R;if(!this._hasNewData&&this._panel===this._lastPanel&&this._narrow===this._lastNarrow&&this._route===this._lastRoute&&this._lastPage===n)return;this._lastPage!=null&&(this._scrollPositions[this._lastPage]=this._root.scrollTop);const r=vn(this._root,this._hass,this._panel);r&&typeof r.then=="function"?r.then(()=>{this._afterRender(n)}).catch(i=>{console.error("PPReaderDashboard: Fehler beim Rendern des Tabs",i),this._afterRender(n)}):this._afterRender(n)}_afterRender(n){if(!this._root)return;const r=this._scrollPositions[n]||0;this._root.scrollTop=r,this._lastPanel=this._panel,this._lastNarrow=this._narrow,this._lastRoute=this._route,this._lastPage=n;try{this._reapplyPendingUpdates()}catch(i){console.error("PPReaderDashboard: Fehler beim Wiederanlegen der Updates",i)}this._hasNewData=!1}}customElements.get("pp-reader-dashboard")||customElements.define("pp-reader-dashboard",oi);console.log("PPReader dashboard.js v20250914b geladen");Br({setSecurityDetailTabFactory:Qr});
//# sourceMappingURL=dashboard.BQvWPgre.js.map
