{"version":3,"file":"dashboard.C0opWQVf.js","sources":["../../../../../src/interaction/tab_control.ts","../../../../../src/content/elements.ts","../../../../../src/data/api.ts","../../../../../src/data/updateConfigsWS.ts","../../../../../src/tabs/overview.ts","../../../../../src/content/charting.ts","../../../../../src/tabs/security_detail.ts","../../../../../src/dashboard.ts"],"sourcesContent":["// @ts-nocheck\n\n/**\n * Swipe and tab interaction helpers mirrored from the legacy UI.\n */\n\n/**\n * FÃ¼gt einem Element Swipe- und Maus-Events hinzu, um zwischen Tabs zu navigieren.\n * @param {HTMLElement} element - Das Element, das die Events erhalten soll.\n * @param {Function} onSwipeLeft - Callback fÃ¼r Swipe/Klick nach links (nÃ¤chster Tab).\n * @param {Function} onSwipeRight - Callback fÃ¼r Swipe/Klick nach rechts (vorheriger Tab).\n */\nexport function addSwipeEvents(element, onSwipeLeft, onSwipeRight) {\n  let startX = null;\n\n  // Touch-Events fÃ¼r MobilgerÃ¤te\n  element.addEventListener(\n    'touchstart',\n    e => {\n      if (e.touches.length === 1) {\n        startX = e.touches[0].clientX;\n      }\n    },\n    { passive: true } // Passive Listener fÃ¼r bessere Performance\n  );\n\n  element.addEventListener(\n    'touchend',\n    e => {\n      if (startX === null) return;\n      const deltaX = e.changedTouches[0].clientX - startX;\n      if (deltaX < -50) {\n        onSwipeLeft();\n      } else if (deltaX > 50) {\n        onSwipeRight();\n      }\n      startX = null;\n    },\n    { passive: true } // Passive Listener fÃ¼r bessere Performance\n  );\n\n  // Maus-Events fÃ¼r Desktop\n  element.addEventListener(\n    'mousedown',\n    e => {\n      startX = e.clientX;\n    },\n    { passive: true } // Passive Listener fÃ¼r bessere Performance\n  );\n\n  element.addEventListener(\n    'mouseup',\n    e => {\n      if (startX === null) return;\n      const deltaX = e.clientX - startX;\n      if (deltaX < -50) {\n        onSwipeLeft();\n      } else if (deltaX > 50) {\n        onSwipeRight();\n      }\n      startX = null;\n    },\n    { passive: true } // Passive Listener fÃ¼r bessere Performance\n  );\n}\n\n/**\n * Optional: Funktion zum direkten Wechseln zu einem Tab per Index.\n * @param {number} targetIndex - Der Index des gewÃ¼nschten Tabs.\n * @param {Function} onTabChange - Callback, der beim Wechsel aufgerufen wird.\n */\nexport function goToTab(targetIndex, onTabChange) {\n  if (typeof onTabChange === 'function') {\n    onTabChange(targetIndex);\n  }\n}","// @ts-nocheck\n\n/**\n * HTML rendering helpers mirrored from the legacy dashboard implementation.\n */\n\nexport function formatValue(key, value, row = undefined, context = undefined) {\n  let formatted;\n\n  const toNumber = (v) => {\n    if (typeof v === 'number') {\n      return v;\n    }\n    if (typeof v === 'string' && v.trim() !== '') {\n      const cleaned = v\n        .replace(/\\s+/g, '')\n        .replace(/[^0-9,.-]/g, '')\n        .replace(/\\.(?=\\d{3}(\\D|$))/g, '')\n        .replace(',', '.');\n      const parsed = Number.parseFloat(cleaned);\n      return Number.isNaN(parsed) ? Number.NaN : parsed;\n    }\n    return Number.NaN;\n  };\n\n  const safeNumber = (v, minFrac = 2, maxFrac = 2) => {\n    const num = typeof v === 'number' ? v : toNumber(v);\n    if (!Number.isFinite(num)) {\n      return '';\n    }\n    return num.toLocaleString('de-DE', {\n      minimumFractionDigits: minFrac,\n      maximumFractionDigits: maxFrac\n    });\n  };\n\n  const renderMissingValue = (reason = '') => {\n    const title = reason || 'Kein Wert verfÃ¼gbar';\n    return `<span class=\"missing-value\" role=\"note\" aria-label=\"${title}\" title=\"${title}\">â€”</span>`;\n  };\n\n  if (['gain_abs', 'gain_pct'].includes(key)) {\n    const missingReason = row?.fx_unavailable\n      ? 'Wechselkurs nicht verfÃ¼gbar â€“ EUR-Wert unbekannt'\n      : '';\n    if (value == null || (context && context.hasValue === false)) {\n      return renderMissingValue(missingReason);\n    }\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue(missingReason);\n    }\n    const symbol = key === 'gain_pct' ? '%' : 'â‚¬';\n    formatted = safeNumber(numeric) + `&nbsp;${symbol}`;\n    let cls = 'neutral';\n    if (numeric > 0) {\n      cls = 'positive';\n    } else if (numeric < 0) {\n      cls = 'negative';\n    }\n    return `<span class=\"${cls}\">${formatted}</span>`;\n  } else if (key === 'position_count') {\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue();\n    }\n    formatted = numeric.toLocaleString('de-DE');\n  } else if (['balance', 'current_value', 'purchase_value'].includes(key)) {\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      if (row?.fx_unavailable) {\n        return renderMissingValue('Wechselkurs nicht verfÃ¼gbar â€“ EUR-Wert unbekannt');\n      }\n      if (context && context.hasValue === false) {\n        return renderMissingValue();\n      }\n      return renderMissingValue();\n    }\n    formatted = safeNumber(numeric) + '&nbsp;â‚¬';\n  } else if (key === 'current_holdings') {\n    // BestÃ¤nde (Anzahl Anteile) â€“ etwas mehr PrÃ¤zision (bis 4 Nachkommastellen), aber ohne unnÃ¶tige Nullen\n    const numeric = typeof value === 'number' ? value : toNumber(value);\n    if (!Number.isFinite(numeric)) {\n      return renderMissingValue();\n    }\n    const hasFraction = Math.abs(numeric % 1) > 0;\n    formatted = numeric.toLocaleString('de-DE', {\n      minimumFractionDigits: hasFraction ? 2 : 0,\n      maximumFractionDigits: 4\n    });\n  } else {\n    formatted = value;\n    if (typeof formatted === 'string') {\n      const MAX_LEN = 60;\n      if (formatted.length > MAX_LEN) {\n        formatted = formatted.slice(0, MAX_LEN - 1) + 'â€¦';\n      }\n      // Entferne frÃ¼here PrÃ¤fixe (AbwÃ¤rtskompatibilitÃ¤t)\n      if (formatted.startsWith('Kontostand ')) {\n        formatted = formatted.substring('Kontostand '.length);\n      } else if (formatted.startsWith('Depotwert ')) {\n        formatted = formatted.substring('Depotwert '.length);\n      }\n    }\n  }\n  if (formatted === '' || formatted == null) {\n    return renderMissingValue();\n  }\n\n  return formatted;\n}\n\nexport function makeTable(rows, cols, sumColumns = [], options = {}) {\n  /**\n   * Erweiterung (optional):\n   * options.sortable    -> true | false (default false)\n   * options.defaultSort -> { key: 'name', dir: 'asc' } (nur wirksam falls sortable)\n   *\n   * Bestehende Aufrufer (3 Parameter) bleiben kompatibel.\n   */\n  const { sortable = false, defaultSort = { key: '', dir: 'asc' } } = options || {};\n\n  const escapeAttribute = (value) => {\n    if (value == null) {\n      return '';\n    }\n    return String(value)\n      .replace(/&/g, '&amp;')\n      .replace(/\"/g, '&quot;');\n  };\n\n  let html = '<table><thead><tr>';\n  cols.forEach(c => {\n    const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n    // Falls sortable: th data-sort-key setzen (nur wenn key vorhanden)\n    if (sortable && c.key) {\n      html += `<th${alignClass} data-sort-key=\"${c.key}\">${c.label}</th>`;\n    } else {\n      html += `<th${alignClass}>${c.label}</th>`;\n    }\n  });\n  html += '</tr></thead><tbody>';\n\n  rows.forEach(r => {\n    html += '<tr>';\n    cols.forEach(c => {\n      const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n      html += `<td${alignClass}>${formatValue(c.key, r[c.key], r)}</td>`;\n    });\n    html += '</tr>';\n  });\n\n  // Summen berechnen (unverÃ¤ndert)\n  const sums = {};\n  const sumMeta = {};\n  cols.forEach(c => {\n    if (sumColumns.includes(c.key)) {\n      let total = 0;\n      let hasValue = false;\n      rows.forEach(row => {\n        const v = row[c.key];\n        if (typeof v === 'number' && Number.isFinite(v)) {\n          total += v;\n          hasValue = true;\n        }\n      });\n      sums[c.key] = hasValue ? total : null;\n      sumMeta[c.key] = { hasValue };\n    }\n  });\n\n  if ('gain_abs' in sums) {\n    if ('purchase_value' in sums && sums.purchase_value > 0) {\n      sums['gain_pct'] = (sums['gain_abs'] / sums['purchase_value']) * 100;\n    } else if ('current_value' in sums && sums.current_value !== 0) {\n      sums['gain_pct'] = (sums['gain_abs'] / (sums['current_value'] - sums['gain_abs'])) * 100;\n    }\n  }\n\n  const aggregatedGainPct = Number.isFinite(sums['gain_pct']) ? sums['gain_pct'] : null;\n  let aggregatedGainPctLabel = '';\n  let aggregatedGainPctSign = 'neutral';\n\n  if (aggregatedGainPct != null) {\n    aggregatedGainPctLabel = `${formatNumber(aggregatedGainPct)}\\u00a0%`;\n    if (aggregatedGainPct > 0) {\n      aggregatedGainPctSign = 'positive';\n    } else if (aggregatedGainPct < 0) {\n      aggregatedGainPctSign = 'negative';\n    }\n  }\n\n  html += '<tr class=\"footer-row\">';\n  cols.forEach((c, idx) => {\n    const alignClass = c.align === 'right' ? ' class=\"align-right\"' : '';\n    if (idx === 0) {\n      html += `<td${alignClass}>Summe</td>`;\n      return;\n    }\n\n    if (sums[c.key] != null) {\n      let extraAttributes = '';\n      if (c.key === 'gain_abs' && aggregatedGainPctLabel) {\n        extraAttributes = ` data-gain-pct=\"${escapeAttribute(aggregatedGainPctLabel)}\" data-gain-sign=\"${escapeAttribute(aggregatedGainPctSign)}\"`;\n      }\n      html += `<td${alignClass}${extraAttributes}>${formatValue(c.key, sums[c.key], undefined, sumMeta[c.key])}</td>`;\n      return;\n    }\n\n    if (c.key === 'gain_pct' && sums['gain_pct'] != null) {\n      html += `<td${alignClass}>${formatValue('gain_pct', sums['gain_pct'], undefined, sumMeta[c.key])}</td>`;\n      return;\n    }\n\n    const fallbackContext = sumMeta[c.key] ?? { hasValue: false };\n    html += `<td${alignClass}>${formatValue(c.key, null, undefined, fallbackContext)}</td>`;\n  });\n  html += '</tr>';\n\n  html += '</tbody></table>';\n\n  // Falls sortable: Default-Sort-Metadaten injizieren (nicht doppelt parsen falls nicht nÃ¶tig)\n  if (sortable) {\n    try {\n      const tpl = document.createElement('template');\n      tpl.innerHTML = html.trim();\n      const table = tpl.content.querySelector('table');\n      if (table) {\n        table.classList.add('sortable-table');\n        if (defaultSort?.key) {\n          table.dataset.defaultSort = defaultSort.key;\n          table.dataset.defaultDir = defaultSort.dir === 'desc' ? 'desc' : 'asc';\n        }\n        return table.outerHTML;\n      }\n    } catch (e) {\n      console.warn(\"makeTable(sortable): Injection fehlgeschlagen:\", e);\n    }\n  }\n\n  return html;\n}\n\nexport function createHeaderCard(headerTitle, meta) {\n  const headerCard = document.createElement('div');\n  headerCard.className = 'header-card';\n\n  headerCard.innerHTML = `\n    <div class=\"header-content\">\n      <button id=\"nav-left\" class=\"nav-arrow\" aria-label=\"Vorherige Seite\">\n        <svg viewBox=\"0 0 24 24\">\n          <path d=\"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z\"></path>\n        </svg>\n      </button>\n      <h1 id=\"headerTitle\">${headerTitle}</h1>\n      <button id=\"nav-right\" class=\"nav-arrow\" aria-label=\"NÃ¤chste Seite\">\n        <svg viewBox=\"0 0 24 24\">\n          <path d=\"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z\"></path>\n        </svg>\n      </button>\n    </div>\n    <div id=\"headerMeta\" class=\"meta\">${meta}</div>\n  `;\n\n  return headerCard;\n}\n\n// === NEU: Vereinheitlichte Format-Helfer fÃ¼r andere Module (z.B. overview.js) ===\nexport function formatNumber(value, minFrac = 2, maxFrac = 2) {\n  return (isNaN(value) ? 0 : value).toLocaleString('de-DE', {\n    minimumFractionDigits: minFrac,\n    maximumFractionDigits: maxFrac\n  });\n}\n\nexport function formatGain(value) {\n  const num = isNaN(value) ? 0 : value;\n  let cls = 'neutral';\n  if (num > 0) {\n    cls = 'positive';\n  } else if (num < 0) {\n    cls = 'negative';\n  }\n  return `<span class=\"${cls}\">${formatNumber(num)}&nbsp;â‚¬</span>`;\n}\n\nexport function formatGainPct(value) {\n  const num = isNaN(value) ? 0 : value;\n  let cls = 'neutral';\n  if (num > 0) {\n    cls = 'positive';\n  } else if (num < 0) {\n    cls = 'negative';\n  }\n  return `<span class=\"${cls}\">${formatNumber(num)}&nbsp;%</span>`;\n}\n\n/**\n * Neue Utility: sortTableRows\n * Sortiert die Datenzeilen (<tr>) einer Tabelle anhand eines Keys.\n *\n * @param {HTMLTableElement} tableEl  Ziel-Tabelle\n * @param {string} key                Daten-Key (muss mit data-sort-key im TH oder Positions-Mapping Ã¼bereinstimmen)\n * @param {'asc'|'desc'} dir          Sortierrichtung\n * @param {boolean} isPositions       true => Positions-Spalten-Mapping verwenden\n * @returns {HTMLTableRowElement[]}   Array der neu angeordneten Daten-Zeilen (ohne Footer)\n *\n * Erkennung Zahl vs. String:\n *  - Entfernt NBSP, â‚¬, %, Tausenderpunkte\n *  - Wandelt Komma in Punkt\n *  - Wenn parseFloat ein valides Zahlenergebnis liefert und der ursprÃ¼ngliche Text\n *    nicht komplett alphabetisch ist -> numerischer Vergleich; sonst localeCompare.\n *\n * Footer-Zeile ('.footer-row') bleibt am Ende erhalten.\n */\nexport function sortTableRows(tableEl, key, dir = 'asc', isPositions = false) {\n  if (!tableEl) return [];\n  const tbody = tableEl.querySelector('tbody');\n  if (!tbody) return [];\n\n  const footer = tbody.querySelector('tr.footer-row');\n  const rows = Array\n    .from(tbody.querySelectorAll('tr'))\n    .filter(r => r !== footer);\n\n  // Spaltenindex bestimmen\n  let colIdx = -1;\n  if (isPositions) {\n    const posMap = {\n      name: 0,\n      current_holdings: 1,\n      purchase_value: 2,\n      current_value: 3,\n      gain_abs: 4,\n      gain_pct: 5\n    };\n    colIdx = posMap[key];\n  } else {\n    // Generisch Ã¼ber thead th[data-sort-key]\n    const ths = Array.from(tableEl.querySelectorAll('thead th'));\n    for (let i = 0; i < ths.length; i++) {\n      if (ths[i].getAttribute('data-sort-key') === key) {\n        colIdx = i;\n        break;\n      }\n    }\n  }\n  if (colIdx == null || colIdx < 0) return rows;\n\n  const toNumber = (txt) => {\n    if (txt == null) return NaN;\n    const cleaned = txt\n      .replace(/\\u00A0/g, ' ')\n      .replace(/[%â‚¬]/g, '')\n      .replace(/\\./g, '')\n      .replace(/,/g, '.')\n      .replace(/[^\\d.-]/g, '')\n      .trim();\n    if (!cleaned) return NaN;\n    const num = parseFloat(cleaned);\n    return Number.isFinite(num) ? num : NaN;\n  };\n\n  rows.sort((a, b) => {\n    const aTxt = a.cells[colIdx]?.textContent.trim() || '';\n    const bTxt = b.cells[colIdx]?.textContent.trim() || '';\n\n    const aNum = toNumber(aTxt);\n    const bNum = toNumber(bTxt);\n\n    let cmp;\n    if (!isNaN(aNum) && !isNaN(bNum) && (aTxt.match(/[0-9]/) || bTxt.match(/[0-9]/))) {\n      cmp = aNum - bNum;\n    } else {\n      cmp = aTxt.localeCompare(bTxt, 'de', { sensitivity: 'base' });\n    }\n    return dir === 'asc' ? cmp : -cmp;\n  });\n\n  // Re-Anordnung im DOM\n  rows.forEach(r => tbody.appendChild(r));\n  if (footer) tbody.appendChild(footer);\n\n  // Visuelle Indikatoren aktualisieren (optional generisch)\n  tableEl.querySelectorAll('thead th.sort-active').forEach(th => {\n    th.classList.remove('sort-active', 'dir-asc', 'dir-desc');\n  });\n  const activeTh = tableEl.querySelector(`thead th[data-sort-key=\"${key}\"]`);\n  if (activeTh) {\n    activeTh.classList.add('sort-active', dir === 'asc' ? 'dir-asc' : 'dir-desc');\n  }\n\n  return rows;\n}\n","// @ts-nocheck\n\n/**\n * Home Assistant websocket API helpers carried over for TypeScript migration.\n */\n\nfunction deriveEntryId(hass, panelConfig) {\n  // Direkt gesetzte einfache Variante (neuer Panelspeicher)\n  let entry_id = panelConfig?.config?.entry_id;\n\n  // Neu: Home Assistant liefert den entry_id-Wert inzwischen auch auf Root-Ebene\n  // des panelConfig-Objekts. Ohne diesen Fallback konnten wir in seltenen FÃ¤llen\n  // keinen entry_id bestimmen (z.B. wenn hass.panels noch nicht gefÃ¼llt war),\n  // wodurch sÃ¤mtliche Websocket-Aufrufe mit \"fehlendes hass oder entry_id\" brachen.\n  if (!entry_id) {\n    entry_id = panelConfig?.entry_id;\n  }\n\n  // Legacy verschachtelte Struktur (panel_custom)\n  if (!entry_id) {\n    entry_id = panelConfig?.config?._panel_custom?.config?.entry_id;\n  }\n\n  // Fallback: aus hass.panels suchen\n  if (!entry_id && hass?.panels) {\n    const candidate =\n      hass.panels.ppreader ||\n      hass.panels.pp_reader ||\n      Object.values(hass.panels).find(p => p?.webcomponent_name === 'pp-reader-panel');\n    entry_id =\n      candidate?.config?.entry_id ||\n      candidate?.config?._panel_custom?.config?.entry_id;\n  }\n\n  return entry_id;\n}\n\n// Export fÃ¼r andere Module (Dashboard/Event-Filter)\nexport function getEntryId(hass, panelConfig) {\n  return deriveEntryId(hass, panelConfig);\n}\n\n// Dashboard Data\nexport async function fetchDashboardDataWS(hass, panelConfig) {\n  const entry_id = deriveEntryId(hass, panelConfig);\n  if (!hass || !entry_id) {\n    throw new Error(`fetchDashboardDataWS: fehlendes hass oder entry_id (${entry_id})`);\n  }\n  return await hass.connection.sendMessagePromise({\n    type: \"pp_reader/get_dashboard_data\",\n    entry_id,\n  });\n}\n\n// Accounts\nexport async function fetchAccountsWS(hass, panelConfig) {\n  const entry_id = deriveEntryId(hass, panelConfig);\n  if (!hass || !entry_id) {\n    throw new Error(`fetchAccountsWS: fehlendes hass oder entry_id (${entry_id})`);\n  }\n  return await hass.connection.sendMessagePromise({\n    type: \"pp_reader/get_accounts\",\n    entry_id,\n  });\n}\n\n// Last file update\nexport async function fetchLastFileUpdateWS(hass, panelConfig) {\n  const entry_id = deriveEntryId(hass, panelConfig);\n  if (!hass || !entry_id) {\n    throw new Error(`fetchLastFileUpdateWS: fehlendes hass oder entry_id (${entry_id})`);\n  }\n  const response = await hass.connection.sendMessagePromise({\n    type: \"pp_reader/get_last_file_update\",\n    entry_id,\n  });\n  return response?.last_file_update || response || '';\n}\n\n// Portfolios\nexport async function fetchPortfoliosWS(hass, panelConfig) {\n  const entry_id = deriveEntryId(hass, panelConfig);\n  if (!hass || !entry_id) {\n    throw new Error(`fetchPortfoliosWS: fehlendes hass oder entry_id (${entry_id})`);\n  }\n  return await hass.connection.sendMessagePromise({\n    type: \"pp_reader/get_portfolio_data\",\n    entry_id,\n  });\n}\n\n// Positions (lazy)\nexport async function fetchPortfolioPositionsWS(hass, panelConfig, portfolio_uuid) {\n  const entry_id = deriveEntryId(hass, panelConfig);\n  if (!hass || !entry_id) {\n    throw new Error(`fetchPortfolioPositionsWS: fehlendes hass oder entry_id (${entry_id})`);\n  }\n  if (!portfolio_uuid) {\n    throw new Error(\"fetchPortfolioPositionsWS: fehlendes portfolio_uuid\");\n  }\n  return await hass.connection.sendMessagePromise({\n    type: \"pp_reader/get_portfolio_positions\",\n    entry_id,\n    portfolio_uuid,\n  });\n}\n\n// Security snapshot for detail tab\nexport async function fetchSecuritySnapshotWS(\n  hass,\n  panelConfig,\n  securityUuid,\n) {\n  const entry_id = deriveEntryId(hass, panelConfig);\n  if (!hass || !entry_id) {\n    throw new Error(\n      `fetchSecuritySnapshotWS: fehlendes hass oder entry_id (${entry_id})`,\n    );\n  }\n  if (!securityUuid) {\n    throw new Error(\"fetchSecuritySnapshotWS: fehlendes securityUuid\");\n  }\n\n  return await hass.connection.sendMessagePromise({\n    type: \"pp_reader/get_security_snapshot\",\n    entry_id,\n    security_uuid: securityUuid,\n  });\n}\n\n// Historical prices for detail tab charting\nexport async function fetchSecurityHistoryWS(\n  hass,\n  panelConfig,\n  securityUuid,\n  options = {},\n) {\n  const entry_id = deriveEntryId(hass, panelConfig);\n  if (!hass || !entry_id) {\n    throw new Error(\n      `fetchSecurityHistoryWS: fehlendes hass oder entry_id (${entry_id})`,\n    );\n  }\n  if (!securityUuid) {\n    throw new Error(\"fetchSecurityHistoryWS: fehlendes securityUuid\");\n  }\n\n  const payload = {\n    type: \"pp_reader/get_security_history\",\n    entry_id,\n    security_uuid: securityUuid,\n  };\n\n  const { startDate, endDate, start_date: start_date_raw, end_date: end_date_raw } =\n    options || {};\n\n  const resolvedStart = startDate ?? start_date_raw;\n  if (resolvedStart !== undefined && resolvedStart !== null) {\n    payload.start_date = resolvedStart;\n  }\n\n  const resolvedEnd = endDate ?? end_date_raw;\n  if (resolvedEnd !== undefined && resolvedEnd !== null) {\n    payload.end_date = resolvedEnd;\n  }\n\n  return await hass.connection.sendMessagePromise(payload);\n}\n","// @ts-nocheck\n\n/**\n * Live update handlers mirrored from the legacy websocket client.\n */\n\nimport { makeTable } from '../content/elements';\nimport { sortTableRows } from '../content/elements'; // NEU: generische Sortier-Utility\n\nconst PENDING_RETRY_INTERVAL = 500;\nconst PENDING_MAX_ATTEMPTS = 10;\nconst PORTFOLIO_POSITIONS_UPDATED_EVENT = 'pp-reader:portfolio-positions-updated';\n\nfunction ensurePendingMap() {\n  if (!window.__ppReaderPendingPositions) {\n    window.__ppReaderPendingPositions = new Map();\n  }\n  return window.__ppReaderPendingPositions;\n}\n\nfunction ensurePendingRetryMeta() {\n  if (!window.__ppReaderPendingRetryMeta) {\n    window.__ppReaderPendingRetryMeta = new Map();\n  }\n  return window.__ppReaderPendingRetryMeta;\n}\n\nfunction renderPositionsError(error, portfolioUuid) {\n  const safeError = typeof error === 'string' ? error : String(error || 'Unbekannter Fehler');\n  return `<div class=\"error\">${safeError} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n}\n\nfunction restoreSortAndInit(containerEl, rootEl, pid) {\n  const table = containerEl.querySelector('table.sortable-positions');\n  if (!table) return;\n\n  const key = containerEl.dataset.sortKey || table.dataset.defaultSort || 'name';\n  const dir = containerEl.dataset.sortDir || table.dataset.defaultDir || 'asc';\n  containerEl.dataset.sortKey = key;\n  containerEl.dataset.sortDir = dir;\n\n  try {\n    sortTableRows(table, key, dir, true);\n  } catch (e) {\n    console.warn('restoreSortAndInit: sortTableRows Fehler:', e);\n  }\n\n  try {\n    if (window.__ppReaderAttachPortfolioPositionsSorting) {\n      window.__ppReaderAttachPortfolioPositionsSorting(rootEl, pid);\n    }\n  } catch (e) {\n    console.warn('restoreSortAndInit: attachPortfolioPositionsSorting Fehler:', e);\n  }\n\n  try {\n    if (window.__ppReaderAttachSecurityDetailListener) {\n      window.__ppReaderAttachSecurityDetailListener(rootEl, pid);\n    }\n  } catch (e) {\n    console.warn('restoreSortAndInit: attachSecurityDetailListener Fehler:', e);\n  }\n}\n\nfunction applyPortfolioPositionsToDom(root, portfolioUuid, positions, error) {\n  if (!root || !portfolioUuid) {\n    return { applied: false, reason: 'invalid' };\n  }\n\n  const detailsRow = root.querySelector(\n    `.portfolio-table .portfolio-details[data-portfolio=\"${portfolioUuid}\"]`\n  );\n  if (!detailsRow) {\n    return { applied: false, reason: 'missing' };\n  }\n\n  const container = detailsRow.querySelector('.positions-container');\n  if (!container) {\n    return { applied: false, reason: 'missing' };\n  }\n\n  if (detailsRow.classList.contains('hidden')) {\n    return { applied: false, reason: 'hidden' };\n  }\n\n  if (error) {\n    container.innerHTML = renderPositionsError(error, portfolioUuid);\n    return { applied: true };\n  }\n\n  const prevKey = container.dataset.sortKey;\n  const prevDir = container.dataset.sortDir;\n\n  container.innerHTML = renderPositionsTableInline(positions || []);\n\n  if (prevKey) container.dataset.sortKey = prevKey;\n  if (prevDir) container.dataset.sortDir = prevDir;\n\n  restoreSortAndInit(container, root, portfolioUuid);\n  return { applied: true };\n}\n\nexport function flushPendingPositions(root, portfolioUuid) {\n  const pendingMap = ensurePendingMap();\n  const pending = pendingMap.get(portfolioUuid);\n  if (!pending) return false;\n\n  const result = applyPortfolioPositionsToDom(\n    root,\n    portfolioUuid,\n    pending.positions,\n    pending.error\n  );\n  if (result.applied) {\n    pendingMap.delete(portfolioUuid);\n  }\n  return result.applied;\n}\n\nexport function flushAllPendingPositions(root) {\n  const pendingMap = ensurePendingMap();\n  let appliedAny = false;\n  for (const [portfolioUuid] of pendingMap) {\n    if (flushPendingPositions(root, portfolioUuid)) {\n      appliedAny = true;\n    }\n  }\n  return appliedAny;\n}\n\nfunction schedulePendingRetry(root, portfolioUuid) {\n  const retryMetaMap = ensurePendingRetryMeta();\n  const meta = retryMetaMap.get(portfolioUuid) || { attempts: 0, timer: null };\n\n  if (meta.timer) {\n    return;\n  }\n\n  meta.timer = setTimeout(() => {\n    meta.timer = null;\n    meta.attempts += 1;\n\n    const success = flushPendingPositions(root, portfolioUuid);\n    if (success || meta.attempts >= PENDING_MAX_ATTEMPTS) {\n      retryMetaMap.delete(portfolioUuid);\n      if (!success) {\n        ensurePendingMap().delete(portfolioUuid);\n      }\n    } else {\n      schedulePendingRetry(root, portfolioUuid);\n    }\n  }, PENDING_RETRY_INTERVAL);\n\n  retryMetaMap.set(portfolioUuid, meta);\n}\n\n/**\n * Handler fÃ¼r Kontodaten-Updates (Accounts, inkl. FX).\n * @param {Array} update - Die empfangenen Kontodaten (mit currency_code, orig_balance, balance(EUR)).\n * @param {HTMLElement} root - Das Root-Element des Dashboards.\n */\nexport function handleAccountUpdate(update, root) {\n  console.log(\"updateConfigsWS: Kontodaten-Update erhalten:\", update);\n  const updatedAccounts = update || [];\n\n  // Tabellen aktualisieren (EUR + FX)\n  updateAccountTable(updatedAccounts, root);\n\n  // Portfolios aus aktueller Tabelle lesen (fÃ¼r Total-Neuberechnung)\n  const portfolioTable = root.querySelector('.portfolio-table table');\n  const portfolios = portfolioTable\n    ? Array.from(portfolioTable.querySelectorAll('tbody tr:not(.footer-row)')).map(row => {\n      // Spalten: Name | position_count | current_value | gain_abs | gain_pct\n      const currentValueCell = row.cells[2];\n      return {\n        current_value: parseFloat(\n          (currentValueCell?.textContent || '')\n            .replace(/\\./g, '')\n            .replace(',', '.')\n            .replace(/[^\\d.-]/g, '')\n        ) || 0\n      };\n    })\n    : [];\n\n  updateTotalWealth(updatedAccounts, portfolios, root);\n}\n\n/**\n * Aktualisiert die Tabellen mit den Kontodaten (EUR + FX).\n * @param {Array} accounts - Alle Kontodaten.\n * @param {HTMLElement} root - Root-Element.\n */\nfunction updateAccountTable(accounts, root) {\n  const eurContainer = root.querySelector('.account-table');\n  const fxContainer = root.querySelector('.fx-account-table');\n\n  const eurAccounts = accounts.filter(a => (a.currency_code || 'EUR') === 'EUR');\n  const fxAccounts = accounts.filter(a => (a.currency_code || 'EUR') !== 'EUR');\n\n  if (eurContainer) {\n    eurContainer.innerHTML = makeTable(eurAccounts, [\n      { key: 'name', label: 'Name' },\n      { key: 'balance', label: 'Kontostand (EUR)', align: 'right' }\n    ], ['balance']);\n  } else {\n    console.warn(\"updateAccountTable: .account-table nicht gefunden.\");\n  }\n\n  if (fxContainer) {\n    fxContainer.innerHTML = makeTable(\n      fxAccounts.map(a => ({\n        ...a,\n        fx_display: `${(a.orig_balance ?? 0).toLocaleString('de-DE', {\n          minimumFractionDigits: 2,\n          maximumFractionDigits: 2\n        })}\\u00A0${a.currency_code}`\n      })),\n      [\n        { key: 'name', label: 'Name' },\n        { key: 'fx_display', label: 'Betrag (FX)' },\n        { key: 'balance', label: 'EUR', align: 'right' }\n      ],\n      ['balance']\n    );\n  } else if (fxAccounts.length) {\n    console.warn(\"updateAccountTable: .fx-account-table nicht gefunden, obwohl FX-Konten vorhanden sind.\");\n  }\n}\n\n/**\n * Handler fÃ¼r Depot-Updates (aggregierte Portfolio-Werte).\n * Ersetzt die bisherige komplette Tabellen-Neuerstellung durch ein gezieltes Patchen\n * der vorhandenen expandierbaren Tabelle (gebaut in overview.js).\n * @param {Array} update - Die empfangenen Depotdaten (uuid, name, current_value, purchase_sum, position_count)\n * @param {HTMLElement} root - Root-Element.\n */\nexport function handlePortfolioUpdate(update, root) {\n  if (!Array.isArray(update)) {\n    console.warn(\"handlePortfolioUpdate: Update ist kein Array:\", update);\n    return;\n  }\n  try {\n    console.debug(\"handlePortfolioUpdate: payload=\", update);\n  } catch (_) { }\n\n  // Tabelle finden (neuer Selektor unterstÃ¼tzt beide Varianten)\n  const table =\n    root?.querySelector('.portfolio-table table') ||\n    root?.querySelector('table.expandable-portfolio-table');\n  if (!table) {\n    const overviewHost = root?.querySelector('.portfolio-table');\n    const detailViewActive =\n      !overviewHost &&\n      (root?.querySelector('.security-range-selector') ||\n        root?.querySelector('.security-detail-placeholder'));\n\n    if (detailViewActive) {\n      console.debug(\n        \"handlePortfolioUpdate: Ãœbersicht nicht aktiv â€“ Update wird spÃ¤ter angewendet.\"\n      );\n    } else {\n      console.warn(\"handlePortfolioUpdate: Keine Portfolio-Tabelle gefunden.\");\n    }\n    return;\n  }\n  const tbody = table.tBodies?.[0];\n  if (!tbody) {\n    console.warn(\"handlePortfolioUpdate: Kein <tbody> in Tabelle.\");\n    return;\n  }\n\n  // Helper Formatierer (lokal oder einfacher Fallback)\n  const formatNumber = (val) => {\n    if (window.Intl) {\n      try {\n        return new Intl.NumberFormat(navigator.language || 'de-DE', {\n          minimumFractionDigits: 2,\n          maximumFractionDigits: 2\n        }).format(val);\n      } catch (_) { }\n    }\n    return (Math.round(val * 100) / 100).toFixed(2).replace('.', ',');\n  };\n\n  // Map: uuid -> Row\n  const rowMap = new Map(\n    Array.from(tbody.querySelectorAll('tr.portfolio-row'))\n      .filter(r => r.dataset && r.dataset.portfolio)\n      .map(r => [r.dataset.portfolio, r])\n  );\n\n  let patched = 0;\n\n  const formatPositionCount = (value) => {\n    const numeric = Number.isFinite(value) ? value : 0;\n    try {\n      return numeric.toLocaleString('de-DE');\n    } catch (_error) {\n      return numeric.toString();\n    }\n  };\n\n  for (const u of update) {\n    if (!u || !u.uuid) continue;\n    const row = rowMap.get(u.uuid);\n    if (!row) continue;\n\n    if (row.cells.length < 3) continue;\n\n    const posCountCell = row.cells[1];\n    const curValCell = row.cells[2];\n    const gainAbsCell = row.cells[3];\n    const gainPctCell = row.cells[4];\n\n    // Normalisierung (Full Sync nutzt value/purchase_sum; Price Events current_value/purchase_sum)\n    const posCount = Number(u.position_count ?? u.count ?? 0);\n    const curVal = Number(u.current_value ?? u.value ?? 0);\n    const purchase = Number(u.purchase_sum ?? u.purchaseSum ?? 0);\n\n    const gainAbs = curVal - purchase;\n    const gainPct = purchase > 0 ? (gainAbs / purchase) * 100 : 0;\n\n    const oldCur = parseNumLoose(curValCell.textContent);\n    const oldCnt = parseNumLoose(posCountCell.textContent);\n\n    if (oldCnt !== posCount) {\n      posCountCell.textContent = formatPositionCount(posCount);\n    }\n    if (Math.abs(oldCur - curVal) >= 0.005) {\n      curValCell.textContent = formatNumber(curVal) + ' â‚¬';\n      row.classList.add('flash-update');\n      setTimeout(() => row.classList.remove('flash-update'), 800);\n    }\n    if (gainAbsCell) {\n      gainAbsCell.innerHTML = formatGain(gainAbs);\n      gainAbsCell.dataset.gainPct = Number.isFinite(gainPct)\n        ? `${formatNumber(gainPct)} %`\n        : 'â€”';\n      gainAbsCell.dataset.gainSign = Number.isFinite(gainPct)\n        ? (gainPct > 0 ? 'positive' : gainPct < 0 ? 'negative' : 'neutral')\n        : 'neutral';\n    }\n    if (gainPctCell) {\n      gainPctCell.innerHTML = formatGainPct(gainPct);\n    }\n\n    row.dataset.positionCount = String(posCount);\n    row.dataset.currentValue = String(curVal);\n    row.dataset.purchaseSum = String(purchase);\n    row.dataset.gainAbs = String(gainAbs);\n    row.dataset.gainPct = String(gainPct);\n\n    patched++;\n\n  }\n\n  if (patched === 0) {\n    console.debug(\"handlePortfolioUpdate: Keine passenden Zeilen gefunden / keine Ã„nderungen.\");\n  } else {\n    console.debug(`handlePortfolioUpdate: ${patched} Zeile(n) gepatcht.`);\n  }\n\n  try {\n    updatePortfolioFooter(table);\n  } catch (e) {\n    console.warn(\"handlePortfolioUpdate: Fehler bei Summen-Neuberechnung:\", e);\n  }\n\n  // Total-Wealth neu berechnen (Accounts + Portfolios)\n  try {\n    const findTable = (...selectors) => {\n      for (const selector of selectors) {\n        if (!selector) continue;\n        const tableEl = root?.querySelector(selector);\n        if (tableEl) return tableEl;\n      }\n      return null;\n    };\n\n    const eurTable = findTable(\n      '.account-table table',\n      '.accounts-eur-table table',\n      '.accounts-table table'\n    );\n    const fxTable = findTable(\n      '.fx-account-table table',\n      '.accounts-fx-table table'\n    );\n\n    const extractAccounts = (tbl, isFx) => {\n      if (!tbl) return [];\n      const accountRows = tbl.querySelectorAll('tbody tr.account-row');\n      const rows = accountRows.length\n        ? Array.from(accountRows)\n        : Array.from(tbl.querySelectorAll('tbody tr:not(.footer-row)'));\n\n      return rows.map(r => {\n        const cell = isFx ? r.cells[2] : r.cells[1];\n        return { balance: parseNumLoose(cell?.textContent) };\n      });\n    };\n    const accounts = [\n      ...extractAccounts(eurTable, false),\n      ...extractAccounts(fxTable, true),\n    ];\n\n    const portfolioDomValues = Array.from(\n      table.querySelectorAll('tbody tr.portfolio-row')\n    ).map(r => {\n      const cv = parseNumLoose(r.cells[2]?.textContent);\n      const gain = parseNumLoose(r.cells[3]?.textContent);\n      const ps = cv - gain;\n      return { current_value: cv, purchase_sum: ps };\n    });\n\n    if (typeof updateTotalWealth === 'function') {\n      updateTotalWealth(accounts, portfolioDomValues, root);\n    }\n  } catch (e) {\n    console.warn(\"handlePortfolioUpdate: Fehler bei Total-Neuberechnung:\", e);\n  }\n}\n\n/**\n * NEU: Handler fÃ¼r Einzel-Positions-Updates (Event: portfolio_positions).\n * @param {{portfolio_uuid: string, positions: Array}} update\n * @param {HTMLElement} root\n */\nfunction normalizePortfolioUuid(payload) {\n  if (!payload || typeof payload !== 'object') {\n    return null;\n  }\n  const direct = payload.portfolio_uuid;\n  if (typeof direct === 'string' && direct) {\n    return direct;\n  }\n  const camelCase = payload.portfolioUuid;\n  if (typeof camelCase === 'string' && camelCase) {\n    return camelCase;\n  }\n  return null;\n}\n\nfunction processPortfolioPositionsUpdate(update, root) {\n  const portfolioUuid = normalizePortfolioUuid(update);\n  if (!portfolioUuid) {\n    console.warn(\"handlePortfolioPositionsUpdate: UngÃ¼ltiges Update:\", update);\n    return false;\n  }\n\n  const error = update?.error;\n  const positions = Array.isArray(update?.positions) ? update.positions : [];\n\n  // Positions-Cache aktualisieren (Lazy-Load bleibt bestehen)\n  try {\n    const cache = window.__ppReaderPortfolioPositionsCache;\n    if (cache && typeof cache.set === 'function' && !error) {\n      cache.set(portfolioUuid, positions);\n    }\n  } catch (e) {\n    console.warn(\"handlePortfolioPositionsUpdate: Positions-Cache konnte nicht aktualisiert werden:\", e);\n  }\n\n  const result = applyPortfolioPositionsToDom(root, portfolioUuid, positions, error);\n  const pendingMap = ensurePendingMap();\n\n  if (result.applied) {\n    pendingMap.delete(portfolioUuid);\n  } else {\n    pendingMap.set(portfolioUuid, { positions, error });\n    if (result.reason !== 'hidden') {\n      schedulePendingRetry(root, portfolioUuid);\n    }\n  }\n\n  if (!error && positions.length > 0) {\n    const securityUuids = Array.from(\n      new Set(\n        positions\n          .map((pos) => pos?.security_uuid)\n          .filter((uuid) => typeof uuid === 'string' && uuid.length > 0),\n      ),\n    );\n\n    if (securityUuids.length && typeof window !== 'undefined') {\n      try {\n        window.dispatchEvent(\n          new CustomEvent(PORTFOLIO_POSITIONS_UPDATED_EVENT, {\n            detail: {\n              portfolioUuid,\n              securityUuids,\n            },\n          }),\n        );\n      } catch (dispatchError) {\n        console.warn(\n          'handlePortfolioPositionsUpdate: Dispatch des Portfolio-Events fehlgeschlagen',\n          dispatchError,\n        );\n      }\n    }\n  }\n\n  return true;\n}\n\nexport function handlePortfolioPositionsUpdate(update, root) {\n  if (Array.isArray(update)) {\n    let handled = false;\n    for (const item of update) {\n      if (processPortfolioPositionsUpdate(item, root)) {\n        handled = true;\n      }\n    }\n    if (!handled && update.length) {\n      console.warn(\"handlePortfolioPositionsUpdate: Kein gÃ¼ltiges Element im Array:\", update);\n    }\n    return;\n  }\n\n  processPortfolioPositionsUpdate(update, root);\n}\n\n/* ------------------ Hilfsfunktionen (lokal) ------------------ */\n\nfunction renderPositionsTableInline(positions) {\n  // Konsistenz Push vs Lazy:\n  try {\n    if (window.__ppReaderRenderPositionsTable) {\n      return window.__ppReaderRenderPositionsTable(positions);\n    }\n  } catch (_) { }\n\n  if (!positions || !positions.length) {\n    return '<div class=\"no-positions\">Keine Positionen vorhanden.</div>';\n  }\n  const rows = positions.map(p => ({\n    name: p.name,\n    current_holdings: p.current_holdings,\n    purchase_value: p.purchase_value,\n    current_value: p.current_value,\n    gain_abs: p.gain_abs,\n    gain_pct: p.gain_pct\n  }));\n\n  // Basis HTML\n  const raw = makeTable(\n    rows,\n    [\n      { key: 'name', label: 'Wertpapier' },\n      { key: 'current_holdings', label: 'Bestand', align: 'right' },\n      { key: 'purchase_value', label: 'Kaufwert', align: 'right' },\n      { key: 'current_value', label: 'Aktueller Wert', align: 'right' },\n      { key: 'gain_abs', label: '+/-', align: 'right' },\n      { key: 'gain_pct', label: '%', align: 'right' }\n    ],\n    ['purchase_value', 'current_value', 'gain_abs']\n  );\n\n  // Sortier-Metadaten wie in overview.js renderPositionsTable injizieren\n  try {\n    const tpl = document.createElement('template');\n    tpl.innerHTML = raw.trim();\n    const table = tpl.content.querySelector('table');\n    if (table) {\n      table.classList.add('sortable-positions');\n      const ths = table.querySelectorAll('thead th');\n      const colKeys = ['name', 'current_holdings', 'purchase_value', 'current_value', 'gain_abs', 'gain_pct'];\n      ths.forEach((th, i) => {\n        const key = colKeys[i];\n        if (!key) return;\n        th.setAttribute('data-sort-key', key);\n        th.classList.add('sortable-col');\n      });\n      const bodyRows = table.querySelectorAll('tbody tr');\n      bodyRows.forEach((tr, idx) => {\n        if (tr.classList.contains('footer-row')) {\n          return;\n        }\n        const pos = positions[idx];\n        if (pos?.security_uuid) {\n          tr.dataset.security = pos.security_uuid;\n        }\n        tr.classList.add('position-row');\n      });\n      table.dataset.defaultSort = 'name';\n      table.dataset.defaultDir = 'asc';\n      if (window.__ppReaderApplyGainPctMetadata) {\n        try {\n          window.__ppReaderApplyGainPctMetadata(table);\n        } catch (err) {\n          console.warn('renderPositionsTableInline: applyGainPctMetadata failed', err);\n        }\n      } else {\n        const rows = table.querySelectorAll('tbody tr');\n        rows.forEach(row => {\n          const gainCell = row.cells?.[4];\n          const pctCell = row.cells?.[5];\n          if (!gainCell || !pctCell) return;\n          const pctText = (pctCell.textContent || '').trim() || 'â€”';\n          let pctSign = 'neutral';\n          if (pctCell.querySelector('.positive')) {\n            pctSign = 'positive';\n          } else if (pctCell.querySelector('.negative')) {\n            pctSign = 'negative';\n          }\n          gainCell.dataset.gainPct = pctText;\n          gainCell.dataset.gainSign = pctSign;\n        });\n      }\n      return table.outerHTML;\n    }\n  } catch (e) {\n    console.warn(\"renderPositionsTableInline: Sortier-Metadaten Injection fehlgeschlagen:\", e);\n  }\n  return raw;\n}\n\nif (!window.__ppReaderFlushPendingPositions) {\n  window.__ppReaderFlushPendingPositions = (root, portfolioUuid) =>\n    flushPendingPositions(root, portfolioUuid);\n}\n\nif (!window.__ppReaderFlushAllPendingPositions) {\n  window.__ppReaderFlushAllPendingPositions = (root) => flushAllPendingPositions(root);\n}\n\nfunction updatePortfolioFooter(table) {\n  if (!table) return;\n  try {\n    const helper = window.__ppReaderUpdatePortfolioFooter;\n    if (typeof helper === 'function') {\n      helper(table);\n      return;\n    }\n  } catch (err) {\n    console.warn(\"updatePortfolioFooter: global Helper schlug fehl:\", err);\n  }\n\n  const rows = Array.from(table.querySelectorAll('tbody tr.portfolio-row'));\n  let sumCurrent = 0;\n  let sumGainAbs = 0;\n  let sumPurchase = 0;\n  let sumPositions = 0;\n\n  rows.forEach(r => {\n    const datasetCount = Number(r.dataset?.positionCount);\n    const posCount = Number.isFinite(datasetCount)\n      ? datasetCount\n      : parseInt((r.cells[1]?.textContent || '').replace(/\\./g, ''), 10) || 0;\n\n    const datasetCurrent = Number(r.dataset?.currentValue);\n    const currentValue = Number.isFinite(datasetCurrent)\n      ? datasetCurrent\n      : parseNumLoose(r.cells[2]?.textContent);\n\n    const datasetGain = Number(r.dataset?.gainAbs);\n    const gainAbs = Number.isFinite(datasetGain)\n      ? datasetGain\n      : parseNumLoose(r.cells[3]?.textContent);\n\n    const datasetPurchase = Number(r.dataset?.purchaseSum);\n    const purchase = Number.isFinite(datasetPurchase)\n      ? datasetPurchase\n      : (currentValue - gainAbs);\n\n    sumPositions += posCount;\n    sumCurrent += currentValue;\n    sumGainAbs += gainAbs;\n    sumPurchase += purchase;\n  });\n\n  if (sumPurchase <= 0) {\n    sumPurchase = sumCurrent - sumGainAbs;\n  }\n  const sumGainPct = sumPurchase > 0 ? (sumGainAbs / sumPurchase) * 100 : 0;\n\n  let footer = table.querySelector('tr.footer-row');\n  if (!footer) {\n    footer = document.createElement('tr');\n    footer.className = 'footer-row';\n    table.querySelector('tbody')?.appendChild(footer);\n  }\n  const sumPositionsDisplay = Math.round(sumPositions).toLocaleString('de-DE');\n\n  footer.innerHTML = `\n    <td>Summe</td>\n    <td class=\"align-right\">${sumPositionsDisplay}</td>\n    <td class=\"align-right\">${formatNumber(sumCurrent)}&nbsp;â‚¬</td>\n    <td class=\"align-right\">${formatGain(sumGainAbs)}</td>\n    <td class=\"align-right\">${formatGainPct(sumGainPct)}</td>\n  `;\n  const footerGainAbsCell = footer.cells?.[3];\n  if (footerGainAbsCell) {\n    footerGainAbsCell.dataset.gainPct = Number.isFinite(sumGainPct)\n      ? `${formatNumber(sumGainPct)} %`\n      : 'â€”';\n    footerGainAbsCell.dataset.gainSign = Number.isFinite(sumGainPct)\n      ? (sumGainPct > 0 ? 'positive' : sumGainPct < 0 ? 'negative' : 'neutral')\n      : 'neutral';\n  }\n  footer.dataset.positionCount = String(Math.round(sumPositions));\n  footer.dataset.currentValue = String(sumCurrent);\n  footer.dataset.purchaseSum = String(sumPurchase);\n  footer.dataset.gainAbs = String(sumGainAbs);\n  footer.dataset.gainPct = String(sumGainPct);\n}\n\nfunction parseLocaleNumber(txt = '') {\n  if (!txt) return 0;\n  return parseFloat(\n    txt\n      .replace(/[^0-9,.\\-]/g, '')\n      .replace(/\\./g, '')\n      .replace(',', '.')\n  ) || 0;\n}\n\nfunction formatNumber(v) {\n  return (isNaN(v) ? 0 : v).toLocaleString('de-DE', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2\n  });\n}\nfunction formatGain(v) {\n  const cls = v >= 0 ? 'positive' : 'negative';\n  return `<span class=\"${cls}\">${formatNumber(v)}&nbsp;â‚¬</span>`;\n}\nfunction formatGainPct(v) {\n  const cls = v >= 0 ? 'positive' : 'negative';\n  return `<span class=\"${cls}\">${formatNumber(v)}&nbsp;%</span>`;\n}\n\nfunction updateTotalWealth(accounts, portfolios, root) {\n  const targetRoot = root || document;\n\n  const accountSum = (Array.isArray(accounts) ? accounts : []).reduce((acc, entry) => {\n    const value = entry != null && typeof entry === 'object'\n      ? entry.balance ?? entry.current_value ?? entry.value ?? 0\n      : entry;\n    const numeric = Number(value);\n    return acc + (Number.isFinite(numeric) ? numeric : 0);\n  }, 0);\n\n  const portfolioSum = (Array.isArray(portfolios) ? portfolios : []).reduce((acc, entry) => {\n    const value = entry != null && typeof entry === 'object'\n      ? entry.current_value ?? entry.value ?? 0\n      : entry;\n    const numeric = Number(value);\n    return acc + (Number.isFinite(numeric) ? numeric : 0);\n  }, 0);\n\n  const totalWealth = accountSum + portfolioSum;\n\n  const headerMeta = targetRoot?.querySelector('#headerMeta');\n  if (!headerMeta) {\n    console.warn('updateTotalWealth: #headerMeta nicht gefunden.');\n    return;\n  }\n\n  const valueElement = headerMeta.querySelector('strong') || headerMeta.querySelector('.total-wealth-value');\n  if (valueElement) {\n    valueElement.textContent = `${formatNumber(totalWealth)}\\u00A0â‚¬`;\n  } else {\n    headerMeta.textContent = `ðŸ’° GesamtvermÃ¶gen: ${formatNumber(totalWealth)}\\u00A0â‚¬`;\n  }\n\n  headerMeta.dataset.totalWealthEur = String(totalWealth);\n}\n\n/**\n * HINWEIS (2025-09):\n * Die frÃ¼here Funktion updatePortfolioTable (vollstÃ¤ndiger Neuaufbau der Depot-Tabelle)\n * wurde durch inkrementelles Patchen via handlePortfolioUpdate + Lazy-Load der Positions-\n * daten ersetzt. Alte Implementierung entfernt, um doppelte Logik und Render-Flashes\n * zu vermeiden.\n *\n * Falls noch Referenzen auf updatePortfolioTable existieren, bitte auf handlePortfolioUpdate\n * umstellen. (dashboard.js ruft bereits nur noch _doRender -> handlePortfolioUpdate auf.)\n */\n// Entfernte Legacy-Funktion:\n// function updatePortfolioTable(...) { /* veraltet, entfernt */ }\n\n// Helper: Erzeuge (Portfolio-Hauptzeile + Detailzeile) HTML-Strings\nfunction createPortfolioRowHtml(p, expanded = false) {\n  const detailId = `portfolio-details-${p.uuid}`;\n  const toggleClass = expanded ? 'portfolio-toggle expanded' : 'portfolio-toggle';\n  return {\n    main: `<tr class=\"portfolio-row\" data-portfolio=\"${p.uuid}\">\n      <td>\n        <button type=\"button\"\n                class=\"${toggleClass}\"\n                data-portfolio=\"${p.uuid}\"\n                aria-expanded=\"${expanded ? 'true' : 'false'}\"\n                aria-controls=\"${detailId}\">\n          <span class=\"caret\">${expanded ? 'â–¼' : 'â–¶'}</span>\n          <span class=\"portfolio-name\">${p.name}</span>\n        </button>\n      </td>\n      <td class=\"align-right\">${(p.position_count ?? 0).toLocaleString('de-DE')}</td>\n      <td class=\"align-right\">${formatNumber(p.current_value)}&nbsp;â‚¬</td>\n      <td class=\"align-right\">${formatGain(p.current_value - p.purchase_sum)}</td>\n      <td class=\"align-right\">${formatGainPct(p.purchase_sum > 0 ? ((p.current_value - p.purchase_sum) / p.purchase_sum) * 100 : 0)}</td>\n    </tr>`,\n    detail: `<tr class=\"portfolio-details hidden\"\n                 data-portfolio=\"${p.uuid}\"\n                 id=\"${detailId}\"\n                 role=\"region\"\n                 aria-label=\"Positionen fÃ¼r ${p.name}\">\n        <td colspan=\"5\">\n          <div class=\"positions-container\"></div>\n        </td>\n      </tr>`\n  };\n}\n\n// ==== Last File Update Handler (canonical) ====\n// (Ã„ndere zu export function, damit unten kein Sammel-Export nÃ¶tig ist)\nexport function handleLastFileUpdate(update, root) {\n  const value = typeof update === 'string'\n    ? update\n    : (update && update.last_file_update) || '';\n\n  if (!root) {\n    console.warn(\"handleLastFileUpdate: root fehlt\");\n    return;\n  }\n\n  // Bevorzugt Footer-Karte, sonst erste passende Stelle\n  let el = root.querySelector('.footer-card .last-file-update') ||\n    root.querySelector('.last-file-update');\n\n  if (!el) {\n    // Fallback: existierende Meta-Hosts durchsuchen\n    const metaHost =\n      root.querySelector('.footer-card .meta') ||\n      root.querySelector('#headerMeta') ||\n      root.querySelector('.header-card .meta') ||\n      root.querySelector('.header-card');\n    if (!metaHost) {\n      console.warn(\"handleLastFileUpdate: Kein EinfÃ¼gepunkt gefunden.\");\n      return;\n    }\n    el = document.createElement('div');\n    el.className = 'last-file-update';\n    metaHost.appendChild(el);\n  }\n\n  // Format abhÃ¤ngig vom Ort (Footer behÃ¤lt <strong>)\n  if (el.closest('.footer-card')) {\n    el.innerHTML = value\n      ? `ðŸ“‚ Letzte Aktualisierung der Datei: <strong>${value}</strong>`\n      : `ðŸ“‚ Letzte Aktualisierung der Datei: <strong>Unbekannt</strong>`;\n  } else {\n    // Header/Meta-Version (schlichter Text)\n    el.textContent = value\n      ? `ðŸ“‚ Letzte Aktualisierung: ${value}`\n      : 'ðŸ“‚ Letzte Aktualisierung: Unbekannt';\n  }\n}\n/// END handleLastFileUpdate (canonical)\n\n/**\n * NEUER HELPER (Ã„nderung 8):\n * Re-applied die gespeicherte Sortierung einer Positions-Tabelle.\n * Liest container.dataset.sortKey / sortDir oder Default-Werte vom <table>.\n * Nutzt sortTableRows(..., true) fÃ¼r Positions-Mapping.\n * @param {HTMLElement} containerEl .positions-container\n */\nexport function reapplyPositionsSort(containerEl) {\n  if (!containerEl) return;\n  const table = containerEl.querySelector('table.sortable-positions');\n  if (!table) return;\n  const key = containerEl.dataset.sortKey || table.dataset.defaultSort || 'name';\n  const dir = containerEl.dataset.sortDir || table.dataset.defaultDir || 'asc';\n  // Persistiere (falls erstmalig)\n  containerEl.dataset.sortKey = key;\n  containerEl.dataset.sortDir = dir;\n  sortTableRows(table, key, dir, true);\n}\nwindow.__ppReaderReapplyPositionsSort = reapplyPositionsSort; // Optional global fÃ¼r Lazy-Load-Code\n\n// === Globale / modulweite Utilities ===\nfunction parseNumLoose(txt) {\n  if (txt == null) return 0;\n  return parseFloat(\n    String(txt)\n      .replace(/\\u00A0/g, ' ')\n      .replace(/[â‚¬%]/g, '')\n      .replace(/\\./g, '')\n      .replace(',', '.')\n      .replace(/[^\\d.-]/g, '')\n  ) || 0;\n}\n","// @ts-nocheck\n\n/**\n * Overview tab renderer copied for the TypeScript source tree.\n */\n\nimport {\n  createHeaderCard,\n  makeTable,\n  formatNumber,\n  formatGain,\n  formatGainPct,\n  formatValue,\n} from '../content/elements';\nimport { openSecurityDetail } from '../dashboard';\nimport {\n  fetchAccountsWS,\n  fetchLastFileUpdateWS,\n  fetchPortfoliosWS,\n  fetchPortfolioPositionsWS,\n} from '../data/api';\nimport { flushPendingPositions, flushAllPendingPositions } from '../data/updateConfigsWS';\n\n// === Modul-weiter State fÃ¼r Expand/Collapse & Lazy Load ===\n// On-Demand Aggregation liefert frische Portfolio-Werte; nur Positionen bleiben Lazy-Loaded.\nlet _hassRef = null;\nlet _panelConfigRef = null;\nconst portfolioPositionsCache = new Map();      // portfolio_uuid -> positions[]\n\n// --- Security-Aggregation fÃ¼r Detail-Ansicht ---\nconst HOLDINGS_PRECISION = 1e6;\n\nfunction toFiniteNumber(value) {\n  const num = Number(value);\n  return Number.isFinite(num) ? num : 0;\n}\n\nfunction roundCurrency(value) {\n  const finite = toFiniteNumber(value);\n  return Math.round(finite * 100) / 100;\n}\n\nfunction roundHoldings(value) {\n  const finite = toFiniteNumber(value);\n  return Math.round(finite * HOLDINGS_PRECISION) / HOLDINGS_PRECISION;\n}\n\nfunction collectSecurityPositions(securityUuid) {\n  if (!securityUuid) {\n    return [];\n  }\n\n  const matches = [];\n  for (const positions of portfolioPositionsCache.values()) {\n    if (!Array.isArray(positions) || positions.length === 0) {\n      continue;\n    }\n    for (const pos of positions) {\n      if (pos && pos.security_uuid === securityUuid) {\n        matches.push(pos);\n      }\n    }\n  }\n  return matches;\n}\n\nexport function getSecurityPositionsFromCache(securityUuid) {\n  const positions = collectSecurityPositions(securityUuid);\n  if (!positions.length) {\n    return [];\n  }\n  return positions.map((pos) => ({ ...pos }));\n}\n\nexport function getSecuritySnapshotFromCache(securityUuid) {\n  const positions = collectSecurityPositions(securityUuid);\n  if (!positions.length) {\n    return null;\n  }\n\n  let name = '';\n  let totalHoldings = 0;\n  let totalPurchaseValue = 0;\n  let totalCurrentValue = 0;\n\n  for (const pos of positions) {\n    if (!name && pos?.name) {\n      name = pos.name;\n    }\n    totalHoldings += toFiniteNumber(pos?.current_holdings);\n    totalPurchaseValue += toFiniteNumber(pos?.purchase_value);\n    totalCurrentValue += toFiniteNumber(pos?.current_value);\n  }\n\n  const gainAbs = totalCurrentValue - totalPurchaseValue;\n  const gainPct = totalPurchaseValue > 0\n    ? (gainAbs / totalPurchaseValue) * 100\n    : 0;\n  const lastPriceEur = totalHoldings > 0 ? totalCurrentValue / totalHoldings : null;\n\n  return {\n    security_uuid: securityUuid,\n    name,\n    total_holdings: roundHoldings(totalHoldings),\n    purchase_value_eur: roundCurrency(totalPurchaseValue),\n    current_value_eur: roundCurrency(totalCurrentValue),\n    gain_abs_eur: roundCurrency(gainAbs),\n    gain_pct: Math.round(gainPct * 100) / 100,\n    last_price_eur: lastPriceEur != null ? roundCurrency(lastPriceEur) : null,\n    source: 'cache',\n  };\n}\n\n// Global fÃ¼r Push-Handler (Events); hÃ¤lt ausschlieÃŸlich Positionsdaten fÃ¼r Lazy-Loads\nportfolioPositionsCache.getSecuritySnapshot = getSecuritySnapshotFromCache;\nportfolioPositionsCache.getSecurityPositions = getSecurityPositionsFromCache;\n\nwindow.__ppReaderPortfolioPositionsCache = portfolioPositionsCache;\nif (!window.__ppReaderGetSecuritySnapshotFromCache) {\n  window.__ppReaderGetSecuritySnapshotFromCache = getSecuritySnapshotFromCache;\n}\nif (!window.__ppReaderGetSecurityPositionsFromCache) {\n  window.__ppReaderGetSecurityPositionsFromCache = getSecurityPositionsFromCache;\n}\nconst expandedPortfolios = new Set();           // gemerkte geÃ¶ffnete Depots (persistiert Ã¼ber Re-Renders)\n\n// ENTFERNT: Globaler document-Listener (Section 6 Hardening)\n// Stattdessen scoped Listener Ã¼ber attachPortfolioToggleHandler(root)\n\n// Rendert die Positions-Tabelle fÃ¼r ein Depot\nfunction applyGainPctMetadata(tableEl) {\n  if (!tableEl) {\n    return;\n  }\n  const bodyRows = tableEl.querySelectorAll('tbody tr');\n  bodyRows.forEach(row => {\n    const gainAbsCell = row.cells?.[4];\n    const gainPctCell = row.cells?.[5];\n    if (!gainAbsCell || !gainPctCell) {\n      return;\n    }\n    const pctText = (gainPctCell.textContent || '').trim() || 'â€”';\n    let pctSign = 'neutral';\n    if (gainPctCell.querySelector('.positive')) {\n      pctSign = 'positive';\n    } else if (gainPctCell.querySelector('.negative')) {\n      pctSign = 'negative';\n    }\n    gainAbsCell.dataset.gainPct = pctText;\n    gainAbsCell.dataset.gainSign = pctSign;\n  });\n}\n\nif (!window.__ppReaderApplyGainPctMetadata) {\n  window.__ppReaderApplyGainPctMetadata = (tableEl) => applyGainPctMetadata(tableEl);\n}\n\nfunction renderPositionsTable(positions) {\n  if (!positions || !positions.length) {\n    return '<div class=\"no-positions\">Keine Positionen vorhanden.</div>';\n  }\n  // Mapping fÃ¼r makeTable\n  const cols = [\n    { key: 'name', label: 'Wertpapier' },\n    { key: 'current_holdings', label: 'Bestand', align: 'right' },\n    { key: 'purchase_value', label: 'Kaufwert', align: 'right' },\n    { key: 'current_value', label: 'Aktueller Wert', align: 'right' },\n    { key: 'gain_abs', label: '+/-', align: 'right' },\n    { key: 'gain_pct', label: '%', align: 'right' }\n  ];\n  const rows = positions.map(p => ({\n    name: p.name,\n    current_holdings: p.current_holdings,\n    purchase_value: p.purchase_value,\n    current_value: p.current_value,\n    gain_abs: p.gain_abs,\n    gain_pct: p.gain_pct\n  }));\n\n  // Basis-HTML Ã¼ber makeTable erzeugen\n  const raw = makeTable(rows, cols, ['purchase_value', 'current_value', 'gain_abs']);\n\n  // Header um data-sort-key ergÃ¤nzen + sortable Klasse setzen\n  try {\n    const tpl = document.createElement('template');\n    tpl.innerHTML = raw.trim();\n    const table = tpl.content.querySelector('table');\n    if (table) {\n      table.classList.add('sortable-positions');\n      const ths = table.querySelectorAll('thead th');\n      cols.forEach((c, i) => {\n        const th = ths[i];\n        if (th) {\n          th.setAttribute('data-sort-key', c.key);\n          th.classList.add('sortable-col');\n        }\n      });\n      const bodyRows = table.querySelectorAll('tbody tr');\n      bodyRows.forEach((tr, idx) => {\n        if (tr.classList.contains('footer-row')) {\n          return;\n        }\n        const pos = positions[idx];\n        if (!pos) {\n          return;\n        }\n        if (pos.security_uuid) {\n          tr.dataset.security = pos.security_uuid;\n        }\n        tr.classList.add('position-row');\n      });\n      // Default-Sortierung (nach Name asc) â€“ bereits durch SQL geliefert, aber markieren\n      table.dataset.defaultSort = 'name';\n      table.dataset.defaultDir = 'asc';\n      applyGainPctMetadata(table);\n      return table.outerHTML;\n    }\n  } catch (e) {\n    // Fallback: unverÃ¤ndertes Markup\n    console.warn(\"renderPositionsTable: Konnte Sortier-Metadaten nicht injizieren:\", e);\n  }\n  return raw;\n}\n\n// NEU: Export / Global bereitstellen fÃ¼r Push-Handler (Konsistenz Push vs Lazy)\nexport function renderPortfolioPositions(positions) {\n  return renderPositionsTable(positions);\n}\nwindow.__ppReaderRenderPositionsTable = renderPositionsTable;\n\nfunction attachSecurityDetailDelegation(root, portfolioUuid) {\n  if (!root || !portfolioUuid) return;\n  const detailsRow = root.querySelector(`.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`);\n  if (!detailsRow) return;\n  const container = detailsRow.querySelector('.positions-container');\n  if (!container || container.__ppReaderSecurityClickBound) return;\n\n  container.__ppReaderSecurityClickBound = true;\n\n  container.addEventListener('click', (event) => {\n    const interactive = event.target.closest('button, a');\n    if (interactive && container.contains(interactive)) {\n      return;\n    }\n\n    const row = event.target.closest('tr[data-security]');\n    if (!row || !container.contains(row)) {\n      return;\n    }\n\n    const securityUuid = row.getAttribute('data-security');\n    if (!securityUuid) {\n      return;\n    }\n\n    try {\n      const opened = openSecurityDetail(securityUuid);\n      if (!opened) {\n        console.warn('attachSecurityDetailDelegation: Detail-Tab konnte nicht geÃ¶ffnet werden fÃ¼r', securityUuid);\n      }\n    } catch (err) {\n      console.error('attachSecurityDetailDelegation: Fehler beim Ã–ffnen des Detail-Tabs', err);\n    }\n  });\n}\n\nexport function attachSecurityDetailListener(root, portfolioUuid) {\n  attachSecurityDetailDelegation(root, portfolioUuid);\n}\n\nif (!window.__ppReaderAttachSecurityDetailListener) {\n  window.__ppReaderAttachSecurityDetailListener = attachSecurityDetailListener;\n}\n\n// (1) Entferne evtl. doppelte frÃ¼here Definitionen von buildExpandablePortfolioTable â€“ nur diese Version behalten\nfunction buildExpandablePortfolioTable(depots) {\n  console.debug(\"buildExpandablePortfolioTable: render\", depots.length, \"portfolios\");\n  const escapeAttribute = (value) => {\n    if (value == null) {\n      return '';\n    }\n    return String(value)\n      .replace(/&/g, '&amp;')\n      .replace(/\"/g, '&quot;');\n  };\n\n  let html = '<table class=\"expandable-portfolio-table\"><thead><tr>';\n  const cols = [\n    { key: 'name', label: 'Name' },\n    { key: 'position_count', label: 'Anzahl Positionen', align: 'right' },\n    { key: 'current_value', label: 'Aktueller Wert', align: 'right' },\n    { key: 'gain_abs', label: 'Gesamt +/-', align: 'right' },\n    { key: 'gain_pct', label: '%', align: 'right' }\n  ];\n  cols.forEach(c => {\n    const align = c.align === 'right' ? ' class=\"align-right\"' : '';\n    html += `<th${align}>${c.label}</th>`;\n  });\n  html += '</tr></thead><tbody>';\n\n  depots.forEach(d => {\n    if (!d || !d.uuid) return;\n    const positionCount = Number.isFinite(d.position_count) ? d.position_count : 0;\n    const purchaseSum = Number.isFinite(d.purchase_sum) ? d.purchase_sum : 0;\n    const hasValue = d.hasValue !== false;\n    const currentValue = hasValue && Number.isFinite(d.current_value) ? d.current_value : null;\n    const gainAbs = hasValue && Number.isFinite(d.gain_abs)\n      ? d.gain_abs\n      : (hasValue && Number.isFinite(d.current_value) ? d.current_value - purchaseSum : null);\n    const gainPct = hasValue && Number.isFinite(d.gain_pct)\n      ? d.gain_pct\n      : (hasValue && purchaseSum > 0 && Number.isFinite(currentValue)\n        ? ((currentValue - purchaseSum) / purchaseSum) * 100\n        : null);\n\n    const expanded = expandedPortfolios.has(d.uuid);\n    const toggleClass = expanded ? 'portfolio-toggle expanded' : 'portfolio-toggle';\n    const detailId = `portfolio-details-${d.uuid}`;\n    const rowData = {\n      fx_unavailable: !hasValue,\n      current_value: currentValue,\n      gain_abs: gainAbs,\n      gain_pct: gainPct\n    };\n    const valueContext = { hasValue };\n    const currentValueCell = formatValue('current_value', rowData.current_value, rowData, valueContext);\n    const gainAbsCell = formatValue('gain_abs', rowData.gain_abs, rowData, valueContext);\n    const gainPctCell = formatValue('gain_pct', rowData.gain_pct, rowData, valueContext);\n\n    const gainPctLabel = hasValue && Number.isFinite(gainPct)\n      ? `${formatNumber(gainPct)} %`\n      : '';\n    const gainPctSign = hasValue && Number.isFinite(gainPct)\n      ? (gainPct > 0 ? 'positive' : gainPct < 0 ? 'negative' : 'neutral')\n      : '';\n\n    const datasetCurrentValue = hasValue && Number.isFinite(currentValue) ? currentValue : '';\n    const datasetGainAbs = hasValue && Number.isFinite(gainAbs) ? gainAbs : '';\n    const datasetGainPct = hasValue && Number.isFinite(gainPct) ? gainPct : '';\n\n    let gainAbsAttributes = '';\n    if (gainPctLabel) {\n      gainAbsAttributes = ` data-gain-pct=\"${escapeAttribute(gainPctLabel)}\" data-gain-sign=\"${escapeAttribute(gainPctSign)}\"`;\n    }\n\n    html += `<tr class=\"portfolio-row\"\n                data-portfolio=\"${d.uuid}\"\n                data-position-count=\"${positionCount}\"\n                data-current-value=\"${escapeAttribute(datasetCurrentValue)}\"\n                data-purchase-sum=\"${escapeAttribute(purchaseSum)}\"\n                data-gain-abs=\"${escapeAttribute(datasetGainAbs)}\"\n                data-gain-pct=\"${escapeAttribute(datasetGainPct)}\"\n                data-has-value=\"${hasValue ? 'true' : 'false'}\">`;\n    html += `<td>\n        <button type=\"button\"\n                class=\"${toggleClass}\"\n                data-portfolio=\"${d.uuid}\"\n                aria-expanded=\"${expanded ? 'true' : 'false'}\"\n                aria-controls=\"${detailId}\">\n          <span class=\"caret\">${expanded ? 'â–¼' : 'â–¶'}</span>\n          <span class=\"portfolio-name\">${d.name}</span>\n        </button>\n      </td>`;\n    html += `<td class=\"align-right\">${positionCount}</td>`;\n    html += `<td class=\"align-right\">${currentValueCell}</td>`;\n    html += `<td class=\"align-right\"${gainAbsAttributes}>${gainAbsCell}</td>`;\n    html += `<td class=\"align-right gain-pct-cell\">${gainPctCell}</td>`;\n    html += '</tr>';\n\n    html += `<tr class=\"portfolio-details${expanded ? '' : ' hidden'}\"\n                data-portfolio=\"${d.uuid}\"\n                id=\"${detailId}\"\n                role=\"region\"\n                aria-label=\"Positionen fÃ¼r ${d.name}\">\n      <td colspan=\"5\">\n        <div class=\"positions-container\">${expanded\n        ? (portfolioPositionsCache.has(d.uuid)\n          ? renderPositionsTable(portfolioPositionsCache.get(d.uuid))\n          : '<div class=\\\"loading\\\">Lade Positionen...</div>')\n        : ''\n      }</div>\n      </td>\n    </tr>`;\n  });\n\n  const availableDepots = depots.filter(d => d && d.hasValue !== false);\n  const sumPositions = depots.reduce((a, d) => a + (Number.isFinite(d?.position_count) ? d.position_count : 0), 0);\n  const sumCurrent = availableDepots.reduce((a, d) => a + (Number.isFinite(d.current_value) ? d.current_value : 0), 0);\n  const sumPurchase = availableDepots.reduce((a, d) => a + (Number.isFinite(d.purchase_sum) ? d.purchase_sum : 0), 0);\n  const sumGainAbs = availableDepots.reduce((a, d) => {\n    const current = Number.isFinite(d.current_value) ? d.current_value : 0;\n    const purchase = Number.isFinite(d.purchase_sum) ? d.purchase_sum : 0;\n    return a + (current - purchase);\n  }, 0);\n  const sumHasValue = availableDepots.length === depots.length;\n  const sumGainPct = sumHasValue && sumPurchase > 0 ? (sumGainAbs / sumPurchase) * 100 : null;\n\n  const sumRowData = {\n    fx_unavailable: !sumHasValue,\n    current_value: sumHasValue ? sumCurrent : null,\n    gain_abs: sumHasValue ? sumGainAbs : null,\n    gain_pct: sumHasValue ? sumGainPct : null\n  };\n  const sumContext = { hasValue: sumHasValue };\n  const sumCurrentCell = formatValue('current_value', sumRowData.current_value, sumRowData, sumContext);\n  const sumGainAbsCell = formatValue('gain_abs', sumRowData.gain_abs, sumRowData, sumContext);\n  const sumGainPctCell = formatValue('gain_pct', sumRowData.gain_pct, sumRowData, sumContext);\n\n  let sumGainAbsAttributes = '';\n  if (sumHasValue && Number.isFinite(sumGainPct)) {\n    const sumGainPctLabel = `${formatNumber(sumGainPct)} %`;\n    const sumGainPctSign = sumGainPct > 0 ? 'positive' : sumGainPct < 0 ? 'negative' : 'neutral';\n    sumGainAbsAttributes = ` data-gain-pct=\"${escapeAttribute(sumGainPctLabel)}\" data-gain-sign=\"${escapeAttribute(sumGainPctSign)}\"`;\n  }\n\n  html += `<tr class=\"footer-row\"\n    data-position-count=\"${sumPositions}\"\n    data-current-value=\"${escapeAttribute(sumHasValue ? sumCurrent : '')}\"\n    data-purchase-sum=\"${escapeAttribute(sumHasValue ? sumPurchase : '')}\"\n    data-gain-abs=\"${escapeAttribute(sumHasValue ? sumGainAbs : '')}\"\n    data-gain-pct=\"${escapeAttribute(sumHasValue && Number.isFinite(sumGainPct) ? sumGainPct : '')}\"\n    data-has-value=\"${sumHasValue ? 'true' : 'false'}\">\n    <td>Summe</td>\n    <td class=\"align-right\">${Math.round(sumPositions).toLocaleString('de-DE')}</td>\n    <td class=\"align-right\">${sumCurrentCell}</td>\n    <td class=\"align-right\"${sumGainAbsAttributes}>${sumGainAbsCell}</td>\n    <td class=\"align-right gain-pct-cell\">${sumGainPctCell}</td>\n  </tr>`;\n\n  html += '</tbody></table>';\n  return html;\n}\n\nfunction resolvePortfolioTable(target) {\n  if (target instanceof HTMLTableElement) {\n    return target;\n  }\n  if (target && typeof target.querySelector === 'function') {\n    return target.querySelector('table.expandable-portfolio-table') ||\n      target.querySelector('.portfolio-table table') ||\n      target.querySelector('table');\n  }\n  return document.querySelector('.portfolio-table table.expandable-portfolio-table') ||\n    document.querySelector('.portfolio-table table');\n}\n\nfunction readDatasetNumber(value) {\n  if (value === undefined) {\n    return null;\n  }\n  const num = Number(value);\n  return Number.isFinite(num) ? num : null;\n}\n\nfunction extractNumericFromCell(cell) {\n  if (!cell) {\n    return 0;\n  }\n  const raw = cell.textContent || '';\n  if (!raw) {\n    return 0;\n  }\n  const cleaned = raw\n    .replace(/[^0-9,.-]/g, '')\n    .replace(/\\./g, '')\n    .replace(',', '.');\n  const parsed = Number.parseFloat(cleaned);\n  return Number.isFinite(parsed) ? parsed : 0;\n}\n\nexport function updatePortfolioFooterFromDom(target) {\n  const table = resolvePortfolioTable(target);\n  if (!table) {\n    return;\n  }\n  const tbody = table.tBodies?.[0];\n  if (!tbody) {\n    return;\n  }\n  const rows = Array.from(tbody.querySelectorAll('tr.portfolio-row'));\n  if (!rows.length) {\n    return;\n  }\n\n  let sumPositions = 0;\n  let sumCurrent = 0;\n  let sumPurchase = 0;\n  let sumGainAbs = 0;\n  let missingRows = 0;\n\n  for (const row of rows) {\n    const hasValueAttr = row.dataset.hasValue;\n    const hasValue = !(hasValueAttr === 'false' || hasValueAttr === '0' || hasValueAttr === '' || hasValueAttr == null);\n    const posCount = readDatasetNumber(row.dataset.positionCount) ?? extractNumericFromCell(row.cells[1]);\n    sumPositions += posCount;\n\n    if (!hasValue) {\n      missingRows += 1;\n      continue;\n    }\n\n    const currentValue = readDatasetNumber(row.dataset.currentValue) ?? extractNumericFromCell(row.cells[2]);\n    const gainAbs = readDatasetNumber(row.dataset.gainAbs) ?? extractNumericFromCell(row.cells[3]);\n    const purchaseSumDataset = readDatasetNumber(row.dataset.purchaseSum);\n    const purchaseSum = purchaseSumDataset != null ? purchaseSumDataset : (currentValue - gainAbs);\n\n    sumCurrent += currentValue;\n    sumGainAbs += gainAbs;\n    sumPurchase += purchaseSum;\n  }\n\n  const sumHasValue = missingRows === 0;\n  if (!sumHasValue && sumPurchase > 0) {\n    sumPurchase = sumCurrent - sumGainAbs;\n  }\n  if (sumHasValue && sumPurchase <= 0) {\n    sumPurchase = sumCurrent - sumGainAbs;\n  }\n\n  const sumGainPct = sumHasValue && sumPurchase > 0 ? (sumGainAbs / sumPurchase) * 100 : null;\n\n  let footer = Array.from(tbody.children).find((child) =>\n    child instanceof HTMLTableRowElement && child.classList.contains('footer-row')\n  );\n  if (!footer) {\n    footer = document.createElement('tr');\n    footer.classList.add('footer-row');\n    tbody.appendChild(footer);\n  }\n\n  const sumPositionsDisplay = Math.round(sumPositions).toLocaleString('de-DE');\n\n  const renderMissingValue = (reason = 'Wert nicht verfÃ¼gbar') =>\n    `<span class=\"missing-value\" role=\"note\" aria-label=\"${reason}\" title=\"${reason}\">â€”</span>`;\n  const missingReason = 'Teilweise fehlende Wechselkurse â€“ Wert unbekannt';\n\n  const currentValueHtml = sumHasValue\n    ? `${formatNumber(sumCurrent)}&nbsp;â‚¬`\n    : renderMissingValue(missingReason);\n  const gainAbsHtml = sumHasValue\n    ? formatGain(sumGainAbs)\n    : renderMissingValue(missingReason);\n  const gainPctHtml = sumHasValue && sumGainPct != null\n    ? formatGainPct(sumGainPct)\n    : renderMissingValue(missingReason);\n\n  footer.innerHTML = `\n    <td>Summe</td>\n    <td class=\"align-right\">${sumPositionsDisplay}</td>\n    <td class=\"align-right\">${currentValueHtml}</td>\n    <td class=\"align-right\">${gainAbsHtml}</td>\n    <td class=\"align-right\">${gainPctHtml}</td>\n  `;\n  footer.dataset.positionCount = String(Math.round(sumPositions));\n  footer.dataset.currentValue = sumHasValue ? String(sumCurrent) : '';\n  footer.dataset.purchaseSum = sumHasValue ? String(sumPurchase) : '';\n  footer.dataset.gainAbs = sumHasValue ? String(sumGainAbs) : '';\n  footer.dataset.gainPct = sumHasValue && sumGainPct != null ? String(sumGainPct) : '';\n  footer.dataset.hasValue = sumHasValue ? 'true' : 'false';\n}\nwindow.__ppReaderUpdatePortfolioFooter = updatePortfolioFooterFromDom;\n\n/**\n * Utility-Funktionen zum Auslesen und Wiederherstellen des Expand-States.\n * Perspektivisch nutzbar, falls ein vollstÃ¤ndiger Neu-Render (Hard Refresh) der\n * Depot-Tabelle nÃ¶tig wird (z.B. beim spÃ¤teren HinzufÃ¼gen von Filter-/Sortierlogik).\n */\nexport function getExpandedPortfolios() {\n  // PrimÃ¤r DOM lesen (falls Tabelle gerendert), Fallback: interner Set\n  const domRows = Array.from(document.querySelectorAll('.portfolio-details:not(.hidden)[data-portfolio]'));\n  if (domRows.length) {\n    return domRows.map(r => r.getAttribute('data-portfolio')).filter(Boolean);\n  }\n  return Array.from(expandedPortfolios.values());\n}\n\nexport function setExpandedPortfolios(portfolioIds) {\n  expandedPortfolios.clear();\n  if (Array.isArray(portfolioIds)) {\n    portfolioIds.forEach(id => {\n      if (id) expandedPortfolios.add(id);\n    });\n  }\n}\n\n// NEU: Helper zum AnhÃ¤ngen der Sortier-Logik an eine Positions-Tabelle eines bestimmten Portfolios\nexport function attachPortfolioPositionsSorting(root, portfolioUuid) {\n  if (!root || !portfolioUuid) return;\n  const detailsRow = root.querySelector(`.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`);\n  if (!detailsRow) return;\n  const container = detailsRow.querySelector('.positions-container');\n  if (!container) return;\n  const table = container.querySelector('table.sortable-positions');\n  if (!table || table.__ppReaderSortingBound) return;\n\n  table.__ppReaderSortingBound = true;\n\n  const applySort = (key, dir) => {\n    const tbody = table.querySelector('tbody');\n    if (!tbody) return;\n    const rows = Array.from(tbody.querySelectorAll('tr'))\n      .filter(r => !r.classList.contains('footer-row'));\n    const footer = tbody.querySelector('tr.footer-row');\n\n    const parseNum = (txt) => {\n      if (txt == null) return 0;\n      // Entferne WÃ¤hrungs-/Prozent-Symbole, geschÃ¼tzte Leerzeichen\n      return parseFloat(\n        txt.replace(/\\u00A0/g, ' ')\n          .replace(/[%â‚¬]/g, '')\n          .replace(/\\./g, '')\n          .replace(',', '.')\n          .replace(/[^\\d.-]/g, '')\n      ) || 0;\n    };\n\n    rows.sort((a, b) => {\n      const idxMap = {\n        name: 0,\n        current_holdings: 1,\n        purchase_value: 2,\n        current_value: 3,\n        gain_abs: 4,\n        gain_pct: 5\n      };\n      const colIdx = idxMap[key];\n      if (colIdx == null) return 0;\n      const aCell = a.cells[colIdx]?.textContent.trim() || '';\n      const bCell = b.cells[colIdx]?.textContent.trim() || '';\n\n      let comp;\n      if (key === 'name') {\n        comp = aCell.localeCompare(bCell, 'de', { sensitivity: 'base' });\n      } else if (key === 'gain_pct') {\n        comp = parseNum(aCell) - parseNum(bCell);\n      } else {\n        comp = parseNum(aCell) - parseNum(bCell);\n      }\n      return dir === 'asc' ? comp : -comp;\n    });\n\n    // Visuelle Indikatoren zurÃ¼cksetzen\n    table.querySelectorAll('thead th.sort-active').forEach(th => {\n      th.classList.remove('sort-active', 'dir-asc', 'dir-desc');\n    });\n\n    // Aktives TH markieren\n    const th = table.querySelector(`thead th[data-sort-key=\"${key}\"]`);\n    if (th) {\n      th.classList.add('sort-active', dir === 'asc' ? 'dir-asc' : 'dir-desc');\n    }\n\n    // Neu einfÃ¼gen\n    rows.forEach(r => tbody.appendChild(r));\n    if (footer) tbody.appendChild(footer);\n  };\n\n  // Initial ggf. gespeicherten Zustand anwenden\n  const currentKey = container.dataset.sortKey || table.dataset.defaultSort || 'name';\n  const currentDir = container.dataset.sortDir || table.dataset.defaultDir || 'asc';\n  applySort(currentKey, currentDir);\n\n  table.addEventListener('click', (e) => {\n    const th = e.target.closest('th[data-sort-key]');\n    if (!th || !table.contains(th)) return;\n    const key = th.getAttribute('data-sort-key');\n    if (!key) return;\n\n    let dir = 'asc';\n    if (container.dataset.sortKey === key) {\n      dir = container.dataset.sortDir === 'asc' ? 'desc' : 'asc';\n    }\n    container.dataset.sortKey = key;\n    container.dataset.sortDir = dir;\n    applySort(key, dir);\n  });\n}\n\n// Exponiere zentrale Sortier-Funktion global fÃ¼r Push-Handler (Race-frei wiederverwendbar)\nif (!window.__ppReaderAttachPortfolioPositionsSorting) {\n  window.__ppReaderAttachPortfolioPositionsSorting = attachPortfolioPositionsSorting;\n}\n\n// NEU: Funktion zum erneuten Laden der Positionsdaten\nasync function reloadPortfolioPositions(portfolioUuid, containerEl, root) {\n  if (!portfolioUuid || !_hassRef || !_panelConfigRef) return;\n\n  const targetContainer = containerEl || root?.querySelector(\n    `.portfolio-details[data-portfolio=\"${portfolioUuid}\"] .positions-container`\n  );\n  if (!targetContainer) {\n    return;\n  }\n\n  const detailsRow = targetContainer.closest('.portfolio-details');\n  if (detailsRow && detailsRow.classList.contains('hidden')) {\n    return; // Hidden Rows sollen keinen Silent-Preload anstoÃŸen\n  }\n\n  targetContainer.innerHTML = '<div class=\"loading\">Neu laden...</div>';\n  try {\n    const resp = await fetchPortfolioPositionsWS(_hassRef, _panelConfigRef, portfolioUuid);\n    if (resp.error) {\n      targetContainer.innerHTML = `<div class=\"error\">${resp.error} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n      return;\n    }\n    const positions = resp.positions || [];\n    portfolioPositionsCache.set(portfolioUuid, positions);\n    targetContainer.innerHTML = renderPositionsTable(positions);\n    // Ã„nderung 11: Nach erstmaligem Lazy-Load Sortierung initialisieren\n    try {\n      attachPortfolioPositionsSorting(root, portfolioUuid);\n    } catch (e) {\n      console.warn(\"attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:\", e);\n    }\n    try {\n      attachSecurityDetailListener(root, portfolioUuid);\n    } catch (e) {\n      console.warn('reloadPortfolioPositions: Security-Listener konnte nicht gebunden werden:', e);\n    }\n  } catch (e) {\n    targetContainer.innerHTML = `<div class=\"error\">Fehler: ${e.message} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Retry</button></div>`;\n  }\n}\n\n// Hilfsfunktion: wartet bis ein Selektor im root existiert\nasync function waitForElement(root, selector, timeoutMs = 3000, intervalMs = 50) {\n  const start = performance.now();\n  return new Promise((resolve) => {\n    const tick = () => {\n      const el = root.querySelector(selector);\n      if (el) return resolve(el);\n      if (performance.now() - start > timeoutMs) return resolve(null);\n      setTimeout(tick, intervalMs);\n    };\n    tick();\n  });\n}\n\nexport function attachPortfolioToggleHandler(root) {\n  if (!root) return;\n\n  const token = (root.__ppReaderAttachToken ?? 0) + 1;\n  root.__ppReaderAttachToken = token;\n  root.__ppReaderAttachInProgress = true;\n\n  (async () => {\n    try {\n      const container = await waitForElement(root, '.portfolio-table');\n      if (token !== root.__ppReaderAttachToken) {\n        return; // Ein neuer Versuch lÃ¤uft bereits â€“ diesen abbrechen\n      }\n      if (!container) {\n        console.warn(\"attachPortfolioToggleHandler: .portfolio-table nicht gefunden (Timeout)\");\n        return;\n      }\n\n      // Buttons generiert?\n      const btnCount = container.querySelectorAll('.portfolio-toggle').length;\n      if (btnCount === 0) {\n        console.debug(\"attachPortfolioToggleHandler: Noch keine Buttons â€“ evtl. Recovery spÃ¤ter\");\n      }\n\n      if (container.__ppReaderPortfolioToggleBound) {\n        return;\n      }\n      container.__ppReaderPortfolioToggleBound = true;\n      console.debug(\"attachPortfolioToggleHandler: Listener registriert\");\n\n      container.addEventListener('click', async (e) => {\n      try {\n        const retryBtn = e.target.closest('.retry-pos');\n        if (retryBtn && container.contains(retryBtn)) {\n          const pid = retryBtn.getAttribute('data-portfolio');\n          const detailsRow = root.querySelector(`.portfolio-details[data-portfolio=\"${pid}\"]`);\n          const cont = detailsRow?.querySelector('.positions-container');\n          await reloadPortfolioPositions(pid, cont, root);\n          return;\n        }\n\n        const btn = e.target.closest('.portfolio-toggle');\n        if (!btn || !container.contains(btn)) return;\n\n        const portfolioUuid = btn.getAttribute('data-portfolio');\n        if (!portfolioUuid) return;\n\n        const detailsRow = root.querySelector(`.portfolio-details[data-portfolio=\"${portfolioUuid}\"]`);\n        if (!detailsRow) return;\n\n        const caretEl = btn.querySelector('.caret');\n        const isHidden = detailsRow.classList.contains('hidden');\n\n        if (isHidden) {\n          detailsRow.classList.remove('hidden');\n          btn.classList.add('expanded');\n          btn.setAttribute('aria-expanded', 'true');\n          if (caretEl) caretEl.textContent = 'â–¼';\n          expandedPortfolios.add(portfolioUuid);\n\n          let pendingApplied = false;\n          try {\n            pendingApplied = flushPendingPositions(root, portfolioUuid);\n          } catch (e) {\n            console.warn('attachPortfolioToggleHandler: Pending-Flush fehlgeschlagen:', e);\n          }\n          if (!pendingApplied && window.__ppReaderFlushPendingPositions) {\n            try {\n              pendingApplied = window.__ppReaderFlushPendingPositions(root, portfolioUuid);\n            } catch (e) {\n              console.warn('attachPortfolioToggleHandler: Global Pending-Flush fehlgeschlagen:', e);\n            }\n          }\n\n          if (!portfolioPositionsCache.has(portfolioUuid)) {\n            const containerEl = detailsRow.querySelector('.positions-container');\n            if (containerEl) containerEl.innerHTML = '<div class=\"loading\">Lade Positionen...</div>';\n            try {\n              const resp = await fetchPortfolioPositionsWS(_hassRef, _panelConfigRef, portfolioUuid);\n              if (resp.error) {\n                if (containerEl) {\n                  containerEl.innerHTML = `<div class=\"error\">${resp.error} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Erneut laden</button></div>`;\n                }\n                return;\n              }\n              const positions = (resp && resp.positions) || [];\n              portfolioPositionsCache.set(portfolioUuid, positions);\n              if (containerEl) {\n                containerEl.innerHTML = renderPositionsTable(positions);\n                // Ã„nderung 11: Nach erstmaligem Lazy-Load Sortierung initialisieren\n                try {\n                  attachPortfolioPositionsSorting(root, portfolioUuid);\n                } catch (e) {\n                  console.warn(\"attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:\", e);\n                }\n                try {\n                  attachSecurityDetailListener(root, portfolioUuid);\n                } catch (e) {\n                  console.warn('attachPortfolioToggleHandler: Security-Listener konnte nicht gebunden werden:', e);\n                }\n              }\n            } catch (err) {\n              const containerEl = detailsRow.querySelector('.positions-container');\n              if (containerEl) {\n                containerEl.innerHTML = `<div class=\"error\">Fehler beim Laden: ${err.message} <button class=\"retry-pos\" data-portfolio=\"${portfolioUuid}\">Retry</button></div>`;\n              }\n              console.error('Fehler beim Lazy Load fÃ¼r', portfolioUuid, err);\n            }\n          } else {\n            const containerEl = detailsRow.querySelector('.positions-container');\n            if (containerEl) {\n              containerEl.innerHTML = renderPositionsTable(portfolioPositionsCache.get(portfolioUuid));\n              attachPortfolioPositionsSorting(root, portfolioUuid);\n              try {\n                attachSecurityDetailListener(root, portfolioUuid);\n              } catch (e) {\n                console.warn('attachPortfolioToggleHandler: Security-Listener (Cache) Fehler:', e);\n              }\n            }\n          }\n        } else {\n          detailsRow.classList.add('hidden');\n          btn.classList.remove('expanded');\n          btn.setAttribute('aria-expanded', 'false');\n          if (caretEl) caretEl.textContent = 'â–¶';\n          expandedPortfolios.delete(portfolioUuid);\n        }\n      } catch (err) {\n        console.error(\"attachPortfolioToggleHandler: Ungefangener Fehler im Click-Handler\", err);\n      }\n      });\n    } finally {\n      if (token === root.__ppReaderAttachToken) {\n        root.__ppReaderAttachInProgress = false;\n      }\n    }\n  })();\n}\n\n// Fallback: direkter Listener auf die Tabelle selbst (falls outer container nicht klickt)\nexport function ensurePortfolioRowFallbackListener(root) {\n  const table = root.querySelector('.expandable-portfolio-table');\n  if (!table) return;\n  if (table.__ppReaderPortfolioFallbackBound) return;\n  table.__ppReaderPortfolioFallbackBound = true;\n  table.addEventListener('click', (e) => {\n    const btn = e.target.closest('.portfolio-toggle');\n    if (!btn) return;\n    // Falls der Haupt-Listener schon aktiv war, nichts doppelt machen\n    if (root.querySelector('.portfolio-table').__ppReaderPortfolioToggleBound) return;\n    console.debug(\"Fallback-Listener aktiv â€“ re-attach Hauptlistener\");\n    attachPortfolioToggleHandler(root);\n  });\n}\n\nexport async function renderDashboard(root, hass, panelConfig) {\n  _hassRef = hass;\n  _panelConfigRef = panelConfig;\n  console.debug(\"renderDashboard: start â€“ panelConfig:\", panelConfig?.config, \"derived entry_id?\", panelConfig?.config?._panel_custom?.config?.entry_id);\n\n  const accountsResp = await fetchAccountsWS(hass, panelConfig);\n  const accounts = (accountsResp && accountsResp.accounts) || [];\n\n  const portfoliosResp = await fetchPortfoliosWS(hass, panelConfig);\n  let depots = (portfoliosResp.portfolios || []).map(p => {\n    const missingPositions = typeof p.missing_value_positions === 'number'\n      ? p.missing_value_positions\n      : 0;\n    const hasCurrentValue = p.has_current_value != null\n      ? Boolean(p.has_current_value)\n      : missingPositions === 0;\n    const baseCurrentValue = typeof p.current_value === 'number' ? p.current_value : 0;\n    const purchase_sum = typeof p.purchase_sum === 'number' ? p.purchase_sum : 0;\n    const current_value = hasCurrentValue ? baseCurrentValue : null;\n    const gain_abs = hasCurrentValue ? baseCurrentValue - purchase_sum : null;\n    const gain_pct = hasCurrentValue && purchase_sum > 0 ? (gain_abs / purchase_sum) * 100 : null;\n    return {\n      uuid: p.uuid,\n      name: p.name,\n      position_count: typeof p.position_count === 'number' ? p.position_count : 0,\n      current_value,\n      purchase_sum,\n      gain_abs,\n      gain_pct,\n      hasValue: hasCurrentValue,\n      missing_value_positions: missingPositions,\n      fx_unavailable: !hasCurrentValue\n    };\n  });\n\n  // 3. Last file update (optional â€“ falls bereits WS-Command vorhanden)\n  let lastFileUpdate = '';\n  try {\n    lastFileUpdate = await fetchLastFileUpdateWS(hass, panelConfig);\n  } catch {\n    lastFileUpdate = '';\n  }\n\n  // 4. GesamtvermÃ¶gen berechnen (nur Anzeige)\n  const totalAccounts = accounts.reduce(\n    (sum, account) => sum + (Number.isFinite(account.balance) ? account.balance : 0),\n    0,\n  );\n  const anyPortfolioMissing = depots.some(depot => depot.hasValue === false);\n  const totalDepots = depots.reduce(\n    (sum, depot) => sum + ((depot.hasValue && Number.isFinite(depot.current_value)) ? depot.current_value : 0),\n    0,\n  );\n  const totalWealth = totalAccounts + totalDepots;\n  const missingWealthReason = 'Teilweise fehlende Wechselkurse â€“ GesamtvermÃ¶gen unbekannt';\n  const wealthValueMarkup = anyPortfolioMissing\n    ? `<span class=\"missing-value\" role=\"note\" aria-label=\"${missingWealthReason}\" title=\"${missingWealthReason}\">â€”</span>`\n    : `${formatNumber(totalWealth)}&nbsp;â‚¬`;\n  const wealthNote = anyPortfolioMissing\n    ? `<span class=\"total-wealth-note\">${missingWealthReason}</span>`\n    : '';\n\n  // 5. Header (ohne Last-File-Update â€“ kommt jetzt wieder in Footer-Karte)\n  const headerMeta = `\n    <div class=\"header-meta-row\">\n      ðŸ’° GesamtvermÃ¶gen: <strong class=\"total-wealth-value\">${wealthValueMarkup}</strong>${wealthNote}\n    </div>\n  `;\n  const headerCard = createHeaderCard('Ãœbersicht', headerMeta);\n\n  // 6. Sicherstellen, dass die Struktur exakt der erwartet wird:\n  //    - .portfolio-table (Wrapper)\n  //    - darin eine <table class=\"expandable-portfolio-table\"> mit <tr class=\"portfolio-row\" data-portfolio=\"UUID\">\n  const portfolioTableHtml = buildExpandablePortfolioTable(depots);\n\n  // 7. Konten-Tabellen\n  const eurAccounts = accounts.filter(a => (a.currency_code || 'EUR') === 'EUR');\n  const fxAccounts = accounts.filter(a => (a.currency_code || 'EUR') !== 'EUR');\n\n  const fxWarningNeeded = fxAccounts.some(a => a.fx_unavailable);\n  const fxWarning = fxWarningNeeded\n    ? `\n        <p class=\"table-note\" role=\"note\">\n          <span class=\"table-note__icon\" aria-hidden=\"true\">âš ï¸</span>\n          <span>Wechselkurse konnten nicht geladen werden. EUR-Werte werden derzeit nicht angezeigt.</span>\n        </p>\n      `\n    : '';\n\n  const accountsHtml = `\n    <div class=\"card\">\n      <h2>LiquiditÃ¤t</h2>\n      <div class=\"scroll-container account-table\">\n        ${makeTable(eurAccounts, [\n    { key: 'name', label: 'Name' },\n    { key: 'balance', label: 'Kontostand (EUR)', align: 'right' }\n  ], ['balance'])}\n      </div>\n    </div>\n    ${fxAccounts.length ? `\n      <div class=\"card\">\n        <h2>FremdwÃ¤hrungen</h2>\n        <div class=\"scroll-container fx-account-table\">\n          ${makeTable(\n    fxAccounts.map(a => ({\n      ...a,\n      fx_display: `${(a.orig_balance ?? 0).toLocaleString('de-DE', {\n        minimumFractionDigits: 2,\n        maximumFractionDigits: 2\n      })}&nbsp;${a.currency_code}`\n    })),\n    [\n      { key: 'name', label: 'Name' },\n      { key: 'fx_display', label: 'Betrag (FX)' },\n      { key: 'balance', label: 'EUR', align: 'right' }\n    ],\n    ['balance']\n  )}\n        </div>\n        ${fxWarning}\n      </div>` : ''}\n  `;\n\n  // 8. Footer-Karte mit letztem Datei-Ã„nderungszeitpunkt (reintroduziert)\n  const footerCard = `\n    <div class=\"card footer-card\">\n      <div class=\"meta\">\n        <div class=\"last-file-update\">\n          ðŸ“‚ Letzte Aktualisierung der Datei: <strong>${lastFileUpdate || 'Unbekannt'}</strong>\n        </div>\n      </div>\n    </div>\n  `;\n\n  const markup = `\n    ${headerCard.outerHTML}\n    <div class=\"card\">\n      <h2>Investment</h2>\n      <div class=\"scroll-container portfolio-table\">\n        ${portfolioTableHtml}\n      </div>\n    </div>\n    ${accountsHtml}\n    ${footerCard}\n  `;\n\n  schedulePostRenderSetup(root, depots);\n\n  return markup;\n}\n\nfunction schedulePostRenderSetup(root, depots) {\n  if (!root) {\n    return;\n  }\n\n  const run = () => {\n    try {\n      const wrapper = root;\n      const tableHost = wrapper.querySelector('.portfolio-table');\n      if (tableHost && tableHost.querySelectorAll('.portfolio-toggle').length === 0) {\n        console.debug('Recovery: Tabelle ohne Buttons â€“ erneuter Aufbau');\n        tableHost.innerHTML = buildExpandablePortfolioTable(depots);\n      }\n\n      attachPortfolioToggleHandler(root);\n      ensurePortfolioRowFallbackListener(root);\n\n      expandedPortfolios.forEach((pid) => {\n        try {\n          if (portfolioPositionsCache.has(pid)) {\n            attachPortfolioPositionsSorting(root, pid);\n            attachSecurityDetailListener(root, pid);\n          }\n        } catch (e) {\n          console.warn('Init-Sortierung fÃ¼r expandiertes Depot fehlgeschlagen:', pid, e);\n        }\n      });\n\n      try {\n        updatePortfolioFooterFromDom(wrapper);\n      } catch (footerErr) {\n        console.warn('renderDashboard: Footer-Summe konnte nicht aktualisiert werden:', footerErr);\n      }\n\n      try {\n        flushAllPendingPositions(root);\n      } catch (pendingErr) {\n        console.warn('renderDashboard: Pending-Positions konnten nicht angewendet werden:', pendingErr);\n      }\n\n      console.debug('renderDashboard: portfolio-toggle Buttons:', wrapper.querySelectorAll('.portfolio-toggle').length);\n    } catch (e) {\n      console.error('renderDashboard: Fehler bei Recovery/Listener', e);\n    }\n  };\n\n  const schedule = typeof requestAnimationFrame === 'function'\n    ? (cb) => requestAnimationFrame(cb)\n    : (cb) => setTimeout(cb, 0);\n\n  schedule(() => schedule(run));\n}\n","// @ts-nocheck\n\n/**\n * Chart preparation utilities preserved from the legacy dashboard.\n */\n\n/**\n * Lightweight SVG chart helpers for the PP Reader dashboard.\n *\n * Provides rendering logic for historical security price charts without\n * introducing external dependencies. The helpers expose a simple API with\n * `renderLineChart` for initial setup and `updateLineChart` to mutate an\n * existing chart instance.\n */\n\nconst SVG_NS = 'http://www.w3.org/2000/svg';\nconst DEFAULT_WIDTH = 640;\nconst DEFAULT_HEIGHT = 260;\nconst DEFAULT_MARGIN = { top: 12, right: 16, bottom: 24, left: 16 };\nconst DEFAULT_COLOR = 'var(--pp-reader-chart-line, #3f51b5)';\nconst DEFAULT_AREA = 'var(--pp-reader-chart-area, rgba(63, 81, 181, 0.12))';\nconst DEFAULT_TICK_FONT = '0.75rem';\nconst ONE_DAY_MS = 24 * 60 * 60 * 1000;\n\nfunction createSvgElement(tag, attrs = {}) {\n  const element = document.createElementNS(SVG_NS, tag);\n  Object.entries(attrs).forEach(([key, value]) => {\n    if (value == null) {\n      return;\n    }\n    element.setAttribute(key, String(value));\n  });\n  return element;\n}\n\nfunction toNumber(value, fallback = null) {\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n\n  if (typeof value === 'string' && value.trim() !== '') {\n    const parsed = Number.parseFloat(value);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return fallback;\n}\n\nfunction toTimestamp(value, index) {\n  if (value instanceof Date) {\n    const timestamp = value.getTime();\n    return Number.isFinite(timestamp) ? timestamp : index;\n  }\n\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    return value;\n  }\n\n  if (typeof value === 'string') {\n    const parsed = Date.parse(value);\n    if (Number.isFinite(parsed)) {\n      return parsed;\n    }\n  }\n\n  return index;\n}\n\nfunction defaultXFormatter(timestamp, dataPoint) {\n  if (Number.isFinite(timestamp)) {\n    const date = new Date(timestamp);\n    if (!Number.isNaN(date.getTime())) {\n      return date.toLocaleDateString('de-DE');\n    }\n  }\n\n  if (dataPoint?.date) {\n    return String(dataPoint.date);\n  }\n\n  if (timestamp == null) {\n    return '';\n  }\n\n  return String(timestamp);\n}\n\nfunction defaultYFormatter(value) {\n  const numeric = Number.isFinite(value) ? value : Number.parseFloat(value) || 0;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2,\n  });\n}\n\nfunction defaultTooltipRenderer({ xFormatted, yFormatted }) {\n  return `\n    <div class=\"chart-tooltip-date\">${xFormatted}</div>\n    <div class=\"chart-tooltip-value\">${yFormatted}&nbsp;â‚¬</div>\n  `;\n}\n\nfunction ensureChartState(container) {\n  if (!container.__chartState) {\n    container.__chartState = {};\n  }\n  return container.__chartState;\n}\n\nfunction clamp(value, min, max) {\n  if (!Number.isFinite(value)) {\n    return min;\n  }\n  if (value < min) {\n    return min;\n  }\n  if (value > max) {\n    return max;\n  }\n  return value;\n}\n\nfunction buildAreaPath(points, baselineY) {\n  if (!Array.isArray(points) || points.length === 0) {\n    return '';\n  }\n\n  const moveLine = points\n    .map((point, index) => {\n      const command = index === 0 ? 'M' : 'L';\n      return `${command}${point.x.toFixed(2)} ${point.y.toFixed(2)}`;\n    })\n    .join(' ');\n\n  const closing = `L${points[points.length - 1].x.toFixed(2)} ${baselineY.toFixed(\n    2,\n  )} L${points[0].x.toFixed(2)} ${baselineY.toFixed(2)} Z`;\n\n  return `${moveLine} ${closing}`;\n}\n\nfunction buildLinePath(points) {\n  if (!Array.isArray(points) || points.length === 0) {\n    return '';\n  }\n\n  return points\n    .map((point, index) => {\n      const command = index === 0 ? 'M' : 'L';\n      return `${command}${point.x.toFixed(2)} ${point.y.toFixed(2)}`;\n    })\n    .join(' ');\n}\n\nfunction computePoints(series, dimensions, accessors) {\n  const { width, height, margin } = dimensions;\n  const { xAccessor, yAccessor } = accessors;\n\n  if (!Array.isArray(series) || series.length === 0) {\n    return { points: [], range: null };\n  }\n\n  const rawPoints = series\n    .map((entry, index) => {\n      const rawX = xAccessor(entry, index);\n      const rawY = yAccessor(entry, index);\n      const xValue = toTimestamp(rawX, index);\n      const yValue = toNumber(rawY);\n      if (!Number.isFinite(yValue)) {\n        return null;\n      }\n      return {\n        index,\n        data: entry,\n        xValue,\n        yValue,\n      };\n    })\n    .filter(Boolean);\n\n  if (rawPoints.length === 0) {\n    return { points: [], range: null };\n  }\n\n  const minX = rawPoints.reduce((min, point) => Math.min(min, point.xValue), rawPoints[0].xValue);\n  const maxX = rawPoints.reduce((max, point) => Math.max(max, point.xValue), rawPoints[0].xValue);\n  const minY = rawPoints.reduce((min, point) => Math.min(min, point.yValue), rawPoints[0].yValue);\n  const maxY = rawPoints.reduce((max, point) => Math.max(max, point.yValue), rawPoints[0].yValue);\n\n  const boundedWidth = Math.max(width - margin.left - margin.right, 1);\n  const boundedHeight = Math.max(height - margin.top - margin.bottom, 1);\n\n  const safeMinX = Number.isFinite(minX) ? minX : 0;\n  const safeMaxX = Number.isFinite(maxX) ? maxX : safeMinX + 1;\n  const safeMinY = Number.isFinite(minY) ? minY : 0;\n  const safeMaxY = Number.isFinite(maxY) ? maxY : safeMinY + 1;\n\n  const desiredYTicks = Math.max(\n    2,\n    Math.min(\n      6,\n      Math.round(\n        Math.max(height - margin.top - margin.bottom, 0) / 60,\n      ) || 4,\n    ),\n  );\n  const { niceMin: domainMinY, niceMax: domainMaxY } = computeNiceDomain(\n    safeMinY,\n    safeMaxY,\n    desiredYTicks,\n  );\n\n  const effectiveMinY = Number.isFinite(domainMinY) ? domainMinY : safeMinY;\n  const effectiveMaxY = Number.isFinite(domainMaxY) ? domainMaxY : safeMaxY;\n\n  const rangeX = safeMaxX - safeMinX || 1;\n  const rangeY = effectiveMaxY - effectiveMinY || 1;\n\n  const points = rawPoints.map((point) => {\n    const ratioX = rangeX === 0 ? 0.5 : (point.xValue - safeMinX) / rangeX;\n    const ratioY = rangeY === 0 ? 0.5 : (point.yValue - effectiveMinY) / rangeY;\n    const x = margin.left + ratioX * boundedWidth;\n    const y = margin.top + (1 - ratioY) * boundedHeight;\n    return {\n      ...point,\n      x,\n      y,\n    };\n  });\n\n  return {\n    points,\n    range: {\n      minX: safeMinX,\n      maxX: safeMaxX,\n      minY: effectiveMinY,\n      maxY: effectiveMaxY,\n      boundedWidth,\n      boundedHeight,\n    },\n  };\n}\n\nfunction assignDimensions(state, width, height, margin) {\n  state.width = Number.isFinite(width) ? width : DEFAULT_WIDTH;\n  state.height = Number.isFinite(height) ? height : DEFAULT_HEIGHT;\n  state.margin = {\n    top: Number.isFinite(margin?.top) ? margin.top : DEFAULT_MARGIN.top,\n    right: Number.isFinite(margin?.right) ? margin.right : DEFAULT_MARGIN.right,\n    bottom: Number.isFinite(margin?.bottom) ? margin.bottom : DEFAULT_MARGIN.bottom,\n    left: Number.isFinite(margin?.left) ? margin.left : DEFAULT_MARGIN.left,\n  };\n}\n\nfunction formatTooltip(state, point) {\n  const xFormatted = state.xFormatter(point.xValue, point.data, point.index);\n  const yFormatted = state.yFormatter(point.yValue, point.data, point.index);\n  return state.tooltipRenderer({\n    point,\n    xFormatted,\n    yFormatted,\n    data: point.data,\n    index: point.index,\n  });\n}\n\nfunction updateTooltipPosition(state, point, pointerY) {\n  const { tooltip, width, margin } = state;\n  if (!tooltip) {\n    return;\n  }\n\n  const baselineY = state.height - margin.bottom;\n  tooltip.style.visibility = 'visible';\n  tooltip.style.opacity = '1';\n  const tooltipWidth = tooltip.offsetWidth || 0;\n  const tooltipHeight = tooltip.offsetHeight || 0;\n  const horizontal = clamp(point.x - tooltipWidth / 2, margin.left, width - margin.right - tooltipWidth);\n  const maxVertical = Math.max(baselineY - tooltipHeight, 0);\n  const padding = 12;\n  const anchorY = Number.isFinite(pointerY)\n    ? clamp(pointerY, margin.top, baselineY)\n    : point.y;\n  let vertical = anchorY + padding;\n  if (vertical > maxVertical) {\n    vertical = anchorY - tooltipHeight - padding;\n  }\n  vertical = clamp(vertical, 0, maxVertical);\n  tooltip.style.transform = `translate(${Math.round(horizontal)}px, ${Math.round(vertical)}px)`;\n}\n\nfunction hideTooltip(state) {\n  const { tooltip, focusLine, focusCircle } = state;\n  if (tooltip) {\n    tooltip.style.opacity = '0';\n    tooltip.style.visibility = 'hidden';\n  }\n  if (focusLine) {\n    focusLine.style.opacity = '0';\n  }\n  if (focusCircle) {\n    focusCircle.style.opacity = '0';\n  }\n}\n\nfunction attachPointerHandlers(container, state) {\n  if (state.handlersAttached) {\n    return;\n  }\n\n  const handlePointerMove = (event) => {\n    if (!state.points || state.points.length === 0) {\n      hideTooltip(state);\n      return;\n    }\n\n    const rect = state.svg.getBoundingClientRect();\n    const pointerX = event.clientX - rect.left;\n    const pointerY = event.clientY - rect.top;\n    let closest = state.points[0];\n    let minDistance = Math.abs(pointerX - closest.x);\n\n    for (let idx = 1; idx < state.points.length; idx += 1) {\n      const candidate = state.points[idx];\n      const distance = Math.abs(pointerX - candidate.x);\n      if (distance < minDistance) {\n        minDistance = distance;\n        closest = candidate;\n      }\n    }\n\n    if (!closest) {\n      hideTooltip(state);\n      return;\n    }\n\n    if (state.focusCircle) {\n      state.focusCircle.setAttribute('cx', closest.x.toFixed(2));\n      state.focusCircle.setAttribute('cy', closest.y.toFixed(2));\n      state.focusCircle.style.opacity = '1';\n    }\n\n    if (state.focusLine) {\n      state.focusLine.setAttribute('x1', closest.x.toFixed(2));\n      state.focusLine.setAttribute('x2', closest.x.toFixed(2));\n      state.focusLine.setAttribute('y1', state.margin.top.toFixed(2));\n      state.focusLine.setAttribute(\n        'y2',\n        (state.height - state.margin.bottom).toFixed(2),\n      );\n      state.focusLine.style.opacity = '1';\n    }\n\n    if (state.tooltip) {\n      state.tooltip.innerHTML = formatTooltip(state, closest);\n      updateTooltipPosition(state, closest, pointerY);\n    }\n  };\n\n  const handlePointerLeave = () => {\n    hideTooltip(state);\n  };\n\n  state.overlay.addEventListener('pointermove', handlePointerMove);\n  state.overlay.addEventListener('pointerenter', handlePointerMove);\n  state.overlay.addEventListener('pointerleave', handlePointerLeave);\n\n  state.handlersAttached = true;\n  state.handlePointerMove = handlePointerMove;\n  state.handlePointerLeave = handlePointerLeave;\n}\n\nexport function renderLineChart(root, options = {}) {\n  if (!root) {\n    console.error('renderLineChart: root element is required');\n    return null;\n  }\n\n  const container = document.createElement('div');\n  container.className = 'line-chart-container';\n  container.dataset.chartType = 'line';\n  container.style.position = 'relative';\n\n  const svg = createSvgElement('svg', {\n    width: DEFAULT_WIDTH,\n    height: DEFAULT_HEIGHT,\n    viewBox: `0 0 ${DEFAULT_WIDTH} ${DEFAULT_HEIGHT}`,\n    role: 'img',\n    'aria-hidden': 'true',\n    focusable: 'false',\n  });\n  svg.classList.add('line-chart-svg');\n\n  const areaPath = createSvgElement('path', {\n    class: 'line-chart-area',\n    fill: DEFAULT_AREA,\n    stroke: 'none',\n  });\n\n  const linePath = createSvgElement('path', {\n    class: 'line-chart-path',\n    fill: 'none',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 2,\n    'stroke-linecap': 'round',\n    'stroke-linejoin': 'round',\n  });\n\n  const focusLine = createSvgElement('line', {\n    class: 'line-chart-focus-line',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 1,\n    'stroke-dasharray': '4 4',\n    opacity: 0,\n  });\n\n  const focusCircle = createSvgElement('circle', {\n    class: 'line-chart-focus-circle',\n    r: 4,\n    fill: '#fff',\n    stroke: DEFAULT_COLOR,\n    'stroke-width': 2,\n    opacity: 0,\n  });\n\n  const overlay = createSvgElement('rect', {\n    class: 'line-chart-overlay',\n    fill: 'transparent',\n    x: 0,\n    y: 0,\n    width: DEFAULT_WIDTH,\n    height: DEFAULT_HEIGHT,\n  });\n\n  svg.appendChild(areaPath);\n  svg.appendChild(linePath);\n  svg.appendChild(focusLine);\n  svg.appendChild(focusCircle);\n  svg.appendChild(overlay);\n\n  container.appendChild(svg);\n\n  const tooltip = document.createElement('div');\n  tooltip.className = 'chart-tooltip';\n  tooltip.style.position = 'absolute';\n  tooltip.style.top = '0';\n  tooltip.style.left = '0';\n  tooltip.style.pointerEvents = 'none';\n  tooltip.style.opacity = '0';\n  tooltip.style.visibility = 'hidden';\n  container.appendChild(tooltip);\n\n  root.appendChild(container);\n\n  const state = ensureChartState(container);\n  state.svg = svg;\n  state.areaPath = areaPath;\n  state.linePath = linePath;\n  state.focusLine = focusLine;\n  state.focusCircle = focusCircle;\n  state.overlay = overlay;\n  state.tooltip = tooltip;\n  state.xAccessor = options.xAccessor || ((entry) => entry?.date);\n  state.yAccessor = options.yAccessor || ((entry) => entry?.close);\n  state.xFormatter = options.xFormatter || defaultXFormatter;\n  state.yFormatter = options.yFormatter || defaultYFormatter;\n  state.tooltipRenderer = options.tooltipRenderer || defaultTooltipRenderer;\n  state.color = options.color || DEFAULT_COLOR;\n  state.areaColor = options.areaColor || DEFAULT_AREA;\n  state.handlersAttached = false;\n\n  if (!state.xAxis) {\n    const xAxis = document.createElement('div');\n    xAxis.className = 'line-chart-axis line-chart-axis-x';\n    xAxis.style.position = 'absolute';\n    xAxis.style.left = '0';\n    xAxis.style.right = '0';\n    xAxis.style.bottom = '0';\n    xAxis.style.pointerEvents = 'none';\n    xAxis.style.fontSize = DEFAULT_TICK_FONT;\n    xAxis.style.color = 'var(--secondary-text-color)';\n    xAxis.style.display = 'block';\n    container.appendChild(xAxis);\n    state.xAxis = xAxis;\n  }\n\n  if (!state.yAxis) {\n    const yAxis = document.createElement('div');\n    yAxis.className = 'line-chart-axis line-chart-axis-y';\n    yAxis.style.position = 'absolute';\n    yAxis.style.top = '0';\n    yAxis.style.bottom = '0';\n    yAxis.style.left = '0';\n    yAxis.style.pointerEvents = 'none';\n    yAxis.style.fontSize = DEFAULT_TICK_FONT;\n    yAxis.style.color = 'var(--secondary-text-color)';\n    yAxis.style.display = 'block';\n    container.appendChild(yAxis);\n    state.yAxis = yAxis;\n  }\n\n  assignDimensions(state, options.width, options.height, options.margin);\n\n  linePath.setAttribute('stroke', state.color);\n  focusLine.setAttribute('stroke', state.color);\n  focusCircle.setAttribute('stroke', state.color);\n  areaPath.setAttribute('fill', state.areaColor);\n\n  updateLineChart(container, options);\n  attachPointerHandlers(container, state);\n\n  return container;\n}\n\nexport function updateLineChart(container, options = {}) {\n  if (!container) {\n    console.error('updateLineChart: container element is required');\n    return;\n  }\n\n  const state = ensureChartState(container);\n  if (!state.svg || !state.linePath || !state.overlay) {\n    console.error('updateLineChart: chart was not initialised with renderLineChart');\n    return;\n  }\n\n  if (options.xAccessor) {\n    state.xAccessor = options.xAccessor;\n  }\n  if (options.yAccessor) {\n    state.yAccessor = options.yAccessor;\n  }\n  if (options.xFormatter) {\n    state.xFormatter = options.xFormatter;\n  }\n  if (options.yFormatter) {\n    state.yFormatter = options.yFormatter;\n  }\n  if (options.tooltipRenderer) {\n    state.tooltipRenderer = options.tooltipRenderer;\n  }\n  if (options.color) {\n    state.color = options.color;\n    state.linePath.setAttribute('stroke', state.color);\n    state.focusLine.setAttribute('stroke', state.color);\n    state.focusCircle.setAttribute('stroke', state.color);\n  }\n  if (options.areaColor) {\n    state.areaColor = options.areaColor;\n    if (state.areaPath) {\n      state.areaPath.setAttribute('fill', state.areaColor);\n    }\n  }\n\n  assignDimensions(state, options.width, options.height, options.margin);\n\n  const { width, height, margin } = state;\n  state.svg.setAttribute('width', width);\n  state.svg.setAttribute('height', height);\n  state.svg.setAttribute('viewBox', `0 0 ${width} ${height}`);\n\n  state.overlay.setAttribute('x', margin.left.toFixed(2));\n  state.overlay.setAttribute('y', margin.top.toFixed(2));\n  state.overlay.setAttribute(\n    'width',\n    Math.max(width - margin.left - margin.right, 0).toFixed(2),\n  );\n  state.overlay.setAttribute(\n    'height',\n    Math.max(height - margin.top - margin.bottom, 0).toFixed(2),\n  );\n\n  const series = Array.isArray(options.series) ? options.series : state.series;\n  state.series = series || [];\n\n  const { points, range } = computePoints(state.series, state, {\n    xAccessor: state.xAccessor,\n    yAccessor: state.yAccessor,\n  });\n  state.points = points;\n  state.range = range;\n\n  if (!points || points.length === 0) {\n    state.linePath.setAttribute('d', '');\n    if (state.areaPath) {\n      state.areaPath.setAttribute('d', '');\n    }\n    hideTooltip(state);\n    updateAxes(state);\n    return;\n  }\n\n  const lineD = buildLinePath(points);\n  state.linePath.setAttribute('d', lineD);\n\n  if (state.areaPath && range) {\n    const baselineY = state.margin.top + range.boundedHeight;\n    const areaD = buildAreaPath(points, baselineY);\n    state.areaPath.setAttribute('d', areaD);\n  }\n\n  updateAxes(state);\n}\n\nfunction updateAxes(state) {\n  const { xAxis, yAxis, range, margin, width, height, yFormatter } = state;\n  if (!xAxis || !yAxis) {\n    return;\n  }\n\n  if (!range) {\n    xAxis.innerHTML = '';\n    yAxis.innerHTML = '';\n    return;\n  }\n\n  const { minX, maxX, minY, maxY, boundedWidth, boundedHeight } = range;\n\n  const hasValidX = Number.isFinite(minX) && Number.isFinite(maxX) && maxX >= minX;\n  const hasValidY = Number.isFinite(minY) && Number.isFinite(maxY) && maxY >= minY;\n\n  const effectiveWidth = Math.max(boundedWidth, 0);\n  const effectiveHeight = Math.max(boundedHeight, 0);\n\n  xAxis.style.left = `${margin.left}px`;\n  xAxis.style.width = `${effectiveWidth}px`;\n  xAxis.style.top = `${height - margin.bottom + 6}px`;\n  xAxis.innerHTML = '';\n\n  if (hasValidX && effectiveWidth > 0) {\n    const rangeDays = (maxX - minX) / ONE_DAY_MS;\n    const desiredTicks = Math.max(2, Math.min(6, Math.round(effectiveWidth / 140) || 4));\n    const xTicks = generateTimeAxisTicks(state, minX, maxX, desiredTicks, rangeDays);\n    xTicks.forEach(({ positionRatio, label }) => {\n      const tick = document.createElement('div');\n      tick.className = 'line-chart-axis-tick line-chart-axis-tick-x';\n      tick.style.position = 'absolute';\n      tick.style.bottom = '0';\n      tick.style.transform = 'translateX(-50%)';\n      const ratio = clamp(positionRatio, 0, 1);\n      tick.style.left = `${ratio * effectiveWidth}px`;\n      tick.textContent = label;\n      xAxis.appendChild(tick);\n    });\n  }\n\n  yAxis.style.top = `${margin.top}px`;\n  yAxis.style.height = `${effectiveHeight}px`;\n  const yAxisWidth = Math.max(margin.left - 6, 0);\n  yAxis.style.left = '0';\n  yAxis.style.width = `${Math.max(yAxisWidth, 0)}px`;\n  yAxis.innerHTML = '';\n\n  if (hasValidY && effectiveHeight > 0) {\n    const desiredTicks = Math.max(2, Math.min(6, Math.round(effectiveHeight / 60) || 4));\n    const yTicks = generateNumericAxisTicks(minY, maxY, desiredTicks);\n    yTicks.forEach(({ value, positionRatio }) => {\n      const tick = document.createElement('div');\n      tick.className = 'line-chart-axis-tick line-chart-axis-tick-y';\n      tick.style.position = 'absolute';\n      tick.style.left = '0';\n      const clampedRatio = clamp(positionRatio, 0, 1);\n      const top = (1 - clampedRatio) * effectiveHeight;\n      tick.style.top = `${top}px`;\n      tick.textContent = yFormatter ? yFormatter(value) : defaultYFormatter(value);\n      yAxis.appendChild(tick);\n    });\n  }\n}\n\nfunction computeNiceDomain(minValue, maxValue, desiredTicks = 4) {\n  if (!Number.isFinite(minValue) || !Number.isFinite(maxValue)) {\n    return {\n      niceMin: minValue,\n      niceMax: maxValue,\n    };\n  }\n\n  const safeTicks = Math.max(2, desiredTicks);\n\n  if (maxValue === minValue) {\n    const padding = niceStep(Math.abs(minValue) || 1);\n    return {\n      niceMin: minValue - padding,\n      niceMax: maxValue + padding,\n    };\n  }\n\n  const range = maxValue - minValue;\n  const rawStep = range / (safeTicks - 1);\n  const step = niceStep(rawStep);\n  const niceMin = Math.floor(minValue / step) * step;\n  const niceMax = Math.ceil(maxValue / step) * step;\n\n  if (niceMin === niceMax) {\n    return {\n      niceMin: minValue,\n      niceMax: maxValue + step,\n    };\n  }\n\n  return {\n    niceMin,\n    niceMax,\n  };\n}\n\nfunction generateTimeAxisTicks(state, minTimestamp, maxTimestamp, desiredTicks, rangeDays) {\n  if (!Number.isFinite(minTimestamp) || !Number.isFinite(maxTimestamp) || maxTimestamp < minTimestamp) {\n    return [];\n  }\n\n  if (!Number.isFinite(rangeDays) || rangeDays <= 0) {\n    const label = formatXAxisLabel(state, minTimestamp, rangeDays || 0);\n    return [\n      {\n        positionRatio: 0.5,\n        label,\n      },\n    ];\n  }\n\n  const tickCount = Math.max(2, desiredTicks);\n  const ticks = [];\n  const range = maxTimestamp - minTimestamp;\n  for (let index = 0; index < tickCount; index += 1) {\n    const ratio = tickCount === 1 ? 0.5 : index / (tickCount - 1);\n    const value = minTimestamp + ratio * range;\n    ticks.push({\n      positionRatio: ratio,\n      label: formatXAxisLabel(state, value, rangeDays),\n    });\n  }\n  return ticks;\n}\n\nfunction formatXAxisLabel(state, timestamp, rangeDays) {\n  const date = new Date(timestamp);\n  if (Number.isFinite(date.getTime())) {\n    if (rangeDays > 1095) {\n      return String(date.getFullYear());\n    }\n    if (rangeDays > 365) {\n      return date.toLocaleDateString('de-DE', {\n        year: 'numeric',\n        month: 'short',\n      });\n    }\n    if (rangeDays > 90) {\n      return date.toLocaleDateString('de-DE', {\n        year: '2-digit',\n        month: 'short',\n      });\n    }\n    if (rangeDays > 30) {\n      return date.toLocaleDateString('de-DE', {\n        day: '2-digit',\n        month: 'short',\n      });\n    }\n    return date.toLocaleDateString('de-DE', {\n      day: '2-digit',\n      month: '2-digit',\n    });\n  }\n\n  return state.xFormatter ? state.xFormatter(timestamp, null, -1) : String(timestamp);\n}\n\nfunction generateNumericAxisTicks(minValue, maxValue, desiredTicks) {\n  if (!Number.isFinite(minValue) || !Number.isFinite(maxValue)) {\n    return [];\n  }\n\n  if (maxValue === minValue) {\n    return [\n      {\n        value: minValue,\n        positionRatio: 0.5,\n      },\n    ];\n  }\n\n  const range = maxValue - minValue;\n  const tickCount = Math.max(2, desiredTicks);\n  const rawStep = range / (tickCount - 1);\n  const step = niceStep(rawStep);\n  const start = Math.floor(minValue / step) * step;\n  const end = Math.ceil(maxValue / step) * step;\n\n  const ticks = [];\n  for (let value = start; value <= end + step / 2; value += step) {\n    const ratio = (value - minValue) / (maxValue - minValue);\n    ticks.push({\n      value,\n      positionRatio: clamp(ratio, 0, 1),\n    });\n  }\n\n  if (ticks.length > tickCount + 2) {\n    return ticks.filter((_, index) => index % 2 === 0);\n  }\n\n  return ticks;\n}\n\nfunction niceStep(value) {\n  if (!Number.isFinite(value) || value === 0) {\n    return 1;\n  }\n\n  const exponent = Math.floor(Math.log10(Math.abs(value)));\n  const fraction = Math.abs(value) / 10 ** exponent;\n  let niceFraction;\n  if (fraction <= 1) {\n    niceFraction = 1;\n  } else if (fraction <= 2) {\n    niceFraction = 2;\n  } else if (fraction <= 5) {\n    niceFraction = 5;\n  } else {\n    niceFraction = 10;\n  }\n  return niceFraction * 10 ** exponent;\n}\n","// @ts-nocheck\n\n/**\n * Security detail tab renderer migrated verbatim for TypeScript.\n */\n\n/**\n * Security detail tab renderer and registration.\n *\n * Provides the render function used by dynamic security tabs and\n * exposes a helper to register the descriptor factory with the\n * dashboard controller.\n */\nimport { createHeaderCard, formatNumber, formatGain } from '../content/elements';\nimport { renderLineChart, updateLineChart } from '../content/charting';\nimport { fetchSecuritySnapshotWS, fetchSecurityHistoryWS } from '../data/api';\n\nconst HOLDINGS_FRACTION_DIGITS = { min: 0, max: 6 };\nconst PRICE_FRACTION_DIGITS = { min: 2, max: 4 };\nconst PRICE_SCALE = 1e8;\nconst DEFAULT_HISTORY_RANGE = '1Y';\nconst AVAILABLE_HISTORY_RANGES = ['1M', '6M', '1Y', '5Y'];\nconst RANGE_DAY_COUNTS = {\n  '1M': 30,\n  '6M': 182,\n  '1Y': 365,\n  '5Y': 1826,\n};\n\nconst SECURITY_HISTORY_CACHE = new Map(); // securityUuid -> Map(rangeKey -> series[])\nconst RANGE_STATE_REGISTRY = new Map(); // securityUuid -> { activeRange }\nconst LIVE_UPDATE_EVENT = 'pp-reader:portfolio-positions-updated';\nconst LIVE_UPDATE_HANDLERS = new Map(); // securityUuid -> handler\n\nfunction buildCachedSnapshotNotice({ fallbackUsed, flaggedAsCache }) {\n  const reasons = [];\n  if (fallbackUsed) {\n    reasons.push(\n      'Der aktuelle Snapshot konnte nicht geladen werden. Es werden die zuletzt gespeicherten Werte angezeigt.',\n    );\n  }\n  if (flaggedAsCache && !fallbackUsed) {\n    reasons.push(\n      'Der Snapshot ist vom Datenanbieter als Zwischenspeicherstand markiert.',\n    );\n  }\n\n  const reasonText = reasons.length\n    ? reasons.join(' ')\n    : 'Die Daten stammen aus dem Zwischenspeicher.';\n\n  return `\n    <div class=\"card warning-card stale-notice\" role=\"status\" aria-live=\"polite\">\n      <h2>Zwischengespeicherte Werte</h2>\n      <p>${reasonText}</p>\n      <p class=\"stale-notice__hint\">Die angezeigten BetrÃ¤ge kÃ¶nnen von den aktuellen Marktwerten abweichen. Laden Sie die Ansicht erneut, sobald eine Verbindung verfÃ¼gbar ist.</p>\n    </div>\n  `;\n}\n\nfunction getCachedSecuritySnapshot(securityUuid) {\n  if (!securityUuid || typeof window === 'undefined') {\n    return null;\n  }\n\n  try {\n    const getter = window.__ppReaderGetSecuritySnapshotFromCache;\n    if (typeof getter === 'function') {\n      const snapshot = getter(securityUuid);\n      return snapshot && typeof snapshot === 'object' ? snapshot : null;\n    }\n  } catch (error) {\n    console.warn('getCachedSecuritySnapshot: Zugriff auf Cache fehlgeschlagen', error);\n  }\n\n  return null;\n}\n\nfunction ensureHistoryCache(securityUuid) {\n  if (!SECURITY_HISTORY_CACHE.has(securityUuid)) {\n    SECURITY_HISTORY_CACHE.set(securityUuid, new Map());\n  }\n  return SECURITY_HISTORY_CACHE.get(securityUuid);\n}\n\nfunction invalidateHistoryCache(securityUuid) {\n  if (!securityUuid) {\n    return;\n  }\n\n  if (SECURITY_HISTORY_CACHE.has(securityUuid)) {\n    try {\n      const cache = SECURITY_HISTORY_CACHE.get(securityUuid);\n      if (cache && typeof cache.clear === 'function') {\n        cache.clear();\n      }\n    } catch (error) {\n      console.warn('invalidateHistoryCache: Konnte Cache nicht leeren', securityUuid, error);\n    }\n    SECURITY_HISTORY_CACHE.delete(securityUuid);\n  }\n}\n\nfunction handleLiveUpdateForSecurity(securityUuid, detail) {\n  if (!securityUuid || !detail) {\n    return;\n  }\n\n  const payload = detail.securityUuids;\n  const candidates = Array.isArray(payload) ? payload : [];\n\n  if (candidates.includes(securityUuid)) {\n    invalidateHistoryCache(securityUuid);\n  }\n}\n\nfunction ensureLiveUpdateSubscription(securityUuid) {\n  if (!securityUuid || LIVE_UPDATE_HANDLERS.has(securityUuid)) {\n    return;\n  }\n\n  const handler = (event) => {\n    if (!event || !event.detail) {\n      return;\n    }\n    handleLiveUpdateForSecurity(securityUuid, event.detail);\n  };\n\n  try {\n    window.addEventListener(LIVE_UPDATE_EVENT, handler);\n    LIVE_UPDATE_HANDLERS.set(securityUuid, handler);\n  } catch (error) {\n    console.error('ensureLiveUpdateSubscription: Registrierung fehlgeschlagen', error);\n  }\n}\n\nfunction removeLiveUpdateSubscription(securityUuid) {\n  if (!securityUuid || !LIVE_UPDATE_HANDLERS.has(securityUuid)) {\n    return;\n  }\n\n  const handler = LIVE_UPDATE_HANDLERS.get(securityUuid);\n  try {\n    window.removeEventListener(LIVE_UPDATE_EVENT, handler);\n  } catch (error) {\n    console.error('removeLiveUpdateSubscription: Entfernen des Listeners fehlgeschlagen', error);\n  }\n\n  LIVE_UPDATE_HANDLERS.delete(securityUuid);\n}\n\nfunction cleanupSecurityDetailState(securityUuid) {\n  if (!securityUuid) {\n    return;\n  }\n\n  removeLiveUpdateSubscription(securityUuid);\n  invalidateHistoryCache(securityUuid);\n  // RANGE_STATE_REGISTRY intentionally left intact so the last chosen\n  // range remains active when the user reopens the security detail.\n}\n\nfunction setActiveRange(securityUuid, rangeKey) {\n  if (!RANGE_STATE_REGISTRY.has(securityUuid)) {\n    RANGE_STATE_REGISTRY.set(securityUuid, { activeRange: rangeKey });\n    return;\n  }\n  const state = RANGE_STATE_REGISTRY.get(securityUuid);\n  state.activeRange = rangeKey;\n}\n\nfunction getActiveRange(securityUuid) {\n  return RANGE_STATE_REGISTRY.get(securityUuid)?.activeRange || DEFAULT_HISTORY_RANGE;\n}\n\nfunction toEpochDay(date) {\n  // Portfolio Performance liefert Datumswerte als epoch day (Tage seit 1970-01-01).\n  // Vorher wurde ein \"YYYYMMDD\" Format verwendet, wodurch alle Filter leer liefen\n  // und die Historie im Frontend dauerhaft als leer angezeigt wurde. Mit der\n  // Umstellung auf eine echte Epoch-Day-Berechnung sprechen Frontend und Backend\n  // wieder dieselbe Sprache und historische Kurse werden korrekt geladen.\n  const epochMs = Date.UTC(\n    date.getUTCFullYear(),\n    date.getUTCMonth(),\n    date.getUTCDate(),\n  );\n  return Math.floor(epochMs / 86400000);\n}\n\nfunction normaliseDate(date) {\n  const clone = new Date(date.getTime());\n  clone.setUTCHours(0, 0, 0, 0);\n  return clone;\n}\n\nfunction resolveRangeOptions(rangeKey) {\n  const now = normaliseDate(new Date());\n  const rangeDays = RANGE_DAY_COUNTS[rangeKey];\n  const options = { end_date: toEpochDay(now) };\n\n  if (Number.isFinite(rangeDays) && rangeDays > 0) {\n    const start = new Date(now.getTime());\n    start.setUTCDate(start.getUTCDate() - (rangeDays - 1));\n    options.start_date = toEpochDay(start);\n  }\n\n  return options;\n}\n\nfunction parseHistoryDate(raw) {\n  if (!raw) {\n    return null;\n  }\n\n  if (raw instanceof Date && !Number.isNaN(raw.getTime())) {\n    return new Date(raw.getTime());\n  }\n\n  if (typeof raw === 'number' && Number.isFinite(raw)) {\n    // Backend liefert Epoch Days (Tage seit 1970-01-01).\n    const timestamp = raw * 86400000;\n    if (Number.isFinite(timestamp)) {\n      return new Date(timestamp);\n    }\n  }\n\n  if (typeof raw === 'string') {\n    const trimmed = raw.trim();\n    if (/^\\d{8}$/.test(trimmed)) {\n      const year = Number.parseInt(trimmed.slice(0, 4), 10);\n      const month = Number.parseInt(trimmed.slice(4, 6), 10) - 1;\n      const day = Number.parseInt(trimmed.slice(6, 8), 10);\n      if (\n        Number.isFinite(year) &&\n        Number.isFinite(month) &&\n        Number.isFinite(day)\n      ) {\n        const date = new Date(Date.UTC(year, month, day));\n        if (!Number.isNaN(date.getTime())) {\n          return date;\n        }\n      }\n    }\n\n    const parsed = Date.parse(trimmed);\n    if (Number.isFinite(parsed)) {\n      return new Date(parsed);\n    }\n  }\n\n  return null;\n}\n\nfunction normaliseHistorySeries(prices) {\n  if (!Array.isArray(prices)) {\n    return [];\n  }\n\n  return prices\n    .map(entry => {\n      const rawClose = Number(entry?.close);\n      if (!Number.isFinite(rawClose)) {\n        return null;\n      }\n\n      const dateValue = parseHistoryDate(entry?.date);\n\n      return {\n        date: dateValue || entry?.date,\n        close: rawClose / PRICE_SCALE,\n      };\n    })\n    .filter(Boolean);\n}\n\nfunction deriveFxRate(snapshot, latestNativePrice) {\n  const currency = String(snapshot?.currency_code || '').toUpperCase();\n  if (!currency || currency === 'EUR') {\n    // Kein FremdwÃ¤hrungsrisiko â€“ Werte liegen bereits in EUR vor.\n    return 1;\n  }\n\n  const lastPriceEurRaw = snapshot?.last_price_eur;\n  const lastPriceEur = Number.isFinite(lastPriceEurRaw)\n    ? lastPriceEurRaw\n    : Number.parseFloat(lastPriceEurRaw);\n\n  if (!Number.isFinite(lastPriceEur) || lastPriceEur <= 0) {\n    // Ohne EUR-Referenzkurs kÃ¶nnen wir nicht in EUR umrechnen.\n    return null;\n  }\n\n  const snapshotNativeRaw = snapshot?.last_price_native;\n  const snapshotNative = Number.isFinite(snapshotNativeRaw)\n    ? snapshotNativeRaw\n    : Number.parseFloat(snapshotNativeRaw);\n\n  if (Number.isFinite(snapshotNative) && snapshotNative > 0) {\n    return lastPriceEur / snapshotNative;\n  }\n\n  const historyNative = Number.isFinite(latestNativePrice)\n    ? latestNativePrice\n    : Number.parseFloat(latestNativePrice);\n  if (Number.isFinite(historyNative) && historyNative > 0) {\n    return lastPriceEur / historyNative;\n  }\n\n  return null;\n}\n\nfunction roundCurrency(value) {\n  if (!Number.isFinite(value)) {\n    return null;\n  }\n\n  const rounded = Math.round(value * 100) / 100;\n  return Object.is(rounded, -0) ? 0 : rounded;\n}\n\nfunction computeGainValues(historySeries, holdings, fxRate) {\n  if (!Array.isArray(historySeries) || historySeries.length === 0) {\n    return { periodGain: null, dailyGain: null };\n  }\n\n  const holdingsNumeric = Number.isFinite(holdings)\n    ? holdings\n    : Number.parseFloat(holdings);\n  const safeHoldings = Number.isFinite(holdingsNumeric) ? holdingsNumeric : 0;\n  const safeFx = Number.isFinite(fxRate) && fxRate > 0 ? fxRate : null;\n\n  if (safeFx == null) {\n    return { periodGain: null, dailyGain: null };\n  }\n\n  const lastEntry = historySeries[historySeries.length - 1];\n  const firstEntry = historySeries[0];\n  const previousEntry =\n    historySeries.length >= 2 ? historySeries[historySeries.length - 2] : null;\n\n  const periodDiff = (lastEntry.close - firstEntry.close) * safeHoldings * safeFx;\n  const dailyDiff = previousEntry\n    ? (lastEntry.close - previousEntry.close) * safeHoldings * safeFx\n    : null;\n\n  return {\n    periodGain: roundCurrency(periodDiff),\n    dailyGain: roundCurrency(dailyDiff),\n  };\n}\n\nfunction formatGainValue(value) {\n  if (value == null || Number.isNaN(value)) {\n    return '<span class=\"value neutral\">â€”</span>';\n  }\n\n  return `<span class=\"value\">${formatGain(value)}</span>`;\n}\n\nfunction buildInfoBar(rangeKey, periodGain, dailyGain) {\n  const rangeLabel = rangeKey ? rangeKey : '';\n  return `\n    <div class=\"security-info-bar\" data-range=\"${rangeLabel}\">\n      <div class=\"security-info-item\">\n        <span class=\"label\">Gesamt (${rangeLabel || 'Zeitraum'})</span>\n        ${formatGainValue(periodGain)}\n      </div>\n      <div class=\"security-info-item\">\n        <span class=\"label\">Letzter Tag</span>\n        ${formatGainValue(dailyGain)}\n      </div>\n    </div>\n  `;\n}\n\nfunction buildRangeSelector(activeRange) {\n  const buttons = AVAILABLE_HISTORY_RANGES.map((rangeKey) => {\n    const activeClass = rangeKey === activeRange ? ' active' : '';\n    return `\n      <button\n        type=\"button\"\n        class=\"security-range-button${activeClass}\"\n        data-range=\"${rangeKey}\"\n        aria-pressed=\"${rangeKey === activeRange}\"\n      >\n        ${rangeKey}\n      </button>\n    `;\n  });\n\n  return `\n    <div class=\"security-range-selector\" role=\"group\" aria-label=\"Zeitraum\">\n      ${buttons.join('\\n')}\n    </div>\n  `;\n}\n\nfunction buildHistoryPlaceholder(rangeKey, state = { status: 'empty' }) {\n  const safeRange = rangeKey || '';\n\n  switch (state.status) {\n    case 'loaded':\n      return `\n        <div\n          class=\"history-chart\"\n          data-state=\"loaded\"\n          data-range=\"${safeRange}\"\n          role=\"img\"\n          aria-label=\"Preisverlauf${safeRange ? ` fÃ¼r ${safeRange}` : ''}\"\n        ></div>\n      `;\n    case 'error': {\n      const message = state?.message\n        ? String(state.message)\n        : 'Die historischen Daten konnten nicht geladen werden.';\n      return `\n        <div class=\"history-placeholder\" data-state=\"error\" data-range=\"${safeRange}\">\n          <p>${message}</p>\n        </div>\n      `;\n    }\n    case 'empty':\n    default:\n      return `\n        <div class=\"history-placeholder\" data-state=\"empty\" data-range=\"${safeRange}\">\n          <p>FÃ¼r dieses Wertpapier liegen im Zeitraum ${safeRange || 'den gewÃ¤hlten Zeitraum'} keine historischen Daten vor.</p>\n        </div>\n      `;\n  }\n}\n\nfunction formatHoldings(value) {\n  if (value == null || Number.isNaN(value)) {\n    return 'â€”';\n  }\n\n  const numeric = Number.isFinite(value) ? value : Number.parseFloat(value) || 0;\n  const hasFraction = Math.abs(numeric % 1) > 0;\n  const minFraction = hasFraction ? 2 : HOLDINGS_FRACTION_DIGITS.min;\n  const maxFraction = hasFraction ? HOLDINGS_FRACTION_DIGITS.max : HOLDINGS_FRACTION_DIGITS.min;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: minFraction,\n    maximumFractionDigits: maxFraction,\n  });\n}\n\nfunction formatPrice(value) {\n  if (value == null || Number.isNaN(value)) {\n    return 'â€”';\n  }\n\n  const numeric = Number.isFinite(value) ? value : Number.parseFloat(value) || 0;\n  return numeric.toLocaleString('de-DE', {\n    minimumFractionDigits: PRICE_FRACTION_DIGITS.min,\n    maximumFractionDigits: PRICE_FRACTION_DIGITS.max,\n  });\n}\n\nfunction buildHeaderMeta(snapshot) {\n  if (!snapshot) {\n    return '<div class=\"meta-error\">Keine Snapshot-Daten verfÃ¼gbar.</div>';\n  }\n\n  const currency = snapshot.currency_code || 'EUR';\n  const holdings = formatHoldings(snapshot.total_holdings);\n  const lastPriceNative =\n    snapshot.last_price_native ?? snapshot.last_price?.native ?? snapshot.last_price_eur;\n  const formattedLastPrice = formatPrice(lastPriceNative);\n  const lastPriceDisplay =\n    formattedLastPrice === 'â€”'\n      ? 'â€”'\n      : `${formattedLastPrice}${currency ? `&nbsp;${currency}` : ''}`;\n  const marketValue = formatNumber(\n    snapshot.market_value_eur ?? snapshot.current_value_eur ?? 0,\n  );\n\n  return `\n    <div class=\"security-meta-grid\">\n      <div class=\"security-meta-item\">\n        <span class=\"label\">WÃ¤hrung</span>\n        <span class=\"value\">${currency}</span>\n      </div>\n      <div class=\"security-meta-item\">\n        <span class=\"label\">Bestand</span>\n        <span class=\"value\">${holdings}</span>\n      </div>\n      <div class=\"security-meta-item\">\n        <span class=\"label\">Letzter Preis (${currency})</span>\n        <span class=\"value\">${lastPriceDisplay}</span>\n      </div>\n      <div class=\"security-meta-item\">\n        <span class=\"label\">Marktwert (EUR)</span>\n        <span class=\"value\">${marketValue}&nbsp;â‚¬</span>\n      </div>\n    </div>\n  `;\n}\n\nfunction normaliseHistoryError(error) {\n  if (!error) {\n    return null;\n  }\n\n  if (typeof error === 'string') {\n    return error;\n  }\n\n  if (error instanceof Error) {\n    return error.message || null;\n  }\n\n  try {\n    return JSON.stringify(error);\n  } catch (_jsonError) {\n    return String(error);\n  }\n}\n\nexport async function renderSecurityDetail(root, hass, panelConfig, securityUuid) {\n  if (!securityUuid) {\n    console.error('renderSecurityDetail: securityUuid fehlt');\n    return '<div class=\"card\"><h2>Fehler</h2><p>Kein Wertpapier angegeben.</p></div>';\n  }\n\n  const cachedSnapshot = getCachedSecuritySnapshot(securityUuid);\n  let snapshot = null;\n  let error = null;\n\n  try {\n    const response = await fetchSecuritySnapshotWS(\n      hass,\n      panelConfig,\n      securityUuid,\n    );\n    if (response && typeof response === 'object') {\n      snapshot =\n        response.snapshot && typeof response.snapshot === 'object'\n          ? response.snapshot\n          : response;\n    } else {\n      snapshot = response;\n    }\n  } catch (err) {\n    console.error('renderSecurityDetail: Snapshot konnte nicht geladen werden', err);\n    error = err instanceof Error ? err.message : String(err);\n  }\n\n  const effectiveSnapshot = snapshot || cachedSnapshot;\n  const fallbackUsed = Boolean(cachedSnapshot && !snapshot);\n  const flaggedAsCache = effectiveSnapshot?.source === 'cache';\n  const staleNotice =\n    effectiveSnapshot && (fallbackUsed || flaggedAsCache)\n      ? buildCachedSnapshotNotice({ fallbackUsed, flaggedAsCache })\n      : '';\n  const headerTitle = effectiveSnapshot?.name || 'Wertpapierdetails';\n  const headerCard = createHeaderCard(headerTitle, buildHeaderMeta(effectiveSnapshot));\n\n  if (error) {\n    return `\n      ${headerCard.outerHTML}\n      ${staleNotice}\n      <div class=\"card error-card\">\n        <h2>Fehler beim Laden</h2>\n        <p>${error}</p>\n      </div>\n    `;\n  }\n\n  const activeRange = getActiveRange(securityUuid);\n  const cache = ensureHistoryCache(securityUuid);\n  let historySeries = cache.has(activeRange) ? cache.get(activeRange) : null;\n  let historyState = { status: 'empty' };\n\n  if (Array.isArray(historySeries)) {\n    historyState = historySeries.length\n      ? { status: 'loaded' }\n      : { status: 'empty' };\n  } else {\n    historySeries = [];\n    try {\n      const rangeOptions = resolveRangeOptions(activeRange);\n      const historyResponse = await fetchSecurityHistoryWS(\n        hass,\n        panelConfig,\n        securityUuid,\n        rangeOptions,\n      );\n      historySeries = normaliseHistorySeries(historyResponse?.prices);\n      cache.set(activeRange, historySeries);\n      historyState = historySeries.length\n        ? { status: 'loaded' }\n        : { status: 'empty' };\n    } catch (historyError) {\n      console.error(\n        'renderSecurityDetail: Historie konnte nicht geladen werden',\n        historyError,\n      );\n      const message = normaliseHistoryError(historyError);\n      historyState = {\n        status: 'error',\n        message:\n          message ||\n          'Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden.',\n      };\n    }\n  }\n\n  const latestNativePrice =\n    historySeries.length > 0\n      ? historySeries[historySeries.length - 1].close\n      : effectiveSnapshot?.last_price_native;\n  const fxRate = deriveFxRate(effectiveSnapshot, latestNativePrice);\n  const holdings = effectiveSnapshot?.total_holdings ?? 0;\n  const { periodGain, dailyGain } = computeGainValues(\n    historySeries,\n    holdings,\n    fxRate,\n  );\n  const infoBar = buildInfoBar(activeRange, periodGain, dailyGain);\n\n  scheduleRangeSetup({\n    root,\n    hass,\n    panelConfig,\n    securityUuid,\n    snapshot: effectiveSnapshot,\n    holdings,\n    initialRange: activeRange,\n    initialHistory: historySeries,\n    initialHistoryState: historyState,\n  });\n\n  return `\n    ${headerCard.outerHTML}\n    ${staleNotice}\n    ${infoBar}\n    ${buildRangeSelector(activeRange)}\n    <div class=\"card security-detail-placeholder\">\n      <h2>Historie</h2>\n      ${buildHistoryPlaceholder(activeRange, historyState)}\n    </div>\n  `;\n}\n\nfunction updateRangeButtons(container, activeRange) {\n  if (!container) {\n    return;\n  }\n\n  container.dataset.activeRange = activeRange;\n  container.querySelectorAll('.security-range-button').forEach((button) => {\n    const rangeKey = button.dataset.range;\n    const isActive = rangeKey === activeRange;\n    button.classList.toggle('active', isActive);\n    button.setAttribute('aria-pressed', isActive ? 'true' : 'false');\n    button.disabled = false;\n    button.classList.remove('loading');\n  });\n}\n\nfunction updateInfoBarContent(root, rangeKey, periodGain, dailyGain) {\n  const infoBar = root.querySelector('.security-info-bar');\n  if (!infoBar || !infoBar.parentElement) {\n    return;\n  }\n\n  const wrapper = document.createElement('div');\n  wrapper.innerHTML = buildInfoBar(rangeKey, periodGain, dailyGain).trim();\n  const fresh = wrapper.firstElementChild;\n  if (!fresh) {\n    return;\n  }\n  infoBar.parentElement.replaceChild(fresh, infoBar);\n}\n\nconst HISTORY_CHART_INSTANCES = new WeakMap();\n\nfunction getHistoryChartOptions(host, series, { currency } = {}) {\n  const measuredWidth = host.clientWidth || host.offsetWidth || 0;\n  const width = measuredWidth > 0 ? measuredWidth : 640;\n  const height = Math.min(Math.max(Math.floor(width * 0.55), 220), 420);\n  const safeCurrency = (currency || '').toUpperCase() || 'EUR';\n\n  return {\n    width,\n    height,\n    margin: { top: 16, right: 20, bottom: 32, left: 20 },\n    series,\n    yFormatter: formatPrice,\n    tooltipRenderer: ({ xFormatted, yFormatted }) => `\n      <div class=\"chart-tooltip-date\">${xFormatted}</div>\n      <div class=\"chart-tooltip-value\">${yFormatted}&nbsp;${safeCurrency}</div>\n    `,\n  };\n}\n\nfunction renderHistoryChart(host, series, options) {\n  if (!host || !Array.isArray(series) || series.length === 0) {\n    return;\n  }\n\n  const chartOptions = getHistoryChartOptions(host, series, options);\n  let chartContainer = HISTORY_CHART_INSTANCES.get(host);\n\n  if (!chartContainer || !host.contains(chartContainer)) {\n    host.innerHTML = '';\n    chartContainer = renderLineChart(host, chartOptions) || null;\n    if (chartContainer) {\n      HISTORY_CHART_INSTANCES.set(host, chartContainer);\n    }\n    return;\n  }\n\n  updateLineChart(chartContainer, chartOptions);\n}\n\nfunction updateHistoryPlaceholder(root, rangeKey, state, historySeries, options = {}) {\n  const placeholderContainer = root.querySelector('.security-detail-placeholder');\n  if (!placeholderContainer) {\n    return;\n  }\n\n  placeholderContainer.innerHTML = `\n    <h2>Historie</h2>\n    ${buildHistoryPlaceholder(rangeKey, state)}\n  `;\n\n  if (state?.status === 'loaded' && Array.isArray(historySeries) && historySeries.length) {\n    const host = placeholderContainer.querySelector('.history-chart');\n    if (host) {\n      requestAnimationFrame(() => {\n        renderHistoryChart(host, historySeries, options);\n      });\n    }\n  }\n}\n\nfunction scheduleRangeSetup({\n  root,\n  hass,\n  panelConfig,\n  securityUuid,\n  snapshot,\n  holdings,\n  initialRange,\n  initialHistory,\n  initialHistoryState,\n}) {\n  if (!root) {\n    return;\n  }\n\n  setTimeout(() => {\n    const rangeSelector = root.querySelector('.security-range-selector');\n    if (!rangeSelector) {\n      return;\n    }\n\n    const cache = ensureHistoryCache(securityUuid);\n    const shouldCacheInitial =\n      Array.isArray(initialHistory) && initialHistoryState?.status !== 'error';\n    if (shouldCacheInitial) {\n      cache.set(initialRange, initialHistory);\n    }\n\n    ensureLiveUpdateSubscription(securityUuid);\n\n    setActiveRange(securityUuid, initialRange);\n    updateRangeButtons(rangeSelector, initialRange);\n    if (initialHistoryState) {\n      updateHistoryPlaceholder(\n        root,\n        initialRange,\n        initialHistoryState,\n        initialHistory,\n        { currency: snapshot?.currency_code },\n      );\n    }\n\n    const handleRangeClick = async (rangeKey) => {\n      if (!rangeKey || rangeKey === getActiveRange(securityUuid)) {\n        return;\n      }\n\n      const button = rangeSelector.querySelector(\n        `.security-range-button[data-range=\"${rangeKey}\"]`,\n      );\n      if (button) {\n        button.disabled = true;\n        button.classList.add('loading');\n      }\n\n      let historySeries = cache.get(rangeKey) || null;\n      let historyState = null;\n      if (!historySeries) {\n        try {\n          const rangeOptions = resolveRangeOptions(rangeKey);\n          const historyResponse = await fetchSecurityHistoryWS(\n            hass,\n            panelConfig,\n            securityUuid,\n            rangeOptions,\n          );\n          historySeries = normaliseHistorySeries(historyResponse?.prices);\n          cache.set(rangeKey, historySeries);\n          historyState = historySeries.length\n            ? { status: 'loaded' }\n            : { status: 'empty' };\n        } catch (error) {\n          console.error('Range-Wechsel: Historie konnte nicht geladen werden', error);\n          historySeries = [];\n          const message = normaliseHistoryError(error);\n          historyState = {\n            status: 'error',\n            message:\n              message ||\n              'Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden.',\n          };\n        }\n      } else {\n        historyState = historySeries.length\n          ? { status: 'loaded' }\n          : { status: 'empty' };\n      }\n\n      const lastClose = historySeries.length\n        ? historySeries[historySeries.length - 1].close\n        : snapshot?.last_price_native;\n      const activeFxRate = deriveFxRate(snapshot, lastClose);\n      const { periodGain, dailyGain } = computeGainValues(\n        historySeries,\n        holdings,\n        activeFxRate,\n      );\n\n      setActiveRange(securityUuid, rangeKey);\n      updateRangeButtons(rangeSelector, rangeKey);\n      updateInfoBarContent(root, rangeKey, periodGain, dailyGain);\n      updateHistoryPlaceholder(\n        root,\n        rangeKey,\n        historyState,\n        historySeries,\n        { currency: snapshot?.currency_code },\n      );\n    };\n\n    rangeSelector.addEventListener('click', (event) => {\n      const button = event.target.closest('.security-range-button');\n      if (!button || button.disabled) {\n        return;\n      }\n      const { range } = button.dataset;\n      handleRangeClick(range);\n    });\n  }, 0);\n}\n\nexport function registerSecurityDetailTab({ setSecurityDetailTabFactory }) {\n  if (typeof setSecurityDetailTabFactory !== 'function') {\n    console.error('registerSecurityDetailTab: UngÃ¼ltige Factory-Funktion Ã¼bergeben');\n    return;\n  }\n\n  setSecurityDetailTabFactory((securityUuid) => ({\n    title: 'Wertpapier',\n    render: (root, hass, panelConfig) => renderSecurityDetail(root, hass, panelConfig, securityUuid),\n    cleanup: () => cleanupSecurityDetailState(securityUuid),\n  }));\n}\n","// @ts-nocheck\n\n/**\n * Mirrors the legacy dashboard controller for initial TypeScript migration.\n */\n\nimport { addSwipeEvents } from './interaction/tab_control';\nimport { renderDashboard, attachPortfolioToggleHandler } from './tabs/overview';\nimport { registerSecurityDetailTab } from './tabs/security_detail';\nimport {\n  handleAccountUpdate,\n  handleLastFileUpdate,\n  handlePortfolioUpdate,\n  handlePortfolioPositionsUpdate\n} from './data/updateConfigsWS';\nimport { getEntryId } from './data/api';\n\nconst STICKY_HEADER_ANCHOR_ID = 'pp-reader-sticky-anchor';\n\nconst OVERVIEW_TAB_KEY = 'overview';\n\nconst baseTabs = [\n  { key: OVERVIEW_TAB_KEY, title: 'Dashboard', render: renderDashboard }\n];\n\nconst detailTabRegistry = new Map();\nconst detailTabOrder = [];\nconst securityTabLookup = new Map();\nconst SECURITY_DETAIL_TAB_PREFIX = 'security:';\n\nfunction extractSecurityUuidFromKey(key) {\n  if (typeof key !== 'string' || !key.startsWith(SECURITY_DETAIL_TAB_PREFIX)) {\n    return null;\n  }\n\n  const uuid = key.slice(SECURITY_DETAIL_TAB_PREFIX.length);\n  return uuid || null;\n}\n\nlet securityDetailTabFactory = null;\nlet navigationInProgress = false;\nlet lastClosedSecurityUuid = null;\n\nfunction tryReopenLastDetail() {\n  if (!lastClosedSecurityUuid) {\n    return false;\n  }\n\n  const reopened = openSecurityDetail(lastClosedSecurityUuid);\n  if (!reopened) {\n    lastClosedSecurityUuid = null;\n  }\n  return reopened;\n}\n\nfunction getVisibleTabs() {\n  const detailTabs = detailTabOrder\n    .map((key) => detailTabRegistry.get(key))\n    .filter(Boolean);\n\n  return [...baseTabs, ...detailTabs];\n}\n\nfunction rememberCurrentPageScroll() {\n  try {\n    const dashboardElement = findDashboardElement();\n    if (dashboardElement && typeof dashboardElement.rememberScrollPosition === 'function') {\n      dashboardElement.rememberScrollPosition();\n    }\n  } catch (error) {\n    console.warn('rememberCurrentPageScroll: konnte Scroll-Position nicht sichern', error);\n  }\n}\n\nfunction clampPageIndex(index) {\n  const tabs = getVisibleTabs();\n  if (!tabs.length) {\n    return 0;\n  }\n  if (index < 0) {\n    return 0;\n  }\n  if (index >= tabs.length) {\n    return tabs.length - 1;\n  }\n  return index;\n}\n\nasync function navigateToPage(targetIndex, root, hass, panel) {\n  const tabs = getVisibleTabs();\n  const clampedIndex = clampPageIndex(targetIndex);\n  if (clampedIndex === currentPage) {\n    if (targetIndex > currentPage) {\n      tryReopenLastDetail();\n    }\n    return;\n  }\n\n  rememberCurrentPageScroll();\n\n  const currentTab = tabs[currentPage];\n  const currentSecurityUuid = extractSecurityUuidFromKey(currentTab?.key);\n  let nextIndex = clampedIndex;\n\n  if (currentSecurityUuid) {\n    const intendedTarget = tabs[clampedIndex];\n    if (intendedTarget?.key === OVERVIEW_TAB_KEY) {\n      const closed = closeSecurityDetail(currentSecurityUuid, { suppressRender: true });\n      if (closed) {\n        const updatedTabs = getVisibleTabs();\n        const overviewIndex = updatedTabs.findIndex((tab) => tab.key === OVERVIEW_TAB_KEY);\n        nextIndex = overviewIndex >= 0 ? overviewIndex : 0;\n      }\n    }\n  }\n\n  if (navigationInProgress) {\n    return;\n  }\n\n  navigationInProgress = true;\n  try {\n    currentPage = clampPageIndex(nextIndex);\n    await renderTab(root, hass, panel);\n  } catch (error) {\n    console.error('navigateToPage: Fehler beim Rendern des Tabs', error);\n  } finally {\n    navigationInProgress = false;\n  }\n}\n\nfunction navigateByDelta(delta, root, hass, panel) {\n  navigateToPage(currentPage + delta, root, hass, panel);\n}\n\nexport function registerDetailTab(key, descriptor) {\n  if (!key || !descriptor || typeof descriptor.render !== 'function') {\n    console.error('registerDetailTab: UngÃ¼ltiger Tab-Descriptor', key, descriptor);\n    return;\n  }\n\n  const securityUuid = extractSecurityUuidFromKey(key);\n  if (securityUuid) {\n    const existingKey = securityTabLookup.get(securityUuid);\n    if (existingKey && existingKey !== key) {\n      unregisterDetailTab(existingKey);\n    }\n  }\n\n  const normalizedDescriptor = {\n    ...descriptor,\n    key,\n  };\n\n  detailTabRegistry.set(key, normalizedDescriptor);\n\n  if (securityUuid) {\n    securityTabLookup.set(securityUuid, key);\n  }\n\n  if (!detailTabOrder.includes(key)) {\n    detailTabOrder.push(key);\n  }\n}\n\nexport function unregisterDetailTab(key) {\n  if (!key) {\n    return;\n  }\n\n  const descriptor = detailTabRegistry.get(key);\n  if (descriptor && typeof descriptor.cleanup === 'function') {\n    try {\n      descriptor.cleanup({ key });\n    } catch (error) {\n      console.error('unregisterDetailTab: Fehler beim AusfÃ¼hren von cleanup', error);\n    }\n  }\n\n  detailTabRegistry.delete(key);\n\n  const index = detailTabOrder.indexOf(key);\n  if (index >= 0) {\n    detailTabOrder.splice(index, 1);\n  }\n\n  const securityUuid = extractSecurityUuidFromKey(key);\n  if (securityUuid && securityTabLookup.get(securityUuid) === key) {\n    securityTabLookup.delete(securityUuid);\n  }\n}\n\nexport function hasDetailTab(key) {\n  return detailTabRegistry.has(key);\n}\n\nexport function getDetailTabDescriptor(key) {\n  return detailTabRegistry.get(key) || null;\n}\n\nexport function setSecurityDetailTabFactory(factory) {\n  if (factory != null && typeof factory !== 'function') {\n    console.error('setSecurityDetailTabFactory: Erwartet Funktion oder null', factory);\n    return;\n  }\n\n  securityDetailTabFactory = factory || null;\n}\n\nfunction getSecurityDetailTabKey(securityUuid) {\n  return `${SECURITY_DETAIL_TAB_PREFIX}${securityUuid}`;\n}\n\nfunction findDashboardElement() {\n  const registered = window.__ppReaderDashboardElements;\n  if (registered instanceof Set) {\n    for (const element of registered) {\n      if (element && element.isConnected) {\n        return element;\n      }\n    }\n  }\n\n  const direct = document.querySelector('pp-reader-dashboard');\n  if (direct) {\n    return direct;\n  }\n\n  const panelElements = document.querySelectorAll('pp-reader-panel');\n  for (const panelElement of panelElements) {\n    if (!panelElement || !panelElement.shadowRoot) {\n      continue;\n    }\n\n    const nested = panelElement.shadowRoot.querySelector('pp-reader-dashboard');\n    if (nested) {\n      return nested;\n    }\n  }\n\n  return null;\n}\n\nfunction requestDashboardRender() {\n  const dashboardElement = findDashboardElement();\n  if (!dashboardElement) {\n    console.warn('requestDashboardRender: Kein pp-reader-dashboard Element gefunden');\n    return;\n  }\n\n  if (typeof dashboardElement._renderIfInitialized === 'function') {\n    dashboardElement._renderIfInitialized();\n    return;\n  }\n\n  if (typeof dashboardElement._render === 'function') {\n    dashboardElement._render();\n  }\n}\n\nexport function openSecurityDetail(securityUuid) {\n  if (!securityUuid) {\n    console.error('openSecurityDetail: UngÃ¼ltige securityUuid', securityUuid);\n    return false;\n  }\n\n  const tabKey = getSecurityDetailTabKey(securityUuid);\n  let descriptor = getDetailTabDescriptor(tabKey);\n\n  if (!descriptor && typeof securityDetailTabFactory === 'function') {\n    try {\n      const maybeDescriptor = securityDetailTabFactory(securityUuid);\n      if (maybeDescriptor && typeof maybeDescriptor.render === 'function') {\n        registerDetailTab(tabKey, maybeDescriptor);\n        descriptor = getDetailTabDescriptor(tabKey);\n      } else {\n        console.error('openSecurityDetail: Factory lieferte ungÃ¼ltigen Descriptor', maybeDescriptor);\n      }\n    } catch (error) {\n      console.error('openSecurityDetail: Fehler beim Erzeugen des Tab-Descriptors', error);\n    }\n  }\n\n  if (!descriptor) {\n    console.warn(`openSecurityDetail: Kein Detail-Tab fÃ¼r ${securityUuid} verfÃ¼gbar`);\n    return false;\n  }\n\n  rememberCurrentPageScroll();\n\n  const tabs = getVisibleTabs();\n  let targetIndex = tabs.findIndex((tab) => tab.key === tabKey);\n\n  if (targetIndex === -1) {\n    const updatedTabs = getVisibleTabs();\n    targetIndex = updatedTabs.findIndex((tab) => tab.key === tabKey);\n    if (targetIndex === -1) {\n      console.error('openSecurityDetail: Tab nach Registrierung nicht auffindbar');\n      return false;\n    }\n  }\n\n  currentPage = targetIndex;\n  lastClosedSecurityUuid = null;\n  requestDashboardRender();\n  return true;\n}\n\nexport function closeSecurityDetail(securityUuid, options = {}) {\n  if (!securityUuid) {\n    console.error('closeSecurityDetail: UngÃ¼ltige securityUuid', securityUuid);\n    return false;\n  }\n\n  const { suppressRender = false } = options;\n\n  const tabKey = getSecurityDetailTabKey(securityUuid);\n  if (!hasDetailTab(tabKey)) {\n    return false;\n  }\n\n  const tabsBefore = getVisibleTabs();\n  const tabIndexBefore = tabsBefore.findIndex((tab) => tab.key === tabKey);\n  const wasActive = tabIndexBefore === currentPage;\n\n  unregisterDetailTab(tabKey);\n\n  const tabsAfter = getVisibleTabs();\n  if (!tabsAfter.length) {\n    currentPage = 0;\n    if (!suppressRender) {\n      requestDashboardRender();\n    }\n    return true;\n  }\n\n  lastClosedSecurityUuid = securityUuid;\n\n  if (wasActive) {\n    const overviewIndex = tabsAfter.findIndex((tab) => tab.key === OVERVIEW_TAB_KEY);\n    if (overviewIndex >= 0) {\n      currentPage = overviewIndex;\n    } else {\n      currentPage = Math.min(Math.max(tabIndexBefore - 1, 0), tabsAfter.length - 1);\n    }\n  } else if (currentPage >= tabsAfter.length) {\n    currentPage = Math.max(0, tabsAfter.length - 1);\n  }\n\n  if (!suppressRender) {\n    requestDashboardRender();\n  }\n  return true;\n}\n\nlet currentPage = 0;\nlet observer; // Globale Variable fÃ¼r Debugging\n\nasync function renderTab(root, hass, panel) {\n  // Fallback: Panel-Konfiguration aus hass.panels ableiten, falls panel undefined\n  let effectivePanel = panel;\n  if (!effectivePanel && hass?.panels) {\n    // Versuche spezifische Keys\n    effectivePanel =\n      hass.panels.ppreader ||\n      hass.panels.pp_reader ||\n      // Suche nach unserem Webcomponent\n      Object.values(hass.panels).find(p => p?.webcomponent_name === 'pp-reader-panel') ||\n      null;\n  }\n\n  const tabs = getVisibleTabs();\n  if (currentPage >= tabs.length) {\n    currentPage = Math.max(0, tabs.length - 1);\n  }\n\n  const tab = tabs[currentPage];\n  if (!tab || !tab.render) {\n    console.error(\"renderTab: Kein gÃ¼ltiger Tab oder keine render-Methode gefunden!\");\n    return;\n  }\n\n  let content;\n  try {\n    content = await tab.render(root, hass, effectivePanel); // effectivePanel statt panel\n  } catch (error) {\n    console.error(\"renderTab: Fehler beim Rendern des Tabs:\", error);\n    root.innerHTML = `<div class=\"card\"><h2>Fehler</h2><pre>${(error && error.message) || error}</pre></div>`;\n    return;\n  }\n\n  if (!root) {\n    console.error(\"renderTab: Root-Element nicht gefunden!\");\n    return;\n  }\n\n  root.innerHTML = content;\n\n  // NEU (Section 6): Scoped Listener fÃ¼r Portfolio-Expand nur fÃ¼r Overview-Tab (Index 0 / Titel 'Dashboard')\n  if (tab.render === renderDashboard) {\n    attachPortfolioToggleHandler(root);\n  }\n\n  // Warte, bis die `.header-card` im DOM verfÃ¼gbar ist\n  const waitForHeaderCard = () => new Promise((resolve) => {\n    const interval = setInterval(() => {\n      const headerCard = root.querySelector('.header-card');\n      if (headerCard) {\n        clearInterval(interval);\n        resolve(headerCard);\n      }\n    }, 50);\n  });\n\n  const headerCard = await waitForHeaderCard();\n  if (!headerCard) {\n    console.error(\"Header-Card nicht gefunden!\");\n    return;\n  }\n\n  // Sticky-Anchor fÃ¼r IntersectionObserver erstellen (scoped innerhalb des Root-Elements)\n  let anchor = root.querySelector(`#${STICKY_HEADER_ANCHOR_ID}`);\n  if (!anchor) {\n    anchor = document.createElement('div');\n    anchor.id = STICKY_HEADER_ANCHOR_ID;\n    headerCard.parentNode.insertBefore(anchor, headerCard);\n  }\n\n  // Navigation und Scrollverhalten einrichten\n  setupNavigation(root, hass, panel); // Lokale Parameter Ã¼bergeben\n  setupSwipeOnHeaderCard(root, hass, panel); // Lokale Parameter Ã¼bergeben\n  setupHeaderScrollBehavior(root);\n}\n\nfunction setupHeaderScrollBehavior(root) {\n  const headerCard = root.querySelector('.header-card');\n  const scrollBorder = root;\n  const anchor = root.querySelector(`#${STICKY_HEADER_ANCHOR_ID}`);\n\n  if (!headerCard || !scrollBorder || !anchor) {\n    console.error(\"Fehlende Elemente fÃ¼r das Scrollverhalten: headerCard, scrollBorder oder anchor.\");\n    return;\n  }\n\n  observer = new IntersectionObserver(\n    ([entry]) => {\n      if (!entry.isIntersecting) {\n        headerCard.classList.add('sticky');\n      } else {\n        headerCard.classList.remove('sticky');\n      }\n    },\n    {\n      root: null,\n      rootMargin: `0px 0px 0px 0px`,\n      threshold: 0\n    }\n  );\n\n  observer.observe(anchor);\n}\n\nfunction setupSwipeOnHeaderCard(root, hass, panel) {\n  const headerCard = root.querySelector('.header-card');\n  if (!headerCard) {\n    console.error(\"Header-Card nicht gefunden!\");\n    return;\n  }\n\n  addSwipeEvents(\n    headerCard,\n    () => navigateByDelta(1, root, hass, panel),\n    () => navigateByDelta(-1, root, hass, panel)\n  );\n}\n\nfunction setupNavigation(root, hass, panel) {\n  const headerCard = root.querySelector('.header-card');\n  if (!headerCard) {\n    console.error(\"Header-Card nicht gefunden!\");\n    return;\n  }\n\n  const navLeft = headerCard.querySelector('#nav-left');\n  const navRight = headerCard.querySelector('#nav-right');\n\n  if (!navLeft || !navRight) {\n    console.error(\"Navigationspfeile nicht gefunden!\");\n    return;\n  }\n\n  navLeft.addEventListener('click', () => {\n    navigateByDelta(-1, root, hass, panel);\n  });\n\n  navRight.addEventListener('click', () => {\n    navigateByDelta(1, root, hass, panel);\n  });\n\n  updateNavigationState(headerCard); // Initialer Zustand der Navigationspfeile\n}\n\nfunction updateNavigationState(headerCard) {\n  const navLeft = headerCard.querySelector('#nav-left');\n  const navRight = headerCard.querySelector('#nav-right');\n\n  if (navLeft) {\n    if (currentPage === 0) {\n      navLeft.disabled = true;\n      navLeft.classList.add('disabled');\n    } else {\n      navLeft.disabled = false;\n      navLeft.classList.remove('disabled');\n    }\n  }\n\n  if (navRight) {\n    const tabs = getVisibleTabs();\n    const atEnd = currentPage === tabs.length - 1;\n    const shouldEnable = !atEnd || !!lastClosedSecurityUuid;\n    navRight.disabled = !shouldEnable;\n    navRight.classList.toggle('disabled', !shouldEnable);\n  }\n}\n\nclass PPReaderDashboard extends HTMLElement {\n  constructor() {\n    super();\n    this._root = document.createElement('div');\n    this._root.className = 'pp-reader-dashboard';\n    this.appendChild(this._root);\n\n    this._lastPanel = null;\n    this._lastNarrow = null;\n    this._lastRoute = null;\n    this._lastPage = null;\n    this._scrollPositions = {}; // Speichert die Scroll-Position pro Tab\n\n    this._unsubscribeEvents = null; // Event-Bus-Listener fÃ¼r Updates\n    this._initialized = false; // Initialisierungs-Flag\n    this._hasNewData = false; // Flag fÃ¼r neue Daten\n    this._pendingUpdates = []; // Gespeicherte WS-Updates zur Re-Anwendung nach Re-Renders\n    this._entryIdWaitWarned = false; // Verhindert Log-Spam wÃ¤hrend wir auf entry_id warten\n  }\n\n  set hass(hass) {\n    this._hass = hass;\n    this._checkInitialization(); // ÃœberprÃ¼fe die Initialisierung\n  }\n\n  set panel(panel) {\n    if (this._panel === panel) {\n      return;\n    }\n    this._panel = panel;\n    // Debug\n    // console.debug(\"PPReaderDashboard: panel setter\", panel);\n    this._checkInitialization();\n  }\n\n  set narrow(narrow) {\n    if (this._narrow === narrow) {\n      return;\n    }\n    this._narrow = narrow;\n    this._renderIfInitialized(); // Rendere nur, wenn initialisiert\n  }\n\n  set route(route) {\n    if (this._route === route) {\n      return;\n    }\n    this._route = route;\n    this._renderIfInitialized(); // Rendere nur, wenn initialisiert\n  }\n\n  connectedCallback() {\n    this._checkInitialization();\n  }\n\n  disconnectedCallback() {\n    // Wenn das Element aus dem DOM fliegt, sauber abmelden\n    if (typeof this._unsubscribeEvents === \"function\") {\n      this._unsubscribeEvents();\n      // console.debug(\"PPReaderDashboard: Event-Listener entfernt\");\n      this._unsubscribeEvents = null;\n    }\n    super.disconnectedCallback && super.disconnectedCallback();\n  }\n\n  _checkInitialization() {\n    if (!this._hass || this._initialized) return;\n\n    // Panel-Fallback falls nicht gesetzt\n    if (!this._panel && this._hass.panels) {\n      this._panel =\n        this._hass.panels.ppreader ||\n        this._hass.panels.pp_reader ||\n        Object.values(this._hass.panels).find(p => p?.config?._panel_custom?.module_url?.includes('pp_reader_dashboard')) ||\n        null;\n    }\n\n    const entryId = getEntryId(this._hass, this._panel);\n    if (!entryId) {\n      if (!this._entryIdWaitWarned) {\n        console.warn(\"PPReaderDashboard: kein entry_id ermittelbar â€“ warte auf Panel-Konfiguration.\");\n        this._entryIdWaitWarned = true;\n      }\n      return;\n    }\n\n    this._entryIdWaitWarned = false;\n    console.debug(\"PPReaderDashboard: entry_id (fallback) =\", entryId);\n    this._initialized = true;\n    this._initializeEventListeners(entryId);\n    this._render();\n  }\n\n  _initializeEventListeners(entryId) {\n    // Wenn schon mal registriert, vorher sauber abmelden\n    if (this._unsubscribeEvents) {\n      this._unsubscribeEvents();\n      this._unsubscribeEvents = null;\n    }\n\n    const conn = this._hass?.connection;\n    if (!conn || typeof conn.subscribeEvents !== \"function\") {\n      console.error(\"PPReaderDashboard: keine valide WebSocket-Verbindung oder subscribeEvents fehlt\");\n      return;\n    }\n\n    // Korrektur: Richtiger Event-Typ ist 'panels_updated' (Wert von HA CONST EVENT_PANELS_UPDATED)\n    // Zur Sicherheit auch Legacy-Fehlwert registrieren (wird einfach nie feuern)\n    const eventTypes = [\"panels_updated\"]; // frÃ¼her fÃ¤lschlich: \"EVENT_PANELS_UPDATED\"\n\n    const subs = [];\n    Promise.all(\n      eventTypes.map(et =>\n        conn\n          .subscribeEvents(this._handleBusEvent.bind(this), et)\n          .then(unsub => {\n            if (typeof unsub === \"function\") {\n              subs.push(unsub);\n              console.debug(\"PPReaderDashboard: subscribed to\", et);\n            } else {\n              console.error(\"PPReaderDashboard: subscribeEvents lieferte kein Unsubscribe-Func fÃ¼r\", et, unsub);\n            }\n          })\n          .catch(err => {\n            console.error(\"PPReaderDashboard: Fehler bei subscribeEvents fÃ¼r\", et, err);\n          })\n      )\n    ).then(() => {\n      this._unsubscribeEvents = () => {\n        subs.forEach(f => {\n          try { f(); } catch (e) { /* noop */ }\n        });\n        console.debug(\"PPReaderDashboard: alle Event-Subscriptions entfernt\");\n      };\n    });\n  }\n\n  _removeEventListeners() {\n    if (typeof this._unsubscribeEvents === \"function\") {\n      try {\n        this._unsubscribeEvents();\n        this._unsubscribeEvents = null;\n        // console.debug(\"PPReaderDashboard: Event-Listener erfolgreich entfernt.\");\n      } catch (error) {\n        console.error(\"PPReaderDashboard: Fehler beim Entfernen der Event-Listener:\", error);\n      }\n    } else {\n      console.warn(\"PPReaderDashboard: Kein gÃ¼ltiger Event-Listener zum Entfernen gefunden.\");\n    }\n  }\n\n  _handleBusEvent(event) {\n    const currentEntryId = getEntryId(this._hass, this._panel);\n    if (!currentEntryId || event.data.entry_id !== currentEntryId) return;\n\n    console.debug(\"PPReaderDashboard: Bus-Update erhalten\", event.data);\n\n    this._queueUpdate(event.data.data_type, event.data.data);\n    // Daten direkt ins Rendern einflieÃŸen lassen\n    this._doRender(event.data.data_type, event.data.data);\n  }\n\n  _doRender(dataType, pushedData) {\n    if (dataType === \"accounts\") {\n      handleAccountUpdate(pushedData, this._root);\n    } else if (dataType === \"last_file_update\") {\n      handleLastFileUpdate(pushedData, this._root);\n    } else if (dataType === \"portfolio_values\") {\n      handlePortfolioUpdate(pushedData, this._root);\n    } else if (dataType === \"portfolio_positions\") {\n      // NEU: Einzelpositions-Update fÃ¼r ein bestimmtes Depot\n      handlePortfolioPositionsUpdate(pushedData, this._root);\n    } else {\n      console.warn(\"PPReaderDashboard: Unbekannter Datentyp:\", dataType);\n    }\n  }\n\n  _queueUpdate(dataType, pushedData) {\n    if (!dataType) {\n      return;\n    }\n\n    if (!Array.isArray(this._pendingUpdates)) {\n      this._pendingUpdates = [];\n    }\n\n    const entry = { type: dataType, data: this._cloneData(pushedData) };\n\n    let index = -1;\n    if (dataType === \"portfolio_positions\" && pushedData && pushedData.portfolio_uuid) {\n      index = this._pendingUpdates.findIndex(\n        (item) =>\n          item.type === dataType &&\n          item.data &&\n          item.data.portfolio_uuid === pushedData.portfolio_uuid\n      );\n    } else {\n      index = this._pendingUpdates.findIndex(item => item.type === dataType);\n    }\n\n    if (index >= 0) {\n      this._pendingUpdates[index] = entry;\n    } else {\n      this._pendingUpdates.push(entry);\n    }\n\n    this._hasNewData = true;\n  }\n\n  _cloneData(data) {\n    if (data == null) {\n      return data;\n    }\n    try {\n      if (typeof structuredClone === \"function\") {\n        return structuredClone(data);\n      }\n    } catch (err) {\n      console.warn(\"PPReaderDashboard: structuredClone fehlgeschlagen, falle auf JSON zurÃ¼ck\", err);\n    }\n    try {\n      return JSON.parse(JSON.stringify(data));\n    } catch (err) {\n      console.warn(\"PPReaderDashboard: JSON-Clone fehlgeschlagen, referenziere Originaldaten\", err);\n      return data;\n    }\n  }\n\n  _reapplyPendingUpdates() {\n    if (!Array.isArray(this._pendingUpdates) || this._pendingUpdates.length === 0) {\n      return;\n    }\n\n    for (const item of this._pendingUpdates) {\n      try {\n        this._doRender(item.type, this._cloneData(item.data));\n      } catch (error) {\n        console.error(\"PPReaderDashboard: Fehler beim erneuten Anwenden eines Updates\", item, error);\n      }\n    }\n  }\n\n  _renderIfInitialized() {\n    // Rendere nur, wenn die Initialisierung abgeschlossen ist\n    if (this._initialized) {\n      this._render();\n    }\n  }\n\n  rememberScrollPosition(page = currentPage) {\n    if (!this._root) {\n      return;\n    }\n\n    const targetPage = Number.isInteger(page) ? page : currentPage;\n    if (targetPage == null) {\n      return;\n    }\n\n    this._scrollPositions[targetPage] = this._root.scrollTop || 0;\n  }\n\n  _render() {\n    if (!this._hass) {\n      console.warn(\"pp-reader-dashboard: noch kein hass, Ã¼berspringe _render()\");\n      return;\n    }\n    if (!this._initialized) {\n      console.debug(\"pp-reader-dashboard: _render aufgerufen bevor initialisiert\");\n      return;\n    }\n\n    // PrÃ¼fen, ob ein Render notwendig ist\n    const page = currentPage;\n    if (\n      !this._hasNewData && // Nur rendern, wenn neue Daten vorliegen\n      this._panel === this._lastPanel &&\n      this._narrow === this._lastNarrow &&\n      this._route === this._lastRoute &&\n      this._lastPage === page\n    ) {\n      // console.log(\"pp-reader-dashboard: keine Ã„nderungen â†’ skip render\");\n      return;\n    }\n\n    // Alte Scroll-Position merken (pro Tab)\n    if (this._lastPage != null) {\n      this._scrollPositions[this._lastPage] = this._root.scrollTop;\n    }\n\n    const maybePromise = renderTab(this._root, this._hass, this._panel);\n    if (maybePromise && typeof maybePromise.then === \"function\") {\n      maybePromise\n        .then(() => {\n          this._afterRender(page);\n        })\n        .catch((error) => {\n          console.error(\"PPReaderDashboard: Fehler beim Rendern des Tabs\", error);\n          this._afterRender(page);\n        });\n    } else {\n      this._afterRender(page);\n    }\n  }\n\n  _afterRender(page) {\n    if (!this._root) {\n      return;\n    }\n\n    const restore = this._scrollPositions[page] || 0;\n    this._root.scrollTop = restore;\n\n    this._lastPanel = this._panel;\n    this._lastNarrow = this._narrow;\n    this._lastRoute = this._route;\n    this._lastPage = page;\n\n    try {\n      this._reapplyPendingUpdates();\n    } catch (error) {\n      console.error(\"PPReaderDashboard: Fehler beim Wiederanlegen der Updates\", error);\n    }\n\n    this._hasNewData = false;\n  }\n}\n\nif (!customElements.get('pp-reader-dashboard')) {\n  customElements.define('pp-reader-dashboard', PPReaderDashboard);\n}\n\nconsole.log(\"PPReader dashboard.js v20250914b geladen\");\n\nregisterSecurityDetailTab({\n  setSecurityDetailTabFactory,\n});\n"],"names":["addSwipeEvents","element","onSwipeLeft","onSwipeRight","startX","e","deltaX","formatValue","key","value","row","context","formatted","toNumber","v","cleaned","parsed","safeNumber","minFrac","maxFrac","num","renderMissingValue","reason","title","missingReason","numeric","symbol","cls","hasFraction","makeTable","rows","cols","sumColumns","options","sortable","defaultSort","escapeAttribute","html","c","alignClass","r","sums","sumMeta","total","hasValue","aggregatedGainPct","aggregatedGainPctLabel","aggregatedGainPctSign","formatNumber","idx","extraAttributes","fallbackContext","tpl","table","createHeaderCard","headerTitle","meta","headerCard","formatGain","formatGainPct","sortTableRows","tableEl","dir","isPositions","tbody","footer","colIdx","ths","i","txt","a","b","_a","_b","aTxt","bTxt","aNum","bNum","cmp","th","activeTh","deriveEntryId","hass","panelConfig","_c","_d","_e","_f","_g","_h","entry_id","candidate","p","getEntryId","fetchAccountsWS","fetchLastFileUpdateWS","response","fetchPortfoliosWS","fetchPortfolioPositionsWS","portfolio_uuid","fetchSecuritySnapshotWS","securityUuid","fetchSecurityHistoryWS","payload","startDate","endDate","start_date_raw","end_date_raw","resolvedStart","resolvedEnd","PENDING_RETRY_INTERVAL","PENDING_MAX_ATTEMPTS","PORTFOLIO_POSITIONS_UPDATED_EVENT","ensurePendingMap","ensurePendingRetryMeta","renderPositionsError","error","portfolioUuid","restoreSortAndInit","containerEl","rootEl","pid","applyPortfolioPositionsToDom","root","positions","detailsRow","container","prevKey","prevDir","renderPositionsTableInline","flushPendingPositions","pendingMap","pending","result","flushAllPendingPositions","appliedAny","schedulePendingRetry","retryMetaMap","success","handleAccountUpdate","update","updatedAccounts","updateAccountTable","portfolioTable","portfolios","currentValueCell","updateTotalWealth","accounts","eurContainer","fxContainer","eurAccounts","fxAccounts","handlePortfolioUpdate","val","rowMap","patched","formatPositionCount","u","posCountCell","curValCell","gainAbsCell","gainPctCell","posCount","curVal","purchase","gainAbs","gainPct","oldCur","parseNumLoose","updatePortfolioFooter","findTable","selectors","selector","eurTable","fxTable","extractAccounts","tbl","isFx","accountRows","cell","portfolioDomValues","cv","gain","ps","normalizePortfolioUuid","direct","camelCase","processPortfolioPositionsUpdate","cache","securityUuids","pos","uuid","dispatchError","handlePortfolioPositionsUpdate","handled","item","raw","colKeys","tr","err","gainCell","pctCell","pctText","pctSign","helper","sumCurrent","sumGainAbs","sumPurchase","sumPositions","datasetCount","datasetCurrent","currentValue","datasetGain","datasetPurchase","sumGainPct","sumPositionsDisplay","footerGainAbsCell","targetRoot","accountSum","acc","entry","portfolioSum","totalWealth","headerMeta","valueElement","handleLastFileUpdate","el","metaHost","reapplyPositionsSort","_hassRef","_panelConfigRef","portfolioPositionsCache","HOLDINGS_PRECISION","toFiniteNumber","roundCurrency","finite","roundHoldings","collectSecurityPositions","matches","getSecurityPositionsFromCache","getSecuritySnapshotFromCache","name","totalHoldings","totalPurchaseValue","totalCurrentValue","lastPriceEur","expandedPortfolios","applyGainPctMetadata","renderPositionsTable","attachSecurityDetailDelegation","event","interactive","openSecurityDetail","attachSecurityDetailListener","buildExpandablePortfolioTable","depots","align","d","positionCount","purchaseSum","expanded","toggleClass","detailId","rowData","valueContext","gainPctLabel","gainPctSign","datasetCurrentValue","datasetGainAbs","datasetGainPct","gainAbsAttributes","availableDepots","current","sumHasValue","sumRowData","sumContext","sumCurrentCell","sumGainAbsCell","sumGainPctCell","sumGainAbsAttributes","sumGainPctLabel","sumGainPctSign","resolvePortfolioTable","target","readDatasetNumber","extractNumericFromCell","updatePortfolioFooterFromDom","missingRows","hasValueAttr","purchaseSumDataset","child","currentValueHtml","gainAbsHtml","gainPctHtml","attachPortfolioPositionsSorting","applySort","parseNum","aCell","bCell","comp","currentKey","currentDir","reloadPortfolioPositions","targetContainer","resp","waitForElement","timeoutMs","intervalMs","start","resolve","tick","attachPortfolioToggleHandler","token","retryBtn","cont","btn","caretEl","pendingApplied","ensurePortfolioRowFallbackListener","renderDashboard","accountsResp","missingPositions","hasCurrentValue","baseCurrentValue","purchase_sum","current_value","gain_abs","gain_pct","lastFileUpdate","totalAccounts","sum","account","anyPortfolioMissing","depot","totalDepots","missingWealthReason","wealthValueMarkup","wealthNote","portfolioTableHtml","fxWarning","accountsHtml","footerCard","markup","schedulePostRenderSetup","run","wrapper","tableHost","footerErr","pendingErr","schedule","cb","SVG_NS","DEFAULT_WIDTH","DEFAULT_HEIGHT","DEFAULT_MARGIN","DEFAULT_COLOR","DEFAULT_AREA","DEFAULT_TICK_FONT","ONE_DAY_MS","createSvgElement","tag","attrs","fallback","toTimestamp","index","timestamp","defaultXFormatter","dataPoint","date","defaultYFormatter","defaultTooltipRenderer","xFormatted","yFormatted","ensureChartState","clamp","min","max","buildAreaPath","points","baselineY","moveLine","point","closing","buildLinePath","computePoints","series","dimensions","accessors","width","height","margin","xAccessor","yAccessor","rawPoints","rawX","rawY","xValue","yValue","minX","maxX","minY","maxY","boundedWidth","boundedHeight","safeMinX","safeMaxX","safeMinY","safeMaxY","desiredYTicks","domainMinY","domainMaxY","computeNiceDomain","effectiveMinY","effectiveMaxY","rangeX","rangeY","ratioX","ratioY","x","y","assignDimensions","state","formatTooltip","updateTooltipPosition","pointerY","tooltip","tooltipWidth","tooltipHeight","horizontal","maxVertical","padding","anchorY","vertical","hideTooltip","focusLine","focusCircle","attachPointerHandlers","handlePointerMove","rect","pointerX","closest","minDistance","distance","handlePointerLeave","renderLineChart","svg","areaPath","linePath","overlay","xAxis","yAxis","updateLineChart","range","updateAxes","lineD","areaD","yFormatter","hasValidX","hasValidY","effectiveWidth","effectiveHeight","rangeDays","desiredTicks","generateTimeAxisTicks","positionRatio","label","ratio","yAxisWidth","generateNumericAxisTicks","top","minValue","maxValue","safeTicks","niceStep","rawStep","step","niceMin","niceMax","minTimestamp","maxTimestamp","formatXAxisLabel","tickCount","ticks","end","_","exponent","fraction","niceFraction","HOLDINGS_FRACTION_DIGITS","PRICE_FRACTION_DIGITS","PRICE_SCALE","DEFAULT_HISTORY_RANGE","AVAILABLE_HISTORY_RANGES","RANGE_DAY_COUNTS","SECURITY_HISTORY_CACHE","RANGE_STATE_REGISTRY","LIVE_UPDATE_EVENT","LIVE_UPDATE_HANDLERS","buildCachedSnapshotNotice","fallbackUsed","flaggedAsCache","reasons","getCachedSecuritySnapshot","getter","snapshot","ensureHistoryCache","invalidateHistoryCache","handleLiveUpdateForSecurity","detail","ensureLiveUpdateSubscription","handler","removeLiveUpdateSubscription","cleanupSecurityDetailState","setActiveRange","rangeKey","getActiveRange","toEpochDay","epochMs","normaliseDate","clone","resolveRangeOptions","now","parseHistoryDate","trimmed","year","month","day","normaliseHistorySeries","prices","rawClose","deriveFxRate","latestNativePrice","currency","lastPriceEurRaw","snapshotNativeRaw","snapshotNative","historyNative","rounded","computeGainValues","historySeries","holdings","fxRate","holdingsNumeric","safeHoldings","safeFx","lastEntry","firstEntry","previousEntry","periodDiff","dailyDiff","formatGainValue","buildInfoBar","periodGain","dailyGain","rangeLabel","buildRangeSelector","activeRange","buildHistoryPlaceholder","safeRange","message","formatHoldings","minFraction","maxFraction","formatPrice","buildHeaderMeta","lastPriceNative","formattedLastPrice","lastPriceDisplay","marketValue","normaliseHistoryError","renderSecurityDetail","cachedSnapshot","effectiveSnapshot","staleNotice","historyState","rangeOptions","historyResponse","historyError","infoBar","scheduleRangeSetup","updateRangeButtons","button","isActive","updateInfoBarContent","fresh","HISTORY_CHART_INSTANCES","getHistoryChartOptions","host","measuredWidth","safeCurrency","renderHistoryChart","chartOptions","chartContainer","updateHistoryPlaceholder","placeholderContainer","initialRange","initialHistory","initialHistoryState","rangeSelector","handleRangeClick","lastClose","activeFxRate","registerSecurityDetailTab","setSecurityDetailTabFactory","STICKY_HEADER_ANCHOR_ID","OVERVIEW_TAB_KEY","baseTabs","detailTabRegistry","detailTabOrder","securityTabLookup","SECURITY_DETAIL_TAB_PREFIX","extractSecurityUuidFromKey","securityDetailTabFactory","navigationInProgress","lastClosedSecurityUuid","tryReopenLastDetail","reopened","getVisibleTabs","detailTabs","rememberCurrentPageScroll","dashboardElement","findDashboardElement","clampPageIndex","tabs","navigateToPage","targetIndex","panel","clampedIndex","currentPage","currentTab","currentSecurityUuid","nextIndex","intendedTarget","closeSecurityDetail","overviewIndex","tab","renderTab","navigateByDelta","delta","registerDetailTab","descriptor","existingKey","unregisterDetailTab","normalizedDescriptor","hasDetailTab","getDetailTabDescriptor","factory","getSecurityDetailTabKey","registered","panelElements","panelElement","nested","requestDashboardRender","tabKey","maybeDescriptor","suppressRender","tabIndexBefore","wasActive","tabsAfter","observer","effectivePanel","content","interval","anchor","setupNavigation","setupSwipeOnHeaderCard","setupHeaderScrollBehavior","scrollBorder","navLeft","navRight","updateNavigationState","shouldEnable","PPReaderDashboard","narrow","route","entryId","conn","eventTypes","subs","et","unsub","f","currentEntryId","dataType","pushedData","data","page","targetPage","maybePromise","restore"],"mappings":"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"}