var Vn=Object.defineProperty;var qn=(e,t,n)=>t in e?Vn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var V=(e,t,n)=>qn(e,typeof t!="symbol"?t+"":t,n);function St(e,t){try{t()}catch(n){console.warn(`addSwipeEvents: ${e} handler threw`,n)}}function Wn(e,t,n){let r=null;const i=s=>{s<-50?St("left",t):s>50&&St("right",n)},a=s=>{s.touches.length===1&&(r=s.touches[0].clientX)},o=s=>{if(r===null)return;if(s.changedTouches.length===0){r=null;return}const d=s.changedTouches[0];i(d.clientX-r),r=null},c=s=>{r=s.clientX},l=s=>{r!==null&&(i(s.clientX-r),r=null)};e.addEventListener("touchstart",a,{passive:!0}),e.addEventListener("touchend",o,{passive:!0}),e.addEventListener("mousedown",c),e.addEventListener("mouseup",l)}const dt=(e,t)=>{if(!Number.isFinite(e)||e===0)return"neutral";const n=.5/Math.pow(10,t);return Math.abs(e)<n?"neutral":e>0?"positive":"negative"};function I(e,t,n=void 0,r=void 0){let i=null;const a=l=>{if(typeof l=="number")return l;if(typeof l=="string"&&l.trim()!==""){const s=l.replace(/\s+/g,"").replace(/[^0-9,.-]/g,"").replace(/\.(?=\d{3}(\D|$))/g,"").replace(",","."),d=Number.parseFloat(s);return Number.isNaN(d)?Number.NaN:d}return Number.NaN},o=(l,s=2,d=2)=>{const u=typeof l=="number"?l:a(l);return Number.isFinite(u)?u.toLocaleString("de-DE",{minimumFractionDigits:s,maximumFractionDigits:d}):""},c=(l="")=>{const s=l||"Kein Wert verfügbar";return`<span class="missing-value" role="note" aria-label="${s}" title="${s}">—</span>`};if(["gain_abs","gain_pct"].includes(e)){if(t==null&&n){const f=n.performance;if(typeof f=="object"&&f!==null){const p=f[e];typeof p=="number"&&(t=p)}}const l=(n==null?void 0:n.fx_unavailable)===!0?"Wechselkurs nicht verfügbar – EUR-Wert unbekannt":"";if(t==null||(r==null?void 0:r.hasValue)===!1)return c(l);const s=typeof t=="number"?t:a(t);if(!Number.isFinite(s))return c(l);const d=e==="gain_pct"?"%":"€";return i=o(s)+`&nbsp;${d}`,`<span class="${dt(s,2)}">${i}</span>`}else if(e==="position_count"){const l=typeof t=="number"?t:a(t);if(!Number.isFinite(l))return c();i=l.toLocaleString("de-DE")}else if(["balance","current_value","purchase_value"].includes(e)){const l=typeof t=="number"?t:a(t);if(!Number.isFinite(l))return n!=null&&n.fx_unavailable?c("Wechselkurs nicht verfügbar – EUR-Wert unbekannt"):(r&&r.hasValue===!1,c());i=o(l)+"&nbsp;€"}else if(e==="current_holdings"){const l=typeof t=="number"?t:a(t);if(!Number.isFinite(l))return c();const s=Math.abs(l%1)>0;i=l.toLocaleString("de-DE",{minimumFractionDigits:s?2:0,maximumFractionDigits:4})}else{let l="";typeof t=="string"?l=t:typeof t=="number"&&Number.isFinite(t)?l=t.toString():typeof t=="boolean"?l=t?"true":"false":t instanceof Date&&Number.isFinite(t.getTime())&&(l=t.toISOString()),i=l,i&&(i.length>60&&(i=i.slice(0,59)+"…"),i.startsWith("Kontostand ")?i=i.substring(11):i.startsWith("Depotwert ")&&(i=i.substring(10)))}return typeof i!="string"||i===""?c():i}function ne(e,t,n=[],r={}){const{sortable:i=!1,defaultSort:a}=r,o=(a==null?void 0:a.key)??"",c=(a==null?void 0:a.dir)==="desc"?"desc":"asc",l=h=>{if(h==null)return"";let m="";if(typeof h=="string")m=h;else if(typeof h=="number"&&Number.isFinite(h))m=h.toString();else if(typeof h=="boolean")m=h?"true":"false";else if(h instanceof Date&&Number.isFinite(h.getTime()))m=h.toISOString();else return"";return m.replace(/&/g,"&amp;").replace(/"/g,"&quot;")};let s="<table><thead><tr>";t.forEach(h=>{const m=h.align==="right"?' class="align-right"':"";i&&h.key?s+=`<th${m} data-sort-key="${h.key}">${h.label}</th>`:s+=`<th${m}>${h.label}</th>`}),s+="</tr></thead><tbody>",e.forEach(h=>{s+="<tr>",t.forEach(m=>{const v=m.align==="right"?' class="align-right"':"";s+=`<td${v}>${I(m.key,h[m.key],h)}</td>`}),s+="</tr>"});const d={},u={};t.forEach(h=>{if(n.includes(h.key)){const m=e.reduce((v,y)=>{let P=y[h.key];if((h.key==="gain_abs"||h.key==="gain_pct")&&(typeof P!="number"||!Number.isFinite(P))){const E=y.performance;if(typeof E=="object"&&E!==null){const w=E[h.key];typeof w=="number"&&(P=w)}}if(typeof P=="number"&&Number.isFinite(P)){const E=P;v.total+=E,v.hasValue=!0}return v},{total:0,hasValue:!1});m.hasValue?(d[h.key]=m.total,u[h.key]={hasValue:!0}):(d[h.key]=null,u[h.key]={hasValue:!1})}});const f=d.gain_abs??null;if(f!=null){const h=d.purchase_value??null;if(h!=null&&h>0)d.gain_pct=f/h*100;else{const m=d.current_value??null;m!=null&&m!==0&&(d.gain_pct=f/(m-f)*100)}}const p=Number.isFinite(d.gain_pct??NaN)?d.gain_pct:null;let g="",_="neutral";if(p!=null&&(g=`${K(p)} %`,p>0?_="positive":p<0&&(_="negative")),s+='<tr class="footer-row">',t.forEach((h,m)=>{const v=h.align==="right"?' class="align-right"':"";if(m===0){s+=`<td${v}>Summe</td>`;return}if(d[h.key]!=null){let P="";h.key==="gain_abs"&&g&&(P=` data-gain-pct="${l(g)}" data-gain-sign="${l(_)}"`),s+=`<td${v}${P}>${I(h.key,d[h.key],void 0,u[h.key])}</td>`;return}if(h.key==="gain_pct"&&d.gain_pct!=null){s+=`<td${v}>${I("gain_pct",d.gain_pct,void 0,u[h.key])}</td>`;return}const y=u[h.key]??{hasValue:!1};s+=`<td${v}>${I(h.key,null,void 0,y)}</td>`}),s+="</tr>",s+="</tbody></table>",i)try{const h=document.createElement("template");h.innerHTML=s.trim();const m=h.content.querySelector("table");if(m)return m.classList.add("sortable-table"),o&&(m.dataset.defaultSort=o,m.dataset.defaultDir=c),m.outerHTML}catch(h){console.warn("makeTable(sortable): Injection fehlgeschlagen:",h)}return s}function Ze(e,t){const n=document.createElement("div");return n.className="header-card",n.innerHTML=`
    <div class="header-content">
      <button id="nav-left" class="nav-arrow" aria-label="Vorherige Seite">
        <svg viewBox="0 0 24 24">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
        </svg>
      </button>
      <h1 id="headerTitle">${e}</h1>
      <button id="nav-right" class="nav-arrow" aria-label="Nächste Seite">
        <svg viewBox="0 0 24 24">
          <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
        </svg>
      </button>
    </div>
    <div id="headerMeta" class="meta">${t}</div>
  `,n}function K(e,t=2,n=2){return(Number.isNaN(e)?0:e).toLocaleString("de-DE",{minimumFractionDigits:t,maximumFractionDigits:n})}function On(e){const t=Number.isNaN(e)?0:e;return`<span class="${dt(t,2)}">${K(t)}&nbsp;€</span>`}function zn(e){const t=Number.isNaN(e)?0:e;return`<span class="${dt(t,2)}">${K(t)}&nbsp;%</span>`}function Bn(e,t,n="asc",r=!1){if(!e)return[];const i=e.querySelector("tbody");if(!i)return[];const a=i.querySelector("tr.footer-row"),o=Array.from(i.querySelectorAll("tr")).filter(d=>d!==a);let c=-1;if(r){const u={name:0,current_holdings:1,purchase_value:2,current_value:3,gain_abs:4,gain_pct:5}[t];typeof u=="number"&&(c=u)}else{const d=Array.from(e.querySelectorAll("thead th"));for(let u=0;u<d.length;u++)if(d[u].getAttribute("data-sort-key")===t){c=u;break}}if(c<0)return o;const l=d=>{const u=d.replace(/\u00A0/g," ").replace(/[%€]/g,"").replace(/\./g,"").replace(/,/g,".").replace(/[^\d.-]/g,"").trim();if(!u)return NaN;const f=parseFloat(u);return Number.isFinite(f)?f:NaN};o.sort((d,u)=>{const f=d.cells.item(c),p=u.cells.item(c),g=((f==null?void 0:f.textContent)??"").trim(),_=((p==null?void 0:p.textContent)??"").trim(),h=l(g),m=l(_);let v;const y=/[0-9]/.test(g)||/[0-9]/.test(_);return!Number.isNaN(h)&&!Number.isNaN(m)&&y?v=h-m:v=g.localeCompare(_,"de",{sensitivity:"base"}),n==="asc"?v:-v}),o.forEach(d=>i.appendChild(d)),a&&i.appendChild(a),e.querySelectorAll("thead th.sort-active").forEach(d=>{d.classList.remove("sort-active","dir-asc","dir-desc")});const s=e.querySelector(`thead th[data-sort-key="${t}"]`);return s&&s.classList.add("sort-active",n==="asc"?"dir-asc":"dir-desc"),o}function Z(e,t){var r,i,a,o,c,l,s,d;let n=((r=t==null?void 0:t.config)==null?void 0:r.entry_id)??(t==null?void 0:t.entry_id)??((o=(a=(i=t==null?void 0:t.config)==null?void 0:i._panel_custom)==null?void 0:a.config)==null?void 0:o.entry_id)??void 0;if(!n&&(e!=null&&e.panels)){const u=e.panels,f=u.ppreader??u.pp_reader??Object.values(u).find(p=>(p==null?void 0:p.webcomponent_name)==="pp-reader-panel");n=((c=f==null?void 0:f.config)==null?void 0:c.entry_id)??(f==null?void 0:f.entry_id)??((d=(s=(l=f==null?void 0:f.config)==null?void 0:l._panel_custom)==null?void 0:s.config)==null?void 0:d.entry_id)??void 0}return n??void 0}function Pt(e,t){return Z(e,t)}async function Gn(e,t){if(!e)throw new Error("fetchAccountsWS: fehlendes hass");const n=Z(e,t);if(!n)throw new Error("fetchAccountsWS: fehlendes entry_id");return e.connection.sendMessagePromise({type:"pp_reader/get_accounts",entry_id:n})}async function Kn(e,t){if(!e)throw new Error("fetchLastFileUpdateWS: fehlendes hass");const n=Z(e,t);if(!n)throw new Error("fetchLastFileUpdateWS: fehlendes entry_id");const r=await e.connection.sendMessagePromise({type:"pp_reader/get_last_file_update",entry_id:n});if(typeof r=="string")return r;const i=r.last_file_update;return typeof i=="string"?i:""}async function Yn(e,t){if(!e)throw new Error("fetchPortfoliosWS: fehlendes hass");const n=Z(e,t);if(!n)throw new Error("fetchPortfoliosWS: fehlendes entry_id");return e.connection.sendMessagePromise({type:"pp_reader/get_portfolio_data",entry_id:n})}async function qt(e,t,n){if(!e)throw new Error("fetchPortfolioPositionsWS: fehlendes hass");const r=Z(e,t);if(!r)throw new Error("fetchPortfolioPositionsWS: fehlendes entry_id");if(!n)throw new Error("fetchPortfolioPositionsWS: fehlendes portfolio_uuid");return e.connection.sendMessagePromise({type:"pp_reader/get_portfolio_positions",entry_id:r,portfolio_uuid:n})}async function jn(e,t,n){if(!e)throw new Error("fetchSecuritySnapshotWS: fehlendes hass");const r=Z(e,t);if(!r)throw new Error("fetchSecuritySnapshotWS: fehlendes entry_id");if(!n)throw new Error("fetchSecuritySnapshotWS: fehlendes securityUuid");return e.connection.sendMessagePromise({type:"pp_reader/get_security_snapshot",entry_id:r,security_uuid:n})}async function Wt(e,t,n,r={}){if(!e)throw new Error("fetchSecurityHistoryWS: fehlendes hass");const i=Z(e,t);if(!i)throw new Error("fetchSecurityHistoryWS: fehlendes entry_id");if(!n)throw new Error("fetchSecurityHistoryWS: fehlendes securityUuid");const a={type:"pp_reader/get_security_history",entry_id:i,security_uuid:n},{startDate:o,endDate:c,start_date:l,end_date:s}=r||{},d=o??l;d!=null&&(a.start_date=d);const u=c??s;return u!=null&&(a.end_date=u),e.connection.sendMessagePromise(a)}const Xn=new Set,Zn=new Set,Ot={},Jn=["renderPositionsTable","applyGainPctMetadata","attachSecurityDetailListener","attachPortfolioPositionsSorting","updatePortfolioFooter"];function Qn(e,t){typeof t=="function"&&(Ot[e]=t)}function er(){return Xn}function tr(){return Zn}function nr(e){for(const t of Jn)Qn(t,e[t])}function ft(){return Ot}const rr=2;function ke(e){var t;if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const n=e.trim().replace(/\u00a0/g,"");if(!n)return null;const r=Number(n);if(Number.isFinite(r))return r;const i=n.replace(/[^0-9.,+-]/g,"");if(!i)return null;const a=i.lastIndexOf(","),o=i.lastIndexOf(".");let c=i;const l=a!==-1,s=o!==-1;if(l&&(!s||a>o))if(s)c=c.replace(/\./g,"").replace(",",".");else{const f=c.split(","),p=((t=f[f.length-1])==null?void 0:t.length)??0,g=f.slice(0,-1).join(""),_=g.replace(/[+-]/g,"").length,h=f.length>2,m=/^[-+]?0$/.test(g);c=h||p===0||p===3&&_>0&&_<=3&&!m?c.replace(/,/g,""):c.replace(",",".")}else s&&l&&o>a?c=c.replace(/,/g,""):s&&c.length-o-1===3&&/\d{4,}/.test(c.replace(/\./g,""))&&(c=c.replace(/\./g,""));if(c==="-"||c==="+")return null;const d=Number.parseFloat(c);if(Number.isFinite(d))return d;const u=Number.parseFloat(i.replace(",","."));if(Number.isFinite(u))return u}return null}function He(e,{decimals:t=rr,fallback:n=null}={}){const r=ke(e);if(r==null)return n??null;const i=10**t,a=Math.round(r*i)/i;return Object.is(a,-0)?0:a}function re(e,t={}){return He(e,t)}function ir(e,t={}){return He(e,t)}const ar=/^[+-]?(?:\d+\.?\d*|\d*\.?\d+)(?:[eE][+-]?\d+)?$/,G=e=>{if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=e.trim();if(!t||!ar.test(t))return null;const n=Number(t);if(Number.isFinite(n))return n}return null},zt=e=>{if(typeof e!="string")return null;const t=e.trim();return t||null};function or(e){const t=e&&typeof e=="object"?e:null;if(!t)return null;const n=G(t.price_change_native),r=G(t.price_change_eur),i=G(t.change_pct);if(n==null&&r==null&&i==null)return null;const a=zt(t.source)??"derived",o=G(t.coverage_ratio)??null;return{price_change_native:n,price_change_eur:r,change_pct:i,source:a,coverage_ratio:o}}function X(e){const t=e&&typeof e=="object"?e:null;if(!t)return null;const n=G(t.gain_abs),r=G(t.gain_pct),i=G(t.total_change_eur),a=G(t.total_change_pct);if(n==null||r==null||i==null||a==null)return null;const o=zt(t.source)??"derived",c=G(t.coverage_ratio)??null,l=or(t.day_change);return{gain_abs:n,gain_pct:r,total_change_eur:i,total_change_pct:a,source:o,coverage_ratio:c,day_change:l}}const Pe=new Map;function Bt(e){return{...e}}function ht(e,t){if(!e)return;if(!Array.isArray(t)){Pe.delete(e);return}const n=t.filter(r=>!!r).map(Bt);Pe.set(e,n)}function pt(e){return e?Pe.has(e):!1}function Gt(e){if(!e)return[];const t=Pe.get(e);return t?t.map(Bt):[]}const ie=new Map,Oe=new Map;function sr(e){if(typeof e=="string"){const t=e.trim();return t.length>0?t:"Unbekannter Fehler"}if(e instanceof Error){const t=e.message.trim();return t.length>0?t:"Unbekannter Fehler"}if(e!=null)try{const t=JSON.stringify(e);if(t&&t!=="{}")return t}catch{}return"Unbekannter Fehler"}function Ae(e){if(typeof e!="string")return null;const t=e.trim();return t.length>0?t:null}function Je(e){return X(e.performance)}function cr(e){return!e||typeof e!="object"?null:{...e}}function lr(e){return!e||typeof e!="object"?null:{...e}}function ur(e){const t=Ae(e.security_uuid),n=Ae(e.name),r=ke(e.current_holdings),i=re(e.purchase_value),a=re(e.current_value);if(!t||!n||r==null||i==null||a==null)return null;const o=cr(e.aggregation),c=lr(e.average_cost),l=Je(e),s=typeof(l==null?void 0:l.gain_abs)=="number"?l.gain_abs:null,d=typeof(l==null?void 0:l.gain_pct)=="number"?l.gain_pct:null;return{...e,security_uuid:t,name:n,current_holdings:r,purchase_value:i,current_value:a,average_cost:c,aggregation:o,performance:l,gain_abs:s,gain_pct:d}}function dr(e){const t=[];for(const n of e){const r=ur(n);r&&t.push(r)}return t}const fr=500,hr=10,pr="pp-reader:portfolio-positions-updated";function gr(e,t){return`<div class="error">${sr(e)} <button class="retry-pos" data-portfolio="${t}">Erneut laden</button></div>`}function mr(e,t,n){const r=e.querySelector("table.sortable-positions");if(!r)return;const i=e.dataset.sortKey||r.dataset.defaultSort||"name",o=(e.dataset.sortDir||r.dataset.defaultDir||"asc")==="desc"?"desc":"asc";e.dataset.sortKey=i,e.dataset.sortDir=o;try{Bn(r,i,o,!0)}catch(s){console.warn("restoreSortAndInit: sortTableRows Fehler:",s)}const{attachPortfolioPositionsSorting:c,attachSecurityDetailListener:l}=ft();if(c)try{c(t,n)}catch(s){console.warn("restoreSortAndInit: attachPortfolioPositionsSorting Fehler:",s)}if(l)try{l(t,n)}catch(s){console.warn("restoreSortAndInit: attachSecurityDetailListener Fehler:",s)}}function Kt(e,t,n,r){if(!e||!t)return{applied:!1,reason:"invalid"};const i=e.querySelector(`.portfolio-table .portfolio-details[data-portfolio="${t}"]`);if(!i)return{applied:!1,reason:"missing"};const a=i.querySelector(".positions-container");if(!a)return{applied:!1,reason:"missing"};if(i.classList.contains("hidden"))return{applied:!1,reason:"hidden"};if(r)return a.innerHTML=gr(r,t),{applied:!0};const o=a.dataset.sortKey,c=a.dataset.sortDir;return a.innerHTML=Ar(n),o&&(a.dataset.sortKey=o),c&&(a.dataset.sortDir=c),mr(a,e,t),{applied:!0}}function gt(e,t){const n=ie.get(t);if(!n)return!1;const r=Kt(e,t,n.positions,n.error);return r.applied&&ie.delete(t),r.applied}function br(e){let t=!1;for(const[n]of ie)gt(e,n)&&(t=!0);return t}function Yt(e,t){const n=Oe.get(t)??{attempts:0,timer:null};n.timer||(n.timer=setTimeout(()=>{n.timer=null,n.attempts+=1;const r=gt(e,t);r||n.attempts>=hr?(Oe.delete(t),r||ie.delete(t)):Yt(e,t)},fr),Oe.set(t,n))}function yr(e,t){console.log("updateConfigsWS: Kontodaten-Update erhalten:",e);const n=Array.isArray(e)?e:[];if(!t)return;_r(n,t);const r=t.querySelector(".portfolio-table table"),i=r?Array.from(r.querySelectorAll("tbody tr:not(.footer-row)")).map(a=>{const o=a.cells.item(2),c=(o==null?void 0:o.textContent)??"",l=parseFloat(c.replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""));return{current_value:Number.isFinite(l)?l:0}}):[];jt(n,i,t)}function _r(e,t){const n=t.querySelector(".account-table"),r=t.querySelector(".fx-account-table"),i=e.filter(o=>(o.currency_code||"EUR")==="EUR"),a=e.filter(o=>(o.currency_code||"EUR")!=="EUR");n?n.innerHTML=ne(i,[{key:"name",label:"Name"},{key:"balance",label:"Kontostand (EUR)",align:"right"}],["balance"]):console.warn("updateAccountTable: .account-table nicht gefunden."),r?r.innerHTML=ne(a.map(o=>{const c=o.orig_balance,l=typeof c=="number"&&Number.isFinite(c),s=Ae(o.currency_code),d=l?c.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):null,u=d?s?`${d} ${s}`:d:"";return{...o,fx_display:u}}),[{key:"name",label:"Name"},{key:"fx_display",label:"Betrag (FX)"},{key:"balance",label:"EUR",align:"right"}],["balance"]):a.length&&console.warn("updateAccountTable: .fx-account-table nicht gefunden, obwohl FX-Konten vorhanden sind.")}function vr(e,t){if(!Array.isArray(e)){console.warn("handlePortfolioUpdate: Update ist kein Array:",e);return}try{console.debug("handlePortfolioUpdate: payload=",e)}catch{}if(!t)return;const n=t.querySelector(".portfolio-table table")||t.querySelector("table.expandable-portfolio-table");if(!n){!t.querySelector(".portfolio-table")&&(t.querySelector(".security-range-selector")||t.querySelector(".security-detail-placeholder"))?console.debug("handlePortfolioUpdate: Übersicht nicht aktiv – Update wird später angewendet."):console.warn("handlePortfolioUpdate: Keine Portfolio-Tabelle gefunden.");return}const r=n.tBodies.item(0)??n.querySelector("tbody");if(!r){console.warn("handlePortfolioUpdate: Kein <tbody> in Tabelle.");return}const i=s=>{if(typeof Intl<"u")try{const u=typeof navigator<"u"&&navigator.language?navigator.language:"de-DE";return new Intl.NumberFormat(u,{minimumFractionDigits:2,maximumFractionDigits:2}).format(s)}catch{}return(He(s,{fallback:0})??0).toFixed(2).replace(".",",")},a=new Map;r.querySelectorAll("tr.portfolio-row").forEach(s=>{const d=s.dataset.portfolio;d&&a.set(d,s)});let c=0;const l=s=>{const d=typeof s=="number"&&Number.isFinite(s)?s:0;try{return d.toLocaleString("de-DE")}catch{return d.toString()}};for(const s of e){const d=s.uuid;if(typeof d!="string"||!d)continue;const u=a.get(d);if(!u||u.cells.length<3)continue;const f=u.cells.item(1),p=u.cells.item(2),g=u.cells.item(3),_=u.cells.item(4);if(!f||!p)continue;const h=Fe(s.position_count??s.count),m=Fe(s.current_value??s.value),v=s,y=X(v.performance),P=typeof(y==null?void 0:y.gain_abs)=="number"?y.gain_abs:null,E=typeof(y==null?void 0:y.gain_pct)=="number"?y.gain_pct:null,w=s.purchase_sum??s.purchaseSum??null,b=typeof w=="number"&&Number.isFinite(w)?w:null,A=ze(p.textContent);ze(f.textContent)!==h&&(f.textContent=l(h));const x=Number.isFinite(m),T={fx_unavailable:!!v.fx_unavailable,current_value:x?m:null,performance:y},$={hasValue:x},M=I("current_value",T.current_value,T,$);if((Math.abs(A-m)>=.005||p.innerHTML!==M)&&(p.innerHTML=M,u.classList.add("flash-update"),setTimeout(()=>{u.classList.remove("flash-update")},800)),g){const R=I("gain_abs",P,T,$);g.innerHTML=R;const F=typeof E=="number"&&Number.isFinite(E)?E:null;g.dataset.gainPct=F!=null?`${i(F)} %`:"—",g.dataset.gainSign=F!=null?F>0?"positive":F<0?"negative":"neutral":"neutral"}_&&(_.innerHTML=I("gain_pct",E,T,$)),u.dataset.positionCount=h.toString(),u.dataset.currentValue=x?m.toString():"",u.dataset.purchaseSum=b!=null?b.toString():"",u.dataset.gainAbs=P!=null?P.toString():"",u.dataset.gainPct=E!=null?E.toString():"",c+=1}if(c===0)console.debug("handlePortfolioUpdate: Keine passenden Zeilen gefunden / keine Änderungen.");else{const s=c.toLocaleString("de-DE");console.debug(`handlePortfolioUpdate: ${s} Zeile(n) gepatcht.`)}try{Fr(n)}catch(s){console.warn("handlePortfolioUpdate: Fehler bei Summen-Neuberechnung:",s)}try{const s=(..._)=>{for(const h of _){if(!h)continue;const m=t.querySelector(h);if(m)return m}return null},d=s(".account-table table",".accounts-eur-table table",".accounts-table table"),u=s(".fx-account-table table",".accounts-fx-table table"),f=(_,h)=>{if(!_)return[];const m=_.querySelectorAll("tbody tr.account-row");return(m.length?Array.from(m):Array.from(_.querySelectorAll("tbody tr:not(.footer-row)"))).map(y=>{const P=h?y.cells.item(2):y.cells.item(1);return{balance:ze(P==null?void 0:P.textContent)}})},p=[...f(d,!1),...f(u,!0)],g=Array.from(n.querySelectorAll("tbody tr.portfolio-row")).map(_=>{const h=_.dataset.currentValue,m=_.dataset.purchaseSum,v=h?Number.parseFloat(h):Number.NaN,y=m?Number.parseFloat(m):Number.NaN;return{current_value:Number.isFinite(v)?v:0,purchase_sum:Number.isFinite(y)?y:0}});jt(p,g,t)}catch(s){console.warn("handlePortfolioUpdate: Fehler bei Total-Neuberechnung:",s)}}function Sr(e){if(!e||typeof e!="object")return null;const t=e.portfolio_uuid;if(typeof t=="string"&&t)return t;const n=e.portfolioUuid;return typeof n=="string"&&n?n:null}function At(e,t){const n=Sr(e);if(!n)return console.warn("handlePortfolioPositionsUpdate: Ungültiges Update:",e),!1;const r=e==null?void 0:e.error,i=Array.isArray(e==null?void 0:e.positions)?e.positions.filter(c=>!!c):[],a=dr(i);r||ht(n,a);const o=Kt(t,n,a,r);if(o.applied?ie.delete(n):(ie.set(n,{positions:a,error:r}),o.reason!=="hidden"&&Yt(t,n)),!r&&a.length>0){const c=Array.from(new Set(a.map(l=>l.security_uuid).filter(l=>typeof l=="string"&&l.length>0)));if(c.length&&typeof window<"u")try{window.dispatchEvent(new CustomEvent(pr,{detail:{portfolioUuid:n,securityUuids:c}}))}catch(l){console.warn("handlePortfolioPositionsUpdate: Dispatch des Portfolio-Events fehlgeschlagen",l)}}return!0}function Pr(e,t){if(Array.isArray(e)){let n=!1;for(const r of e)At(r,t)&&(n=!0);!n&&e.length&&console.warn("handlePortfolioPositionsUpdate: Kein gültiges Element im Array:",e);return}At(e,t)}function Ar(e){const{renderPositionsTable:t,applyGainPctMetadata:n}=ft();try{if(typeof t=="function")return t(e)}catch{}if(e.length===0)return'<div class="no-positions">Keine Positionen vorhanden.</div>';const r=e.map(a=>{const o=Je(a);return{name:a.name,current_holdings:a.current_holdings,purchase_value:a.purchase_value,current_value:a.current_value,performance:o}}),i=ne(r,[{key:"name",label:"Wertpapier"},{key:"current_holdings",label:"Bestand",align:"right"},{key:"purchase_value",label:"Kaufwert",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"+/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}],["purchase_value","current_value","gain_abs"]);try{const a=document.createElement("template");a.innerHTML=i.trim();const o=a.content.querySelector("table");if(o){o.classList.add("sortable-positions");const c=o.querySelectorAll("thead th"),l=["name","current_holdings","purchase_value","current_value","gain_abs","gain_pct"];c.forEach((u,f)=>{const p=l[f];p&&(u.setAttribute("data-sort-key",p),u.classList.add("sortable-col"))}),o.querySelectorAll("tbody tr").forEach((u,f)=>{if(u.classList.contains("footer-row"))return;const p=e[f];p.security_uuid&&(u.dataset.security=p.security_uuid),u.classList.add("position-row")}),o.dataset.defaultSort="name",o.dataset.defaultDir="asc";const d=n;if(d)try{d(o)}catch(u){console.warn("renderPositionsTableInline: applyGainPctMetadata failed",u)}else o.querySelectorAll("tbody tr").forEach((f,p)=>{if(f.classList.contains("footer-row"))return;const g=f.cells.item(4);if(!g)return;const _=e[p],h=Je(_),m=typeof(h==null?void 0:h.gain_pct)=="number"&&Number.isFinite(h.gain_pct)?h.gain_pct:null,v=m!=null?`${m.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})} %`:"—",y=m==null?"neutral":m>0?"positive":m<0?"negative":"neutral";g.dataset.gainPct=v,g.dataset.gainSign=y});return o.outerHTML}}catch(a){console.warn("renderPositionsTableInline: Sortier-Metadaten Injection fehlgeschlagen:",a)}return i}function Fr(e){var m;if(!e)return;const{updatePortfolioFooter:t}=ft();if(typeof t=="function")try{t(e);return}catch(v){console.warn("updatePortfolioFooter: helper schlug fehl:",v)}const n=Array.from(e.querySelectorAll("tbody tr.portfolio-row")),r=v=>{if(v===void 0)return null;const y=Number.parseFloat(v);return Number.isFinite(y)?y:null},i=n.reduce((v,y)=>{const P=r(y.dataset.positionCount);if(P!=null&&(v.sumPositions+=P),y.dataset.fxUnavailable==="true"&&(v.fxUnavailable=!0),y.dataset.hasValue!=="true")return v.incompleteRows+=1,v;v.valueRows+=1;const E=r(y.dataset.currentValue),w=r(y.dataset.gainAbs),b=r(y.dataset.purchaseSum);return E==null||w==null||b==null?(v.incompleteRows+=1,v):(v.sumCurrent+=E,v.sumGainAbs+=w,v.sumPurchase+=b,v)},{sumCurrent:0,sumGainAbs:0,sumPurchase:0,sumPositions:0,valueRows:0,incompleteRows:0,fxUnavailable:!1}),a=i.valueRows>0&&i.incompleteRows===0,o=a&&i.sumPurchase>0?i.sumGainAbs/i.sumPurchase*100:null;let c=e.querySelector("tr.footer-row");c||(c=document.createElement("tr"),c.className="footer-row",(m=e.querySelector("tbody"))==null||m.appendChild(c));const l=Math.round(i.sumPositions).toLocaleString("de-DE"),s={fx_unavailable:i.fxUnavailable||!a,current_value:a?i.sumCurrent:null,performance:a?{gain_abs:i.sumGainAbs,gain_pct:o,total_change_eur:i.sumGainAbs,total_change_pct:o,source:"aggregated",coverage_ratio:1}:null},d={hasValue:a},u=I("current_value",s.current_value,s,d),f=a?i.sumGainAbs:null,p=a?o:null,g=I("gain_abs",f,s,d),_=I("gain_pct",p,s,d);c.innerHTML=`
    <td>Summe</td>
    <td class="align-right">${l}</td>
    <td class="align-right">${u}</td>
    <td class="align-right">${g}</td>
    <td class="align-right">${_}</td>
  `;const h=c.cells.item(3);h&&(h.dataset.gainPct=a&&typeof o=="number"?`${Qe(o)} %`:"—",h.dataset.gainSign=a&&typeof o=="number"?o>0?"positive":o<0?"negative":"neutral":"neutral"),c.dataset.positionCount=Math.round(i.sumPositions).toString(),c.dataset.currentValue=a?i.sumCurrent.toString():"",c.dataset.purchaseSum=a?i.sumPurchase.toString():"",c.dataset.gainAbs=a?i.sumGainAbs.toString():"",c.dataset.gainPct=a&&typeof o=="number"?o.toString():"",c.dataset.hasValue=a?"true":"false",c.dataset.fxUnavailable=i.fxUnavailable||!a?"true":"false"}function Fe(e){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"){const t=Number.parseFloat(e);return Number.isFinite(t)?t:0}return 0}function Qe(e){return(He(e,{fallback:0})??0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}function jt(e,t,n){const r=n??document,a=(Array.isArray(e)?e:[]).reduce((u,f)=>{const p=f.balance??f.current_value??f.value??0;return u+Fe(p)},0),c=(Array.isArray(t)?t:[]).reduce((u,f)=>{const p=f.current_value??f.value??0;return u+Fe(p)},0),l=a+c,s=r.querySelector("#headerMeta");if(!s){console.warn("updateTotalWealth: #headerMeta nicht gefunden.");return}const d=s.querySelector("strong")||s.querySelector(".total-wealth-value");d?d.textContent=`${Qe(l)} €`:s.textContent=`💰 Gesamtvermögen: ${Qe(l)} €`,s.dataset.totalWealthEur=l.toString()}function Er(e,t){const n=typeof e=="string"?e:e==null?void 0:e.last_file_update,r=Ae(n)??"";if(!t){console.warn("handleLastFileUpdate: root fehlt");return}let i=t.querySelector(".footer-card .last-file-update")||t.querySelector(".last-file-update");if(!i){const a=t.querySelector(".footer-card .meta")||t.querySelector("#headerMeta")||t.querySelector(".header-card .meta")||t.querySelector(".header-card");if(!a){console.warn("handleLastFileUpdate: Kein Einfügepunkt gefunden.");return}i=document.createElement("div"),i.className="last-file-update",a.appendChild(i)}i.closest(".footer-card")?i.innerHTML=r?`📂 Letzte Aktualisierung der Datei: <strong>${r}</strong>`:"📂 Letzte Aktualisierung der Datei: <strong>Unbekannt</strong>":i.textContent=r?`📂 Letzte Aktualisierung: ${r}`:"📂 Letzte Aktualisierung: Unbekannt"}function ze(e){return e==null?0:parseFloat(e.replace(/\u00A0/g," ").replace(/[€%]/g,"").replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""))||0}const wr=["name","current_holdings","purchase_value","current_value","gain_abs","gain_pct"];function Be(e){return wr.includes(e)}function Ge(e){return e==="asc"||e==="desc"}let Ee=null,we=null;const Ft={min:2,max:6};function J(e){return ke(e)}function et(e){return typeof e=="number"&&Number.isFinite(e)}function Nr(e){if(typeof e!="string")return null;const t=e.trim();if(!t)return null;const n=t.toUpperCase();return/^[A-Z]{3}$/.test(n)?n:n==="€"?"EUR":null}function Et(e,t,n=null){const r=e;for(const i of t){const a=Nr(r[i]);if(a)return a}return n}function Xt(e){return typeof e=="object"&&e!==null}function xr(e){return"native"in e&&(typeof e.native=="number"||e.native===null)&&"security"in e&&(typeof e.security=="number"||e.security===null)&&"account"in e&&(typeof e.account=="number"||e.account===null)&&"eur"in e&&(typeof e.eur=="number"||e.eur===null)&&typeof e.source=="string"}function Zt(e){return Xt(e)&&xr(e)?e:null}function Dr(e){return typeof e.total_holdings=="number"&&typeof e.positive_holdings=="number"&&typeof e.purchase_value_cents=="number"&&typeof e.purchase_value_eur=="number"&&typeof e.security_currency_total=="number"&&typeof e.account_currency_total=="number"&&typeof e.purchase_total_security=="number"&&typeof e.purchase_total_account=="number"}function Jt(e){return Xt(e)&&Dr(e)?e:null}function Lr(e){const t=e,n=Zt(e.average_cost),r=Jt(e.aggregation),i=X(t.performance),a=typeof(i==null?void 0:i.gain_abs)=="number"?i.gain_abs:null,o=typeof(i==null?void 0:i.gain_pct)=="number"?i.gain_pct:null;return{...e,current_holdings:J(t.current_holdings),purchase_value:re(t.purchase_value),current_value:re(t.current_value),gain_abs:a,gain_pct:o,average_cost:n,aggregation:r,performance:i}}function Ke(e,t){return et(e)?`${e.toLocaleString("de-DE",{minimumFractionDigits:Ft.min,maximumFractionDigits:Ft.max})}${t?` ${t}`:""}`:null}function Tr(e){const t=Zt(e.average_cost),n=Jt(e.aggregation),r=Et(e,["security_currency_code","security_currency","native_currency_code","native_currency"]),i=Et(e,["account_currency_code","account_currency","purchase_currency_code","currency_code"])??(r==="EUR"?"EUR":null)??"EUR",a=J(t==null?void 0:t.native),o=J(t==null?void 0:t.security),c=J(t==null?void 0:t.account),l=J(t==null?void 0:t.eur),s=o??a,d=c??l;let u=s,f=r,p=Ke(s,r);p||(u=d,f=i,p=Ke(d,i));const g=Ke(d,i),_=g!==null&&(p==null||!f||!i||i!==f||et(d)&&et(u)&&Math.abs(d-u)>1e-6),h=[],m=[];p?(h.push(`<span class="purchase-price purchase-price--primary">${p}</span>`),m.push(p.replace(/\u00A0/g," "))):(h.push('<span class="missing-value" role="note" aria-label="Kein Kaufpreis verfügbar" title="Kein Kaufpreis verfügbar">—</span>'),m.push("Kein Kaufpreis verfügbar")),_&&g&&g!==p&&(h.push(`<span class="purchase-price purchase-price--secondary">${g}</span>`),m.push(g.replace(/\u00A0/g," ")));const v=h.join("<br>"),y=J(n==null?void 0:n.purchase_value_eur)??0,P=m.join(", ");return{markup:v,sortValue:y,ariaLabel:P}}const Ne=new Set;function Qt(e){if(!e)return;Array.from(e.querySelectorAll("tbody tr")).forEach(n=>{const r=n.cells.item(4),i=n.cells.item(5);if(!r||!i||r.dataset.gainPct&&r.dataset.gainSign)return;const a=(i.textContent||"").trim()||"—";let o="neutral";i.querySelector(".positive")?o="positive":i.querySelector(".negative")&&(o="negative"),r.dataset.gainPct=a,r.dataset.gainSign=o})}function fe(e){if(e.length===0)return'<div class="no-positions">Keine Positionen vorhanden.</div>';const t=e.map(Lr),n=[{key:"name",label:"Wertpapier"},{key:"current_holdings",label:"Bestand",align:"right"},{key:"purchase_value",label:"Ø Kaufpreis",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"+/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}],r=t.map(a=>{const o=X(a.performance),c=typeof(o==null?void 0:o.gain_abs)=="number"?o.gain_abs:null,l=typeof(o==null?void 0:o.gain_pct)=="number"?o.gain_pct:null;return{name:typeof a.name=="string"?a.name:typeof a.name=="number"?String(a.name):"",current_holdings:typeof a.current_holdings=="number"||typeof a.current_holdings=="string"?a.current_holdings:null,purchase_value:typeof a.purchase_value=="number"||typeof a.purchase_value=="string"?a.purchase_value:null,current_value:typeof a.current_value=="number"||typeof a.current_value=="string"?a.current_value:null,gain_abs:c,gain_pct:l}}),i=ne(r,n,["purchase_value","current_value","gain_abs"]);try{const a=document.createElement("template");a.innerHTML=i.trim();const o=a.content.querySelector("table");if(o){o.classList.add("sortable-positions");const c=Array.from(o.querySelectorAll("thead th"));return n.forEach((s,d)=>{const u=c.at(d);u&&(u.setAttribute("data-sort-key",s.key),u.classList.add("sortable-col"))}),o.querySelectorAll("tbody tr").forEach((s,d)=>{if(s.classList.contains("footer-row")||d>=t.length)return;const u=t[d],f=typeof u.security_uuid=="string"?u.security_uuid:null;f&&(s.dataset.security=f),s.classList.add("position-row");const p=s.cells.item(2);if(p){const{markup:h,sortValue:m,ariaLabel:v}=Tr(u);p.innerHTML=h,p.dataset.sortValue=String(m),v?p.setAttribute("aria-label",v):p.removeAttribute("aria-label")}const g=s.cells.item(4);if(g){const h=X(u.performance),m=typeof(h==null?void 0:h.gain_pct)=="number"&&Number.isFinite(h.gain_pct)?h.gain_pct:null,v=m!=null?`${m.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})} %`:"—",y=m==null?"neutral":m>0?"positive":m<0?"negative":"neutral";g.dataset.gainPct=v,g.dataset.gainSign=y}const _=s.cells.item(5);_&&_.classList.add("gain-pct-cell")}),o.dataset.defaultSort="name",o.dataset.defaultDir="asc",Qt(o),o.outerHTML}}catch(a){console.warn("renderPositionsTable: Konnte Sortier-Metadaten nicht injizieren:",a)}return i}function Rr(e){return fe(e)}function $r(e,t){if(!t)return;const n=e.querySelector(`.portfolio-details[data-portfolio="${t}"]`);if(!n)return;const r=n.querySelector(".positions-container");r&&(r.__ppReaderSecurityClickBound||(r.__ppReaderSecurityClickBound=!0,r.addEventListener("click",i=>{const a=i.target;if(!(a instanceof Element))return;const o=a.closest("button, a");if(o&&r.contains(o))return;const c=a.closest("tr[data-security]");if(!c||!r.contains(c))return;const l=c.getAttribute("data-security");if(l)try{Mn(l)||console.warn("attachSecurityDetailDelegation: Detail-Tab konnte nicht geöffnet werden für",l)}catch(s){console.error("attachSecurityDetailDelegation: Fehler beim Öffnen des Detail-Tabs",s)}})))}function he(e,t){$r(e,t)}function en(e){console.debug("buildExpandablePortfolioTable: render",e.length,"portfolios");const t=b=>b==null||typeof b!="string"&&typeof b!="number"&&typeof b!="boolean"?"":String(b).replace(/&/g,"&amp;").replace(/"/g,"&quot;");let n='<table class="expandable-portfolio-table"><thead><tr>';[{key:"name",label:"Name"},{key:"position_count",label:"Anzahl Positionen",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"Gesamt +/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}].forEach(b=>{const A=b.align==="right"?' class="align-right"':"";n+=`<th${A}>${b.label}</th>`}),n+="</tr></thead><tbody>",e.forEach(b=>{const A=Number.isFinite(b.position_count)?b.position_count:0,L=Number.isFinite(b.purchase_sum)?b.purchase_sum:0,x=b.hasValue&&typeof b.current_value=="number"&&Number.isFinite(b.current_value)?b.current_value:null,T=x!==null,$=b.performance,M=typeof($==null?void 0:$.gain_abs)=="number"?$.gain_abs:null,R=typeof($==null?void 0:$.gain_pct)=="number"?$.gain_pct:null,S=b.fx_unavailable&&T,F=Ne.has(b.uuid),q=F?"portfolio-toggle expanded":"portfolio-toggle",O=`portfolio-details-${b.uuid}`,U={fx_unavailable:b.fx_unavailable,current_value:x,gain_abs:M,gain_pct:R},H={hasValue:T},C=I("current_value",U.current_value,U,H),W=I("gain_abs",U.gain_abs,U,H),Ue=I("gain_pct",U.gain_pct,U,H),be=T&&typeof R=="number"&&Number.isFinite(R)?`${K(R)} %`:"",Ve=T&&typeof R=="number"&&Number.isFinite(R)?R>0?"positive":R<0?"negative":"neutral":"",ye=T&&typeof x=="number"&&Number.isFinite(x)?x:"",qe=T&&typeof M=="number"&&Number.isFinite(M)?M:"",Hn=T&&typeof R=="number"&&Number.isFinite(R)?R:"",In=String(A);let We="";be&&(We=` data-gain-pct="${t(be)}" data-gain-sign="${t(Ve)}"`),S&&(We+=' data-partial="true"'),n+=`<tr class="portfolio-row"
                  data-portfolio="${b.uuid}"
                  data-position-count="${In}"
                  data-current-value="${t(ye)}"
                  data-purchase-sum="${t(L)}"
                  data-gain-abs="${t(qe)}"
                data-gain-pct="${t(Hn)}"
                data-has-value="${T?"true":"false"}"
                data-fx-unavailable="${b.fx_unavailable?"true":"false"}">`,n+=`<td>
        <button type="button"
                class="${q}"
                data-portfolio="${b.uuid}"
                aria-expanded="${F?"true":"false"}"
                aria-controls="${O}">
          <span class="caret">${F?"▼":"▶"}</span>
          <span class="portfolio-name">${b.name}</span>
        </button>
      </td>`;const Un=A.toLocaleString("de-DE");n+=`<td class="align-right">${Un}</td>`,n+=`<td class="align-right">${C}</td>`,n+=`<td class="align-right"${We}>${W}</td>`,n+=`<td class="align-right gain-pct-cell">${Ue}</td>`,n+="</tr>",n+=`<tr class="portfolio-details${F?"":" hidden"}"
                data-portfolio="${b.uuid}"
                id="${O}"
                role="region"
                aria-label="Positionen für ${b.name}">
      <td colspan="5">
        <div class="positions-container">${F?pt(b.uuid)?fe(Gt(b.uuid)):'<div class="loading">Lade Positionen...</div>':""}</div>
      </td>
    </tr>`});const i=e.filter(b=>typeof b.current_value=="number"&&Number.isFinite(b.current_value)),a=e.reduce((b,A)=>b+(Number.isFinite(A.position_count)?A.position_count:0),0),o=i.reduce((b,A)=>typeof A.current_value=="number"&&Number.isFinite(A.current_value)?b+A.current_value:b,0),c=i.reduce((b,A)=>typeof A.purchase_sum=="number"&&Number.isFinite(A.purchase_sum)?b+A.purchase_sum:b,0),l=i.reduce((b,A)=>{var T;if(typeof((T=A.performance)==null?void 0:T.gain_abs)=="number"&&Number.isFinite(A.performance.gain_abs))return b+A.performance.gain_abs;const L=typeof A.current_value=="number"&&Number.isFinite(A.current_value)?A.current_value:0,x=typeof A.purchase_sum=="number"&&Number.isFinite(A.purchase_sum)?A.purchase_sum:0;return b+(L-x)},0),s=i.length>0,d=i.length!==e.length,u=s&&c>0?l/c*100:null,f={fx_unavailable:d,current_value:s?o:null,gain_abs:s?l:null,gain_pct:s?u:null},p={hasValue:s},g=I("current_value",f.current_value,f,p),_=I("gain_abs",f.gain_abs,f,p),h=I("gain_pct",f.gain_pct,f,p);let m="";if(s&&typeof u=="number"&&Number.isFinite(u)){const b=`${K(u)} %`,A=u>0?"positive":u<0?"negative":"neutral";m=` data-gain-pct="${t(b)}" data-gain-sign="${t(A)}"`}d&&(m+=' data-partial="true"');const v=String(Math.round(a)),y=s?String(o):"",P=s?String(c):"",E=s?String(l):"",w=s&&typeof u=="number"&&Number.isFinite(u)?String(u):"";return n+=`<tr class="footer-row"
      data-position-count="${v}"
      data-current-value="${t(y)}"
      data-purchase-sum="${t(P)}"
      data-gain-abs="${t(E)}"
      data-gain-pct="${t(w)}"
      data-has-value="${s?"true":"false"}"
      data-fx-unavailable="${d?"true":"false"}">
      <td>Summe</td>
      <td class="align-right">${Math.round(a).toLocaleString("de-DE")}</td>
    <td class="align-right">${g}</td>
    <td class="align-right"${m}>${_}</td>
    <td class="align-right gain-pct-cell">${h}</td>
  </tr>`,n+="</tbody></table>",n}function Cr(e){if(e instanceof HTMLTableElement)return e;if(e&&"querySelector"in e){const t=e.querySelector("table.expandable-portfolio-table");if(t)return t;const n=e.querySelector(".portfolio-table table");if(n)return n;const r=e.querySelector("table");if(r)return r}return document.querySelector(".portfolio-table table.expandable-portfolio-table")||document.querySelector(".portfolio-table table")}function _e(e){if(e===void 0)return null;const t=Number(e);return Number.isFinite(t)?t:null}function tn(e){const t=Cr(e);if(!t)return;const n=t.tBodies.item(0);if(!n)return;const r=Array.from(n.querySelectorAll("tr.portfolio-row"));if(!r.length)return;let i=0,a=0,o=0,c=0,l=!1,s=!0,d=!1;for(const E of r){const w=_e(E.dataset.positionCount);w!=null&&(i+=w),E.dataset.fxUnavailable==="true"&&(d=!0);const b=E.dataset.hasValue;if(!!(b==="false"||b==="0"||b===""||b==null)){s=!1;continue}l=!0;const L=_e(E.dataset.currentValue),x=_e(E.dataset.gainAbs),T=_e(E.dataset.purchaseSum);if(L==null||x==null||T==null){s=!1;continue}a+=L,c+=x,o+=T}const u=l&&s,f=u&&o>0?c/o*100:null;let p=Array.from(n.children).find(E=>E instanceof HTMLTableRowElement&&E.classList.contains("footer-row"));p||(p=document.createElement("tr"),p.classList.add("footer-row"),n.appendChild(p));const g=Math.round(i).toLocaleString("de-DE"),_={fx_unavailable:d||!u,current_value:u?a:null,gain_abs:u?c:null,gain_pct:u?f:null},h={hasValue:u},m=I("current_value",_.current_value,_,h),v=I("gain_abs",_.gain_abs,_,h),y=I("gain_pct",_.gain_pct,_,h);p.innerHTML=`
      <td>Summe</td>
      <td class="align-right">${g}</td>
      <td class="align-right">${m}</td>
      <td class="align-right">${v}</td>
      <td class="align-right">${y}</td>
    `;const P=p.cells.item(3);P&&(P.dataset.gainPct=u&&typeof f=="number"?`${K(f)} %`:"—",P.dataset.gainSign=u&&typeof f=="number"?f>0?"positive":f<0?"negative":"neutral":"neutral"),p.dataset.positionCount=String(Math.round(i)),p.dataset.currentValue=u?String(a):"",p.dataset.purchaseSum=u?String(o):"",p.dataset.gainAbs=u?String(c):"",p.dataset.gainPct=u&&typeof f=="number"?String(f):"",p.dataset.hasValue=u?"true":"false",p.dataset.fxUnavailable=d?"true":"false"}function pe(e,t){if(!t)return;const n=e.querySelector(`.portfolio-details[data-portfolio="${t}"]`);if(!n)return;const r=n.querySelector(".positions-container");if(!r)return;const i=r.querySelector("table.sortable-positions");if(!i||i.__ppReaderSortingBound)return;i.__ppReaderSortingBound=!0;const a=(f,p)=>{const g=i.querySelector("tbody");if(!g)return;const _=Array.from(g.querySelectorAll("tr")).filter(y=>!y.classList.contains("footer-row")),h=g.querySelector("tr.footer-row"),m=y=>{if(y==null)return 0;const P=y.replace(/\u00A0/g," ").replace(/[%€]/g,"").replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""),E=Number.parseFloat(P);return Number.isFinite(E)?E:0};_.sort((y,P)=>{const w={name:0,current_holdings:1,purchase_value:2,current_value:3,gain_abs:4,gain_pct:5}[f],b=y.cells.item(w),A=P.cells.item(w);let L="";if(b){const M=b.textContent;typeof M=="string"&&(L=M.trim())}let x="";if(A){const M=A.textContent;typeof M=="string"&&(x=M.trim())}const T=(M,R)=>{const S=M?M.dataset.sortValue:void 0;if(S!=null&&S!==""){const F=Number(S);if(Number.isFinite(F))return F}return m(R)};let $;if(f==="name")$=L.localeCompare(x,"de",{sensitivity:"base"});else{const M=T(b,L),R=T(A,x);$=M-R}return p==="asc"?$:-$}),i.querySelectorAll("thead th.sort-active").forEach(y=>{y.classList.remove("sort-active","dir-asc","dir-desc")});const v=i.querySelector(`thead th[data-sort-key="${f}"]`);v&&v.classList.add("sort-active",p==="asc"?"dir-asc":"dir-desc"),_.forEach(y=>g.appendChild(y)),h&&g.appendChild(h)},o=r.dataset.sortKey,c=r.dataset.sortDir,l=i.dataset.defaultSort,s=i.dataset.defaultDir,d=Be(o)?o:Be(l)?l:"name",u=Ge(c)?c:Ge(s)?s:"asc";a(d,u),i.addEventListener("click",f=>{const p=f.target;if(!(p instanceof Element))return;const g=p.closest("th[data-sort-key]");if(!g||!i.contains(g))return;const _=g.getAttribute("data-sort-key");if(!Be(_))return;let h="asc";r.dataset.sortKey===_&&(h=(Ge(r.dataset.sortDir)?r.dataset.sortDir:"asc")==="asc"?"desc":"asc"),r.dataset.sortKey=_,r.dataset.sortDir=h,a(_,h)})}async function Mr(e,t,n){if(!e||!Ee||!we)return;const r=t||n.querySelector(`.portfolio-details[data-portfolio="${e}"] .positions-container`);if(!r)return;const i=r.closest(".portfolio-details");if(!(i&&i.classList.contains("hidden"))){r.innerHTML='<div class="loading">Neu laden...</div>';try{const a=await qt(Ee,we,e);if(a.error){const c=typeof a.error=="string"?a.error:String(a.error);r.innerHTML=`<div class="error">${c} <button class="retry-pos" data-portfolio="${e}">Erneut laden</button></div>`;return}const o=Array.isArray(a.positions)?a.positions:[];ht(e,o),r.innerHTML=fe(o);try{pe(n,e)}catch(c){console.warn("attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:",c)}try{he(n,e)}catch(c){console.warn("reloadPortfolioPositions: Security-Listener konnte nicht gebunden werden:",c)}}catch(a){const o=a instanceof Error?a.message:String(a);r.innerHTML=`<div class="error">Fehler: ${o} <button class="retry-pos" data-portfolio="${e}">Retry</button></div>`}}}async function kr(e,t,n=3e3,r=50){const i=performance.now();return new Promise(a=>{const o=()=>{const c=e.querySelector(t);if(c){a(c);return}if(performance.now()-i>n){a(null);return}setTimeout(o,r)};o()})}function mt(e){const n=(typeof e.__ppReaderAttachToken=="number"?e.__ppReaderAttachToken:0)+1;e.__ppReaderAttachToken=n,e.__ppReaderAttachInProgress=!0,(async()=>{try{const r=await kr(e,".portfolio-table");if(n!==e.__ppReaderAttachToken)return;if(!r){console.warn("attachPortfolioToggleHandler: .portfolio-table nicht gefunden (Timeout)");return}if(r.querySelectorAll(".portfolio-toggle").length===0&&console.debug("attachPortfolioToggleHandler: Noch keine Buttons – evtl. Recovery später"),r.__ppReaderPortfolioToggleBound)return;r.__ppReaderPortfolioToggleBound=!0,console.debug("attachPortfolioToggleHandler: Listener registriert"),r.addEventListener("click",a=>{(async()=>{try{const o=a.target;if(!(o instanceof Element))return;const c=o.closest(".retry-pos");if(c&&r.contains(c)){const p=c.getAttribute("data-portfolio");if(p){const g=e.querySelector(`.portfolio-details[data-portfolio="${p}"]`),_=g==null?void 0:g.querySelector(".positions-container");await Mr(p,_??null,e)}return}const l=o.closest(".portfolio-toggle");if(!l||!r.contains(l))return;const s=l.getAttribute("data-portfolio");if(!s)return;const d=e.querySelector(`.portfolio-details[data-portfolio="${s}"]`);if(!d)return;const u=l.querySelector(".caret");if(d.classList.contains("hidden")){d.classList.remove("hidden"),l.classList.add("expanded"),l.setAttribute("aria-expanded","true"),u&&(u.textContent="▼"),Ne.add(s);try{gt(e,s)}catch(p){console.warn("attachPortfolioToggleHandler: Pending-Flush fehlgeschlagen:",p)}if(pt(s)){const p=d.querySelector(".positions-container");if(p){p.innerHTML=fe(Gt(s)),pe(e,s);try{he(e,s)}catch(g){console.warn("attachPortfolioToggleHandler: Security-Listener (Cache) Fehler:",g)}}}else{const p=d.querySelector(".positions-container");p&&(p.innerHTML='<div class="loading">Lade Positionen...</div>');try{const g=await qt(Ee,we,s);if(g.error){const h=typeof g.error=="string"?g.error:String(g.error);p&&(p.innerHTML=`<div class="error">${h} <button class="retry-pos" data-portfolio="${s}">Erneut laden</button></div>`);return}const _=Array.isArray(g.positions)?g.positions:[];if(ht(s,_),p){p.innerHTML=fe(_);try{pe(e,s)}catch(h){console.warn("attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:",h)}try{he(e,s)}catch(h){console.warn("attachPortfolioToggleHandler: Security-Listener konnte nicht gebunden werden:",h)}}}catch(g){const _=g instanceof Error?g.message:String(g),h=d.querySelector(".positions-container");h&&(h.innerHTML=`<div class="error">Fehler beim Laden: ${_} <button class="retry-pos" data-portfolio="${s}">Retry</button></div>`),console.error("Fehler beim Lazy Load für",s,g)}}}else d.classList.add("hidden"),l.classList.remove("expanded"),l.setAttribute("aria-expanded","false"),u&&(u.textContent="▶"),Ne.delete(s)}catch(o){console.error("attachPortfolioToggleHandler: Ungefangener Fehler im Click-Handler",o)}})()})}finally{n===e.__ppReaderAttachToken&&(e.__ppReaderAttachInProgress=!1)}})()}function Hr(e){const t=e.querySelector(".expandable-portfolio-table");t&&(t.__ppReaderPortfolioFallbackBound||(t.__ppReaderPortfolioFallbackBound=!0,t.addEventListener("click",n=>{const r=n.target;if(!(r instanceof Element)||!r.closest(".portfolio-toggle"))return;const a=e.querySelector(".portfolio-table");a!=null&&a.__ppReaderPortfolioToggleBound||(console.debug("Fallback-Listener aktiv – re-attach Hauptlistener"),mt(e))})))}async function nn(e,t,n){var $,M,R;Ee=t??null,we=n??null,console.debug("renderDashboard: start – panelConfig:",n==null?void 0:n.config,"derived entry_id?",(R=(M=($=n==null?void 0:n.config)==null?void 0:$._panel_custom)==null?void 0:M.config)==null?void 0:R.entry_id);const a=(await Gn(t,n)).accounts.map(S=>({name:S.name??"—",balance:typeof S.balance=="number"&&Number.isFinite(S.balance)?S.balance:null,currency_code:S.currency_code??null,orig_balance:typeof S.orig_balance=="number"&&Number.isFinite(S.orig_balance)?S.orig_balance:null,fx_unavailable:!!S.fx_unavailable})),c=(await Yn(t,n)).portfolios.map(S=>{const F=S,q=typeof S.uuid=="string"&&S.uuid?S.uuid:null;if(!q)return null;const O=typeof S.missing_value_positions=="number"?S.missing_value_positions:0,U=re(F.current_value),H=re(F.purchase_sum)??0,C=X(F.performance),W=U!=null,Ue=typeof(C==null?void 0:C.gain_abs)=="number"?C.gain_abs:null,be=typeof(C==null?void 0:C.gain_pct)=="number"?C.gain_pct:null,Ve=O>0,ye=W,qe=Ve||!ye;return{uuid:q,name:S.name??"Unbenanntes Depot",position_count:typeof S.position_count=="number"?S.position_count:0,current_value:W?U:null,purchase_sum:H,gain_abs:Ue,gain_pct:be,hasValue:ye,missing_value_positions:O,fx_unavailable:qe,performance:C}}).filter(S=>S!==null);let l="";try{l=await Kn(t,n)}catch{l=""}const s=a.reduce((S,F)=>S+(typeof F.balance=="number"&&Number.isFinite(F.balance)?F.balance:0),0),d=c.some(S=>S.fx_unavailable),u=a.some(S=>S.fx_unavailable&&(S.balance==null||!Number.isFinite(S.balance))),f=c.reduce((S,F)=>F.hasValue&&typeof F.current_value=="number"&&Number.isFinite(F.current_value)?S+F.current_value:S,0),p=s+f,g="Teilw. fehlende FX-Kurse – Gesamtvermögen abweichend",h=c.some(S=>S.hasValue&&typeof S.current_value=="number"&&Number.isFinite(S.current_value))||a.some(S=>typeof S.balance=="number"&&Number.isFinite(S.balance))?`${K(p)}&nbsp;€`:`<span class="missing-value" role="note" aria-label="${g}" title="${g}">—</span>`,m=d||u?`<span class="total-wealth-note">${g}</span>`:"",v=`
    <div class="header-meta-row">
      💰 Gesamtvermögen: <strong class="total-wealth-value">${h}</strong>${m}
    </div>
  `,y=Ze("Übersicht",v),P=en(c),E=a.filter(S=>(S.currency_code??"EUR")==="EUR"),w=a.filter(S=>(S.currency_code??"EUR")!=="EUR"),A=w.some(S=>S.fx_unavailable)?`
        <p class="table-note" role="note">
          <span class="table-note__icon" aria-hidden="true">⚠️</span>
          <span>Wechselkurse konnten nicht geladen werden. EUR-Werte werden derzeit nicht angezeigt.</span>
        </p>
      `:"",L=`
    <div class="card">
      <h2>Liquidität</h2>
      <div class="scroll-container account-table">
        ${ne(E.map(S=>({name:S.name,balance:S.balance??null})),[{key:"name",label:"Name"},{key:"balance",label:"Kontostand (EUR)",align:"right"}],["balance"])}
      </div>
    </div>
    ${w.length?`
      <div class="card">
        <h2>Fremdwährungen</h2>
        <div class="scroll-container fx-account-table">
          ${ne(w.map(S=>{const F=S.orig_balance,O=typeof F=="number"&&Number.isFinite(F)?`${F.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}&nbsp;${S.currency_code??""}`:"";return{name:S.name,fx_display:O,balance:S.balance??null}}),[{key:"name",label:"Name"},{key:"fx_display",label:"Betrag (FX)"},{key:"balance",label:"EUR",align:"right"}],["balance"])}
        </div>
        ${A}
      </div>`:""}
  `,x=`
    <div class="card footer-card">
      <div class="meta">
        <div class="last-file-update">
          📂 Letzte Aktualisierung der Datei: <strong>${l||"Unbekannt"}</strong>
        </div>
      </div>
    </div>
  `,T=`
    ${y.outerHTML}
    <div class="card">
      <h2>Investment</h2>
      <div class="scroll-container portfolio-table">
        ${P}
      </div>
    </div>
    ${L}
    ${x}
  `;return Ir(e,c),T}function Ir(e,t){if(!e)return;const n=()=>{try{const i=e,a=i.querySelector(".portfolio-table");a&&a.querySelectorAll(".portfolio-toggle").length===0&&(console.debug("Recovery: Tabelle ohne Buttons – erneuter Aufbau"),a.innerHTML=en(t)),mt(e),Hr(e),Ne.forEach(o=>{try{pt(o)&&(pe(e,o),he(e,o))}catch(c){console.warn("Init-Sortierung für expandiertes Depot fehlgeschlagen:",o,c)}});try{tn(i)}catch(o){console.warn("renderDashboard: Footer-Summe konnte nicht aktualisiert werden:",o)}try{br(e)}catch(o){console.warn("renderDashboard: Pending-Positions konnten nicht angewendet werden:",o)}console.debug("renderDashboard: portfolio-toggle Buttons:",i.querySelectorAll(".portfolio-toggle").length)}catch(i){console.error("renderDashboard: Fehler bei Recovery/Listener",i)}},r=typeof requestAnimationFrame=="function"?i=>requestAnimationFrame(i):i=>setTimeout(i,0);r(()=>r(n))}nr({renderPositionsTable:e=>Rr(e),applyGainPctMetadata:Qt,attachSecurityDetailListener:he,attachPortfolioPositionsSorting:pe,updatePortfolioFooter:e=>{e&&tn(e)}});const Ur="http://www.w3.org/2000/svg",le=640,ue=260,se={top:12,right:16,bottom:24,left:16},ce="var(--pp-reader-chart-line, #3f51b5)",tt="var(--pp-reader-chart-area, rgba(63, 81, 181, 0.12))",wt="0.75rem",rn="var(--pp-reader-chart-baseline, rgba(96, 125, 139, 0.75))",an="6 4",Vr=24*60*60*1e3;function qr(e){if(e==null)return null;if(typeof e=="string")return e;if(typeof e=="number")return Number.isFinite(e)?e.toString():null;if(typeof e=="boolean")return e?"true":"false";if(e instanceof Date){const t=e.getTime();return Number.isFinite(t)?e.toISOString():null}return null}function Wr(e){return typeof e=="string"?e:typeof e=="number"&&Number.isFinite(e)?e.toString():e instanceof Date&&Number.isFinite(e.getTime())?e.toISOString():""}function z(e){return`${String(e)}px`}function Y(e,t={}){const n=document.createElementNS(Ur,e);return Object.entries(t).forEach(([r,i])=>{const a=qr(i);a!=null&&n.setAttribute(r,a)}),n}function nt(e,t=null){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"&&e.trim()!==""){const n=Number.parseFloat(e);if(Number.isFinite(n))return n}return t}function Or(e,t){if(e instanceof Date){const n=e.getTime();return Number.isFinite(n)?n:t}if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"){const n=Date.parse(e);if(Number.isFinite(n))return n}return t}const on=e=>{if(e&&typeof e=="object"&&"date"in e)return e.date},sn=e=>{if(e&&typeof e=="object"&&"close"in e)return e.close},cn=(e,t,n)=>{if(Number.isFinite(e)){const r=new Date(e);if(!Number.isNaN(r.getTime()))return r.toLocaleDateString("de-DE")}if(t&&typeof t=="object"&&"date"in t){const r=t.date,i=Wr(r);if(i)return i}return Number.isFinite(e)?e.toString():""},ln=(e,t,n)=>(Number.isFinite(e)?e:nt(e,0)??0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}),un=({xFormatted:e,yFormatted:t})=>`
    <div class="chart-tooltip-date">${e}</div>
    <div class="chart-tooltip-value">${t}&nbsp;€</div>
  `;function dn(e){return e.__chartState||(e.__chartState={svg:null,areaPath:null,linePath:null,baselineLine:null,focusLine:null,focusCircle:null,overlay:null,tooltip:null,width:le,height:ue,margin:{...se},series:[],points:[],range:null,xAccessor:on,yAccessor:sn,xFormatter:cn,yFormatter:ln,tooltipRenderer:un,color:ce,areaColor:tt,baseline:null,handlersAttached:!1}),e.__chartState}function j(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function zr(e,t){if(e.length===0)return"";const n=[];e.forEach((o,c)=>{const l=c===0?"M":"L",s=o.x.toFixed(2),d=o.y.toFixed(2);n.push(`${l}${s} ${d}`)});const r=e[0],a=`L${e[e.length-1].x.toFixed(2)} ${t.toFixed(2)} L${r.x.toFixed(2)} ${t.toFixed(2)} Z`;return`${n.join(" ")} ${a}`}function Br(e){if(e.length===0)return"";const t=[];return e.forEach((n,r)=>{const i=r===0?"M":"L",a=n.x.toFixed(2),o=n.y.toFixed(2);t.push(`${i}${a} ${o}`)}),t.join(" ")}function Gr(e){const{baselineLine:t,baseline:n}=e;if(!t)return;const r=(n==null?void 0:n.color)??rn,i=(n==null?void 0:n.dashArray)??an;t.setAttribute("stroke",r),t.setAttribute("stroke-dasharray",i)}function Nt(e){const{baselineLine:t,baseline:n,range:r,margin:i,width:a}=e;if(!t)return;const o=n==null?void 0:n.value;if(!r||o==null||!Number.isFinite(o)){t.style.opacity="0";return}const{minY:c,maxY:l,boundedHeight:s}=r,d=Number.isFinite(c)?c:o,f=(Number.isFinite(l)?l:d+1)-d,p=f===0?.5:(o-d)/f,g=j(p,0,1),_=Math.max(s,0),h=i.top+(1-g)*_,m=Math.max(a-i.left-i.right,0),v=i.left,y=i.left+m;t.setAttribute("x1",v.toFixed(2)),t.setAttribute("x2",y.toFixed(2)),t.setAttribute("y1",h.toFixed(2)),t.setAttribute("y2",h.toFixed(2)),t.style.opacity="1"}function Kr(e,t,n){var R;const{width:r,height:i,margin:a}=t,{xAccessor:o,yAccessor:c}=n;if(e.length===0)return{points:[],range:null};const l=e.map((S,F)=>{const q=o(S,F),O=c(S,F),U=Or(q,F),H=nt(O,Number.NaN);return Number.isFinite(H)?{index:F,data:S,xValue:U,yValue:H}:null}).filter(S=>!!S);if(l.length===0)return{points:[],range:null};const s=l.reduce((S,F)=>Math.min(S,F.xValue),l[0].xValue),d=l.reduce((S,F)=>Math.max(S,F.xValue),l[0].xValue),u=l.reduce((S,F)=>Math.min(S,F.yValue),l[0].yValue),f=l.reduce((S,F)=>Math.max(S,F.yValue),l[0].yValue),p=Math.max(r-a.left-a.right,1),g=Math.max(i-a.top-a.bottom,1),_=Number.isFinite(s)?s:0,h=Number.isFinite(d)?d:_+1,m=Number.isFinite(u)?u:0,v=Number.isFinite(f)?f:m+1,y=nt((R=t.baseline)==null?void 0:R.value,null),P=y!=null&&Number.isFinite(y)?Math.min(m,y):m,E=y!=null&&Number.isFinite(y)?Math.max(v,y):v,w=Math.max(2,Math.min(6,Math.round(Math.max(i-a.top-a.bottom,0)/60)||4)),{niceMin:b,niceMax:A}=Jr(P,E,w),L=Number.isFinite(b)?b:m,x=Number.isFinite(A)?A:v,T=h-_||1,$=x-L||1;return{points:l.map(S=>{const F=T===0?.5:(S.xValue-_)/T,q=$===0?.5:(S.yValue-L)/$,O=a.left+F*p,U=a.top+(1-q)*g;return{...S,x:O,y:U}}),range:{minX:_,maxX:h,minY:L,maxY:x,boundedWidth:p,boundedHeight:g}}}function fn(e,t,n,r){e.width=Number.isFinite(t)?Number(t):le,e.height=Number.isFinite(n)?Number(n):ue,e.margin={top:Number.isFinite(r==null?void 0:r.top)?Number(r==null?void 0:r.top):se.top,right:Number.isFinite(r==null?void 0:r.right)?Number(r==null?void 0:r.right):se.right,bottom:Number.isFinite(r==null?void 0:r.bottom)?Number(r==null?void 0:r.bottom):se.bottom,left:Number.isFinite(r==null?void 0:r.left)?Number(r==null?void 0:r.left):se.left}}function Yr(e,t){const n=e.xFormatter(t.xValue,t.data,t.index),r=e.yFormatter(t.yValue,t.data,t.index);return e.tooltipRenderer({point:t,xFormatted:n,yFormatted:r,data:t.data,index:t.index})}function jr(e,t,n){const{tooltip:r,width:i,margin:a,height:o}=e;if(!r)return;const c=o-a.bottom;r.style.visibility="visible",r.style.opacity="1";const l=r.offsetWidth||0,s=r.offsetHeight||0,d=j(t.x-l/2,a.left,i-a.right-l),u=Math.max(c-s,0),f=12,p=Number.isFinite(n)?j(n??0,a.top,c):t.y;let g=p-s-f;g<a.top&&(g=p+f),g=j(g,0,u);const _=z(Math.round(d)),h=z(Math.round(g));r.style.transform=`translate(${_}, ${h})`}function rt(e){const{tooltip:t,focusLine:n,focusCircle:r}=e;t&&(t.style.opacity="0",t.style.visibility="hidden"),n&&(n.style.opacity="0"),r&&(r.style.opacity="0")}function Xr(e,t){if(t.handlersAttached||!t.overlay)return;const n=i=>{if(t.points.length===0||!t.svg){rt(t);return}const a=t.svg.getBoundingClientRect(),o=i.clientX-a.left,c=i.clientY-a.top;let l=t.points[0],s=Math.abs(o-l.x);for(let d=1;d<t.points.length;d+=1){const u=t.points[d],f=Math.abs(o-u.x);f<s&&(s=f,l=u)}t.focusCircle&&(t.focusCircle.setAttribute("cx",l.x.toFixed(2)),t.focusCircle.setAttribute("cy",l.y.toFixed(2)),t.focusCircle.style.opacity="1"),t.focusLine&&(t.focusLine.setAttribute("x1",l.x.toFixed(2)),t.focusLine.setAttribute("x2",l.x.toFixed(2)),t.focusLine.setAttribute("y1",t.margin.top.toFixed(2)),t.focusLine.setAttribute("y2",(t.height-t.margin.bottom).toFixed(2)),t.focusLine.style.opacity="1"),t.tooltip&&(t.tooltip.innerHTML=Yr(t,l),jr(t,l,c))},r=()=>{rt(t)};t.overlay.addEventListener("pointermove",n),t.overlay.addEventListener("pointerenter",n),t.overlay.addEventListener("pointerleave",r),t.handlersAttached=!0,t.handlePointerMove=n,t.handlePointerLeave=r,e.addEventListener("pointercancel",r)}function Zr(e,t={}){const n=document.createElement("div");n.className="line-chart-container",n.dataset.chartType="line",n.style.position="relative";const r=Y("svg",{width:le,height:ue,viewBox:`0 0 ${String(le)} ${String(ue)}`,role:"img","aria-hidden":"true",focusable:"false"});r.classList.add("line-chart-svg");const i=Y("path",{class:"line-chart-area",fill:tt,stroke:"none"}),a=Y("line",{class:"line-chart-baseline",stroke:rn,"stroke-width":1,"stroke-dasharray":an,opacity:0}),o=Y("path",{class:"line-chart-path",fill:"none",stroke:ce,"stroke-width":2,"stroke-linecap":"round","stroke-linejoin":"round"}),c=Y("line",{class:"line-chart-focus-line",stroke:ce,"stroke-width":1,"stroke-dasharray":"4 4",opacity:0}),l=Y("circle",{class:"line-chart-focus-circle",r:4,fill:"#fff",stroke:ce,"stroke-width":2,opacity:0}),s=Y("rect",{class:"line-chart-overlay",fill:"transparent",x:0,y:0,width:le,height:ue});r.appendChild(i),r.appendChild(a),r.appendChild(o),r.appendChild(c),r.appendChild(l),r.appendChild(s),n.appendChild(r);const d=document.createElement("div");d.className="chart-tooltip",d.style.position="absolute",d.style.top="0",d.style.left="0",d.style.pointerEvents="none",d.style.opacity="0",d.style.visibility="hidden",n.appendChild(d),e.appendChild(n);const u=dn(n);if(u.svg=r,u.areaPath=i,u.linePath=o,u.baselineLine=a,u.focusLine=c,u.focusCircle=l,u.overlay=s,u.tooltip=d,u.xAccessor=t.xAccessor??on,u.yAccessor=t.yAccessor??sn,u.xFormatter=t.xFormatter??cn,u.yFormatter=t.yFormatter??ln,u.tooltipRenderer=t.tooltipRenderer??un,u.color=t.color??ce,u.areaColor=t.areaColor??tt,u.baseline=t.baseline??null,u.handlersAttached=!1,!u.xAxis){const f=document.createElement("div");f.className="line-chart-axis line-chart-axis-x",f.style.position="absolute",f.style.left="0",f.style.right="0",f.style.bottom="0",f.style.pointerEvents="none",f.style.fontSize=wt,f.style.color="var(--secondary-text-color)",f.style.display="block",n.appendChild(f),u.xAxis=f}if(!u.yAxis){const f=document.createElement("div");f.className="line-chart-axis line-chart-axis-y",f.style.position="absolute",f.style.top="0",f.style.bottom="0",f.style.left="0",f.style.pointerEvents="none",f.style.fontSize=wt,f.style.color="var(--secondary-text-color)",f.style.display="block",n.appendChild(f),u.yAxis=f}return fn(u,t.width,t.height,t.margin),o.setAttribute("stroke",u.color),c.setAttribute("stroke",u.color),l.setAttribute("stroke",u.color),i.setAttribute("fill",u.areaColor),hn(n,t),Xr(n,u),n}function hn(e,t={}){if(!e){console.error("updateLineChart: container element is required");return}const n=dn(e);if(!n.svg||!n.linePath||!n.overlay){console.error("updateLineChart: chart was not initialised with renderLineChart");return}t.xAccessor&&(n.xAccessor=t.xAccessor),t.yAccessor&&(n.yAccessor=t.yAccessor),t.xFormatter&&(n.xFormatter=t.xFormatter),t.yFormatter&&(n.yFormatter=t.yFormatter),t.tooltipRenderer&&(n.tooltipRenderer=t.tooltipRenderer),t.color&&(n.color=t.color,n.linePath.setAttribute("stroke",n.color),n.focusLine&&n.focusLine.setAttribute("stroke",n.color),n.focusCircle&&n.focusCircle.setAttribute("stroke",n.color)),t.areaColor&&(n.areaColor=t.areaColor,n.areaPath&&n.areaPath.setAttribute("fill",n.areaColor)),Object.prototype.hasOwnProperty.call(t,"baseline")&&(n.baseline=t.baseline??null),Gr(n),fn(n,t.width,t.height,t.margin);const{width:r,height:i,margin:a}=n;n.svg.setAttribute("width",String(r)),n.svg.setAttribute("height",String(i)),n.svg.setAttribute("viewBox",`0 0 ${String(r)} ${String(i)}`),n.overlay.setAttribute("x",a.left.toFixed(2)),n.overlay.setAttribute("y",a.top.toFixed(2)),n.overlay.setAttribute("width",Math.max(r-a.left-a.right,0).toFixed(2)),n.overlay.setAttribute("height",Math.max(i-a.top-a.bottom,0).toFixed(2)),Array.isArray(t.series)&&(n.series=Array.from(t.series));const{points:o,range:c}=Kr(n.series,n,{xAccessor:n.xAccessor,yAccessor:n.yAccessor});if(n.points=o,n.range=c,o.length===0){n.linePath.setAttribute("d",""),n.areaPath&&n.areaPath.setAttribute("d",""),rt(n),xt(n),Nt(n);return}const l=Br(o);if(n.linePath.setAttribute("d",l),n.areaPath&&c){const s=n.margin.top+c.boundedHeight,d=zr(o,s);n.areaPath.setAttribute("d",d)}xt(n),Nt(n)}function xt(e){const{xAxis:t,yAxis:n,range:r,margin:i,height:a,yFormatter:o}=e;if(!t||!n)return;if(!r){t.innerHTML="",n.innerHTML="";return}const{minX:c,maxX:l,minY:s,maxY:d,boundedWidth:u,boundedHeight:f}=r,p=Number.isFinite(c)&&Number.isFinite(l)&&l>=c,g=Number.isFinite(s)&&Number.isFinite(d)&&d>=s,_=Math.max(u,0),h=Math.max(f,0);if(t.style.left=z(i.left),t.style.width=z(_),t.style.top=z(a-i.bottom+6),t.innerHTML="",p&&_>0){const v=(l-c)/Vr,y=Math.max(2,Math.min(6,Math.round(_/140)||4));Qr(e,c,l,y,v).forEach(({positionRatio:E,label:w})=>{const b=document.createElement("div");b.className="line-chart-axis-tick line-chart-axis-tick-x",b.style.position="absolute",b.style.bottom="0";const A=j(E,0,1);b.style.left=z(A*_);let L="-50%",x="center";A<=.001?(L="0",x="left",b.style.marginLeft="2px"):A>=.999&&(L="-100%",x="right",b.style.marginRight="2px"),b.style.transform=`translateX(${L})`,b.style.textAlign=x,b.textContent=w,t.appendChild(b)})}n.style.top=z(i.top),n.style.height=z(h);const m=Math.max(i.left-6,0);if(n.style.left="0",n.style.width=z(Math.max(m,0)),n.innerHTML="",g&&h>0){const v=Math.max(2,Math.min(6,Math.round(h/60)||4)),y=ei(s,d,v),P=o;y.forEach(({value:E,positionRatio:w})=>{const b=document.createElement("div");b.className="line-chart-axis-tick line-chart-axis-tick-y",b.style.position="absolute",b.style.left="0";const L=(1-j(w,0,1))*h;b.style.top=z(L),b.textContent=P(E,null,-1),n.appendChild(b)})}}function Jr(e,t,n=4){if(!Number.isFinite(e)||!Number.isFinite(t))return{niceMin:e,niceMax:t};const r=Math.max(2,n);if(t===e){const s=it(Math.abs(e)||1);return{niceMin:e-s,niceMax:t+s}}const a=(t-e)/(r-1),o=it(a),c=Math.floor(e/o)*o,l=Math.ceil(t/o)*o;return c===l?{niceMin:e,niceMax:t+o}:{niceMin:c,niceMax:l}}function Qr(e,t,n,r,i){if(!Number.isFinite(t)||!Number.isFinite(n)||n<t)return[];if(!Number.isFinite(i)||i<=0)return[{positionRatio:.5,label:Dt(e,t,i||0)}];const a=Math.max(2,r),o=[],c=n-t;for(let l=0;l<a;l+=1){const s=a===1?.5:l/(a-1),d=t+s*c;o.push({positionRatio:s,label:Dt(e,d,i)})}return o}function Dt(e,t,n){const r=new Date(t);return Number.isFinite(r.getTime())?n>1095?String(r.getFullYear()):n>365?r.toLocaleDateString("de-DE",{year:"numeric",month:"short"}):n>90?r.toLocaleDateString("de-DE",{year:"2-digit",month:"short"}):n>30?r.toLocaleDateString("de-DE",{day:"2-digit",month:"short"}):r.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"}):e.xFormatter(t,null,-1)}function ei(e,t,n){if(!Number.isFinite(e)||!Number.isFinite(t))return[];if(t===e)return[{value:e,positionRatio:.5}];const r=t-e,i=Math.max(2,n),a=r/(i-1),o=it(a),c=Math.floor(e/o)*o,l=Math.ceil(t/o)*o,s=[];for(let d=c;d<=l+o/2;d+=o){const u=(d-e)/(t-e);s.push({value:d,positionRatio:j(u,0,1)})}return s.length>i+2?s.filter((d,u)=>u%2===0):s}function it(e){if(!Number.isFinite(e)||e===0)return 1;const t=Math.floor(Math.log10(Math.abs(e))),n=Math.abs(e)/10**t;let r;return n<=1?r=1:n<=2?r=2:n<=5?r=5:r=10,r*10**t}function ti(e){return Array.isArray(e)&&e.every(t=>typeof t=="string")}function ni(e){return typeof e=="object"&&e!==null}function ri(e){if(!ni(e))return!1;const t=e;return typeof t.portfolioUuid!="string"?!1:ti(t.securityUuids)}function ii(e){return e instanceof CustomEvent?ri(e.detail):!1}const Ye={min:0,max:6},xe={min:2,max:4},ai="1Y",pn=["1M","6M","1Y","5Y","ALL"],oi={"1M":30,"6M":182,"1Y":365,"5Y":1826,ALL:Number.POSITIVE_INFINITY},je={aggregation:"Aggregationsdaten",totals:"Kaufsummen",eur_total:"EUR-Kaufsumme"},Q=new Map,ve=new Map,ge=new Map,gn="pp-reader:portfolio-positions-updated",de=new Map;function Ie(e){if(!e)return null;const t=e.average_cost;if(!t||typeof t!="object")return null;const n=t,r=D(n.native),i=D(n.security),a=D(n.account),o=D(n.eur),c=D(n.coverage_ratio);if(r==null&&i==null&&a==null&&o==null&&c==null)return null;const l=n.source;return{native:r,security:i,account:a,eur:o,source:l==="totals"||l==="eur_total"?l:"aggregation",coverage_ratio:c}}function si(e){if(!e)return null;const t=e.aggregation;if(!t||typeof t!="object")return null;const n=t,r=D(n.total_holdings),i=D(n.positive_holdings),a=D(n.purchase_value_eur),o=D(n.purchase_total_security)??D(n.security_currency_total),c=D(n.purchase_total_account)??D(n.account_currency_total),l=n.purchase_value_cents;let s=0;if(typeof l=="number"&&Number.isFinite(l))s=Math.trunc(l);else if(typeof l=="string"){const u=Number.parseInt(l,10);Number.isFinite(u)&&(s=u)}return r!=null||i!=null||a!=null||o!=null||c!=null||s!==0?{total_holdings:r??0,positive_holdings:i??0,purchase_value_cents:s,purchase_value_eur:a??0,security_currency_total:o??0,account_currency_total:c??0,purchase_total_security:o??0,purchase_total_account:c??0}:null}function ci(e){const{fallbackUsed:t,flaggedAsCache:n}=e,r=[];return t&&r.push("Der aktuelle Snapshot konnte nicht geladen werden. Es werden die zuletzt gespeicherten Werte angezeigt."),n&&!t&&r.push("Der Snapshot ist vom Datenanbieter als Zwischenspeicherstand markiert."),`
    <div class="card warning-card stale-notice" role="status" aria-live="polite">
      <h2>Zwischengespeicherte Werte</h2>
      <p>${r.length?r.join(" "):"Die Daten stammen aus dem Zwischenspeicher."}</p>
      <p class="stale-notice__hint">Die angezeigten Beträge können von den aktuellen Marktwerten abweichen. Laden Sie die Ansicht erneut, sobald eine Verbindung verfügbar ist.</p>
    </div>
  `}function li(e,t){if(e){if(t){ge.set(e,t);return}ge.delete(e)}}function ui(e){if(!e||typeof window>"u")return null;if(ge.has(e)){const t=ge.get(e)||null;if(t)return t}return null}function mn(e){return Q.has(e)||Q.set(e,new Map),Q.get(e)}function bn(e){if(e&&Q.has(e)){try{const t=Q.get(e);t&&t.clear()}catch(t){console.warn("invalidateHistoryCache: Konnte Cache nicht leeren",e,t)}Q.delete(e)}}function yn(e){e&&ge.delete(e)}function di(e,t){if(!e||!t)return;const n=t.securityUuids;(Array.isArray(n)?n:[]).includes(e)&&(bn(e),yn(e))}function fi(e){if(!e||de.has(e))return;const t=n=>{ii(n)&&di(e,n.detail)};try{window.addEventListener(gn,t),de.set(e,t)}catch(n){console.error("ensureLiveUpdateSubscription: Registrierung fehlgeschlagen",n)}}function hi(e){if(!e||!de.has(e))return;const t=de.get(e);try{t&&window.removeEventListener(gn,t)}catch(n){console.error("removeLiveUpdateSubscription: Entfernen des Listeners fehlgeschlagen",n)}de.delete(e)}function pi(e){e&&(hi(e),bn(e),yn(e))}function Lt(e,t){if(!ve.has(e)){ve.set(e,{activeRange:t});return}const n=ve.get(e);n&&(n.activeRange=t)}function _n(e){var t;return((t=ve.get(e))==null?void 0:t.activeRange)??ai}function De(e){const t=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate());return Math.floor(t/864e5)}function at(e){const t=new Date(e.getTime());return t.setUTCHours(0,0,0,0),t}function D(e){return ke(e)}function gi(e){if(typeof e!="string")return null;const t=e.trim();return t||null}function Le(e){const t=gi(e);return t?t.toUpperCase():null}function vn(e,t="Unbekannter Fehler"){if(typeof e=="string"){const n=e.trim();return n||t}if(e instanceof Error){const n=e.message.trim();return n||t}if(e!=null)try{const n=JSON.stringify(e);if(n&&n!=="{}")return n}catch{}return t}function Sn(e){const t=at(new Date),n=oi[e],r={end_date:De(t)};if(Number.isFinite(n)&&n>0){const i=new Date(t.getTime());i.setUTCDate(i.getUTCDate()-(n-1)),r.start_date=De(i)}return r}function Pn(e){if(!e)return null;if(e instanceof Date&&!Number.isNaN(e.getTime()))return new Date(e.getTime());if(typeof e=="number"&&Number.isFinite(e)){const t=e*864e5;if(Number.isFinite(t))return new Date(t)}if(typeof e=="string"){const t=e.trim();if(/^\d{8}$/.test(t)){const r=Number.parseInt(t.slice(0,4),10),i=Number.parseInt(t.slice(4,6),10)-1,a=Number.parseInt(t.slice(6,8),10);if(Number.isFinite(r)&&Number.isFinite(i)&&Number.isFinite(a)){const o=new Date(Date.UTC(r,i,a));if(!Number.isNaN(o.getTime()))return o}}const n=Date.parse(t);if(Number.isFinite(n))return new Date(n)}return null}function Te(e){if(!e&&e!==0)return null;if(e instanceof Date&&!Number.isNaN(e.getTime()))return e.getTime();if(typeof e=="number"&&Number.isFinite(e)){if(e>1e12)return e;if(e>1e9)return e*1e3}if(typeof e=="string"){const t=e.trim();if(!t)return null;const n=Date.parse(t);if(Number.isFinite(n))return n}return null}function An(e){return Array.isArray(e)?e.map(t=>{let r=D(t.close);if(r==null){const a=D(t.close_raw);a!=null&&(r=a/1e8)}return r==null?null:{date:Pn(t.date)??t.date,close:r}}).filter(t=>!!t):[]}function bt(e){var r;const t=D(e==null?void 0:e.last_price_native)??D((r=e==null?void 0:e.last_price)==null?void 0:r.native)??null;if(N(t))return t;if(Le(e==null?void 0:e.currency_code)==="EUR"){const i=D(e==null?void 0:e.last_price_eur);if(N(i))return i}return null}function mi(e){if(!e)return null;const n=e.last_price_fetched_at,r=Te(n);if(r!=null)return r;const i=e.last_price,a=i==null?void 0:i.fetched_at;return Te(a)??null}function ot(e,t){let n=[];Array.isArray(e)&&(n=e.map(s=>({...s})));const r=n.slice(),i=bt(t);if(!N(i))return r;const a=mi(t)??Date.now(),o=new Date(a);if(Number.isNaN(o.getTime()))return r;const c=De(at(o));let l=null;for(let s=r.length-1;s>=0;s-=1){const d=r[s],u=Pn(d.date);if(!u)continue;const f=De(at(u));if(l==null&&(l=f),f===c)return d.close!==i&&(r[s]={...d,close:i}),r;if(f<c)break}return l!=null&&l>c||r.push({date:o,close:i}),r}function N(e){return typeof e=="number"&&Number.isFinite(e)}function Tt(e){return typeof e=="number"&&Number.isFinite(e)&&e>0}function Se(e,t,n){if(!N(e)||!N(t))return!1;const r=Math.abs(e-t),i=Math.max(Math.abs(e),Math.abs(t),1);return r<=i*1e-4}function bi(e,t){return!N(t)||t===0||!N(e)?null:ir((e-t)/t*100)}function Fn(e,t){if(e.length===0)return{priceChange:null,priceChangePct:null};const n=e[0],r=D(n.close);if(!N(r)||r===0)return{priceChange:null,priceChangePct:null};const i=e[e.length-1],a=D(i.close),o=D(t)??a;if(!N(o))return{priceChange:null,priceChangePct:null};const c=o-r,l=Object.is(c,-0)?0:c,s=bi(o,r);return{priceChange:l,priceChangePct:s}}function yt(e,t){if(!N(e)||e===0)return"neutral";const n=.5/Math.pow(10,t);return Math.abs(e)<n?"neutral":e>0?"positive":"negative"}function yi(e,t){if(!N(e))return'<span class="value neutral">—</span>';const n=ee(e);if(n==="—")return'<span class="value neutral">—</span>';const r=yt(e,xe.max),i=t?`&nbsp;${t}`:"";return`<span class="value ${r}">${n}${i}</span>`}function _i(e){return N(e)?`<span class="value ${yt(e,2)} value--percentage">${K(e)}&nbsp;%</span>`:'<span class="value neutral">—</span>'}function En(e,t,n,r){const i=e,a=i.length>0?i:"Zeitraum";return`
    <div class="security-info-bar" data-range="${i}">
      <div class="security-info-item">
        <span class="label">Preisänderung (${a})</span>
        <div class="value-row">
          ${yi(t,r)}
          ${_i(n)}
        </div>
      </div>
    </div>
  `}function vi(e){return`
    <div class="security-range-selector" role="group" aria-label="Zeitraum">
      ${pn.map(n=>`
      <button
        type="button"
        class="security-range-button${n===e?" active":""}"
        data-range="${n}"
        aria-pressed="${n===e?"true":"false"}"
      >
        ${n}
      </button>
    `).join(`
`)}
    </div>
  `}function wn(e,t={status:"empty"}){const n=e;switch(t.status){case"loaded":{const r=n.length>0?` für ${n}`:"";return`
        <div
          class="history-chart"
          data-state="loaded"
          data-range="${n}"
          role="img"
          aria-label="Preisverlauf${r}"
        ></div>
      `}case"error":{const r=vn(t.message,"Die historischen Daten konnten nicht geladen werden.");return`
        <div class="history-placeholder" data-state="error" data-range="${n}">
          <p>${r}</p>
        </div>
      `}case"empty":default:{const r=n.length>0?n:"den gewählten Zeitraum";return`
        <div class="history-placeholder" data-state="empty" data-range="${n}">
          <p>Für dieses Wertpapier liegen im Zeitraum ${r} keine historischen Daten vor.</p>
        </div>
      `}}}function Si(e){const t=D(e);if(t==null)return"—";const n=Math.abs(t%1)>0,r=n?2:Ye.min,i=n?Ye.max:Ye.min;return t.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:i})}function ee(e){const t=D(e);return t==null?"—":t.toLocaleString("de-DE",{minimumFractionDigits:xe.min,maximumFractionDigits:xe.max})}function Pi(e,t){const n=ee(e),r=`&nbsp;${t}`;return`<span class="${yt(e,xe.max)}">${n}${r}</span>`}function Ai(e){return e==null?"":(typeof e=="string"?e:String(e)).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Fi(e,t,n){const r=Ie(e),i=(r==null?void 0:r.account)??(N(t)?t:D(t));if(!N(i))return null;const a=(e==null?void 0:e.account_currency_code)??(e==null?void 0:e.account_currency);if(typeof a=="string"&&a.trim())return a.trim().toUpperCase();const o=Le(e==null?void 0:e.currency_code)??"",c=(r==null?void 0:r.security)??(r==null?void 0:r.native)??(N(n)?n:D(n)),l=si(e);if(o&&N(c)&&Se(i,c))return o;const s=D(l==null?void 0:l.purchase_total_security)??D(e==null?void 0:e.purchase_total_security),d=D(l==null?void 0:l.purchase_total_account)??D(e==null?void 0:e.purchase_total_account);let u=null;if(N(s)&&s!==0&&N(d)&&(u=d/s),(r==null?void 0:r.source)==="eur_total")return"EUR";const p=r==null?void 0:r.eur;if(N(p)&&Se(i,p))return"EUR";const g=D(e==null?void 0:e.purchase_value_eur);return N(g)?"EUR":u!=null&&Se(u,1)?o||null:o==="EUR"?"EUR":o||"EUR"}function Rt(e){return typeof e!="number"||!Number.isFinite(e)||e<=0?null:e.toLocaleString("de-DE",{minimumFractionDigits:4,maximumFractionDigits:4})}function Ei(e){const t=e,n=["purchase_fx_date","purchase_fx_timestamp","purchase_fx_rate_date","purchase_fx_rate_timestamp","avg_price_updated_at","avg_price_timestamp","purchase_updated_at","purchase_updated","purchase_value_updated_at","purchase_value_updated","last_purchase_date","last_purchase_timestamp","last_transaction_date","last_transaction_at"];for(const a of n){const o=t==null?void 0:t[a],c=Te(o);if(c!=null)return c}const r=[];t&&"last_price_fetched_at"in t&&r.push(t.last_price_fetched_at);const i=e==null?void 0:e.last_price;i&&typeof i=="object"&&r.push(i.fetched_at),t&&"last_price_date"in t&&r.push(t.last_price_date);for(const a of r){const o=Te(a);if(o!=null)return o}return null}function wi(e){if(e==null||!Number.isFinite(e))return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function Ni(e,t){const n=Le(e==null?void 0:e.currency_code)??"",r=Le(t)??"";if(!n||!r||n===r)return null;const i=Ie(e);if(!i)return null;const a=i.native??i.security??null,o=i.account??i.eur??null;if(!Tt(a)||!Tt(o))return null;const c=o/a;if(!Number.isFinite(c)||c<=0)return null;const l=Rt(c);if(!l)return null;let s=null;if(c>0){const m=1/c;Number.isFinite(m)&&m>0&&(s=Rt(m))}const d=Ei(e),u=wi(d),f=[`FX-Kurs (Kauf): 1 ${n} = ${l} ${r}`];s&&f.push(`1 ${r} = ${s} ${n}`);const p=[],g=i.source,_=g in je?je[g]:je.aggregation;if(p.push(`Quelle: ${_}`),N(i.coverage_ratio)){const m=Math.min(Math.max(i.coverage_ratio*100,0),100);p.push(`Abdeckung: ${m.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})}%`)}p.length&&f.push(...p);const h=u??"Datum unbekannt";return`${f.join(" · ")} (Stand: ${h})`}function $t(e){const t=Ie(e),n=(t==null?void 0:t.native)??(t==null?void 0:t.security)??null;return N(n)?n:null}function Ct(e){var U;if(!e)return'<div class="meta-error">Keine Snapshot-Daten verfügbar.</div>';const t=e.currency_code||"EUR",n=e.total_holdings_precise??e.total_holdings,r=Si(n),i=e.last_price_native??((U=e.last_price)==null?void 0:U.native)??e.last_price_eur,a=ee(i),o=a==="—"?null:`${a}${`&nbsp;${t}`}`,c=D(e.market_value_eur)??D(e.current_value_eur)??null,l=Ie(e),s=(l==null?void 0:l.native)??(l==null?void 0:l.security)??null,d=(l==null?void 0:l.eur)??null,f=(l==null?void 0:l.account)??null??d,p=X(e.performance),g=(p==null?void 0:p.day_change)??null,_=(g==null?void 0:g.price_change_native)??null,h=(g==null?void 0:g.price_change_eur)??null,m=N(_)?_:h,v=N(_)?t:"EUR",y=(H,C="")=>{const W=["value"];return C&&W.push(...C.split(" ").filter(Boolean)),`<span class="${W.join(" ")}">${H}</span>`},P=(H="")=>{const C=["value--missing"];return H&&C.push(H),y("—",C.join(" "))},E=(H,C="")=>{if(!N(H))return P(C);const W=["value--gain"];return C&&W.push(C),y(On(H),W.join(" "))},w=(H,C="")=>{if(!N(H))return P(C);const W=["value--gain-percentage"];return C&&W.push(C),y(zn(H),W.join(" "))},b=o?y(o,"value--price"):P("value--price"),A=r==="—"?P("value--holdings"):y(r,"value--holdings"),L=N(c)?y(`${K(c)}&nbsp;€`,"value--market-value"):P("value--market-value"),x=N(m)?y(Pi(m,v),"value--gain value--absolute"):P("value--absolute"),T=w(g==null?void 0:g.change_pct,"value--percentage"),$=E(p==null?void 0:p.total_change_eur,"value--absolute"),M=w(p==null?void 0:p.total_change_pct,"value--percentage"),R=Fi(e,f,s),S=Ni(e,R),F=S?` title="${Ai(S)}"`:"",q=[];return N(s)?q.push(y(`${ee(s)}${`&nbsp;${t}`}`,"value--average value--average-native")):q.push(P("value--average value--average-native")),N(f)&&(!N(s)||!R||!t||R!==t||!Se(f,s))&&N(f)&&q.push(y(`${ee(f)}${R?`&nbsp;${R}`:""}`,"value--average value--average-eur")),`
    <div class="security-meta-grid security-meta-grid--expanded">
      <div class="security-meta-item security-meta-item--price">
        <span class="label">Letzter Preis</span>
        <div class="value-group">${b}</div>
      </div>
      <div class="security-meta-item security-meta-item--average">
        <span class="label">Durchschnittlicher Kaufpreis</span>
        <div class="value-group"${F}>
          ${q.join("")}
        </div>
      </div>
      <div class="security-meta-item security-meta-item--day-change">
        <span class="label">Tagesänderung</span>
        <div class="value-group">
          ${x}
          ${T}
        </div>
      </div>
      <div class="security-meta-item security-meta-item--total-change">
        <span class="label">Gesamtänderung</span>
        <div class="value-group">
          ${$}
          ${M}
        </div>
      </div>
      <div class="security-meta-item security-meta-item--holdings">
        <span class="label">Bestand</span>
        <div class="value-group">${A}</div>
      </div>
      <div class="security-meta-item security-meta-item--market-value">
        <span class="label">Marktwert (EUR)</span>
        <div class="value-group">${L}</div>
      </div>
    </div>
  `}function Nn(e){if(!e)return null;if(typeof e=="string")return e;if(e instanceof Error)return e.message||null;try{const t=JSON.stringify(e);return t&&t!=="{}"?t:null}catch{return null}}function xi(e,t,{currency:n,baseline:r}={}){const i=e.clientWidth||e.offsetWidth||0,a=i>0?i:640,o=Math.min(Math.max(Math.floor(a*.55),220),420),c=(n||"").toUpperCase()||"EUR",l=N(r)?r:null;return{width:a,height:o,margin:{top:16,right:20,bottom:32,left:20},series:t,yFormatter:s=>ee(s),tooltipRenderer:({xFormatted:s,yFormatted:d})=>`
      <div class="chart-tooltip-date">${s}</div>
      <div class="chart-tooltip-value">${d}&nbsp;${c}</div>
    `,baseline:l!=null?{value:l}:null}}const Mt=new WeakMap;function Di(e,t,n={}){if(t.length===0)return;const r=xi(e,t,n);let i=Mt.get(e)??null;if(!i||!e.contains(i)){e.innerHTML="",i=Zr(e,r),i&&Mt.set(e,i);return}hn(i,r)}function kt(e,t){e&&(e.dataset.activeRange=t,e.querySelectorAll(".security-range-button").forEach(n=>{const i=n.dataset.range===t;n.classList.toggle("active",i),n.setAttribute("aria-pressed",i?"true":"false"),n.disabled=!1,n.classList.remove("loading")}))}function Li(e,t,n,r,i){const a=e.querySelector(".security-info-bar");if(!a||!a.parentElement)return;const o=document.createElement("div");o.innerHTML=En(t,n,r,i).trim();const c=o.firstElementChild;c&&a.parentElement.replaceChild(c,a)}function Ht(e,t,n,r,i={}){const a=e.querySelector(".security-detail-placeholder");if(a&&(a.innerHTML=`
    <h2>Historie</h2>
    ${wn(t,n)}
  `,n.status==="loaded"&&Array.isArray(r)&&r.length)){const o=a.querySelector(".history-chart");o&&requestAnimationFrame(()=>{Di(o,r,i)})}}function Ti(e){const{root:t,hass:n,panelConfig:r,securityUuid:i,snapshot:a,initialRange:o,initialHistory:c,initialHistoryState:l}=e;setTimeout(()=>{const s=t.querySelector(".security-range-selector");if(!s)return;const d=mn(i),u=$t(a);Array.isArray(c)&&l.status!=="error"&&d.set(o,c),fi(i),Lt(i,o),kt(s,o);const p=ot(c,a);let g=l;g.status!=="error"&&(g=p.length?{status:"loaded"}:{status:"empty"}),Ht(t,o,g,p,{currency:a==null?void 0:a.currency_code,baseline:u});const _=async h=>{if(h===_n(i))return;const m=s.querySelector(`.security-range-button[data-range="${h}"]`);m&&(m.disabled=!0,m.classList.add("loading"));let v=d.get(h)??null,y=null,P=[];if(v)y=v.length?{status:"loaded"}:{status:"empty"};else try{const L=Sn(h),x=await Wt(n,r,i,L);v=An(x.prices),d.set(h,v),y=v.length?{status:"loaded"}:{status:"empty"}}catch(L){console.error("Range-Wechsel: Historie konnte nicht geladen werden",L),v=[],y={status:"error",message:Nn(L)||"Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden."}}P=ot(v,a),y.status!=="error"&&(y=P.length?{status:"loaded"}:{status:"empty"});const E=bt(a),{priceChange:w,priceChangePct:b}=Fn(P,E);Lt(i,h),kt(s,h),Li(t,h,w,b,a==null?void 0:a.currency_code);const A=$t(a);Ht(t,h,y,P,{currency:a==null?void 0:a.currency_code,baseline:A})};s.addEventListener("click",h=>{var y;const m=(y=h.target)==null?void 0:y.closest(".security-range-button");if(!m||m.disabled)return;const{range:v}=m.dataset;!v||!pn.includes(v)||_(v)})},0)}async function Ri(e,t,n,r){if(!r)return console.error("renderSecurityDetail: securityUuid fehlt"),'<div class="card"><h2>Fehler</h2><p>Kein Wertpapier angegeben.</p></div>';const i=ui(r);let a=null,o=null;try{const w=await jn(t,n,r),b=w.snapshot;a=b&&typeof b=="object"?b:w}catch(w){console.error("renderSecurityDetail: Snapshot konnte nicht geladen werden",w),o=vn(w)}const c=a||i,l=!!(i&&!a),s=((c==null?void 0:c.source)??"")==="cache";r&&li(r,c??null);const d=c&&(l||s)?ci({fallbackUsed:l,flaggedAsCache:s}):"",u=(c==null?void 0:c.name)||"Wertpapierdetails";if(o)return`
      ${Ze(u,Ct(c)).outerHTML}
      ${d}
      <div class="card error-card">
        <h2>Fehler beim Laden</h2>
        <p>${o}</p>
      </div>
    `;const f=_n(r),p=mn(r);let g=p.has(f)?p.get(f)??null:null,_={status:"empty"};if(Array.isArray(g))_=g.length?{status:"loaded"}:{status:"empty"};else{g=[];try{const w=Sn(f),b=await Wt(t,n,r,w);g=An(b.prices),p.set(f,g),_=g.length?{status:"loaded"}:{status:"empty"}}catch(w){console.error("renderSecurityDetail: Historie konnte nicht geladen werden",w),_={status:"error",message:Nn(w)||"Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden."}}}const h=ot(g,c);_.status!=="error"&&(_=h.length?{status:"loaded"}:{status:"empty"});const m=Ze(u,Ct(c)),v=bt(c),{priceChange:y,priceChangePct:P}=Fn(h,v),E=En(f,y,P,c==null?void 0:c.currency_code);return Ti({root:e,hass:t,panelConfig:n,securityUuid:r,snapshot:c,initialRange:f,initialHistory:g,initialHistoryState:_}),`
    ${m.outerHTML}
    ${d}
    ${E}
    ${vi(f)}
    <div class="card security-detail-placeholder">
      <h2>Historie</h2>
      ${wn(f,_)}
    </div>
  `}function $i(e){const{setSecurityDetailTabFactory:t}=e;if(typeof t!="function"){console.error("registerSecurityDetailTab: Ungültige Factory-Funktion übergeben");return}t(n=>({title:"Wertpapier",render:(r,i,a)=>Ri(r,i,a,n),cleanup:()=>{pi(n)}}))}const Ci=Wn,st="pp-reader-sticky-anchor",Re="overview",ct="security:";function xn(){return typeof window>"u"?null:window}function*Dn(e){if(e instanceof Set)for(const t of e)t instanceof HTMLElement&&(yield t)}function*Mi(){const e=xn();e&&(yield*Dn(e.__ppReaderDashboardElements))}function*ki(){const e=xn();e&&(yield*Dn(e.__ppReaderPanelHosts))}const Hi=[{key:Re,title:"Dashboard",render:nn}],ae=new Map,me=[],$e=new Map;let lt=null,Xe=!1,te=null,k=0,oe=null;function Ce(e){return typeof e=="object"&&e!==null}function Ln(e){return typeof e=="object"&&e!==null&&typeof e.then=="function"}function Ii(e){if(typeof e=="string"){const t=e.trim();return t.length>0?t:"Unbekannter Fehler"}if(e instanceof Error){const t=e.message.trim();return t.length>0?t:e.name}if(e!=null)try{const t=JSON.stringify(e);if(t&&t!=="{}")return t}catch{}return String(e)}function Ui(e){return e==="accounts"||e==="last_file_update"||e==="portfolio_values"||e==="portfolio_positions"}function It(e){const t=e.portfolio_uuid;if(typeof t=="string"&&t)return t;const n=e.portfolioUuid;return typeof n=="string"&&n?n:null}function Vi(e){if(!e)return null;if(Array.isArray(e)){for(const t of e)if(Ce(t)){const n=It(t);if(n)return n}return null}return Ce(e)?It(e):null}function qi(e,t){switch(e){case"accounts":return{type:e,data:Array.isArray(t)?t:null};case"last_file_update":return typeof t=="string"?{type:e,data:t}:Ce(t)?{type:e,data:t}:{type:e,data:null};case"portfolio_values":return Array.isArray(t)?{type:e,data:t}:{type:e,data:null};case"portfolio_positions":return Array.isArray(t)?{type:e,data:t}:Ce(t)?{type:e,data:t}:{type:e,data:null};default:return null}}function _t(e){return typeof e!="string"||!e.startsWith(ct)?null:e.slice(ct.length)||null}function Wi(){if(!te)return!1;const e=Mn(te);return e||(te=null),e}function B(){const e=me.map(t=>ae.get(t)).filter(t=>!!t);return[...Hi,...e]}function Oi(e){const t=B();return e<0||e>=t.length?null:t[e]}function Tn(e){if(!e)return null;const t=e,n=t.ppreader??t.pp_reader;return n||(Object.values(t).find(i=>!i||typeof i!="object"?!1:i.webcomponent_name==="pp-reader-panel")??null)}function Rn(){try{const e=vt();e&&typeof e.rememberScrollPosition=="function"&&e.rememberScrollPosition()}catch(e){console.warn("rememberCurrentPageScroll: konnte Scroll-Position nicht sichern",e)}}function Ut(e){const t=B();return!t.length||e<0?0:e>=t.length?t.length-1:e}async function zi(e,t,n,r){const i=B(),a=Ut(e);if(a===k){e>k&&Wi();return}Rn();const o=k>=0&&k<i.length?i[k]:null,c=o?_t(o.key):null;let l=a;if(c){const s=a>=0&&a<i.length?i[a]:null;if(s&&s.key===Re&&ji(c,{suppressRender:!0})){const f=B().findIndex(p=>p.key===Re);l=f>=0?f:0}}if(!Xe){Xe=!0;try{k=Ut(l);const s=k;await kn(t,n,r),Yi(s)}catch(s){console.error("navigateToPage: Fehler beim Rendern des Tabs",s)}finally{Xe=!1}}}function Me(e,t,n,r){zi(k+e,t,n,r)}function Bi(e,t){if(!e||!t||typeof t.render!="function"){console.error("registerDetailTab: Ungültiger Tab-Descriptor",e,t);return}const n=_t(e);if(n){const i=$e.get(n);i&&i!==e&&$n(i)}const r={...t,key:e};ae.set(e,r),n&&$e.set(n,e),me.includes(e)||me.push(e)}function $n(e){if(!e)return;const t=ae.get(e);if(t&&typeof t.cleanup=="function")try{const i=t.cleanup({key:e});Ln(i)&&i.catch(a=>{console.error("unregisterDetailTab: Fehler beim asynchronen cleanup",a)})}catch(i){console.error("unregisterDetailTab: Fehler beim Ausführen von cleanup",i)}ae.delete(e);const n=me.indexOf(e);n>=0&&me.splice(n,1);const r=_t(e);r&&$e.get(r)===e&&$e.delete(r)}function Gi(e){return ae.has(e)}function Vt(e){return ae.get(e)??null}function Ki(e){if(e!=null&&typeof e!="function"){console.error("setSecurityDetailTabFactory: Erwartet Funktion oder null",e);return}lt=e??null}function Cn(e){return`${ct}${e}`}function vt(){var t;for(const n of er())if(n!=null&&n.isConnected)return n;for(const n of Mi())if(n.isConnected)return n;const e=new Set;for(const n of tr())n instanceof HTMLElement&&e.add(n);for(const n of ki())e.add(n);for(const n of e){const r=(t=n.shadowRoot)==null?void 0:t.querySelector("pp-reader-dashboard");if(r)return r}return null}function ut(){const e=vt();if(!e){console.warn("requestDashboardRender: Kein pp-reader-dashboard Element gefunden");return}if(typeof e._renderIfInitialized=="function"){e._renderIfInitialized();return}typeof e._render=="function"&&e._render()}function Yi(e){const t=vt();if(t&&typeof t.handleExternalRender=="function")try{t.handleExternalRender(e)}catch(n){console.warn("notifyExternalRender: Fehler beim Synchronisieren des Dashboards",n)}}function Mn(e){if(!e)return console.error("openSecurityDetail: Ungültige securityUuid",e),!1;const t=Cn(e);let n=Vt(t);if(!n&&typeof lt=="function")try{const a=lt(e);a&&typeof a.render=="function"?(Bi(t,a),n=Vt(t)):console.error("openSecurityDetail: Factory lieferte ungültigen Descriptor",a)}catch(a){console.error("openSecurityDetail: Fehler beim Erzeugen des Tab-Descriptors",a)}if(!n)return console.warn(`openSecurityDetail: Kein Detail-Tab für ${e} verfügbar`),!1;Rn();let i=B().findIndex(a=>a.key===t);return i===-1&&(i=B().findIndex(o=>o.key===t),i===-1)?(console.error("openSecurityDetail: Tab nach Registrierung nicht auffindbar"),!1):(k=i,te=null,ut(),!0)}function ji(e,t={}){if(!e)return console.error("closeSecurityDetail: Ungültige securityUuid",e),!1;const{suppressRender:n=!1}=t,r=Cn(e);if(!Gi(r))return!1;const a=B().findIndex(l=>l.key===r),o=a===k;$n(r);const c=B();if(!c.length)return k=0,n||ut(),!0;if(te=e,o){const l=c.findIndex(s=>s.key===Re);l>=0?k=l:k=Math.min(Math.max(a-1,0),c.length-1)}else k>=c.length&&(k=Math.max(0,c.length-1));return n||ut(),!0}async function kn(e,t,n){let r=n;r||(r=Tn(t?t.panels:null));const i=B();k>=i.length&&(k=Math.max(0,i.length-1));const a=Oi(k);if(!a){console.error("renderTab: Kein gültiger Tab oder keine render-Methode gefunden!");return}let o;try{o=await a.render(e,t,r)}catch(d){console.error("renderTab: Fehler beim Rendern des Tabs:",d),e.innerHTML=`<div class="card"><h2>Fehler</h2><pre>${Ii(d)}</pre></div>`;return}e.innerHTML=o??"",a.render===nn&&mt(e);const l=await new Promise(d=>{const u=window.setInterval(()=>{const f=e.querySelector(".header-card");f&&(clearInterval(u),d(f))},50)});let s=e.querySelector(`#${st}`);if(!s){s=document.createElement("div"),s.id=st;const d=l.parentNode;d&&"insertBefore"in d&&d.insertBefore(s,l)}Ji(e,t,n),Zi(e,t,n),Xi(e)}function Xi(e){const t=e.querySelector(".header-card"),n=e.querySelector(`#${st}`);if(!t||!n){console.error("Fehlende Elemente für das Scrollverhalten: headerCard oder anchor.");return}oe==null||oe.disconnect(),oe=new IntersectionObserver(([r])=>{r.isIntersecting?t.classList.remove("sticky"):t.classList.add("sticky")},{root:null,rootMargin:"0px 0px 0px 0px",threshold:0}),oe.observe(n)}function Zi(e,t,n){const r=e.querySelector(".header-card");if(!r){console.error("Header-Card nicht gefunden!");return}Ci(r,()=>{Me(1,e,t,n)},()=>{Me(-1,e,t,n)})}function Ji(e,t,n){const r=e.querySelector(".header-card");if(!r){console.error("Header-Card nicht gefunden!");return}const i=r.querySelector("#nav-left"),a=r.querySelector("#nav-right");if(!i||!a){console.error("Navigationspfeile nicht gefunden!");return}i.addEventListener("click",()=>{Me(-1,e,t,n)}),a.addEventListener("click",()=>{Me(1,e,t,n)}),Qi(r)}function Qi(e){const t=e.querySelector("#nav-left"),n=e.querySelector("#nav-right");if(t&&(k===0?(t.disabled=!0,t.classList.add("disabled")):(t.disabled=!1,t.classList.remove("disabled"))),n){const r=B(),a=!(k===r.length-1)||!!te;n.disabled=!a,n.classList.toggle("disabled",!a)}}class ea extends HTMLElement{constructor(){super();V(this,"_root");V(this,"_hass",null);V(this,"_panel",null);V(this,"_narrow",null);V(this,"_route",null);V(this,"_lastPanel",null);V(this,"_lastNarrow",null);V(this,"_lastRoute",null);V(this,"_lastPage",null);V(this,"_scrollPositions",{});V(this,"_unsubscribeEvents",null);V(this,"_initialized",!1);V(this,"_hasNewData",!1);V(this,"_pendingUpdates",[]);V(this,"_entryIdWaitWarned",!1);this._root=document.createElement("div"),this._root.className="pp-reader-dashboard",this.appendChild(this._root)}set hass(n){this._hass=n??null,this._checkInitialization()}set panel(n){this._panel!==n&&(this._panel=n??null,this._checkInitialization())}set narrow(n){this._narrow!==(n??null)&&(this._narrow=n??null,this._renderIfInitialized())}set route(n){this._route!==(n??null)&&(this._route=n??null,this._renderIfInitialized())}connectedCallback(){this._checkInitialization()}disconnectedCallback(){this._removeEventListeners()}_checkInitialization(){if(!this._hass||this._initialized)return;this._panel||(this._panel=Tn(this._hass.panels??null));const n=Pt(this._hass,this._panel);if(!n){this._entryIdWaitWarned||(console.warn("PPReaderDashboard: kein entry_id ermittelbar – warte auf Panel-Konfiguration."),this._entryIdWaitWarned=!0);return}this._entryIdWaitWarned=!1,console.debug("PPReaderDashboard: entry_id (fallback) =",n),this._initialized=!0,this._initializeEventListeners(),this._render()}_initializeEventListeners(){var o;this._removeEventListeners();const n=(o=this._hass)==null?void 0:o.connection;if(!n||typeof n.subscribeEvents!="function"){console.error("PPReaderDashboard: keine valide WebSocket-Verbindung oder subscribeEvents fehlt");return}const r=["panels_updated"],i=[];Promise.all(r.map(async c=>{try{const l=await n.subscribeEvents(this._handleBusEvent.bind(this),c);typeof l=="function"?(i.push(l),console.debug("PPReaderDashboard: subscribed to",c)):console.error("PPReaderDashboard: subscribeEvents lieferte kein Unsubscribe-Func für",c,l)}catch(l){console.error("PPReaderDashboard: Fehler bei subscribeEvents für",c,l)}})).then(()=>{this._unsubscribeEvents=()=>{i.forEach(c=>{try{c()}catch{}}),console.debug("PPReaderDashboard: alle Event-Subscriptions entfernt")}}).catch(c=>{console.error("PPReaderDashboard: Fehler beim Registrieren der Events",c)})}_removeEventListeners(){if(typeof this._unsubscribeEvents=="function")try{this._unsubscribeEvents()}catch(n){console.error("PPReaderDashboard: Fehler beim Entfernen der Event-Listener:",n)}this._unsubscribeEvents=null}_handleBusEvent(n){const r=Pt(this._hass,this._panel);if(!r)return;const i=n.data;if(!Ui(i.data_type)||i.entry_id&&i.entry_id!==r)return;const a=qi(i.data_type,i.data);a&&(this._queueUpdate(a.type,a.data),this._doRender(a.type,a.data))}_doRender(n,r){switch(n){case"accounts":yr(r,this._root);break;case"last_file_update":Er(r,this._root);break;case"portfolio_values":vr(r,this._root);break;case"portfolio_positions":Pr(r,this._root);break;default:console.warn("PPReaderDashboard: Unbekannter Datentyp:",n);break}}_queueUpdate(n,r){const i=this._cloneData(r),a={type:n,data:i};n==="portfolio_positions"&&(a.portfolioUuid=Vi(i));let o=-1;n==="portfolio_positions"&&a.portfolioUuid?o=this._pendingUpdates.findIndex(c=>c.type===n&&c.portfolioUuid===a.portfolioUuid):o=this._pendingUpdates.findIndex(c=>c.type===n),o>=0?this._pendingUpdates[o]=a:this._pendingUpdates.push(a),this._hasNewData=!0}_cloneData(n){if(n==null)return n;try{if(typeof structuredClone=="function")return structuredClone(n)}catch(r){console.warn("PPReaderDashboard: structuredClone fehlgeschlagen, falle auf JSON zurück",r)}try{return JSON.parse(JSON.stringify(n))}catch(r){return console.warn("PPReaderDashboard: JSON-Clone fehlgeschlagen, referenziere Originaldaten",r),n}}_reapplyPendingUpdates(){if(!(!Array.isArray(this._pendingUpdates)||this._pendingUpdates.length===0))for(const n of this._pendingUpdates)try{this._doRender(n.type,this._cloneData(n.data))}catch(r){console.error("PPReaderDashboard: Fehler beim erneuten Anwenden eines Updates",n,r)}}_renderIfInitialized(){this._initialized&&this._render()}handleExternalRender(n){this._afterRender(n)}rememberScrollPosition(n=k){const r=Number.isInteger(n)?n:k;this._scrollPositions[r]=this._root.scrollTop||0}_render(){if(!this._hass){console.warn("pp-reader-dashboard: noch kein hass, überspringe _render()");return}if(!this._initialized){console.debug("pp-reader-dashboard: _render aufgerufen bevor initialisiert");return}const n=k;if(!this._hasNewData&&this._panel===this._lastPanel&&this._narrow===this._lastNarrow&&this._route===this._lastRoute&&this._lastPage===n)return;this._lastPage!=null&&(this._scrollPositions[this._lastPage]=this._root.scrollTop);const r=kn(this._root,this._hass,this._panel);if(Ln(r)){r.then(()=>{this._afterRender(n)}).catch(i=>{console.error("PPReaderDashboard: Fehler beim Rendern des Tabs",i),this._afterRender(n)});return}this._afterRender(n)}_afterRender(n){const r=this._scrollPositions[n]||0;this._root.scrollTop=r,this._lastPanel=this._panel,this._lastNarrow=this._narrow,this._lastRoute=this._route,this._lastPage=n;try{this._reapplyPendingUpdates()}catch(i){console.error("PPReaderDashboard: Fehler beim Wiederanlegen der Updates",i)}this._hasNewData=!1}}customElements.get("pp-reader-dashboard")||customElements.define("pp-reader-dashboard",ea);console.log("PPReader dashboard module v20250914b geladen");$i({setSecurityDetailTabFactory:Ki});
//# sourceMappingURL=dashboard.CBExcrhS.js.map
