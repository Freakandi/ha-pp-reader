var Fn=Object.defineProperty;var xn=(e,t,n)=>t in e?Fn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var W=(e,t,n)=>xn(e,typeof t!="symbol"?t+"":t,n);function En(e,t,n){let r=null;e.addEventListener("touchstart",a=>{a.touches.length===1&&(r=a.touches[0].clientX)},{passive:!0}),e.addEventListener("touchend",a=>{if(r===null)return;const i=a.changedTouches[0].clientX-r;i<-50?t():i>50&&n(),r=null},{passive:!0}),e.addEventListener("mousedown",a=>{r=a.clientX},{passive:!0}),e.addEventListener("mouseup",a=>{if(r===null)return;const i=a.clientX-r;i<-50?t():i>50&&n(),r=null},{passive:!0})}const at=(e,t)=>{if(!Number.isFinite(e)||e===0)return"neutral";const n=.5/Math.pow(10,t);return Math.abs(e)<n?"neutral":e>0?"positive":"negative"};function V(e,t,n=void 0,r=void 0){let a=null;const i=o=>{if(typeof o=="number")return o;if(typeof o=="string"&&o.trim()!==""){const l=o.replace(/\s+/g,"").replace(/[^0-9,.-]/g,"").replace(/\.(?=\d{3}(\D|$))/g,"").replace(",","."),u=Number.parseFloat(l);return Number.isNaN(u)?Number.NaN:u}return Number.NaN},s=(o,l=2,u=2)=>{const d=typeof o=="number"?o:i(o);return Number.isFinite(d)?d.toLocaleString("de-DE",{minimumFractionDigits:l,maximumFractionDigits:u}):""},c=(o="")=>{const l=o||"Kein Wert verfügbar";return`<span class="missing-value" role="note" aria-label="${l}" title="${l}">—</span>`};if(["gain_abs","gain_pct"].includes(e)){const o=n,l=o!=null&&o.fx_unavailable?"Wechselkurs nicht verfügbar – EUR-Wert unbekannt":"";if(t==null||r&&r.hasValue===!1)return c(l);const u=typeof t=="number"?t:i(t);if(!Number.isFinite(u))return c(l);const d=e==="gain_pct"?"%":"€";return a=s(u)+`&nbsp;${d}`,`<span class="${at(u,2)}">${a}</span>`}else if(e==="position_count"){const o=typeof t=="number"?t:i(t);if(!Number.isFinite(o))return c();a=o.toLocaleString("de-DE")}else if(["balance","current_value","purchase_value"].includes(e)){const o=typeof t=="number"?t:i(t);if(!Number.isFinite(o))return n!=null&&n.fx_unavailable?c("Wechselkurs nicht verfügbar – EUR-Wert unbekannt"):(r&&r.hasValue===!1,c());a=s(o)+"&nbsp;€"}else if(e==="current_holdings"){const o=typeof t=="number"?t:i(t);if(!Number.isFinite(o))return c();const l=Math.abs(o%1)>0;a=o.toLocaleString("de-DE",{minimumFractionDigits:l?2:0,maximumFractionDigits:4})}else a=typeof t=="string"?t:t!=null?String(t):"",a&&(a.length>60&&(a=a.slice(0,59)+"…"),a.startsWith("Kontostand ")?a=a.substring(11):a.startsWith("Depotwert ")&&(a=a.substring(10)));return a==null||a===""?c():a}function ce(e,t,n=[],r={}){const{sortable:a=!1,defaultSort:i}=r||{},s=(i==null?void 0:i.key)??"",c=(i==null?void 0:i.dir)==="desc"?"desc":"asc",o=p=>p==null?"":String(p).replace(/&/g,"&amp;").replace(/"/g,"&quot;");let l="<table><thead><tr>";t.forEach(p=>{const b=p.align==="right"?' class="align-right"':"";a&&p.key?l+=`<th${b} data-sort-key="${p.key}">${p.label}</th>`:l+=`<th${b}>${p.label}</th>`}),l+="</tr></thead><tbody>",e.forEach(p=>{l+="<tr>",t.forEach(b=>{const h=b.align==="right"?' class="align-right"':"";l+=`<td${h}>${V(b.key,p[b.key],p)}</td>`}),l+="</tr>"});const u={},d={};t.forEach(p=>{if(n.includes(p.key)){let b=0,h=!1;e.forEach(g=>{const P=g[p.key];typeof P=="number"&&Number.isFinite(P)&&(b+=P,h=!0)}),u[p.key]=h?b:null,d[p.key]={hasValue:h}}});const f=u.gain_abs??null;if(f!=null){const p=u.purchase_value??null;if(p!=null&&p>0)u.gain_pct=f/p*100;else{const b=u.current_value??null;b!=null&&b!==0&&(u.gain_pct=f/(b-f)*100)}}const _=Number.isFinite(u.gain_pct??NaN)?u.gain_pct:null;let m="",y="neutral";if(_!=null&&(m=`${Z(_)} %`,_>0?y="positive":_<0&&(y="negative")),l+='<tr class="footer-row">',t.forEach((p,b)=>{const h=p.align==="right"?' class="align-right"':"";if(b===0){l+=`<td${h}>Summe</td>`;return}if(u[p.key]!=null){let P="";p.key==="gain_abs"&&m&&(P=` data-gain-pct="${o(m)}" data-gain-sign="${o(y)}"`),l+=`<td${h}${P}>${V(p.key,u[p.key],void 0,d[p.key])}</td>`;return}if(p.key==="gain_pct"&&u.gain_pct!=null){l+=`<td${h}>${V("gain_pct",u.gain_pct,void 0,d[p.key])}</td>`;return}const g=d[p.key]??{hasValue:!1};l+=`<td${h}>${V(p.key,null,void 0,g)}</td>`}),l+="</tr>",l+="</tbody></table>",a)try{const p=document.createElement("template");p.innerHTML=l.trim();const b=p.content.querySelector("table");if(b)return b.classList.add("sortable-table"),s&&(b.dataset.defaultSort=s,b.dataset.defaultDir=c),b.outerHTML}catch(p){console.warn("makeTable(sortable): Injection fehlgeschlagen:",p)}return l}function Ke(e,t){const n=document.createElement("div");return n.className="header-card",n.innerHTML=`
    <div class="header-content">
      <button id="nav-left" class="nav-arrow" aria-label="Vorherige Seite">
        <svg viewBox="0 0 24 24">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
        </svg>
      </button>
      <h1 id="headerTitle">${e}</h1>
      <button id="nav-right" class="nav-arrow" aria-label="Nächste Seite">
        <svg viewBox="0 0 24 24">
          <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
        </svg>
      </button>
    </div>
    <div id="headerMeta" class="meta">${t}</div>
  `,n}function Z(e,t=2,n=2){return(Number.isNaN(e)?0:e).toLocaleString("de-DE",{minimumFractionDigits:t,maximumFractionDigits:n})}function Dn(e){const t=Number.isNaN(e)?0:e;return`<span class="${at(t,2)}">${Z(t)}&nbsp;€</span>`}function Rn(e){const t=Number.isNaN(e)?0:e;return`<span class="${at(t,2)}">${Z(t)}&nbsp;%</span>`}function kt(e,t,n="asc",r=!1){if(!e)return[];const a=e.querySelector("tbody");if(!a)return[];const i=a.querySelector("tr.footer-row"),s=Array.from(a.querySelectorAll("tr")).filter(u=>u!==i);let c=-1;if(r)c={name:0,current_holdings:1,purchase_value:2,current_value:3,gain_abs:4,gain_pct:5}[t];else{const u=Array.from(e.querySelectorAll("thead th"));for(let d=0;d<u.length;d++)if(u[d].getAttribute("data-sort-key")===t){c=d;break}}if(c==null||c<0)return s;const o=u=>{if(u==null)return NaN;const d=u.replace(/\u00A0/g," ").replace(/[%€]/g,"").replace(/\./g,"").replace(/,/g,".").replace(/[^\d.-]/g,"").trim();if(!d)return NaN;const f=parseFloat(d);return Number.isFinite(f)?f:NaN};s.sort((u,d)=>{const f=u.cells.item(c),_=d.cells.item(c),m=((f==null?void 0:f.textContent)??"").trim(),y=((_==null?void 0:_.textContent)??"").trim(),p=o(m),b=o(y);let h;const g=/[0-9]/.test(m)||/[0-9]/.test(y);return!Number.isNaN(p)&&!Number.isNaN(b)&&g?h=p-b:h=m.localeCompare(y,"de",{sensitivity:"base"}),n==="asc"?h:-h}),s.forEach(u=>a.appendChild(u)),i&&a.appendChild(i),e.querySelectorAll("thead th.sort-active").forEach(u=>{u.classList.remove("sort-active","dir-asc","dir-desc")});const l=e.querySelector(`thead th[data-sort-key="${t}"]`);return l&&l.classList.add("sort-active",n==="asc"?"dir-asc":"dir-desc"),s}function ae(e,t){var r,a,i,s,c,o,l,u;let n=((r=t==null?void 0:t.config)==null?void 0:r.entry_id)??(t==null?void 0:t.entry_id)??((s=(i=(a=t==null?void 0:t.config)==null?void 0:a._panel_custom)==null?void 0:i.config)==null?void 0:s.entry_id)??void 0;if(!n&&(e!=null&&e.panels)){const d=e.panels,f=d.ppreader??d.pp_reader??Object.values(d).find(_=>(_==null?void 0:_.webcomponent_name)==="pp-reader-panel");n=((c=f==null?void 0:f.config)==null?void 0:c.entry_id)??(f==null?void 0:f.entry_id)??((u=(l=(o=f==null?void 0:f.config)==null?void 0:o._panel_custom)==null?void 0:l.config)==null?void 0:u.entry_id)??void 0}return n??void 0}function ht(e,t){return ae(e,t)}async function Ln(e,t){if(!e)throw new Error("fetchAccountsWS: fehlendes hass");const n=ae(e,t);if(!n)throw new Error("fetchAccountsWS: fehlendes entry_id");return e.connection.sendMessagePromise({type:"pp_reader/get_accounts",entry_id:n})}async function Tn(e,t){if(!e)throw new Error("fetchLastFileUpdateWS: fehlendes hass");const n=ae(e,t);if(!n)throw new Error("fetchLastFileUpdateWS: fehlendes entry_id");const r=await e.connection.sendMessagePromise({type:"pp_reader/get_last_file_update",entry_id:n});if(typeof r=="string")return r;const a=r==null?void 0:r.last_file_update;return typeof a=="string"?a:""}async function $n(e,t){if(!e)throw new Error("fetchPortfoliosWS: fehlendes hass");const n=ae(e,t);if(!n)throw new Error("fetchPortfoliosWS: fehlendes entry_id");return e.connection.sendMessagePromise({type:"pp_reader/get_portfolio_data",entry_id:n})}async function Mt(e,t,n){if(!e)throw new Error("fetchPortfolioPositionsWS: fehlendes hass");const r=ae(e,t);if(!r)throw new Error("fetchPortfolioPositionsWS: fehlendes entry_id");if(!n)throw new Error("fetchPortfolioPositionsWS: fehlendes portfolio_uuid");return e.connection.sendMessagePromise({type:"pp_reader/get_portfolio_positions",entry_id:r,portfolio_uuid:n})}async function Cn(e,t,n){if(!e)throw new Error("fetchSecuritySnapshotWS: fehlendes hass");const r=ae(e,t);if(!r)throw new Error("fetchSecuritySnapshotWS: fehlendes entry_id");if(!n)throw new Error("fetchSecuritySnapshotWS: fehlendes securityUuid");return e.connection.sendMessagePromise({type:"pp_reader/get_security_snapshot",entry_id:r,security_uuid:n})}async function Ht(e,t,n,r={}){if(!e)throw new Error("fetchSecurityHistoryWS: fehlendes hass");const a=ae(e,t);if(!a)throw new Error("fetchSecurityHistoryWS: fehlendes entry_id");if(!n)throw new Error("fetchSecurityHistoryWS: fehlendes securityUuid");const i={type:"pp_reader/get_security_history",entry_id:a,security_uuid:n},{startDate:s,endDate:c,start_date:o,end_date:l}=r||{},u=s??o;u!=null&&(i.start_date=u);const d=c??l;return d!=null&&(i.end_date=d),e.connection.sendMessagePromise(i)}const kn=2;function it(e){var t;if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const n=e.trim().replace(/\u00a0/g,"");if(!n)return null;const r=Number(n);if(Number.isFinite(r))return r;const a=n.replace(/[^0-9.,+-]/g,"");if(!a)return null;const i=a.lastIndexOf(","),s=a.lastIndexOf(".");let c=a;const o=i!==-1,l=s!==-1;if(o&&(!l||i>s))if(l)c=c.replace(/\./g,"").replace(",",".");else{const f=c.split(","),_=((t=f[f.length-1])==null?void 0:t.length)??0,m=f.slice(0,-1).join(""),y=m.replace(/[+-]/g,"").length,p=f.length>2,b=/^[-+]?0$/.test(m);c=p||_===0||_===3&&y>0&&y<=3&&!b?c.replace(/,/g,""):c.replace(",",".")}else l&&o&&s>i?c=c.replace(/,/g,""):l&&c.length-s-1===3&&/\d{4,}/.test(c.replace(/\./g,""))&&(c=c.replace(/\./g,""));if(c==="-"||c==="+")return null;const u=Number.parseFloat(c);if(Number.isFinite(u))return u;const d=Number.parseFloat(a.replace(",","."));if(Number.isFinite(d))return d}return null}function O(e,{decimals:t=kn,fallback:n=null}={}){const r=it(e);if(r==null)return n??null;const a=10**t,i=Math.round(r*a)/a;return Object.is(i,-0)?0:i}function xe(e,t={}){return O(e,t)}function Mn(e,t={}){return O(e,t)}const Hn=/^[+-]?(?:\d+\.?\d*|\d*\.?\d+)(?:[eE][+-]?\d+)?$/,X=e=>{if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){const t=e.trim();if(!t||!Hn.test(t))return null;const n=Number(t);if(Number.isFinite(n))return n}return null},It=e=>{if(typeof e!="string")return null;const t=e.trim();return t||null};function In(e){const t=e&&typeof e=="object"?e:null;if(!t)return null;const n=X(t.price_change_native),r=X(t.price_change_eur),a=X(t.change_pct);if(n==null&&r==null&&a==null)return null;const i=It(t.source)??"derived",s=X(t.coverage_ratio)??null;return{price_change_native:n,price_change_eur:r,change_pct:a,source:i,coverage_ratio:s}}function re(e){const t=e&&typeof e=="object"?e:null;if(!t)return null;const n=X(t.gain_abs),r=X(t.gain_pct),a=X(t.total_change_eur),i=X(t.total_change_pct);if(n==null||r==null||a==null||i==null)return null;const s=It(t.source)??"derived",c=X(t.coverage_ratio)??null,o=In(t.day_change);return{gain_abs:n,gain_pct:r,total_change_eur:a,total_change_pct:i,source:s,coverage_ratio:c,day_change:o}}function Ye(e){return re(e.performance)}function qn(e){const t=e.aggregation&&typeof e.aggregation=="object"?e.aggregation:null,n=p=>typeof p=="number"&&Number.isFinite(p)?p:null,r=p=>{const b=n(p);return b===null?null:b},a=n(t==null?void 0:t.total_holdings)??n(e.current_holdings)??0,i=n(t==null?void 0:t.positive_holdings)??(a>0?a:0),s=n(t==null?void 0:t.purchase_value_eur)??n(e.purchase_value)??0,c=n(t==null?void 0:t.purchase_value_cents),o=Math.round(c!==null?c:s*100),l=n(t==null?void 0:t.security_currency_total)??n(t==null?void 0:t.purchase_total_security)??n(e.purchase_total_security)??0,u=n(t==null?void 0:t.account_currency_total)??n(t==null?void 0:t.purchase_total_account)??n(e.purchase_total_account)??0,d=r((t==null?void 0:t.average_purchase_price_native)??e.average_purchase_price_native),f=r((t==null?void 0:t.avg_price_security)??e.avg_price_security),_=r((t==null?void 0:t.avg_price_account)??e.avg_price_account),m=n(t==null?void 0:t.purchase_total_security)??n(e.purchase_total_security)??l,y=n(t==null?void 0:t.purchase_total_account)??n(e.purchase_total_account)??u;return{total_holdings:a,positive_holdings:i>0?i:0,purchase_value_cents:o,purchase_value_eur:s,security_currency_total:l,account_currency_total:u,average_purchase_price_native:d,avg_price_security:f,avg_price_account:_,purchase_total_security:m,purchase_total_account:y}}function Vn(e,t){const n=e.average_cost&&typeof e.average_cost=="object"?e.average_cost:null,r=u=>typeof u=="number"&&Number.isFinite(u)?u:null,a=u=>{const d=r(u);return d===null?null:d},i=u=>u==="totals"||u==="eur_total"||u==="aggregation"?u:"aggregation";if(n)return{native:a(n.native),security:a(n.security),account:a(n.account),eur:a(n.eur),source:i(n.source),coverage_ratio:a(n.coverage_ratio)};const s=a(e.average_purchase_price_native??t.average_purchase_price_native),c=a(e.avg_price_security??t.avg_price_security),o=a(e.avg_price_account??t.avg_price_account),l=a(e.purchase_value??t.purchase_value_eur);return s===null&&c===null&&o===null&&l===null?null:{native:s,security:c,account:o,eur:l,source:"aggregation",coverage_ratio:null}}function Un(e){const t=qn(e),n=Vn(e,t),r=Ye(e),a=typeof(r==null?void 0:r.gain_abs)=="number"?r.gain_abs:null,i=typeof(r==null?void 0:r.gain_pct)=="number"?r.gain_pct:null;return{...e,current_holdings:t.total_holdings,purchase_value:t.purchase_value_eur,purchase_total_security:t.purchase_total_security,purchase_total_account:t.purchase_total_account,average_purchase_price_native:(n==null?void 0:n.native)??null,avg_price_security:(n==null?void 0:n.security)??null,avg_price_account:(n==null?void 0:n.account)??null,average_cost:n,gain_abs:a,gain_pct:i,performance:r,aggregation:t}}function Wn(e){return e.map(Un)}const Bn=500,Gn=10,On="pp-reader:portfolio-positions-updated";function qe(){return window.__ppReaderPendingPositions||(window.__ppReaderPendingPositions=new Map),window.__ppReaderPendingPositions}function zn(){return window.__ppReaderPendingRetryMeta||(window.__ppReaderPendingRetryMeta=new Map),window.__ppReaderPendingRetryMeta}function Kn(e,t){return`<div class="error">${typeof e=="string"?e:String(e??"Unbekannter Fehler")} <button class="retry-pos" data-portfolio="${t}">Erneut laden</button></div>`}function Yn(e,t,n){const r=e.querySelector("table.sortable-positions");if(!r)return;const a=e.dataset.sortKey||r.dataset.defaultSort||"name",s=(e.dataset.sortDir||r.dataset.defaultDir||"asc")==="desc"?"desc":"asc";e.dataset.sortKey=a,e.dataset.sortDir=s;try{kt(r,a,s,!0)}catch(c){console.warn("restoreSortAndInit: sortTableRows Fehler:",c)}try{window.__ppReaderAttachPortfolioPositionsSorting&&window.__ppReaderAttachPortfolioPositionsSorting(t,n)}catch(c){console.warn("restoreSortAndInit: attachPortfolioPositionsSorting Fehler:",c)}try{window.__ppReaderAttachSecurityDetailListener&&window.__ppReaderAttachSecurityDetailListener(t,n)}catch(c){console.warn("restoreSortAndInit: attachSecurityDetailListener Fehler:",c)}}function qt(e,t,n,r){if(!e||!t)return{applied:!1,reason:"invalid"};const a=e.querySelector(`.portfolio-table .portfolio-details[data-portfolio="${t}"]`);if(!a)return{applied:!1,reason:"missing"};const i=a.querySelector(".positions-container");if(!i)return{applied:!1,reason:"missing"};if(a.classList.contains("hidden"))return{applied:!1,reason:"hidden"};if(r)return i.innerHTML=Kn(r,t),{applied:!0};const s=i.dataset.sortKey,c=i.dataset.sortDir;return i.innerHTML=er(n),s&&(i.dataset.sortKey=s),c&&(i.dataset.sortDir=c),Yn(i,e,t),{applied:!0}}function Ve(e,t){const n=qe(),r=n.get(t);if(!r)return!1;const a=qt(e,t,r.positions,r.error);return a.applied&&n.delete(t),a.applied}function Vt(e){const t=qe();let n=!1;for(const[r]of t)Ve(e,r)&&(n=!0);return n}function Ut(e,t){const n=zn(),r=n.get(t)??{attempts:0,timer:null};r.timer||(r.timer=setTimeout(()=>{r.timer=null,r.attempts+=1;const a=Ve(e,t);a||r.attempts>=Gn?(n.delete(t),a||qe().delete(t)):Ut(e,t)},Bn),n.set(t,r))}function jn(e,t){console.log("updateConfigsWS: Kontodaten-Update erhalten:",e);const n=Array.isArray(e)?e:[];if(!t)return;Xn(n,t);const r=t.querySelector(".portfolio-table table"),a=r?Array.from(r.querySelectorAll("tbody tr:not(.footer-row)")).map(i=>{const s=i.cells.item(2),c=(s==null?void 0:s.textContent)??"",o=parseFloat(c.replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""));return{current_value:Number.isFinite(o)?o:0}}):[];Wt(n,a,t)}function Xn(e,t){const n=t.querySelector(".account-table"),r=t.querySelector(".fx-account-table"),a=e.filter(s=>(s.currency_code||"EUR")==="EUR"),i=e.filter(s=>(s.currency_code||"EUR")!=="EUR");n?n.innerHTML=ce(a,[{key:"name",label:"Name"},{key:"balance",label:"Kontostand (EUR)",align:"right"}],["balance"]):console.warn("updateAccountTable: .account-table nicht gefunden."),r?r.innerHTML=ce(i.map(s=>{const c=s.orig_balance,l=typeof c=="number"&&Number.isFinite(c)?`${c.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})} ${s.currency_code}`:"";return{...s,fx_display:l}}),[{key:"name",label:"Name"},{key:"fx_display",label:"Betrag (FX)"},{key:"balance",label:"EUR",align:"right"}],["balance"]):i.length&&console.warn("updateAccountTable: .fx-account-table nicht gefunden, obwohl FX-Konten vorhanden sind.")}function Zn(e,t){if(!Array.isArray(e)){console.warn("handlePortfolioUpdate: Update ist kein Array:",e);return}try{console.debug("handlePortfolioUpdate: payload=",e)}catch{}if(!t)return;const n=t.querySelector(".portfolio-table table")||t.querySelector("table.expandable-portfolio-table");if(!n){!t.querySelector(".portfolio-table")&&(t.querySelector(".security-range-selector")||t.querySelector(".security-detail-placeholder"))?console.debug("handlePortfolioUpdate: Übersicht nicht aktiv – Update wird später angewendet."):console.warn("handlePortfolioUpdate: Keine Portfolio-Tabelle gefunden.");return}const r=n.tBodies.item(0)??n.querySelector("tbody");if(!r){console.warn("handlePortfolioUpdate: Kein <tbody> in Tabelle.");return}const a=o=>{if(window.Intl)try{return new Intl.NumberFormat(navigator.language||"de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(o)}catch{}return(O(o,{fallback:0})??0).toFixed(2).replace(".",",")},i=new Map(Array.from(r.querySelectorAll("tr.portfolio-row")).filter(o=>{var l;return!!((l=o.dataset)!=null&&l.portfolio)}).map(o=>[o.dataset.portfolio,o]));let s=0;const c=o=>{const l=Number.isFinite(o)?Number(o):0;try{return l.toLocaleString("de-DE")}catch{return l.toString()}};for(const o of e){const l=o==null?void 0:o.uuid;if(typeof l!="string"||!l)continue;const u=i.get(l);if(!u||u.cells.length<3)continue;const d=u.cells.item(1),f=u.cells.item(2),_=u.cells.item(3),m=u.cells.item(4);if(!d||!f)continue;const y=Number(o.position_count??o.count??0),p=Number(o.current_value??o.value??0),b=o,h=re(b.performance),g=typeof(h==null?void 0:h.gain_abs)=="number"?h.gain_abs:null,P=typeof(h==null?void 0:h.gain_pct)=="number"?h.gain_pct:null,A=o.purchase_sum??o.purchaseSum??null,N=typeof A=="number"&&Number.isFinite(A)?A:null,S=te(f.textContent);te(d.textContent)!==y&&(d.textContent=c(y));const w=Number.isFinite(p),D={fx_unavailable:!!b.fx_unavailable,current_value:w?p:null,gain_abs:g,gain_pct:P},T={hasValue:w},M=V("current_value",D.current_value,D,T);if((Math.abs(S-p)>=.005||f.innerHTML!==M)&&(f.innerHTML=M,u.classList.add("flash-update"),setTimeout(()=>u.classList.remove("flash-update"),800)),_){const x=V("gain_abs",D.gain_abs,D,T);_.innerHTML=x;const v=typeof P=="number"&&Number.isFinite(P)?P:null;_.dataset.gainPct=v!=null?`${a(v)} %`:"—",_.dataset.gainSign=v!=null?v>0?"positive":v<0?"negative":"neutral":"neutral"}m&&(m.innerHTML=V("gain_pct",D.gain_pct,D,T)),u.dataset.positionCount=String(y),u.dataset.currentValue=w?String(p):"",u.dataset.purchaseSum=N!=null?String(N):"",u.dataset.gainAbs=g!=null?String(g):"",u.dataset.gainPct=P!=null?String(P):"",s+=1}console.debug(s===0?"handlePortfolioUpdate: Keine passenden Zeilen gefunden / keine Änderungen.":`handlePortfolioUpdate: ${s} Zeile(n) gepatcht.`);try{tr(n)}catch(o){console.warn("handlePortfolioUpdate: Fehler bei Summen-Neuberechnung:",o)}try{const o=(...m)=>{for(const y of m){if(!y)continue;const p=t.querySelector(y);if(p)return p}return null},l=o(".account-table table",".accounts-eur-table table",".accounts-table table"),u=o(".fx-account-table table",".accounts-fx-table table"),d=(m,y)=>{if(!m)return[];const p=m.querySelectorAll("tbody tr.account-row");return(p.length?Array.from(p):Array.from(m.querySelectorAll("tbody tr:not(.footer-row)"))).map(h=>{const g=y?h.cells.item(2):h.cells.item(1);return{balance:te(g==null?void 0:g.textContent)}})},f=[...d(l,!1),...d(u,!0)],_=Array.from(n.querySelectorAll("tbody tr.portfolio-row")).map(m=>{var h,g;const y=te((h=m.cells.item(2))==null?void 0:h.textContent),p=te((g=m.cells.item(3))==null?void 0:g.textContent),b=y-p;return{current_value:y,purchase_sum:b}});Wt(f,_,t)}catch(o){console.warn("handlePortfolioUpdate: Fehler bei Total-Neuberechnung:",o)}}function Jn(e){if(!e||typeof e!="object")return null;const t=e.portfolio_uuid;if(typeof t=="string"&&t)return t;const n=e.portfolioUuid;return typeof n=="string"&&n?n:null}function gt(e,t){const n=Jn(e);if(!n)return console.warn("handlePortfolioPositionsUpdate: Ungültiges Update:",e),!1;const r=e==null?void 0:e.error,a=Array.isArray(e==null?void 0:e.positions)?e.positions.filter(o=>!!o):[],i=Wn(a);try{const o=window.__ppReaderPortfolioPositionsCache;o&&typeof o.set=="function"&&!r&&o.set(n,i)}catch(o){console.warn("handlePortfolioPositionsUpdate: Positions-Cache konnte nicht aktualisiert werden:",o)}const s=qt(t,n,i,r),c=qe();if(s.applied?c.delete(n):(c.set(n,{positions:i,error:r}),s.reason!=="hidden"&&Ut(t,n)),!r&&i.length>0){const o=Array.from(new Set(i.map(l=>l==null?void 0:l.security_uuid).filter(l=>typeof l=="string"&&l.length>0)));if(o.length&&typeof window<"u")try{window.dispatchEvent(new CustomEvent(On,{detail:{portfolioUuid:n,securityUuids:o}}))}catch(l){console.warn("handlePortfolioPositionsUpdate: Dispatch des Portfolio-Events fehlgeschlagen",l)}}return!0}function Qn(e,t){if(Array.isArray(e)){let n=!1;for(const r of e)gt(r,t)&&(n=!0);!n&&e.length&&console.warn("handlePortfolioPositionsUpdate: Kein gültiges Element im Array:",e);return}gt(e,t)}function er(e){try{if(window.__ppReaderRenderPositionsTable)return window.__ppReaderRenderPositionsTable(e)}catch{}if(!e||!e.length)return'<div class="no-positions">Keine Positionen vorhanden.</div>';const t=e.map(r=>{const a=Ye(r),i=typeof(a==null?void 0:a.gain_abs)=="number"?a.gain_abs:null,s=typeof(a==null?void 0:a.gain_pct)=="number"?a.gain_pct:null;return{name:r.name,current_holdings:r.current_holdings,purchase_value:r.purchase_value,current_value:r.current_value,gain_abs:i,gain_pct:s}}),n=ce(t,[{key:"name",label:"Wertpapier"},{key:"current_holdings",label:"Bestand",align:"right"},{key:"purchase_value",label:"Kaufwert",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"+/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}],["purchase_value","current_value","gain_abs"]);try{const r=document.createElement("template");r.innerHTML=n.trim();const a=r.content.querySelector("table");if(a){a.classList.add("sortable-positions");const i=a.querySelectorAll("thead th"),s=["name","current_holdings","purchase_value","current_value","gain_abs","gain_pct"];if(i.forEach((o,l)=>{const u=s[l];u&&(o.setAttribute("data-sort-key",u),o.classList.add("sortable-col"))}),a.querySelectorAll("tbody tr").forEach((o,l)=>{if(o.classList.contains("footer-row"))return;const u=e[l];u!=null&&u.security_uuid&&(o.dataset.security=u.security_uuid),o.classList.add("position-row")}),a.dataset.defaultSort="name",a.dataset.defaultDir="asc",window.__ppReaderApplyGainPctMetadata)try{window.__ppReaderApplyGainPctMetadata(a)}catch(o){console.warn("renderPositionsTableInline: applyGainPctMetadata failed",o)}else a.querySelectorAll("tbody tr").forEach((l,u)=>{var b;if(l.classList.contains("footer-row"))return;const d=(b=l.cells)==null?void 0:b[4];if(!d)return;const f=e[u],_=Ye(f),m=typeof(_==null?void 0:_.gain_pct)=="number"&&Number.isFinite(_.gain_pct)?_.gain_pct:null,y=m!=null?`${m.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})} %`:"—",p=m==null?"neutral":m>0?"positive":m<0?"negative":"neutral";d.dataset.gainPct=y,d.dataset.gainSign=p});return a.outerHTML}}catch(r){console.warn("renderPositionsTableInline: Sortier-Metadaten Injection fehlgeschlagen:",r)}return n}window.__ppReaderFlushPendingPositions||(window.__ppReaderFlushPendingPositions=(e,t)=>Ve(e,t));window.__ppReaderFlushAllPendingPositions||(window.__ppReaderFlushAllPendingPositions=e=>Vt(e));function tr(e){var b,h;if(!e)return;try{const g=window.__ppReaderUpdatePortfolioFooter;if(typeof g=="function"){g(e);return}}catch(g){console.warn("updatePortfolioFooter: global Helper schlug fehl:",g)}const t=Array.from(e.querySelectorAll("tbody tr.portfolio-row"));let n=0,r=0,a=0,i=0;t.forEach(g=>{var M,x,E,v,R,k,H;const P=Number((M=g.dataset)==null?void 0:M.positionCount),A=Number.isFinite(P)?P:parseInt((((x=g.cells.item(1))==null?void 0:x.textContent)||"").replace(/\./g,""),10)||0,N=Number((E=g.dataset)==null?void 0:E.currentValue),S=Number.isFinite(N)?N:te((v=g.cells.item(2))==null?void 0:v.textContent),L=Number((R=g.dataset)==null?void 0:R.gainAbs),w=Number.isFinite(L)?L:te((k=g.cells.item(3))==null?void 0:k.textContent),D=Number((H=g.dataset)==null?void 0:H.purchaseSum),T=Number.isFinite(D)?D:S-w;i+=A,n+=S,r+=w,a+=T}),a<=0&&(a=n-r);const s=a>0?r/a*100:0;let c=e.querySelector("tr.footer-row");c||(c=document.createElement("tr"),c.className="footer-row",(b=e.querySelector("tbody"))==null||b.appendChild(c));const o=Math.round(i).toLocaleString("de-DE"),l=t.some(g=>{var P;return((P=g.dataset)==null?void 0:P.hasValue)==="true"}),d={fx_unavailable:t.some(g=>{var P;return((P=g.dataset)==null?void 0:P.fxUnavailable)==="true"}),current_value:l?n:null,gain_abs:l?r:null,gain_pct:l?s:null},f={hasValue:l},_=V("current_value",d.current_value,d,f),m=V("gain_abs",d.gain_abs,d,f),y=V("gain_pct",d.gain_pct,d,f);c.innerHTML=`
    <td>Summe</td>
    <td class="align-right">${o}</td>
    <td class="align-right">${_}</td>
    <td class="align-right">${m}</td>
    <td class="align-right">${y}</td>
  `;const p=(h=c.cells)==null?void 0:h[3];p&&(p.dataset.gainPct=l&&Number.isFinite(s)?`${je(s)} %`:"—",p.dataset.gainSign=l&&Number.isFinite(s)?s>0?"positive":s<0?"negative":"neutral":"neutral"),c.dataset.positionCount=String(Math.round(i)),c.dataset.currentValue=String(n),c.dataset.purchaseSum=String(a),c.dataset.gainAbs=String(r),c.dataset.gainPct=String(s),c.dataset.hasValue=l?"true":"false"}function je(e){return(O(e,{fallback:0})??0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}function Wt(e,t,n){const r=n||document,a=(Array.isArray(e)?e:[]).reduce((l,u)=>{const d=u!=null&&typeof u=="object"?u.balance??u.current_value??u.value??0:u,f=Number(d);return l+(Number.isFinite(f)?f:0)},0),i=(Array.isArray(t)?t:[]).reduce((l,u)=>{const d=u!=null&&typeof u=="object"?u.current_value??u.value??0:u,f=Number(d);return l+(Number.isFinite(f)?f:0)},0),s=a+i,c=r==null?void 0:r.querySelector("#headerMeta");if(!c){console.warn("updateTotalWealth: #headerMeta nicht gefunden.");return}const o=c.querySelector("strong")||c.querySelector(".total-wealth-value");o?o.textContent=`${je(s)} €`:c.textContent=`💰 Gesamtvermögen: ${je(s)} €`,c.dataset.totalWealthEur=String(s)}function nr(e,t){const n=typeof e=="string"?e:e&&e.last_file_update||"";if(!t){console.warn("handleLastFileUpdate: root fehlt");return}let r=t.querySelector(".footer-card .last-file-update")||t.querySelector(".last-file-update");if(!r){const a=t.querySelector(".footer-card .meta")||t.querySelector("#headerMeta")||t.querySelector(".header-card .meta")||t.querySelector(".header-card");if(!a){console.warn("handleLastFileUpdate: Kein Einfügepunkt gefunden.");return}r=document.createElement("div"),r.className="last-file-update",a.appendChild(r)}r.closest(".footer-card")?r.innerHTML=n?`📂 Letzte Aktualisierung der Datei: <strong>${n}</strong>`:"📂 Letzte Aktualisierung der Datei: <strong>Unbekannt</strong>":r.textContent=n?`📂 Letzte Aktualisierung: ${n}`:"📂 Letzte Aktualisierung: Unbekannt"}function rr(e){if(!e)return;const t=e.querySelector("table.sortable-positions");if(!t)return;const n=e.dataset.sortKey||t.dataset.defaultSort||"name",a=(e.dataset.sortDir||t.dataset.defaultDir||"asc")==="desc"?"desc":"asc";e.dataset.sortKey=n,e.dataset.sortDir=a,kt(t,n,a,!0)}window.__ppReaderReapplyPositionsSort=rr;function te(e){return e==null?0:parseFloat(String(e).replace(/\u00A0/g," ").replace(/[€%]/g,"").replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""))||0}const ar=["name","current_holdings","purchase_value","current_value","gain_abs","gain_pct"];function Ue(e){return ar.includes(e)}function We(e){return e==="asc"||e==="desc"}let Ee=null,De=null;const j=new Map,_t={min:2,max:6};function C(e){return it(e)}function Re(e){return typeof e=="number"&&Number.isFinite(e)}function Q(...e){for(const t of e)if(typeof t=="number"&&Number.isFinite(t))return t;return null}function ir(e){if(typeof e!="string")return null;const t=e.trim();if(!t)return null;const n=t.toUpperCase();return/^[A-Z]{3}$/.test(n)?n:n==="€"?"EUR":null}function bt(e,t,n=null){const r=e;for(const a of t){const i=ir(r[a]);if(i)return i}return n}function or(e){const t=e.aggregation;if(!t||typeof t!="object")return null;const n=t,r=["total_holdings","purchase_value_eur","purchase_total_security","purchase_total_account"];for(const a of r)if(typeof n[a]!="number")return null;return n}function sr(e,t){const n=e.average_cost;if(n&&typeof n=="object"){const _=n,m=_.source,y=m==="totals"||m==="eur_total"||m==="aggregation"?m:void 0;return{native:C(_.native),security:C(_.security),account:C(_.account),eur:C(_.eur),source:y??"aggregation",coverage_ratio:C(_.coverage_ratio)}}const r=[C(e.current_holdings)];t&&r.unshift(C(t.positive_holdings),C(t.total_holdings));const a=Q(...r),i=Q(t?C(t.purchase_total_security):null,C(e.purchase_total_security)),s=Q(t?C(t.purchase_total_account):null,C(e.purchase_total_account)),c=Q(t?C(t.purchase_value_eur):null,C(e.purchase_value)),o=(_,m)=>_!=null&&typeof _=="number"&&Re(m)&&m>0?_/m:null,l=Q(t?C(t.average_purchase_price_native):null,C(e.average_purchase_price_native),C(e.avg_price_security),o(i,a)),u=Q(t?C(t.avg_price_security):null,C(e.avg_price_security),l,o(i,a)),d=Q(t?C(t.avg_price_account):null,C(e.avg_price_account),o(s,a),o(c,a)),f=Q(o(c,a),d);return l==null&&u==null&&d==null&&f==null?null:{native:l,security:u,account:d,eur:f,source:"aggregation",coverage_ratio:t?C(t==null?void 0:t.coverage_ratio):null}}function Bt(e){return re(e.performance)}function ot(e){const t=e,n=Bt(t),r=typeof(n==null?void 0:n.gain_abs)=="number"?n.gain_abs:null,a=typeof(n==null?void 0:n.gain_pct)=="number"?n.gain_pct:null;return{...e,current_holdings:C(t.current_holdings),purchase_value:xe(t.purchase_value),current_value:xe(t.current_value),gain_abs:r,gain_pct:a,performance:n}}function Be(e,t){return Re(e)?`${e.toLocaleString("de-DE",{minimumFractionDigits:_t.min,maximumFractionDigits:_t.max})}${t?` ${t}`:""}`:null}function cr(e){const t=e,n=or(t),r=sr(t,n),a=bt(e,["security_currency_code","security_currency","native_currency_code","native_currency"]),i=bt(e,["account_currency_code","account_currency","purchase_currency_code","currency_code"])??(a==="EUR"?"EUR":null)??"EUR",s=C(r==null?void 0:r.native),c=C(r==null?void 0:r.security),o=C(r==null?void 0:r.account),l=C(r==null?void 0:r.eur),u=c??s,d=o??l;let f=u,_=a,m=Be(u,a);m||(f=d,_=i,m=Be(d,i));const y=Be(d,i),p=y!==null&&(m==null||!_||!i||i!==_||Re(d)&&Re(f)&&Math.abs(d-f)>1e-6),b=[],h=[];m?(b.push(`<span class="purchase-price purchase-price--primary">${m}</span>`),h.push(m.replace(/\u00A0/g," "))):(b.push('<span class="missing-value" role="note" aria-label="Kein Kaufpreis verfügbar" title="Kein Kaufpreis verfügbar">—</span>'),h.push("Kein Kaufpreis verfügbar")),p&&y&&y!==m&&(b.push(`<span class="purchase-price purchase-price--secondary">${y}</span>`),h.push(y.replace(/\u00A0/g," ")));const g=b.join("<br>"),P=C((n==null?void 0:n.purchase_value_eur)??t.purchase_value)??0,A=h.join(", ");return{markup:g,sortValue:P,ariaLabel:A}}function Gt(e){if(!e)return[];const t=[];for(const n of j.values())if(!(!Array.isArray(n)||n.length===0))for(const r of n){const a=typeof(r==null?void 0:r.security_uuid)=="string"?r.security_uuid:null;r&&a===e&&t.push(r)}return t.length?t.map(n=>({...n})):[]}j.getSecurityPositions=Gt;window.__ppReaderPortfolioPositionsCache=j;window.__ppReaderGetSecurityPositionsFromCache||(window.__ppReaderGetSecurityPositionsFromCache=Gt);const Le=new Set;function Ot(e){if(!e)return;Array.from(e.querySelectorAll("tbody tr")).forEach(n=>{var c,o;const r=((c=n.cells)==null?void 0:c[4])??null,a=((o=n.cells)==null?void 0:o[5])??null;if(!r||!a||r.dataset.gainPct&&r.dataset.gainSign)return;const i=(a.textContent||"").trim()||"—";let s="neutral";a.querySelector(".positive")?s="positive":a.querySelector(".negative")&&(s="negative"),r.dataset.gainPct=i,r.dataset.gainSign=s})}window.__ppReaderApplyGainPctMetadata||(window.__ppReaderApplyGainPctMetadata=e=>Ot(e));function be(e){if(!e||e.length===0)return'<div class="no-positions">Keine Positionen vorhanden.</div>';const t=e.map(ot),n=[{key:"name",label:"Wertpapier"},{key:"current_holdings",label:"Bestand",align:"right"},{key:"purchase_value",label:"Ø Kaufpreis",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"+/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}],r=t.map(i=>{const s=re(i.performance),c=typeof(s==null?void 0:s.gain_abs)=="number"?s.gain_abs:null,o=typeof(s==null?void 0:s.gain_pct)=="number"?s.gain_pct:null;return{name:typeof i.name=="string"?i.name:i.name!=null?String(i.name):"",current_holdings:typeof i.current_holdings=="number"||typeof i.current_holdings=="string"?i.current_holdings:null,purchase_value:typeof i.purchase_value=="number"||typeof i.purchase_value=="string"?i.purchase_value:null,current_value:typeof i.current_value=="number"||typeof i.current_value=="string"?i.current_value:null,gain_abs:c,gain_pct:o}}),a=ce(r,n,["purchase_value","current_value","gain_abs"]);try{const i=document.createElement("template");i.innerHTML=a.trim();const s=i.content.querySelector("table");if(s){s.classList.add("sortable-positions");const c=s.querySelectorAll("thead th");return n.forEach((l,u)=>{const d=c[u];d&&(d.setAttribute("data-sort-key",l.key),d.classList.add("sortable-col"))}),s.querySelectorAll("tbody tr").forEach((l,u)=>{var p,b,h;if(l.classList.contains("footer-row"))return;const d=t[u];if(!d)return;const f=typeof d.security_uuid=="string"?d.security_uuid:null;f&&(l.dataset.security=f),l.classList.add("position-row");const _=((p=l.cells)==null?void 0:p[2])??null;if(_){const{markup:g,sortValue:P,ariaLabel:A}=cr(d);_.innerHTML=g,_.dataset.sortValue=String(P),A?_.setAttribute("aria-label",A):_.removeAttribute("aria-label")}const m=((b=l.cells)==null?void 0:b[4])??null;if(m){const g=re(d.performance),P=typeof(g==null?void 0:g.gain_pct)=="number"&&Number.isFinite(g.gain_pct)?g.gain_pct:null,A=P!=null?`${P.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})} %`:"—",N=P==null?"neutral":P>0?"positive":P<0?"negative":"neutral";m.dataset.gainPct=A,m.dataset.gainSign=N}const y=((h=l.cells)==null?void 0:h[5])??null;y&&y.classList.add("gain-pct-cell")}),s.dataset.defaultSort="name",s.dataset.defaultDir="asc",Ot(s),s.outerHTML}}catch(i){console.warn("renderPositionsTable: Konnte Sortier-Metadaten nicht injizieren:",i)}return a}window.__ppReaderRenderPositionsTable=be;function lr(e,t){if(!t)return;const n=e.querySelector(`.portfolio-details[data-portfolio="${t}"]`);if(!n)return;const r=n.querySelector(".positions-container");!r||r.__ppReaderSecurityClickBound||(r.__ppReaderSecurityClickBound=!0,r.addEventListener("click",a=>{const i=a.target;if(!(i instanceof Element))return;const s=i.closest("button, a");if(s&&r.contains(s))return;const c=i.closest("tr[data-security]");if(!c||!r.contains(c))return;const o=c.getAttribute("data-security");if(o)try{An(o)||console.warn("attachSecurityDetailDelegation: Detail-Tab konnte nicht geöffnet werden für",o)}catch(l){console.error("attachSecurityDetailDelegation: Fehler beim Öffnen des Detail-Tabs",l)}}))}function me(e,t){lr(e,t)}window.__ppReaderAttachSecurityDetailListener||(window.__ppReaderAttachSecurityDetailListener=me);function zt(e){console.debug("buildExpandablePortfolioTable: render",e.length,"portfolios");const t=h=>h==null?"":String(h).replace(/&/g,"&amp;").replace(/"/g,"&quot;");let n='<table class="expandable-portfolio-table"><thead><tr>';[{key:"name",label:"Name"},{key:"position_count",label:"Anzahl Positionen",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"Gesamt +/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}].forEach(h=>{const g=h.align==="right"?' class="align-right"':"";n+=`<th${g}>${h.label}</th>`}),n+="</tr></thead><tbody>",e.forEach(h=>{if(!h||!h.uuid)return;const g=Number.isFinite(h.position_count)?h.position_count:0,P=Number.isFinite(h.purchase_sum)?h.purchase_sum:0,A=h.hasValue&&typeof h.current_value=="number"&&Number.isFinite(h.current_value),N=A?h.current_value:null,S=h.performance,L=typeof(S==null?void 0:S.gain_abs)=="number"?S.gain_abs:null,w=typeof(S==null?void 0:S.gain_pct)=="number"?S.gain_pct:null,D=h.fx_unavailable&&A,T=Le.has(h.uuid),M=T?"portfolio-toggle expanded":"portfolio-toggle",x=`portfolio-details-${h.uuid}`,E={fx_unavailable:h.fx_unavailable,current_value:N,gain_abs:L,gain_pct:w},v={hasValue:A},R=V("current_value",E.current_value,E,v),k=V("gain_abs",E.gain_abs,E,v),H=V("gain_pct",E.gain_pct,E,v),z=A&&typeof w=="number"&&Number.isFinite(w)?`${Z(w)} %`:"",B=A&&typeof w=="number"&&Number.isFinite(w)?w>0?"positive":w<0?"negative":"neutral":"",G=A&&typeof N=="number"&&Number.isFinite(N)?N:"",K=A&&typeof L=="number"&&Number.isFinite(L)?L:"",U=A&&typeof w=="number"&&Number.isFinite(w)?w:"";let q="";z&&(q=` data-gain-pct="${t(z)}" data-gain-sign="${t(B)}"`),D&&(q+=' data-partial="true"'),n+=`<tr class="portfolio-row"
                data-portfolio="${h.uuid}"
                data-position-count="${g}"
                data-current-value="${t(G)}"
                data-purchase-sum="${t(P)}"
                data-gain-abs="${t(K)}"
                data-gain-pct="${t(U)}"
                data-has-value="${A?"true":"false"}"
                data-fx-unavailable="${h.fx_unavailable?"true":"false"}">`,n+=`<td>
        <button type="button"
                class="${M}"
                data-portfolio="${h.uuid}"
                aria-expanded="${T?"true":"false"}"
                aria-controls="${x}">
          <span class="caret">${T?"▼":"▶"}</span>
          <span class="portfolio-name">${h.name}</span>
        </button>
      </td>`,n+=`<td class="align-right">${g}</td>`,n+=`<td class="align-right">${R}</td>`,n+=`<td class="align-right"${q}>${k}</td>`,n+=`<td class="align-right gain-pct-cell">${H}</td>`,n+="</tr>",n+=`<tr class="portfolio-details${T?"":" hidden"}"
                data-portfolio="${h.uuid}"
                id="${x}"
                role="region"
                aria-label="Positionen für ${h.name}">
      <td colspan="5">
        <div class="positions-container">${T?j.has(h.uuid)?be(j.get(h.uuid)??[]):'<div class="loading">Lade Positionen...</div>':""}</div>
      </td>
    </tr>`});const a=e.filter(h=>typeof(h==null?void 0:h.current_value)=="number"&&Number.isFinite(h.current_value)),i=e.reduce((h,g)=>h+(Number.isFinite(g==null?void 0:g.position_count)?g.position_count:0),0),s=a.reduce((h,g)=>typeof g.current_value=="number"&&Number.isFinite(g.current_value)?h+g.current_value:h,0),c=a.reduce((h,g)=>typeof g.purchase_sum=="number"&&Number.isFinite(g.purchase_sum)?h+g.purchase_sum:h,0),o=a.reduce((h,g)=>{var N;if(typeof((N=g.performance)==null?void 0:N.gain_abs)=="number"&&Number.isFinite(g.performance.gain_abs))return h+g.performance.gain_abs;const P=typeof g.current_value=="number"&&Number.isFinite(g.current_value)?g.current_value:0,A=typeof g.purchase_sum=="number"&&Number.isFinite(g.purchase_sum)?g.purchase_sum:0;return h+(P-A)},0),l=a.length>0,u=a.length!==e.length,d=l&&c>0?o/c*100:null,f={fx_unavailable:u,current_value:l?s:null,gain_abs:l?o:null,gain_pct:l?d:null},_={hasValue:l},m=V("current_value",f.current_value,f,_),y=V("gain_abs",f.gain_abs,f,_),p=V("gain_pct",f.gain_pct,f,_);let b="";if(l&&typeof d=="number"&&Number.isFinite(d)){const h=`${Z(d)} %`,g=d>0?"positive":d<0?"negative":"neutral";b=` data-gain-pct="${t(h)}" data-gain-sign="${t(g)}"`}return u&&(b+=' data-partial="true"'),n+=`<tr class="footer-row"
    data-position-count="${i}"
    data-current-value="${t(l?s:"")}"
    data-purchase-sum="${t(l?c:"")}"
    data-gain-abs="${t(l?o:"")}"
    data-gain-pct="${t(l&&typeof d=="number"&&Number.isFinite(d)?d:"")}"
    data-has-value="${l?"true":"false"}"
    data-fx-unavailable="${u?"true":"false"}">
    <td>Summe</td>
    <td class="align-right">${Math.round(i).toLocaleString("de-DE")}</td>
    <td class="align-right">${m}</td>
    <td class="align-right"${b}>${y}</td>
    <td class="align-right gain-pct-cell">${p}</td>
  </tr>`,n+="</tbody></table>",n}function ur(e){if(e instanceof HTMLTableElement)return e;if(e&&"querySelector"in e){const t=e.querySelector("table.expandable-portfolio-table");if(t)return t;const n=e.querySelector(".portfolio-table table");if(n)return n;const r=e.querySelector("table");if(r)return r}return document.querySelector(".portfolio-table table.expandable-portfolio-table")||document.querySelector(".portfolio-table table")}function Ae(e){if(e===void 0)return null;const t=Number(e);return Number.isFinite(t)?t:null}function Ge(e){if(!e)return 0;const t=e.textContent||"";if(!t)return 0;const n=t.replace(/[^0-9,.-]/g,"").replace(/\./g,"").replace(",","."),r=Number.parseFloat(n);return Number.isFinite(r)?r:0}function Kt(e){var g,P;const t=ur(e);if(!t)return;const n=(g=t.tBodies)==null?void 0:g[0];if(!n)return;const r=Array.from(n.querySelectorAll("tr.portfolio-row"));if(!r.length)return;let a=0,i=0,s=0,c=0,o=0;for(const A of r){const N=A.dataset.hasValue,S=!(N==="false"||N==="0"||N===""||N==null),L=Ae(A.dataset.positionCount)??Ge(A.cells.item(1));if(a+=L,!S){o+=1;continue}const w=Ae(A.dataset.currentValue)??Ge(A.cells.item(2)),D=Ae(A.dataset.gainAbs)??Ge(A.cells.item(3)),T=Ae(A.dataset.purchaseSum),M=T??w-D;i+=w,c+=D,s+=M}const l=o===0;!l&&s>0&&(s=i-c),l&&s<=0&&(s=i-c);const u=l&&s>0?c/s*100:null;let d=Array.from(n.children).find(A=>A instanceof HTMLTableRowElement&&A.classList.contains("footer-row"));d||(d=document.createElement("tr"),d.classList.add("footer-row"),n.appendChild(d));const f=Math.round(a).toLocaleString("de-DE"),_={fx_unavailable:!l,current_value:l?i:null,gain_abs:l?c:null,gain_pct:l?u:null},m={hasValue:l},y=V("current_value",_.current_value,_,m),p=V("gain_abs",_.gain_abs,_,m),b=V("gain_pct",_.gain_pct,_,m);d.innerHTML=`
    <td>Summe</td>
    <td class="align-right">${f}</td>
    <td class="align-right">${y}</td>
    <td class="align-right">${p}</td>
    <td class="align-right">${b}</td>
  `;const h=(P=d.cells)==null?void 0:P[3];h&&(h.dataset.gainPct=l&&typeof u=="number"?`${Z(u)} %`:"—",h.dataset.gainSign=l&&typeof u=="number"?u>0?"positive":u<0?"negative":"neutral":"neutral"),d.dataset.positionCount=String(Math.round(a)),d.dataset.currentValue=l?String(i):"",d.dataset.purchaseSum=l?String(s):"",d.dataset.gainAbs=l?String(c):"",d.dataset.gainPct=l&&typeof u=="number"?String(u):"",d.dataset.hasValue=l?"true":"false"}window.__ppReaderUpdatePortfolioFooter=Kt;function ye(e,t){if(!t)return;const n=e.querySelector(`.portfolio-details[data-portfolio="${t}"]`);if(!n)return;const r=n.querySelector(".positions-container");if(!r)return;const a=r.querySelector("table.sortable-positions");if(!a||a.__ppReaderSortingBound)return;a.__ppReaderSortingBound=!0;const i=(f,_)=>{const m=a.querySelector("tbody");if(!m)return;const y=Array.from(m.querySelectorAll("tr")).filter(g=>!g.classList.contains("footer-row")),p=m.querySelector("tr.footer-row"),b=g=>{if(g==null)return 0;const P=g.replace(/\u00A0/g," ").replace(/[%€]/g,"").replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""),A=Number.parseFloat(P);return Number.isFinite(A)?A:0};y.sort((g,P)=>{var x,E;const N={name:0,current_holdings:1,purchase_value:2,current_value:3,gain_abs:4,gain_pct:5}[f];if(N==null)return 0;const S=g.cells[N],L=P.cells[N],w=((x=S==null?void 0:S.textContent)==null?void 0:x.trim())??"",D=((E=L==null?void 0:L.textContent)==null?void 0:E.trim())??"",T=(v,R)=>{const k=v==null?void 0:v.dataset.sortValue;if(k!=null&&k!==""){const H=Number(k);if(Number.isFinite(H))return H}return b(R)};let M;if(f==="name")M=w.localeCompare(D,"de",{sensitivity:"base"});else{const v=T(S,w),R=T(L,D);M=v-R}return _==="asc"?M:-M}),a.querySelectorAll("thead th.sort-active").forEach(g=>{g.classList.remove("sort-active","dir-asc","dir-desc")});const h=a.querySelector(`thead th[data-sort-key="${f}"]`);h&&h.classList.add("sort-active",_==="asc"?"dir-asc":"dir-desc"),y.forEach(g=>m.appendChild(g)),p&&m.appendChild(p)},s=r.dataset.sortKey,c=r.dataset.sortDir,o=a.dataset.defaultSort,l=a.dataset.defaultDir,u=Ue(s)?s:Ue(o)?o:"name",d=We(c)?c:We(l)?l:"asc";i(u,d),a.addEventListener("click",f=>{const _=f.target;if(!(_ instanceof Element))return;const m=_.closest("th[data-sort-key]");if(!m||!a.contains(m))return;const y=m.getAttribute("data-sort-key");if(!Ue(y))return;let p="asc";r.dataset.sortKey===y&&(p=(We(r.dataset.sortDir)?r.dataset.sortDir:"asc")==="asc"?"desc":"asc"),r.dataset.sortKey=y,r.dataset.sortDir=p,i(y,p)})}window.__ppReaderAttachPortfolioPositionsSorting||(window.__ppReaderAttachPortfolioPositionsSorting=ye);async function dr(e,t,n){if(!e||!Ee||!De)return;const r=t||n.querySelector(`.portfolio-details[data-portfolio="${e}"] .positions-container`);if(!r)return;const a=r.closest(".portfolio-details");if(!(a&&a.classList.contains("hidden"))){r.innerHTML='<div class="loading">Neu laden...</div>';try{const i=await Mt(Ee,De,e);if(i.error){const o=typeof i.error=="string"?i.error:String(i.error);r.innerHTML=`<div class="error">${o} <button class="retry-pos" data-portfolio="${e}">Erneut laden</button></div>`;return}const c=(i.positions??[]).map(ot);j.set(e,c),r.innerHTML=be(c);try{ye(n,e)}catch(o){console.warn("attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:",o)}try{me(n,e)}catch(o){console.warn("reloadPortfolioPositions: Security-Listener konnte nicht gebunden werden:",o)}}catch(i){const s=i instanceof Error?i.message:String(i);r.innerHTML=`<div class="error">Fehler: ${s} <button class="retry-pos" data-portfolio="${e}">Retry</button></div>`}}}async function fr(e,t,n=3e3,r=50){const a=performance.now();return new Promise(i=>{const s=()=>{const c=e.querySelector(t);if(c)return i(c);if(performance.now()-a>n)return i(null);setTimeout(s,r)};s()})}function st(e){if(!e)return;const t=(e.__ppReaderAttachToken??0)+1;e.__ppReaderAttachToken=t,e.__ppReaderAttachInProgress=!0,(async()=>{try{const n=await fr(e,".portfolio-table");if(t!==e.__ppReaderAttachToken)return;if(!n){console.warn("attachPortfolioToggleHandler: .portfolio-table nicht gefunden (Timeout)");return}if(n.querySelectorAll(".portfolio-toggle").length===0&&console.debug("attachPortfolioToggleHandler: Noch keine Buttons – evtl. Recovery später"),n.__ppReaderPortfolioToggleBound)return;n.__ppReaderPortfolioToggleBound=!0,console.debug("attachPortfolioToggleHandler: Listener registriert"),n.addEventListener("click",async a=>{try{const i=a.target;if(!(i instanceof Element))return;const s=i.closest(".retry-pos");if(s&&n.contains(s)){const f=s.getAttribute("data-portfolio");if(f){const _=e.querySelector(`.portfolio-details[data-portfolio="${f}"]`),m=_==null?void 0:_.querySelector(".positions-container");await dr(f,m??null,e)}return}const c=i.closest(".portfolio-toggle");if(!c||!n.contains(c))return;const o=c.getAttribute("data-portfolio");if(!o)return;const l=e.querySelector(`.portfolio-details[data-portfolio="${o}"]`);if(!l)return;const u=c.querySelector(".caret");if(l.classList.contains("hidden")){l.classList.remove("hidden"),c.classList.add("expanded"),c.setAttribute("aria-expanded","true"),u&&(u.textContent="▼"),Le.add(o);let f=!1;try{f=Ve(e,o)}catch(_){console.warn("attachPortfolioToggleHandler: Pending-Flush fehlgeschlagen:",_)}if(!f&&window.__ppReaderFlushPendingPositions)try{f=window.__ppReaderFlushPendingPositions(e,o)}catch(_){console.warn("attachPortfolioToggleHandler: Global Pending-Flush fehlgeschlagen:",_)}if(j.has(o)){const _=l.querySelector(".positions-container");if(_){_.innerHTML=be(j.get(o)??[]),ye(e,o);try{me(e,o)}catch(m){console.warn("attachPortfolioToggleHandler: Security-Listener (Cache) Fehler:",m)}}}else{const _=l.querySelector(".positions-container");_&&(_.innerHTML='<div class="loading">Lade Positionen...</div>');try{const m=await Mt(Ee,De,o);if(m.error){const b=typeof m.error=="string"?m.error:String(m.error);_&&(_.innerHTML=`<div class="error">${b} <button class="retry-pos" data-portfolio="${o}">Erneut laden</button></div>`);return}const p=(m.positions??[]).map(ot);if(j.set(o,p),_){_.innerHTML=be(p);try{ye(e,o)}catch(b){console.warn("attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:",b)}try{me(e,o)}catch(b){console.warn("attachPortfolioToggleHandler: Security-Listener konnte nicht gebunden werden:",b)}}}catch(m){const y=m instanceof Error?m.message:String(m),p=l.querySelector(".positions-container");p&&(p.innerHTML=`<div class="error">Fehler beim Laden: ${y} <button class="retry-pos" data-portfolio="${o}">Retry</button></div>`),console.error("Fehler beim Lazy Load für",o,m)}}}else l.classList.add("hidden"),c.classList.remove("expanded"),c.setAttribute("aria-expanded","false"),u&&(u.textContent="▶"),Le.delete(o)}catch(i){console.error("attachPortfolioToggleHandler: Ungefangener Fehler im Click-Handler",i)}})}finally{t===e.__ppReaderAttachToken&&(e.__ppReaderAttachInProgress=!1)}})()}function pr(e){const t=e.querySelector(".expandable-portfolio-table");t&&(t.__ppReaderPortfolioFallbackBound||(t.__ppReaderPortfolioFallbackBound=!0,t.addEventListener("click",n=>{const r=n.target;if(!(r instanceof Element)||!r.closest(".portfolio-toggle"))return;const i=e.querySelector(".portfolio-table");i!=null&&i.__ppReaderPortfolioToggleBound||(console.debug("Fallback-Listener aktiv – re-attach Hauptlistener"),st(e))})))}async function Yt(e,t,n){var M,x,E;Ee=t??null,De=n??null,console.debug("renderDashboard: start – panelConfig:",n==null?void 0:n.config,"derived entry_id?",(E=(x=(M=n==null?void 0:n.config)==null?void 0:M._panel_custom)==null?void 0:x.config)==null?void 0:E.entry_id);const r=await Ln(t,n),i=((r==null?void 0:r.accounts)??[]).map(v=>({name:v.name??"—",balance:typeof v.balance=="number"&&Number.isFinite(v.balance)?v.balance:null,currency_code:v.currency_code??null,orig_balance:typeof v.orig_balance=="number"&&Number.isFinite(v.orig_balance)?v.orig_balance:null,fx_unavailable:!!v.fx_unavailable})),c=((await $n(t,n)).portfolios??[]).map(v=>{const R=v,k=typeof v.uuid=="string"&&v.uuid?v.uuid:null;if(!k)return null;const H=typeof v.missing_value_positions=="number"?v.missing_value_positions:0,z=xe(R.current_value),B=xe(R.purchase_sum)??0,G=Bt(R),K=z!=null,U=typeof(G==null?void 0:G.gain_abs)=="number"?G.gain_abs:null,q=typeof(G==null?void 0:G.gain_pct)=="number"?G.gain_pct:null,Y=H>0,pt=K,Nn=Y||!pt;return{uuid:k,name:v.name??"Unbenanntes Depot",position_count:typeof v.position_count=="number"?v.position_count:0,current_value:K?z:null,purchase_sum:B,gain_abs:U,gain_pct:q,hasValue:pt,missing_value_positions:H,fx_unavailable:Nn,performance:G}}).filter(v=>v!==null);let o="";try{o=await Tn(t,n)}catch{o=""}const l=i.reduce((v,R)=>v+(typeof R.balance=="number"&&Number.isFinite(R.balance)?R.balance:0),0),u=c.some(v=>v.fx_unavailable),d=i.some(v=>v.fx_unavailable&&(v.balance==null||!Number.isFinite(v.balance))),f=c.reduce((v,R)=>R.hasValue&&typeof R.current_value=="number"&&Number.isFinite(R.current_value)?v+R.current_value:v,0),_=l+f,m="Teilw. fehlende FX-Kurse – Gesamtvermögen abweichend",p=c.some(v=>v.hasValue&&typeof v.current_value=="number"&&Number.isFinite(v.current_value))||i.some(v=>typeof v.balance=="number"&&Number.isFinite(v.balance))?`${Z(_)}&nbsp;€`:`<span class="missing-value" role="note" aria-label="${m}" title="${m}">—</span>`,b=u||d?`<span class="total-wealth-note">${m}</span>`:"",h=`
    <div class="header-meta-row">
      💰 Gesamtvermögen: <strong class="total-wealth-value">${p}</strong>${b}
    </div>
  `,g=Ke("Übersicht",h),P=zt(c),A=i.filter(v=>(v.currency_code??"EUR")==="EUR"),N=i.filter(v=>(v.currency_code??"EUR")!=="EUR"),L=N.some(v=>v.fx_unavailable)?`
        <p class="table-note" role="note">
          <span class="table-note__icon" aria-hidden="true">⚠️</span>
          <span>Wechselkurse konnten nicht geladen werden. EUR-Werte werden derzeit nicht angezeigt.</span>
        </p>
      `:"",w=`
    <div class="card">
      <h2>Liquidität</h2>
      <div class="scroll-container account-table">
        ${ce(A.map(v=>({name:v.name,balance:v.balance??null})),[{key:"name",label:"Name"},{key:"balance",label:"Kontostand (EUR)",align:"right"}],["balance"])}
      </div>
    </div>
    ${N.length?`
      <div class="card">
        <h2>Fremdwährungen</h2>
        <div class="scroll-container fx-account-table">
          ${ce(N.map(v=>{const R=v.orig_balance,H=typeof R=="number"&&Number.isFinite(R)?`${R.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}&nbsp;${v.currency_code??""}`:"";return{name:v.name,fx_display:H,balance:v.balance??null}}),[{key:"name",label:"Name"},{key:"fx_display",label:"Betrag (FX)"},{key:"balance",label:"EUR",align:"right"}],["balance"])}
        </div>
        ${L}
      </div>`:""}
  `,D=`
    <div class="card footer-card">
      <div class="meta">
        <div class="last-file-update">
          📂 Letzte Aktualisierung der Datei: <strong>${o||"Unbekannt"}</strong>
        </div>
      </div>
    </div>
  `,T=`
    ${g.outerHTML}
    <div class="card">
      <h2>Investment</h2>
      <div class="scroll-container portfolio-table">
        ${P}
      </div>
    </div>
    ${w}
    ${D}
  `;return hr(e,c),T}function hr(e,t){if(!e)return;const n=()=>{try{const a=e,i=a.querySelector(".portfolio-table");i&&i.querySelectorAll(".portfolio-toggle").length===0&&(console.debug("Recovery: Tabelle ohne Buttons – erneuter Aufbau"),i.innerHTML=zt(t)),st(e),pr(e),Le.forEach(s=>{try{j.has(s)&&(ye(e,s),me(e,s))}catch(c){console.warn("Init-Sortierung für expandiertes Depot fehlgeschlagen:",s,c)}});try{Kt(a)}catch(s){console.warn("renderDashboard: Footer-Summe konnte nicht aktualisiert werden:",s)}try{Vt(e)}catch(s){console.warn("renderDashboard: Pending-Positions konnten nicht angewendet werden:",s)}console.debug("renderDashboard: portfolio-toggle Buttons:",a.querySelectorAll(".portfolio-toggle").length)}catch(a){console.error("renderDashboard: Fehler bei Recovery/Listener",a)}},r=typeof requestAnimationFrame=="function"?a=>requestAnimationFrame(a):a=>setTimeout(a,0);r(()=>r(n))}const gr="http://www.w3.org/2000/svg",he=640,ge=260,fe={top:12,right:16,bottom:24,left:16},pe="var(--pp-reader-chart-line, #3f51b5)",Xe="var(--pp-reader-chart-area, rgba(63, 81, 181, 0.12))",mt="0.75rem",jt="var(--pp-reader-chart-baseline, rgba(96, 125, 139, 0.75))",Xt="6 4",_r=24*60*60*1e3;function ee(e,t={}){const n=document.createElementNS(gr,e);return Object.entries(t).forEach(([r,a])=>{a!=null&&n.setAttribute(r,String(a))}),n}function yt(e,t=null){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"&&e.trim()!==""){const n=Number.parseFloat(e);if(Number.isFinite(n))return n}return t}function br(e,t){if(e instanceof Date){const n=e.getTime();return Number.isFinite(n)?n:t}if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"){const n=Date.parse(e);if(Number.isFinite(n))return n}return t}const Zt=e=>{if(e&&typeof e=="object"&&"date"in e)return e.date},Jt=e=>{if(e&&typeof e=="object"&&"close"in e)return e.close},Qt=(e,t,n)=>{if(Number.isFinite(e)){const r=new Date(e);if(!Number.isNaN(r.getTime()))return r.toLocaleDateString("de-DE")}if(t&&typeof t=="object"&&"date"in t){const r=t.date;return r!=null?String(r):""}return e==null?"":String(e)},ct=(e,t,n)=>(Number.isFinite(e)?e:Number.parseFloat(String(e))||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}),en=({xFormatted:e,yFormatted:t})=>`
    <div class="chart-tooltip-date">${e}</div>
    <div class="chart-tooltip-value">${t}&nbsp;€</div>
  `;function tn(e){return e.__chartState||(e.__chartState={svg:null,areaPath:null,linePath:null,baselineLine:null,focusLine:null,focusCircle:null,overlay:null,tooltip:null,width:he,height:ge,margin:{...fe},series:[],points:[],range:null,xAccessor:Zt,yAccessor:Jt,xFormatter:Qt,yFormatter:ct,tooltipRenderer:en,color:pe,areaColor:Xe,baseline:null,handlersAttached:!1}),e.__chartState}function ne(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function mr(e,t){if(!Array.isArray(e)||e.length===0)return"";const n=e.map((a,i)=>`${i===0?"M":"L"}${a.x.toFixed(2)} ${a.y.toFixed(2)}`).join(" "),r=`L${e[e.length-1].x.toFixed(2)} ${t.toFixed(2)} L${e[0].x.toFixed(2)} ${t.toFixed(2)} Z`;return`${n} ${r}`}function yr(e){return!Array.isArray(e)||e.length===0?"":e.map((t,n)=>`${n===0?"M":"L"}${t.x.toFixed(2)} ${t.y.toFixed(2)}`).join(" ")}function vr(e){const{baselineLine:t,baseline:n}=e;if(!t)return;const r=(n==null?void 0:n.color)??jt,a=(n==null?void 0:n.dashArray)??Xt;t.setAttribute("stroke",r),t.setAttribute("stroke-dasharray",a)}function vt(e){const{baselineLine:t,baseline:n,range:r,margin:a,width:i}=e;if(!t)return;const s=n==null?void 0:n.value;if(!r||s==null||!Number.isFinite(s)){t.style.opacity="0";return}const{minY:c,maxY:o,boundedHeight:l}=r,u=Number.isFinite(c)?c:s,f=(Number.isFinite(o)?o:u+1)-u,_=f===0?.5:(s-u)/f,m=ne(_,0,1),y=Math.max(l,0),p=a.top+(1-m)*y,b=Math.max(i-a.left-a.right,0),h=a.left,g=a.left+b;t.setAttribute("x1",h.toFixed(2)),t.setAttribute("x2",g.toFixed(2)),t.setAttribute("y1",p.toFixed(2)),t.setAttribute("y2",p.toFixed(2)),t.style.opacity="1"}function Sr(e,t,n){var E;const{width:r,height:a,margin:i}=t,{xAccessor:s,yAccessor:c}=n;if(!Array.isArray(e)||e.length===0)return{points:[],range:null};const o=e.map((v,R)=>{const k=s(v,R),H=c(v,R),z=br(k,R),B=yt(H,Number.NaN);return Number.isFinite(B)?{index:R,data:v,xValue:z,yValue:B}:null}).filter(v=>!!v);if(o.length===0)return{points:[],range:null};const l=o.reduce((v,R)=>Math.min(v,R.xValue),o[0].xValue),u=o.reduce((v,R)=>Math.max(v,R.xValue),o[0].xValue),d=o.reduce((v,R)=>Math.min(v,R.yValue),o[0].yValue),f=o.reduce((v,R)=>Math.max(v,R.yValue),o[0].yValue),_=Math.max(r-i.left-i.right,1),m=Math.max(a-i.top-i.bottom,1),y=Number.isFinite(l)?l:0,p=Number.isFinite(u)?u:y+1,b=Number.isFinite(d)?d:0,h=Number.isFinite(f)?f:b+1,g=yt((E=t.baseline)==null?void 0:E.value,null),P=g!=null&&Number.isFinite(g)?Math.min(b,g):b,A=g!=null&&Number.isFinite(g)?Math.max(h,g):h,N=Math.max(2,Math.min(6,Math.round(Math.max(a-i.top-i.bottom,0)/60)||4)),{niceMin:S,niceMax:L}=Fr(P,A,N),w=Number.isFinite(S)?S:b,D=Number.isFinite(L)?L:h,T=p-y||1,M=D-w||1;return{points:o.map(v=>{const R=T===0?.5:(v.xValue-y)/T,k=M===0?.5:(v.yValue-w)/M,H=i.left+R*_,z=i.top+(1-k)*m;return{...v,x:H,y:z}}),range:{minX:y,maxX:p,minY:w,maxY:D,boundedWidth:_,boundedHeight:m}}}function nn(e,t,n,r){e.width=Number.isFinite(t)?Number(t):he,e.height=Number.isFinite(n)?Number(n):ge,e.margin={top:Number.isFinite(r==null?void 0:r.top)?Number(r==null?void 0:r.top):fe.top,right:Number.isFinite(r==null?void 0:r.right)?Number(r==null?void 0:r.right):fe.right,bottom:Number.isFinite(r==null?void 0:r.bottom)?Number(r==null?void 0:r.bottom):fe.bottom,left:Number.isFinite(r==null?void 0:r.left)?Number(r==null?void 0:r.left):fe.left}}function Pr(e,t){const n=e.xFormatter(t.xValue,t.data,t.index),r=e.yFormatter(t.yValue,t.data,t.index);return e.tooltipRenderer({point:t,xFormatted:n,yFormatted:r,data:t.data,index:t.index})}function Ar(e,t,n){const{tooltip:r,width:a,margin:i,height:s}=e;if(!r)return;const c=s-i.bottom;r.style.visibility="visible",r.style.opacity="1";const o=r.offsetWidth||0,l=r.offsetHeight||0,u=ne(t.x-o/2,i.left,a-i.right-o),d=Math.max(c-l,0),f=12,_=Number.isFinite(n)?ne(n??0,i.top,c):t.y;let m=_-l-f;m<i.top&&(m=_+f),m=ne(m,0,d),r.style.transform=`translate(${Math.round(u)}px, ${Math.round(m)}px)`}function we(e){const{tooltip:t,focusLine:n,focusCircle:r}=e;t&&(t.style.opacity="0",t.style.visibility="hidden"),n&&(n.style.opacity="0"),r&&(r.style.opacity="0")}function wr(e,t){if(t.handlersAttached||!t.overlay)return;const n=a=>{if(!t.points||t.points.length===0||!t.svg){we(t);return}const i=t.svg.getBoundingClientRect(),s=a.clientX-i.left,c=a.clientY-i.top;let o=t.points[0],l=Math.abs(s-o.x);for(let u=1;u<t.points.length;u+=1){const d=t.points[u],f=Math.abs(s-d.x);f<l&&(l=f,o=d)}if(!o){we(t);return}t.focusCircle&&(t.focusCircle.setAttribute("cx",o.x.toFixed(2)),t.focusCircle.setAttribute("cy",o.y.toFixed(2)),t.focusCircle.style.opacity="1"),t.focusLine&&(t.focusLine.setAttribute("x1",o.x.toFixed(2)),t.focusLine.setAttribute("x2",o.x.toFixed(2)),t.focusLine.setAttribute("y1",t.margin.top.toFixed(2)),t.focusLine.setAttribute("y2",(t.height-t.margin.bottom).toFixed(2)),t.focusLine.style.opacity="1"),t.tooltip&&(t.tooltip.innerHTML=Pr(t,o),Ar(t,o,c))},r=()=>{we(t)};t.overlay.addEventListener("pointermove",n),t.overlay.addEventListener("pointerenter",n),t.overlay.addEventListener("pointerleave",r),t.handlersAttached=!0,t.handlePointerMove=n,t.handlePointerLeave=r,e.addEventListener("pointercancel",r)}function Nr(e,t={}){if(!e)return console.error("renderLineChart: root element is required"),null;const n=document.createElement("div");n.className="line-chart-container",n.dataset.chartType="line",n.style.position="relative";const r=ee("svg",{width:he,height:ge,viewBox:`0 0 ${he} ${ge}`,role:"img","aria-hidden":"true",focusable:"false"});r.classList.add("line-chart-svg");const a=ee("path",{class:"line-chart-area",fill:Xe,stroke:"none"}),i=ee("line",{class:"line-chart-baseline",stroke:jt,"stroke-width":1,"stroke-dasharray":Xt,opacity:0}),s=ee("path",{class:"line-chart-path",fill:"none",stroke:pe,"stroke-width":2,"stroke-linecap":"round","stroke-linejoin":"round"}),c=ee("line",{class:"line-chart-focus-line",stroke:pe,"stroke-width":1,"stroke-dasharray":"4 4",opacity:0}),o=ee("circle",{class:"line-chart-focus-circle",r:4,fill:"#fff",stroke:pe,"stroke-width":2,opacity:0}),l=ee("rect",{class:"line-chart-overlay",fill:"transparent",x:0,y:0,width:he,height:ge});r.appendChild(a),r.appendChild(i),r.appendChild(s),r.appendChild(c),r.appendChild(o),r.appendChild(l),n.appendChild(r);const u=document.createElement("div");u.className="chart-tooltip",u.style.position="absolute",u.style.top="0",u.style.left="0",u.style.pointerEvents="none",u.style.opacity="0",u.style.visibility="hidden",n.appendChild(u),e.appendChild(n);const d=tn(n);if(d.svg=r,d.areaPath=a,d.linePath=s,d.baselineLine=i,d.focusLine=c,d.focusCircle=o,d.overlay=l,d.tooltip=u,d.xAccessor=t.xAccessor??Zt,d.yAccessor=t.yAccessor??Jt,d.xFormatter=t.xFormatter??Qt,d.yFormatter=t.yFormatter??ct,d.tooltipRenderer=t.tooltipRenderer??en,d.color=t.color??pe,d.areaColor=t.areaColor??Xe,d.baseline=t.baseline??null,d.handlersAttached=!1,!d.xAxis){const f=document.createElement("div");f.className="line-chart-axis line-chart-axis-x",f.style.position="absolute",f.style.left="0",f.style.right="0",f.style.bottom="0",f.style.pointerEvents="none",f.style.fontSize=mt,f.style.color="var(--secondary-text-color)",f.style.display="block",n.appendChild(f),d.xAxis=f}if(!d.yAxis){const f=document.createElement("div");f.className="line-chart-axis line-chart-axis-y",f.style.position="absolute",f.style.top="0",f.style.bottom="0",f.style.left="0",f.style.pointerEvents="none",f.style.fontSize=mt,f.style.color="var(--secondary-text-color)",f.style.display="block",n.appendChild(f),d.yAxis=f}return nn(d,t.width,t.height,t.margin),d.linePath&&d.linePath.setAttribute("stroke",d.color),d.focusLine&&d.focusLine.setAttribute("stroke",d.color),d.focusCircle&&d.focusCircle.setAttribute("stroke",d.color),d.areaPath&&d.areaPath.setAttribute("fill",d.areaColor),rn(n,t),wr(n,d),n}function rn(e,t={}){if(!e){console.error("updateLineChart: container element is required");return}const n=tn(e);if(!n.svg||!n.linePath||!n.overlay){console.error("updateLineChart: chart was not initialised with renderLineChart");return}t.xAccessor&&(n.xAccessor=t.xAccessor),t.yAccessor&&(n.yAccessor=t.yAccessor),t.xFormatter&&(n.xFormatter=t.xFormatter),t.yFormatter&&(n.yFormatter=t.yFormatter),t.tooltipRenderer&&(n.tooltipRenderer=t.tooltipRenderer),t.color&&(n.color=t.color,n.linePath.setAttribute("stroke",n.color),n.focusLine&&n.focusLine.setAttribute("stroke",n.color),n.focusCircle&&n.focusCircle.setAttribute("stroke",n.color)),t.areaColor&&(n.areaColor=t.areaColor,n.areaPath&&n.areaPath.setAttribute("fill",n.areaColor)),Object.prototype.hasOwnProperty.call(t,"baseline")&&(n.baseline=t.baseline??null),vr(n),nn(n,t.width,t.height,t.margin);const{width:r,height:a,margin:i}=n;n.svg.setAttribute("width",String(r)),n.svg.setAttribute("height",String(a)),n.svg.setAttribute("viewBox",`0 0 ${r} ${a}`),n.overlay.setAttribute("x",i.left.toFixed(2)),n.overlay.setAttribute("y",i.top.toFixed(2)),n.overlay.setAttribute("width",Math.max(r-i.left-i.right,0).toFixed(2)),n.overlay.setAttribute("height",Math.max(a-i.top-i.bottom,0).toFixed(2));const s=Array.isArray(t.series)?t.series:n.series;n.series=Array.isArray(s)?[...s]:[];const{points:c,range:o}=Sr(n.series,n,{xAccessor:n.xAccessor,yAccessor:n.yAccessor});if(n.points=c,n.range=o,!c||c.length===0){n.linePath.setAttribute("d",""),n.areaPath&&n.areaPath.setAttribute("d",""),we(n),St(n),vt(n);return}const l=yr(c);if(n.linePath.setAttribute("d",l),n.areaPath&&o){const u=n.margin.top+o.boundedHeight,d=mr(c,u);n.areaPath.setAttribute("d",d)}St(n),vt(n)}function St(e){const{xAxis:t,yAxis:n,range:r,margin:a,height:i,yFormatter:s}=e;if(!t||!n)return;if(!r){t.innerHTML="",n.innerHTML="";return}const{minX:c,maxX:o,minY:l,maxY:u,boundedWidth:d,boundedHeight:f}=r,_=Number.isFinite(c)&&Number.isFinite(o)&&o>=c,m=Number.isFinite(l)&&Number.isFinite(u)&&u>=l,y=Math.max(d,0),p=Math.max(f,0);if(t.style.left=`${a.left}px`,t.style.width=`${y}px`,t.style.top=`${i-a.bottom+6}px`,t.innerHTML="",_&&y>0){const h=(o-c)/_r,g=Math.max(2,Math.min(6,Math.round(y/140)||4));xr(e,c,o,g,h).forEach(({positionRatio:A,label:N})=>{const S=document.createElement("div");S.className="line-chart-axis-tick line-chart-axis-tick-x",S.style.position="absolute",S.style.bottom="0";const L=ne(A,0,1);S.style.left=`${L*y}px`;let w="-50%",D="center";L<=.001?(w="0",D="left",S.style.marginLeft="2px"):L>=.999&&(w="-100%",D="right",S.style.marginRight="2px"),S.style.transform=`translateX(${w})`,S.style.textAlign=D,S.textContent=N,t.appendChild(S)})}n.style.top=`${a.top}px`,n.style.height=`${p}px`;const b=Math.max(a.left-6,0);if(n.style.left="0",n.style.width=`${Math.max(b,0)}px`,n.innerHTML="",m&&p>0){const h=Math.max(2,Math.min(6,Math.round(p/60)||4)),g=Er(l,u,h),P=s??ct;g.forEach(({value:A,positionRatio:N})=>{const S=document.createElement("div");S.className="line-chart-axis-tick line-chart-axis-tick-y",S.style.position="absolute",S.style.left="0";const w=(1-ne(N,0,1))*p;S.style.top=`${w}px`,S.textContent=P(A,null,-1),n.appendChild(S)})}}function Fr(e,t,n=4){if(!Number.isFinite(e)||!Number.isFinite(t))return{niceMin:e,niceMax:t};const r=Math.max(2,n);if(t===e){const l=Ze(Math.abs(e)||1);return{niceMin:e-l,niceMax:t+l}}const i=(t-e)/(r-1),s=Ze(i),c=Math.floor(e/s)*s,o=Math.ceil(t/s)*s;return c===o?{niceMin:e,niceMax:t+s}:{niceMin:c,niceMax:o}}function xr(e,t,n,r,a){if(!Number.isFinite(t)||!Number.isFinite(n)||n<t)return[];if(!Number.isFinite(a)||a<=0)return[{positionRatio:.5,label:Pt(e,t,a||0)}];const i=Math.max(2,r),s=[],c=n-t;for(let o=0;o<i;o+=1){const l=i===1?.5:o/(i-1),u=t+l*c;s.push({positionRatio:l,label:Pt(e,u,a)})}return s}function Pt(e,t,n){const r=new Date(t);return Number.isFinite(r.getTime())?n>1095?String(r.getFullYear()):n>365?r.toLocaleDateString("de-DE",{year:"numeric",month:"short"}):n>90?r.toLocaleDateString("de-DE",{year:"2-digit",month:"short"}):n>30?r.toLocaleDateString("de-DE",{day:"2-digit",month:"short"}):r.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"}):e.xFormatter?e.xFormatter(t,null,-1):String(t)}function Er(e,t,n){if(!Number.isFinite(e)||!Number.isFinite(t))return[];if(t===e)return[{value:e,positionRatio:.5}];const r=t-e,a=Math.max(2,n),i=r/(a-1),s=Ze(i),c=Math.floor(e/s)*s,o=Math.ceil(t/s)*s,l=[];for(let u=c;u<=o+s/2;u+=s){const d=(u-e)/(t-e);l.push({value:u,positionRatio:ne(d,0,1)})}return l.length>a+2?l.filter((u,d)=>d%2===0):l}function Ze(e){if(!Number.isFinite(e)||e===0)return 1;const t=Math.floor(Math.log10(Math.abs(e))),n=Math.abs(e)/10**t;let r;return n<=1?r=1:n<=2?r=2:n<=5?r=5:r=10,r*10**t}const Oe={min:0,max:6},Te={min:2,max:4},Dr="1Y",an=["1M","6M","1Y","5Y","ALL"],Rr={"1M":30,"6M":182,"1Y":365,"5Y":1826,ALL:Number.POSITIVE_INFINITY};function Pe(e){if(!e)return null;const t=b=>{const h=F(b);return h??null},n=b=>b==="totals"||b==="eur_total"?b:"aggregation",r=t(e.total_holdings_precise)??t(e.total_holdings),a=b=>{const h=t(b);if(h==null||r==null||!Number.isFinite(r)||r===0)return null;const g=h/r;return Number.isFinite(g)?g:null},i=a(e.purchase_total_security),s=a(e.purchase_total_account),c=a(e.purchase_value_eur),o=e.average_cost;if(o&&typeof o=="object"){const b=t(o.native),h=t(o.security),g=t(o.account),P=t(o.eur),A=t(o.coverage_ratio),N=t(e.average_purchase_price_native),S=t(e.avg_price_security),L=t(e.avg_price_account),w=t(e.purchase_value_eur);return{native:b??h??N??S??i??null,security:h??b??S??N??i??null,account:g??L??s??P??w??null,eur:P??c??w??null,source:n(o.source),coverageRatio:A}}const l=t(e.average_purchase_price_native),u=t(e.avg_price_security),d=t(e.avg_price_account),f=t(e.purchase_value_eur),_=u??i,m=l??_??i,y=d??s??c,p=c??f??y;return m==null&&_==null&&y==null&&p==null?null:{native:m??_??null,security:_??m??null,account:y??p??null,eur:p??y??null,source:"aggregation",coverageRatio:null}}const At={aggregation:"Aggregationsdaten",totals:"Kaufsummen",eur_total:"EUR-Kaufsumme"},ie=new Map,Ne=new Map,ve=new Map,$e=new Map,on="pp-reader:portfolio-positions-updated",_e=new Map;function Lr(e){const{fallbackUsed:t,flaggedAsCache:n}=e,r=[];return t&&r.push("Der aktuelle Snapshot konnte nicht geladen werden. Es werden die zuletzt gespeicherten Werte angezeigt."),n&&!t&&r.push("Der Snapshot ist vom Datenanbieter als Zwischenspeicherstand markiert."),`
    <div class="card warning-card stale-notice" role="status" aria-live="polite">
      <h2>Zwischengespeicherte Werte</h2>
      <p>${r.length?r.join(" "):"Die Daten stammen aus dem Zwischenspeicher."}</p>
      <p class="stale-notice__hint">Die angezeigten Beträge können von den aktuellen Marktwerten abweichen. Laden Sie die Ansicht erneut, sobald eine Verbindung verfügbar ist.</p>
    </div>
  `}function sn(e,t){if(e){if(t){ve.set(e,t);return}ve.delete(e)}}function Tr(e){if(!e||typeof window>"u")return null;if(ve.has(e)){const n=ve.get(e)||null;if(n)return n}const t=kr(e);return t?(sn(e,t),t):null}function $r(){try{const e=window.__ppReaderPortfolioPositionsCache;if(e&&typeof e.values=="function")return e}catch(e){console.warn("resolvePortfolioPositionsCache: Zugriff fehlgeschlagen",e)}return null}function Cr(e){if(!e||typeof e!="object")return null;const t=e.aggregation;return!t||typeof t!="object"?null:t}function kr(e){const t=$r();if(!t)return null;const n=[];for(const x of t.values())if(!(!Array.isArray(x)||x.length===0))for(const E of x){const v=E==null?void 0:E.security_uuid;typeof v=="string"&&v===e&&n.push(E)}if(!n.length)return null;let r="",a=0,i=0,s=0,c=0,o=0,l=0,u=0,d=0,f=0,_=0,m=0,y=0,p=0;for(const x of n){!r&&typeof(x==null?void 0:x.name)=="string"&&(r=x.name);const E=Cr(x),v=F(E==null?void 0:E.total_holdings)??F(x==null?void 0:x.current_holdings);v!=null&&(a+=v);const R=F(E==null?void 0:E.purchase_value_eur)??F(x==null?void 0:x.purchase_value);R!=null&&(i+=R);const k=F(x==null?void 0:x.current_value);k!=null&&(s+=k);const H=F(E==null?void 0:E.purchase_total_security)??F(x==null?void 0:x.purchase_total_security);H!=null&&(c+=H);const z=F(E==null?void 0:E.purchase_total_account)??F(x==null?void 0:x.purchase_total_account);if(z!=null&&(o+=z),v!=null&&v>0){const G=F(E==null?void 0:E.average_purchase_price_native)??F(x==null?void 0:x.average_purchase_price_native);G!=null&&(l+=v*G,u+=v);const K=F(E==null?void 0:E.avg_price_security)??F(x==null?void 0:x.avg_price_security);K!=null&&(d+=v*K,f+=v);const U=F(E==null?void 0:E.avg_price_account)??F(x==null?void 0:x.avg_price_account);U!=null&&(_+=v*U,m+=v)}const B=re(x.performance);B&&typeof B.gain_abs=="number"&&(y+=B.gain_abs,p+=1)}const b=O(a,{decimals:6,fallback:0})??0,h=O(i,{fallback:0})??0,g=O(s,{fallback:0})??0,P=p>0?O(y,{fallback:null}):null,A=p>0&&i>0?O(y/i*100,{fallback:null}):null,N=b>0?O(g/b,{fallback:null}):null,S=O(c,{fallback:0})??0,L=O(o,{fallback:0})??0,w=u>0?O(l/u,{decimals:6,fallback:null}):null,D=f>0?O(d/f,{decimals:6,fallback:null}):null,T=m>0?O(_/m,{decimals:6,fallback:null}):null,M=P!=null&&A!=null?{gain_abs:P,gain_pct:A,total_change_eur:P,total_change_pct:A,source:"cache",coverage_ratio:null,day_change:null}:null;return{security_uuid:e,name:r,total_holdings:b,purchase_value_eur:h,current_value_eur:g,gain_abs_eur:P,gain_pct:A,last_price_eur:N,purchase_total_security:S,purchase_total_account:L,avg_price_security:D,avg_price_account:T,average_purchase_price_native:w,source:"cache",performance:M}}function cn(e){return ie.has(e)||ie.set(e,new Map),ie.get(e)}function ln(e){if(e&&ie.has(e)){try{const t=ie.get(e);t==null||t.clear()}catch(t){console.warn("invalidateHistoryCache: Konnte Cache nicht leeren",e,t)}ie.delete(e)}}function un(e){e&&(ve.delete(e),$e.delete(e))}function Mr(e,t){if(!e||!t)return;const n=t.securityUuids;(Array.isArray(n)?n:[]).includes(e)&&(ln(e),un(e))}function Hr(e){if(!e||_e.has(e))return;const t=n=>{if(!(n instanceof CustomEvent))return;const r=n.detail;r&&Mr(e,r)};try{window.addEventListener(on,t),_e.set(e,t)}catch(n){console.error("ensureLiveUpdateSubscription: Registrierung fehlgeschlagen",n)}}function Ir(e){if(!e||!_e.has(e))return;const t=_e.get(e);try{t&&window.removeEventListener(on,t)}catch(n){console.error("removeLiveUpdateSubscription: Entfernen des Listeners fehlgeschlagen",n)}_e.delete(e)}function qr(e){e&&(Ir(e),ln(e),un(e))}function wt(e,t){if(!Ne.has(e)){Ne.set(e,{activeRange:t});return}const n=Ne.get(e);n&&(n.activeRange=t)}function dn(e){var t;return((t=Ne.get(e))==null?void 0:t.activeRange)??Dr}function Ce(e){const t=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate());return Math.floor(t/864e5)}function Je(e){const t=new Date(e.getTime());return t.setUTCHours(0,0,0,0),t}function F(e){return it(e)}function fn(e){const t=Je(new Date),n=Rr[e],r={end_date:Ce(t)};if(Number.isFinite(n)&&n>0){const a=new Date(t.getTime());a.setUTCDate(a.getUTCDate()-(n-1)),r.start_date=Ce(a)}return r}function pn(e){if(!e)return null;if(e instanceof Date&&!Number.isNaN(e.getTime()))return new Date(e.getTime());if(typeof e=="number"&&Number.isFinite(e)){const t=e*864e5;if(Number.isFinite(t))return new Date(t)}if(typeof e=="string"){const t=e.trim();if(/^\d{8}$/.test(t)){const r=Number.parseInt(t.slice(0,4),10),a=Number.parseInt(t.slice(4,6),10)-1,i=Number.parseInt(t.slice(6,8),10);if(Number.isFinite(r)&&Number.isFinite(a)&&Number.isFinite(i)){const s=new Date(Date.UTC(r,a,i));if(!Number.isNaN(s.getTime()))return s}}const n=Date.parse(t);if(Number.isFinite(n))return new Date(n)}return null}function le(e){if(!e&&e!==0)return null;if(e instanceof Date&&!Number.isNaN(e.getTime()))return e.getTime();if(typeof e=="number"&&Number.isFinite(e)){if(e>1e12)return e;if(e>1e9)return e*1e3}if(typeof e=="string"){const t=e.trim();if(!t)return null;const n=Date.parse(t);if(Number.isFinite(n))return n}return null}function hn(e){return Array.isArray(e)?e.map(t=>{let r=F(t==null?void 0:t.close);if(r==null){const i=F(t==null?void 0:t.close_raw);i!=null&&(r=i/1e8)}return r==null?null:{date:pn(t==null?void 0:t.date)??(t==null?void 0:t.date),close:r}}).filter(t=>!!t):[]}function lt(e){var r;const t=F(e==null?void 0:e.last_price_native)??F((r=e==null?void 0:e.last_price)==null?void 0:r.native)??null;if($(t))return t;if(String((e==null?void 0:e.currency_code)||"").toUpperCase()==="EUR"){const a=F(e==null?void 0:e.last_price_eur);if($(a))return a}return null}function Vr(e){var t;return e?le(e==null?void 0:e.last_price_fetched_at)??le((t=e.last_price)==null?void 0:t.fetched_at)??null:null}function Qe(e,t){const r=(Array.isArray(e)?e:[]).slice(),a=lt(t);if(!$(a))return r;const i=Vr(t)??Date.now(),s=new Date(i);if(Number.isNaN(s.getTime()))return r;const c=Ce(Je(s));let o=null;for(let l=r.length-1;l>=0;l-=1){const u=r[l];if(!u)continue;const d=pn(u.date);if(!d)continue;const f=Ce(Je(d));if(o==null&&(o=f),f===c)return u.close!==a&&(r[l]={...u,close:a}),r;if(f<c)break}return o!=null&&o>c||r.push({date:s,close:a}),r}function Ur(e,t){const n=String((e==null?void 0:e.currency_code)||"").toUpperCase();if(!n||n==="EUR")return 1;const r=F(e==null?void 0:e.last_price_eur);if(r==null||r<=0)return null;const a=F(e==null?void 0:e.last_price_native);if(a!=null&&a>0)return r/a;const i=F(t);return i!=null&&i>0?r/i:null}function $(e){return typeof e=="number"&&Number.isFinite(e)}function gn(e){return typeof e=="number"&&Number.isFinite(e)&&e>0}function Fe(e,t,n){if(!$(e)||!$(t))return!1;const r=Math.abs(e-t),a=Math.max(Math.abs(e),Math.abs(t),1);return r<=a*1e-4}function Wr(e,t){return!$(t)||t===0||!$(e)?null:Mn((e-t)/t*100)}function Br(e,t){var D,T;if(!e)return null;if(!t)return $e.delete(e),null;const n=t.total_holdings_precise??t.total_holdings??null,r=F(n),a=F(t.purchase_value_eur),i=F(t.market_value_eur)??F(t.current_value_eur),s=Pe(t),c=(s==null?void 0:s.security)??(s==null?void 0:s.native)??F(t.avg_price_security)??F(t.average_purchase_price_native),o=(s==null?void 0:s.account)??F(t.avg_price_account),l=(s==null?void 0:s.eur)??null,u=F(t.last_price_native)??F((D=t.last_price)==null?void 0:D.native)??null,d=le(t==null?void 0:t.last_price_fetched_at)??le((T=t.last_price)==null?void 0:T.fetched_at),f=Ur(t,u),_=gn(f)?f:null,m=$(r)?r:null,y=re(t.performance),p=(y==null?void 0:y.day_change)??null,b=F(t==null?void 0:t.day_price_change_native),h=F(t==null?void 0:t.day_price_change_eur),g=F(t==null?void 0:t.day_change_pct),P=(p==null?void 0:p.price_change_native)??b??null,A=(p==null?void 0:p.price_change_eur)??h??null,N=(p==null?void 0:p.change_pct)??g??null,S=(y==null?void 0:y.total_change_eur)??null,L=(y==null?void 0:y.total_change_pct)??null,w={holdings:m,fxRate:_,purchaseValueEur:a,currentValueEur:i,averagePurchaseNative:c,averagePurchaseEur:l,averagePurchaseAccount:o??l,dayPriceChangeNative:P,dayPriceChangeEur:A,dayChangePct:N,totalChangeEur:S,totalChangePct:L,performance:y??null,lastPriceFetchedAt:d??null};return $e.set(e,w),w}function Nt(e){return e?$e.get(e)??null:null}function _n(e,t){if(!Array.isArray(e)||e.length===0)return{priceChange:null,priceChangePct:null};const n=e[0],r=F(n==null?void 0:n.close);if(!$(r)||r===0)return{priceChange:null,priceChangePct:null};const a=e[e.length-1],i=F(a==null?void 0:a.close),s=F(t)??i;if(!$(s))return{priceChange:null,priceChangePct:null};const c=s-r,o=Object.is(c,-0)?0:c,l=Wr(s,r);return{priceChange:o,priceChangePct:l}}function ut(e,t){if(!$(e)||e===0)return"neutral";const n=.5/Math.pow(10,t);return Math.abs(e)<n?"neutral":e>0?"positive":"negative"}function Gr(e,t){if(!$(e))return'<span class="value neutral">—</span>';const n=oe(e);if(n==="—")return'<span class="value neutral">—</span>';const r=ut(e,Te.max),a=t?`&nbsp;${t}`:"";return`<span class="value ${r}">${n}${a}</span>`}function Or(e){return $(e)?`<span class="value ${ut(e,2)} value--percentage">${Z(e)}&nbsp;%</span>`:'<span class="value neutral">—</span>'}function bn(e,t,n,r){const a=e||"";return`
    <div class="security-info-bar" data-range="${a}">
      <div class="security-info-item">
        <span class="label">Preisänderung (${a||"Zeitraum"})</span>
        <div class="value-row">
          ${Gr(t,r)}
          ${Or(n)}
        </div>
      </div>
    </div>
  `}function zr(e){return`
    <div class="security-range-selector" role="group" aria-label="Zeitraum">
      ${an.map(n=>`
      <button
        type="button"
        class="security-range-button${n===e?" active":""}"
        data-range="${n}"
        aria-pressed="${n===e}"
      >
        ${n}
      </button>
    `).join(`
`)}
    </div>
  `}function mn(e,t={status:"empty"}){const n=e||"";switch(t.status){case"loaded":return`
        <div
          class="history-chart"
          data-state="loaded"
          data-range="${n}"
          role="img"
          aria-label="Preisverlauf${n?` für ${n}`:""}"
        ></div>
      `;case"error":{const r=t!=null&&t.message?String(t.message):"Die historischen Daten konnten nicht geladen werden.";return`
        <div class="history-placeholder" data-state="error" data-range="${n}">
          <p>${r}</p>
        </div>
      `}case"empty":default:return`
        <div class="history-placeholder" data-state="empty" data-range="${n}">
          <p>Für dieses Wertpapier liegen im Zeitraum ${n||"den gewählten Zeitraum"} keine historischen Daten vor.</p>
        </div>
      `}}function Kr(e){const t=F(e);if(t==null)return"—";const n=Math.abs(t%1)>0,r=n?2:Oe.min,a=n?Oe.max:Oe.min;return t.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:a})}function oe(e){const t=F(e);return t==null?"—":t.toLocaleString("de-DE",{minimumFractionDigits:Te.min,maximumFractionDigits:Te.max})}function Yr(e,t){const n=oe(e),r=`&nbsp;${t}`;return`<span class="${ut(e,Te.max)}">${n}${r}</span>`}function jr(e){return e==null?"":String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Xr(e,t,n,r){const a=Pe(e),i=(a==null?void 0:a.account)??($(n)?n:F(n));if(!$(i))return null;const s=(e==null?void 0:e.account_currency_code)??(e==null?void 0:e.account_currency);if(typeof s=="string"&&s.trim())return s.trim().toUpperCase();const c=String((e==null?void 0:e.currency_code)||"").trim().toUpperCase(),o=(a==null?void 0:a.security)??(a==null?void 0:a.native)??($(r)?r:F(r));if(c&&$(o)&&Fe(i,o))return c;const l=F(e==null?void 0:e.purchase_total_security),u=F(e==null?void 0:e.purchase_total_account);let d=null;$(l)&&l!==0&&$(u)&&(d=u/l);const f=(t==null?void 0:t.fxRate)??null;if(d!=null){if(Fe(d,1))return c||null;if(gn(f)&&Fe(d,f))return"EUR"}if(c==="EUR")return"EUR";const _=F(e==null?void 0:e.purchase_value_eur);return $(_)?"EUR":c||"EUR"}function Ft(e){return typeof e!="number"||!Number.isFinite(e)||e<=0?null:e.toLocaleString("de-DE",{minimumFractionDigits:4,maximumFractionDigits:4})}function Zr(e,t){const n=e,r=["purchase_fx_date","purchase_fx_timestamp","purchase_fx_rate_date","purchase_fx_rate_timestamp","avg_price_updated_at","avg_price_timestamp","purchase_updated_at","purchase_updated","purchase_value_updated_at","purchase_value_updated","last_purchase_date","last_purchase_timestamp","last_transaction_date","last_transaction_at"];for(const s of r){const c=n==null?void 0:n[s],o=le(c);if(o!=null)return o}if((t==null?void 0:t.lastPriceFetchedAt)!=null&&Number.isFinite(t.lastPriceFetchedAt))return t.lastPriceFetchedAt;const a=[];n&&"last_price_fetched_at"in n&&a.push(n.last_price_fetched_at);const i=e==null?void 0:e.last_price;i&&typeof i=="object"&&a.push(i.fetched_at),n&&"last_price_date"in n&&a.push(n.last_price_date);for(const s of a){const c=le(s);if(c!=null)return c}return null}function Jr(e){if(e==null||!Number.isFinite(e))return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t.toLocaleDateString("de-DE")}function Qr(e,t,n,r,a,i,s,c){const o=String((e==null?void 0:e.currency_code)||"").trim().toUpperCase(),l=String(n||"").trim().toUpperCase();if(!o||!l||o===l)return null;const u=(w,D)=>{if(typeof w!="number"||!Number.isFinite(w)||w<=0||typeof D!="number"||!Number.isFinite(D)||D<=0)return null;const T=w/D;return T>0&&Number.isFinite(T)?T:null},d=c??Pe(e),f=(d==null?void 0:d.security)??(d==null?void 0:d.native)??F(r),_=(d==null?void 0:d.account)??F(a),m=F(i)??F(e==null?void 0:e.purchase_total_security),y=F(s)??F(e==null?void 0:e.purchase_total_account),p=[u(_,f),u(y,m)];let b=null;for(const w of p)if(w!=null){b=w;break}if(b==null)return null;const h=Ft(b);if(!h)return null;let g=null;if(b>0){const w=1/b;Number.isFinite(w)&&(g=Ft(w))}const P=Zr(e,t),A=Jr(P),N=[`FX-Kurs (Kauf): 1 ${o} = ${h} ${l}`];g&&N.push(`1 ${l} = ${g} ${o}`);const S=[];if(d){const w=At[d.source]??At.aggregation;if(S.push(`Quelle: ${w}`),typeof d.coverageRatio=="number"&&Number.isFinite(d.coverageRatio)){const D=d.coverageRatio*100,T=Math.min(Math.max(D,0),100);S.push(`Abdeckung: ${T.toLocaleString("de-DE",{minimumFractionDigits:0,maximumFractionDigits:1})}%`)}}S.length&&N.push(...S);const L=A??"Datum unbekannt";return`${N.join(" · ")} (Stand: ${L})`}function xt(e,t=null){var K;if(!e)return'<div class="meta-error">Keine Snapshot-Daten verfügbar.</div>';const n=e.currency_code||"EUR",r=(t==null?void 0:t.holdings)??e.total_holdings_precise??e.total_holdings,a=Kr(r),i=e.last_price_native??((K=e.last_price)==null?void 0:K.native)??e.last_price_eur,s=oe(i),c=s==="—"?null:`${s}${`&nbsp;${n}`}`,o=F(e.market_value_eur)??F(e.current_value_eur)??null,l=F(e.purchase_total_security),u=F(e.purchase_total_account),d=Pe(e),f=(t==null?void 0:t.averagePurchaseNative)??(d==null?void 0:d.security)??(d==null?void 0:d.native)??F(e.avg_price_security)??F(e.average_purchase_price_native),_=(t==null?void 0:t.averagePurchaseEur)??(d==null?void 0:d.eur)??null,y=(t==null?void 0:t.averagePurchaseAccount)??(d==null?void 0:d.account)??null??_,p=(t==null?void 0:t.performance)??null,b=(p==null?void 0:p.day_change)??null,h=(b==null?void 0:b.price_change_native)??null,g=(b==null?void 0:b.price_change_eur)??null,P=$(h)?h:g,A=$(h)?n:"EUR",N=(U,q="")=>{const Y=["value"];return q&&Y.push(...q.split(" ").filter(Boolean)),`<span class="${Y.join(" ")}">${U}</span>`},S=(U="")=>{const q=["value--missing"];return U&&q.push(U),N("—",q.join(" "))},L=(U,q="")=>{if(!$(U))return S(q);const Y=["value--gain"];return q&&Y.push(q),N(Dn(U),Y.join(" "))},w=(U,q="")=>{if(!$(U))return S(q);const Y=["value--gain-percentage"];return q&&Y.push(q),N(Rn(U),Y.join(" "))},D=c?N(c,"value--price"):S("value--price"),T=a==="—"?S("value--holdings"):N(a,"value--holdings"),M=$(o)?N(`${Z(o)}&nbsp;€`,"value--market-value"):S("value--market-value"),x=$(P)?N(Yr(P,A),"value--gain value--absolute"):S("value--absolute"),E=w(b==null?void 0:b.change_pct,"value--percentage"),v=L(p==null?void 0:p.total_change_eur,"value--absolute"),R=w(p==null?void 0:p.total_change_pct,"value--percentage"),k=Xr(e,t,y,f),H=Qr(e,t,k,f,y,l,u,d),z=H?` title="${jr(H)}"`:"",B=[];return $(f)?B.push(N(`${oe(f)}${`&nbsp;${n}`}`,"value--average value--average-native")):B.push(S("value--average value--average-native")),$(y)&&(!$(f)||!k||!n||k!==n||!Fe(y,f))&&$(y)&&B.push(N(`${oe(y)}${k?`&nbsp;${k}`:""}`,"value--average value--average-eur")),`
    <div class="security-meta-grid security-meta-grid--expanded">
      <div class="security-meta-item security-meta-item--price">
        <span class="label">Letzter Preis</span>
        <div class="value-group">${D}</div>
      </div>
      <div class="security-meta-item security-meta-item--average">
        <span class="label">Durchschnittlicher Kaufpreis</span>
        <div class="value-group"${z}>
          ${B.join("")}
        </div>
      </div>
      <div class="security-meta-item security-meta-item--day-change">
        <span class="label">Tagesänderung</span>
        <div class="value-group">
          ${x}
          ${E}
        </div>
      </div>
      <div class="security-meta-item security-meta-item--total-change">
        <span class="label">Gesamtänderung</span>
        <div class="value-group">
          ${v}
          ${R}
        </div>
      </div>
      <div class="security-meta-item security-meta-item--holdings">
        <span class="label">Bestand</span>
        <div class="value-group">${T}</div>
      </div>
      <div class="security-meta-item security-meta-item--market-value">
        <span class="label">Marktwert (EUR)</span>
        <div class="value-group">${M}</div>
      </div>
    </div>
  `}function yn(e){if(!e)return null;if(typeof e=="string")return e;if(e instanceof Error)return e.message||null;try{return JSON.stringify(e)}catch{return String(e)}}function Et(e,t){const n=e==null?void 0:e.averagePurchaseNative;if(typeof n=="number"&&Number.isFinite(n))return n;const r=Pe(t),a=(r==null?void 0:r.security)??(r==null?void 0:r.native)??null;if(typeof a=="number"&&Number.isFinite(a))return a;const i=F(t==null?void 0:t.avg_price_security);return typeof i=="number"&&Number.isFinite(i)?i:F(t==null?void 0:t.average_purchase_price_native)}function ea(e,t,{currency:n,baseline:r}={}){const a=e.clientWidth||e.offsetWidth||0,i=a>0?a:640,s=Math.min(Math.max(Math.floor(i*.55),220),420),c=(n||"").toUpperCase()||"EUR",o=$(r)?r:null;return{width:i,height:s,margin:{top:16,right:20,bottom:32,left:20},series:t,yFormatter:l=>oe(l),tooltipRenderer:({xFormatted:l,yFormatted:u})=>`
      <div class="chart-tooltip-date">${l}</div>
      <div class="chart-tooltip-value">${u}&nbsp;${c}</div>
    `,baseline:o!=null?{value:o}:null}}const Dt=new WeakMap;function ta(e,t,n={}){if(!e||!Array.isArray(t)||t.length===0)return;const r=ea(e,t,n);let a=Dt.get(e)||null;if(!a||!e.contains(a)){e.innerHTML="",a=Nr(e,r),a&&Dt.set(e,a);return}rn(a,r)}function Rt(e,t){e&&(e.dataset.activeRange=t,e.querySelectorAll(".security-range-button").forEach(n=>{const a=n.dataset.range===t;n.classList.toggle("active",a),n.setAttribute("aria-pressed",a?"true":"false"),n.disabled=!1,n.classList.remove("loading")}))}function na(e,t,n,r,a){const i=e.querySelector(".security-info-bar");if(!i||!i.parentElement)return;const s=document.createElement("div");s.innerHTML=bn(t,n,r,a).trim();const c=s.firstElementChild;c&&i.parentElement.replaceChild(c,i)}function Lt(e,t,n,r,a={}){const i=e.querySelector(".security-detail-placeholder");if(i&&(i.innerHTML=`
    <h2>Historie</h2>
    ${mn(t,n)}
  `,(n==null?void 0:n.status)==="loaded"&&Array.isArray(r)&&r.length)){const s=i.querySelector(".history-chart");s&&requestAnimationFrame(()=>{ta(s,r,a)})}}function ra(e){const{root:t,hass:n,panelConfig:r,securityUuid:a,snapshot:i,metrics:s,initialRange:c,initialHistory:o,initialHistoryState:l}=e;t&&setTimeout(()=>{const u=t.querySelector(".security-range-selector");if(!u)return;const d=cn(a),f=s??Nt(a),_=Et(f,i);if(Array.isArray(o)&&(l==null?void 0:l.status)!=="error"&&d.set(c,o),Hr(a),wt(a,c),Rt(u,c),l){const p=Qe(o,i);let b=l;b.status!=="error"&&(b=p.length?{status:"loaded"}:{status:"empty"}),Lt(t,c,b,p,{currency:i==null?void 0:i.currency_code,baseline:_})}const y=async p=>{if(!p||p===dn(a))return;const b=u.querySelector(`.security-range-button[data-range="${p}"]`);b&&(b.disabled=!0,b.classList.add("loading"));let h=d.get(p)||null,g=null,P=[];if(h)g=h.length?{status:"loaded"}:{status:"empty"};else try{const D=fn(p),T=await Ht(n,r,a,D);h=hn(T==null?void 0:T.prices),d.set(p,h),g=h.length?{status:"loaded"}:{status:"empty"}}catch(D){console.error("Range-Wechsel: Historie konnte nicht geladen werden",D),h=[],g={status:"error",message:yn(D)||"Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden."}}P=Qe(h,i),(g==null?void 0:g.status)!=="error"&&(g=P.length?{status:"loaded"}:{status:"empty"});const A=lt(i),{priceChange:N,priceChangePct:S}=_n(P,A);wt(a,p),Rt(u,p),na(t,p,N,S,i==null?void 0:i.currency_code);const L=Nt(a)??f,w=Et(L,i);Lt(t,p,g,P,{currency:i==null?void 0:i.currency_code,baseline:w})};u.addEventListener("click",p=>{var g;const b=(g=p.target)==null?void 0:g.closest(".security-range-button");if(!b||b.disabled)return;const{range:h}=b.dataset;!h||!an.includes(h)||y(h)})},0)}async function aa(e,t,n,r){if(!r)return console.error("renderSecurityDetail: securityUuid fehlt"),'<div class="card"><h2>Fehler</h2><p>Kein Wertpapier angegeben.</p></div>';const a=Tr(r);let i=null,s=null;try{const S=await Cn(t,n,r);S&&typeof S=="object"?i=S.snapshot&&typeof S.snapshot=="object"?S.snapshot:S:i=S}catch(S){console.error("renderSecurityDetail: Snapshot konnte nicht geladen werden",S),s=S instanceof Error?S.message:String(S)}const c=i||a,o=!!(a&&!i),l=((c==null?void 0:c.source)??"")==="cache";let u=null;r&&(sn(r,c??null),u=Br(r,c??null));const d=c&&(o||l)?Lr({fallbackUsed:o,flaggedAsCache:l}):"",f=(c==null?void 0:c.name)||"Wertpapierdetails";if(s)return`
      ${Ke(f,xt(c,u)).outerHTML}
      ${d}
      <div class="card error-card">
        <h2>Fehler beim Laden</h2>
        <p>${s}</p>
      </div>
    `;const _=dn(r),m=cn(r);let y=m.has(_)?m.get(_)??null:null,p={status:"empty"};if(Array.isArray(y))p=y.length?{status:"loaded"}:{status:"empty"};else{y=[];try{const S=fn(_),L=await Ht(t,n,r,S);y=hn(L==null?void 0:L.prices),m.set(_,y),p=y.length?{status:"loaded"}:{status:"empty"}}catch(S){console.error("renderSecurityDetail: Historie konnte nicht geladen werden",S),p={status:"error",message:yn(S)||"Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden."}}}const b=Qe(y,c);(p==null?void 0:p.status)!=="error"&&(p=b.length?{status:"loaded"}:{status:"empty"});const h=Ke(f,xt(c,u)),g=lt(c),{priceChange:P,priceChangePct:A}=_n(b,g),N=bn(_,P,A,c==null?void 0:c.currency_code);return ra({root:e,hass:t,panelConfig:n,securityUuid:r,snapshot:c,metrics:u,initialRange:_,initialHistory:y,initialHistoryState:p}),`
    ${h.outerHTML}
    ${d}
    ${N}
    ${zr(_)}
    <div class="card security-detail-placeholder">
      <h2>Historie</h2>
      ${mn(_,p)}
    </div>
  `}function ia(e){const{setSecurityDetailTabFactory:t}=e;if(typeof t!="function"){console.error("registerSecurityDetailTab: Ungültige Factory-Funktion übergeben");return}t(n=>({title:"Wertpapier",render:(r,a,i)=>aa(r,a,i,n),cleanup:()=>qr(n)}))}const oa=En,et="pp-reader-sticky-anchor",ke="overview",tt="security:",sa=[{key:ke,title:"Dashboard",render:Yt}],ue=new Map,Se=[],Me=new Map;let nt=null,ze=!1,se=null,I=0,de=null;function He(e){return typeof e=="object"&&e!==null}function ca(e){return e==="accounts"||e==="last_file_update"||e==="portfolio_values"||e==="portfolio_positions"}function Tt(e){const t=e.portfolio_uuid;if(typeof t=="string"&&t)return t;const n=e.portfolioUuid;return typeof n=="string"&&n?n:null}function la(e){if(!e)return null;if(Array.isArray(e)){for(const t of e)if(He(t)){const n=Tt(t);if(n)return n}return null}return He(e)?Tt(e):null}function ua(e,t){switch(e){case"accounts":return{type:e,data:Array.isArray(t)?t:null};case"last_file_update":return typeof t=="string"?{type:e,data:t}:He(t)?{type:e,data:t}:{type:e,data:null};case"portfolio_values":return Array.isArray(t)?{type:e,data:t}:{type:e,data:null};case"portfolio_positions":return Array.isArray(t)?{type:e,data:t}:He(t)?{type:e,data:t}:{type:e,data:null};default:return null}}function dt(e){return typeof e!="string"||!e.startsWith(tt)?null:e.slice(tt.length)||null}function da(){if(!se)return!1;const e=An(se);return e||(se=null),e}function J(){const e=Se.map(t=>ue.get(t)).filter(t=>!!t);return[...sa,...e]}function vn(){try{const e=ft();e&&typeof e.rememberScrollPosition=="function"&&e.rememberScrollPosition()}catch(e){console.warn("rememberCurrentPageScroll: konnte Scroll-Position nicht sichern",e)}}function $t(e){const t=J();return!t.length||e<0?0:e>=t.length?t.length-1:e}async function fa(e,t,n,r){const a=J(),i=$t(e);if(i===I){e>I&&da();return}vn();const s=a[I],c=dt(s==null?void 0:s.key);let o=i;if(c){const l=a[i];if((l==null?void 0:l.key)===ke&&ba(c,{suppressRender:!0})){const f=J().findIndex(_=>_.key===ke);o=f>=0?f:0}}if(!ze){ze=!0;try{I=$t(o);const l=I;await wn(t,n,r),_a(l)}catch(l){console.error("navigateToPage: Fehler beim Rendern des Tabs",l)}finally{ze=!1}}}function Ie(e,t,n,r){fa(I+e,t,n,r)}function pa(e,t){if(!e||!t||typeof t.render!="function"){console.error("registerDetailTab: Ungültiger Tab-Descriptor",e,t);return}const n=dt(e);if(n){const a=Me.get(n);a&&a!==e&&Sn(a)}const r={...t,key:e};ue.set(e,r),n&&Me.set(n,e),Se.includes(e)||Se.push(e)}function Sn(e){if(!e)return;const t=ue.get(e);if(t&&typeof t.cleanup=="function")try{t.cleanup({key:e})}catch(a){console.error("unregisterDetailTab: Fehler beim Ausführen von cleanup",a)}ue.delete(e);const n=Se.indexOf(e);n>=0&&Se.splice(n,1);const r=dt(e);r&&Me.get(r)===e&&Me.delete(r)}function ha(e){return ue.has(e)}function Ct(e){return ue.get(e)??null}function ga(e){if(e!=null&&typeof e!="function"){console.error("setSecurityDetailTabFactory: Erwartet Funktion oder null",e);return}nt=e??null}function Pn(e){return`${tt}${e}`}function ft(){const e=window.__ppReaderDashboardElements;if(e instanceof Set){for(const r of e)if(r&&r.isConnected)return r}const t=document.querySelector("pp-reader-dashboard");if(t)return t;const n=document.querySelectorAll("pp-reader-panel");for(const r of n){if(!r||!r.shadowRoot)continue;const a=r.shadowRoot.querySelector("pp-reader-dashboard");if(a)return a}return null}function rt(){const e=ft();if(!e){console.warn("requestDashboardRender: Kein pp-reader-dashboard Element gefunden");return}if(typeof e._renderIfInitialized=="function"){e._renderIfInitialized();return}typeof e._render=="function"&&e._render()}function _a(e){const t=ft();if(t&&typeof t.handleExternalRender=="function")try{t.handleExternalRender(e)}catch(n){console.warn("notifyExternalRender: Fehler beim Synchronisieren des Dashboards",n)}}function An(e){if(!e)return console.error("openSecurityDetail: Ungültige securityUuid",e),!1;const t=Pn(e);let n=Ct(t);if(!n&&typeof nt=="function")try{const i=nt(e);i&&typeof i.render=="function"?(pa(t,i),n=Ct(t)):console.error("openSecurityDetail: Factory lieferte ungültigen Descriptor",i)}catch(i){console.error("openSecurityDetail: Fehler beim Erzeugen des Tab-Descriptors",i)}if(!n)return console.warn(`openSecurityDetail: Kein Detail-Tab für ${e} verfügbar`),!1;vn();let a=J().findIndex(i=>i.key===t);return a===-1&&(a=J().findIndex(s=>s.key===t),a===-1)?(console.error("openSecurityDetail: Tab nach Registrierung nicht auffindbar"),!1):(I=a,se=null,rt(),!0)}function ba(e,t={}){if(!e)return console.error("closeSecurityDetail: Ungültige securityUuid",e),!1;const{suppressRender:n=!1}=t,r=Pn(e);if(!ha(r))return!1;const i=J().findIndex(o=>o.key===r),s=i===I;Sn(r);const c=J();if(!c.length)return I=0,n||rt(),!0;if(se=e,s){const o=c.findIndex(l=>l.key===ke);o>=0?I=o:I=Math.min(Math.max(i-1,0),c.length-1)}else I>=c.length&&(I=Math.max(0,c.length-1));return n||rt(),!0}async function wn(e,t,n){let r=n;if(!r&&(t!=null&&t.panels)){const u=t.panels;r=u.ppreader||u.pp_reader||Object.values(u).find(d=>(d==null?void 0:d.webcomponent_name)==="pp-reader-panel")||null}const a=J();I>=a.length&&(I=Math.max(0,a.length-1));const i=a[I];if(!i||typeof i.render!="function"){console.error("renderTab: Kein gültiger Tab oder keine render-Methode gefunden!");return}let s;try{s=await i.render(e,t,r)}catch(u){console.error("renderTab: Fehler beim Rendern des Tabs:",u),e.innerHTML=`<div class="card"><h2>Fehler</h2><pre>${(u==null?void 0:u.message)||u}</pre></div>`;return}if(!e){console.error("renderTab: Root-Element nicht gefunden!");return}e.innerHTML=s??"",i.render===Yt&&st(e);const o=await new Promise(u=>{const d=window.setInterval(()=>{const f=e.querySelector(".header-card");f&&(clearInterval(d),u(f))},50)});if(!o){console.error("Header-Card nicht gefunden!");return}let l=e.querySelector(`#${et}`);if(!l){l=document.createElement("div"),l.id=et;const u=o.parentNode;u&&"insertBefore"in u&&u.insertBefore(l,o)}va(e,t,n),ya(e,t,n),ma(e)}function ma(e){const t=e.querySelector(".header-card"),n=e,r=e.querySelector(`#${et}`);if(!t||!n||!r){console.error("Fehlende Elemente für das Scrollverhalten: headerCard, scrollBorder oder anchor.");return}de==null||de.disconnect(),de=new IntersectionObserver(([a])=>{a.isIntersecting?t.classList.remove("sticky"):t.classList.add("sticky")},{root:null,rootMargin:"0px 0px 0px 0px",threshold:0}),de.observe(r)}function ya(e,t,n){const r=e.querySelector(".header-card");if(!r){console.error("Header-Card nicht gefunden!");return}oa(r,()=>Ie(1,e,t,n),()=>Ie(-1,e,t,n))}function va(e,t,n){const r=e.querySelector(".header-card");if(!r){console.error("Header-Card nicht gefunden!");return}const a=r.querySelector("#nav-left"),i=r.querySelector("#nav-right");if(!a||!i){console.error("Navigationspfeile nicht gefunden!");return}a.addEventListener("click",()=>{Ie(-1,e,t,n)}),i.addEventListener("click",()=>{Ie(1,e,t,n)}),Sa(r)}function Sa(e){const t=e.querySelector("#nav-left"),n=e.querySelector("#nav-right");if(t&&(I===0?(t.disabled=!0,t.classList.add("disabled")):(t.disabled=!1,t.classList.remove("disabled"))),n){const r=J(),i=!(I===r.length-1)||!!se;n.disabled=!i,n.classList.toggle("disabled",!i)}}class Pa extends HTMLElement{constructor(){super();W(this,"_root");W(this,"_hass",null);W(this,"_panel",null);W(this,"_narrow",null);W(this,"_route",null);W(this,"_lastPanel",null);W(this,"_lastNarrow",null);W(this,"_lastRoute",null);W(this,"_lastPage",null);W(this,"_scrollPositions",{});W(this,"_unsubscribeEvents",null);W(this,"_initialized",!1);W(this,"_hasNewData",!1);W(this,"_pendingUpdates",[]);W(this,"_entryIdWaitWarned",!1);this._root=document.createElement("div"),this._root.className="pp-reader-dashboard",this.appendChild(this._root)}set hass(n){this._hass=n??null,this._checkInitialization()}set panel(n){this._panel!==n&&(this._panel=n??null,this._checkInitialization())}set narrow(n){this._narrow!==(n??null)&&(this._narrow=n??null,this._renderIfInitialized())}set route(n){this._route!==(n??null)&&(this._route=n??null,this._renderIfInitialized())}connectedCallback(){this._checkInitialization()}disconnectedCallback(){this._removeEventListeners()}_checkInitialization(){if(!this._hass||this._initialized)return;if(!this._panel&&this._hass.panels){const r=this._hass.panels;this._panel=r.ppreader||r.pp_reader||Object.values(r).find(a=>(a==null?void 0:a.webcomponent_name)==="pp-reader-panel")||null}const n=ht(this._hass,this._panel);if(!n){this._entryIdWaitWarned||(console.warn("PPReaderDashboard: kein entry_id ermittelbar – warte auf Panel-Konfiguration."),this._entryIdWaitWarned=!0);return}this._entryIdWaitWarned=!1,console.debug("PPReaderDashboard: entry_id (fallback) =",n),this._initialized=!0,this._initializeEventListeners(),this._render()}_initializeEventListeners(){var i;this._removeEventListeners();const n=(i=this._hass)==null?void 0:i.connection;if(!n||typeof n.subscribeEvents!="function"){console.error("PPReaderDashboard: keine valide WebSocket-Verbindung oder subscribeEvents fehlt");return}const r=["panels_updated"],a=[];Promise.all(r.map(s=>n.subscribeEvents(this._handleBusEvent.bind(this),s).then(c=>{typeof c=="function"?(a.push(c),console.debug("PPReaderDashboard: subscribed to",s)):console.error("PPReaderDashboard: subscribeEvents lieferte kein Unsubscribe-Func für",s,c)}).catch(c=>{console.error("PPReaderDashboard: Fehler bei subscribeEvents für",s,c)}))).then(()=>{this._unsubscribeEvents=()=>{a.forEach(s=>{try{s()}catch{}}),console.debug("PPReaderDashboard: alle Event-Subscriptions entfernt")}})}_removeEventListeners(){if(typeof this._unsubscribeEvents=="function")try{this._unsubscribeEvents()}catch(n){console.error("PPReaderDashboard: Fehler beim Entfernen der Event-Listener:",n)}this._unsubscribeEvents=null}_handleBusEvent(n){const r=ht(this._hass,this._panel);if(!r)return;const a=n==null?void 0:n.data;if(!a||!ca(a.data_type)||a.entry_id&&a.entry_id!==r)return;const i=ua(a.data_type,a.data);i&&(this._queueUpdate(i.type,i.data),this._doRender(i.type,i.data))}_doRender(n,r){switch(n){case"accounts":jn(r,this._root);break;case"last_file_update":nr(r,this._root);break;case"portfolio_values":Zn(r,this._root);break;case"portfolio_positions":Qn(r,this._root);break;default:console.warn("PPReaderDashboard: Unbekannter Datentyp:",n);break}}_queueUpdate(n,r){const a=this._cloneData(r),i={type:n,data:a};n==="portfolio_positions"&&(i.portfolioUuid=la(a));let s=-1;n==="portfolio_positions"&&i.portfolioUuid?s=this._pendingUpdates.findIndex(c=>c.type===n&&c.portfolioUuid===i.portfolioUuid):s=this._pendingUpdates.findIndex(c=>c.type===n),s>=0?this._pendingUpdates[s]=i:this._pendingUpdates.push(i),this._hasNewData=!0}_cloneData(n){if(n==null)return n;try{if(typeof structuredClone=="function")return structuredClone(n)}catch(r){console.warn("PPReaderDashboard: structuredClone fehlgeschlagen, falle auf JSON zurück",r)}try{return JSON.parse(JSON.stringify(n))}catch(r){return console.warn("PPReaderDashboard: JSON-Clone fehlgeschlagen, referenziere Originaldaten",r),n}}_reapplyPendingUpdates(){if(!(!Array.isArray(this._pendingUpdates)||this._pendingUpdates.length===0))for(const n of this._pendingUpdates)try{this._doRender(n.type,this._cloneData(n.data))}catch(r){console.error("PPReaderDashboard: Fehler beim erneuten Anwenden eines Updates",n,r)}}_renderIfInitialized(){this._initialized&&this._render()}handleExternalRender(n){this._afterRender(n)}rememberScrollPosition(n=I){if(!this._root)return;const r=Number.isInteger(n)?n:I;r!=null&&(this._scrollPositions[r]=this._root.scrollTop||0)}_render(){if(!this._hass){console.warn("pp-reader-dashboard: noch kein hass, überspringe _render()");return}if(!this._initialized){console.debug("pp-reader-dashboard: _render aufgerufen bevor initialisiert");return}const n=I;if(!this._hasNewData&&this._panel===this._lastPanel&&this._narrow===this._lastNarrow&&this._route===this._lastRoute&&this._lastPage===n)return;this._lastPage!=null&&(this._scrollPositions[this._lastPage]=this._root.scrollTop);const r=wn(this._root,this._hass,this._panel);r&&typeof r.then=="function"?r.then(()=>{this._afterRender(n)}).catch(a=>{console.error("PPReaderDashboard: Fehler beim Rendern des Tabs",a),this._afterRender(n)}):this._afterRender(n)}_afterRender(n){if(!this._root)return;const r=this._scrollPositions[n]||0;this._root.scrollTop=r,this._lastPanel=this._panel,this._lastNarrow=this._narrow,this._lastRoute=this._route,this._lastPage=n;try{this._reapplyPendingUpdates()}catch(a){console.error("PPReaderDashboard: Fehler beim Wiederanlegen der Updates",a)}this._hasNewData=!1}}customElements.get("pp-reader-dashboard")||customElements.define("pp-reader-dashboard",Pa);console.log("PPReader dashboard.js v20250914b geladen");ia({setSecurityDetailTabFactory:ga});
//# sourceMappingURL=dashboard.dJ4vp7Nt.js.map
