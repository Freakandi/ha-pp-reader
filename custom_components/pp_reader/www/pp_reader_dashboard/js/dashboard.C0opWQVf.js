function Ct(e,t,n){let r=null;e.addEventListener("touchstart",i=>{i.touches.length===1&&(r=i.touches[0].clientX)},{passive:!0}),e.addEventListener("touchend",i=>{if(r===null)return;const a=i.changedTouches[0].clientX-r;a<-50?t():a>50&&n(),r=null},{passive:!0}),e.addEventListener("mousedown",i=>{r=i.clientX},{passive:!0}),e.addEventListener("mouseup",i=>{if(r===null)return;const a=i.clientX-r;a<-50?t():a>50&&n(),r=null},{passive:!0})}function C(e,t,n=void 0,r=void 0){let i;const a=c=>{if(typeof c=="number")return c;if(typeof c=="string"&&c.trim()!==""){const l=c.replace(/\s+/g,"").replace(/[^0-9,.-]/g,"").replace(/\.(?=\d{3}(\D|$))/g,"").replace(",","."),u=Number.parseFloat(l);return Number.isNaN(u)?Number.NaN:u}return Number.NaN},o=(c,l=2,u=2)=>{const d=typeof c=="number"?c:a(c);return Number.isFinite(d)?d.toLocaleString("de-DE",{minimumFractionDigits:l,maximumFractionDigits:u}):""},s=(c="")=>{const l=c||"Kein Wert verfügbar";return`<span class="missing-value" role="note" aria-label="${l}" title="${l}">—</span>`};if(["gain_abs","gain_pct"].includes(e)){const c=n!=null&&n.fx_unavailable?"Wechselkurs nicht verfügbar – EUR-Wert unbekannt":"";if(t==null||r&&r.hasValue===!1)return s(c);const l=typeof t=="number"?t:a(t);if(!Number.isFinite(l))return s(c);const u=e==="gain_pct"?"%":"€";i=o(l)+`&nbsp;${u}`;let d="neutral";return l>0?d="positive":l<0&&(d="negative"),`<span class="${d}">${i}</span>`}else if(e==="position_count"){const c=typeof t=="number"?t:a(t);if(!Number.isFinite(c))return s();i=c.toLocaleString("de-DE")}else if(["balance","current_value","purchase_value"].includes(e)){const c=typeof t=="number"?t:a(t);if(!Number.isFinite(c))return n!=null&&n.fx_unavailable?s("Wechselkurs nicht verfügbar – EUR-Wert unbekannt"):(r&&r.hasValue===!1,s());i=o(c)+"&nbsp;€"}else if(e==="current_holdings"){const c=typeof t=="number"?t:a(t);if(!Number.isFinite(c))return s();const l=Math.abs(c%1)>0;i=c.toLocaleString("de-DE",{minimumFractionDigits:l?2:0,maximumFractionDigits:4})}else i=t,typeof i=="string"&&(i.length>60&&(i=i.slice(0,59)+"…"),i.startsWith("Kontostand ")?i=i.substring(11):i.startsWith("Depotwert ")&&(i=i.substring(10)));return i===""||i==null?s():i}function B(e,t,n=[],r={}){const{sortable:i=!1,defaultSort:a={key:"",dir:"asc"}}=r||{},o=f=>f==null?"":String(f).replace(/&/g,"&amp;").replace(/"/g,"&quot;");let s="<table><thead><tr>";t.forEach(f=>{const b=f.align==="right"?' class="align-right"':"";i&&f.key?s+=`<th${b} data-sort-key="${f.key}">${f.label}</th>`:s+=`<th${b}>${f.label}</th>`}),s+="</tr></thead><tbody>",e.forEach(f=>{s+="<tr>",t.forEach(b=>{const g=b.align==="right"?' class="align-right"':"";s+=`<td${g}>${C(b.key,f[b.key],f)}</td>`}),s+="</tr>"});const c={},l={};t.forEach(f=>{if(n.includes(f.key)){let b=0,g=!1;e.forEach(_=>{const p=_[f.key];typeof p=="number"&&Number.isFinite(p)&&(b+=p,g=!0)}),c[f.key]=g?b:null,l[f.key]={hasValue:g}}}),"gain_abs"in c&&("purchase_value"in c&&c.purchase_value>0?c.gain_pct=c.gain_abs/c.purchase_value*100:"current_value"in c&&c.current_value!==0&&(c.gain_pct=c.gain_abs/(c.current_value-c.gain_abs)*100));const u=Number.isFinite(c.gain_pct)?c.gain_pct:null;let d="",h="neutral";if(u!=null&&(d=`${H(u)} %`,u>0?h="positive":u<0&&(h="negative")),s+='<tr class="footer-row">',t.forEach((f,b)=>{const g=f.align==="right"?' class="align-right"':"";if(b===0){s+=`<td${g}>Summe</td>`;return}if(c[f.key]!=null){let p="";f.key==="gain_abs"&&d&&(p=` data-gain-pct="${o(d)}" data-gain-sign="${o(h)}"`),s+=`<td${g}${p}>${C(f.key,c[f.key],void 0,l[f.key])}</td>`;return}if(f.key==="gain_pct"&&c.gain_pct!=null){s+=`<td${g}>${C("gain_pct",c.gain_pct,void 0,l[f.key])}</td>`;return}const _=l[f.key]??{hasValue:!1};s+=`<td${g}>${C(f.key,null,void 0,_)}</td>`}),s+="</tr>",s+="</tbody></table>",i)try{const f=document.createElement("template");f.innerHTML=s.trim();const b=f.content.querySelector("table");if(b)return b.classList.add("sortable-table"),a!=null&&a.key&&(b.dataset.defaultSort=a.key,b.dataset.defaultDir=a.dir==="desc"?"desc":"asc"),b.outerHTML}catch(f){console.warn("makeTable(sortable): Injection fehlgeschlagen:",f)}return s}function Ke(e,t){const n=document.createElement("div");return n.className="header-card",n.innerHTML=`
    <div class="header-content">
      <button id="nav-left" class="nav-arrow" aria-label="Vorherige Seite">
        <svg viewBox="0 0 24 24">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
        </svg>
      </button>
      <h1 id="headerTitle">${e}</h1>
      <button id="nav-right" class="nav-arrow" aria-label="Nächste Seite">
        <svg viewBox="0 0 24 24">
          <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
        </svg>
      </button>
    </div>
    <div id="headerMeta" class="meta">${t}</div>
  `,n}function H(e,t=2,n=2){return(isNaN(e)?0:e).toLocaleString("de-DE",{minimumFractionDigits:t,maximumFractionDigits:n})}function Xe(e){const t=isNaN(e)?0:e;let n="neutral";return t>0?n="positive":t<0&&(n="negative"),`<span class="${n}">${H(t)}&nbsp;€</span>`}function Mt(e){const t=isNaN(e)?0:e;let n="neutral";return t>0?n="positive":t<0&&(n="negative"),`<span class="${n}">${H(t)}&nbsp;%</span>`}function je(e,t,n="asc",r=!1){if(!e)return[];const i=e.querySelector("tbody");if(!i)return[];const a=i.querySelector("tr.footer-row"),o=Array.from(i.querySelectorAll("tr")).filter(u=>u!==a);let s=-1;if(r)s={name:0,current_holdings:1,purchase_value:2,current_value:3,gain_abs:4,gain_pct:5}[t];else{const u=Array.from(e.querySelectorAll("thead th"));for(let d=0;d<u.length;d++)if(u[d].getAttribute("data-sort-key")===t){s=d;break}}if(s==null||s<0)return o;const c=u=>{if(u==null)return NaN;const d=u.replace(/\u00A0/g," ").replace(/[%€]/g,"").replace(/\./g,"").replace(/,/g,".").replace(/[^\d.-]/g,"").trim();if(!d)return NaN;const h=parseFloat(d);return Number.isFinite(h)?h:NaN};o.sort((u,d)=>{var p,y;const h=((p=u.cells[s])==null?void 0:p.textContent.trim())||"",f=((y=d.cells[s])==null?void 0:y.textContent.trim())||"",b=c(h),g=c(f);let _;return!isNaN(b)&&!isNaN(g)&&(h.match(/[0-9]/)||f.match(/[0-9]/))?_=b-g:_=h.localeCompare(f,"de",{sensitivity:"base"}),n==="asc"?_:-_}),o.forEach(u=>i.appendChild(u)),a&&i.appendChild(a),e.querySelectorAll("thead th.sort-active").forEach(u=>{u.classList.remove("sort-active","dir-asc","dir-desc")});const l=e.querySelector(`thead th[data-sort-key="${t}"]`);return l&&l.classList.add("sort-active",n==="asc"?"dir-asc":"dir-desc"),o}function I(e,t){var r,i,a,o,s,c,l,u;let n=(r=t==null?void 0:t.config)==null?void 0:r.entry_id;if(n||(n=t==null?void 0:t.entry_id),n||(n=(o=(a=(i=t==null?void 0:t.config)==null?void 0:i._panel_custom)==null?void 0:a.config)==null?void 0:o.entry_id),!n&&(e!=null&&e.panels)){const d=e.panels.ppreader||e.panels.pp_reader||Object.values(e.panels).find(h=>(h==null?void 0:h.webcomponent_name)==="pp-reader-panel");n=((s=d==null?void 0:d.config)==null?void 0:s.entry_id)||((u=(l=(c=d==null?void 0:d.config)==null?void 0:c._panel_custom)==null?void 0:l.config)==null?void 0:u.entry_id)}return n}function Le(e,t){return I(e,t)}async function kt(e,t){const n=I(e,t);if(!e||!n)throw new Error(`fetchAccountsWS: fehlendes hass oder entry_id (${n})`);return await e.connection.sendMessagePromise({type:"pp_reader/get_accounts",entry_id:n})}async function Ht(e,t){const n=I(e,t);if(!e||!n)throw new Error(`fetchLastFileUpdateWS: fehlendes hass oder entry_id (${n})`);const r=await e.connection.sendMessagePromise({type:"pp_reader/get_last_file_update",entry_id:n});return(r==null?void 0:r.last_file_update)||r||""}async function qt(e,t){const n=I(e,t);if(!e||!n)throw new Error(`fetchPortfoliosWS: fehlendes hass oder entry_id (${n})`);return await e.connection.sendMessagePromise({type:"pp_reader/get_portfolio_data",entry_id:n})}async function Ze(e,t,n){const r=I(e,t);if(!e||!r)throw new Error(`fetchPortfolioPositionsWS: fehlendes hass oder entry_id (${r})`);if(!n)throw new Error("fetchPortfolioPositionsWS: fehlendes portfolio_uuid");return await e.connection.sendMessagePromise({type:"pp_reader/get_portfolio_positions",entry_id:r,portfolio_uuid:n})}async function It(e,t,n){const r=I(e,t);if(!e||!r)throw new Error(`fetchSecuritySnapshotWS: fehlendes hass oder entry_id (${r})`);if(!n)throw new Error("fetchSecuritySnapshotWS: fehlendes securityUuid");return await e.connection.sendMessagePromise({type:"pp_reader/get_security_snapshot",entry_id:r,security_uuid:n})}async function Je(e,t,n,r={}){const i=I(e,t);if(!e||!i)throw new Error(`fetchSecurityHistoryWS: fehlendes hass oder entry_id (${i})`);if(!n)throw new Error("fetchSecurityHistoryWS: fehlendes securityUuid");const a={type:"pp_reader/get_security_history",entry_id:i,security_uuid:n},{startDate:o,endDate:s,start_date:c,end_date:l}=r||{},u=o??c;u!=null&&(a.start_date=u);const d=s??l;return d!=null&&(a.end_date=d),await e.connection.sendMessagePromise(a)}const Wt=500,Gt=10,Ut="pp-reader:portfolio-positions-updated";function pe(){return window.__ppReaderPendingPositions||(window.__ppReaderPendingPositions=new Map),window.__ppReaderPendingPositions}function Vt(){return window.__ppReaderPendingRetryMeta||(window.__ppReaderPendingRetryMeta=new Map),window.__ppReaderPendingRetryMeta}function Bt(e,t){return`<div class="error">${typeof e=="string"?e:String(e||"Unbekannter Fehler")} <button class="retry-pos" data-portfolio="${t}">Erneut laden</button></div>`}function zt(e,t,n){const r=e.querySelector("table.sortable-positions");if(!r)return;const i=e.dataset.sortKey||r.dataset.defaultSort||"name",a=e.dataset.sortDir||r.dataset.defaultDir||"asc";e.dataset.sortKey=i,e.dataset.sortDir=a;try{je(r,i,a,!0)}catch(o){console.warn("restoreSortAndInit: sortTableRows Fehler:",o)}try{window.__ppReaderAttachPortfolioPositionsSorting&&window.__ppReaderAttachPortfolioPositionsSorting(t,n)}catch(o){console.warn("restoreSortAndInit: attachPortfolioPositionsSorting Fehler:",o)}try{window.__ppReaderAttachSecurityDetailListener&&window.__ppReaderAttachSecurityDetailListener(t,n)}catch(o){console.warn("restoreSortAndInit: attachSecurityDetailListener Fehler:",o)}}function Qe(e,t,n,r){if(!e||!t)return{applied:!1,reason:"invalid"};const i=e.querySelector(`.portfolio-table .portfolio-details[data-portfolio="${t}"]`);if(!i)return{applied:!1,reason:"missing"};const a=i.querySelector(".positions-container");if(!a)return{applied:!1,reason:"missing"};if(i.classList.contains("hidden"))return{applied:!1,reason:"hidden"};if(r)return a.innerHTML=Bt(r,t),{applied:!0};const o=a.dataset.sortKey,s=a.dataset.sortDir;return a.innerHTML=Zt(n||[]),o&&(a.dataset.sortKey=o),s&&(a.dataset.sortDir=s),zt(a,e,t),{applied:!0}}function ge(e,t){const n=pe(),r=n.get(t);if(!r)return!1;const i=Qe(e,t,r.positions,r.error);return i.applied&&n.delete(t),i.applied}function et(e){const t=pe();let n=!1;for(const[r]of t)ge(e,r)&&(n=!0);return n}function tt(e,t){const n=Vt(),r=n.get(t)||{attempts:0,timer:null};r.timer||(r.timer=setTimeout(()=>{r.timer=null,r.attempts+=1;const i=ge(e,t);i||r.attempts>=Gt?(n.delete(t),i||pe().delete(t)):tt(e,t)},Wt),n.set(t,r))}function Ot(e,t){console.log("updateConfigsWS: Kontodaten-Update erhalten:",e);const n=e||[];Yt(n,t);const r=t.querySelector(".portfolio-table table"),i=r?Array.from(r.querySelectorAll("tbody tr:not(.footer-row)")).map(a=>{const o=a.cells[2];return{current_value:parseFloat(((o==null?void 0:o.textContent)||"").replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""))||0}}):[];we(n,i,t)}function Yt(e,t){const n=t.querySelector(".account-table"),r=t.querySelector(".fx-account-table"),i=e.filter(o=>(o.currency_code||"EUR")==="EUR"),a=e.filter(o=>(o.currency_code||"EUR")!=="EUR");n?n.innerHTML=B(i,[{key:"name",label:"Name"},{key:"balance",label:"Kontostand (EUR)",align:"right"}],["balance"]):console.warn("updateAccountTable: .account-table nicht gefunden."),r?r.innerHTML=B(a.map(o=>({...o,fx_display:`${(o.orig_balance??0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})} ${o.currency_code}`})),[{key:"name",label:"Name"},{key:"fx_display",label:"Betrag (FX)"},{key:"balance",label:"EUR",align:"right"}],["balance"]):a.length&&console.warn("updateAccountTable: .fx-account-table nicht gefunden, obwohl FX-Konten vorhanden sind.")}function Kt(e,t){var c;if(!Array.isArray(e)){console.warn("handlePortfolioUpdate: Update ist kein Array:",e);return}try{console.debug("handlePortfolioUpdate: payload=",e)}catch{}const n=(t==null?void 0:t.querySelector(".portfolio-table table"))||(t==null?void 0:t.querySelector("table.expandable-portfolio-table"));if(!n){!(t==null?void 0:t.querySelector(".portfolio-table"))&&((t==null?void 0:t.querySelector(".security-range-selector"))||(t==null?void 0:t.querySelector(".security-detail-placeholder")))?console.debug("handlePortfolioUpdate: Übersicht nicht aktiv – Update wird später angewendet."):console.warn("handlePortfolioUpdate: Keine Portfolio-Tabelle gefunden.");return}const r=(c=n.tBodies)==null?void 0:c[0];if(!r){console.warn("handlePortfolioUpdate: Kein <tbody> in Tabelle.");return}const i=l=>{if(window.Intl)try{return new Intl.NumberFormat(navigator.language||"de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(l)}catch{}return(Math.round(l*100)/100).toFixed(2).replace(".",",")},a=new Map(Array.from(r.querySelectorAll("tr.portfolio-row")).filter(l=>l.dataset&&l.dataset.portfolio).map(l=>[l.dataset.portfolio,l]));let o=0;const s=l=>{const u=Number.isFinite(l)?l:0;try{return u.toLocaleString("de-DE")}catch{return u.toString()}};for(const l of e){if(!l||!l.uuid)continue;const u=a.get(l.uuid);if(!u||u.cells.length<3)continue;const d=u.cells[1],h=u.cells[2],f=u.cells[3],b=u.cells[4],g=Number(l.position_count??l.count??0),_=Number(l.current_value??l.value??0),p=Number(l.purchase_sum??l.purchaseSum??0),y=_-p,m=p>0?y/p*100:0,S=q(h.textContent);q(d.textContent)!==g&&(d.textContent=s(g)),Math.abs(S-_)>=.005&&(h.textContent=i(_)+" €",u.classList.add("flash-update"),setTimeout(()=>u.classList.remove("flash-update"),800)),f&&(f.innerHTML=nt(y),f.dataset.gainPct=Number.isFinite(m)?`${i(m)} %`:"—",f.dataset.gainSign=Number.isFinite(m)?m>0?"positive":m<0?"negative":"neutral":"neutral"),b&&(b.innerHTML=rt(m)),u.dataset.positionCount=String(g),u.dataset.currentValue=String(_),u.dataset.purchaseSum=String(p),u.dataset.gainAbs=String(y),u.dataset.gainPct=String(m),o++}console.debug(o===0?"handlePortfolioUpdate: Keine passenden Zeilen gefunden / keine Änderungen.":`handlePortfolioUpdate: ${o} Zeile(n) gepatcht.`);try{Jt(n)}catch(l){console.warn("handlePortfolioUpdate: Fehler bei Summen-Neuberechnung:",l)}try{const l=(...g)=>{for(const _ of g){if(!_)continue;const p=t==null?void 0:t.querySelector(_);if(p)return p}return null},u=l(".account-table table",".accounts-eur-table table",".accounts-table table"),d=l(".fx-account-table table",".accounts-fx-table table"),h=(g,_)=>{if(!g)return[];const p=g.querySelectorAll("tbody tr.account-row");return(p.length?Array.from(p):Array.from(g.querySelectorAll("tbody tr:not(.footer-row)"))).map(m=>{const S=_?m.cells[2]:m.cells[1];return{balance:q(S==null?void 0:S.textContent)}})},f=[...h(u,!1),...h(d,!0)],b=Array.from(n.querySelectorAll("tbody tr.portfolio-row")).map(g=>{var m,S;const _=q((m=g.cells[2])==null?void 0:m.textContent),p=q((S=g.cells[3])==null?void 0:S.textContent),y=_-p;return{current_value:_,purchase_sum:y}});typeof we=="function"&&we(f,b,t)}catch(l){console.warn("handlePortfolioUpdate: Fehler bei Total-Neuberechnung:",l)}}function Xt(e){if(!e||typeof e!="object")return null;const t=e.portfolio_uuid;if(typeof t=="string"&&t)return t;const n=e.portfolioUuid;return typeof n=="string"&&n?n:null}function $e(e,t){const n=Xt(e);if(!n)return console.warn("handlePortfolioPositionsUpdate: Ungültiges Update:",e),!1;const r=e==null?void 0:e.error,i=Array.isArray(e==null?void 0:e.positions)?e.positions:[];try{const s=window.__ppReaderPortfolioPositionsCache;s&&typeof s.set=="function"&&!r&&s.set(n,i)}catch(s){console.warn("handlePortfolioPositionsUpdate: Positions-Cache konnte nicht aktualisiert werden:",s)}const a=Qe(t,n,i,r),o=pe();if(a.applied?o.delete(n):(o.set(n,{positions:i,error:r}),a.reason!=="hidden"&&tt(t,n)),!r&&i.length>0){const s=Array.from(new Set(i.map(c=>c==null?void 0:c.security_uuid).filter(c=>typeof c=="string"&&c.length>0)));if(s.length&&typeof window<"u")try{window.dispatchEvent(new CustomEvent(Ut,{detail:{portfolioUuid:n,securityUuids:s}}))}catch(c){console.warn("handlePortfolioPositionsUpdate: Dispatch des Portfolio-Events fehlgeschlagen",c)}}return!0}function jt(e,t){if(Array.isArray(e)){let n=!1;for(const r of e)$e(r,t)&&(n=!0);!n&&e.length&&console.warn("handlePortfolioPositionsUpdate: Kein gültiges Element im Array:",e);return}$e(e,t)}function Zt(e){try{if(window.__ppReaderRenderPositionsTable)return window.__ppReaderRenderPositionsTable(e)}catch{}if(!e||!e.length)return'<div class="no-positions">Keine Positionen vorhanden.</div>';const t=e.map(r=>({name:r.name,current_holdings:r.current_holdings,purchase_value:r.purchase_value,current_value:r.current_value,gain_abs:r.gain_abs,gain_pct:r.gain_pct})),n=B(t,[{key:"name",label:"Wertpapier"},{key:"current_holdings",label:"Bestand",align:"right"},{key:"purchase_value",label:"Kaufwert",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"+/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}],["purchase_value","current_value","gain_abs"]);try{const r=document.createElement("template");r.innerHTML=n.trim();const i=r.content.querySelector("table");if(i){i.classList.add("sortable-positions");const a=i.querySelectorAll("thead th"),o=["name","current_holdings","purchase_value","current_value","gain_abs","gain_pct"];if(a.forEach((c,l)=>{const u=o[l];u&&(c.setAttribute("data-sort-key",u),c.classList.add("sortable-col"))}),i.querySelectorAll("tbody tr").forEach((c,l)=>{if(c.classList.contains("footer-row"))return;const u=e[l];u!=null&&u.security_uuid&&(c.dataset.security=u.security_uuid),c.classList.add("position-row")}),i.dataset.defaultSort="name",i.dataset.defaultDir="asc",window.__ppReaderApplyGainPctMetadata)try{window.__ppReaderApplyGainPctMetadata(i)}catch(c){console.warn("renderPositionsTableInline: applyGainPctMetadata failed",c)}else i.querySelectorAll("tbody tr").forEach(l=>{var b,g;const u=(b=l.cells)==null?void 0:b[4],d=(g=l.cells)==null?void 0:g[5];if(!u||!d)return;const h=(d.textContent||"").trim()||"—";let f="neutral";d.querySelector(".positive")?f="positive":d.querySelector(".negative")&&(f="negative"),u.dataset.gainPct=h,u.dataset.gainSign=f});return i.outerHTML}}catch(r){console.warn("renderPositionsTableInline: Sortier-Metadaten Injection fehlgeschlagen:",r)}return n}window.__ppReaderFlushPendingPositions||(window.__ppReaderFlushPendingPositions=(e,t)=>ge(e,t));window.__ppReaderFlushAllPendingPositions||(window.__ppReaderFlushAllPendingPositions=e=>et(e));function Jt(e){var u,d;if(!e)return;try{const h=window.__ppReaderUpdatePortfolioFooter;if(typeof h=="function"){h(e);return}}catch(h){console.warn("updatePortfolioFooter: global Helper schlug fehl:",h)}const t=Array.from(e.querySelectorAll("tbody tr.portfolio-row"));let n=0,r=0,i=0,a=0;t.forEach(h=>{var P,F,v,A,E,L,N;const f=Number((P=h.dataset)==null?void 0:P.positionCount),b=Number.isFinite(f)?f:parseInt((((F=h.cells[1])==null?void 0:F.textContent)||"").replace(/\./g,""),10)||0,g=Number((v=h.dataset)==null?void 0:v.currentValue),_=Number.isFinite(g)?g:q((A=h.cells[2])==null?void 0:A.textContent),p=Number((E=h.dataset)==null?void 0:E.gainAbs),y=Number.isFinite(p)?p:q((L=h.cells[3])==null?void 0:L.textContent),m=Number((N=h.dataset)==null?void 0:N.purchaseSum),S=Number.isFinite(m)?m:_-y;a+=b,n+=_,r+=y,i+=S}),i<=0&&(i=n-r);const o=i>0?r/i*100:0;let s=e.querySelector("tr.footer-row");s||(s=document.createElement("tr"),s.className="footer-row",(u=e.querySelector("tbody"))==null||u.appendChild(s));const c=Math.round(a).toLocaleString("de-DE");s.innerHTML=`
    <td>Summe</td>
    <td class="align-right">${c}</td>
    <td class="align-right">${z(n)}&nbsp;€</td>
    <td class="align-right">${nt(r)}</td>
    <td class="align-right">${rt(o)}</td>
  `;const l=(d=s.cells)==null?void 0:d[3];l&&(l.dataset.gainPct=Number.isFinite(o)?`${z(o)} %`:"—",l.dataset.gainSign=Number.isFinite(o)?o>0?"positive":o<0?"negative":"neutral":"neutral"),s.dataset.positionCount=String(Math.round(a)),s.dataset.currentValue=String(n),s.dataset.purchaseSum=String(i),s.dataset.gainAbs=String(r),s.dataset.gainPct=String(o)}function z(e){return(isNaN(e)?0:e).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}function nt(e){return`<span class="${e>=0?"positive":"negative"}">${z(e)}&nbsp;€</span>`}function rt(e){return`<span class="${e>=0?"positive":"negative"}">${z(e)}&nbsp;%</span>`}function we(e,t,n){const r=n||document,i=(Array.isArray(e)?e:[]).reduce((l,u)=>{const d=u!=null&&typeof u=="object"?u.balance??u.current_value??u.value??0:u,h=Number(d);return l+(Number.isFinite(h)?h:0)},0),a=(Array.isArray(t)?t:[]).reduce((l,u)=>{const d=u!=null&&typeof u=="object"?u.current_value??u.value??0:u,h=Number(d);return l+(Number.isFinite(h)?h:0)},0),o=i+a,s=r==null?void 0:r.querySelector("#headerMeta");if(!s){console.warn("updateTotalWealth: #headerMeta nicht gefunden.");return}const c=s.querySelector("strong")||s.querySelector(".total-wealth-value");c?c.textContent=`${z(o)} €`:s.textContent=`💰 Gesamtvermögen: ${z(o)} €`,s.dataset.totalWealthEur=String(o)}function Qt(e,t){const n=typeof e=="string"?e:e&&e.last_file_update||"";if(!t){console.warn("handleLastFileUpdate: root fehlt");return}let r=t.querySelector(".footer-card .last-file-update")||t.querySelector(".last-file-update");if(!r){const i=t.querySelector(".footer-card .meta")||t.querySelector("#headerMeta")||t.querySelector(".header-card .meta")||t.querySelector(".header-card");if(!i){console.warn("handleLastFileUpdate: Kein Einfügepunkt gefunden.");return}r=document.createElement("div"),r.className="last-file-update",i.appendChild(r)}r.closest(".footer-card")?r.innerHTML=n?`📂 Letzte Aktualisierung der Datei: <strong>${n}</strong>`:"📂 Letzte Aktualisierung der Datei: <strong>Unbekannt</strong>":r.textContent=n?`📂 Letzte Aktualisierung: ${n}`:"📂 Letzte Aktualisierung: Unbekannt"}function en(e){if(!e)return;const t=e.querySelector("table.sortable-positions");if(!t)return;const n=e.dataset.sortKey||t.dataset.defaultSort||"name",r=e.dataset.sortDir||t.dataset.defaultDir||"asc";e.dataset.sortKey=n,e.dataset.sortDir=r,je(t,n,r,!0)}window.__ppReaderReapplyPositionsSort=en;function q(e){return e==null?0:parseFloat(String(e).replace(/\u00A0/g," ").replace(/[€%]/g,"").replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""))||0}let ce=null,le=null;const T=new Map,Te=1e6;function Y(e){const t=Number(e);return Number.isFinite(t)?t:0}function ee(e){const t=Y(e);return Math.round(t*100)/100}function tn(e){const t=Y(e);return Math.round(t*Te)/Te}function it(e){if(!e)return[];const t=[];for(const n of T.values())if(!(!Array.isArray(n)||n.length===0))for(const r of n)r&&r.security_uuid===e&&t.push(r);return t}function at(e){const t=it(e);return t.length?t.map(n=>({...n})):[]}function st(e){const t=it(e);if(!t.length)return null;let n="",r=0,i=0,a=0;for(const l of t)!n&&(l!=null&&l.name)&&(n=l.name),r+=Y(l==null?void 0:l.current_holdings),i+=Y(l==null?void 0:l.purchase_value),a+=Y(l==null?void 0:l.current_value);const o=a-i,s=i>0?o/i*100:0,c=r>0?a/r:null;return{security_uuid:e,name:n,total_holdings:tn(r),purchase_value_eur:ee(i),current_value_eur:ee(a),gain_abs_eur:ee(o),gain_pct:Math.round(s*100)/100,last_price_eur:c!=null?ee(c):null,source:"cache"}}T.getSecuritySnapshot=st;T.getSecurityPositions=at;window.__ppReaderPortfolioPositionsCache=T;window.__ppReaderGetSecuritySnapshotFromCache||(window.__ppReaderGetSecuritySnapshotFromCache=st);window.__ppReaderGetSecurityPositionsFromCache||(window.__ppReaderGetSecurityPositionsFromCache=at);const ue=new Set;function ot(e){if(!e)return;e.querySelectorAll("tbody tr").forEach(n=>{var s,c;const r=(s=n.cells)==null?void 0:s[4],i=(c=n.cells)==null?void 0:c[5];if(!r||!i)return;const a=(i.textContent||"").trim()||"—";let o="neutral";i.querySelector(".positive")?o="positive":i.querySelector(".negative")&&(o="negative"),r.dataset.gainPct=a,r.dataset.gainSign=o})}window.__ppReaderApplyGainPctMetadata||(window.__ppReaderApplyGainPctMetadata=e=>ot(e));function X(e){if(!e||!e.length)return'<div class="no-positions">Keine Positionen vorhanden.</div>';const t=[{key:"name",label:"Wertpapier"},{key:"current_holdings",label:"Bestand",align:"right"},{key:"purchase_value",label:"Kaufwert",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"+/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}],n=e.map(i=>({name:i.name,current_holdings:i.current_holdings,purchase_value:i.purchase_value,current_value:i.current_value,gain_abs:i.gain_abs,gain_pct:i.gain_pct})),r=B(n,t,["purchase_value","current_value","gain_abs"]);try{const i=document.createElement("template");i.innerHTML=r.trim();const a=i.content.querySelector("table");if(a){a.classList.add("sortable-positions");const o=a.querySelectorAll("thead th");return t.forEach((c,l)=>{const u=o[l];u&&(u.setAttribute("data-sort-key",c.key),u.classList.add("sortable-col"))}),a.querySelectorAll("tbody tr").forEach((c,l)=>{if(c.classList.contains("footer-row"))return;const u=e[l];u&&(u.security_uuid&&(c.dataset.security=u.security_uuid),c.classList.add("position-row"))}),a.dataset.defaultSort="name",a.dataset.defaultDir="asc",ot(a),a.outerHTML}}catch(i){console.warn("renderPositionsTable: Konnte Sortier-Metadaten nicht injizieren:",i)}return r}window.__ppReaderRenderPositionsTable=X;function nn(e,t){if(!e||!t)return;const n=e.querySelector(`.portfolio-details[data-portfolio="${t}"]`);if(!n)return;const r=n.querySelector(".positions-container");!r||r.__ppReaderSecurityClickBound||(r.__ppReaderSecurityClickBound=!0,r.addEventListener("click",i=>{const a=i.target.closest("button, a");if(a&&r.contains(a))return;const o=i.target.closest("tr[data-security]");if(!o||!r.contains(o))return;const s=o.getAttribute("data-security");if(s)try{$t(s)||console.warn("attachSecurityDetailDelegation: Detail-Tab konnte nicht geöffnet werden für",s)}catch(c){console.error("attachSecurityDetailDelegation: Fehler beim Öffnen des Detail-Tabs",c)}}))}function j(e,t){nn(e,t)}window.__ppReaderAttachSecurityDetailListener||(window.__ppReaderAttachSecurityDetailListener=j);function ct(e){console.debug("buildExpandablePortfolioTable: render",e.length,"portfolios");const t=p=>p==null?"":String(p).replace(/&/g,"&amp;").replace(/"/g,"&quot;");let n='<table class="expandable-portfolio-table"><thead><tr>';[{key:"name",label:"Name"},{key:"position_count",label:"Anzahl Positionen",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"Gesamt +/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}].forEach(p=>{const y=p.align==="right"?' class="align-right"':"";n+=`<th${y}>${p.label}</th>`}),n+="</tr></thead><tbody>",e.forEach(p=>{if(!p||!p.uuid)return;const y=Number.isFinite(p.position_count)?p.position_count:0,m=Number.isFinite(p.purchase_sum)?p.purchase_sum:0,S=p.hasValue!==!1,P=S&&Number.isFinite(p.current_value)?p.current_value:null,F=S&&Number.isFinite(p.gain_abs)?p.gain_abs:S&&Number.isFinite(p.current_value)?p.current_value-m:null,v=S&&Number.isFinite(p.gain_pct)?p.gain_pct:S&&m>0&&Number.isFinite(P)?(P-m)/m*100:null,A=ue.has(p.uuid),E=A?"portfolio-toggle expanded":"portfolio-toggle",L=`portfolio-details-${p.uuid}`,N={fx_unavailable:!S,current_value:P,gain_abs:F,gain_pct:v},w={hasValue:S},D=C("current_value",N.current_value,N,w),$=C("gain_abs",N.gain_abs,N,w),k=C("gain_pct",N.gain_pct,N,w),R=S&&Number.isFinite(v)?`${H(v)} %`:"",be=S&&Number.isFinite(v)?v>0?"positive":v<0?"negative":"neutral":"",Q=S&&Number.isFinite(P)?P:"",me=S&&Number.isFinite(F)?F:"",Rt=S&&Number.isFinite(v)?v:"";let De="";R&&(De=` data-gain-pct="${t(R)}" data-gain-sign="${t(be)}"`),n+=`<tr class="portfolio-row"
                data-portfolio="${p.uuid}"
                data-position-count="${y}"
                data-current-value="${t(Q)}"
                data-purchase-sum="${t(m)}"
                data-gain-abs="${t(me)}"
                data-gain-pct="${t(Rt)}"
                data-has-value="${S?"true":"false"}">`,n+=`<td>
        <button type="button"
                class="${E}"
                data-portfolio="${p.uuid}"
                aria-expanded="${A?"true":"false"}"
                aria-controls="${L}">
          <span class="caret">${A?"▼":"▶"}</span>
          <span class="portfolio-name">${p.name}</span>
        </button>
      </td>`,n+=`<td class="align-right">${y}</td>`,n+=`<td class="align-right">${D}</td>`,n+=`<td class="align-right"${De}>${$}</td>`,n+=`<td class="align-right gain-pct-cell">${k}</td>`,n+="</tr>",n+=`<tr class="portfolio-details${A?"":" hidden"}"
                data-portfolio="${p.uuid}"
                id="${L}"
                role="region"
                aria-label="Positionen für ${p.name}">
      <td colspan="5">
        <div class="positions-container">${A?T.has(p.uuid)?X(T.get(p.uuid)):'<div class="loading">Lade Positionen...</div>':""}</div>
      </td>
    </tr>`});const i=e.filter(p=>p&&p.hasValue!==!1),a=e.reduce((p,y)=>p+(Number.isFinite(y==null?void 0:y.position_count)?y.position_count:0),0),o=i.reduce((p,y)=>p+(Number.isFinite(y.current_value)?y.current_value:0),0),s=i.reduce((p,y)=>p+(Number.isFinite(y.purchase_sum)?y.purchase_sum:0),0),c=i.reduce((p,y)=>{const m=Number.isFinite(y.current_value)?y.current_value:0,S=Number.isFinite(y.purchase_sum)?y.purchase_sum:0;return p+(m-S)},0),l=i.length===e.length,u=l&&s>0?c/s*100:null,d={fx_unavailable:!l,current_value:l?o:null,gain_abs:l?c:null,gain_pct:l?u:null},h={hasValue:l},f=C("current_value",d.current_value,d,h),b=C("gain_abs",d.gain_abs,d,h),g=C("gain_pct",d.gain_pct,d,h);let _="";if(l&&Number.isFinite(u)){const p=`${H(u)} %`,y=u>0?"positive":u<0?"negative":"neutral";_=` data-gain-pct="${t(p)}" data-gain-sign="${t(y)}"`}return n+=`<tr class="footer-row"
    data-position-count="${a}"
    data-current-value="${t(l?o:"")}"
    data-purchase-sum="${t(l?s:"")}"
    data-gain-abs="${t(l?c:"")}"
    data-gain-pct="${t(l&&Number.isFinite(u)?u:"")}"
    data-has-value="${l?"true":"false"}">
    <td>Summe</td>
    <td class="align-right">${Math.round(a).toLocaleString("de-DE")}</td>
    <td class="align-right">${f}</td>
    <td class="align-right"${_}>${b}</td>
    <td class="align-right gain-pct-cell">${g}</td>
  </tr>`,n+="</tbody></table>",n}function rn(e){return e instanceof HTMLTableElement?e:e&&typeof e.querySelector=="function"?e.querySelector("table.expandable-portfolio-table")||e.querySelector(".portfolio-table table")||e.querySelector("table"):document.querySelector(".portfolio-table table.expandable-portfolio-table")||document.querySelector(".portfolio-table table")}function te(e){if(e===void 0)return null;const t=Number(e);return Number.isFinite(t)?t:null}function ye(e){if(!e)return 0;const t=e.textContent||"";if(!t)return 0;const n=t.replace(/[^0-9,.-]/g,"").replace(/\./g,"").replace(",","."),r=Number.parseFloat(n);return Number.isFinite(r)?r:0}function lt(e){var y;const t=rn(e);if(!t)return;const n=(y=t.tBodies)==null?void 0:y[0];if(!n)return;const r=Array.from(n.querySelectorAll("tr.portfolio-row"));if(!r.length)return;let i=0,a=0,o=0,s=0,c=0;for(const m of r){const S=m.dataset.hasValue,P=!(S==="false"||S==="0"||S===""||S==null),F=te(m.dataset.positionCount)??ye(m.cells[1]);if(i+=F,!P){c+=1;continue}const v=te(m.dataset.currentValue)??ye(m.cells[2]),A=te(m.dataset.gainAbs)??ye(m.cells[3]),E=te(m.dataset.purchaseSum),L=E??v-A;a+=v,s+=A,o+=L}const l=c===0;!l&&o>0&&(o=a-s),l&&o<=0&&(o=a-s);const u=l&&o>0?s/o*100:null;let d=Array.from(n.children).find(m=>m instanceof HTMLTableRowElement&&m.classList.contains("footer-row"));d||(d=document.createElement("tr"),d.classList.add("footer-row"),n.appendChild(d));const h=Math.round(i).toLocaleString("de-DE"),f=(m="Wert nicht verfügbar")=>`<span class="missing-value" role="note" aria-label="${m}" title="${m}">—</span>`,b="Teilweise fehlende Wechselkurse – Wert unbekannt",g=l?`${H(a)}&nbsp;€`:f(b),_=l?Xe(s):f(b),p=l&&u!=null?Mt(u):f(b);d.innerHTML=`
    <td>Summe</td>
    <td class="align-right">${h}</td>
    <td class="align-right">${g}</td>
    <td class="align-right">${_}</td>
    <td class="align-right">${p}</td>
  `,d.dataset.positionCount=String(Math.round(i)),d.dataset.currentValue=l?String(a):"",d.dataset.purchaseSum=l?String(o):"",d.dataset.gainAbs=l?String(s):"",d.dataset.gainPct=l&&u!=null?String(u):"",d.dataset.hasValue=l?"true":"false"}window.__ppReaderUpdatePortfolioFooter=lt;function Z(e,t){if(!e||!t)return;const n=e.querySelector(`.portfolio-details[data-portfolio="${t}"]`);if(!n)return;const r=n.querySelector(".positions-container");if(!r)return;const i=r.querySelector("table.sortable-positions");if(!i||i.__ppReaderSortingBound)return;i.__ppReaderSortingBound=!0;const a=(c,l)=>{const u=i.querySelector("tbody");if(!u)return;const d=Array.from(u.querySelectorAll("tr")).filter(g=>!g.classList.contains("footer-row")),h=u.querySelector("tr.footer-row"),f=g=>g==null?0:parseFloat(g.replace(/\u00A0/g," ").replace(/[%€]/g,"").replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""))||0;d.sort((g,_)=>{var F,v;const y={name:0,current_holdings:1,purchase_value:2,current_value:3,gain_abs:4,gain_pct:5}[c];if(y==null)return 0;const m=((F=g.cells[y])==null?void 0:F.textContent.trim())||"",S=((v=_.cells[y])==null?void 0:v.textContent.trim())||"";let P;return c==="name"?P=m.localeCompare(S,"de",{sensitivity:"base"}):P=f(m)-f(S),l==="asc"?P:-P}),i.querySelectorAll("thead th.sort-active").forEach(g=>{g.classList.remove("sort-active","dir-asc","dir-desc")});const b=i.querySelector(`thead th[data-sort-key="${c}"]`);b&&b.classList.add("sort-active",l==="asc"?"dir-asc":"dir-desc"),d.forEach(g=>u.appendChild(g)),h&&u.appendChild(h)},o=r.dataset.sortKey||i.dataset.defaultSort||"name",s=r.dataset.sortDir||i.dataset.defaultDir||"asc";a(o,s),i.addEventListener("click",c=>{const l=c.target.closest("th[data-sort-key]");if(!l||!i.contains(l))return;const u=l.getAttribute("data-sort-key");if(!u)return;let d="asc";r.dataset.sortKey===u&&(d=r.dataset.sortDir==="asc"?"desc":"asc"),r.dataset.sortKey=u,r.dataset.sortDir=d,a(u,d)})}window.__ppReaderAttachPortfolioPositionsSorting||(window.__ppReaderAttachPortfolioPositionsSorting=Z);async function an(e,t,n){if(!e||!ce||!le)return;const r=t||(n==null?void 0:n.querySelector(`.portfolio-details[data-portfolio="${e}"] .positions-container`));if(!r)return;const i=r.closest(".portfolio-details");if(!(i&&i.classList.contains("hidden"))){r.innerHTML='<div class="loading">Neu laden...</div>';try{const a=await Ze(ce,le,e);if(a.error){r.innerHTML=`<div class="error">${a.error} <button class="retry-pos" data-portfolio="${e}">Erneut laden</button></div>`;return}const o=a.positions||[];T.set(e,o),r.innerHTML=X(o);try{Z(n,e)}catch(s){console.warn("attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:",s)}try{j(n,e)}catch(s){console.warn("reloadPortfolioPositions: Security-Listener konnte nicht gebunden werden:",s)}}catch(a){r.innerHTML=`<div class="error">Fehler: ${a.message} <button class="retry-pos" data-portfolio="${e}">Retry</button></div>`}}}async function sn(e,t,n=3e3,r=50){const i=performance.now();return new Promise(a=>{const o=()=>{const s=e.querySelector(t);if(s)return a(s);if(performance.now()-i>n)return a(null);setTimeout(o,r)};o()})}function xe(e){if(!e)return;const t=(e.__ppReaderAttachToken??0)+1;e.__ppReaderAttachToken=t,e.__ppReaderAttachInProgress=!0,(async()=>{try{const n=await sn(e,".portfolio-table");if(t!==e.__ppReaderAttachToken)return;if(!n){console.warn("attachPortfolioToggleHandler: .portfolio-table nicht gefunden (Timeout)");return}if(n.querySelectorAll(".portfolio-toggle").length===0&&console.debug("attachPortfolioToggleHandler: Noch keine Buttons – evtl. Recovery später"),n.__ppReaderPortfolioToggleBound)return;n.__ppReaderPortfolioToggleBound=!0,console.debug("attachPortfolioToggleHandler: Listener registriert"),n.addEventListener("click",async i=>{try{const a=i.target.closest(".retry-pos");if(a&&n.contains(a)){const d=a.getAttribute("data-portfolio"),h=e.querySelector(`.portfolio-details[data-portfolio="${d}"]`),f=h==null?void 0:h.querySelector(".positions-container");await an(d,f,e);return}const o=i.target.closest(".portfolio-toggle");if(!o||!n.contains(o))return;const s=o.getAttribute("data-portfolio");if(!s)return;const c=e.querySelector(`.portfolio-details[data-portfolio="${s}"]`);if(!c)return;const l=o.querySelector(".caret");if(c.classList.contains("hidden")){c.classList.remove("hidden"),o.classList.add("expanded"),o.setAttribute("aria-expanded","true"),l&&(l.textContent="▼"),ue.add(s);let d=!1;try{d=ge(e,s)}catch(h){console.warn("attachPortfolioToggleHandler: Pending-Flush fehlgeschlagen:",h)}if(!d&&window.__ppReaderFlushPendingPositions)try{d=window.__ppReaderFlushPendingPositions(e,s)}catch(h){console.warn("attachPortfolioToggleHandler: Global Pending-Flush fehlgeschlagen:",h)}if(T.has(s)){const h=c.querySelector(".positions-container");if(h){h.innerHTML=X(T.get(s)),Z(e,s);try{j(e,s)}catch(f){console.warn("attachPortfolioToggleHandler: Security-Listener (Cache) Fehler:",f)}}}else{const h=c.querySelector(".positions-container");h&&(h.innerHTML='<div class="loading">Lade Positionen...</div>');try{const f=await Ze(ce,le,s);if(f.error){h&&(h.innerHTML=`<div class="error">${f.error} <button class="retry-pos" data-portfolio="${s}">Erneut laden</button></div>`);return}const b=f&&f.positions||[];if(T.set(s,b),h){h.innerHTML=X(b);try{Z(e,s)}catch(g){console.warn("attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:",g)}try{j(e,s)}catch(g){console.warn("attachPortfolioToggleHandler: Security-Listener konnte nicht gebunden werden:",g)}}}catch(f){const b=c.querySelector(".positions-container");b&&(b.innerHTML=`<div class="error">Fehler beim Laden: ${f.message} <button class="retry-pos" data-portfolio="${s}">Retry</button></div>`),console.error("Fehler beim Lazy Load für",s,f)}}}else c.classList.add("hidden"),o.classList.remove("expanded"),o.setAttribute("aria-expanded","false"),l&&(l.textContent="▶"),ue.delete(s)}catch(a){console.error("attachPortfolioToggleHandler: Ungefangener Fehler im Click-Handler",a)}})}finally{t===e.__ppReaderAttachToken&&(e.__ppReaderAttachInProgress=!1)}})()}function on(e){const t=e.querySelector(".expandable-portfolio-table");t&&(t.__ppReaderPortfolioFallbackBound||(t.__ppReaderPortfolioFallbackBound=!0,t.addEventListener("click",n=>{n.target.closest(".portfolio-toggle")&&(e.querySelector(".portfolio-table").__ppReaderPortfolioToggleBound||(console.debug("Fallback-Listener aktiv – re-attach Hauptlistener"),xe(e)))})))}async function ut(e,t,n){var E,L,N;ce=t,le=n,console.debug("renderDashboard: start – panelConfig:",n==null?void 0:n.config,"derived entry_id?",(N=(L=(E=n==null?void 0:n.config)==null?void 0:E._panel_custom)==null?void 0:L.config)==null?void 0:N.entry_id);const r=await kt(t,n),i=r&&r.accounts||[];let o=((await qt(t,n)).portfolios||[]).map(w=>{const D=typeof w.missing_value_positions=="number"?w.missing_value_positions:0,$=w.has_current_value!=null?!!w.has_current_value:D===0,k=typeof w.current_value=="number"?w.current_value:0,R=typeof w.purchase_sum=="number"?w.purchase_sum:0,be=$?k:null,Q=$?k-R:null,me=$&&R>0?Q/R*100:null;return{uuid:w.uuid,name:w.name,position_count:typeof w.position_count=="number"?w.position_count:0,current_value:be,purchase_sum:R,gain_abs:Q,gain_pct:me,hasValue:$,missing_value_positions:D,fx_unavailable:!$}}),s="";try{s=await Ht(t,n)}catch{s=""}const c=i.reduce((w,D)=>w+(Number.isFinite(D.balance)?D.balance:0),0),l=o.some(w=>w.hasValue===!1),u=o.reduce((w,D)=>w+(D.hasValue&&Number.isFinite(D.current_value)?D.current_value:0),0),d=c+u,h="Teilweise fehlende Wechselkurse – Gesamtvermögen unbekannt",f=l?`<span class="missing-value" role="note" aria-label="${h}" title="${h}">—</span>`:`${H(d)}&nbsp;€`,b=l?`<span class="total-wealth-note">${h}</span>`:"",g=`
    <div class="header-meta-row">
      💰 Gesamtvermögen: <strong class="total-wealth-value">${f}</strong>${b}
    </div>
  `,_=Ke("Übersicht",g),p=ct(o),y=i.filter(w=>(w.currency_code||"EUR")==="EUR"),m=i.filter(w=>(w.currency_code||"EUR")!=="EUR"),P=m.some(w=>w.fx_unavailable)?`
        <p class="table-note" role="note">
          <span class="table-note__icon" aria-hidden="true">⚠️</span>
          <span>Wechselkurse konnten nicht geladen werden. EUR-Werte werden derzeit nicht angezeigt.</span>
        </p>
      `:"",F=`
    <div class="card">
      <h2>Liquidität</h2>
      <div class="scroll-container account-table">
        ${B(y,[{key:"name",label:"Name"},{key:"balance",label:"Kontostand (EUR)",align:"right"}],["balance"])}
      </div>
    </div>
    ${m.length?`
      <div class="card">
        <h2>Fremdwährungen</h2>
        <div class="scroll-container fx-account-table">
          ${B(m.map(w=>({...w,fx_display:`${(w.orig_balance??0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}&nbsp;${w.currency_code}`})),[{key:"name",label:"Name"},{key:"fx_display",label:"Betrag (FX)"},{key:"balance",label:"EUR",align:"right"}],["balance"])}
        </div>
        ${P}
      </div>`:""}
  `,v=`
    <div class="card footer-card">
      <div class="meta">
        <div class="last-file-update">
          📂 Letzte Aktualisierung der Datei: <strong>${s||"Unbekannt"}</strong>
        </div>
      </div>
    </div>
  `,A=`
    ${_.outerHTML}
    <div class="card">
      <h2>Investment</h2>
      <div class="scroll-container portfolio-table">
        ${p}
      </div>
    </div>
    ${F}
    ${v}
  `;return cn(e,o),A}function cn(e,t){if(!e)return;const n=()=>{try{const i=e,a=i.querySelector(".portfolio-table");a&&a.querySelectorAll(".portfolio-toggle").length===0&&(console.debug("Recovery: Tabelle ohne Buttons – erneuter Aufbau"),a.innerHTML=ct(t)),xe(e),on(e),ue.forEach(o=>{try{T.has(o)&&(Z(e,o),j(e,o))}catch(s){console.warn("Init-Sortierung für expandiertes Depot fehlgeschlagen:",o,s)}});try{lt(i)}catch(o){console.warn("renderDashboard: Footer-Summe konnte nicht aktualisiert werden:",o)}try{et(e)}catch(o){console.warn("renderDashboard: Pending-Positions konnten nicht angewendet werden:",o)}console.debug("renderDashboard: portfolio-toggle Buttons:",i.querySelectorAll(".portfolio-toggle").length)}catch(i){console.error("renderDashboard: Fehler bei Recovery/Listener",i)}},r=typeof requestAnimationFrame=="function"?i=>requestAnimationFrame(i):i=>setTimeout(i,0);r(()=>r(n))}const ln="http://www.w3.org/2000/svg",ie=640,ae=260,ne={top:12,right:16,bottom:24,left:16},re="var(--pp-reader-chart-line, #3f51b5)",Re="var(--pp-reader-chart-area, rgba(63, 81, 181, 0.12))",Ce="0.75rem",un=24*60*60*1e3;function W(e,t={}){const n=document.createElementNS(ln,e);return Object.entries(t).forEach(([r,i])=>{i!=null&&n.setAttribute(r,String(i))}),n}function dn(e,t=null){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"&&e.trim()!==""){const n=Number.parseFloat(e);if(Number.isFinite(n))return n}return t}function fn(e,t){if(e instanceof Date){const n=e.getTime();return Number.isFinite(n)?n:t}if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"){const n=Date.parse(e);if(Number.isFinite(n))return n}return t}function hn(e,t){if(Number.isFinite(e)){const n=new Date(e);if(!Number.isNaN(n.getTime()))return n.toLocaleDateString("de-DE")}return t!=null&&t.date?String(t.date):e==null?"":String(e)}function dt(e){return(Number.isFinite(e)?e:Number.parseFloat(e)||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}function pn({xFormatted:e,yFormatted:t}){return`
    <div class="chart-tooltip-date">${e}</div>
    <div class="chart-tooltip-value">${t}&nbsp;€</div>
  `}function ft(e){return e.__chartState||(e.__chartState={}),e.__chartState}function G(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function gn(e,t){if(!Array.isArray(e)||e.length===0)return"";const n=e.map((i,a)=>`${a===0?"M":"L"}${i.x.toFixed(2)} ${i.y.toFixed(2)}`).join(" "),r=`L${e[e.length-1].x.toFixed(2)} ${t.toFixed(2)} L${e[0].x.toFixed(2)} ${t.toFixed(2)} Z`;return`${n} ${r}`}function bn(e){return!Array.isArray(e)||e.length===0?"":e.map((t,n)=>`${n===0?"M":"L"}${t.x.toFixed(2)} ${t.y.toFixed(2)}`).join(" ")}function mn(e,t,n){const{width:r,height:i,margin:a}=t,{xAccessor:o,yAccessor:s}=n;if(!Array.isArray(e)||e.length===0)return{points:[],range:null};const c=e.map((N,w)=>{const D=o(N,w),$=s(N,w),k=fn(D,w),R=dn($);return Number.isFinite(R)?{index:w,data:N,xValue:k,yValue:R}:null}).filter(Boolean);if(c.length===0)return{points:[],range:null};const l=c.reduce((N,w)=>Math.min(N,w.xValue),c[0].xValue),u=c.reduce((N,w)=>Math.max(N,w.xValue),c[0].xValue),d=c.reduce((N,w)=>Math.min(N,w.yValue),c[0].yValue),h=c.reduce((N,w)=>Math.max(N,w.yValue),c[0].yValue),f=Math.max(r-a.left-a.right,1),b=Math.max(i-a.top-a.bottom,1),g=Number.isFinite(l)?l:0,_=Number.isFinite(u)?u:g+1,p=Number.isFinite(d)?d:0,y=Number.isFinite(h)?h:p+1,m=Math.max(2,Math.min(6,Math.round(Math.max(i-a.top-a.bottom,0)/60)||4)),{niceMin:S,niceMax:P}=Sn(p,y,m),F=Number.isFinite(S)?S:p,v=Number.isFinite(P)?P:y,A=_-g||1,E=v-F||1;return{points:c.map(N=>{const w=A===0?.5:(N.xValue-g)/A,D=E===0?.5:(N.yValue-F)/E,$=a.left+w*f,k=a.top+(1-D)*b;return{...N,x:$,y:k}}),range:{minX:g,maxX:_,minY:F,maxY:v,boundedWidth:f,boundedHeight:b}}}function ht(e,t,n,r){e.width=Number.isFinite(t)?t:ie,e.height=Number.isFinite(n)?n:ae,e.margin={top:Number.isFinite(r==null?void 0:r.top)?r.top:ne.top,right:Number.isFinite(r==null?void 0:r.right)?r.right:ne.right,bottom:Number.isFinite(r==null?void 0:r.bottom)?r.bottom:ne.bottom,left:Number.isFinite(r==null?void 0:r.left)?r.left:ne.left}}function yn(e,t){const n=e.xFormatter(t.xValue,t.data,t.index),r=e.yFormatter(t.yValue,t.data,t.index);return e.tooltipRenderer({point:t,xFormatted:n,yFormatted:r,data:t.data,index:t.index})}function _n(e,t,n){const{tooltip:r,width:i,margin:a}=e;if(!r)return;const o=e.height-a.bottom;r.style.visibility="visible",r.style.opacity="1";const s=r.offsetWidth||0,c=r.offsetHeight||0,l=G(t.x-s/2,a.left,i-a.right-s),u=Math.max(o-c,0),d=12,h=Number.isFinite(n)?G(n,a.top,o):t.y;let f=h+d;f>u&&(f=h-c-d),f=G(f,0,u),r.style.transform=`translate(${Math.round(l)}px, ${Math.round(f)}px)`}function se(e){const{tooltip:t,focusLine:n,focusCircle:r}=e;t&&(t.style.opacity="0",t.style.visibility="hidden"),n&&(n.style.opacity="0"),r&&(r.style.opacity="0")}function vn(e,t){if(t.handlersAttached)return;const n=i=>{if(!t.points||t.points.length===0){se(t);return}const a=t.svg.getBoundingClientRect(),o=i.clientX-a.left,s=i.clientY-a.top;let c=t.points[0],l=Math.abs(o-c.x);for(let u=1;u<t.points.length;u+=1){const d=t.points[u],h=Math.abs(o-d.x);h<l&&(l=h,c=d)}if(!c){se(t);return}t.focusCircle&&(t.focusCircle.setAttribute("cx",c.x.toFixed(2)),t.focusCircle.setAttribute("cy",c.y.toFixed(2)),t.focusCircle.style.opacity="1"),t.focusLine&&(t.focusLine.setAttribute("x1",c.x.toFixed(2)),t.focusLine.setAttribute("x2",c.x.toFixed(2)),t.focusLine.setAttribute("y1",t.margin.top.toFixed(2)),t.focusLine.setAttribute("y2",(t.height-t.margin.bottom).toFixed(2)),t.focusLine.style.opacity="1"),t.tooltip&&(t.tooltip.innerHTML=yn(t,c),_n(t,c,s))},r=()=>{se(t)};t.overlay.addEventListener("pointermove",n),t.overlay.addEventListener("pointerenter",n),t.overlay.addEventListener("pointerleave",r),t.handlersAttached=!0,t.handlePointerMove=n,t.handlePointerLeave=r}function wn(e,t={}){if(!e)return console.error("renderLineChart: root element is required"),null;const n=document.createElement("div");n.className="line-chart-container",n.dataset.chartType="line",n.style.position="relative";const r=W("svg",{width:ie,height:ae,viewBox:`0 0 ${ie} ${ae}`,role:"img","aria-hidden":"true",focusable:"false"});r.classList.add("line-chart-svg");const i=W("path",{class:"line-chart-area",fill:Re,stroke:"none"}),a=W("path",{class:"line-chart-path",fill:"none",stroke:re,"stroke-width":2,"stroke-linecap":"round","stroke-linejoin":"round"}),o=W("line",{class:"line-chart-focus-line",stroke:re,"stroke-width":1,"stroke-dasharray":"4 4",opacity:0}),s=W("circle",{class:"line-chart-focus-circle",r:4,fill:"#fff",stroke:re,"stroke-width":2,opacity:0}),c=W("rect",{class:"line-chart-overlay",fill:"transparent",x:0,y:0,width:ie,height:ae});r.appendChild(i),r.appendChild(a),r.appendChild(o),r.appendChild(s),r.appendChild(c),n.appendChild(r);const l=document.createElement("div");l.className="chart-tooltip",l.style.position="absolute",l.style.top="0",l.style.left="0",l.style.pointerEvents="none",l.style.opacity="0",l.style.visibility="hidden",n.appendChild(l),e.appendChild(n);const u=ft(n);if(u.svg=r,u.areaPath=i,u.linePath=a,u.focusLine=o,u.focusCircle=s,u.overlay=c,u.tooltip=l,u.xAccessor=t.xAccessor||(d=>d==null?void 0:d.date),u.yAccessor=t.yAccessor||(d=>d==null?void 0:d.close),u.xFormatter=t.xFormatter||hn,u.yFormatter=t.yFormatter||dt,u.tooltipRenderer=t.tooltipRenderer||pn,u.color=t.color||re,u.areaColor=t.areaColor||Re,u.handlersAttached=!1,!u.xAxis){const d=document.createElement("div");d.className="line-chart-axis line-chart-axis-x",d.style.position="absolute",d.style.left="0",d.style.right="0",d.style.bottom="0",d.style.pointerEvents="none",d.style.fontSize=Ce,d.style.color="var(--secondary-text-color)",d.style.display="block",n.appendChild(d),u.xAxis=d}if(!u.yAxis){const d=document.createElement("div");d.className="line-chart-axis line-chart-axis-y",d.style.position="absolute",d.style.top="0",d.style.bottom="0",d.style.left="0",d.style.pointerEvents="none",d.style.fontSize=Ce,d.style.color="var(--secondary-text-color)",d.style.display="block",n.appendChild(d),u.yAxis=d}return ht(u,t.width,t.height,t.margin),a.setAttribute("stroke",u.color),o.setAttribute("stroke",u.color),s.setAttribute("stroke",u.color),i.setAttribute("fill",u.areaColor),pt(n,t),vn(n,u),n}function pt(e,t={}){if(!e){console.error("updateLineChart: container element is required");return}const n=ft(e);if(!n.svg||!n.linePath||!n.overlay){console.error("updateLineChart: chart was not initialised with renderLineChart");return}t.xAccessor&&(n.xAccessor=t.xAccessor),t.yAccessor&&(n.yAccessor=t.yAccessor),t.xFormatter&&(n.xFormatter=t.xFormatter),t.yFormatter&&(n.yFormatter=t.yFormatter),t.tooltipRenderer&&(n.tooltipRenderer=t.tooltipRenderer),t.color&&(n.color=t.color,n.linePath.setAttribute("stroke",n.color),n.focusLine.setAttribute("stroke",n.color),n.focusCircle.setAttribute("stroke",n.color)),t.areaColor&&(n.areaColor=t.areaColor,n.areaPath&&n.areaPath.setAttribute("fill",n.areaColor)),ht(n,t.width,t.height,t.margin);const{width:r,height:i,margin:a}=n;n.svg.setAttribute("width",r),n.svg.setAttribute("height",i),n.svg.setAttribute("viewBox",`0 0 ${r} ${i}`),n.overlay.setAttribute("x",a.left.toFixed(2)),n.overlay.setAttribute("y",a.top.toFixed(2)),n.overlay.setAttribute("width",Math.max(r-a.left-a.right,0).toFixed(2)),n.overlay.setAttribute("height",Math.max(i-a.top-a.bottom,0).toFixed(2));const o=Array.isArray(t.series)?t.series:n.series;n.series=o||[];const{points:s,range:c}=mn(n.series,n,{xAccessor:n.xAccessor,yAccessor:n.yAccessor});if(n.points=s,n.range=c,!s||s.length===0){n.linePath.setAttribute("d",""),n.areaPath&&n.areaPath.setAttribute("d",""),se(n),Me(n);return}const l=bn(s);if(n.linePath.setAttribute("d",l),n.areaPath&&c){const u=n.margin.top+c.boundedHeight,d=gn(s,u);n.areaPath.setAttribute("d",d)}Me(n)}function Me(e){const{xAxis:t,yAxis:n,range:r,margin:i,width:a,height:o,yFormatter:s}=e;if(!t||!n)return;if(!r){t.innerHTML="",n.innerHTML="";return}const{minX:c,maxX:l,minY:u,maxY:d,boundedWidth:h,boundedHeight:f}=r,b=Number.isFinite(c)&&Number.isFinite(l)&&l>=c,g=Number.isFinite(u)&&Number.isFinite(d)&&d>=u,_=Math.max(h,0),p=Math.max(f,0);if(t.style.left=`${i.left}px`,t.style.width=`${_}px`,t.style.top=`${o-i.bottom+6}px`,t.innerHTML="",b&&_>0){const m=(l-c)/un,S=Math.max(2,Math.min(6,Math.round(_/140)||4));Pn(e,c,l,S,m).forEach(({positionRatio:F,label:v})=>{const A=document.createElement("div");A.className="line-chart-axis-tick line-chart-axis-tick-x",A.style.position="absolute",A.style.bottom="0",A.style.transform="translateX(-50%)";const E=G(F,0,1);A.style.left=`${E*_}px`,A.textContent=v,t.appendChild(A)})}n.style.top=`${i.top}px`,n.style.height=`${p}px`;const y=Math.max(i.left-6,0);if(n.style.left="0",n.style.width=`${Math.max(y,0)}px`,n.innerHTML="",g&&p>0){const m=Math.max(2,Math.min(6,Math.round(p/60)||4));An(u,d,m).forEach(({value:P,positionRatio:F})=>{const v=document.createElement("div");v.className="line-chart-axis-tick line-chart-axis-tick-y",v.style.position="absolute",v.style.left="0";const E=(1-G(F,0,1))*p;v.style.top=`${E}px`,v.textContent=s?s(P):dt(P),n.appendChild(v)})}}function Sn(e,t,n=4){if(!Number.isFinite(e)||!Number.isFinite(t))return{niceMin:e,niceMax:t};const r=Math.max(2,n);if(t===e){const l=Se(Math.abs(e)||1);return{niceMin:e-l,niceMax:t+l}}const a=(t-e)/(r-1),o=Se(a),s=Math.floor(e/o)*o,c=Math.ceil(t/o)*o;return s===c?{niceMin:e,niceMax:t+o}:{niceMin:s,niceMax:c}}function Pn(e,t,n,r,i){if(!Number.isFinite(t)||!Number.isFinite(n)||n<t)return[];if(!Number.isFinite(i)||i<=0)return[{positionRatio:.5,label:ke(e,t,i||0)}];const a=Math.max(2,r),o=[],s=n-t;for(let c=0;c<a;c+=1){const l=a===1?.5:c/(a-1),u=t+l*s;o.push({positionRatio:l,label:ke(e,u,i)})}return o}function ke(e,t,n){const r=new Date(t);return Number.isFinite(r.getTime())?n>1095?String(r.getFullYear()):n>365?r.toLocaleDateString("de-DE",{year:"numeric",month:"short"}):n>90?r.toLocaleDateString("de-DE",{year:"2-digit",month:"short"}):n>30?r.toLocaleDateString("de-DE",{day:"2-digit",month:"short"}):r.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"}):e.xFormatter?e.xFormatter(t,null,-1):String(t)}function An(e,t,n){if(!Number.isFinite(e)||!Number.isFinite(t))return[];if(t===e)return[{value:e,positionRatio:.5}];const r=t-e,i=Math.max(2,n),a=r/(i-1),o=Se(a),s=Math.floor(e/o)*o,c=Math.ceil(t/o)*o,l=[];for(let u=s;u<=c+o/2;u+=o){const d=(u-e)/(t-e);l.push({value:u,positionRatio:G(d,0,1)})}return l.length>i+2?l.filter((u,d)=>d%2===0):l}function Se(e){if(!Number.isFinite(e)||e===0)return 1;const t=Math.floor(Math.log10(Math.abs(e))),n=Math.abs(e)/10**t;let r;return n<=1?r=1:n<=2?r=2:n<=5?r=5:r=10,r*10**t}const _e={min:0,max:6},He={min:2,max:4},Fn=1e8,Nn="1Y",xn=["1M","6M","1Y","5Y"],En={"1M":30,"6M":182,"1Y":365,"5Y":1826},U=new Map,oe=new Map,gt="pp-reader:portfolio-positions-updated",K=new Map;function Dn({fallbackUsed:e,flaggedAsCache:t}){const n=[];return e&&n.push("Der aktuelle Snapshot konnte nicht geladen werden. Es werden die zuletzt gespeicherten Werte angezeigt."),t&&!e&&n.push("Der Snapshot ist vom Datenanbieter als Zwischenspeicherstand markiert."),`
    <div class="card warning-card stale-notice" role="status" aria-live="polite">
      <h2>Zwischengespeicherte Werte</h2>
      <p>${n.length?n.join(" "):"Die Daten stammen aus dem Zwischenspeicher."}</p>
      <p class="stale-notice__hint">Die angezeigten Beträge können von den aktuellen Marktwerten abweichen. Laden Sie die Ansicht erneut, sobald eine Verbindung verfügbar ist.</p>
    </div>
  `}function Ln(e){if(!e||typeof window>"u")return null;try{const t=window.__ppReaderGetSecuritySnapshotFromCache;if(typeof t=="function"){const n=t(e);return n&&typeof n=="object"?n:null}}catch(t){console.warn("getCachedSecuritySnapshot: Zugriff auf Cache fehlgeschlagen",t)}return null}function bt(e){return U.has(e)||U.set(e,new Map),U.get(e)}function mt(e){if(e&&U.has(e)){try{const t=U.get(e);t&&typeof t.clear=="function"&&t.clear()}catch(t){console.warn("invalidateHistoryCache: Konnte Cache nicht leeren",e,t)}U.delete(e)}}function $n(e,t){if(!e||!t)return;const n=t.securityUuids;(Array.isArray(n)?n:[]).includes(e)&&mt(e)}function Tn(e){if(!e||K.has(e))return;const t=n=>{!n||!n.detail||$n(e,n.detail)};try{window.addEventListener(gt,t),K.set(e,t)}catch(n){console.error("ensureLiveUpdateSubscription: Registrierung fehlgeschlagen",n)}}function Rn(e){if(!e||!K.has(e))return;const t=K.get(e);try{window.removeEventListener(gt,t)}catch(n){console.error("removeLiveUpdateSubscription: Entfernen des Listeners fehlgeschlagen",n)}K.delete(e)}function Cn(e){e&&(Rn(e),mt(e))}function qe(e,t){if(!oe.has(e)){oe.set(e,{activeRange:t});return}const n=oe.get(e);n.activeRange=t}function yt(e){var t;return((t=oe.get(e))==null?void 0:t.activeRange)||Nn}function Ie(e){const t=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate());return Math.floor(t/864e5)}function Mn(e){const t=new Date(e.getTime());return t.setUTCHours(0,0,0,0),t}function _t(e){const t=Mn(new Date),n=En[e],r={end_date:Ie(t)};if(Number.isFinite(n)&&n>0){const i=new Date(t.getTime());i.setUTCDate(i.getUTCDate()-(n-1)),r.start_date=Ie(i)}return r}function kn(e){if(!e)return null;if(e instanceof Date&&!Number.isNaN(e.getTime()))return new Date(e.getTime());if(typeof e=="number"&&Number.isFinite(e)){const t=e*864e5;if(Number.isFinite(t))return new Date(t)}if(typeof e=="string"){const t=e.trim();if(/^\d{8}$/.test(t)){const r=Number.parseInt(t.slice(0,4),10),i=Number.parseInt(t.slice(4,6),10)-1,a=Number.parseInt(t.slice(6,8),10);if(Number.isFinite(r)&&Number.isFinite(i)&&Number.isFinite(a)){const o=new Date(Date.UTC(r,i,a));if(!Number.isNaN(o.getTime()))return o}}const n=Date.parse(t);if(Number.isFinite(n))return new Date(n)}return null}function vt(e){return Array.isArray(e)?e.map(t=>{const n=Number(t==null?void 0:t.close);return Number.isFinite(n)?{date:kn(t==null?void 0:t.date)||(t==null?void 0:t.date),close:n/Fn}:null}).filter(Boolean):[]}function wt(e,t){const n=String((e==null?void 0:e.currency_code)||"").toUpperCase();if(!n||n==="EUR")return 1;const r=e==null?void 0:e.last_price_eur,i=Number.isFinite(r)?r:Number.parseFloat(r);if(!Number.isFinite(i)||i<=0)return null;const a=e==null?void 0:e.last_price_native,o=Number.isFinite(a)?a:Number.parseFloat(a);if(Number.isFinite(o)&&o>0)return i/o;const s=Number.isFinite(t)?t:Number.parseFloat(t);return Number.isFinite(s)&&s>0?i/s:null}function We(e){if(!Number.isFinite(e))return null;const t=Math.round(e*100)/100;return Object.is(t,-0)?0:t}function St(e,t,n){if(!Array.isArray(e)||e.length===0)return{periodGain:null,dailyGain:null};const r=Number.isFinite(t)?t:Number.parseFloat(t),i=Number.isFinite(r)?r:0,a=Number.isFinite(n)&&n>0?n:null;if(a==null)return{periodGain:null,dailyGain:null};const o=e[e.length-1],s=e[0],c=e.length>=2?e[e.length-2]:null,l=(o.close-s.close)*i*a,u=c?(o.close-c.close)*i*a:null;return{periodGain:We(l),dailyGain:We(u)}}function Ge(e){return e==null||Number.isNaN(e)?'<span class="value neutral">—</span>':`<span class="value">${Xe(e)}</span>`}function Pt(e,t,n){const r=e||"";return`
    <div class="security-info-bar" data-range="${r}">
      <div class="security-info-item">
        <span class="label">Gesamt (${r||"Zeitraum"})</span>
        ${Ge(t)}
      </div>
      <div class="security-info-item">
        <span class="label">Letzter Tag</span>
        ${Ge(n)}
      </div>
    </div>
  `}function Hn(e){return`
    <div class="security-range-selector" role="group" aria-label="Zeitraum">
      ${xn.map(n=>`
      <button
        type="button"
        class="security-range-button${n===e?" active":""}"
        data-range="${n}"
        aria-pressed="${n===e}"
      >
        ${n}
      </button>
    `).join(`
`)}
    </div>
  `}function At(e,t={status:"empty"}){const n=e||"";switch(t.status){case"loaded":return`
        <div
          class="history-chart"
          data-state="loaded"
          data-range="${n}"
          role="img"
          aria-label="Preisverlauf${n?` für ${n}`:""}"
        ></div>
      `;case"error":{const r=t!=null&&t.message?String(t.message):"Die historischen Daten konnten nicht geladen werden.";return`
        <div class="history-placeholder" data-state="error" data-range="${n}">
          <p>${r}</p>
        </div>
      `}case"empty":default:return`
        <div class="history-placeholder" data-state="empty" data-range="${n}">
          <p>Für dieses Wertpapier liegen im Zeitraum ${n||"den gewählten Zeitraum"} keine historischen Daten vor.</p>
        </div>
      `}}function qn(e){if(e==null||Number.isNaN(e))return"—";const t=Number.isFinite(e)?e:Number.parseFloat(e)||0,n=Math.abs(t%1)>0,r=n?2:_e.min,i=n?_e.max:_e.min;return t.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:i})}function Ft(e){return e==null||Number.isNaN(e)?"—":(Number.isFinite(e)?e:Number.parseFloat(e)||0).toLocaleString("de-DE",{minimumFractionDigits:He.min,maximumFractionDigits:He.max})}function In(e){var s;if(!e)return'<div class="meta-error">Keine Snapshot-Daten verfügbar.</div>';const t=e.currency_code||"EUR",n=qn(e.total_holdings),r=e.last_price_native??((s=e.last_price)==null?void 0:s.native)??e.last_price_eur,i=Ft(r),a=i==="—"?"—":`${i}${`&nbsp;${t}`}`,o=H(e.market_value_eur??e.current_value_eur??0);return`
    <div class="security-meta-grid">
      <div class="security-meta-item">
        <span class="label">Währung</span>
        <span class="value">${t}</span>
      </div>
      <div class="security-meta-item">
        <span class="label">Bestand</span>
        <span class="value">${n}</span>
      </div>
      <div class="security-meta-item">
        <span class="label">Letzter Preis (${t})</span>
        <span class="value">${a}</span>
      </div>
      <div class="security-meta-item">
        <span class="label">Marktwert (EUR)</span>
        <span class="value">${o}&nbsp;€</span>
      </div>
    </div>
  `}function Nt(e){if(!e)return null;if(typeof e=="string")return e;if(e instanceof Error)return e.message||null;try{return JSON.stringify(e)}catch{return String(e)}}async function Wn(e,t,n,r){if(!r)return console.error("renderSecurityDetail: securityUuid fehlt"),'<div class="card"><h2>Fehler</h2><p>Kein Wertpapier angegeben.</p></div>';const i=Ln(r);let a=null,o=null;try{const v=await It(t,n,r);v&&typeof v=="object"?a=v.snapshot&&typeof v.snapshot=="object"?v.snapshot:v:a=v}catch(v){console.error("renderSecurityDetail: Snapshot konnte nicht geladen werden",v),o=v instanceof Error?v.message:String(v)}const s=a||i,c=!!(i&&!a),l=(s==null?void 0:s.source)==="cache",u=s&&(c||l)?Dn({fallbackUsed:c,flaggedAsCache:l}):"",d=(s==null?void 0:s.name)||"Wertpapierdetails",h=Ke(d,In(s));if(o)return`
      ${h.outerHTML}
      ${u}
      <div class="card error-card">
        <h2>Fehler beim Laden</h2>
        <p>${o}</p>
      </div>
    `;const f=yt(r),b=bt(r);let g=b.has(f)?b.get(f):null,_={status:"empty"};if(Array.isArray(g))_=g.length?{status:"loaded"}:{status:"empty"};else{g=[];try{const v=_t(f),A=await Je(t,n,r,v);g=vt(A==null?void 0:A.prices),b.set(f,g),_=g.length?{status:"loaded"}:{status:"empty"}}catch(v){console.error("renderSecurityDetail: Historie konnte nicht geladen werden",v),_={status:"error",message:Nt(v)||"Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden."}}}const p=g.length>0?g[g.length-1].close:s==null?void 0:s.last_price_native,y=wt(s,p),m=(s==null?void 0:s.total_holdings)??0,{periodGain:S,dailyGain:P}=St(g,m,y),F=Pt(f,S,P);return Bn({root:e,hass:t,panelConfig:n,securityUuid:r,snapshot:s,holdings:m,initialRange:f,initialHistory:g,initialHistoryState:_}),`
    ${h.outerHTML}
    ${u}
    ${F}
    ${Hn(f)}
    <div class="card security-detail-placeholder">
      <h2>Historie</h2>
      ${At(f,_)}
    </div>
  `}function Ue(e,t){e&&(e.dataset.activeRange=t,e.querySelectorAll(".security-range-button").forEach(n=>{const i=n.dataset.range===t;n.classList.toggle("active",i),n.setAttribute("aria-pressed",i?"true":"false"),n.disabled=!1,n.classList.remove("loading")}))}function Gn(e,t,n,r){const i=e.querySelector(".security-info-bar");if(!i||!i.parentElement)return;const a=document.createElement("div");a.innerHTML=Pt(t,n,r).trim();const o=a.firstElementChild;o&&i.parentElement.replaceChild(o,i)}const Ve=new WeakMap;function Un(e,t,{currency:n}={}){const r=e.clientWidth||e.offsetWidth||0,i=r>0?r:640,a=Math.min(Math.max(Math.floor(i*.55),220),420),o=(n||"").toUpperCase()||"EUR";return{width:i,height:a,margin:{top:16,right:20,bottom:32,left:20},series:t,yFormatter:Ft,tooltipRenderer:({xFormatted:s,yFormatted:c})=>`
      <div class="chart-tooltip-date">${s}</div>
      <div class="chart-tooltip-value">${c}&nbsp;${o}</div>
    `}}function Vn(e,t,n){if(!e||!Array.isArray(t)||t.length===0)return;const r=Un(e,t,n);let i=Ve.get(e);if(!i||!e.contains(i)){e.innerHTML="",i=wn(e,r)||null,i&&Ve.set(e,i);return}pt(i,r)}function Be(e,t,n,r,i={}){const a=e.querySelector(".security-detail-placeholder");if(a&&(a.innerHTML=`
    <h2>Historie</h2>
    ${At(t,n)}
  `,(n==null?void 0:n.status)==="loaded"&&Array.isArray(r)&&r.length)){const o=a.querySelector(".history-chart");o&&requestAnimationFrame(()=>{Vn(o,r,i)})}}function Bn({root:e,hass:t,panelConfig:n,securityUuid:r,snapshot:i,holdings:a,initialRange:o,initialHistory:s,initialHistoryState:c}){e&&setTimeout(()=>{const l=e.querySelector(".security-range-selector");if(!l)return;const u=bt(r);Array.isArray(s)&&(c==null?void 0:c.status)!=="error"&&u.set(o,s),Tn(r),qe(r,o),Ue(l,o),c&&Be(e,o,c,s,{currency:i==null?void 0:i.currency_code});const h=async f=>{if(!f||f===yt(r))return;const b=l.querySelector(`.security-range-button[data-range="${f}"]`);b&&(b.disabled=!0,b.classList.add("loading"));let g=u.get(f)||null,_=null;if(g)_=g.length?{status:"loaded"}:{status:"empty"};else try{const P=_t(f),F=await Je(t,n,r,P);g=vt(F==null?void 0:F.prices),u.set(f,g),_=g.length?{status:"loaded"}:{status:"empty"}}catch(P){console.error("Range-Wechsel: Historie konnte nicht geladen werden",P),g=[],_={status:"error",message:Nt(P)||"Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden."}}const p=g.length?g[g.length-1].close:i==null?void 0:i.last_price_native,y=wt(i,p),{periodGain:m,dailyGain:S}=St(g,a,y);qe(r,f),Ue(l,f),Gn(e,f,m,S),Be(e,f,_,g,{currency:i==null?void 0:i.currency_code})};l.addEventListener("click",f=>{const b=f.target.closest(".security-range-button");if(!b||b.disabled)return;const{range:g}=b.dataset;h(g)})},0)}function zn({setSecurityDetailTabFactory:e}){if(typeof e!="function"){console.error("registerSecurityDetailTab: Ungültige Factory-Funktion übergeben");return}e(t=>({title:"Wertpapier",render:(n,r,i)=>Wn(n,r,i,t),cleanup:()=>Cn(t)}))}const Pe="pp-reader-sticky-anchor",de="overview",On=[{key:de,title:"Dashboard",render:ut}],O=new Map,J=[],fe=new Map,Ae="security:";function Ee(e){return typeof e!="string"||!e.startsWith(Ae)?null:e.slice(Ae.length)||null}let Fe=null,ve=!1,V=null;function Yn(){if(!V)return!1;const e=$t(V);return e||(V=null),e}function M(){const e=J.map(t=>O.get(t)).filter(Boolean);return[...On,...e]}function xt(){try{const e=Lt();e&&typeof e.rememberScrollPosition=="function"&&e.rememberScrollPosition()}catch(e){console.warn("rememberCurrentPageScroll: konnte Scroll-Position nicht sichern",e)}}function ze(e){const t=M();return!t.length||e<0?0:e>=t.length?t.length-1:e}async function Kn(e,t,n,r){const i=M(),a=ze(e);if(a===x){e>x&&Yn();return}xt();const o=i[x],s=Ee(o==null?void 0:o.key);let c=a;if(s){const l=i[a];if((l==null?void 0:l.key)===de&&Jn(s,{suppressRender:!0})){const h=M().findIndex(f=>f.key===de);c=h>=0?h:0}}if(!ve){ve=!0;try{x=ze(c),await Tt(t,n,r)}catch(l){console.error("navigateToPage: Fehler beim Rendern des Tabs",l)}finally{ve=!1}}}function he(e,t,n,r){Kn(x+e,t,n,r)}function Xn(e,t){if(!e||!t||typeof t.render!="function"){console.error("registerDetailTab: Ungültiger Tab-Descriptor",e,t);return}const n=Ee(e);if(n){const i=fe.get(n);i&&i!==e&&Et(i)}const r={...t,key:e};O.set(e,r),n&&fe.set(n,e),J.includes(e)||J.push(e)}function Et(e){if(!e)return;const t=O.get(e);if(t&&typeof t.cleanup=="function")try{t.cleanup({key:e})}catch(i){console.error("unregisterDetailTab: Fehler beim Ausführen von cleanup",i)}O.delete(e);const n=J.indexOf(e);n>=0&&J.splice(n,1);const r=Ee(e);r&&fe.get(r)===e&&fe.delete(r)}function jn(e){return O.has(e)}function Oe(e){return O.get(e)||null}function Zn(e){if(e!=null&&typeof e!="function"){console.error("setSecurityDetailTabFactory: Erwartet Funktion oder null",e);return}Fe=e||null}function Dt(e){return`${Ae}${e}`}function Lt(){const e=window.__ppReaderDashboardElements;if(e instanceof Set){for(const r of e)if(r&&r.isConnected)return r}const t=document.querySelector("pp-reader-dashboard");if(t)return t;const n=document.querySelectorAll("pp-reader-panel");for(const r of n){if(!r||!r.shadowRoot)continue;const i=r.shadowRoot.querySelector("pp-reader-dashboard");if(i)return i}return null}function Ne(){const e=Lt();if(!e){console.warn("requestDashboardRender: Kein pp-reader-dashboard Element gefunden");return}if(typeof e._renderIfInitialized=="function"){e._renderIfInitialized();return}typeof e._render=="function"&&e._render()}function $t(e){if(!e)return console.error("openSecurityDetail: Ungültige securityUuid",e),!1;const t=Dt(e);let n=Oe(t);if(!n&&typeof Fe=="function")try{const a=Fe(e);a&&typeof a.render=="function"?(Xn(t,a),n=Oe(t)):console.error("openSecurityDetail: Factory lieferte ungültigen Descriptor",a)}catch(a){console.error("openSecurityDetail: Fehler beim Erzeugen des Tab-Descriptors",a)}if(!n)return console.warn(`openSecurityDetail: Kein Detail-Tab für ${e} verfügbar`),!1;xt();let i=M().findIndex(a=>a.key===t);return i===-1&&(i=M().findIndex(o=>o.key===t),i===-1)?(console.error("openSecurityDetail: Tab nach Registrierung nicht auffindbar"),!1):(x=i,V=null,Ne(),!0)}function Jn(e,t={}){if(!e)return console.error("closeSecurityDetail: Ungültige securityUuid",e),!1;const{suppressRender:n=!1}=t,r=Dt(e);if(!jn(r))return!1;const a=M().findIndex(c=>c.key===r),o=a===x;Et(r);const s=M();if(!s.length)return x=0,n||Ne(),!0;if(V=e,o){const c=s.findIndex(l=>l.key===de);c>=0?x=c:x=Math.min(Math.max(a-1,0),s.length-1)}else x>=s.length&&(x=Math.max(0,s.length-1));return n||Ne(),!0}let x=0,Ye;async function Tt(e,t,n){let r=n;!r&&(t!=null&&t.panels)&&(r=t.panels.ppreader||t.panels.pp_reader||Object.values(t.panels).find(u=>(u==null?void 0:u.webcomponent_name)==="pp-reader-panel")||null);const i=M();x>=i.length&&(x=Math.max(0,i.length-1));const a=i[x];if(!a||!a.render){console.error("renderTab: Kein gültiger Tab oder keine render-Methode gefunden!");return}let o;try{o=await a.render(e,t,r)}catch(u){console.error("renderTab: Fehler beim Rendern des Tabs:",u),e.innerHTML=`<div class="card"><h2>Fehler</h2><pre>${u&&u.message||u}</pre></div>`;return}if(!e){console.error("renderTab: Root-Element nicht gefunden!");return}e.innerHTML=o,a.render===ut&&xe(e);const c=await new Promise(u=>{const d=setInterval(()=>{const h=e.querySelector(".header-card");h&&(clearInterval(d),u(h))},50)});if(!c){console.error("Header-Card nicht gefunden!");return}let l=e.querySelector(`#${Pe}`);l||(l=document.createElement("div"),l.id=Pe,c.parentNode.insertBefore(l,c)),tr(e,t,n),er(e,t,n),Qn(e)}function Qn(e){const t=e.querySelector(".header-card"),n=e,r=e.querySelector(`#${Pe}`);if(!t||!n||!r){console.error("Fehlende Elemente für das Scrollverhalten: headerCard, scrollBorder oder anchor.");return}Ye=new IntersectionObserver(([i])=>{i.isIntersecting?t.classList.remove("sticky"):t.classList.add("sticky")},{root:null,rootMargin:"0px 0px 0px 0px",threshold:0}),Ye.observe(r)}function er(e,t,n){const r=e.querySelector(".header-card");if(!r){console.error("Header-Card nicht gefunden!");return}Ct(r,()=>he(1,e,t,n),()=>he(-1,e,t,n))}function tr(e,t,n){const r=e.querySelector(".header-card");if(!r){console.error("Header-Card nicht gefunden!");return}const i=r.querySelector("#nav-left"),a=r.querySelector("#nav-right");if(!i||!a){console.error("Navigationspfeile nicht gefunden!");return}i.addEventListener("click",()=>{he(-1,e,t,n)}),a.addEventListener("click",()=>{he(1,e,t,n)}),nr(r)}function nr(e){const t=e.querySelector("#nav-left"),n=e.querySelector("#nav-right");if(t&&(x===0?(t.disabled=!0,t.classList.add("disabled")):(t.disabled=!1,t.classList.remove("disabled"))),n){const r=M(),a=!(x===r.length-1)||!!V;n.disabled=!a,n.classList.toggle("disabled",!a)}}class rr extends HTMLElement{constructor(){super(),this._root=document.createElement("div"),this._root.className="pp-reader-dashboard",this.appendChild(this._root),this._lastPanel=null,this._lastNarrow=null,this._lastRoute=null,this._lastPage=null,this._scrollPositions={},this._unsubscribeEvents=null,this._initialized=!1,this._hasNewData=!1,this._pendingUpdates=[],this._entryIdWaitWarned=!1}set hass(t){this._hass=t,this._checkInitialization()}set panel(t){this._panel!==t&&(this._panel=t,this._checkInitialization())}set narrow(t){this._narrow!==t&&(this._narrow=t,this._renderIfInitialized())}set route(t){this._route!==t&&(this._route=t,this._renderIfInitialized())}connectedCallback(){this._checkInitialization()}disconnectedCallback(){typeof this._unsubscribeEvents=="function"&&(this._unsubscribeEvents(),this._unsubscribeEvents=null),super.disconnectedCallback&&super.disconnectedCallback()}_checkInitialization(){if(!this._hass||this._initialized)return;!this._panel&&this._hass.panels&&(this._panel=this._hass.panels.ppreader||this._hass.panels.pp_reader||Object.values(this._hass.panels).find(n=>{var r,i,a;return(a=(i=(r=n==null?void 0:n.config)==null?void 0:r._panel_custom)==null?void 0:i.module_url)==null?void 0:a.includes("pp_reader_dashboard")})||null);const t=Le(this._hass,this._panel);if(!t){this._entryIdWaitWarned||(console.warn("PPReaderDashboard: kein entry_id ermittelbar – warte auf Panel-Konfiguration."),this._entryIdWaitWarned=!0);return}this._entryIdWaitWarned=!1,console.debug("PPReaderDashboard: entry_id (fallback) =",t),this._initialized=!0,this._initializeEventListeners(t),this._render()}_initializeEventListeners(t){var a;this._unsubscribeEvents&&(this._unsubscribeEvents(),this._unsubscribeEvents=null);const n=(a=this._hass)==null?void 0:a.connection;if(!n||typeof n.subscribeEvents!="function"){console.error("PPReaderDashboard: keine valide WebSocket-Verbindung oder subscribeEvents fehlt");return}const r=["panels_updated"],i=[];Promise.all(r.map(o=>n.subscribeEvents(this._handleBusEvent.bind(this),o).then(s=>{typeof s=="function"?(i.push(s),console.debug("PPReaderDashboard: subscribed to",o)):console.error("PPReaderDashboard: subscribeEvents lieferte kein Unsubscribe-Func für",o,s)}).catch(s=>{console.error("PPReaderDashboard: Fehler bei subscribeEvents für",o,s)}))).then(()=>{this._unsubscribeEvents=()=>{i.forEach(o=>{try{o()}catch{}}),console.debug("PPReaderDashboard: alle Event-Subscriptions entfernt")}})}_removeEventListeners(){if(typeof this._unsubscribeEvents=="function")try{this._unsubscribeEvents(),this._unsubscribeEvents=null}catch(t){console.error("PPReaderDashboard: Fehler beim Entfernen der Event-Listener:",t)}else console.warn("PPReaderDashboard: Kein gültiger Event-Listener zum Entfernen gefunden.")}_handleBusEvent(t){const n=Le(this._hass,this._panel);!n||t.data.entry_id!==n||(console.debug("PPReaderDashboard: Bus-Update erhalten",t.data),this._queueUpdate(t.data.data_type,t.data.data),this._doRender(t.data.data_type,t.data.data))}_doRender(t,n){t==="accounts"?Ot(n,this._root):t==="last_file_update"?Qt(n,this._root):t==="portfolio_values"?Kt(n,this._root):t==="portfolio_positions"?jt(n,this._root):console.warn("PPReaderDashboard: Unbekannter Datentyp:",t)}_queueUpdate(t,n){if(!t)return;Array.isArray(this._pendingUpdates)||(this._pendingUpdates=[]);const r={type:t,data:this._cloneData(n)};let i=-1;t==="portfolio_positions"&&n&&n.portfolio_uuid?i=this._pendingUpdates.findIndex(a=>a.type===t&&a.data&&a.data.portfolio_uuid===n.portfolio_uuid):i=this._pendingUpdates.findIndex(a=>a.type===t),i>=0?this._pendingUpdates[i]=r:this._pendingUpdates.push(r),this._hasNewData=!0}_cloneData(t){if(t==null)return t;try{if(typeof structuredClone=="function")return structuredClone(t)}catch(n){console.warn("PPReaderDashboard: structuredClone fehlgeschlagen, falle auf JSON zurück",n)}try{return JSON.parse(JSON.stringify(t))}catch(n){return console.warn("PPReaderDashboard: JSON-Clone fehlgeschlagen, referenziere Originaldaten",n),t}}_reapplyPendingUpdates(){if(!(!Array.isArray(this._pendingUpdates)||this._pendingUpdates.length===0))for(const t of this._pendingUpdates)try{this._doRender(t.type,this._cloneData(t.data))}catch(n){console.error("PPReaderDashboard: Fehler beim erneuten Anwenden eines Updates",t,n)}}_renderIfInitialized(){this._initialized&&this._render()}rememberScrollPosition(t=x){if(!this._root)return;const n=Number.isInteger(t)?t:x;n!=null&&(this._scrollPositions[n]=this._root.scrollTop||0)}_render(){if(!this._hass){console.warn("pp-reader-dashboard: noch kein hass, überspringe _render()");return}if(!this._initialized){console.debug("pp-reader-dashboard: _render aufgerufen bevor initialisiert");return}const t=x;if(!this._hasNewData&&this._panel===this._lastPanel&&this._narrow===this._lastNarrow&&this._route===this._lastRoute&&this._lastPage===t)return;this._lastPage!=null&&(this._scrollPositions[this._lastPage]=this._root.scrollTop);const n=Tt(this._root,this._hass,this._panel);n&&typeof n.then=="function"?n.then(()=>{this._afterRender(t)}).catch(r=>{console.error("PPReaderDashboard: Fehler beim Rendern des Tabs",r),this._afterRender(t)}):this._afterRender(t)}_afterRender(t){if(!this._root)return;const n=this._scrollPositions[t]||0;this._root.scrollTop=n,this._lastPanel=this._panel,this._lastNarrow=this._narrow,this._lastRoute=this._route,this._lastPage=t;try{this._reapplyPendingUpdates()}catch(r){console.error("PPReaderDashboard: Fehler beim Wiederanlegen der Updates",r)}this._hasNewData=!1}}customElements.get("pp-reader-dashboard")||customElements.define("pp-reader-dashboard",rr);console.log("PPReader dashboard.js v20250914b geladen");zn({setSecurityDetailTabFactory:Zn});
//# sourceMappingURL=dashboard.C0opWQVf.js.map
