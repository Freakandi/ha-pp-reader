var nn=Object.defineProperty;var rn=(e,t,n)=>t in e?nn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var $=(e,t,n)=>rn(e,typeof t!="symbol"?t+"":t,n);function on(e,t,n){let r=null;e.addEventListener("touchstart",i=>{i.touches.length===1&&(r=i.touches[0].clientX)},{passive:!0}),e.addEventListener("touchend",i=>{if(r===null)return;const o=i.changedTouches[0].clientX-r;o<-50?t():o>50&&n(),r=null},{passive:!0}),e.addEventListener("mousedown",i=>{r=i.clientX},{passive:!0}),e.addEventListener("mouseup",i=>{if(r===null)return;const o=i.clientX-r;o<-50?t():o>50&&n(),r=null},{passive:!0})}function I(e,t,n=void 0,r=void 0){let i=null;const o=a=>{if(typeof a=="number")return a;if(typeof a=="string"&&a.trim()!==""){const u=a.replace(/\s+/g,"").replace(/[^0-9,.-]/g,"").replace(/\.(?=\d{3}(\D|$))/g,"").replace(",","."),s=Number.parseFloat(u);return Number.isNaN(s)?Number.NaN:s}return Number.NaN},c=(a,u=2,s=2)=>{const d=typeof a=="number"?a:o(a);return Number.isFinite(d)?d.toLocaleString("de-DE",{minimumFractionDigits:u,maximumFractionDigits:s}):""},l=(a="")=>{const u=a||"Kein Wert verf√ºgbar";return`<span class="missing-value" role="note" aria-label="${u}" title="${u}">‚Äî</span>`};if(["gain_abs","gain_pct"].includes(e)){const a=n,u=a!=null&&a.fx_unavailable?"Wechselkurs nicht verf√ºgbar ‚Äì EUR-Wert unbekannt":"";if(t==null||r&&r.hasValue===!1)return l(u);const s=typeof t=="number"?t:o(t);if(!Number.isFinite(s))return l(u);const d=e==="gain_pct"?"%":"‚Ç¨";i=c(s)+`&nbsp;${d}`;let h="neutral";return s>0?h="positive":s<0&&(h="negative"),`<span class="${h}">${i}</span>`}else if(e==="position_count"){const a=typeof t=="number"?t:o(t);if(!Number.isFinite(a))return l();i=a.toLocaleString("de-DE")}else if(["balance","current_value","purchase_value"].includes(e)){const a=typeof t=="number"?t:o(t);if(!Number.isFinite(a))return n!=null&&n.fx_unavailable?l("Wechselkurs nicht verf√ºgbar ‚Äì EUR-Wert unbekannt"):(r&&r.hasValue===!1,l());i=c(a)+"&nbsp;‚Ç¨"}else if(e==="current_holdings"){const a=typeof t=="number"?t:o(t);if(!Number.isFinite(a))return l();const u=Math.abs(a%1)>0;i=a.toLocaleString("de-DE",{minimumFractionDigits:u?2:0,maximumFractionDigits:4})}else i=typeof t=="string"?t:t!=null?String(t):"",i&&(i.length>60&&(i=i.slice(0,59)+"‚Ä¶"),i.startsWith("Kontostand ")?i=i.substring(11):i.startsWith("Depotwert ")&&(i=i.substring(10)));return i==null||i===""?l():i}function X(e,t,n=[],r={}){const{sortable:i=!1,defaultSort:o}=r||{},c=(o==null?void 0:o.key)??"",l=(o==null?void 0:o.dir)==="desc"?"desc":"asc",a=p=>p==null?"":String(p).replace(/&/g,"&amp;").replace(/"/g,"&quot;");let u="<table><thead><tr>";t.forEach(p=>{const f=p.align==="right"?' class="align-right"':"";i&&p.key?u+=`<th${f} data-sort-key="${p.key}">${p.label}</th>`:u+=`<th${f}>${p.label}</th>`}),u+="</tr></thead><tbody>",e.forEach(p=>{u+="<tr>",t.forEach(f=>{const b=f.align==="right"?' class="align-right"':"";u+=`<td${b}>${I(f.key,p[f.key],p)}</td>`}),u+="</tr>"});const s={},d={};t.forEach(p=>{if(n.includes(p.key)){let f=0,b=!1;e.forEach(m=>{const S=m[p.key];typeof S=="number"&&Number.isFinite(S)&&(f+=S,b=!0)}),s[p.key]=b?f:null,d[p.key]={hasValue:b}}});const h=s.gain_abs??null;if(h!=null){const p=s.purchase_value??null;if(p!=null&&p>0)s.gain_pct=h/p*100;else{const f=s.current_value??null;f!=null&&f!==0&&(s.gain_pct=h/(f-h)*100)}}const g=Number.isFinite(s.gain_pct??NaN)?s.gain_pct:null;let y="",v="neutral";if(g!=null&&(y=`${W(g)}¬†%`,g>0?v="positive":g<0&&(v="negative")),u+='<tr class="footer-row">',t.forEach((p,f)=>{const b=p.align==="right"?' class="align-right"':"";if(f===0){u+=`<td${b}>Summe</td>`;return}if(s[p.key]!=null){let S="";p.key==="gain_abs"&&y&&(S=` data-gain-pct="${a(y)}" data-gain-sign="${a(v)}"`),u+=`<td${b}${S}>${I(p.key,s[p.key],void 0,d[p.key])}</td>`;return}if(p.key==="gain_pct"&&s.gain_pct!=null){u+=`<td${b}>${I("gain_pct",s.gain_pct,void 0,d[p.key])}</td>`;return}const m=d[p.key]??{hasValue:!1};u+=`<td${b}>${I(p.key,null,void 0,m)}</td>`}),u+="</tr>",u+="</tbody></table>",i)try{const p=document.createElement("template");p.innerHTML=u.trim();const f=p.content.querySelector("table");if(f)return f.classList.add("sortable-table"),c&&(f.dataset.defaultSort=c,f.dataset.defaultDir=l),f.outerHTML}catch(p){console.warn("makeTable(sortable): Injection fehlgeschlagen:",p)}return u}function ft(e,t){const n=document.createElement("div");return n.className="header-card",n.innerHTML=`
    <div class="header-content">
      <button id="nav-left" class="nav-arrow" aria-label="Vorherige Seite">
        <svg viewBox="0 0 24 24">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
        </svg>
      </button>
      <h1 id="headerTitle">${e}</h1>
      <button id="nav-right" class="nav-arrow" aria-label="N√§chste Seite">
        <svg viewBox="0 0 24 24">
          <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
        </svg>
      </button>
    </div>
    <div id="headerMeta" class="meta">${t}</div>
  `,n}function W(e,t=2,n=2){return(Number.isNaN(e)?0:e).toLocaleString("de-DE",{minimumFractionDigits:t,maximumFractionDigits:n})}function Ge(e){const t=Number.isNaN(e)?0:e;let n="neutral";return t>0?n="positive":t<0&&(n="negative"),`<span class="${n}">${W(t)}&nbsp;‚Ç¨</span>`}function ht(e){const t=Number.isNaN(e)?0:e;let n="neutral";return t>0?n="positive":t<0&&(n="negative"),`<span class="${n}">${W(t)}&nbsp;%</span>`}function pt(e,t,n="asc",r=!1){if(!e)return[];const i=e.querySelector("tbody");if(!i)return[];const o=i.querySelector("tr.footer-row"),c=Array.from(i.querySelectorAll("tr")).filter(s=>s!==o);let l=-1;if(r)l={name:0,current_holdings:1,purchase_value:2,current_value:3,gain_abs:4,gain_pct:5}[t];else{const s=Array.from(e.querySelectorAll("thead th"));for(let d=0;d<s.length;d++)if(s[d].getAttribute("data-sort-key")===t){l=d;break}}if(l==null||l<0)return c;const a=s=>{if(s==null)return NaN;const d=s.replace(/\u00A0/g," ").replace(/[%‚Ç¨]/g,"").replace(/\./g,"").replace(/,/g,".").replace(/[^\d.-]/g,"").trim();if(!d)return NaN;const h=parseFloat(d);return Number.isFinite(h)?h:NaN};c.sort((s,d)=>{const h=s.cells.item(l),g=d.cells.item(l),y=((h==null?void 0:h.textContent)??"").trim(),v=((g==null?void 0:g.textContent)??"").trim(),p=a(y),f=a(v);let b;const m=/[0-9]/.test(y)||/[0-9]/.test(v);return!Number.isNaN(p)&&!Number.isNaN(f)&&m?b=p-f:b=y.localeCompare(v,"de",{sensitivity:"base"}),n==="asc"?b:-b}),c.forEach(s=>i.appendChild(s)),o&&i.appendChild(o),e.querySelectorAll("thead th.sort-active").forEach(s=>{s.classList.remove("sort-active","dir-asc","dir-desc")});const u=e.querySelector(`thead th[data-sort-key="${t}"]`);return u&&u.classList.add("sort-active",n==="asc"?"dir-asc":"dir-desc"),c}function O(e,t){var r,i,o,c,l,a,u,s;let n=((r=t==null?void 0:t.config)==null?void 0:r.entry_id)??(t==null?void 0:t.entry_id)??((c=(o=(i=t==null?void 0:t.config)==null?void 0:i._panel_custom)==null?void 0:o.config)==null?void 0:c.entry_id)??void 0;if(!n&&(e!=null&&e.panels)){const d=e.panels,h=d.ppreader??d.pp_reader??Object.values(d).find(g=>(g==null?void 0:g.webcomponent_name)==="pp-reader-panel");n=((l=h==null?void 0:h.config)==null?void 0:l.entry_id)??(h==null?void 0:h.entry_id)??((s=(u=(a=h==null?void 0:h.config)==null?void 0:a._panel_custom)==null?void 0:u.config)==null?void 0:s.entry_id)??void 0}return n??void 0}function Xe(e,t){return O(e,t)}async function an(e,t){if(!e)throw new Error("fetchAccountsWS: fehlendes hass");const n=O(e,t);if(!n)throw new Error("fetchAccountsWS: fehlendes entry_id");return e.connection.sendMessagePromise({type:"pp_reader/get_accounts",entry_id:n})}async function sn(e,t){if(!e)throw new Error("fetchLastFileUpdateWS: fehlendes hass");const n=O(e,t);if(!n)throw new Error("fetchLastFileUpdateWS: fehlendes entry_id");const r=await e.connection.sendMessagePromise({type:"pp_reader/get_last_file_update",entry_id:n});if(typeof r=="string")return r;const i=r==null?void 0:r.last_file_update;return typeof i=="string"?i:""}async function ln(e,t){if(!e)throw new Error("fetchPortfoliosWS: fehlendes hass");const n=O(e,t);if(!n)throw new Error("fetchPortfoliosWS: fehlendes entry_id");return e.connection.sendMessagePromise({type:"pp_reader/get_portfolio_data",entry_id:n})}async function gt(e,t,n){if(!e)throw new Error("fetchPortfolioPositionsWS: fehlendes hass");const r=O(e,t);if(!r)throw new Error("fetchPortfolioPositionsWS: fehlendes entry_id");if(!n)throw new Error("fetchPortfolioPositionsWS: fehlendes portfolio_uuid");return e.connection.sendMessagePromise({type:"pp_reader/get_portfolio_positions",entry_id:r,portfolio_uuid:n})}async function cn(e,t,n){if(!e)throw new Error("fetchSecuritySnapshotWS: fehlendes hass");const r=O(e,t);if(!r)throw new Error("fetchSecuritySnapshotWS: fehlendes entry_id");if(!n)throw new Error("fetchSecuritySnapshotWS: fehlendes securityUuid");return e.connection.sendMessagePromise({type:"pp_reader/get_security_snapshot",entry_id:r,security_uuid:n})}async function bt(e,t,n,r={}){if(!e)throw new Error("fetchSecurityHistoryWS: fehlendes hass");const i=O(e,t);if(!i)throw new Error("fetchSecurityHistoryWS: fehlendes entry_id");if(!n)throw new Error("fetchSecurityHistoryWS: fehlendes securityUuid");const o={type:"pp_reader/get_security_history",entry_id:i,security_uuid:n},{startDate:c,endDate:l,start_date:a,end_date:u}=r||{},s=c??a;s!=null&&(o.start_date=s);const d=l??u;return d!=null&&(o.end_date=d),e.connection.sendMessagePromise(o)}const un=500,dn=10,fn="pp-reader:portfolio-positions-updated";function Ee(){return window.__ppReaderPendingPositions||(window.__ppReaderPendingPositions=new Map),window.__ppReaderPendingPositions}function hn(){return window.__ppReaderPendingRetryMeta||(window.__ppReaderPendingRetryMeta=new Map),window.__ppReaderPendingRetryMeta}function pn(e,t){return`<div class="error">${typeof e=="string"?e:String(e??"Unbekannter Fehler")} <button class="retry-pos" data-portfolio="${t}">Erneut laden</button></div>`}function gn(e,t,n){const r=e.querySelector("table.sortable-positions");if(!r)return;const i=e.dataset.sortKey||r.dataset.defaultSort||"name",c=(e.dataset.sortDir||r.dataset.defaultDir||"asc")==="desc"?"desc":"asc";e.dataset.sortKey=i,e.dataset.sortDir=c;try{pt(r,i,c,!0)}catch(l){console.warn("restoreSortAndInit: sortTableRows Fehler:",l)}try{window.__ppReaderAttachPortfolioPositionsSorting&&window.__ppReaderAttachPortfolioPositionsSorting(t,n)}catch(l){console.warn("restoreSortAndInit: attachPortfolioPositionsSorting Fehler:",l)}try{window.__ppReaderAttachSecurityDetailListener&&window.__ppReaderAttachSecurityDetailListener(t,n)}catch(l){console.warn("restoreSortAndInit: attachSecurityDetailListener Fehler:",l)}}function mt(e,t,n,r){if(!e||!t)return{applied:!1,reason:"invalid"};const i=e.querySelector(`.portfolio-table .portfolio-details[data-portfolio="${t}"]`);if(!i)return{applied:!1,reason:"missing"};const o=i.querySelector(".positions-container");if(!o)return{applied:!1,reason:"missing"};if(i.classList.contains("hidden"))return{applied:!1,reason:"hidden"};if(r)return o.innerHTML=pn(r,t),{applied:!0};const c=o.dataset.sortKey,l=o.dataset.sortDir;return o.innerHTML=Sn(n),c&&(o.dataset.sortKey=c),l&&(o.dataset.sortDir=l),gn(o,e,t),{applied:!0}}function xe(e,t){const n=Ee(),r=n.get(t);if(!r)return!1;const i=mt(e,t,r.positions,r.error);return i.applied&&n.delete(t),i.applied}function yt(e){const t=Ee();let n=!1;for(const[r]of t)xe(e,r)&&(n=!0);return n}function _t(e,t){const n=hn(),r=n.get(t)??{attempts:0,timer:null};r.timer||(r.timer=setTimeout(()=>{r.timer=null,r.attempts+=1;const i=xe(e,t);i||r.attempts>=dn?(n.delete(t),i||Ee().delete(t)):_t(e,t)},un),n.set(t,r))}function bn(e,t){console.log("updateConfigsWS: Kontodaten-Update erhalten:",e);const n=Array.isArray(e)?e:[];if(!t)return;mn(n,t);const r=t.querySelector(".portfolio-table table"),i=r?Array.from(r.querySelectorAll("tbody tr:not(.footer-row)")).map(o=>{const c=o.cells.item(2),l=(c==null?void 0:c.textContent)??"",a=parseFloat(l.replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""));return{current_value:Number.isFinite(a)?a:0}}):[];wt(n,i,t)}function mn(e,t){const n=t.querySelector(".account-table"),r=t.querySelector(".fx-account-table"),i=e.filter(c=>(c.currency_code||"EUR")==="EUR"),o=e.filter(c=>(c.currency_code||"EUR")!=="EUR");n?n.innerHTML=X(i,[{key:"name",label:"Name"},{key:"balance",label:"Kontostand (EUR)",align:"right"}],["balance"]):console.warn("updateAccountTable: .account-table nicht gefunden."),r?r.innerHTML=X(o.map(c=>({...c,fx_display:`${(c.orig_balance??0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}¬†${c.currency_code}`})),[{key:"name",label:"Name"},{key:"fx_display",label:"Betrag (FX)"},{key:"balance",label:"EUR",align:"right"}],["balance"]):o.length&&console.warn("updateAccountTable: .fx-account-table nicht gefunden, obwohl FX-Konten vorhanden sind.")}function yn(e,t){if(!Array.isArray(e)){console.warn("handlePortfolioUpdate: Update ist kein Array:",e);return}try{console.debug("handlePortfolioUpdate: payload=",e)}catch{}if(!t)return;const n=t.querySelector(".portfolio-table table")||t.querySelector("table.expandable-portfolio-table");if(!n){!t.querySelector(".portfolio-table")&&(t.querySelector(".security-range-selector")||t.querySelector(".security-detail-placeholder"))?console.debug("handlePortfolioUpdate: √úbersicht nicht aktiv ‚Äì Update wird sp√§ter angewendet."):console.warn("handlePortfolioUpdate: Keine Portfolio-Tabelle gefunden.");return}const r=n.tBodies.item(0)??n.querySelector("tbody");if(!r){console.warn("handlePortfolioUpdate: Kein <tbody> in Tabelle.");return}const i=a=>{if(window.Intl)try{return new Intl.NumberFormat(navigator.language||"de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(a)}catch{}return(Math.round(a*100)/100).toFixed(2).replace(".",",")},o=new Map(Array.from(r.querySelectorAll("tr.portfolio-row")).filter(a=>{var u;return!!((u=a.dataset)!=null&&u.portfolio)}).map(a=>[a.dataset.portfolio,a]));let c=0;const l=a=>{const u=Number.isFinite(a)?Number(a):0;try{return u.toLocaleString("de-DE")}catch{return u.toString()}};for(const a of e){const u=a==null?void 0:a.uuid;if(typeof u!="string"||!u)continue;const s=o.get(u);if(!s||s.cells.length<3)continue;const d=s.cells.item(1),h=s.cells.item(2),g=s.cells.item(3),y=s.cells.item(4);if(!d||!h)continue;const v=Number(a.position_count??a.count??0),p=Number(a.current_value??a.value??0),f=Number(a.purchase_sum??a.purchaseSum??0),b=p-f,m=f>0?b/f*100:0,S=U(h.textContent);U(d.textContent)!==v&&(d.textContent=l(v)),Math.abs(S-p)>=.005&&(h.textContent=`${i(p)} ‚Ç¨`,s.classList.add("flash-update"),setTimeout(()=>s.classList.remove("flash-update"),800)),g&&(g.innerHTML=vt(b),g.dataset.gainPct=Number.isFinite(m)?`${i(m)} %`:"‚Äî",g.dataset.gainSign=Number.isFinite(m)?m>0?"positive":m<0?"negative":"neutral":"neutral"),y&&(y.innerHTML=St(m)),s.dataset.positionCount=String(v),s.dataset.currentValue=String(p),s.dataset.purchaseSum=String(f),s.dataset.gainAbs=String(b),s.dataset.gainPct=String(m),c+=1}console.debug(c===0?"handlePortfolioUpdate: Keine passenden Zeilen gefunden / keine √Ñnderungen.":`handlePortfolioUpdate: ${c} Zeile(n) gepatcht.`);try{wn(n)}catch(a){console.warn("handlePortfolioUpdate: Fehler bei Summen-Neuberechnung:",a)}try{const a=(...y)=>{for(const v of y){if(!v)continue;const p=t.querySelector(v);if(p)return p}return null},u=a(".account-table table",".accounts-eur-table table",".accounts-table table"),s=a(".fx-account-table table",".accounts-fx-table table"),d=(y,v)=>{if(!y)return[];const p=y.querySelectorAll("tbody tr.account-row");return(p.length?Array.from(p):Array.from(y.querySelectorAll("tbody tr:not(.footer-row)"))).map(b=>{const m=v?b.cells.item(2):b.cells.item(1);return{balance:U(m==null?void 0:m.textContent)}})},h=[...d(u,!1),...d(s,!0)],g=Array.from(n.querySelectorAll("tbody tr.portfolio-row")).map(y=>{var b,m;const v=U((b=y.cells.item(2))==null?void 0:b.textContent),p=U((m=y.cells.item(3))==null?void 0:m.textContent),f=v-p;return{current_value:v,purchase_sum:f}});wt(h,g,t)}catch(a){console.warn("handlePortfolioUpdate: Fehler bei Total-Neuberechnung:",a)}}function _n(e){if(!e||typeof e!="object")return null;const t=e.portfolio_uuid;if(typeof t=="string"&&t)return t;const n=e.portfolioUuid;return typeof n=="string"&&n?n:null}function je(e,t){const n=_n(e);if(!n)return console.warn("handlePortfolioPositionsUpdate: Ung√ºltiges Update:",e),!1;const r=e==null?void 0:e.error,i=Array.isArray(e==null?void 0:e.positions)?e.positions.filter(l=>!!l):[];try{const l=window.__ppReaderPortfolioPositionsCache;l&&typeof l.set=="function"&&!r&&l.set(n,i)}catch(l){console.warn("handlePortfolioPositionsUpdate: Positions-Cache konnte nicht aktualisiert werden:",l)}const o=mt(t,n,i,r),c=Ee();if(o.applied?c.delete(n):(c.set(n,{positions:i,error:r}),o.reason!=="hidden"&&_t(t,n)),!r&&i.length>0){const l=Array.from(new Set(i.map(a=>a==null?void 0:a.security_uuid).filter(a=>typeof a=="string"&&a.length>0)));if(l.length&&typeof window<"u")try{window.dispatchEvent(new CustomEvent(fn,{detail:{portfolioUuid:n,securityUuids:l}}))}catch(a){console.warn("handlePortfolioPositionsUpdate: Dispatch des Portfolio-Events fehlgeschlagen",a)}}return!0}function vn(e,t){if(Array.isArray(e)){let n=!1;for(const r of e)je(r,t)&&(n=!0);!n&&e.length&&console.warn("handlePortfolioPositionsUpdate: Kein g√ºltiges Element im Array:",e);return}je(e,t)}function Sn(e){try{if(window.__ppReaderRenderPositionsTable)return window.__ppReaderRenderPositionsTable(e)}catch{}if(!e||!e.length)return'<div class="no-positions">Keine Positionen vorhanden.</div>';const t=e.map(r=>({name:r.name,current_holdings:r.current_holdings,purchase_value:r.purchase_value,current_value:r.current_value,gain_abs:r.gain_abs,gain_pct:r.gain_pct})),n=X(t,[{key:"name",label:"Wertpapier"},{key:"current_holdings",label:"Bestand",align:"right"},{key:"purchase_value",label:"Kaufwert",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"+/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}],["purchase_value","current_value","gain_abs"]);try{const r=document.createElement("template");r.innerHTML=n.trim();const i=r.content.querySelector("table");if(i){i.classList.add("sortable-positions");const o=i.querySelectorAll("thead th"),c=["name","current_holdings","purchase_value","current_value","gain_abs","gain_pct"];if(o.forEach((a,u)=>{const s=c[u];s&&(a.setAttribute("data-sort-key",s),a.classList.add("sortable-col"))}),i.querySelectorAll("tbody tr").forEach((a,u)=>{if(a.classList.contains("footer-row"))return;const s=e[u];s!=null&&s.security_uuid&&(a.dataset.security=s.security_uuid),a.classList.add("position-row")}),i.dataset.defaultSort="name",i.dataset.defaultDir="asc",window.__ppReaderApplyGainPctMetadata)try{window.__ppReaderApplyGainPctMetadata(i)}catch(a){console.warn("renderPositionsTableInline: applyGainPctMetadata failed",a)}else i.querySelectorAll("tbody tr").forEach(u=>{var y,v;const s=(y=u.cells)==null?void 0:y[4],d=(v=u.cells)==null?void 0:v[5];if(!s||!d)return;const h=(d.textContent||"").trim()||"‚Äî";let g="neutral";d.querySelector(".positive")?g="positive":d.querySelector(".negative")&&(g="negative"),s.dataset.gainPct=h,s.dataset.gainSign=g});return i.outerHTML}}catch(r){console.warn("renderPositionsTableInline: Sortier-Metadaten Injection fehlgeschlagen:",r)}return n}window.__ppReaderFlushPendingPositions||(window.__ppReaderFlushPendingPositions=(e,t)=>xe(e,t));window.__ppReaderFlushAllPendingPositions||(window.__ppReaderFlushAllPendingPositions=e=>yt(e));function wn(e){var s,d;if(!e)return;try{const h=window.__ppReaderUpdatePortfolioFooter;if(typeof h=="function"){h(e);return}}catch(h){console.warn("updatePortfolioFooter: global Helper schlug fehl:",h)}const t=Array.from(e.querySelectorAll("tbody tr.portfolio-row"));let n=0,r=0,i=0,o=0;t.forEach(h=>{var N,F,w,P,E,R,A;const g=Number((N=h.dataset)==null?void 0:N.positionCount),y=Number.isFinite(g)?g:parseInt((((F=h.cells.item(1))==null?void 0:F.textContent)||"").replace(/\./g,""),10)||0,v=Number((w=h.dataset)==null?void 0:w.currentValue),p=Number.isFinite(v)?v:U((P=h.cells.item(2))==null?void 0:P.textContent),f=Number((E=h.dataset)==null?void 0:E.gainAbs),b=Number.isFinite(f)?f:U((R=h.cells.item(3))==null?void 0:R.textContent),m=Number((A=h.dataset)==null?void 0:A.purchaseSum),S=Number.isFinite(m)?m:p-b;o+=y,n+=p,r+=b,i+=S}),i<=0&&(i=n-r);const c=i>0?r/i*100:0;let l=e.querySelector("tr.footer-row");l||(l=document.createElement("tr"),l.className="footer-row",(s=e.querySelector("tbody"))==null||s.appendChild(l));const a=Math.round(o).toLocaleString("de-DE");l.innerHTML=`
    <td>Summe</td>
    <td class="align-right">${a}</td>
    <td class="align-right">${j(n)}&nbsp;‚Ç¨</td>
    <td class="align-right">${vt(r)}</td>
    <td class="align-right">${St(c)}</td>
  `;const u=(d=l.cells)==null?void 0:d[3];u&&(u.dataset.gainPct=Number.isFinite(c)?`${j(c)} %`:"‚Äî",u.dataset.gainSign=Number.isFinite(c)?c>0?"positive":c<0?"negative":"neutral":"neutral"),l.dataset.positionCount=String(Math.round(o)),l.dataset.currentValue=String(n),l.dataset.purchaseSum=String(i),l.dataset.gainAbs=String(r),l.dataset.gainPct=String(c)}function j(e){return(Number.isNaN(e)?0:e).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}function vt(e){return`<span class="${e>=0?"positive":"negative"}">${j(e)}&nbsp;‚Ç¨</span>`}function St(e){return`<span class="${e>=0?"positive":"negative"}">${j(e)}&nbsp;%</span>`}function wt(e,t,n){const r=n||document,i=(Array.isArray(e)?e:[]).reduce((u,s)=>{const d=s!=null&&typeof s=="object"?s.balance??s.current_value??s.value??0:s,h=Number(d);return u+(Number.isFinite(h)?h:0)},0),o=(Array.isArray(t)?t:[]).reduce((u,s)=>{const d=s!=null&&typeof s=="object"?s.current_value??s.value??0:s,h=Number(d);return u+(Number.isFinite(h)?h:0)},0),c=i+o,l=r==null?void 0:r.querySelector("#headerMeta");if(!l){console.warn("updateTotalWealth: #headerMeta nicht gefunden.");return}const a=l.querySelector("strong")||l.querySelector(".total-wealth-value");a?a.textContent=`${j(c)}¬†‚Ç¨`:l.textContent=`üí∞ Gesamtverm√∂gen: ${j(c)}¬†‚Ç¨`,l.dataset.totalWealthEur=String(c)}function Pn(e,t){const n=typeof e=="string"?e:e&&e.last_file_update||"";if(!t){console.warn("handleLastFileUpdate: root fehlt");return}let r=t.querySelector(".footer-card .last-file-update")||t.querySelector(".last-file-update");if(!r){const i=t.querySelector(".footer-card .meta")||t.querySelector("#headerMeta")||t.querySelector(".header-card .meta")||t.querySelector(".header-card");if(!i){console.warn("handleLastFileUpdate: Kein Einf√ºgepunkt gefunden.");return}r=document.createElement("div"),r.className="last-file-update",i.appendChild(r)}r.closest(".footer-card")?r.innerHTML=n?`üìÇ Letzte Aktualisierung der Datei: <strong>${n}</strong>`:"üìÇ Letzte Aktualisierung der Datei: <strong>Unbekannt</strong>":r.textContent=n?`üìÇ Letzte Aktualisierung: ${n}`:"üìÇ Letzte Aktualisierung: Unbekannt"}function An(e){if(!e)return;const t=e.querySelector("table.sortable-positions");if(!t)return;const n=e.dataset.sortKey||t.dataset.defaultSort||"name",i=(e.dataset.sortDir||t.dataset.defaultDir||"asc")==="desc"?"desc":"asc";e.dataset.sortKey=n,e.dataset.sortDir=i,pt(t,n,i,!0)}window.__ppReaderReapplyPositionsSort=An;function U(e){return e==null?0:parseFloat(String(e).replace(/\u00A0/g," ").replace(/[‚Ç¨%]/g,"").replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""))||0}const Nn=["name","current_holdings","purchase_value","current_value","gain_abs","gain_pct"];function Le(e){return Nn.includes(e)}function Re(e){return e==="asc"||e==="desc"}let _e=null,ve=null;const H=new Map,Ze=1e6;function re(e){const t=Number(e);return Number.isFinite(t)?t:0}function ge(e){const t=re(e);return Math.round(t*100)/100}function Fn(e){const t=re(e);return Math.round(t*Ze)/Ze}function Pt(e){if(!e)return[];const t=[];for(const n of H.values())if(!(!Array.isArray(n)||n.length===0))for(const r of n){const i=typeof(r==null?void 0:r.security_uuid)=="string"?r.security_uuid:null;r&&i===e&&t.push(r)}return t}function At(e){const t=Pt(e);return t.length?t.map(n=>({...n})):[]}function Nt(e){const t=Pt(e);if(!t.length||!e)return null;let n="",r=0,i=0,o=0;for(const u of t){const s=u==null?void 0:u.name;!n&&typeof s=="string"&&(n=s),r+=re(u==null?void 0:u.current_holdings),i+=re(u==null?void 0:u.purchase_value),o+=re(u==null?void 0:u.current_value)}const c=o-i,l=i>0?c/i*100:0,a=r>0?o/r:null;return{security_uuid:e,name:n,total_holdings:Fn(r),purchase_value_eur:ge(i),current_value_eur:ge(o),gain_abs_eur:ge(c),gain_pct:Math.round(l*100)/100,last_price_eur:a!=null?ge(a):null,source:"cache"}}H.getSecuritySnapshot=Nt;H.getSecurityPositions=At;window.__ppReaderPortfolioPositionsCache=H;window.__ppReaderGetSecuritySnapshotFromCache||(window.__ppReaderGetSecuritySnapshotFromCache=Nt);window.__ppReaderGetSecurityPositionsFromCache||(window.__ppReaderGetSecurityPositionsFromCache=At);const Se=new Set;function Ft(e){if(!e)return;Array.from(e.querySelectorAll("tbody tr")).forEach(n=>{var l,a;const r=((l=n.cells)==null?void 0:l[4])??null,i=((a=n.cells)==null?void 0:a[5])??null;if(!r||!i)return;const o=(i.textContent||"").trim()||"‚Äî";let c="neutral";i.querySelector(".positive")?c="positive":i.querySelector(".negative")&&(c="negative"),r.dataset.gainPct=o,r.dataset.gainSign=c})}window.__ppReaderApplyGainPctMetadata||(window.__ppReaderApplyGainPctMetadata=e=>Ft(e));function se(e){if(!e||e.length===0)return'<div class="no-positions">Keine Positionen vorhanden.</div>';const t=[{key:"name",label:"Wertpapier"},{key:"current_holdings",label:"Bestand",align:"right"},{key:"purchase_value",label:"Kaufwert",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"+/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}],n=e.map(i=>({name:typeof i.name=="string"?i.name:i.name!=null?String(i.name):"",current_holdings:typeof i.current_holdings=="number"||typeof i.current_holdings=="string"?i.current_holdings:null,purchase_value:typeof i.purchase_value=="number"||typeof i.purchase_value=="string"?i.purchase_value:null,current_value:typeof i.current_value=="number"||typeof i.current_value=="string"?i.current_value:null,gain_abs:typeof i.gain_abs=="number"||typeof i.gain_abs=="string"?i.gain_abs:null,gain_pct:typeof i.gain_pct=="number"||typeof i.gain_pct=="string"?i.gain_pct:null})),r=X(n,t,["purchase_value","current_value","gain_abs"]);try{const i=document.createElement("template");i.innerHTML=r.trim();const o=i.content.querySelector("table");if(o){o.classList.add("sortable-positions");const c=o.querySelectorAll("thead th");return t.forEach((a,u)=>{const s=c[u];s&&(s.setAttribute("data-sort-key",a.key),s.classList.add("sortable-col"))}),o.querySelectorAll("tbody tr").forEach((a,u)=>{if(a.classList.contains("footer-row"))return;const s=e[u];if(!s)return;const d=typeof s.security_uuid=="string"?s.security_uuid:null;d&&(a.dataset.security=d),a.classList.add("position-row")}),o.dataset.defaultSort="name",o.dataset.defaultDir="asc",Ft(o),o.outerHTML}}catch(i){console.warn("renderPositionsTable: Konnte Sortier-Metadaten nicht injizieren:",i)}return r}window.__ppReaderRenderPositionsTable=se;function En(e,t){if(!t)return;const n=e.querySelector(`.portfolio-details[data-portfolio="${t}"]`);if(!n)return;const r=n.querySelector(".positions-container");!r||r.__ppReaderSecurityClickBound||(r.__ppReaderSecurityClickBound=!0,r.addEventListener("click",i=>{const o=i.target;if(!(o instanceof Element))return;const c=o.closest("button, a");if(c&&r.contains(c))return;const l=o.closest("tr[data-security]");if(!l||!r.contains(l))return;const a=l.getAttribute("data-security");if(a)try{en(a)||console.warn("attachSecurityDetailDelegation: Detail-Tab konnte nicht ge√∂ffnet werden f√ºr",a)}catch(u){console.error("attachSecurityDetailDelegation: Fehler beim √ñffnen des Detail-Tabs",u)}}))}function le(e,t){En(e,t)}window.__ppReaderAttachSecurityDetailListener||(window.__ppReaderAttachSecurityDetailListener=le);function Et(e){console.debug("buildExpandablePortfolioTable: render",e.length,"portfolios");const t=f=>f==null?"":String(f).replace(/&/g,"&amp;").replace(/"/g,"&quot;");let n='<table class="expandable-portfolio-table"><thead><tr>';[{key:"name",label:"Name"},{key:"position_count",label:"Anzahl Positionen",align:"right"},{key:"current_value",label:"Aktueller Wert",align:"right"},{key:"gain_abs",label:"Gesamt +/-",align:"right"},{key:"gain_pct",label:"%",align:"right"}].forEach(f=>{const b=f.align==="right"?' class="align-right"':"";n+=`<th${b}>${f.label}</th>`}),n+="</tr></thead><tbody>",e.forEach(f=>{if(!f||!f.uuid)return;const b=Number.isFinite(f.position_count)?f.position_count:0,m=Number.isFinite(f.purchase_sum)?f.purchase_sum:0,S=f.hasValue!==!1,N=S&&typeof f.current_value=="number"&&Number.isFinite(f.current_value)?f.current_value:null,F=S&&typeof f.gain_abs=="number"&&Number.isFinite(f.gain_abs)?f.gain_abs:S&&typeof f.current_value=="number"&&Number.isFinite(f.current_value)?f.current_value-m:null,w=S&&typeof f.gain_pct=="number"&&Number.isFinite(f.gain_pct)?f.gain_pct:S&&m>0&&typeof N=="number"?(N-m)/m*100:null,P=Se.has(f.uuid),E=P?"portfolio-toggle expanded":"portfolio-toggle",R=`portfolio-details-${f.uuid}`,A={fx_unavailable:!S,current_value:N,gain_abs:F,gain_pct:w},D={hasValue:S},_=I("current_value",A.current_value,A,D),x=I("gain_abs",A.gain_abs,A,D),T=I("gain_pct",A.gain_pct,A,D),k=S&&typeof w=="number"&&Number.isFinite(w)?`${W(w)} %`:"",he=S&&typeof w=="number"&&Number.isFinite(w)?w>0?"positive":w<0?"negative":"neutral":"",Y=S&&typeof N=="number"&&Number.isFinite(N)?N:"",De=S&&typeof F=="number"&&Number.isFinite(F)?F:"",J=S&&typeof w=="number"&&Number.isFinite(w)?w:"";let pe="";k&&(pe=` data-gain-pct="${t(k)}" data-gain-sign="${t(he)}"`),n+=`<tr class="portfolio-row"
                data-portfolio="${f.uuid}"
                data-position-count="${b}"
                data-current-value="${t(Y)}"
                data-purchase-sum="${t(m)}"
                data-gain-abs="${t(De)}"
                data-gain-pct="${t(J)}"
                data-has-value="${S?"true":"false"}">`,n+=`<td>
        <button type="button"
                class="${E}"
                data-portfolio="${f.uuid}"
                aria-expanded="${P?"true":"false"}"
                aria-controls="${R}">
          <span class="caret">${P?"‚ñº":"‚ñ∂"}</span>
          <span class="portfolio-name">${f.name}</span>
        </button>
      </td>`,n+=`<td class="align-right">${b}</td>`,n+=`<td class="align-right">${_}</td>`,n+=`<td class="align-right"${pe}>${x}</td>`,n+=`<td class="align-right gain-pct-cell">${T}</td>`,n+="</tr>",n+=`<tr class="portfolio-details${P?"":" hidden"}"
                data-portfolio="${f.uuid}"
                id="${R}"
                role="region"
                aria-label="Positionen f√ºr ${f.name}">
      <td colspan="5">
        <div class="positions-container">${P?H.has(f.uuid)?se(H.get(f.uuid)??[]):'<div class="loading">Lade Positionen...</div>':""}</div>
      </td>
    </tr>`});const i=e.filter(f=>f&&f.hasValue!==!1),o=e.reduce((f,b)=>f+(Number.isFinite(b==null?void 0:b.position_count)?b.position_count:0),0),c=i.reduce((f,b)=>typeof b.current_value=="number"&&Number.isFinite(b.current_value)?f+b.current_value:f,0),l=i.reduce((f,b)=>typeof b.purchase_sum=="number"&&Number.isFinite(b.purchase_sum)?f+b.purchase_sum:f,0),a=i.reduce((f,b)=>{const m=typeof b.current_value=="number"&&Number.isFinite(b.current_value)?b.current_value:0,S=typeof b.purchase_sum=="number"&&Number.isFinite(b.purchase_sum)?b.purchase_sum:0;return f+(m-S)},0),u=i.length===e.length,s=u&&l>0?a/l*100:null,d={fx_unavailable:!u,current_value:u?c:null,gain_abs:u?a:null,gain_pct:u?s:null},h={hasValue:u},g=I("current_value",d.current_value,d,h),y=I("gain_abs",d.gain_abs,d,h),v=I("gain_pct",d.gain_pct,d,h);let p="";if(u&&typeof s=="number"&&Number.isFinite(s)){const f=`${W(s)} %`,b=s>0?"positive":s<0?"negative":"neutral";p=` data-gain-pct="${t(f)}" data-gain-sign="${t(b)}"`}return n+=`<tr class="footer-row"
    data-position-count="${o}"
    data-current-value="${t(u?c:"")}"
    data-purchase-sum="${t(u?l:"")}"
    data-gain-abs="${t(u?a:"")}"
    data-gain-pct="${t(u&&typeof s=="number"&&Number.isFinite(s)?s:"")}"
    data-has-value="${u?"true":"false"}">
    <td>Summe</td>
    <td class="align-right">${Math.round(o).toLocaleString("de-DE")}</td>
    <td class="align-right">${g}</td>
    <td class="align-right"${p}>${y}</td>
    <td class="align-right gain-pct-cell">${v}</td>
  </tr>`,n+="</tbody></table>",n}function xn(e){if(e instanceof HTMLTableElement)return e;if(e&&"querySelector"in e){const t=e.querySelector("table.expandable-portfolio-table");if(t)return t;const n=e.querySelector(".portfolio-table table");if(n)return n;const r=e.querySelector("table");if(r)return r}return document.querySelector(".portfolio-table table.expandable-portfolio-table")||document.querySelector(".portfolio-table table")}function be(e){if(e===void 0)return null;const t=Number(e);return Number.isFinite(t)?t:null}function Ce(e){if(!e)return 0;const t=e.textContent||"";if(!t)return 0;const n=t.replace(/[^0-9,.-]/g,"").replace(/\./g,"").replace(",","."),r=Number.parseFloat(n);return Number.isFinite(r)?r:0}function xt(e){var b;const t=xn(e);if(!t)return;const n=(b=t.tBodies)==null?void 0:b[0];if(!n)return;const r=Array.from(n.querySelectorAll("tr.portfolio-row"));if(!r.length)return;let i=0,o=0,c=0,l=0,a=0;for(const m of r){const S=m.dataset.hasValue,N=!(S==="false"||S==="0"||S===""||S==null),F=be(m.dataset.positionCount)??Ce(m.cells.item(1));if(i+=F,!N){a+=1;continue}const w=be(m.dataset.currentValue)??Ce(m.cells.item(2)),P=be(m.dataset.gainAbs)??Ce(m.cells.item(3)),E=be(m.dataset.purchaseSum),R=E??w-P;o+=w,l+=P,c+=R}const u=a===0;!u&&c>0&&(c=o-l),u&&c<=0&&(c=o-l);const s=u&&c>0?l/c*100:null;let d=Array.from(n.children).find(m=>m instanceof HTMLTableRowElement&&m.classList.contains("footer-row"));d||(d=document.createElement("tr"),d.classList.add("footer-row"),n.appendChild(d));const h=Math.round(i).toLocaleString("de-DE"),g=(m="Wert nicht verf√ºgbar")=>`<span class="missing-value" role="note" aria-label="${m}" title="${m}">‚Äî</span>`,y="Teilweise fehlende Wechselkurse ‚Äì Wert unbekannt",v=u?`${W(o)}&nbsp;‚Ç¨`:g(y),p=u?Ge(l):g(y),f=u&&s!=null?ht(s):g(y);d.innerHTML=`
    <td>Summe</td>
    <td class="align-right">${h}</td>
    <td class="align-right">${v}</td>
    <td class="align-right">${p}</td>
    <td class="align-right">${f}</td>
  `,d.dataset.positionCount=String(Math.round(i)),d.dataset.currentValue=u?String(o):"",d.dataset.purchaseSum=u?String(c):"",d.dataset.gainAbs=u?String(l):"",d.dataset.gainPct=u&&typeof s=="number"?String(s):"",d.dataset.hasValue=u?"true":"false"}window.__ppReaderUpdatePortfolioFooter=xt;function ce(e,t){if(!t)return;const n=e.querySelector(`.portfolio-details[data-portfolio="${t}"]`);if(!n)return;const r=n.querySelector(".positions-container");if(!r)return;const i=r.querySelector("table.sortable-positions");if(!i||i.__ppReaderSortingBound)return;i.__ppReaderSortingBound=!0;const o=(h,g)=>{const y=i.querySelector("tbody");if(!y)return;const v=Array.from(y.querySelectorAll("tr")).filter(m=>!m.classList.contains("footer-row")),p=y.querySelector("tr.footer-row"),f=m=>{if(m==null)return 0;const S=m.replace(/\u00A0/g," ").replace(/[%‚Ç¨]/g,"").replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,""),N=Number.parseFloat(S);return Number.isFinite(N)?N:0};v.sort((m,S)=>{var R,A,D,_;const F={name:0,current_holdings:1,purchase_value:2,current_value:3,gain_abs:4,gain_pct:5}[h];if(F==null)return 0;const w=((A=(R=m.cells[F])==null?void 0:R.textContent)==null?void 0:A.trim())??"",P=((_=(D=S.cells[F])==null?void 0:D.textContent)==null?void 0:_.trim())??"";let E;return h==="name"?E=w.localeCompare(P,"de",{sensitivity:"base"}):E=f(w)-f(P),g==="asc"?E:-E}),i.querySelectorAll("thead th.sort-active").forEach(m=>{m.classList.remove("sort-active","dir-asc","dir-desc")});const b=i.querySelector(`thead th[data-sort-key="${h}"]`);b&&b.classList.add("sort-active",g==="asc"?"dir-asc":"dir-desc"),v.forEach(m=>y.appendChild(m)),p&&y.appendChild(p)},c=r.dataset.sortKey,l=r.dataset.sortDir,a=i.dataset.defaultSort,u=i.dataset.defaultDir,s=Le(c)?c:Le(a)?a:"name",d=Re(l)?l:Re(u)?u:"asc";o(s,d),i.addEventListener("click",h=>{const g=h.target;if(!(g instanceof Element))return;const y=g.closest("th[data-sort-key]");if(!y||!i.contains(y))return;const v=y.getAttribute("data-sort-key");if(!Le(v))return;let p="asc";r.dataset.sortKey===v&&(p=(Re(r.dataset.sortDir)?r.dataset.sortDir:"asc")==="asc"?"desc":"asc"),r.dataset.sortKey=v,r.dataset.sortDir=p,o(v,p)})}window.__ppReaderAttachPortfolioPositionsSorting||(window.__ppReaderAttachPortfolioPositionsSorting=ce);async function Dn(e,t,n){if(!e||!_e||!ve)return;const r=t||n.querySelector(`.portfolio-details[data-portfolio="${e}"] .positions-container`);if(!r)return;const i=r.closest(".portfolio-details");if(!(i&&i.classList.contains("hidden"))){r.innerHTML='<div class="loading">Neu laden...</div>';try{const o=await gt(_e,ve,e);if(o.error){const l=typeof o.error=="string"?o.error:String(o.error);r.innerHTML=`<div class="error">${l} <button class="retry-pos" data-portfolio="${e}">Erneut laden</button></div>`;return}const c=o.positions??[];H.set(e,c),r.innerHTML=se(c);try{ce(n,e)}catch(l){console.warn("attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:",l)}try{le(n,e)}catch(l){console.warn("reloadPortfolioPositions: Security-Listener konnte nicht gebunden werden:",l)}}catch(o){const c=o instanceof Error?o.message:String(o);r.innerHTML=`<div class="error">Fehler: ${c} <button class="retry-pos" data-portfolio="${e}">Retry</button></div>`}}}async function Ln(e,t,n=3e3,r=50){const i=performance.now();return new Promise(o=>{const c=()=>{const l=e.querySelector(t);if(l)return o(l);if(performance.now()-i>n)return o(null);setTimeout(c,r)};c()})}function Ue(e){if(!e)return;const t=(e.__ppReaderAttachToken??0)+1;e.__ppReaderAttachToken=t,e.__ppReaderAttachInProgress=!0,(async()=>{try{const n=await Ln(e,".portfolio-table");if(t!==e.__ppReaderAttachToken)return;if(!n){console.warn("attachPortfolioToggleHandler: .portfolio-table nicht gefunden (Timeout)");return}if(n.querySelectorAll(".portfolio-toggle").length===0&&console.debug("attachPortfolioToggleHandler: Noch keine Buttons ‚Äì evtl. Recovery sp√§ter"),n.__ppReaderPortfolioToggleBound)return;n.__ppReaderPortfolioToggleBound=!0,console.debug("attachPortfolioToggleHandler: Listener registriert"),n.addEventListener("click",async i=>{try{const o=i.target;if(!(o instanceof Element))return;const c=o.closest(".retry-pos");if(c&&n.contains(c)){const h=c.getAttribute("data-portfolio");if(h){const g=e.querySelector(`.portfolio-details[data-portfolio="${h}"]`),y=g==null?void 0:g.querySelector(".positions-container");await Dn(h,y??null,e)}return}const l=o.closest(".portfolio-toggle");if(!l||!n.contains(l))return;const a=l.getAttribute("data-portfolio");if(!a)return;const u=e.querySelector(`.portfolio-details[data-portfolio="${a}"]`);if(!u)return;const s=l.querySelector(".caret");if(u.classList.contains("hidden")){u.classList.remove("hidden"),l.classList.add("expanded"),l.setAttribute("aria-expanded","true"),s&&(s.textContent="‚ñº"),Se.add(a);let h=!1;try{h=xe(e,a)}catch(g){console.warn("attachPortfolioToggleHandler: Pending-Flush fehlgeschlagen:",g)}if(!h&&window.__ppReaderFlushPendingPositions)try{h=window.__ppReaderFlushPendingPositions(e,a)}catch(g){console.warn("attachPortfolioToggleHandler: Global Pending-Flush fehlgeschlagen:",g)}if(H.has(a)){const g=u.querySelector(".positions-container");if(g){g.innerHTML=se(H.get(a)??[]),ce(e,a);try{le(e,a)}catch(y){console.warn("attachPortfolioToggleHandler: Security-Listener (Cache) Fehler:",y)}}}else{const g=u.querySelector(".positions-container");g&&(g.innerHTML='<div class="loading">Lade Positionen...</div>');try{const y=await gt(_e,ve,a);if(y.error){const p=typeof y.error=="string"?y.error:String(y.error);g&&(g.innerHTML=`<div class="error">${p} <button class="retry-pos" data-portfolio="${a}">Erneut laden</button></div>`);return}const v=y.positions??[];if(H.set(a,v),g){g.innerHTML=se(v);try{ce(e,a)}catch(p){console.warn("attachPortfolioToggleHandler: Sort-Init (Lazy) fehlgeschlagen:",p)}try{le(e,a)}catch(p){console.warn("attachPortfolioToggleHandler: Security-Listener konnte nicht gebunden werden:",p)}}}catch(y){const v=y instanceof Error?y.message:String(y),p=u.querySelector(".positions-container");p&&(p.innerHTML=`<div class="error">Fehler beim Laden: ${v} <button class="retry-pos" data-portfolio="${a}">Retry</button></div>`),console.error("Fehler beim Lazy Load f√ºr",a,y)}}}else u.classList.add("hidden"),l.classList.remove("expanded"),l.setAttribute("aria-expanded","false"),s&&(s.textContent="‚ñ∂"),Se.delete(a)}catch(o){console.error("attachPortfolioToggleHandler: Ungefangener Fehler im Click-Handler",o)}})}finally{t===e.__ppReaderAttachToken&&(e.__ppReaderAttachInProgress=!1)}})()}function Rn(e){const t=e.querySelector(".expandable-portfolio-table");t&&(t.__ppReaderPortfolioFallbackBound||(t.__ppReaderPortfolioFallbackBound=!0,t.addEventListener("click",n=>{const r=n.target;if(!(r instanceof Element)||!r.closest(".portfolio-toggle"))return;const o=e.querySelector(".portfolio-table");o!=null&&o.__ppReaderPortfolioToggleBound||(console.debug("Fallback-Listener aktiv ‚Äì re-attach Hauptlistener"),Ue(e))})))}async function Dt(e,t,n){var R,A,D;_e=t??null,ve=n??null,console.debug("renderDashboard: start ‚Äì panelConfig:",n==null?void 0:n.config,"derived entry_id?",(D=(A=(R=n==null?void 0:n.config)==null?void 0:R._panel_custom)==null?void 0:A.config)==null?void 0:D.entry_id);const r=await an(t,n),o=((r==null?void 0:r.accounts)??[]).map(_=>({name:_.name??"‚Äî",balance:typeof _.balance=="number"&&Number.isFinite(_.balance)?_.balance:null,currency_code:_.currency_code??null,orig_balance:typeof _.orig_balance=="number"&&Number.isFinite(_.orig_balance)?_.orig_balance:null,fx_unavailable:!!_.fx_unavailable})),l=((await ln(t,n)).portfolios??[]).map(_=>{const x=typeof _.uuid=="string"&&_.uuid?_.uuid:null;if(!x)return null;const T=typeof _.missing_value_positions=="number"?_.missing_value_positions:0,k=_.has_current_value!=null?!!_.has_current_value:T===0,he=typeof _.current_value=="number"?_.current_value:0,Y=typeof _.purchase_sum=="number"?_.purchase_sum:0,De=k?he:null,J=k?he-Y:null,pe=k&&Y>0&&J!=null?J/Y*100:null;return{uuid:x,name:_.name??"Unbenanntes Depot",position_count:typeof _.position_count=="number"?_.position_count:0,current_value:De,purchase_sum:Y,gain_abs:J,gain_pct:pe,hasValue:k,missing_value_positions:T,fx_unavailable:!k}}).filter(_=>_!==null);let a="";try{a=await sn(t,n)}catch{a=""}const u=o.reduce((_,x)=>_+(x.balance??0),0),s=l.some(_=>_.hasValue===!1),d=l.reduce((_,x)=>x.hasValue&&typeof x.current_value=="number"&&Number.isFinite(x.current_value)?_+x.current_value:_,0),h=u+d,g="Teilweise fehlende Wechselkurse ‚Äì Gesamtverm√∂gen unbekannt",y=s?`<span class="missing-value" role="note" aria-label="${g}" title="${g}">‚Äî</span>`:`${W(h)}&nbsp;‚Ç¨`,v=s?`<span class="total-wealth-note">${g}</span>`:"",p=`
    <div class="header-meta-row">
      üí∞ Gesamtverm√∂gen: <strong class="total-wealth-value">${y}</strong>${v}
    </div>
  `,f=ft("√úbersicht",p),b=Et(l),m=o.filter(_=>(_.currency_code??"EUR")==="EUR"),S=o.filter(_=>(_.currency_code??"EUR")!=="EUR"),F=S.some(_=>_.fx_unavailable)?`
        <p class="table-note" role="note">
          <span class="table-note__icon" aria-hidden="true">‚ö†Ô∏è</span>
          <span>Wechselkurse konnten nicht geladen werden. EUR-Werte werden derzeit nicht angezeigt.</span>
        </p>
      `:"",w=`
    <div class="card">
      <h2>Liquidit√§t</h2>
      <div class="scroll-container account-table">
        ${X(m.map(_=>({name:_.name,balance:_.balance??null})),[{key:"name",label:"Name"},{key:"balance",label:"Kontostand (EUR)",align:"right"}],["balance"])}
      </div>
    </div>
    ${S.length?`
      <div class="card">
        <h2>Fremdw√§hrungen</h2>
        <div class="scroll-container fx-account-table">
          ${X(S.map(_=>({name:_.name,fx_display:`${(_.orig_balance??0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}&nbsp;${_.currency_code??""}`,balance:_.balance??null})),[{key:"name",label:"Name"},{key:"fx_display",label:"Betrag (FX)"},{key:"balance",label:"EUR",align:"right"}],["balance"])}
        </div>
        ${F}
      </div>`:""}
  `,P=`
    <div class="card footer-card">
      <div class="meta">
        <div class="last-file-update">
          üìÇ Letzte Aktualisierung der Datei: <strong>${a||"Unbekannt"}</strong>
        </div>
      </div>
    </div>
  `,E=`
    ${f.outerHTML}
    <div class="card">
      <h2>Investment</h2>
      <div class="scroll-container portfolio-table">
        ${b}
      </div>
    </div>
    ${w}
    ${P}
  `;return Cn(e,l),E}function Cn(e,t){if(!e)return;const n=()=>{try{const i=e,o=i.querySelector(".portfolio-table");o&&o.querySelectorAll(".portfolio-toggle").length===0&&(console.debug("Recovery: Tabelle ohne Buttons ‚Äì erneuter Aufbau"),o.innerHTML=Et(t)),Ue(e),Rn(e),Se.forEach(c=>{try{H.has(c)&&(ce(e,c),le(e,c))}catch(l){console.warn("Init-Sortierung f√ºr expandiertes Depot fehlgeschlagen:",c,l)}});try{xt(i)}catch(c){console.warn("renderDashboard: Footer-Summe konnte nicht aktualisiert werden:",c)}try{yt(e)}catch(c){console.warn("renderDashboard: Pending-Positions konnten nicht angewendet werden:",c)}console.debug("renderDashboard: portfolio-toggle Buttons:",i.querySelectorAll(".portfolio-toggle").length)}catch(i){console.error("renderDashboard: Fehler bei Recovery/Listener",i)}},r=typeof requestAnimationFrame=="function"?i=>requestAnimationFrame(i):i=>setTimeout(i,0);r(()=>r(n))}const Tn="http://www.w3.org/2000/svg",ie=640,oe=260,te={top:12,right:16,bottom:24,left:16},ne="var(--pp-reader-chart-line, #3f51b5)",Me="var(--pp-reader-chart-area, rgba(63, 81, 181, 0.12))",Je="0.75rem",Lt="var(--pp-reader-chart-baseline, rgba(96, 125, 139, 0.75))",Rt="6 4",$n=24*60*60*1e3;function G(e,t={}){const n=document.createElementNS(Tn,e);return Object.entries(t).forEach(([r,i])=>{i!=null&&n.setAttribute(r,String(i))}),n}function Mn(e,t=null){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"&&e.trim()!==""){const n=Number.parseFloat(e);if(Number.isFinite(n))return n}return t}function kn(e,t){if(e instanceof Date){const n=e.getTime();return Number.isFinite(n)?n:t}if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"){const n=Date.parse(e);if(Number.isFinite(n))return n}return t}const Ct=e=>{if(e&&typeof e=="object"&&"date"in e)return e.date},Tt=e=>{if(e&&typeof e=="object"&&"close"in e)return e.close},$t=(e,t,n)=>{if(Number.isFinite(e)){const r=new Date(e);if(!Number.isNaN(r.getTime()))return r.toLocaleDateString("de-DE")}if(t&&typeof t=="object"&&"date"in t){const r=t.date;return r!=null?String(r):""}return e==null?"":String(e)},Ve=(e,t,n)=>(Number.isFinite(e)?e:Number.parseFloat(String(e))||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}),Mt=({xFormatted:e,yFormatted:t})=>`
    <div class="chart-tooltip-date">${e}</div>
    <div class="chart-tooltip-value">${t}&nbsp;‚Ç¨</div>
  `;function kt(e){return e.__chartState||(e.__chartState={svg:null,areaPath:null,linePath:null,baselineLine:null,focusLine:null,focusCircle:null,overlay:null,tooltip:null,width:ie,height:oe,margin:{...te},series:[],points:[],range:null,xAccessor:Ct,yAccessor:Tt,xFormatter:$t,yFormatter:Ve,tooltipRenderer:Mt,color:ne,areaColor:Me,baseline:null,handlersAttached:!1}),e.__chartState}function B(e,t,n){return!Number.isFinite(e)||e<t?t:e>n?n:e}function Hn(e,t){if(!Array.isArray(e)||e.length===0)return"";const n=e.map((i,o)=>`${o===0?"M":"L"}${i.x.toFixed(2)} ${i.y.toFixed(2)}`).join(" "),r=`L${e[e.length-1].x.toFixed(2)} ${t.toFixed(2)} L${e[0].x.toFixed(2)} ${t.toFixed(2)} Z`;return`${n} ${r}`}function In(e){return!Array.isArray(e)||e.length===0?"":e.map((t,n)=>`${n===0?"M":"L"}${t.x.toFixed(2)} ${t.y.toFixed(2)}`).join(" ")}function qn(e){const{baselineLine:t,baseline:n}=e;if(!t)return;const r=(n==null?void 0:n.color)??Lt,i=(n==null?void 0:n.dashArray)??Rt;t.setAttribute("stroke",r),t.setAttribute("stroke-dasharray",i)}function Qe(e){const{baselineLine:t,baseline:n,range:r,margin:i,width:o}=e;if(!t)return;const c=n==null?void 0:n.value;if(!r||c==null||!Number.isFinite(c)){t.style.opacity="0";return}const{minY:l,maxY:a,boundedHeight:u}=r,s=Number.isFinite(l)?l:c,h=(Number.isFinite(a)?a:s+1)-s,g=h===0?.5:(c-s)/h,y=B(g,0,1),v=Math.max(u,0),p=i.top+(1-y)*v,f=Math.max(o-i.left-i.right,0),b=i.left,m=i.left+f;t.setAttribute("x1",b.toFixed(2)),t.setAttribute("x2",m.toFixed(2)),t.setAttribute("y1",p.toFixed(2)),t.setAttribute("y2",p.toFixed(2)),t.style.opacity="1"}function Wn(e,t,n){const{width:r,height:i,margin:o}=t,{xAccessor:c,yAccessor:l}=n;if(!Array.isArray(e)||e.length===0)return{points:[],range:null};const a=e.map((A,D)=>{const _=c(A,D),x=l(A,D),T=kn(_,D),k=Mn(x,Number.NaN);return Number.isFinite(k)?{index:D,data:A,xValue:T,yValue:k}:null}).filter(A=>!!A);if(a.length===0)return{points:[],range:null};const u=a.reduce((A,D)=>Math.min(A,D.xValue),a[0].xValue),s=a.reduce((A,D)=>Math.max(A,D.xValue),a[0].xValue),d=a.reduce((A,D)=>Math.min(A,D.yValue),a[0].yValue),h=a.reduce((A,D)=>Math.max(A,D.yValue),a[0].yValue),g=Math.max(r-o.left-o.right,1),y=Math.max(i-o.top-o.bottom,1),v=Number.isFinite(u)?u:0,p=Number.isFinite(s)?s:v+1,f=Number.isFinite(d)?d:0,b=Number.isFinite(h)?h:f+1,m=Math.max(2,Math.min(6,Math.round(Math.max(i-o.top-o.bottom,0)/60)||4)),{niceMin:S,niceMax:N}=On(f,b,m),F=Number.isFinite(S)?S:f,w=Number.isFinite(N)?N:b,P=p-v||1,E=w-F||1;return{points:a.map(A=>{const D=P===0?.5:(A.xValue-v)/P,_=E===0?.5:(A.yValue-F)/E,x=o.left+D*g,T=o.top+(1-_)*y;return{...A,x,y:T}}),range:{minX:v,maxX:p,minY:F,maxY:w,boundedWidth:g,boundedHeight:y}}}function Ht(e,t,n,r){e.width=Number.isFinite(t)?Number(t):ie,e.height=Number.isFinite(n)?Number(n):oe,e.margin={top:Number.isFinite(r==null?void 0:r.top)?Number(r==null?void 0:r.top):te.top,right:Number.isFinite(r==null?void 0:r.right)?Number(r==null?void 0:r.right):te.right,bottom:Number.isFinite(r==null?void 0:r.bottom)?Number(r==null?void 0:r.bottom):te.bottom,left:Number.isFinite(r==null?void 0:r.left)?Number(r==null?void 0:r.left):te.left}}function Gn(e,t){const n=e.xFormatter(t.xValue,t.data,t.index),r=e.yFormatter(t.yValue,t.data,t.index);return e.tooltipRenderer({point:t,xFormatted:n,yFormatted:r,data:t.data,index:t.index})}function Un(e,t,n){const{tooltip:r,width:i,margin:o,height:c}=e;if(!r)return;const l=c-o.bottom;r.style.visibility="visible",r.style.opacity="1";const a=r.offsetWidth||0,u=r.offsetHeight||0,s=B(t.x-a/2,o.left,i-o.right-a),d=Math.max(l-u,0),h=12,g=Number.isFinite(n)?B(n??0,o.top,l):t.y;let y=g+h;y>d&&(y=g-u-h),y=B(y,0,d),r.style.transform=`translate(${Math.round(s)}px, ${Math.round(y)}px)`}function me(e){const{tooltip:t,focusLine:n,focusCircle:r}=e;t&&(t.style.opacity="0",t.style.visibility="hidden"),n&&(n.style.opacity="0"),r&&(r.style.opacity="0")}function Vn(e,t){if(t.handlersAttached||!t.overlay)return;const n=i=>{if(!t.points||t.points.length===0||!t.svg){me(t);return}const o=t.svg.getBoundingClientRect(),c=i.clientX-o.left,l=i.clientY-o.top;let a=t.points[0],u=Math.abs(c-a.x);for(let s=1;s<t.points.length;s+=1){const d=t.points[s],h=Math.abs(c-d.x);h<u&&(u=h,a=d)}if(!a){me(t);return}t.focusCircle&&(t.focusCircle.setAttribute("cx",a.x.toFixed(2)),t.focusCircle.setAttribute("cy",a.y.toFixed(2)),t.focusCircle.style.opacity="1"),t.focusLine&&(t.focusLine.setAttribute("x1",a.x.toFixed(2)),t.focusLine.setAttribute("x2",a.x.toFixed(2)),t.focusLine.setAttribute("y1",t.margin.top.toFixed(2)),t.focusLine.setAttribute("y2",(t.height-t.margin.bottom).toFixed(2)),t.focusLine.style.opacity="1"),t.tooltip&&(t.tooltip.innerHTML=Gn(t,a),Un(t,a,l))},r=()=>{me(t)};t.overlay.addEventListener("pointermove",n),t.overlay.addEventListener("pointerenter",n),t.overlay.addEventListener("pointerleave",r),t.handlersAttached=!0,t.handlePointerMove=n,t.handlePointerLeave=r,e.addEventListener("pointercancel",r)}function Bn(e,t={}){if(!e)return console.error("renderLineChart: root element is required"),null;const n=document.createElement("div");n.className="line-chart-container",n.dataset.chartType="line",n.style.position="relative";const r=G("svg",{width:ie,height:oe,viewBox:`0 0 ${ie} ${oe}`,role:"img","aria-hidden":"true",focusable:"false"});r.classList.add("line-chart-svg");const i=G("path",{class:"line-chart-area",fill:Me,stroke:"none"}),o=G("line",{class:"line-chart-baseline",stroke:Lt,"stroke-width":1,"stroke-dasharray":Rt,opacity:0}),c=G("path",{class:"line-chart-path",fill:"none",stroke:ne,"stroke-width":2,"stroke-linecap":"round","stroke-linejoin":"round"}),l=G("line",{class:"line-chart-focus-line",stroke:ne,"stroke-width":1,"stroke-dasharray":"4 4",opacity:0}),a=G("circle",{class:"line-chart-focus-circle",r:4,fill:"#fff",stroke:ne,"stroke-width":2,opacity:0}),u=G("rect",{class:"line-chart-overlay",fill:"transparent",x:0,y:0,width:ie,height:oe});r.appendChild(i),r.appendChild(o),r.appendChild(c),r.appendChild(l),r.appendChild(a),r.appendChild(u),n.appendChild(r);const s=document.createElement("div");s.className="chart-tooltip",s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.pointerEvents="none",s.style.opacity="0",s.style.visibility="hidden",n.appendChild(s),e.appendChild(n);const d=kt(n);if(d.svg=r,d.areaPath=i,d.linePath=c,d.baselineLine=o,d.focusLine=l,d.focusCircle=a,d.overlay=u,d.tooltip=s,d.xAccessor=t.xAccessor??Ct,d.yAccessor=t.yAccessor??Tt,d.xFormatter=t.xFormatter??$t,d.yFormatter=t.yFormatter??Ve,d.tooltipRenderer=t.tooltipRenderer??Mt,d.color=t.color??ne,d.areaColor=t.areaColor??Me,d.baseline=t.baseline??null,d.handlersAttached=!1,!d.xAxis){const h=document.createElement("div");h.className="line-chart-axis line-chart-axis-x",h.style.position="absolute",h.style.left="0",h.style.right="0",h.style.bottom="0",h.style.pointerEvents="none",h.style.fontSize=Je,h.style.color="var(--secondary-text-color)",h.style.display="block",n.appendChild(h),d.xAxis=h}if(!d.yAxis){const h=document.createElement("div");h.className="line-chart-axis line-chart-axis-y",h.style.position="absolute",h.style.top="0",h.style.bottom="0",h.style.left="0",h.style.pointerEvents="none",h.style.fontSize=Je,h.style.color="var(--secondary-text-color)",h.style.display="block",n.appendChild(h),d.yAxis=h}return Ht(d,t.width,t.height,t.margin),d.linePath&&d.linePath.setAttribute("stroke",d.color),d.focusLine&&d.focusLine.setAttribute("stroke",d.color),d.focusCircle&&d.focusCircle.setAttribute("stroke",d.color),d.areaPath&&d.areaPath.setAttribute("fill",d.areaColor),It(n,t),Vn(n,d),n}function It(e,t={}){if(!e){console.error("updateLineChart: container element is required");return}const n=kt(e);if(!n.svg||!n.linePath||!n.overlay){console.error("updateLineChart: chart was not initialised with renderLineChart");return}t.xAccessor&&(n.xAccessor=t.xAccessor),t.yAccessor&&(n.yAccessor=t.yAccessor),t.xFormatter&&(n.xFormatter=t.xFormatter),t.yFormatter&&(n.yFormatter=t.yFormatter),t.tooltipRenderer&&(n.tooltipRenderer=t.tooltipRenderer),t.color&&(n.color=t.color,n.linePath.setAttribute("stroke",n.color),n.focusLine&&n.focusLine.setAttribute("stroke",n.color),n.focusCircle&&n.focusCircle.setAttribute("stroke",n.color)),t.areaColor&&(n.areaColor=t.areaColor,n.areaPath&&n.areaPath.setAttribute("fill",n.areaColor)),Object.prototype.hasOwnProperty.call(t,"baseline")&&(n.baseline=t.baseline??null),qn(n),Ht(n,t.width,t.height,t.margin);const{width:r,height:i,margin:o}=n;n.svg.setAttribute("width",String(r)),n.svg.setAttribute("height",String(i)),n.svg.setAttribute("viewBox",`0 0 ${r} ${i}`),n.overlay.setAttribute("x",o.left.toFixed(2)),n.overlay.setAttribute("y",o.top.toFixed(2)),n.overlay.setAttribute("width",Math.max(r-o.left-o.right,0).toFixed(2)),n.overlay.setAttribute("height",Math.max(i-o.top-o.bottom,0).toFixed(2));const c=Array.isArray(t.series)?t.series:n.series;n.series=Array.isArray(c)?[...c]:[];const{points:l,range:a}=Wn(n.series,n,{xAccessor:n.xAccessor,yAccessor:n.yAccessor});if(n.points=l,n.range=a,!l||l.length===0){n.linePath.setAttribute("d",""),n.areaPath&&n.areaPath.setAttribute("d",""),me(n),et(n),Qe(n);return}const u=In(l);if(n.linePath.setAttribute("d",u),n.areaPath&&a){const s=n.margin.top+a.boundedHeight,d=Hn(l,s);n.areaPath.setAttribute("d",d)}et(n),Qe(n)}function et(e){const{xAxis:t,yAxis:n,range:r,margin:i,height:o,yFormatter:c}=e;if(!t||!n)return;if(!r){t.innerHTML="",n.innerHTML="";return}const{minX:l,maxX:a,minY:u,maxY:s,boundedWidth:d,boundedHeight:h}=r,g=Number.isFinite(l)&&Number.isFinite(a)&&a>=l,y=Number.isFinite(u)&&Number.isFinite(s)&&s>=u,v=Math.max(d,0),p=Math.max(h,0);if(t.style.left=`${i.left}px`,t.style.width=`${v}px`,t.style.top=`${o-i.bottom+6}px`,t.innerHTML="",g&&v>0){const b=(a-l)/$n,m=Math.max(2,Math.min(6,Math.round(v/140)||4));Yn(e,l,a,m,b).forEach(({positionRatio:N,label:F})=>{const w=document.createElement("div");w.className="line-chart-axis-tick line-chart-axis-tick-x",w.style.position="absolute",w.style.bottom="0",w.style.transform="translateX(-50%)";const P=B(N,0,1);w.style.left=`${P*v}px`,w.textContent=F,t.appendChild(w)})}n.style.top=`${i.top}px`,n.style.height=`${p}px`;const f=Math.max(i.left-6,0);if(n.style.left="0",n.style.width=`${Math.max(f,0)}px`,n.innerHTML="",y&&p>0){const b=Math.max(2,Math.min(6,Math.round(p/60)||4)),m=zn(u,s,b),S=c??Ve;m.forEach(({value:N,positionRatio:F})=>{const w=document.createElement("div");w.className="line-chart-axis-tick line-chart-axis-tick-y",w.style.position="absolute",w.style.left="0";const E=(1-B(F,0,1))*p;w.style.top=`${E}px`,w.textContent=S(N,null,-1),n.appendChild(w)})}}function On(e,t,n=4){if(!Number.isFinite(e)||!Number.isFinite(t))return{niceMin:e,niceMax:t};const r=Math.max(2,n);if(t===e){const u=ke(Math.abs(e)||1);return{niceMin:e-u,niceMax:t+u}}const o=(t-e)/(r-1),c=ke(o),l=Math.floor(e/c)*c,a=Math.ceil(t/c)*c;return l===a?{niceMin:e,niceMax:t+c}:{niceMin:l,niceMax:a}}function Yn(e,t,n,r,i){if(!Number.isFinite(t)||!Number.isFinite(n)||n<t)return[];if(!Number.isFinite(i)||i<=0)return[{positionRatio:.5,label:tt(e,t,i||0)}];const o=Math.max(2,r),c=[],l=n-t;for(let a=0;a<o;a+=1){const u=o===1?.5:a/(o-1),s=t+u*l;c.push({positionRatio:u,label:tt(e,s,i)})}return c}function tt(e,t,n){const r=new Date(t);return Number.isFinite(r.getTime())?n>1095?String(r.getFullYear()):n>365?r.toLocaleDateString("de-DE",{year:"numeric",month:"short"}):n>90?r.toLocaleDateString("de-DE",{year:"2-digit",month:"short"}):n>30?r.toLocaleDateString("de-DE",{day:"2-digit",month:"short"}):r.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"}):e.xFormatter?e.xFormatter(t,null,-1):String(t)}function zn(e,t,n){if(!Number.isFinite(e)||!Number.isFinite(t))return[];if(t===e)return[{value:e,positionRatio:.5}];const r=t-e,i=Math.max(2,n),o=r/(i-1),c=ke(o),l=Math.floor(e/c)*c,a=Math.ceil(t/c)*c,u=[];for(let s=l;s<=a+c/2;s+=c){const d=(s-e)/(t-e);u.push({value:s,positionRatio:B(d,0,1)})}return u.length>i+2?u.filter((s,d)=>d%2===0):u}function ke(e){if(!Number.isFinite(e)||e===0)return 1;const t=Math.floor(Math.log10(Math.abs(e))),n=Math.abs(e)/10**t;let r;return n<=1?r=1:n<=2?r=2:n<=5?r=5:r=10,r*10**t}const Te={min:0,max:6},nt={min:2,max:4},Kn=1e8,Xn="1Y",qt=["1M","6M","1Y","5Y","ALL"],jn={"1M":30,"6M":182,"1Y":365,"5Y":1826,ALL:Number.POSITIVE_INFINITY},z=new Map,ye=new Map,ue=new Map,we=new Map,Wt="pp-reader:portfolio-positions-updated",ae=new Map;function Zn(e){const{fallbackUsed:t,flaggedAsCache:n}=e,r=[];return t&&r.push("Der aktuelle Snapshot konnte nicht geladen werden. Es werden die zuletzt gespeicherten Werte angezeigt."),n&&!t&&r.push("Der Snapshot ist vom Datenanbieter als Zwischenspeicherstand markiert."),`
    <div class="card warning-card stale-notice" role="status" aria-live="polite">
      <h2>Zwischengespeicherte Werte</h2>
      <p>${r.length?r.join(" "):"Die Daten stammen aus dem Zwischenspeicher."}</p>
      <p class="stale-notice__hint">Die angezeigten Betr√§ge k√∂nnen von den aktuellen Marktwerten abweichen. Laden Sie die Ansicht erneut, sobald eine Verbindung verf√ºgbar ist.</p>
    </div>
  `}function Gt(e,t){if(e){if(t){ue.set(e,t);return}ue.delete(e)}}function Jn(e){if(!e||typeof window>"u")return null;if(ue.has(e)){const t=ue.get(e)||null;if(t)return t}try{const t=window.__ppReaderGetSecuritySnapshotFromCache;if(typeof t=="function"){const n=t(e);if(n&&typeof n=="object"){const r=n;return Gt(e,r),r}}}catch(t){console.warn("getCachedSecuritySnapshot: Zugriff auf Cache fehlgeschlagen",t)}return null}function Ut(e){return z.has(e)||z.set(e,new Map),z.get(e)}function Vt(e){if(e&&z.has(e)){try{const t=z.get(e);t==null||t.clear()}catch(t){console.warn("invalidateHistoryCache: Konnte Cache nicht leeren",e,t)}z.delete(e)}}function Qn(e,t){if(!e||!t)return;const n=t.securityUuids;(Array.isArray(n)?n:[]).includes(e)&&Vt(e)}function er(e){if(!e||ae.has(e))return;const t=n=>{if(!(n instanceof CustomEvent))return;const r=n.detail;r&&Qn(e,r)};try{window.addEventListener(Wt,t),ae.set(e,t)}catch(n){console.error("ensureLiveUpdateSubscription: Registrierung fehlgeschlagen",n)}}function tr(e){if(!e||!ae.has(e))return;const t=ae.get(e);try{t&&window.removeEventListener(Wt,t)}catch(n){console.error("removeLiveUpdateSubscription: Entfernen des Listeners fehlgeschlagen",n)}ae.delete(e)}function nr(e){e&&(tr(e),Vt(e),ue.delete(e),we.delete(e))}function rt(e,t){if(!ye.has(e)){ye.set(e,{activeRange:t});return}const n=ye.get(e);n&&(n.activeRange=t)}function Bt(e){var t;return((t=ye.get(e))==null?void 0:t.activeRange)??Xn}function it(e){const t=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate());return Math.floor(t/864e5)}function rr(e){const t=new Date(e.getTime());return t.setUTCHours(0,0,0,0),t}function L(e){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"&&e.trim()!==""){const t=Number.parseFloat(e);if(Number.isFinite(t))return t}return null}function Ot(e){const t=rr(new Date),n=jn[e],r={end_date:it(t)};if(Number.isFinite(n)&&n>0){const i=new Date(t.getTime());i.setUTCDate(i.getUTCDate()-(n-1)),r.start_date=it(i)}return r}function ir(e){if(!e)return null;if(e instanceof Date&&!Number.isNaN(e.getTime()))return new Date(e.getTime());if(typeof e=="number"&&Number.isFinite(e)){const t=e*864e5;if(Number.isFinite(t))return new Date(t)}if(typeof e=="string"){const t=e.trim();if(/^\d{8}$/.test(t)){const r=Number.parseInt(t.slice(0,4),10),i=Number.parseInt(t.slice(4,6),10)-1,o=Number.parseInt(t.slice(6,8),10);if(Number.isFinite(r)&&Number.isFinite(i)&&Number.isFinite(o)){const c=new Date(Date.UTC(r,i,o));if(!Number.isNaN(c.getTime()))return c}}const n=Date.parse(t);if(Number.isFinite(n))return new Date(n)}return null}function Yt(e){return Array.isArray(e)?e.map(t=>{const n=L(t==null?void 0:t.close);return n==null?null:{date:ir(t==null?void 0:t.date)??(t==null?void 0:t.date),close:n/Kn}}).filter(t=>!!t):[]}function Be(e,t){const n=String((e==null?void 0:e.currency_code)||"").toUpperCase();if(!n||n==="EUR")return 1;const r=L(e==null?void 0:e.last_price_eur);if(r==null||r<=0)return null;const i=L(e==null?void 0:e.last_price_native);if(i!=null&&i>0)return r/i;const o=L(t);return o!=null&&o>0?r/o:null}function de(e){const t=L(e);if(t==null)return null;const n=Math.round(t*100)/100;return Object.is(n,-0)?0:n}function M(e){return typeof e=="number"&&Number.isFinite(e)}function Oe(e){return typeof e=="number"&&Number.isFinite(e)&&e>0}function or(e){if(e==null||Number.isNaN(e))return null;const t=Math.round(e*100)/100;return Object.is(t,-0)?0:t}function V(e,t){return!M(e)||!M(t)?null:e-t}function ar(e,t){return!M(e)||!Oe(t)?null:e*t}function sr(e,t,n,r){if(!M(e))return null;const i=ar(t,r);return i!=null?de(i*e):M(n)?de(n*e):null}function lr(e,t){return!Oe(t)||!M(e)?null:e/t}function Q(e,t){return!M(t)||t===0||!M(e)?null:or((e-t)/t*100)}function cr(e,t){var w;if(!e)return null;if(!t)return we.delete(e),null;const n=t.total_holdings_precise??t.total_holdings??null,r=L(n),i=L(t.purchase_value_eur),o=L(t.market_value_eur)??L(t.current_value_eur),c=L(t.average_purchase_price_native),l=lr(i,r),a=L(t.last_price_native)??L((w=t.last_price)==null?void 0:w.native)??null,u=L(t.last_price_eur),s=L(t.last_close_native),d=L(t.last_close_eur),h=Be(t,a),g=Oe(h)?h:null,y=M(r)?r:null,v=V(a,s),p=V(u,d),f=Q(a,s)??Q(u,d),b=sr(y,V(a,c),V(u,l),g),m=V(o,i),S=m!=null?de(m):b,N=Q(o,i)??Q(a,c)??Q(u,l),F={holdings:y,fxRate:g,purchaseValueEur:i,currentValueEur:o,averagePurchaseNative:c,averagePurchaseEur:l,dayPriceChangeNative:v,dayPriceChangeEur:p,dayChangePct:f,totalChangeEur:S,totalChangePct:N};return we.set(e,F),F}function ur(e){return e?we.get(e)??null:null}function zt(e,t,n){if(!Array.isArray(e)||e.length===0)return{periodGain:null,dailyGain:null};const i=L(t)??0,o=typeof n=="number"&&Number.isFinite(n)&&n>0?n:null;if(o==null)return{periodGain:null,dailyGain:null};const c=e[e.length-1],l=e[0],a=e.length>=2?e[e.length-2]:null,u=(c.close-l.close)*i*o,s=a?(c.close-a.close)*i*o:null;return{periodGain:de(u),dailyGain:de(s)}}function ot(e){return e==null||Number.isNaN(e)?'<span class="value neutral">‚Äî</span>':`<span class="value">${Ge(e)}</span>`}function Kt(e,t,n){const r=e||"";return`
    <div class="security-info-bar" data-range="${r}">
      <div class="security-info-item">
        <span class="label">Gesamt (${r||"Zeitraum"})</span>
        ${ot(t)}
      </div>
      <div class="security-info-item">
        <span class="label">Letzter Tag</span>
        ${ot(n)}
      </div>
    </div>
  `}function dr(e){return`
    <div class="security-range-selector" role="group" aria-label="Zeitraum">
      ${qt.map(n=>`
      <button
        type="button"
        class="security-range-button${n===e?" active":""}"
        data-range="${n}"
        aria-pressed="${n===e}"
      >
        ${n}
      </button>
    `).join(`
`)}
    </div>
  `}function Xt(e,t={status:"empty"}){const n=e||"";switch(t.status){case"loaded":return`
        <div
          class="history-chart"
          data-state="loaded"
          data-range="${n}"
          role="img"
          aria-label="Preisverlauf${n?` f√ºr ${n}`:""}"
        ></div>
      `;case"error":{const r=t!=null&&t.message?String(t.message):"Die historischen Daten konnten nicht geladen werden.";return`
        <div class="history-placeholder" data-state="error" data-range="${n}">
          <p>${r}</p>
        </div>
      `}case"empty":default:return`
        <div class="history-placeholder" data-state="empty" data-range="${n}">
          <p>F√ºr dieses Wertpapier liegen im Zeitraum ${n||"den gew√§hlten Zeitraum"} keine historischen Daten vor.</p>
        </div>
      `}}function fr(e){const t=L(e);if(t==null)return"‚Äî";const n=Math.abs(t%1)>0,r=n?2:Te.min,i=n?Te.max:Te.min;return t.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:i})}function Ye(e){const t=L(e);return t==null?"‚Äî":t.toLocaleString("de-DE",{minimumFractionDigits:nt.min,maximumFractionDigits:nt.max})}function hr(e,t){const n=Ye(e),r=`&nbsp;${t}`;return`<span class="${e>0?"positive":e<0?"negative":"neutral"}">${n}${r}</span>`}function pr(e,t=null){var D;if(!e)return'<div class="meta-error">Keine Snapshot-Daten verf√ºgbar.</div>';const n=e.currency_code||"EUR",r=(t==null?void 0:t.holdings)??e.total_holdings_precise??e.total_holdings,i=fr(r),o=e.last_price_native??((D=e.last_price)==null?void 0:D.native)??e.last_price_eur,c=L(o),l=Ye(o),a=l==="‚Äî"?null:`${l}${`&nbsp;${n}`}`,u=L(e.market_value_eur)??L(e.current_value_eur)??null,s=L(e.last_close_native),d=L(e.last_price_eur),h=L(e.last_close_eur),g=(t==null?void 0:t.dayPriceChangeNative)??V(c,s),y=(t==null?void 0:t.dayPriceChangeEur)??V(d,h),v=M(g)?g:y,p=M(g)?n:"EUR",f=(_,x="")=>{const T=["value"];return x&&T.push(...x.split(" ").filter(Boolean)),`<span class="${T.join(" ")}">${_}</span>`},b=(_="")=>{const x=["value--missing"];return _&&x.push(_),f("‚Äî",x.join(" "))},m=(_,x="")=>{if(!M(_))return b(x);const T=["value--gain"];return x&&T.push(x),f(Ge(_),T.join(" "))},S=(_,x="")=>{if(!M(_))return b(x);const T=["value--gain-percentage"];return x&&T.push(x),f(ht(_),T.join(" "))},N=a?f(a,"value--price"):b("value--price"),F=i==="‚Äî"?b("value--holdings"):f(i,"value--holdings"),w=M(u)?f(`${W(u)}&nbsp;‚Ç¨`,"value--market-value"):b("value--market-value"),P=M(v)?f(hr(v,p),"value--gain value--absolute"):b("value--absolute"),E=S(t==null?void 0:t.dayChangePct,"value--percentage"),R=m(t==null?void 0:t.totalChangeEur,"value--absolute"),A=S(t==null?void 0:t.totalChangePct,"value--percentage");return`
    <div class="security-meta-grid security-meta-grid--expanded">
      <div class="security-meta-item security-meta-item--price">
        <span class="label">Letzter Preis</span>
        <div class="value-group">${N}</div>
      </div>
      <div class="security-meta-item security-meta-item--day-change">
        <span class="label">Tages√§nderung</span>
        <div class="value-group">
          ${P}
          ${E}
        </div>
      </div>
      <div class="security-meta-item security-meta-item--total-change">
        <span class="label">Gesamt√§nderung</span>
        <div class="value-group">
          ${R}
          ${A}
        </div>
      </div>
      <div class="security-meta-item security-meta-item--holdings">
        <span class="label">Bestand</span>
        <div class="value-group">${F}</div>
      </div>
      <div class="security-meta-item security-meta-item--market-value">
        <span class="label">Marktwert (EUR)</span>
        <div class="value-group">${w}</div>
      </div>
    </div>
  `}function jt(e){if(!e)return null;if(typeof e=="string")return e;if(e instanceof Error)return e.message||null;try{return JSON.stringify(e)}catch{return String(e)}}function gr(e,t,{currency:n,baseline:r}={}){const i=e.clientWidth||e.offsetWidth||0,o=i>0?i:640,c=Math.min(Math.max(Math.floor(o*.55),220),420),l=(n||"").toUpperCase()||"EUR",a=M(r)?r:null;return{width:o,height:c,margin:{top:16,right:20,bottom:32,left:20},series:t,yFormatter:u=>Ye(u),tooltipRenderer:({xFormatted:u,yFormatted:s})=>`
      <div class="chart-tooltip-date">${u}</div>
      <div class="chart-tooltip-value">${s}&nbsp;${l}</div>
    `,baseline:a!=null?{value:a}:null}}const at=new WeakMap;function br(e,t,n={}){if(!e||!Array.isArray(t)||t.length===0)return;const r=gr(e,t,n);let i=at.get(e)||null;if(!i||!e.contains(i)){e.innerHTML="",i=Bn(e,r),i&&at.set(e,i);return}It(i,r)}function st(e,t){e&&(e.dataset.activeRange=t,e.querySelectorAll(".security-range-button").forEach(n=>{const i=n.dataset.range===t;n.classList.toggle("active",i),n.setAttribute("aria-pressed",i?"true":"false"),n.disabled=!1,n.classList.remove("loading")}))}function mr(e,t,n,r){const i=e.querySelector(".security-info-bar");if(!i||!i.parentElement)return;const o=document.createElement("div");o.innerHTML=Kt(t,n,r).trim();const c=o.firstElementChild;c&&i.parentElement.replaceChild(c,i)}function lt(e,t,n,r,i={}){const o=e.querySelector(".security-detail-placeholder");if(o&&(o.innerHTML=`
    <h2>Historie</h2>
    ${Xt(t,n)}
  `,(n==null?void 0:n.status)==="loaded"&&Array.isArray(r)&&r.length)){const c=o.querySelector(".history-chart");c&&requestAnimationFrame(()=>{br(c,r,i)})}}function yr(e){const{root:t,hass:n,panelConfig:r,securityUuid:i,snapshot:o,holdings:c,metrics:l,initialRange:a,initialHistory:u,initialHistoryState:s}=e;t&&setTimeout(()=>{const d=t.querySelector(".security-range-selector");if(!d)return;const h=Ut(i),g=l??ur(i),y=(g==null?void 0:g.holdings)??c;Array.isArray(u)&&(s==null?void 0:s.status)!=="error"&&h.set(a,u),er(i),rt(i,a),st(d,a),s&&lt(t,a,s,u,{currency:o==null?void 0:o.currency_code,baseline:(g==null?void 0:g.averagePurchaseNative)??null});const p=async f=>{if(!f||f===Bt(i))return;const b=d.querySelector(`.security-range-button[data-range="${f}"]`);b&&(b.disabled=!0,b.classList.add("loading"));let m=h.get(f)||null,S=null;if(m)S=m.length?{status:"loaded"}:{status:"empty"};else try{const E=Ot(f),R=await bt(n,r,i,E);m=Yt(R==null?void 0:R.prices),h.set(f,m),S=m.length?{status:"loaded"}:{status:"empty"}}catch(E){console.error("Range-Wechsel: Historie konnte nicht geladen werden",E),m=[],S={status:"error",message:jt(E)||"Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden."}}const N=m.length?m[m.length-1].close:o==null?void 0:o.last_price_native,F=Be(o,N),{periodGain:w,dailyGain:P}=zt(m,y,F);rt(i,f),st(d,f),mr(t,f,w,P),lt(t,f,S,m,{currency:o==null?void 0:o.currency_code,baseline:(g==null?void 0:g.averagePurchaseNative)??null})};d.addEventListener("click",f=>{var S;const b=(S=f.target)==null?void 0:S.closest(".security-range-button");if(!b||b.disabled)return;const{range:m}=b.dataset;!m||!qt.includes(m)||p(m)})},0)}async function _r(e,t,n,r){if(!r)return console.error("renderSecurityDetail: securityUuid fehlt"),'<div class="card"><h2>Fehler</h2><p>Kein Wertpapier angegeben.</p></div>';const i=Jn(r);let o=null,c=null;try{const P=await cn(t,n,r);P&&typeof P=="object"?o=P.snapshot&&typeof P.snapshot=="object"?P.snapshot:P:o=P}catch(P){console.error("renderSecurityDetail: Snapshot konnte nicht geladen werden",P),c=P instanceof Error?P.message:String(P)}const l=o||i,a=!!(i&&!o),u=((l==null?void 0:l.source)??"")==="cache";let s=null;r&&(Gt(r,l??null),s=cr(r,l??null));const d=l&&(a||u)?Zn({fallbackUsed:a,flaggedAsCache:u}):"",h=(l==null?void 0:l.name)||"Wertpapierdetails",g=ft(h,pr(l,s));if(c)return`
      ${g.outerHTML}
      ${d}
      <div class="card error-card">
        <h2>Fehler beim Laden</h2>
        <p>${c}</p>
      </div>
    `;const y=Bt(r),v=Ut(r);let p=v.has(y)?v.get(y)??null:null,f={status:"empty"};if(Array.isArray(p))f=p.length?{status:"loaded"}:{status:"empty"};else{p=[];try{const P=Ot(y),E=await bt(t,n,r,P);p=Yt(E==null?void 0:E.prices),v.set(y,p),f=p.length?{status:"loaded"}:{status:"empty"}}catch(P){console.error("renderSecurityDetail: Historie konnte nicht geladen werden",P),f={status:"error",message:jt(P)||"Die historischen Daten konnten aufgrund eines Fehlers nicht geladen werden."}}}const b=p.length>0?p[p.length-1].close:l==null?void 0:l.last_price_native,m=Be(l,b),S=(s==null?void 0:s.holdings)??(l==null?void 0:l.total_holdings)??0,{periodGain:N,dailyGain:F}=zt(p,S,m),w=Kt(y,N,F);return yr({root:e,hass:t,panelConfig:n,securityUuid:r,snapshot:l,holdings:S,metrics:s,initialRange:y,initialHistory:p,initialHistoryState:f}),`
    ${g.outerHTML}
    ${d}
    ${w}
    ${dr(y)}
    <div class="card security-detail-placeholder">
      <h2>Historie</h2>
      ${Xt(y,f)}
    </div>
  `}function vr(e){const{setSecurityDetailTabFactory:t}=e;if(typeof t!="function"){console.error("registerSecurityDetailTab: Ung√ºltige Factory-Funktion √ºbergeben");return}t(n=>({title:"Wertpapier",render:(r,i,o)=>_r(r,i,o,n),cleanup:()=>nr(n)}))}const Sr=on,He="pp-reader-sticky-anchor",Pe="overview",Ie="security:",wr=[{key:Pe,title:"Dashboard",render:Dt}],Z=new Map,fe=[],Ae=new Map;let qe=null,$e=!1,K=null,C=0,ee=null;function Ne(e){return typeof e=="object"&&e!==null}function Pr(e){return e==="accounts"||e==="last_file_update"||e==="portfolio_values"||e==="portfolio_positions"}function ct(e){const t=e.portfolio_uuid;if(typeof t=="string"&&t)return t;const n=e.portfolioUuid;return typeof n=="string"&&n?n:null}function Ar(e){if(!e)return null;if(Array.isArray(e)){for(const t of e)if(Ne(t)){const n=ct(t);if(n)return n}return null}return Ne(e)?ct(e):null}function Nr(e,t){switch(e){case"accounts":return{type:e,data:Array.isArray(t)?t:null};case"last_file_update":return typeof t=="string"?{type:e,data:t}:Ne(t)?{type:e,data:t}:{type:e,data:null};case"portfolio_values":return Array.isArray(t)?{type:e,data:t}:{type:e,data:null};case"portfolio_positions":return Array.isArray(t)?{type:e,data:t}:Ne(t)?{type:e,data:t}:{type:e,data:null};default:return null}}function ze(e){return typeof e!="string"||!e.startsWith(Ie)?null:e.slice(Ie.length)||null}function Fr(){if(!K)return!1;const e=en(K);return e||(K=null),e}function q(){const e=fe.map(t=>Z.get(t)).filter(t=>!!t);return[...wr,...e]}function Zt(){try{const e=Ke();e&&typeof e.rememberScrollPosition=="function"&&e.rememberScrollPosition()}catch(e){console.warn("rememberCurrentPageScroll: konnte Scroll-Position nicht sichern",e)}}function ut(e){const t=q();return!t.length||e<0?0:e>=t.length?t.length-1:e}async function Er(e,t,n,r){const i=q(),o=ut(e);if(o===C){e>C&&Fr();return}Zt();const c=i[C],l=ze(c==null?void 0:c.key);let a=o;if(l){const u=i[o];if((u==null?void 0:u.key)===Pe&&Cr(l,{suppressRender:!0})){const h=q().findIndex(g=>g.key===Pe);a=h>=0?h:0}}if(!$e){$e=!0;try{C=ut(a);const u=C;await tn(t,n,r),Rr(u)}catch(u){console.error("navigateToPage: Fehler beim Rendern des Tabs",u)}finally{$e=!1}}}function Fe(e,t,n,r){Er(C+e,t,n,r)}function xr(e,t){if(!e||!t||typeof t.render!="function"){console.error("registerDetailTab: Ung√ºltiger Tab-Descriptor",e,t);return}const n=ze(e);if(n){const i=Ae.get(n);i&&i!==e&&Jt(i)}const r={...t,key:e};Z.set(e,r),n&&Ae.set(n,e),fe.includes(e)||fe.push(e)}function Jt(e){if(!e)return;const t=Z.get(e);if(t&&typeof t.cleanup=="function")try{t.cleanup({key:e})}catch(i){console.error("unregisterDetailTab: Fehler beim Ausf√ºhren von cleanup",i)}Z.delete(e);const n=fe.indexOf(e);n>=0&&fe.splice(n,1);const r=ze(e);r&&Ae.get(r)===e&&Ae.delete(r)}function Dr(e){return Z.has(e)}function dt(e){return Z.get(e)??null}function Lr(e){if(e!=null&&typeof e!="function"){console.error("setSecurityDetailTabFactory: Erwartet Funktion oder null",e);return}qe=e??null}function Qt(e){return`${Ie}${e}`}function Ke(){const e=window.__ppReaderDashboardElements;if(e instanceof Set){for(const r of e)if(r&&r.isConnected)return r}const t=document.querySelector("pp-reader-dashboard");if(t)return t;const n=document.querySelectorAll("pp-reader-panel");for(const r of n){if(!r||!r.shadowRoot)continue;const i=r.shadowRoot.querySelector("pp-reader-dashboard");if(i)return i}return null}function We(){const e=Ke();if(!e){console.warn("requestDashboardRender: Kein pp-reader-dashboard Element gefunden");return}if(typeof e._renderIfInitialized=="function"){e._renderIfInitialized();return}typeof e._render=="function"&&e._render()}function Rr(e){const t=Ke();if(t&&typeof t.handleExternalRender=="function")try{t.handleExternalRender(e)}catch(n){console.warn("notifyExternalRender: Fehler beim Synchronisieren des Dashboards",n)}}function en(e){if(!e)return console.error("openSecurityDetail: Ung√ºltige securityUuid",e),!1;const t=Qt(e);let n=dt(t);if(!n&&typeof qe=="function")try{const o=qe(e);o&&typeof o.render=="function"?(xr(t,o),n=dt(t)):console.error("openSecurityDetail: Factory lieferte ung√ºltigen Descriptor",o)}catch(o){console.error("openSecurityDetail: Fehler beim Erzeugen des Tab-Descriptors",o)}if(!n)return console.warn(`openSecurityDetail: Kein Detail-Tab f√ºr ${e} verf√ºgbar`),!1;Zt();let i=q().findIndex(o=>o.key===t);return i===-1&&(i=q().findIndex(c=>c.key===t),i===-1)?(console.error("openSecurityDetail: Tab nach Registrierung nicht auffindbar"),!1):(C=i,K=null,We(),!0)}function Cr(e,t={}){if(!e)return console.error("closeSecurityDetail: Ung√ºltige securityUuid",e),!1;const{suppressRender:n=!1}=t,r=Qt(e);if(!Dr(r))return!1;const o=q().findIndex(a=>a.key===r),c=o===C;Jt(r);const l=q();if(!l.length)return C=0,n||We(),!0;if(K=e,c){const a=l.findIndex(u=>u.key===Pe);a>=0?C=a:C=Math.min(Math.max(o-1,0),l.length-1)}else C>=l.length&&(C=Math.max(0,l.length-1));return n||We(),!0}async function tn(e,t,n){let r=n;if(!r&&(t!=null&&t.panels)){const s=t.panels;r=s.ppreader||s.pp_reader||Object.values(s).find(d=>(d==null?void 0:d.webcomponent_name)==="pp-reader-panel")||null}const i=q();C>=i.length&&(C=Math.max(0,i.length-1));const o=i[C];if(!o||typeof o.render!="function"){console.error("renderTab: Kein g√ºltiger Tab oder keine render-Methode gefunden!");return}let c;try{c=await o.render(e,t,r)}catch(s){console.error("renderTab: Fehler beim Rendern des Tabs:",s),e.innerHTML=`<div class="card"><h2>Fehler</h2><pre>${(s==null?void 0:s.message)||s}</pre></div>`;return}if(!e){console.error("renderTab: Root-Element nicht gefunden!");return}e.innerHTML=c??"",o.render===Dt&&Ue(e);const a=await new Promise(s=>{const d=window.setInterval(()=>{const h=e.querySelector(".header-card");h&&(clearInterval(d),s(h))},50)});if(!a){console.error("Header-Card nicht gefunden!");return}let u=e.querySelector(`#${He}`);if(!u){u=document.createElement("div"),u.id=He;const s=a.parentNode;s&&"insertBefore"in s&&s.insertBefore(u,a)}Mr(e,t,n),$r(e,t,n),Tr(e)}function Tr(e){const t=e.querySelector(".header-card"),n=e,r=e.querySelector(`#${He}`);if(!t||!n||!r){console.error("Fehlende Elemente f√ºr das Scrollverhalten: headerCard, scrollBorder oder anchor.");return}ee==null||ee.disconnect(),ee=new IntersectionObserver(([i])=>{i.isIntersecting?t.classList.remove("sticky"):t.classList.add("sticky")},{root:null,rootMargin:"0px 0px 0px 0px",threshold:0}),ee.observe(r)}function $r(e,t,n){const r=e.querySelector(".header-card");if(!r){console.error("Header-Card nicht gefunden!");return}Sr(r,()=>Fe(1,e,t,n),()=>Fe(-1,e,t,n))}function Mr(e,t,n){const r=e.querySelector(".header-card");if(!r){console.error("Header-Card nicht gefunden!");return}const i=r.querySelector("#nav-left"),o=r.querySelector("#nav-right");if(!i||!o){console.error("Navigationspfeile nicht gefunden!");return}i.addEventListener("click",()=>{Fe(-1,e,t,n)}),o.addEventListener("click",()=>{Fe(1,e,t,n)}),kr(r)}function kr(e){const t=e.querySelector("#nav-left"),n=e.querySelector("#nav-right");if(t&&(C===0?(t.disabled=!0,t.classList.add("disabled")):(t.disabled=!1,t.classList.remove("disabled"))),n){const r=q(),o=!(C===r.length-1)||!!K;n.disabled=!o,n.classList.toggle("disabled",!o)}}class Hr extends HTMLElement{constructor(){super();$(this,"_root");$(this,"_hass",null);$(this,"_panel",null);$(this,"_narrow",null);$(this,"_route",null);$(this,"_lastPanel",null);$(this,"_lastNarrow",null);$(this,"_lastRoute",null);$(this,"_lastPage",null);$(this,"_scrollPositions",{});$(this,"_unsubscribeEvents",null);$(this,"_initialized",!1);$(this,"_hasNewData",!1);$(this,"_pendingUpdates",[]);$(this,"_entryIdWaitWarned",!1);this._root=document.createElement("div"),this._root.className="pp-reader-dashboard",this.appendChild(this._root)}set hass(n){this._hass=n??null,this._checkInitialization()}set panel(n){this._panel!==n&&(this._panel=n??null,this._checkInitialization())}set narrow(n){this._narrow!==(n??null)&&(this._narrow=n??null,this._renderIfInitialized())}set route(n){this._route!==(n??null)&&(this._route=n??null,this._renderIfInitialized())}connectedCallback(){this._checkInitialization()}disconnectedCallback(){this._removeEventListeners()}_checkInitialization(){if(!this._hass||this._initialized)return;if(!this._panel&&this._hass.panels){const r=this._hass.panels;this._panel=r.ppreader||r.pp_reader||Object.values(r).find(i=>(i==null?void 0:i.webcomponent_name)==="pp-reader-panel")||null}const n=Xe(this._hass,this._panel);if(!n){this._entryIdWaitWarned||(console.warn("PPReaderDashboard: kein entry_id ermittelbar ‚Äì warte auf Panel-Konfiguration."),this._entryIdWaitWarned=!0);return}this._entryIdWaitWarned=!1,console.debug("PPReaderDashboard: entry_id (fallback) =",n),this._initialized=!0,this._initializeEventListeners(),this._render()}_initializeEventListeners(){var o;this._removeEventListeners();const n=(o=this._hass)==null?void 0:o.connection;if(!n||typeof n.subscribeEvents!="function"){console.error("PPReaderDashboard: keine valide WebSocket-Verbindung oder subscribeEvents fehlt");return}const r=["panels_updated"],i=[];Promise.all(r.map(c=>n.subscribeEvents(this._handleBusEvent.bind(this),c).then(l=>{typeof l=="function"?(i.push(l),console.debug("PPReaderDashboard: subscribed to",c)):console.error("PPReaderDashboard: subscribeEvents lieferte kein Unsubscribe-Func f√ºr",c,l)}).catch(l=>{console.error("PPReaderDashboard: Fehler bei subscribeEvents f√ºr",c,l)}))).then(()=>{this._unsubscribeEvents=()=>{i.forEach(c=>{try{c()}catch{}}),console.debug("PPReaderDashboard: alle Event-Subscriptions entfernt")}})}_removeEventListeners(){if(typeof this._unsubscribeEvents=="function")try{this._unsubscribeEvents()}catch(n){console.error("PPReaderDashboard: Fehler beim Entfernen der Event-Listener:",n)}this._unsubscribeEvents=null}_handleBusEvent(n){const r=Xe(this._hass,this._panel);if(!r)return;const i=n==null?void 0:n.data;if(!i||!Pr(i.data_type)||i.entry_id&&i.entry_id!==r)return;const o=Nr(i.data_type,i.data);o&&(this._queueUpdate(o.type,o.data),this._doRender(o.type,o.data))}_doRender(n,r){switch(n){case"accounts":bn(r,this._root);break;case"last_file_update":Pn(r,this._root);break;case"portfolio_values":yn(r,this._root);break;case"portfolio_positions":vn(r,this._root);break;default:console.warn("PPReaderDashboard: Unbekannter Datentyp:",n);break}}_queueUpdate(n,r){const i=this._cloneData(r),o={type:n,data:i};n==="portfolio_positions"&&(o.portfolioUuid=Ar(i));let c=-1;n==="portfolio_positions"&&o.portfolioUuid?c=this._pendingUpdates.findIndex(l=>l.type===n&&l.portfolioUuid===o.portfolioUuid):c=this._pendingUpdates.findIndex(l=>l.type===n),c>=0?this._pendingUpdates[c]=o:this._pendingUpdates.push(o),this._hasNewData=!0}_cloneData(n){if(n==null)return n;try{if(typeof structuredClone=="function")return structuredClone(n)}catch(r){console.warn("PPReaderDashboard: structuredClone fehlgeschlagen, falle auf JSON zur√ºck",r)}try{return JSON.parse(JSON.stringify(n))}catch(r){return console.warn("PPReaderDashboard: JSON-Clone fehlgeschlagen, referenziere Originaldaten",r),n}}_reapplyPendingUpdates(){if(!(!Array.isArray(this._pendingUpdates)||this._pendingUpdates.length===0))for(const n of this._pendingUpdates)try{this._doRender(n.type,this._cloneData(n.data))}catch(r){console.error("PPReaderDashboard: Fehler beim erneuten Anwenden eines Updates",n,r)}}_renderIfInitialized(){this._initialized&&this._render()}handleExternalRender(n){this._afterRender(n)}rememberScrollPosition(n=C){if(!this._root)return;const r=Number.isInteger(n)?n:C;r!=null&&(this._scrollPositions[r]=this._root.scrollTop||0)}_render(){if(!this._hass){console.warn("pp-reader-dashboard: noch kein hass, √ºberspringe _render()");return}if(!this._initialized){console.debug("pp-reader-dashboard: _render aufgerufen bevor initialisiert");return}const n=C;if(!this._hasNewData&&this._panel===this._lastPanel&&this._narrow===this._lastNarrow&&this._route===this._lastRoute&&this._lastPage===n)return;this._lastPage!=null&&(this._scrollPositions[this._lastPage]=this._root.scrollTop);const r=tn(this._root,this._hass,this._panel);r&&typeof r.then=="function"?r.then(()=>{this._afterRender(n)}).catch(i=>{console.error("PPReaderDashboard: Fehler beim Rendern des Tabs",i),this._afterRender(n)}):this._afterRender(n)}_afterRender(n){if(!this._root)return;const r=this._scrollPositions[n]||0;this._root.scrollTop=r,this._lastPanel=this._panel,this._lastNarrow=this._narrow,this._lastRoute=this._route,this._lastPage=n;try{this._reapplyPendingUpdates()}catch(i){console.error("PPReaderDashboard: Fehler beim Wiederanlegen der Updates",i)}this._hasNewData=!1}}customElements.get("pp-reader-dashboard")||customElements.define("pp-reader-dashboard",Hr);console.log("PPReader dashboard.js v20250914b geladen");vr({setSecurityDetailTabFactory:Lr});
//# sourceMappingURL=dashboard.Bz8LS1tL.js.map
