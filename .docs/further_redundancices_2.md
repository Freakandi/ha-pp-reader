## Frontend fallbacks duplicating backend calculations

| Legacy item | Location(s) still using it | Cleanup actions to remove |
| --- | --- | --- |

| `buildSnapshotFromPortfolioCache` | The security detail cache fallback loops over cached positions, re-sums holdings, purchase totals, gain metrics, and rebuilds an average-cost object instead of forwarding the backend-provided aggregation/performance blocks.【F:src/tabs/security_detail.ts†L380-L602】 | Lean on the backend `HoldingsAggregation` and `AverageCostSelection` outputs (`aggregation`/`average_cost` payloads) described in the redundancy cleanup plan, wiring the fallback to reuse those structures directly and deleting the manual accumulation code.【F:.docs/TODO_redundancy_cleanup_plan.md†L130-L190】【F:custom_components/pp_reader/data/aggregations.py†L23-L308】 |

## Version 2
The following tables capture every construct that still reflects the pre-refactor currency, aggregation, or performance flows. Each entry records the legacy helper or payload, where it continues to run, and which shared implementation should replace it according to the consolidation plan.

## Backend helpers still duplicating the shared utilities

| Legacy item | Where still in use | Superseded by |

| `_normalize_currency_amount` wrapper | Event push continues to funnel cent and float inputs through its own converter before packaging portfolio updates.【F:custom_components/pp_reader/data/event_push.py†L41-L111】 | Call the shared `cent_to_eur` / `round_currency` helpers directly and drop the bespoke wrapper once all call sites migrate.【F:custom_components/pp_reader/util/currency.py†L35-L98】【F:.docs/TODO_redundancy_cleanup_plan.md†L162-L166】 |
| `_normalize_portfolio_value_entry` recomputation | Portfolio value events still rebuild gains locally and only optionally reattach the structured performance payload.【F:custom_components/pp_reader/data/event_push.py†L59-L111】 | Trust the central performance helper and forward its payload without duplicating rounding, per the event refactor checklist.【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:.docs/TODO_redundancy_cleanup_plan.md†L219-L222】 |
| `_normalize_position_entry` fallbacks | Position events re-create holdings aggregations, average-cost choices, and performance data even though those structures are already computed server-side.【F:custom_components/pp_reader/data/event_push.py†L160-L338】 | Consume the `HoldingsAggregation`/`AverageCostSelection` dataclasses and the shared performance metrics instead of rebuilding them locally.【F:custom_components/pp_reader/data/aggregations.py†L175-L238】【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:.docs/TODO_redundancy_cleanup_plan.md†L120-L166】【F:.docs/TODO_redundancy_cleanup_plan.md†L219-L222】 |
| Coordinator gain rounding | `_portfolio_contract_entry` still casts gains via `round(...)` before returning sensor payloads, duplicating the precision logic from the shared helper.【F:custom_components/pp_reader/data/coordinator.py†L141-L179】 | Delegate rounding to the performance helper (and/or `round_currency`) so the coordinator mirrors the canonical calculations.【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:custom_components/pp_reader/util/currency.py†L35-L98】【F:.docs/TODO_redundancy_cleanup_plan.md†L219-L222】 |
| Price revaluation cent scaling | The price revaluation flow converts EUR floats back to cents and rounds totals manually during portfolio upserts.【F:custom_components/pp_reader/prices/price_service.py†L560-L610】 | Reuse the currency helpers or aggregation outputs for cent/float conversions so the revaluation path shares the same rounding surface as the rest of the backend.【F:custom_components/pp_reader/util/currency.py†L35-L98】【F:.docs/TODO_redundancy_cleanup_plan.md†

## Backend payload fields awaiting retirement

| Legacy item | Where still in use | Superseded by |

| Legacy average-cost mirrors on portfolio positions | `get_portfolio_positions` still emits `average_purchase_price_native`, `avg_price_account`, and duplicated purchase totals alongside the structured aggregation and `average_cost` payload.【F:custom_components/pp_reader/data/db_access.py†L780-L898】 | Rely exclusively on the `AverageCostSelection` output inside `average_cost`, keeping the aggregation payload authoritative for totals.【F:custom_components/pp_reader/data/aggregations.py†L187-L238】【F:.docs/TODO_redundancy_cleanup_plan.md†L152-L170】 |
| Legacy average-cost mirrors on security snapshots | `get_security_snapshot` forwards the same flat average-price and purchase-total fields even though the snapshot already carries `average_cost` and aggregation data.【F:custom_components/pp_reader/data/db_access.py†L648-L665】 | Surface only the structured average-cost block and its aggregation context as prescribed in the cleanup plan.【F:custom_components/pp_reader/data/aggregations.py†L175-L238】【F:.docs/TODO_redundancy_cleanup_plan.md†L214-L217】 |
| Flattened gain metrics | Portfolio positions and event payloads duplicate `gain_abs`/`gain_pct` next to the nested `performance` object, keeping legacy mirrors alive.【F:custom_components/pp_reader/data/db_access.py†L780-L898】【F:custom_components/pp_reader/data/event_push.py†L96-L105】【F:custom_components/pp_reader/data/event_push.py†L322-L335】 | Consumers should read gains from `PerformanceMetrics`, allowing the redundant scalars to be removed once downstream code migrates.【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:.docs/TODO_redundancy_cleanup_plan.md†L219-L237】 |
| Legacy day-change field | Snapshots still expose `day_price_change_native` even though the structured day-change block in `performance` covers the same information.【F:custom_components/pp_reader/data/db_access.py†L648-L664】 | Transition callers to `performance.day_change` (native/EUR deltas and percentage change) so the flat field can be deleted.【F:custom_components/pp_reader/data/performance.py†L115-L152】【F:.docs/TODO_redundancy_cleanup_plan.md†L214-L237】 |

## Frontend fallback normalisers

| Legacy item | Where still in use | Superseded by |

| WebSocket cache re-derives aggregation & average-cost | `deriveAggregation`, `normalizeAverageCost`, and `normalizePosition` rebuild holdings totals, average costs, and gain mirrors instead of trusting the backend payload.【F:src/data/updateConfigsWS.ts†L69-L187】 | Consume the delivered `HoldingsAggregationPayload`, `AverageCostPayload`, and `PerformanceMetricsPayload` directly, matching the plan to drop local fallbacks.【F:custom_components/pp_reader/data/aggregations.py†L175-L238】【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:.docs/TODO_redundancy_cleanup_plan.md†L130-L133】【F:.docs/TODO_redundancy_cleanup_plan.md†L177-L180】 |
| Overview tab average-cost resolver | `resolveAverageCost` and related helpers still parse and normalise average-cost fields client-side before rendering purchase price rows.【F:src/tabs/overview.ts†L177-L233】【F:src/tabs/overview.ts†L251-L280】 | Bind UI components to the structured `average_cost` payload supplied by the backend, as outlined in the dashboard migration steps.【F:custom_components/pp_reader/data/aggregations.py†L175-L238】【F:.docs/TODO_redundancy_cleanup_plan.md†L135-L138】【F:.docs/TODO_redundancy_cleanup_plan.md†L182-L185】 |
| Security detail average-cost & baseline fallbacks | `normalizeAverageCost` and `resolveAveragePurchaseBaseline` continue to reconstruct averages and chart baselines from legacy fields instead of using the server-provided structures.【F:src/tabs/security_detail.ts†L137-L187】【F:src/tabs/security_detail.ts†L1830-L1846】 | Depend on the backend’s `average_cost` and performance day-change metrics for charting and tooltips, removing the redundant computations per the refactor checklist.【F:custom_components/pp_reader/data/aggregations.py†L175-L238】【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:.docs/TODO_redundancy_cleanup_plan.md†L135-L190】 |

## Version 3

## Frontend fallbacks duplicating backend calculations

| Legacy item | Location(s) still using it | Cleanup actions to remove |
| --- | --- | --- |
| `buildSnapshotFromPortfolioCache` | Cache fallback re-aggregates holdings, purchase totals, and gain metrics by iterating over positions and rounding locally instead of trusting backend payloads.【F:src/tabs/security_detail.ts†L420-L602】 | Pull cached snapshots directly from the backend-provided `aggregation`, `average_cost`, and `performance` blocks returned by `get_security_snapshot`, then delete the manual summation/rounding path once consumers rely on the structured helpers.【F:.docs/TODO_redundancy_cleanup_plan.md†L187-L248】【F:custom_components/pp_reader/data/db_access.py†L536-L665】 |
| `ensureSnapshotMetrics` | Security detail metrics registry rebuilds average prices, FX rates, and day/total changes from raw snapshot fields despite the dedicated performance payload.【F:src/tabs/security_detail.ts†L1030-L1107】 | Source holdings and delta metrics from the backend `performance` object (including `day_change`) and aggregated cost helpers, remove bespoke computations, and update chart consumers/tests to expect the canonical payload shape.【F:.docs/TODO_redundancy_cleanup_plan.md†L214-L248】【F:custom_components/pp_reader/data/db_access.py†L536-L665】 |

## Version 4

Cross-checking the codebase with the completed currency/aggregation/performance refactors shows a couple of compatibility shims that are still present even though newer helpers already exist. The table below groups each legacy construct with its remaining usage and the modern surface that should replace it.

| Legacy item | Where it still appears | Replacement / successor |
| --- | --- | --- |
| Flat `gain_abs`/`gain_pct` payload fields | Portfolio position queries and event payloads still emit the legacy scalars alongside the structured performance block, and the websocket cache restores them so DOM helpers can keep addressing `gain_*` keys.【F:custom_components/pp_reader/data/db_access.py†L866-L895】【F:custom_components/pp_reader/data/db_access.py†L936-L952】【F:custom_components/pp_reader/data/event_push.py†L84-L110】【F:src/data/updateConfigsWS.ts†L153-L188】 | The `PerformanceMetricsPayload` already carries the canonical gain data and day-change metadata, letting downstream code rely on `performance.gain_*` instead of the flat mirrors.【F:src/tabs/types.ts†L37-L51】 |
| Deprecated `avg_price_account` field | Portfolio position and snapshot helpers still propagate the account-average number next to the structured average-cost payload, and the TypeScript type keeps the optional property for compatibility.【F:custom_components/pp_reader/data/db_access.py†L824-L893】【F:custom_components/pp_reader/data/db_access.py†L648-L660】【F:src/tabs/types.ts†L132-L146】 | The structured `AverageCostPayload.account` value supersedes the legacy field and should be the single source for account-currency averages.【F:src/tabs/types.ts†L11-L22】 |
| Flattened `day_price_change_native` snapshot value | Security snapshots still attach the raw native day change even though websocket serialisation drops the field before it reaches clients.【F:custom_components/pp_reader/data/db_access.py†L644-L664】【F:custom_components/pp_reader/data/websocket.py†L159-L164】 | The nested `performance.day_change.price_change_native`/`price_change_eur` values produced by `select_performance_metrics` already provide the canonical day-delta payload.【F:custom_components/pp_reader/data/performance.py†L83-L149】 |
| Legacy portfolio aggregation fallbacks (`calculate_portfolio_value`, `calculate_purchase_sum`, `db_calculate_portfolio_*`) | The price revaluation pipeline keeps these helpers as a safety net, so the legacy FIFO/FX routines remain in `logic/portfolio.py`.【F:custom_components/pp_reader/logic/portfolio.py†L53-L142】【F:custom_components/pp_reader/logic/portfolio.py†L285-L360】【F:custom_components/pp_reader/prices/revaluation.py†L30-L78】 | Modern consumers already use `fetch_live_portfolios` for normalised aggregates; extending its error handling would let the legacy helpers be retired.【F:custom_components/pp_reader/data/db_access.py†L961-L1024】 |
| Frontend fallback to legacy `dashboard.js` bundle | The published panel bootstrapper still imports `dashboard.js` when the module build cannot be loaded, keeping the old bundle alive in production packages.【F:custom_components/pp_reader/www/pp_reader_dashboard/panel.js†L1-L58】 | The TypeScript panel entry point loads the compiled `dashboard.module.js` bundle and exposes the same custom element, so once the build is reliable the fallback can be removed.【F:src/panel.ts†L1-L55】 |
| Global `window.__ppReader*` shims | Websocket handlers and the overview tab keep registering helpers on `window` to satisfy legacy DOM integrations instead of consuming the module exports directly.【F:src/data/updateConfigsWS.ts†L203-L249】【F:src/tabs/overview.ts†L532-L586】 | The same modules already expose typed exports such as `PORTFOLIO_POSITIONS_UPDATED_EVENT`, `renderPortfolioPositions`, and `attachSecurityDetailListener`, allowing callers to import them instead of relying on global lookups.【F:src/data/updateConfigsWS.ts†L200-L206】【F:src/tabs/overview.ts†L532-L586】 |