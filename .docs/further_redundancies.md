# Further Redundancies Identified

The following table lists legacy fields and helpers that remain in the codebase for backwards compatibility even though newer structures exist, based on the completed currency and performance refactors.

| Legacy item | Remaining usage | Replacement |
| --- | --- | --- |
| `average_purchase_price_native` field on portfolio and snapshot payloads | Backend serializers still populate the field for portfolio positions and security snapshots, and the dashboard continues to fall back to it when normalising average cost payloads. | `average_cost.native` emitted by the new aggregation helpers and consumed by the frontend normalisers. |
| `avg_price_security` field on portfolio and snapshot payloads | Portfolio queries and snapshot responses continue to include the legacy security-currency average, while dashboard average-cost helpers still read it as a fallback. | `average_cost.security` within the structured average cost payload. |
| `avg_price_account` field on portfolio and snapshot payloads | Portfolio aggregation keeps emitting the account-currency average and the frontend normalisers reuse it when structured averages are missing. | `average_cost.account` inside the aggregated average cost payload. |
| Flat `gain_abs` metric on portfolio items | Portfolio position builders copy the absolute gain out of the new performance payload, and the dashboard re-injects it to match legacy table renderers. | `performance.gain_abs` provided by `PerformanceMetricsPayload`. |
| Flat `gain_pct` metric on portfolio items | Backend responses still expose the percentage gain alongside the nested payload, and the frontend retains it when normalising positions for existing formatters. | `performance.gain_pct` within the structured performance payload. |
| `day_price_change_native` snapshot field | Security snapshot responses continue to surface the native day change and the dashboard fallbacks rely on it if the structured payload is missing. | `performance.day_change.price_change_native` from the performance metrics helper. |
| `day_price_change_eur` snapshot field | Backend snapshots still add the EUR-denominated day delta, which the frontend uses as a fallback when normalising metrics. | `performance.day_change.price_change_eur` nested in the performance payload. |
| `day_change_pct` snapshot field | Snapshot serializers populate the legacy percentage change while the UI normalisation code treats it as a fallback. | `performance.day_change.change_pct` contained in the new performance payload. |
| Legacy item | Current usage / behaviour | Replacement or preferred implementation |
| --- | --- | --- |
| `_normalize_currency_amount` helper in `data/event_push.py` | Still normalises cent and float inputs for portfolio events and feeds fallback paths in `_normalize_portfolio_value_entry` and `_normalize_position_entry`, keeping duplicate rounding logic alive instead of trusting backend-normalised values.【F:custom_components/pp_reader/data/event_push.py†L40-L276】 | Remove bespoke conversion in favour of the backend supplied EUR amounts that already pass through the shared currency helpers (`cent_to_eur`, `round_currency`) and the aggregation/average-cost data produced by `compute_holdings_aggregation` and `select_average_cost`.【F:.docs/TODO_redundancy_cleanup_plan.md†L120-L166】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】 |
| `_normalize_position_entry` in `data/event_push.py` | Rebuilds purchase totals, average prices and performance metrics by probing raw dicts, even though the backend now attaches `aggregation`, `average_cost` and `performance` payloads.【F:custom_components/pp_reader/data/event_push.py†L146-L276】 | Read the prepared `aggregation`, `average_cost` and `performance` objects directly, which are already generated by `compute_holdings_aggregation`, `select_average_cost` and `select_performance_metrics`, eliminating manual fallbacks.【F:.docs/TODO_redundancy_cleanup_plan.md†L120-L166】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
| `_normalize_portfolio_positions` in `data/websocket.py` | Duplicates purchase-total calculations, average-price derivations and performance recomputation for websocket responses rather than passing through backend payloads.【F:custom_components/pp_reader/data/websocket.py†L272-L359】 | Streamline the serializer to forward the backend-provided `average_cost`, `aggregation` and `performance` blocks, matching the cleanup plan for step 6d/7d.【F:.docs/TODO_redundancy_cleanup_plan.md†L152-L217】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
| `deriveAggregation` in `src/data/updateConfigsWS.ts` | Recomputes holdings totals, purchase sums and averages on the client, effectively mirroring the backend aggregation despite the cache already receiving an `aggregation` object.【F:src/data/updateConfigsWS.ts†L72-L143】 | Trust the backend aggregation from `HoldingsAggregation` and drop the client-side reconstruction per plan step 6h/5j, using the supplied payload as-is.【F:.docs/TODO_redundancy_cleanup_plan.md†L130-L181】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】 |
| `normalizeAverageCost` in `src/data/updateConfigsWS.ts` | Synthesises average-cost figures from legacy fields and derived totals when the backend already exports a structured `average_cost` block.【F:src/data/updateConfigsWS.ts†L146-L200】 | Consume the backend `AverageCostPayload` emitted via `select_average_cost` without recomputing values on the client, matching steps 6c–6h.【F:.docs/TODO_redundancy_cleanup_plan.md†L140-L181】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `normalizePosition` in `src/data/updateConfigsWS.ts` | Overwrites incoming positions with the recomputed aggregation/average-cost data, keeping legacy normalisation logic alive in the websocket cache.【F:src/data/updateConfigsWS.ts†L202-L228】 | Preserve the server-provided structures and only perform minimal shape validation, as outlined for the websocket update handlers in step 6h and performance harmonisation in step 7i.【F:.docs/TODO_redundancy_cleanup_plan.md†L177-L243】 |
| `resolveAverageCost` in `src/tabs/overview.ts` | Calculates average purchase prices from holdings, totals and legacy fields on the fly before rendering purchase-price cells.【F:src/tabs/overview.ts†L187-L288】 | Use the `average_cost` object from the API (sourced from `select_average_cost`) directly when rendering, in line with the dashboard migration tasks in step 6i.【F:.docs/TODO_redundancy_cleanup_plan.md†L182-L196】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `normalizeAverageCost` in `src/tabs/security_detail.ts` | Reconstructs native, security, account and EUR averages from legacy snapshot data and derived totals even though the snapshot already includes the new `average_cost` payload.【F:src/tabs/security_detail.ts†L160-L254】 | Rely on the snapshot’s `average_cost` structure populated by the backend helper chain to avoid recomputation, following step 6j of the cleanup plan.【F:.docs/TODO_redundancy_cleanup_plan.md†L187-L248】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `resolveAveragePurchaseBaseline` in `src/tabs/security_detail.ts` | Falls back to legacy snapshot fields to derive a chart baseline instead of trusting the metrics derived from `average_cost` and backend performance data.【F:src/tabs/security_detail.ts†L1825-L2047】 | Base the history baseline on the backend-supplied metrics (`average_cost`, `performance`) without recomputing, aligning with steps 6j and 7j that centralise these calculations.【F:.docs/TODO_redundancy_cleanup_plan.md†L187-L248】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
