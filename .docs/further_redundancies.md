# Further Redundancies Identified

The following tables consolidate every outstanding legacy construct that still lives in the codebase. Each entry appears only once and is described with the precise clean-up actions required to retire it. The goal is to replace bespoke conversions, duplicated aggregation logic, and backwards-compatibility payloads with the new currency, aggregation, and performance helpers already in place.

## Backend currency conversions that bypass the shared helpers

| Legacy item | Location(s) still using it | Cleanup actions to remove |
| --- | --- | --- |
| Manual cent-to-euro conversions for account balances | `calculate_account_balance` divides accumulated saldo by `100.0`, and `_emit_accounts_update` in the sync layer rescales raw balances before emitting websocket payloads.【F:custom_components/pp_reader/logic/accounting.py†L67-L72】【F:custom_components/pp_reader/data/sync_from_pclient.py†L1159-L1182】 | Replace all `/ 100` and bespoke rounding with `cent_to_eur` and `round_currency` so balances flow through the central currency utilities, then delete the redundant math once callers are updated.【F:custom_components/pp_reader/util/currency.py†L34-L69】 |
| Manual transaction amount conversions | `_normalize_transaction_amounts`/`_resolve_native_amount` convert cents to EUR manually when preparing security transaction payloads.【F:custom_components/pp_reader/logic/securities.py†L98-L125】【F:custom_components/pp_reader/logic/securities.py†L340-L405】 | Route every amount (gross, fees, taxes, native legs) through `cent_to_eur`/`round_currency`, update tests/fixtures accordingly, and then remove the legacy conversion paths from the securities module.【F:custom_components/pp_reader/util/currency.py†L34-L69】 |
| Coordinator `_normalize_amount` helper duplicating currency logic | The portfolio coordinator still accepts ints/floats and divides by `100`/rounds locally instead of relying on shared helpers.【F:custom_components/pp_reader/data/coordinator.py†L77-L92】 | Inline calls to `cent_to_eur` and `round_currency`, migrate every caller to the helpers, and drop the bespoke `_normalize_amount` implementation afterwards.【F:custom_components/pp_reader/util/currency.py†L34-L69】 |
| Websocket payload rounding via Python `round` | Position serializer still invokes `round(...)` for purchase value, gains, holdings, and current value even though the module imports `round_currency`.【F:custom_components/pp_reader/data/websocket.py†L308-L347】 | Swap each `round` usage for `round_currency`, ensure payload comparisons in tests use the shared helper, then remove any now-unused rounding utilities from the websocket module.【F:custom_components/pp_reader/util/currency.py†L53-L69】 |

## Backend event/websocket normalisation wrappers to remove

| Legacy item | Location(s) still using it | Cleanup actions to remove |
| --- | --- | --- |
| `_normalize_currency_amount` | Event push normalisation still wraps cent and float conversions for portfolio updates instead of trusting the shared helpers.【F:custom_components/pp_reader/data/event_push.py†L40-L120】 | Replace the helper body with `cent_to_eur`/`round_currency`, update callers to use the utility module directly, and delete the wrapper once nothing references it.【F:.docs/TODO_redundancy_cleanup_plan.md†L22-L25】【F:custom_components/pp_reader/util/currency.py†L34-L69】 |
| `_normalize_position_entry` | Event push payloads rebuild purchase totals, average prices, and performance metrics locally, ignoring the aggregation/average-cost helpers.【F:custom_components/pp_reader/data/event_push.py†L160-L276】 | Consume `aggregation`, `average_cost`, and `performance` objects returned by `compute_holdings_aggregation`, `select_average_cost`, and `select_performance_metrics`; remove manual recomputation after adjusting serializers/tests to expect the structured payloads.【F:.docs/TODO_redundancy_cleanup_plan.md†L142-L166】【F:custom_components/pp_reader/data/aggregations.py†L149-L330】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
| `_coerce_float` & `_coerce_optional_float` | Event push normalisation and aggregation helpers still define bespoke float coercers instead of trusting the shared currency utilities.【F:custom_components/pp_reader/data/event_push.py†L167-L207】【F:custom_components/pp_reader/data/aggregations.py†L62-L120】 | Replace these coercers with calls to `cent_to_eur`/`round_currency`, update payload builders to expect already-normalised data, and delete the bespoke helpers afterwards.【F:.docs/TODO_redundancy_cleanup_plan.md†L152-L160】【F:custom_components/pp_reader/util/currency.py†L34-L69】 |
| `_normalize_portfolio_positions` | Websocket payload normalisation recomputes purchase totals, average prices, and performance metrics rather than forwarding backend results.【F:custom_components/pp_reader/data/websocket.py†L272-L359】 | Pass through the backend-provided `aggregation`, `average_cost`, and `performance` blocks untouched, adjust frontend consumers to rely on those structures, and remove the redundant recomputation logic.【F:.docs/TODO_redundancy_cleanup_plan.md†L152-L217】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |

## Frontend fallbacks duplicating backend calculations

| Legacy item | Location(s) still using it | Cleanup actions to remove |
| --- | --- | --- |
| `deriveAggregation` fallback that rebuilds holdings totals | The websocket cache recalculates totals with `Math.round(... * 100)` when `purchase_value_cents` is missing, even though the backend already supplies full aggregations.【F:src/data/updateConfigsWS.ts†L72-L143】 | Trust the `HoldingsAggregation` payload from the server: remove the fallback, pipe incoming aggregation data directly into the cache, and update tests/storybook fixtures to expect server-calculated fields only.【F:.docs/TODO_redundancy_cleanup_plan.md†L130-L181】【F:custom_components/pp_reader/data/aggregations.py†L149-L330】 |
| `normalizeAverageCost` (websocket cache) | Rebuilds average-cost figures from legacy fields despite the structured payload being available.【F:src/data/updateConfigsWS.ts†L146-L200】 | Consume the `AverageCostPayload` emitted via `select_average_cost`, delete derived math, and refactor consumers to rely on the structured shape exclusively.【F:.docs/TODO_redundancy_cleanup_plan.md†L140-L181】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `normalizePosition` | Overwrites websocket positions with recomputed aggregation/average-cost data, keeping legacy normalisation alive.【F:src/data/updateConfigsWS.ts†L202-L228】 | Preserve the server-provided structures, limit the helper to shape validation, and remove manual recomputation after updating downstream callers (tables, charts) to read the nested payloads.【F:.docs/TODO_redundancy_cleanup_plan.md†L177-L243】 |
| `resolveAverageCost` (overview tab) | Calculates average purchase prices from holdings and legacy fields before rendering overview cells.【F:src/tabs/overview.ts†L187-L288】 | Render `average_cost` directly from the API payload, adjust UI components to read nested metrics, and drop the derived calculations plus their supporting tests/mocks.【F:.docs/TODO_redundancy_cleanup_plan.md†L182-L196】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `normalizeAverageCost` (security detail tab) | Reconstructs average-cost metrics from snapshot data even though the snapshot exposes the new structure.【F:src/tabs/security_detail.ts†L160-L254】 | Depend on the snapshot’s `average_cost` object, delete redundant recomputation, and update the detail view plus tests to expect the structured payload only.【F:.docs/TODO_redundancy_cleanup_plan.md†L187-L248】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `resolveAveragePurchaseBaseline` | Builds chart baselines from legacy snapshot fields rather than using backend metrics.【F:src/tabs/security_detail.ts†L1825-L2047】 | Switch the chart baseline to `average_cost`/`performance` metrics produced by the backend, prune fallback logic, and refresh chart fixtures to mirror the new source of truth.【F:.docs/TODO_redundancy_cleanup_plan.md†L187-L248】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |

## Legacy payload fields kept for backwards compatibility

| Legacy item | Remaining usage | Cleanup actions to remove |
| --- | --- | --- |
| `average_purchase_price_native` on portfolio/snapshot payloads | Serialisers still populate the field and frontend normalisers rely on it as a fallback.【F:custom_components/pp_reader/data/websocket.py†L272-L359】 | Update clients to read `average_cost.native`, backfill fixtures, and remove the legacy field from serializers once all consumers migrate.【F:custom_components/pp_reader/data/aggregations.py†L149-L330】 |
| `avg_price_security` field | Portfolio queries and snapshots expose the legacy security-currency average while the dashboard still reads it.【F:custom_components/pp_reader/data/websocket.py†L272-L359】 | Transition both backend serializers and frontend consumers to `average_cost.security`, then drop the deprecated field after ensuring compatibility shims/tests are updated.【F:custom_components/pp_reader/data/aggregations.py†L149-L330】 |
| `avg_price_account` field | Aggregation continues to emit the account-currency average and the frontend uses it as a fallback.【F:custom_components/pp_reader/data/websocket.py†L272-L359】 | Migrate to `average_cost.account`, adjust payload parsing, and remove the legacy attribute once unused.【F:custom_components/pp_reader/data/aggregations.py†L149-L330】 |
| Flat `gain_abs` metric | Portfolio builders and the dashboard still copy this scalar from the structured performance payload.【F:custom_components/pp_reader/data/websocket.py†L308-L347】 | Read `performance.gain_abs` directly from `PerformanceMetricsPayload`, delete the flattened property, and adapt UI formatters/tests to the nested source.【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
| Flat `gain_pct` metric | Backend responses expose the percentage gain alongside the nested payload, and the frontend retains it for legacy formatters.【F:custom_components/pp_reader/data/websocket.py†L308-L347】 | Use `performance.gain_pct` from the structured payload, remove redundant flattening, and update consumers/tests to the nested value.【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
| `day_price_change_native` snapshot field | Snapshot responses still surface the native day change and the dashboard falls back to it if the nested payload is missing.【F:custom_components/pp_reader/data/websocket.py†L272-L359】 | Switch to `performance.day_change.price_change_native`, purge the fallback, and drop the legacy field after verifying front-end references are gone.【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
| `day_price_change_eur` snapshot field | Backend snapshots add the EUR-denominated delta, which the frontend reads as a fallback.【F:custom_components/pp_reader/data/websocket.py†L272-L359】 | Consume `performance.day_change.price_change_eur`, remove duplicated values, and update tests/fixtures to expect only the nested payload.【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
| `day_change_pct` snapshot field | Serializers populate the legacy percentage change while the UI still expects it as a fallback.【F:custom_components/pp_reader/data/websocket.py†L272-L359】 | Rely on `performance.day_change.change_pct`, delete the flat field after consumers migrate, and align validations/fixtures accordingly.【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
