# Further Redundancies Identified

| Legacy item | Current usage / behaviour | Replacement or preferred implementation |
| --- | --- | --- |
| `_normalize_currency_amount` helper in `data/event_push.py` | Still normalises cent and float inputs for portfolio events and feeds fallback paths in `_normalize_portfolio_value_entry` and `_normalize_position_entry`, keeping duplicate rounding logic alive instead of trusting backend-normalised values.【F:custom_components/pp_reader/data/event_push.py†L40-L276】 | Remove bespoke conversion in favour of the backend supplied EUR amounts that already pass through the shared currency helpers (`cent_to_eur`, `round_currency`) and the aggregation/average-cost data produced by `compute_holdings_aggregation` and `select_average_cost`.【F:.docs/TODO_redundancy_cleanup_plan.md†L120-L166】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】 |
| `_normalize_position_entry` in `data/event_push.py` | Rebuilds purchase totals, average prices and performance metrics by probing raw dicts, even though the backend now attaches `aggregation`, `average_cost` and `performance` payloads.【F:custom_components/pp_reader/data/event_push.py†L146-L276】 | Read the prepared `aggregation`, `average_cost` and `performance` objects directly, which are already generated by `compute_holdings_aggregation`, `select_average_cost` and `select_performance_metrics`, eliminating manual fallbacks.【F:.docs/TODO_redundancy_cleanup_plan.md†L120-L166】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
| `_normalize_portfolio_positions` in `data/websocket.py` | Duplicates purchase-total calculations, average-price derivations and performance recomputation for websocket responses rather than passing through backend payloads.【F:custom_components/pp_reader/data/websocket.py†L272-L359】 | Streamline the serializer to forward the backend-provided `average_cost`, `aggregation` and `performance` blocks, matching the cleanup plan for step 6d/7d.【F:.docs/TODO_redundancy_cleanup_plan.md†L152-L217】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
| `deriveAggregation` in `src/data/updateConfigsWS.ts` | Recomputes holdings totals, purchase sums and averages on the client, effectively mirroring the backend aggregation despite the cache already receiving an `aggregation` object.【F:src/data/updateConfigsWS.ts†L72-L143】 | Trust the backend aggregation from `HoldingsAggregation` and drop the client-side reconstruction per plan step 6h/5j, using the supplied payload as-is.【F:.docs/TODO_redundancy_cleanup_plan.md†L130-L181】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】 |
| `normalizeAverageCost` in `src/data/updateConfigsWS.ts` | Synthesises average-cost figures from legacy fields and derived totals when the backend already exports a structured `average_cost` block.【F:src/data/updateConfigsWS.ts†L146-L200】 | Consume the backend `AverageCostPayload` emitted via `select_average_cost` without recomputing values on the client, matching steps 6c–6h.【F:.docs/TODO_redundancy_cleanup_plan.md†L140-L181】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `normalizePosition` in `src/data/updateConfigsWS.ts` | Overwrites incoming positions with the recomputed aggregation/average-cost data, keeping legacy normalisation logic alive in the websocket cache.【F:src/data/updateConfigsWS.ts†L202-L228】 | Preserve the server-provided structures and only perform minimal shape validation, as outlined for the websocket update handlers in step 6h and performance harmonisation in step 7i.【F:.docs/TODO_redundancy_cleanup_plan.md†L177-L243】 |
| `resolveAverageCost` in `src/tabs/overview.ts` | Calculates average purchase prices from holdings, totals and legacy fields on the fly before rendering purchase-price cells.【F:src/tabs/overview.ts†L187-L288】 | Use the `average_cost` object from the API (sourced from `select_average_cost`) directly when rendering, in line with the dashboard migration tasks in step 6i.【F:.docs/TODO_redundancy_cleanup_plan.md†L182-L196】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `normalizeAverageCost` in `src/tabs/security_detail.ts` | Reconstructs native, security, account and EUR averages from legacy snapshot data and derived totals even though the snapshot already includes the new `average_cost` payload.【F:src/tabs/security_detail.ts†L160-L254】 | Rely on the snapshot’s `average_cost` structure populated by the backend helper chain to avoid recomputation, following step 6j of the cleanup plan.【F:.docs/TODO_redundancy_cleanup_plan.md†L187-L248】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `resolveAveragePurchaseBaseline` in `src/tabs/security_detail.ts` | Falls back to legacy snapshot fields to derive a chart baseline instead of trusting the metrics derived from `average_cost` and backend performance data.【F:src/tabs/security_detail.ts†L1825-L2047】 | Base the history baseline on the backend-supplied metrics (`average_cost`, `performance`) without recomputing, aligning with steps 6j and 7j that centralise these calculations.【F:.docs/TODO_redundancy_cleanup_plan.md†L187-L248】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
