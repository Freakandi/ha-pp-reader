# Further Redundancies Identified

| Legacy item | Still referenced in | Replacement/helper to adopt |
| --- | --- | --- |
| Manual cent-to-euro conversion via `saldo / 100.0` | `calculate_account_balance` still divides the accumulated saldo by 100 before returning the balance, bypassing the shared helper that enforces consistent rounding.【F:custom_components/pp_reader/logic/accounting.py†L67-L72】 | Use `cent_to_eur(...)` from the currency utility to normalise cents and benefit from centralised rounding rules.【F:custom_components/pp_reader/util/currency.py†L34-L50】 |
| Transaction normalisation divides by 100 throughout `_normalize_transaction_amounts`/`_resolve_native_amount` | Security transaction preparation repeatedly casts integers and divides by 100 for gross amounts, account/native legs, and aggregates instead of delegating to the new helper layer.【F:custom_components/pp_reader/logic/securities.py†L98-L125】【F:custom_components/pp_reader/logic/securities.py†L340-L405】 | Replace the manual divisions with `cent_to_eur(...)`/`round_currency(...)` so transaction math follows the unified currency pipeline introduced in the utility module.【F:custom_components/pp_reader/util/currency.py†L34-L69】 |
| `_normalize_amount` helper performs its own cent handling | The coordinator’s private normaliser accepts ints and divides by 100 or casts floats directly, recreating logic that now lives in the currency helpers.【F:custom_components/pp_reader/data/coordinator.py†L77-L92】 | Swap the body for `cent_to_eur` (and reuse `round_currency` for floats) to eliminate duplicated conversion code and keep coordinator values aligned with backend rounding defaults.【F:custom_components/pp_reader/util/currency.py†L34-L69】 |
| Account sync divides raw balances by 100 before publishing events | `_emit_accounts_update` converts database balances with `/ 100.0` and rounds locally even though the websocket layer already exposes central helpers for these conversions.【F:custom_components/pp_reader/data/sync_from_pclient.py†L1159-L1182】 | Use `cent_to_eur`/`round_currency` when preparing `orig_balance` and `balance` so the sync path stays consistent with the rest of the backend currency stack.【F:custom_components/pp_reader/util/currency.py†L34-L69】 |
| Frontend fallback recomputes `purchase_value_cents` with `Math.round(... * 100)` | `deriveAggregation` still multiplies EUR totals by 100 and rounds when `purchase_value_cents` is missing, duplicating logic that the backend aggregation now provides.【F:src/data/updateConfigsWS.ts†L90-L103】 | Prefer consuming the backend’s `purchase_value_cents`/`purchase_value_eur` from the holdings aggregation and, if fallback is still needed, route it through `roundCurrency` (or a helper built on it) instead of bespoke math.【F:custom_components/pp_reader/data/aggregations.py†L149-L200】【F:src/utils/currency.ts†L87-L116】 |
| Websocket position normalisation rounds currency fields with Python’s built-in `round` | The websocket payload builder still calls `round(...)` for purchase value, gains, holdings and current value even though `round_currency` is imported for that module.【F:custom_components/pp_reader/data/websocket.py†L308-L347】 | Replace the direct `round` calls with `round_currency` so websocket payloads share the same rounding semantics as the rest of the backend helpers.【F:custom_components/pp_reader/util/currency.py†L53-L69】 |

| Legacy Item | Current Usage | Replacement / Modern Path |
| --- | --- | --- |
| `_normalize_currency_amount` helper | Still wraps cent and rounding conversions inside event push payload normalisation, despite the dedicated currency utilities. It is invoked when compacting `portfolio_values` and `portfolio_positions` events. 【F:custom_components/pp_reader/data/event_push.py†L40-L120】 | Replace direct calls with the shared helpers from `util.currency` (e.g. `cent_to_eur`, `round_currency`) per the cleanup plan to remove redundant wrappers. 【F:.docs/TODO_redundancy_cleanup_plan.md†L22-L25】 |
| `_normalize_position_entry` event payload builder | Continues to recompute purchase totals, average prices, and gain metrics with local coercion logic instead of reusing the `aggregation`/`average_cost` output the backend now provides. 【F:custom_components/pp_reader/data/event_push.py†L160-L276】 | Read the precomputed fields from `aggregation` and `average_cost` directly, aligning with the new holdings helpers and Average-Cost selection flow. 【F:.docs/TODO_redundancy_cleanup_plan.md†L142-L166】 |
| `_normalize_amount` (and `_portfolio_contract_entry`) | Coordinator still divides by 100 and rounds ad-hoc when mapping live portfolio rows, recreating logic that the currency utilities and holdings aggregation already cover. 【F:custom_components/pp_reader/data/coordinator.py†L80-L165】 | Use `cent_to_eur`/`round_currency` for conversions and lean on the shared aggregation helpers to eliminate the bespoke normaliser. 【F:.docs/TODO_redundancy_cleanup_plan.md†L7-L25】【F:.docs/TODO_redundancy_cleanup_plan.md†L85-L123】 |
| `_coerce_float` & `_coerce_optional_float` in WebSocket serializer | WebSocket payloads still run through bespoke float coercion and rounding, duplicating the behaviour of the new currency helpers and average cost pipeline. 【F:custom_components/pp_reader/data/websocket.py†L140-L270】 | Replace with the shared rounding helpers and pass through the average cost payload untouched, as outlined for the WebSocket refactor. 【F:.docs/TODO_redundancy_cleanup_plan.md†L152-L160】 |
| `_normalize_portfolio_positions` (WebSocket) | Recomputes purchase totals, average prices, and performance metrics on the fly instead of trusting the backend aggregation/average-cost values. 【F:custom_components/pp_reader/data/websocket.py†L272-L359】 | Serialize the provided `aggregation`/`average_cost` objects directly to match the planned Average-Cost WebSocket simplification. 【F:.docs/TODO_redundancy_cleanup_plan.md†L152-L160】 |
| `calculate_account_balance` cent division | Accounting logic still converts cents to EUR via `/ 100.0`, bypassing the shared helper meant to centralise currency conversions. 【F:custom_components/pp_reader/logic/accounting.py†L14-L72】 | Switch to `cent_to_eur` (and `round_currency` where needed) per the backend utility migration. 【F:.docs/TODO_redundancy_cleanup_plan.md†L7-L20】 |
| `_normalize_transaction_amounts` in securities logic | Transaction normalisation divides by 100 for gross amounts, fees, and taxes, duplicating the cent conversion helper introduced in the utilities module. 【F:custom_components/pp_reader/logic/securities.py†L98-L159】 | Use `cent_to_eur`/`round_currency` for cent-to-EUR conversion to align with the shared helper strategy. 【F:.docs/TODO_redundancy_cleanup_plan.md†L7-L20】 |
| Account balance scaling in `sync_from_pclient` | Legacy sync still divides raw balances by 100 when constructing updated account payloads. 【F:custom_components/pp_reader/data/sync_from_pclient.py†L1148-L1174】 | Apply the central currency helpers so the sync path mirrors the normalised conversions elsewhere. 【F:.docs/TODO_redundancy_cleanup_plan.md†L7-L35】 |
The following table lists legacy fields and helpers that remain in the codebase for backwards compatibility even though newer structures exist, based on the completed currency and performance refactors.

| Legacy item | Remaining usage | Replacement |
| --- | --- | --- |
| `average_purchase_price_native` field on portfolio and snapshot payloads | Backend serializers still populate the field for portfolio positions and security snapshots, and the dashboard continues to fall back to it when normalising average cost payloads. | `average_cost.native` emitted by the new aggregation helpers and consumed by the frontend normalisers. |
| `avg_price_security` field on portfolio and snapshot payloads | Portfolio queries and snapshot responses continue to include the legacy security-currency average, while dashboard average-cost helpers still read it as a fallback. | `average_cost.security` within the structured average cost payload. |
| `avg_price_account` field on portfolio and snapshot payloads | Portfolio aggregation keeps emitting the account-currency average and the frontend normalisers reuse it when structured averages are missing. | `average_cost.account` inside the aggregated average cost payload. |
| Flat `gain_abs` metric on portfolio items | Portfolio position builders copy the absolute gain out of the new performance payload, and the dashboard re-injects it to match legacy table renderers. | `performance.gain_abs` provided by `PerformanceMetricsPayload`. |
| Flat `gain_pct` metric on portfolio items | Backend responses still expose the percentage gain alongside the nested payload, and the frontend retains it when normalising positions for existing formatters. | `performance.gain_pct` within the structured performance payload. |
| `day_price_change_native` snapshot field | Security snapshot responses continue to surface the native day change and the dashboard fallbacks rely on it if the structured payload is missing. | `performance.day_change.price_change_native` from the performance metrics helper. |
| `day_price_change_eur` snapshot field | Backend snapshots still add the EUR-denominated day delta, which the frontend uses as a fallback when normalising metrics. | `performance.day_change.price_change_eur` nested in the performance payload. |
| `day_change_pct` snapshot field | Snapshot serializers populate the legacy percentage change while the UI normalisation code treats it as a fallback. | `performance.day_change.change_pct` contained in the new performance payload. |

| Legacy item | Current usage / behaviour | Replacement or preferred implementation |
| --- | --- | --- |
| `_normalize_currency_amount` helper in `data/event_push.py` | Still normalises cent and float inputs for portfolio events and feeds fallback paths in `_normalize_portfolio_value_entry` and `_normalize_position_entry`, keeping duplicate rounding logic alive instead of trusting backend-normalised values.【F:custom_components/pp_reader/data/event_push.py†L40-L276】 | Remove bespoke conversion in favour of the backend supplied EUR amounts that already pass through the shared currency helpers (`cent_to_eur`, `round_currency`) and the aggregation/average-cost data produced by `compute_holdings_aggregation` and `select_average_cost`.【F:.docs/TODO_redundancy_cleanup_plan.md†L120-L166】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】 |
| `_normalize_position_entry` in `data/event_push.py` | Rebuilds purchase totals, average prices and performance metrics by probing raw dicts, even though the backend now attaches `aggregation`, `average_cost` and `performance` payloads.【F:custom_components/pp_reader/data/event_push.py†L146-L276】 | Read the prepared `aggregation`, `average_cost` and `performance` objects directly, which are already generated by `compute_holdings_aggregation`, `select_average_cost` and `select_performance_metrics`, eliminating manual fallbacks.【F:.docs/TODO_redundancy_cleanup_plan.md†L120-L166】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
| `_normalize_portfolio_positions` in `data/websocket.py` | Duplicates purchase-total calculations, average-price derivations and performance recomputation for websocket responses rather than passing through backend payloads.【F:custom_components/pp_reader/data/websocket.py†L272-L359】 | Streamline the serializer to forward the backend-provided `average_cost`, `aggregation` and `performance` blocks, matching the cleanup plan for step 6d/7d.【F:.docs/TODO_redundancy_cleanup_plan.md†L152-L217】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
| `deriveAggregation` in `src/data/updateConfigsWS.ts` | Recomputes holdings totals, purchase sums and averages on the client, effectively mirroring the backend aggregation despite the cache already receiving an `aggregation` object.【F:src/data/updateConfigsWS.ts†L72-L143】 | Trust the backend aggregation from `HoldingsAggregation` and drop the client-side reconstruction per plan step 6h/5j, using the supplied payload as-is.【F:.docs/TODO_redundancy_cleanup_plan.md†L130-L181】【F:custom_components/pp_reader/data/aggregations.py†L86-L330】 |
| `normalizeAverageCost` in `src/data/updateConfigsWS.ts` | Synthesises average-cost figures from legacy fields and derived totals when the backend already exports a structured `average_cost` block.【F:src/data/updateConfigsWS.ts†L146-L200】 | Consume the backend `AverageCostPayload` emitted via `select_average_cost` without recomputing values on the client, matching steps 6c–6h.【F:.docs/TODO_redundancy_cleanup_plan.md†L140-L181】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `normalizePosition` in `src/data/updateConfigsWS.ts` | Overwrites incoming positions with the recomputed aggregation/average-cost data, keeping legacy normalisation logic alive in the websocket cache.【F:src/data/updateConfigsWS.ts†L202-L228】 | Preserve the server-provided structures and only perform minimal shape validation, as outlined for the websocket update handlers in step 6h and performance harmonisation in step 7i.【F:.docs/TODO_redundancy_cleanup_plan.md†L177-L243】 |
| `resolveAverageCost` in `src/tabs/overview.ts` | Calculates average purchase prices from holdings, totals and legacy fields on the fly before rendering purchase-price cells.【F:src/tabs/overview.ts†L187-L288】 | Use the `average_cost` object from the API (sourced from `select_average_cost`) directly when rendering, in line with the dashboard migration tasks in step 6i.【F:.docs/TODO_redundancy_cleanup_plan.md†L182-L196】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `normalizeAverageCost` in `src/tabs/security_detail.ts` | Reconstructs native, security, account and EUR averages from legacy snapshot data and derived totals even though the snapshot already includes the new `average_cost` payload.【F:src/tabs/security_detail.ts†L160-L254】 | Rely on the snapshot’s `average_cost` structure populated by the backend helper chain to avoid recomputation, following step 6j of the cleanup plan.【F:.docs/TODO_redundancy_cleanup_plan.md†L187-L248】【F:custom_components/pp_reader/data/aggregations.py†L209-L330】 |
| `resolveAveragePurchaseBaseline` in `src/tabs/security_detail.ts` | Falls back to legacy snapshot fields to derive a chart baseline instead of trusting the metrics derived from `average_cost` and backend performance data.【F:src/tabs/security_detail.ts†L1825-L2047】 | Base the history baseline on the backend-supplied metrics (`average_cost`, `performance`) without recomputing, aligning with steps 6j and 7j that centralise these calculations.【F:.docs/TODO_redundancy_cleanup_plan.md†L187-L248】【F:custom_components/pp_reader/data/performance.py†L83-L194】 |
