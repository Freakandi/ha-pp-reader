# Legacy Cleanup Strategy for the Datamodel Refactor

## Objectives

This strategy governs how the integration will remove superseded assets once the canonical ingestion → normalization → delivery flow is in place, ensuring the portfolio pipeline remains aligned with the backend data model and dashboard contracts documented in the canonical specs.【F:datamodel/backend-datamodel-final.md†L1-L133】【F:datamodel/dataflow_backend.md†L1-L138】【F:datamodel/dataflow_frontend.md†L1-L118】

Key goals:

- Decommission legacy helpers in lockstep with the new parser, enrichment, normalization, and frontend adapters so every removal is gated by observable parity checks.【F:custom_components/pp_reader/data/coordinator.py†L49-L199】【F:tests/test_event_push.py†L1-L160】
- Preserve a verifiable audit trail through fixtures, dashboards, and Home Assistant configuration artifacts while trimming obsolete resources.【F:datamodel/db_entries/Aixtron_entries.md†L1-L48】【F:README.md†L41-L68】
- Track cleanup readiness alongside the roadmap and workstream plans to keep backend and frontend stakeholders synchronized.【F:.docs/refactor_roadmap.md†L1-L72】【F:.docs/backend_workstreams.md†L1-L83】【F:.docs/frontend_alignment.md†L1-L36】

## Governance Principles

1. **Evidence-first removals.** No module, schema, or UI asset is deleted until fixtures, automated tests, and manual runbooks show the canonical data still satisfies the dashboard contract matrix and websocket behaviors.【F:datamodel/panel_connectors.md†L1-L94】【F:tests/test_ws_portfolio_positions.py†L1-L198】
2. **Shared verification.** Backend and frontend contributors jointly sign off on contract compatibility by replaying representative database snapshots before removals ship.【F:datamodel/db_entries/Aixtron_entries.md†L1-L48】【F:tests/test_coordinator_contract.py†L1-L120】
3. **Configuration parity.** Cleanup never strands user configuration; database paths, backups, and service bindings remain intact and documented for users during each milestone.【F:README.md†L41-L77】【F:tests/test_backup_cleanup.py†L1-L36】
4. **Rolling checkpoints.** Every removal candidate ties back to roadmap milestones so coordination notes and release messaging stay current.【F:.docs/refactor_roadmap.md†L45-L73】【F:.docs/frontend_alignment.md†L15-L34】

## Cleanup Tracker

| Status | Area | Legacy asset(s) | Preconditions | Validation & Evidence | Notes |
| --- | --- | --- | --- | --- | --- |
| [ ] | Parser ingestion | `custom_components/pp_reader/pclient/*`, coordinator fallback `_sync_data_to_db`, legacy `_SyncRunner` helpers | Streaming parser pipeline stages data via `ingestion_writer`/`ingestion_reader`, and normalization consumers rely solely on staging snapshots (Roadmap M1–M4).【F:custom_components/pp_reader/services/parser_pipeline.py†L1-L320】【F:.docs/backend_workstreams.md†L5-L38】 | Green runs for `tests/services/test_parser_pipeline.py`, `tests/integration/test_ingestion_writer.py`, `tests/integration/test_sync_from_staging.py`, plus coordinator/websocket suites confirm staging parity with protobuf imports.【F:tests/services/test_parser_pipeline.py†L1-L210】【F:tests/integration/test_ingestion_writer.py†L1-L220】【F:tests/integration/test_sync_from_staging.py†L1-L200】【F:tests/test_coordinator_contract.py†L1-L120】 | Remove legacy protobuf helpers only after migration notes capture staging snapshot coverage and CLI + coordinator imports documented as canonical path. |
| [ ] | Enrichment jobs | Sync FX entry points (`ensure_exchange_rates_for_dates_sync`, `load_cached_rate_records_sync`, `util.currency.normalize_price_to_eur_sync`) plus dormant Yahoo history fallbacks | Async enrichment paths are the default: coordinator and CLI await `ensure_exchange_rates_for_dates`; websocket/account payloads rely on the async loader; `logic/securities.py` and `data/sync_from_pclient.py` are refactored to call the async helper via `async_run_executor_job`, leaving sync wrappers unused in production (Roadmap M2, backend workstream enrichment).【F:custom_components/pp_reader/data/coordinator.py†L601-L670】【F:custom_components/pp_reader/data/websocket.py†L60-L138】【F:custom_components/pp_reader/logic/securities.py†L376-L460】【F:custom_components/pp_reader/data/sync_from_pclient.py†L1363-L1439】 | `tests/prices/test_history_queue.py`, `tests/prices/test_history_ingest.py`, `tests/currencies/test_fx_async.py`, `tests/test_price_service.py`, and `tests/integration/test_enrichment_pipeline.py` run green with WAL enabled; targeted grep confirms no runtime imports of the sync helpers outside compatibility shims/tests.【F:tests/prices/test_history_queue.py†L1-L220】【F:tests/prices/test_history_ingest.py†L1-L320】【F:tests/currencies/test_fx_async.py†L1-L140】【F:tests/test_price_service.py†L1-L220】【F:tests/integration/test_enrichment_pipeline.py†L1-L240】 | Sequenced removal: (1) provide an async/await replacement for `normalize_price_to_eur_sync` and migrate call sites (logic, sync_from_pclient, diagnostics); (2) delete the sync FX/history helpers, update docs/release notes, and mark the cleanup tracker row complete. |
| [ ] | Metrics + normalization | Legacy aggregation logic in `helpers/performance_legacy.py`, `_compact_event_data` fallbacks, manual coordinator caches | Metrics engine writes canonical tables and websocket serializers read normalized rows only (Roadmap M3–M4).【F:.docs/backend_workstreams.md†L35-L63】【F:custom_components/pp_reader/data/event_push.py†L1-L134】 | Snapshot + push parity verified via `tests/test_event_push.py`, `tests/test_aggregations.py`, and websocket smoke tests (`tests/test_ws_portfolios_live.py`, `tests/test_ws_portfolio_positions.py`).【F:tests/test_event_push.py†L1-L143】【F:tests/test_aggregations.py†L1-L160】【F:tests/test_ws_portfolios_live.py†L1-L142】 | Capture coordinator telemetry before pruning caches so diagnostics stay traceable. |
| [ ] | Storage + backups | `config/pp_reader_data` flat backups, ad-hoc WAL toggles, manual repair scripts | Migration framework with idempotent schema upgrades and managed backups shipped (Roadmap M4, Storage workstream).【F:.docs/backend_workstreams.md†L65-L83】【F:README.md†L41-L68】 | `tests/test_backup_cleanup.py`, `tests/test_migration.py`, and cold-start restores from `datamodel/db_entries/*` snapshots prove recoverability without legacy scripts.【F:tests/test_backup_cleanup.py†L1-L36】【F:tests/test_migration.py†L1-L200】【F:datamodel/db_entries/Aixtron_entries.md†L1-L48】 | Communicate backup rotation change in release notes and README troubleshooting. |
| [ ] | Frontend fallbacks | Legacy adapters under `src/lib/api/portfolio/legacy_*`, dashboard map bundles referencing deprecated fields | Canonical payload feature branch validated; stores/components migrated (Roadmap M5, Frontend alignment).【F:.docs/frontend_alignment.md†L5-L34】 | `tests/frontend/*`, dashboard snapshot assertions, and manual regression via websocket panel matrix pass without legacy selectors.【F:tests/frontend/test_dashboard_smoke.py†L1-L63】【F:datamodel/panel_connectors.md†L1-L94】 | Remove minified bundles after `npm run build` refresh; coordinate with documentation updates. |
| [ ] | Documentation & comms | Outdated references in `README.md`, `.docs/*` strategies superseded by canonical pipeline | QA/docs milestone complete with updated architecture + dashboard guides (Roadmap M6).【F:.docs/refactor_roadmap.md†L125-L150】【F:README.md†L1-L84】 | `README.md`, `README-dev.md`, and changelog diffs reviewed alongside release announcement notes; internal rollouts confirm messaging.【F:README.md†L1-L84】【F:README-dev.md†L1-L120】【F:CHANGELOG.md†L1-L120】 | Archive historical strategy docs into `/zz_Drafts/` once superseded. |

### Enrichment sync helper retirement checklist
- Migrate `logic/securities.py`, `data/sync_from_pclient.py`, and diagnostics helpers to await `ensure_exchange_rates_for_dates` via `async_run_executor_job`, dropping imports of `ensure_exchange_rates_for_dates_sync` and `load_cached_rate_records_sync`.【F:custom_components/pp_reader/logic/securities.py†L376-L460】【F:custom_components/pp_reader/data/sync_from_pclient.py†L1363-L1439】
- Replace `normalize_price_to_eur_sync` usages with an async or executor-backed variant so price/FX conversions no longer depend on synchronous shims before removal.【F:custom_components/pp_reader/util/currency.py†L120-L182】
- Confirm historical price ingestion exclusively flows through `prices/history_queue.py` + `history_ingest.py`; delete deprecated history helpers and update release notes once CI runs the enrichment suites listed above.【F:custom_components/pp_reader/prices/history_queue.py†L1-L320】【F:custom_components/pp_reader/prices/history_ingest.py†L1-L360】

## Execution Checklist

1. **Baseline audit.** Snapshot the current database and dashboard state using representative fixtures from `datamodel/db_entries/` before cutting any removals; attach evidence to the roadmap milestone notes.【F:datamodel/db_entries/Aixtron_entries.md†L1-L48】【F:.docs/refactor_roadmap.md†L59-L73】
2. **Milestone gating.** During each roadmap milestone review, copy the relevant tracker row into the status note and capture blocking tasks for backend/frontend owners.【F:.docs/refactor_roadmap.md†L45-L73】【F:.docs/frontend_alignment.md†L15-L34】
3. **Test matrix.** Run the targeted pytest modules listed above plus websocket suites (`tests/test_ws_*`) and dashboard tests after every removal PR; store links to the CI runs in the tracker table notes.【F:tests/test_ws_portfolio_positions.py†L1-L198】【F:tests/test_ws_security_history.py†L1-L200】【F:tests/frontend/test_dashboard_smoke.py†L1-L63】
4. **Configuration verification.** Validate that Home Assistant configuration paths (`/config/pp_reader_data`) continue to be honored for imports, backups, and services, documenting any migration steps for users.【F:README.md†L41-L68】【F:tests/test_backup_cleanup.py†L1-L36】
5. **Release coordination.** Fold cleanup updates into release notes and docs refresh so decommissioned assets are communicated with upgrade steps, referencing the frontend/back-end alignment documents for contract summaries.【F:.docs/frontend_alignment.md†L15-L34】【F:CHANGELOG.md†L1-L120】

## Reporting & Ownership

- **Status reviews.** Add tracker updates to the weekly refactor sync so owners can surface blockers early; include links to roadmap notes and test evidence for each row.【F:.docs/refactor_roadmap.md†L59-L73】
- **Documentation log.** Annotate `.docs/live_aggregation/` and related directories with cleanup outcomes; move superseded notes into `datamodel/zz_Drafts/` with a tombstone entry referencing the tracker row.【F:.docs/backend_workstreams.md†L65-L83】【F:datamodel/zz_Drafts/frontend-backend-data.md†L1-L24】
- **Escalations.** If removal readiness cannot be demonstrated with the listed fixtures or tests, raise a dedicated issue linking to the blocker and keep the tracker row open until resolved.【F:tests/test_migration.py†L1-L200】【F:tests/test_coordinator_contract.py†L1-L120】
