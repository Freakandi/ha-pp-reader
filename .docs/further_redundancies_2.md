## Legacy redundancy backlog from the latest search

The follow-up search exposed additional legacy surfaces that still duplicate backend calculations or rely on compatibility shims. The open checklist below groups every finding into logical backend, frontend, and cross-cutting blocks so we can retire them systematically. Duplicate sightings have been merged, but no unique entry from the raw list was removed.

### Backend helpers duplicating shared utilities
1. [x] **`_normalize_currency_amount` wrapper** – Event push continues to run raw cent and float values through its own converter before emitting portfolio updates; callers should invoke `cent_to_eur` and `round_currency` directly per the cleanup plan.【F:custom_components/pp_reader/data/event_push.py†L45-L114】【F:custom_components/pp_reader/util/currency.py†L35-L98】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L162-L166】
2. [ ] **`_normalize_portfolio_value_entry` recomputation** – Portfolio value events rebuild gains and day-change payloads locally instead of trusting the shared performance helper, causing double rounding and redundant structures.【F:custom_components/pp_reader/data/event_push.py†L62-L114】【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L210-L222】
3. [ ] **`_normalize_position_entry` fallbacks** – Position events reconstruct holdings aggregations, average-cost choices, and performance blocks even though those objects are already produced server-side, leaving stale manual math in place.【F:custom_components/pp_reader/data/event_push.py†L150-L338】【F:custom_components/pp_reader/data/aggregations.py†L175-L238】【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L162-L190】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L210-L222】
4. [ ] **Coordinator gain rounding** – `_portfolio_contract_entry` still rounds gains directly via `round(...)` before returning sensor payloads instead of delegating to the shared helpers, so rounding rules drift from the canonical implementation.【F:custom_components/pp_reader/data/coordinator.py†L141-L179】【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:custom_components/pp_reader/util/currency.py†L35-L98】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L210-L222】
5. [ ] **Price revaluation cent scaling** – The revaluation flow reconverts EUR floats back to cents and applies manual rounding during portfolio upserts, duplicating the utility logic that already normalises these values.【F:custom_components/pp_reader/prices/price_service.py†L520-L640】【F:custom_components/pp_reader/util/currency.py†L35-L98】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L219-L222】

### Backend payload fields awaiting retirement
1. [ ] **Legacy average-cost mirrors on portfolio positions** – `get_portfolio_positions` still exposes flat average-price and purchase-total mirrors next to the structured `aggregation`/`average_cost` payloads, keeping both representations alive.【F:custom_components/pp_reader/data/db_access.py†L780-L898】【F:custom_components/pp_reader/data/aggregations.py†L175-L238】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L152-L170】
2. [ ] **Legacy average-cost mirrors on security snapshots** – Snapshot queries forward the same legacy fields even though the structured `average_cost` block already supplies the canonical numbers.【F:custom_components/pp_reader/data/db_access.py†L536-L665】【F:custom_components/pp_reader/data/aggregations.py†L175-L238】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L187-L217】
3. [ ] **Flattened gain metrics alongside structured payloads** – Portfolio positions, events, and websocket caches still mirror `gain_abs`/`gain_pct` next to the new `performance` object, preventing clients from migrating to the consolidated helper output.【F:custom_components/pp_reader/data/db_access.py†L780-L898】【F:custom_components/pp_reader/data/db_access.py†L866-L952】【F:custom_components/pp_reader/data/event_push.py†L84-L110】【F:src/data/updateConfigsWS.ts†L153-L188】【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L210-L237】
4. [ ] **Legacy day-change mirrors** – Security snapshots still emit `day_price_change_native` as a flat field even though the nested `performance.day_change` block now carries the authoritative deltas.【F:custom_components/pp_reader/data/db_access.py†L536-L665】【F:custom_components/pp_reader/data/websocket.py†L159-L164】【F:custom_components/pp_reader/data/performance.py†L115-L152】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L214-L237】
5. [ ] **Deprecated `avg_price_account` surface** – Backend payloads and the dashboard type definitions continue to keep the legacy account-average field alongside the structured average-cost payload.【F:custom_components/pp_reader/data/db_access.py†L824-L893】【F:custom_components/pp_reader/data/db_access.py†L648-L660】【F:src/tabs/types.ts†L132-L146】【F:src/tabs/types.ts†L11-L22】

### Frontend fallback normalisers
1. [x] **WebSocket cache re-derives aggregation & average-cost** – `deriveAggregation`, `normalizeAverageCost`, and `normalizePosition` rebuild holdings totals, average costs, and gain mirrors instead of consuming the backend payloads verbatim.【F:src/data/updateConfigsWS.ts†L69-L249】【F:custom_components/pp_reader/data/aggregations.py†L175-L238】【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L177-L180】
2. [x] **Overview tab average-cost resolver** – `resolveAverageCost` and helpers still parse and normalise average-cost values client-side before rendering, even though the backend already ships the structured block.【F:src/tabs/overview.ts†L177-L280】【F:custom_components/pp_reader/data/aggregations.py†L175-L238】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L135-L138】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L182-L185】
3. [x] **Security detail average-cost & baseline fallbacks** – Security detail helpers reconstruct averages and chart baselines from legacy fields rather than using the backend-provided `average_cost` and performance metrics.【F:src/tabs/security_detail.ts†L137-L187】【F:src/tabs/security_detail.ts†L1830-L1846】【F:custom_components/pp_reader/data/aggregations.py†L175-L238】【F:custom_components/pp_reader/data/performance.py†L83-L154】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L135-L190】

### Frontend fallbacks duplicating backend calculations
1. [ ] **`buildSnapshotFromPortfolioCache`** – The cache fallback still aggregates holdings, purchase totals, and gain metrics by hand instead of trusting the backend snapshot payload, leaving redundant summation and rounding logic in place.【F:src/tabs/security_detail.ts†L380-L602】【F:src/tabs/security_detail.ts†L420-L602】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L187-L248】【F:custom_components/pp_reader/data/db_access.py†L536-L665】【F:custom_components/pp_reader/data/aggregations.py†L23-L308】
2. [ ] **`ensureSnapshotMetrics`** – The security detail metrics registry re-derives average prices, FX rates, and day/total changes from raw fields even though the dedicated performance payload already contains the canonical values.【F:src/tabs/security_detail.ts†L1030-L1107】【F:.docs/cleanup/TODO_redundancy_cleanup_plan.md†L214-L248】【F:custom_components/pp_reader/data/db_access.py†L536-L665】

### Compatibility shims still in place
1. [ ] **Legacy portfolio aggregation fallbacks** – `logic/portfolio.py` and the price revaluation pipeline retain fallback helpers such as `calculate_portfolio_value` and `db_calculate_portfolio_*`, duplicating the modern aggregation flow used by `fetch_live_portfolios`.【F:custom_components/pp_reader/logic/portfolio.py†L53-L360】【F:custom_components/pp_reader/prices/revaluation.py†L30-L78】【F:custom_components/pp_reader/data/db_access.py†L961-L1024】
2. [ ] **Frontend fallback to legacy `dashboard.js` bundle** – The published panel bootstrapper still imports the legacy bundle whenever the module build is unavailable, keeping the old asset in production packages.【F:custom_components/pp_reader/www/pp_reader_dashboard/panel.js†L1-L58】【F:src/panel.ts†L1-L55】
3. [ ] **Global `window.__ppReader*` shims** – Websocket handlers and the overview tab still register helpers on the global window object for legacy DOM integrations instead of relying on typed module exports.【F:src/data/updateConfigsWS.ts†L200-L249】【F:src/tabs/overview.ts†L532-L586】【F:src/data/updateConfigsWS.ts†L200-L206】
