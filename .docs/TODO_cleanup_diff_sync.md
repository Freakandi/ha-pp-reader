# TODO: Retire protobuf diff sync

Derived from `.docs/legacy_cleanup_strategy.md`, section "1. Retire protobuf diff sync". Complete each checklist item to remove the protobuf diff-sync pipeline in favor of the canonical ingestion → normalization flow.

1. [x] Pre-removal prerequisites captured — tests/services/test_parser_pipeline.py; tests/integration/test_ingestion_writer.py; tests/integration/test_normalization_smoketest.py — parser_pipeline.async_parse_portfolio; ingestion_writer.async_ingestion_session; normalization_smoketest suite — Baseline proves canonical parser → staging → normalization flow is already stable before deleting diff sync.
    - ✅ Baseline suites locked in via 1.a/1.b on 2025-11-15 (see log references below); no additional diff-sync verification required.
1.a [x] Run `pytest tests/services/test_parser_pipeline.py` and retain the log/commit reference in the cleanup issue — tests/services/test_parser_pipeline.py — parser_pipeline.ParseProgress handling — Document deterministic parser/staging serialization ahead of removals.
    - ✅ 2025-11-15T09:56:18+01:00 — `source venv-ha/bin/activate && pytest tests/services/test_parser_pipeline.py` on 46fd80109fb4856033872db71c1dbecb314eee07
1.b [x] Run `pytest tests/integration/test_ingestion_writer.py tests/integration/test_normalization_smoketest.py` — tests/integration/test_ingestion_writer.py; tests/integration/test_normalization_smoketest.py — ingestion_writer.finalize_ingestion; async_normalize_snapshot smoke flow — Confirm end-to-end staging + normalization works without invoking diff sync.
    - ✅ 2025-11-15T09:57:34+01:00 — `source venv-ha/bin/activate && pytest tests/integration/test_ingestion_writer.py tests/integration/test_normalization_smoketest.py` on 46fd80109fb4856033872db71c1dbecb314eee07
2. [x] Coordinator no longer executes the legacy diff-sync branch — custom_components/pp_reader/data/coordinator.py — PPReaderCoordinator._async_update_data; use_staging_importer flag — Coordinator always relies on staging ingestion output and normalization pipeline.
    - ✅ Coordinator telemetry now reports ingestion + normalization metadata only; all legacy client hooks were removed alongside the `_legacy_sync_to_db` branch.
2.a [x] Remove `use_staging_importer` feature flag handling plus `_load_staging_proto_snapshot` helper and its `ingestion_reader.load_proto_snapshot` dependency — custom_components/pp_reader/data/coordinator.py; custom_components/pp_reader/data/ingestion_reader.py; tests/integration/test_ingestion_reader.py — use_staging_importer flag; load_proto_snapshot; test_load_proto_snapshot_builds_pclient — Staging snapshots are no longer rebuilt into protobuf clients for sync, leaving only ingestion diagnostics helpers.
    - ✅ 2025-11-15T10:03:01+01:00 — Removed flag plumbing + proto snapshot builder; `source venv-ha/bin/activate && ruff check custom_components/pp_reader/data/coordinator.py custom_components/pp_reader/data/ingestion_reader.py custom_components/pp_reader/data/sync_from_pclient.py custom_components/pp_reader/feature_flags.py tests/integration/test_ingestion_reader.py` and `source venv-ha/bin/activate && pytest tests/integration/test_ingestion_reader.py` on 46fd80109fb4856033872db71c1dbecb314eee07
2.b [x] Delete `_legacy_sync_to_db` and the `import_module("custom_components.pp_reader.data.sync_from_pclient")` call, removing the synchronous executor job entirely — custom_components/pp_reader/data/coordinator.py — _legacy_sync_to_db; DataUpdateCoordinator._async_update_data legacy_client handling — Coordinator stops calling diff-sync and no longer instantiates `_reader_module` fallbacks.
    - ✅ `_legacy_sync_to_db` / `_reader_module` references are gone; the coordinator solely orchestrates parser → ingestion → normalization telemetry (verified in 2bc1126, see `custom_components/pp_reader/data/coordinator.py`).
2.c [x] Replace the legacy `legacy_client` usage with normalized staging metadata (e.g., rely on `writer.finalize_ingestion` output + `_last_ingestion_run_id`) when scheduling enrichment updates — custom_components/pp_reader/data/coordinator.py — _last_ingestion_run_id; _schedule_enrichment_jobs; _notify_parser_completed — Update loop derives all follow-up work from canonical ingestion artifacts only.
    - ✅ `_last_ingestion_run_id` is now the sole driver for enrichment scheduling and `legacy_client` disappeared from the codebase (`grep -R legacy_client` yields only this checklist entry, verified 2025-11-16).
3. [x] Deprecate `data.reader` usage by rewiring config flows and deleting the module — custom_components/pp_reader/config_flow.py; custom_components/pp_reader/data/reader.py — ConfigFlow.async_step_user; parse_data_portfolio — File validation uses the parser pipeline, enabling module removal.
3.a [x] Switch the config flow portfolio validation to `parser_pipeline.async_parse_portfolio` (or its `portfolio_file` helper) so no code imports `data.reader.parse_data_portfolio` — custom_components/pp_reader/config_flow.py — ConfigFlow.async_step_user; async_step_import attachment validation — Config flow exercises the canonical parser and surfaces validation errors identical to runtime ingestion.
3.b [x] Remove `custom_components/pp_reader/data/reader.py` and any `_reader_module` imports or guards — custom_components/pp_reader/data/reader.py; custom_components/pp_reader/data/coordinator.py — parse_data_portfolio; _reader_module shim — Deprecated protobuf reader disappears along with its log spam.
3.c [x] Scrub stray direct references to `data.reader` from docs or helper modules (e.g., README, TODO specs) so the only parsing entry point is the services parser pipeline — README-dev.md; ARCHITECTURE.md; .docs/portfolio-data-spec.md — Architecture documentation sections referencing parse_data_portfolio — Contributor docs no longer mention the removed module.
    - ✅ Config flow now calls `parser_pipeline.async_parse_portfolio(..., fire_progress=False)` with a no-op writer, the module file is removed, and the architecture/spec docs reference the canonical parser.
4. [x] Remove `sync_from_pclient` and every consumer — custom_components/pp_reader/data/sync_from_pclient.py — sync_from_pclient; _SyncRunner — Legacy diff-sync pipeline is gone.
4.a [x] Delete `custom_components/pp_reader/data/sync_from_pclient.py` together with `_SyncRunner`, `_apply_diff_event_data`, and `pp_reader.name.abuchen.portfolio` import shims — custom_components/pp_reader/data/sync_from_pclient.py — sync_from_pclient; _SyncRunner; _apply_diff_event_data — No runtime code or packaging references the diff-sync module.
4.b [x] Update `scripts/enrichment_smoketest.py` to keep working without diff-sync (normalize staging snapshots via `async_normalize_snapshot` instead of calling `sync_from_pclient`) — scripts/enrichment_smoketest.py — _run_sync; _sync_portfolio_database — CLI exercises parser → staging → normalization without depending on deleted helpers.
4.c [x] Remove the `pp_reader` namespace alias (`sys.modules[_NAMESPACE_ALIAS] = sys.modules[__name__]`) because no remaining runtime import relies on it — custom_components/pp_reader/__init__.py — _NAMESPACE_ALIAS; sys.modules mapping — Package tree stops exporting the legacy namespace.
    - ✅ Alias shim deleted alongside the normalized feature-flag toggles; canonical modules now import via `custom_components.pp_reader.*` only.
4.d [x] Delete `tests/test_sync_from_pclient.py` and drop its fixtures from `tests/common.py` if present — tests/test_sync_from_pclient.py; tests/common.py — sync_from_pclient fixture helpers; _prepare_portfolio_db — Test suite no longer runs diff-sync cases.
4.e [x] Delete `tests/integration/test_sync_from_staging.py` plus any staging parity fixtures — tests/integration/test_sync_from_staging.py; tests/integration/conftest.py — staging_sync fixtures — Integration suite stops comparing ingestion snapshots to the removed legacy sync.
5. [x] Validation after deletions — tests/services/test_parser_pipeline.py; tests/integration/test_ingestion_writer.py; tests/integration/test_normalization_smoketest.py; tests/test_coordinator_contract.py; scripts/enrichment_smoketest.py — parser_pipeline; ingestion_writer; normalization_pipeline; Coordinator contract; CLI smoketest — Confirms canonical flow and CLI still function after cleanup.
5.a [x] Run `pytest tests/services/test_parser_pipeline.py tests/integration/test_ingestion_writer.py tests/integration/test_normalization_smoketest.py tests/test_coordinator_contract.py` — tests/... — parser_pipeline; ingestion_writer; normalization_pipeline; CoordinatorContractTest — All suites pass without diff-sync modules.
    - ✅ 2025-11-15T11:32Z — `source venv-ha/bin/activate && pytest tests/services/test_parser_pipeline.py tests/integration/test_ingestion_writer.py tests/integration/test_normalization_smoketest.py tests/test_coordinator_contract.py` (added canonical seeding helper inside the smoketest regression to reflect the new ingestion-only path).
5.b [x] Execute `python scripts/enrichment_smoketest.py --portfolio <fixture> --db-path <tmp>` and capture the summary in the cleanup issue — scripts/enrichment_smoketest.py — CLI normalization path — QA smoketest proves CLI tooling also survives the removal.
    - ✅ 2025-11-16T09:02:05+01:00 — `source venv-ha/bin/activate && PYTHONIOENCODING=utf-8 PYTHONPATH=. python scripts/enrichment_smoketest.py --portfolio config/pp_reader_data/S-Depot.portfolio --db-path tmp/smoketest.db --logfile tmp/enrichment_smoketest.log` → exit 0; run_id=1705cf417a674a87a201227e31d7892c, metric_run_uuid=30579aac7ba342768c03da29cf766c0a, fx=skipped (EUR base), history=completed (115 targets / 11,333 candles), metrics=completed, normalization=ok (include_positions=False), canonical snapshots persisted (5 accounts / 4 portfolios, snapshot_at=2025-11-16T08:03:30Z; see tmp/enrichment_smoketest.log for full JSON summary).
