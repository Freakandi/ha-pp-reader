#!/usr/bin/env bash

# Fail on errors and undefined vars
set -euo pipefail

cd "$(dirname "$0")/.."

APT_PACKAGES=(ffmpeg libturbojpeg libpcap-dev libsqlite3-dev python3-venv)
if command -v apt-get >/dev/null; then
    sudo apt-get update -y
    sudo apt-get install -y "${APT_PACKAGES[@]}"
fi

if command -v pyenv >/dev/null; then
    pyenv install -s 3.13.3
    pyenv global 3.13.3
fi

if [ ! -d ".venv" ]; then
    python3 -m venv .venv
fi
source .venv/bin/activate

pip install --upgrade pip
pip install --requirement requirements.txt

CONFIG_DIR="${PWD}/config"
if [ ! -d "${CONFIG_DIR}" ]; then
    mkdir -p "${CONFIG_DIR}"
fi

if [ ! -e "/config" ]; then
    ln -s "${CONFIG_DIR}" /config
elif [ -L "/config" ]; then
    current_target="$(readlink /config)"
    if [ "${current_target}" != "${CONFIG_DIR}" ]; then
        rm /config
        ln -s "${CONFIG_DIR}" /config
    fi
elif [ ! -d "/config" ]; then
    echo "Refusing to overwrite /config because it exists and is not a symlink" >&2
    exit 1
fi

echo "Setup complete. Run ./scripts/develop to start Home Assistant."
