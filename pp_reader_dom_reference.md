# Portfolio Performance Reader Panel DOM Reference

![Portfolio Dashboard overview](browser:/invocations/uwqyprkg/artifacts/artifacts/ppreader.png)

## 1. Host Integration inside Home Assistant
- The custom panel is rendered inside Home Assistant's main drawer layout. The shadow DOM of `pp-reader-panel` is mounted under `home-assistant-main`, allowing the panel to dispatch `hass-toggle-menu` events to open or close the sidebar when the custom menu button is pressed.【F:custom_components/pp_reader/www/pp_reader_dashboard/panel.js†L11-L63】
- The panel shadow imports the dashboard controller bundle and injects the wrapper markup (`.panel-root`, fixed header, scrollable wrapper, and the `<pp-reader-dashboard>` host element) that the rest of the UI relies on.【F:custom_components/pp_reader/www/pp_reader_dashboard/panel.js†L10-L28】

## 2. Panel Shell (`pp-reader-panel`)
- `pp-reader-panel` attaches three scoped stylesheets (`base.css`, `cards.css`, `nav.css`) and watches its own size via a `ResizeObserver` to set `--panel-width`, which keeps the sticky header widths aligned with the container.【F:custom_components/pp_reader/www/pp_reader_dashboard/panel.js†L25-L90】【F:custom_components/pp_reader/www/pp_reader_dashboard/css/base.css†L1-L40】
- `base.css` fixes the header at the top (48 px high), positions the scrollable dashboard beneath it, and constrains horizontal overflow to the dedicated `.scroll-container` wrappers so tables can scroll independently.【F:custom_components/pp_reader/www/pp_reader_dashboard/css/base.css†L20-L45】
- The header exposes a hamburger button and title that inherit Home Assistant theme variables; hovering styles, icon sizing, and typography are defined in the same stylesheet.【F:custom_components/pp_reader/www/pp_reader_dashboard/css/base.css†L47-L99】

## 3. Dashboard Host (`pp-reader-dashboard`)
- The dashboard custom element wraps its content in a light DOM `<div class="pp-reader-dashboard">` so that Home Assistant's global typography and theme variables apply while retaining scroll state per tab.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/dashboard.js†L520-L612】
- It tracks Home Assistant references (`hass`, `panel`, `route`, `narrow`), remembers scroll positions by tab, subscribes to `panels_updated` WebSocket events, and queues incremental updates for later reapplication if the DOM is rebuilt.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/dashboard.js†L520-L910】
- Rendering is delegated to `renderTab`, which injects the HTML returned by the current tab descriptor, builds the sticky header anchor, wires navigation buttons, and adds swipe gestures to the header card.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/dashboard.js†L353-L517】
- Sticky behavior is driven by an `IntersectionObserver` watching `#pp-reader-sticky-anchor`, toggling `.header-card.sticky` when the scroll position passes the anchor.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/dashboard.js†L429-L455】
- Left/right navigation buttons are enabled or disabled depending on the active tab index; the right arrow only reactivates when another detail tab can be reopened.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/dashboard.js†L471-L517】

## 4. Overview Tab Layout
### 4.1 Header Card
- `createHeaderCard` produces a card with navigation arrows, `<h1 id="headerTitle">`, and a `.meta` container for supplemental information. Sticky mode shrinks the typography and collapses the meta section via CSS transitions.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/content/elements.js†L138-L159】【F:custom_components/pp_reader/www/pp_reader_dashboard/css/cards.css†L41-L124】【F:custom_components/pp_reader/www/pp_reader_dashboard/css/nav.css†L1-L34】
- `renderDashboard` injects the header card and fills `.header-meta-row` with the aggregated portfolio + account total wealth figure.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L789-L800】

### 4.2 Investment Card and Portfolio Table
- The overview tab creates an `Investment` card containing `.scroll-container.portfolio-table` and a `<table class="expandable-portfolio-table">` with a `tr.portfolio-row` per depot and paired `tr.portfolio-details` rows for detail content.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L230-L318】
- Each summary row carries numeric dataset attributes (`data-position-count`, `data-current-value`, etc.) for later updates, while the toggle button maintains `aria-expanded`, `aria-controls`, and a caret glyph for accessibility cues.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L254-L279】
- Detail rows host a `.positions-container` placeholder. When a portfolio is expanded, the container is populated with either a loading indicator, an error with `.retry-pos`, or a lazy-rendered `table.sortable-positions` generated by `renderPositionsTable` depending on cache state.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L287-L318】【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L596-L708】
- Card styling keeps the section self-contained: sticky section headers, alternating row backgrounds, hover highlighting, and the `.flash-update` animation for live price pushes.【F:custom_components/pp_reader/www/pp_reader_dashboard/css/cards.css†L1-L216】

### 4.3 Liquidity and FX Cards
- `renderDashboard` builds a `Liquidität` card backed by `makeTable`, formatting account balances as right-aligned currency columns, and optionally adds a `Fremdwährungen` card that shows original currency amounts alongside their EUR conversion.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L803-L836】【F:custom_components/pp_reader/www/pp_reader_dashboard/js/content/elements.js†L49-L135】

### 4.4 Footer Meta Card
- A `.card.footer-card` at the end of the layout surfaces the last Portfolio Performance export timestamp so users can verify data freshness.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L839-L860】

## 5. Portfolio Detail Behaviour
- Module-level state stores a `portfolioPositionsCache` map and `expandedPortfolios` set so that lazy-loaded detail tables persist across rerenders and push updates.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L6-L120】
- `attachPortfolioToggleHandler` binds delegated clicks inside `.portfolio-table` to open/close detail rows, update `aria-expanded`, swap the caret glyph (`▶`/`▼`), and remember expansion state. When a row opens, it flushes any pending WebSocket updates, shows a loading placeholder, fetches positions, and renders/sorts the table; closing resets classes and removes the portfolio from the expanded set.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L596-L732】
- Sorting for position tables is attached once per portfolio via `attachPortfolioPositionsSorting`, which toggles `.sort-active` indicators on header cells and persists the selected sort column/direction in `dataset` attributes.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L443-L538】
- Users can request a fresh fetch with the retry button, which calls `reloadPortfolioPositions` to re-render the table and rebind sorting and security navigation listeners.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L540-L579】
- `schedulePostRenderSetup` runs after every overview render to rebuild missing buttons, reattach listeners, restore expanded rows, recompute the footer, and flush any pending updates that arrived while the table was not mounted.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L867-L918】
- A fallback listener on `.expandable-portfolio-table` retriggers the main handler if the outer container was not yet bound, avoiding dead controls after asynchronous renders.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L735-L748】

## 6. Data Flow and Live Updates
- WebSocket helpers derive the integration `entry_id` from multiple sources and expose typed commands for accounts, portfolio aggregates, positions, file metadata, security snapshots, and history ranges. All dashboard fetches and live updates run through these endpoints.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/data/api.js†L1-L160】
- `updateConfigsWS.js` keeps maps of pending position payloads so WebSocket deltas can be applied once detail rows become visible. It also restores sort state after rerenders by reusing the global sorting helper.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/data/updateConfigsWS.js†L1-L149】
- `handleAccountUpdate` and `handlePortfolioUpdate` patch existing table rows in place, update dataset attributes for future recalculations, trigger the `.flash-update` feedback, and recompute the footer and total-wealth banner based on the latest DOM state.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/data/updateConfigsWS.js†L151-L358】

## 7. Navigation and Tab Management
- The dashboard module maintains a registry of detail tabs keyed by `security:` identifiers. Helper functions add or remove tabs, reopen the previously viewed security when paging forward, and constrain navigation indices.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/dashboard.js†L16-L348】
- `addSwipeEvents` (used by `setupSwipeOnHeaderCard`) listens for both touch and mouse drags to provide gesture navigation on the header card, matching the button-based navigation.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/interaction/tab_control.js†L1-L40】【F:custom_components/pp_reader/www/pp_reader_dashboard/js/dashboard.js†L457-L468】
- Scroll state for each tab is remembered via `rememberScrollPosition`, allowing the dashboard to restore the user's position when switching back to the overview or a reopened detail tab.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/dashboard.js†L770-L910】

## 8. Styling and Visual Feedback Summary
- Card-level styling (rounded corners, sticky headers, controlled scrollbars) and positive/negative highlighting for gains are centralized in `cards.css`, ensuring consistent semantics across aggregated and detailed tables.【F:custom_components/pp_reader/www/pp_reader_dashboard/css/cards.css†L1-L216】
- Navigation arrows share theming with Home Assistant through `nav.css`, including disabled states that also suppress pointer events so navigation cannot be triggered while unavailable.【F:custom_components/pp_reader/www/pp_reader_dashboard/css/nav.css†L1-L34】
- The scroll anchor (`#pp-reader-sticky-anchor`) sits just above the header card and is invisible but participates in intersection checks that drive sticky mode transitions.【F:custom_components/pp_reader/www/pp_reader_dashboard/css/nav.css†L36-L67】

## 9. Edge Cases and Observed States
- When fetches fail, `.positions-container` renders an error block with a retry button; the same container shows `Lade…`/`Neu laden…` placeholders while awaiting network responses.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L670-L705】【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L540-L579】
- Pending WebSocket updates for collapsed portfolios are cached in `window.__ppReaderPendingPositions` and replayed once the row expands, preventing stale data when the dashboard receives background updates.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/data/updateConfigsWS.js†L1-L149】
- Footer totals rely on dataset values added to each portfolio row, allowing `updatePortfolioFooterFromDom` to recalculate sums even after manual DOM edits or partial live updates.【F:custom_components/pp_reader/www/pp_reader_dashboard/js/tabs/overview.js†L357-L416】

This reference should equip future contributors with a reliable map of the Portfolio Performance Reader panel's DOM, the components that manage it, and the data flows that keep it up to date.
